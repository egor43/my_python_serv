define("Deprecated/Controls/DataViewAbstract/DataViewAbstract",["Deprecated/Controls/Menu/Menu","Core/helpers/String/format","Core/core-functions","Core/core-clone","Deprecated/core-attach","Core/core-instance","Core/core-merge","Core/helpers/Function/debounce","Core/helpers/i18n/wordCaseByNumber","Deprecated/BLObject","Deprecated/Record","Deprecated/RecordSet","Transport/attachTemplate","Core/helpers/generate-helpers","Core/helpers/Function/memoize","Core/helpers/fast-control-helpers","Core/helpers/Hcontrol/openErrorsReportDialog","Deprecated/helpers/fast-control-helpers","Deprecated/helpers/dom&controls-helpers","Core/helpers/dom&controls-helpers","Core/helpers/Hcontrol/hasScrollbar","Core/helpers/Hcontrol/isElementVisible","Core/helpers/getType","Core/WindowManager","Core/UserConfig","Core/SessionStorage","Core/MicroSession","Core/IoC","Core/Context","Core/ParallelDeferred","Core/Deferred","Core/defaultRenders","Core/CommandDispatcher","Core/constants","Lib/Control/Control","Lib/Type/TDataSource/TDataSource","Deprecated/Controls/FieldDropdown/FieldDropdown","Lib/Control/Paging/Paging","Lib/Control/Dialog/Dialog","Deprecated/Controls/LoadingIndicator/LoadingIndicator","html!Deprecated/Controls/DataViewAbstract/resources/rowOptionItemTpl","Core/DependencyResolver","Deprecated/SerializatorSBIS","bootup","Deprecated/Controls/RecordFloatArea/RecordFloatArea","Core/moduleStubs","Transport/HTTPError","Core/detection","browser!Core/jquery-dblclick","css!Deprecated/Controls/DataViewAbstract/DataViewAbstract","Deprecated/res/wsmodules/SumDialog/SumDialog","i18n!Deprecated/Controls/DataViewAbstract/DataViewAbstract","Deprecated/ClassMapper"],function(e,t,i,o,s,r,n,a,l,h,d,c,_,f,u,p,w,g,m,y,R,v,b,S,O,C,P,k,D,A,E,B,F,M,T,H,x,I,N,L,j,z,V,U,K,W,q){"use strict";var Q={newDialog:1,thisPage:1,newFloatArea:1},G=3e3,J=100,Y=/\bdisablepreload\b/i;M.Browser=M.Browser||{},M.Browser.pageSizes=[10,20,25,50,100,200,500,1e3],M.Browser.minHeight=24,M.Browser.loadingIndicatorDelay=1e3,M.Browser.loadingIndicatorForReadDelay=3e3,M.Browser.rowOptionsElementsOffset={right:2,top:0},M.Browser.rowOptionBeforeAll=-1,M.Browser.rowOptionsMenuConfig=[void 0,{left:5,top:-5},{objectLeft:false,targetLeft:false},{horizontal:true,vertical:true},false,M.$win],M.Browser.imgPath=M.wsRoot+"img/themes/wi_scheme/browser/",z.register("Deprecated/Controls/DataViewAbstract/DataViewAbstract",function(e){var t={};if(e){if(t["Deprecated/Controls/DataViewAbstract/plugins/Print-plugin"]=1,e.display.showPaging)t["Lib/Control/Paging/Paging"]=1;if(e.allowMove||!("allowMove"in e)||e.display.sequenceNumberColumn)t["Deprecated/Controls/DataViewAbstract/plugins/Move-plugin"]=1;if(e.rowOptions)t["Deprecated/Controls/Menu/Menu"]=1;if(e.useCopyRecords)t["Deprecated/Controls/DataViewAbstract/plugins/Copy-plugin"]=1;if(e.useMergeRecords)t["Deprecated/Controls/DataViewAbstract/plugins/Merge-plugin"]=1;if(e.display.showToolbar)t["Deprecated/Controls/DataViewAbstract/plugins/Toolbar-plugin"]=1,t["Deprecated/Controls/ToolBar/ToolBar"]=1,t["Deprecated/Controls/Button/Button"]=1,t["Deprecated/Controls/Menu/Menu"]=1;if(e.display.scrollPaging)t["Lib/Control/Paging/Paging"]=0,t["Deprecated/Controls/TableView/plugins/ScrollPaging-plugin"]=1;if(e.markedRowOptions&&!Object.isEmpty(e.markedRowOptions))t["Deprecated/Controls/DataViewAbstract/plugins/MarkedRowOptions-plugin"]=1;if(e.display.usePartScroll)t["Deprecated/Controls/TableView/plugins/PartScroll-plugin/PartScroll-plugin"]=1}return Object.keys(t)});var Z=T.DataBoundControl.extend({$protected:{_options:{preprocessQuery:false,multiSelect:true,useSelection:true,allowAdd:true,allowEdit:true,allowDelete:true,dataSource:H,moveMode:"newDialog",editMode:"newDialog",editDialogTemplate:"",editDialogTemplateSettings:{},editFullScreenTemplate:void 0,filterDialogTemplate:"",filterParams:{},setCursorOnLoad:false,mode:"oneClickMode",useHoverRowAsActive:false,setNewDataSourceWithParent:false,sumFields:{},reloadAfterChange:void 0,saveMarkerPositionAfterReload:true,delayedEvents:{onAfterRender:true},display:{columns:[],readOnly:false,showRecordsCount:true,showPaging:true,usePaging:"",recordsPerPage:20,pagesLeftRight:3,displayValue:"",emptyHtml:"",emptyTableHtml:"",reload:true,allowHorizontalScroll:true,showSelectionCheckbox:true,usePageSizeSelect:true,rowOptions:false,mainRowOptions:{recordUp:true,recordDown:true,edit:true,delete:true},userRowOptions:[],sequenceNumberColumn:"",rowOptionsPosition:"bottom",rowOptionsOffset:{right:0,bottom:0}}},_rootElement:"",_headContainer:void 0,_resizer:void 0,_head:"",_body:"",_foot:"",_footer:"",_data:"",_browserContainer:void 0,_browserContainerWrapper:void 0,_activeElement:false,_lastActiveElement:false,_bodyHeight:0,_bodyRealHeight:0,_wsBrowserContainer:false,_currentRecordSet:null,_initialSource:{},_initialFilter:{},_currentFilter:{},_currentFilterBeforeChange:{},_count:0,_hovered:0,_loadedForPathSelector:false,_sortingStack:[],_sortingMarkers:{},_paging:void 0,_pagingFilter:{},_selected:{},_selectedRecords:[],_selectMode:false,_dReady:void 0,_isUpdatingRecords:false,_actions:{},_emptyDataBlock:void 0,_emptyDataTextSet:true,_emptyDataText:null,_isFakeDelete:false,_fakeFocusDiv:null,_loadingIndicator:void 0,_onBeforeChangeRowEventResult:void 0,_footerDrawed:false,_applyingState:false,_scrollGapPlaceholder:false,_ajaxLoader:false,_menuButtons:{},_initialColumns:[],_dropped:false,_keysActions:{},_sumFieldsArray:[],_loadingTimer:void 0,_loadingReadTimer:void 0,_needHide:false,_highlight:"",_blockEdit:false,_systemParams:{},_keysWeHandle:[M.key.enter,M.key.down,M.key.up,M.key.del,M.key.insert,M.key.f3,M.key.esc,M.key.pageUp,M.key.minus,M.key.pageDown,M.key.space,M.key.q,M.key.n],_rowOptionsInitialized:false,_rowOptionsElement:void 0,_hasRowOptions:false,_rowOptionsMenu:void 0,_rowOptionsMenuDeferred:null,_rowOptionsHoverRow:void 0,_rowOptionsHoverRecord:void 0,_rowOptionsTargetRow:void 0,_rowOptionsMenuVisible:false,_rowOptionsButtons:{},_rowOptionsMenuButtons:[],_rowOptionsDisableStandart:false,_rowOptionsDefault:[],_rowOptions:{},_rowOptionsIsInit:false,_hiddenRowOptions:{},_rowOptionsShift:{},_allowChangePorNomer:true,_sequenceNumberObject:void 0,_filterFromState:null,_prevFilterFromState:null,_dataBindHandler:null,_setDataHandler:null,_clickEventsQueue:[],_rowSelectionSetted:false,_methodName:"static",_minimized:false,_isShowSelection:false,_selectedBeforeChoice:void 0,_initialRecordSet:false,_pageOptions:[],_pageOptionsContainer:void 0,_pageOptionsDropdown:false,_useKeyboard:false,_recordsOpened:[],_scrollWidth:void 0,_isGroupDelete:false,_inBeforeRenderActionCnt:0,_oldAdditionalHeight:null,_updateRecordMethodName:false,_isRecordFloatAreaOpen:false,_filterContextChangeHandlerBound:null,_reloadDebounced:null,_boundFields:{},_hasBoundFields:false,_lastLoadDeferred:null,_preventReloadForField:{},_isLoading:false,_headerContentFlags:{},_functionValues:{},_editDeferred:void 0,_isUpdateAfterReload:false,_isReady:false,_updatingAfterRemoveRecord:false},$constructor:function(e){var t=this;if(e.display&&e.display.hasOwnProperty("useSequenceNumbers"))k.resolve("ILogger").log("DataViewAbstract","Опция useSequenceNumbers удалена с 3.6.3. Используйте только sequenceNumberColumn.");if(this._filterContextChangeHandlerBound=this._filterContextChangeHandler.bind(this),this._reloadDebounced=a.call(this.reload,42),this._emptyDataText=this._options.display.emptyHtml,this._scrollWidth=y.getScrollWidth(),this._dReady=new E,this._firstLoadDeferred=new E,this._configChecking(),this._publishEvents(),F.declareCommand(this,"newItem",this._insertRecordItem),F.declareCommand(this,"edit",this._editRecord),F.declareCommand(this,"delete",this.deleteSelectedRecords),F.declareCommand(this,"confirmSelection",this.confirmSelection),F.declareCommand(this,"selectAll",this.selectAll),F.declareCommand(this,"removeSelection",this.removeSelection),F.declareCommand(this,"reload",this.reload),F.declareCommand(this,"showSelection",this.showSelection),this._mapColumns(),this._initialColumns=this._options.display.columns,this._createContainer(),this.setUseDefaultPrint)this.setUseDefaultPrint();if(this._initActionsFlags(),this._resetContext())this._context=D.createContext(this,null,this._context);if(this.getLinkedContext().subscribe("onFieldChange",this._filterContextChangeHandlerBound).subscribe("onDataBind",this._filterContextChangeHandlerBound),this._setSumFieldsArray(this._options.sumFields),void 0===this._options.reloadAfterChange)this._options.reloadAfterChange=this._options.display.reload;if(this._options.saveState)this.once("onInit",function(){t.once("onStateChanged",function(){t._constructorInitSource()}),t._notify("onStateChanged")});else this._constructorInitSource();if(this._initEvents(),this._initKeys(),!this._options.display.rowOptions)if(this._options.display.readOnly)this._menuButtons.view=[rk("Просмотреть")+" (F3)","sprite:icon-16 icon-Edit icon-primary","edit"];else this._menuButtons.edit=[rk("Редактировать")+" (F3)","sprite:icon-16 icon-Edit icon-primary","edit"];if(this._options.display.rowOptions&&this._options.useSelection)this._checkRowOptions();if(this._options.display.sequenceNumberColumn)this._sequenceNumberObject=new h("ПорядковыйНомер");if(!this._fakeFocusDiv)this._fakeFocusDiv=$("<div />",{style:"position: fixed; top: 0; left: 0; width: 1px; height: 1px;",tabindex:-1}),this._container.prepend(this._fakeFocusDiv)},_constructorInitSource:function(){if(this._initDataSource(),this._dataBindHandler=$.proxy(this._dataBind,this),!this._options.setNewDataSourceWithParent&&this._parent)this._parent.subscribe("onReady",this._dataBindHandler);else this._dataBind();this._options.dataSource.readerType=this._options.dataSource.readerType||"ReaderUnifiedSBIS"},_publishEvents:function(){this._publish("onAfterInsert","onAfterLoad","onAfterRender","onBeforeCreate","onBeforeDelete","onBeforeInsert","onBeforeLoad","onBeforeOpenEditWindow","onBeforeRead","onBeforeRender","onBeforeUpdate","onCalculateSum","onChangeSelection","onDataReady","onDeleteStart","onFilterChange","onLoadError","onNewAction","onRecordsChanged","onRowActivated","onRowClick","onBeforeChangeRow","onRowDoubleClick","onSelectEditMode","onSelectFormat","onSelectionConfirm","onSetCursor","onUpdateActions","onRowOptions")},isUseSelection:function(){return this._options.useSelection},_resetRowOptionsShift:function(){this._rowOptionsShift={top:M.Browser.rowOptionsElementsOffset.top-this._options.display.rowOptionsOffset.bottom,right:M.Browser.rowOptionsElementsOffset.right+(this._getVerticalScrollShowed()?this._scrollWidth:0)+this._options.display.rowOptionsOffset.right}},_resetContext:function(){return true},_preloadTemplates:function(){var e=new A({maxRunningCount:1,stopOnFirstError:false});this._collectTemplatesToPreload().forEach(function(t){e.push(function(){return _.attachTemplate(t,{fast:M.fasttemplate,preloadControls:true})})}),e.done()},_initComplete:function(){if("undefined"!==typeof window&&!Y.test(window.location.hash))setTimeout(this._preloadTemplates.bind(this),G);Z.superclass._initComplete.apply(this,arguments),this._heightChangedIfVisible()},_collectTemplatesToPreload:function(){if(this._options.editMode in Q)return[this._options.editDialogTemplate,this._options.editFullScreenTemplate];else return[]},_haveAutoWidth:function(){return this._options.autoWidth&&"Stretch"!==this._horizontalAlignment},_isHeightGrowable:function(){return this._options.autoHeight&&"Stretch"!==this._verticalAlignment},_isInBeforeRenderAction:function(){return this._inBeforeRenderActionCnt>0},markControl:function(e){var t=Z.superclass.markControl.apply(this,arguments);return this._onResizeHandler(),t},clearMark:function(){var e=Z.superclass.clearMark.apply(this,arguments);return this._onResizeHandler(),e},isReadOnly:function(){return this._options.display.readOnly},_getElementToFocus:function(){return this._fakeFocusDiv},_getComplexKey:function(e){if("string"===typeof e&&-1!==e.indexOf(M.IDENTITY_SPLITTER)){var t=e.split(M.IDENTITY_SPLITTER);return t[0]=parseInt(t[0],10),t}return e},show:function(){this._runInBatchUpdate("DataViewAbstract.show",function(){this._setVisibility(true),this._heightChangedIfVisible()})},_updateHeaderContentStyles:function(){var e=!!this._options.display.hasZebra;if(e)e=this._options.display.showHead&&this._headContainer.length>0&&Object.keys(this._headerContentFlags).reduce(function(e,t){return e||!!this._headerContentFlags[t]}.bind(this),false)||this._count>0;this._browserContainerWrapper.toggleClass("ws-browser-container-wrapper-zebra",e)},recalcBrowserOnDOMChange:function(){this._heightChangedIfVisible(false)},_onSizeChangedBatch:function(){return this._contentHeightChanged(),true},_heightChangedIfVisible:function(e){var t=this._isVisibleWithParents()&&!this._isInBeforeRenderAction();if(t)this._contentHeightChanged();if(this._notifyOnSizeChanged(this,this,!t),e&&M.browser.isIE)setTimeout(function(){this._heightChangedIfVisible(false)}.bind(this),0)},_isVisibleWithParents:function(){return v(this._container)},_notifyOnSizeChangedWithVisible:function(e){if(void 0===e)e=this._isVisibleWithParents();this._notifyOnSizeChanged(this,this,!e)},_notifyOnSizeChanged:function(){return this._setContainerHeightForRecalk(),Z.superclass._notifyOnSizeChanged.apply(this,arguments)},_setContainerHeightForRecalk:function(){if(this._isHeightGrowable()&&"Stretch"===this._horizontalAlignment)this._containerHeightForRecalk=this._container.get(0).offsetHeight},_checkContainerHeightForRecalk:function(){if(this._isHeightGrowable()&&"Stretch"===this._horizontalAlignment){var e=this._containerHeightForRecalk;if(this._setContainerHeightForRecalk(),this._containerHeightForRecalk!==e)this._notifyOnSizeChanged(this,this)}},_needShowSelectionCheckbox:function(){return this._options.display.showSelectionCheckbox&&false!==this._options.useSelection},setMultiSelect:function(e){if(this._options.multiSelect=!!e,this._options.display.showSelectionCheckbox=!!e,!e)this.removeSelection();this._colgroupCache=void 0,this._columnMap=[],this.refresh(true)},isMultiSelect:function(){return this._options.multiSelect},_getBodyElement:function(){return this._container.find(".ws-browser tbody")},_createContainer:function(){if(this._container.click(function(e){e.stopImmediatePropagation()}),this._resizer=this._container.find(".ws-browser-resizer"),0===this._resizer.length)this._resizer=null;if(this._rootElement=this._container.find(".ws-browser-data-container"),this._body=this._getBodyElement(),this._head=this._rootElement.find("thead"),this._foot=this._rootElement.find("tfoot"),this._footer=this._rootElement.find(".ws-browser-footer"),this._headContainer=this._rootElement.find(".ws-browser-head-container"),this._data=this._rootElement.find(".ws-browser"),this._browserContainer=this._rootElement.find(".ws-browser-container"),this._browserContainerWrapper=this._rootElement.find(".ws-browser-container-wrapper"),this._pageOptionsContainer=this._container.find(".ws-browser-page-selector"),this._emptyDataScroller=this._container.find(".ws-browser-empty-scroller"),this._emptyDataBlock=this._container.find(".ws-browser-empty"),this._isHeightGrowable())this._browserContainer.css("overflow-y","hidden");if(!this._options.display.allowHorizontalScroll)this._data.parent().css("overflow-x","hidden");if(this._options.autoHeight)this._container.height("auto"),this._data.parent().height("auto");if(this._options.display.width>0)this._browserContainer.width(this._options.display.width+"px"),this._rootElement.width(this._options.display.width+"px");this._updateHeaderContentStyles()},_configChecking:function(){if(this._options.display.useDrawingLines)this._options.display.useSeparating=false,this._options.display.hasZebra=false;if(this._options.display.usePaging){if(this._options.display.partiallyLoad=true,!this._container.hasClass("ws-browser-ignore-local-page-size"))if(this._options.display.recordsPerPage=C.get("ws-page-size")||this._options.display.recordsPerPage,this._options.display.recordsPerPage<=J)O.setParam("ws-page-size",String(this._options.display.recordsPerPage))}else this._options.display.showPaging=false;if(false===this._options.multiSelect)this._options.display.showSelectionCheckbox=false;this._initSystemParams();var e=this._options.dataSource?this._options.dataSource.readerParams||{}:{};if(!e.adapterType)e.adapterType="TransportAdapterRPCJSON";if(!$.isEmptyObject(e)){if(!e.linkedObject&&"TransportAdapterRPCJSON"===e.adapterType)this._options.dataSource.firstRequest=false;this._methodName=[e.linkedObject,e.queryName].join(".")}},_initSystemParams:function(){if(this._options.display.sequenceNumberColumn)this._systemParams["__ПорНомер__"]=this._options.display.sequenceNumberColumn},_getMenuButtons:function(){return[[rk("Очистить сортировку"),"sprite:icon-16 icon-Close icon-primary","clearSorting"]]},_actionEdit:function(e){var t=e instanceof Object&&"jquery"in e?e:this.getActiveElement();if(t&&"null"!==t.attr("rowkey"))this._showDialogForRecord(this.getActiveRecord(t))},_initActionsFlags:function(){var e=this._options.editDialogTemplate,t=this._options.display.readOnly,i=this;this._actions={addItem:e&&false!==this._options.allowAdd&&!t&&function(){i._showRecordDialog({})},edit:false!==this._options.allowEdit&&e&&this._actionEdit.bind(this),delete:!t&&false!==this._options.allowDelete&&function(e,t){if(t instanceof Object&&"jquery"in t&&(!i._activeElement||i._activeElement.attr("rowkey")!==t.attr("rowkey")))i.setActiveRow(t);i.deleteSelectedRecords([i.getActiveRecord()],true).addBoth(function(){i._toggleIndicator(true,false)})},recordUp:this._options.display.sequenceNumberColumn&&this._onRecordUpHandler.bind(this),recordDown:this._options.display.sequenceNumberColumn&&this._onRecordDownHandler.bind(this),filterParams:this._options.filterDialogTemplate&&function(){i.createFiltersDialog.apply(i,[])},clearFilter:this._options.filterDialogTemplate&&function(){i.resetFilter()},refresh:$.proxy(i.reload,i)}},getActions:function(){return o(this._actions)},isUseMergeRecords:function(){return this._options.useMergeRecords},isAllowMove:function(){return this._options.allowMove},_changeRecordSetHandlers:function(e){if(e instanceof c){var t=this;if(this._currentRecordSet=e,e.subscribe("onRecordUpdated",this._onRecordUpdated.bind(this)),e.subscribe("onRecordDeleted",this._onRecordDeleted.bind(this)),e.subscribe("onBeforeLoad",function(){t._minimized=false,t._isShowSelection=false}),this._paging)this._paging.setRecordSet(e);if(this._pathSelector instanceof Object)this._pathSelector.setBrowserRecordSet(e)}},_onDataLoadedBatchUpdateWrapper:T.ControlBatchUpdater.createBatchUpdateWrapper("_onDataLoaded wrap","_onDataLoaded"),setData:function(e,t){if(e instanceof c){var i=this,o=function(){if(i._setDataHandler)i._parent.unsubscribe("onReady",i._setDataHandler);if(t)i._initialRecordSet=e;if(e.subscribe("onBeforeLoad",i._onDataLoadStarted.bind(i)),e.subscribe("onAfterLoad",i._onDataLoadedBatchUpdateWrapper.bind(i)),i._changeRecordSetHandlers(e),i._container.hasClass("ws-browser-ignore-local-page-size"))i.setPageSize(e.getPageSize(),true);else i.setPageSize(C.get("ws-page-size")||e.getPageSize(),true);if(i.removeSelection(),!i._dReady.isReady())i._dReady.callback();if(i._pathSelector instanceof Object)i._pathSelector.setSource(e.getSource());if(i._hovered&&!i._options.setCursorOnLoad)i.setActiveElement(null);if(i._options.display.usePaging&&0!==i._currentRecordSet.getPageNumber())i.setPage(0,true);else i._onDataLoaded({},e,true)};if(e.getContext().isGlobal())e.setContext(D.createContext(i,null,i.getLinkedContext()));if(this._unbindParentHandlers(),this._parent&&!this._parent.isReady())this._parent.subscribe("onReady",this._setDataHandler=o);else o()}},recordSetReady:function(){return this._dReady},setSource:function(e){if(e instanceof Object){if(this._unbindParentHandlers(),this._isReloadStage=false,this._pathSelector instanceof Object)this._pathSelector.setSource(n({},e));this._options.dataSource=e,this.removeSelection(),this._dReady=new E,this._initDataSource(),this._dataBind()}},getDataSource:function(){return this._options.dataSource},setPage:function(e,t){if(e=parseInt(e,10),this._options.display.usePaging){var i=this;this._dReady.addCallback(function(){i._currentRecordSet.setPage(e,!t)})}},getPageNumber:function(){if(this._options.display.usePaging&&this._currentRecordSet)return this._currentRecordSet.getPageNumber();return 0},_setPageSize:function(e,t,i){if(this._options.display.recordsPerPage!==e){if(this._options.display.recordsPerPage=this._options.dataSource.rowsPerPage=e,!i&&e<=J&&!this._container.hasClass("ws-browser-ignore-local-page-size"))O.setParam("ws-page-size",String(e));var o=this;if(this._dReady.addCallback(function(){o._currentRecordSet.setPageSize(e,t)}),this._paging)this._paging.setPageSize(e),this._paging.update(1)}},_insertPageCount:function(e){for(var t=-1,i=0;i<this._pageOptions.length;++i)if(this._pageOptions[i]>=e){if(this._pageOptions[i]>e)this._pageOptions.splice(i,0,e);t=i;break}if(-1===t)this._pageOptions.push(e);if(this._pageOptionsDropdown){var o={};for(var s in this._pageOptions)if(this._pageOptions.hasOwnProperty(s))o[this._pageOptions[s]]=this._pageOptions[s];this._pageOptionsDropdown.setData(o),this._pageOptionsDropdown.setValue(e)}},setPageSize:function(e,t){if(this._options.display.usePaging&&e!==this._options.display.recordsPerPage)if(this._drawFooter(),this._setPageSize(e,t,true),this._options.display.usePageSizeSelect)this._insertPageCount(e)},getPageSize:function(){return this._options.display.recordsPerPage},_prepareQueryFilter:function(e){var t=this._prepareFilter(n({},e),true);for(var i in t)if(t.hasOwnProperty(i))if(void 0===t[i])delete t[i];return t},setQuery:function(e,t,i,o,s){var r=this,a=new E;return this._dReady.addCallback(function(){var l=r._prepareQueryFilter(n({},e));if(!i)r._currentRecordSet.setPage(0,true);else if("number"===typeof i)r._currentRecordSet.setPage(i,true);if(void 0!==o)r.setSorting(o,true);for(var h in r._prevFilterFromState)if(r._prevFilterFromState.hasOwnProperty(h)&&!l.hasOwnProperty(h))delete r._options.filterParams[h];r._prevFilterFromState=null,a.dependOn(r._runQuery(l,t,s))}),a},_getDefaultFilterContext:function(){var e=this.getParent();return(e?e.getLinkedContext():null)||D.global},_runQuery:function(e,t,i){var o=this,s=new E,r;return this._lastLoadDeferred=s,this._dReady.addCallback(function(){if(t=void 0===t?true:t,o._hasBoundFields)s.addCallback(function(){var e=o.getRecordSet().getQuery();for(var t in o._boundFields)if(o._boundFields.hasOwnProperty(t)){var i=o._boundFields[t];if(r=o._currentRecordSet.getContext().getFieldOrigin2(t),o._preventReloadForField[t]=1,i in e&&void 0!==e[i])(r=r||o._getDefaultFilterContext()).setValue(t,e[i]);else if(r)r.setValue(t,void 0)}o._preventReloadForField={}});s.dependOn(o._currentRecordSet.setQuery(e,t,void 0,i))}),s},getLastLoadDeferred:function(){return this._lastLoadDeferred?this._lastLoadDeferred:this._firstLoadDeferred},resetFilter:function(e){var t=this;this.recordSetReady().addCallback(function(){t._currentFilter=n({},t._initialFilter),t._currentRecordSet.resetFilter(t._currentFilter,e)})},getQuery:function(e){var t={},i=n({},this._currentFilter);if(e){for(var o in i)if(i.hasOwnProperty(o))if("array"===b(i[o]))delete i[o];n(i,this._prepareFilter(this._options.filterParams))}else this._prepareSystemParams(i);for(var s in i)if(i.hasOwnProperty(s)&&void 0===i[s])delete i[s];if(e){if(this._currentRecordSet){t=n({},this._initialSource.filterParams),n(t,this._functionValues),t=this._currentRecordSet.getUpdatedQuery(t),t=this._prepareSystemParams(t);for(var r in this._initialSource.filterParams)if(this._initialSource.filterParams.hasOwnProperty(r)&&!(b(this._initialSource.filterParams[r])in{object:0,function:0}))if(void 0!==this._currentFilter[r])t[r]=this._currentFilter[r]}return n(i,t,{rec:true})}else{if(this._currentRecordSet)t=this._currentRecordSet.getQuery();return n(i,t)}},_prepareSystemParams:function(e,t){var i=n({},e)||{};for(var o in this._systemParams)if(this._systemParams.hasOwnProperty(o)&&"object"!==b(o)&&(!e.hasOwnProperty(o)||true!==t))i[o]=void 0!==this._currentFilter[o]?this._currentFilter[o]:this._systemParams[o];return i},_prepareFilter:function(e,t,i){var o=this._prepareSystemParams(e,t);for(var s in o)if(o.hasOwnProperty(s))if(o[s]instanceof Object&&void 0!==o[s].fieldName)o[s]=this._context.getValue(o[s].fieldName);else if("function"===typeof o[s]&&!i)o[s]=o[s].apply(this,[this._context,s]),this._functionValues[s]=o[s];return o},_prepareDataSource:function(){var e=this._options.dataSource;if(!(e instanceof Object))return;if(this._filterFromState)[this._options.filterParams||{},this._options.dataSource&&this._options.dataSource.filterParams||{}].forEach(function(e){for(var t in e)if(e.hasOwnProperty(t)){var i=e[t],o;if(this._preventReloadForField[t]=1,t in this._filterFromState&&i&&"object"===typeof i&&"fieldName"in i)(o=this.getLinkedContext().getFieldOrigin(i.fieldName)||this._getDefaultFilterContext()).setValue(i.fieldName,this._filterFromState[t]),delete this._filterFromState[t];this._preventReloadForField={}}},this),this._options.filterParams=n(this._options.filterParams,this._filterFromState),this._prevFilterFromState=this._filterFromState,this._filterFromState=null;var t={filterParams:{},hierarchyField:this._options.display.hierColumn?this._options.display.hierColumn:"",rowsPerPage:this._options.display.recordsPerPage,usePages:this._options.display.usePaging,handlers:{onBeforeLoad:this._onDataLoadStarted.bind(this),onAfterLoad:this._onDataLoadedBatchUpdateWrapper.bind(this)}};this._options.dataSource.filterParams=n(this._options.dataSource.filterParams||{},this._options.filterParams,{preferSource:true}),this._options.dataSource.filterParams=this._prepareSystemParams(this._options.dataSource.filterParams),n(e,t)},_initDataSource:function(){var e=this._options.dataSource;this._enumFiltersToListen(this._options.filterParams,this._options.dataSource.filterParams),this._prepareDataSource(),this._initialSource=n({},e,{clone:true}),this._initialSource.context=this._context},_filterContextChangeHandler:function(e,t){var i,o,s=false;if(this._hasBoundFields&&null!==this._currentRecordSet)if(t){if(t in this._boundFields)if(!(t in this._preventReloadForField))if(this._currentFilter[this._boundFields[t]]!=this.getLinkedContext().getValue(t))this._reloadDebounced()}else{o=this.getQuery(),i=this.getLinkedContext();for(var r in this._boundFields)if(this._boundFields.hasOwnProperty(r))if(o[this._boundFields[r]]!=i.getValue(r))s=true;if(s)this._reloadDebounced()}},_enumFiltersToListen:function(){this._boundFields={};for(var e in arguments)if(arguments.hasOwnProperty(e)){var t=arguments[e];for(var i in t)if(t.hasOwnProperty(i)){var o=t[i];if(o&&o.fieldName&&o.autoreload)this._boundFields[o.fieldName]=i}}this._hasBoundFields=!Object.isEmpty(this._boundFields)},_dataBind:function(){var e=this,t=e._options.dataSource;if(this._parent)this._parent.unsubscribe("onReady",this._dataBindHandler);if(!(t instanceof Object))return false;var i=n({},t);if(i.context=this._context,this._savedPageNum)i.pageNum=this._savedPageNum;var o=this._options.filterParams?n({},this._options.filterParams):{};return o=n(o,t.filterParams),this._initialFilter=this._options.filterParams?this._prepareFilter(o):{},this._currentFilter=n({},this._initialFilter),n(i.filterParams,this._functionValues),W.require("Deprecated/RecordSet").addCallback(function(t){if(!e._dReady.isReady())e._changeRecordSetHandlers(new t[0](i)),e._dReady.callback();if(!e._isReady)e._notify("onReady"),e._isReady=true})},_hasFilterChanges:function(e){for(var t in e)if(e.hasOwnProperty(t))if("pageNum"!==t&&this._pagingFilter[t]!==e[t])return true;return false},_onDataLoadStarted:function(e,t){var i=this;if(!this._ajaxLoader)this._ajaxLoader=this._container.find(".ws-browser-ajax-loader");if(this._clearTimeOutLoadingIndicator(),this._loadingTimer=setTimeout(this._showLoadingIndicatorInTime.bind(i),M.Browser.loadingIndicatorDelay),this._currentFilterBeforeChange=t,this._notify("onFilterChange",t),this._paging&&this._hasFilterChanges(t))this._paging.clearMaxPage();this._pagingFilter=t,this._currentFilter=t,this._isLoading=true,this.getContainer().removeClass("ws-DataViewAbstract__dataLoaded"),this._notify("onBeforeLoad")},isLoading:function(){return this._isLoading},_resetSelectedRecords:function(){var e=[],t=this._storeKeysFromSelectedRecords();for(var i in this._selected)if(this._selected.hasOwnProperty(i))if(this._currentRecordSet.contains(i))e.push(this._currentRecordSet.getRecordByPrimaryKey(i)),this._selected[i]=e.length;else if(this._options.display.usePaging||this.isHierarchyMode())if(this._selected[i]=-1,t.hasOwnProperty(i))e.push(t[i]);this._selectedRecords=e},_storeKeysFromSelectedRecords:function(){for(var e={},t=0,i=this._selectedRecords.length;t<i;t++)e[this._selectedRecords[t].getKey()]=this._selectedRecords[t];return e},_onDataLoaded:function(e,t,i,o){var s=this;function r(){var e,r;if(i){if(s._currentRecordSet=t,s._notify("onAfterLoad"),s._onBeforeRenderActions()&&!s._isDestroyed){if(s._processPaging(),s._resetSelectedRecords(),s._columnMap&&s._columnMap.length>0)s._mapColumns();else s._refreshHead();if(""===s._turn&&s._pathSelector)s._findWay(s._currentRootId);var n=s.getActiveElement();if(s._loadedForPathSelector)s._loadedForPathSelector=false;else if(n)s._hovered=n.attr("rowkey");if(s._drawFooter(),s._drawBody(),s._updatePager(),this.recalcBrowserOnDOMChange(),s.getContainer().addClass("ws-DataViewAbstract__dataLoaded"),s._notifyBatchDelayed("onDataReady"),!s._firstLoadDeferred.isReady())s._firstLoadDeferred.callback();s._changeState()}}else{var a=s._options.dataSource.readerParams,l=a.linkedObject+"."+(a.queryName||"Список"),h=false,d=false,c=false,_=false;if(o instanceof q&&0!==o.httpError)h=403===o.httpError,d=429===o.httpError,c=true===s._notify("onLoadError",o,l),_=true;if(!c){if(s._body.empty(),s._rootElement.find(".ws-browser-pager-text").empty(),h)s._emptyDataBlock.html('<span class="ws-browser-deny">'+rk("Недостаточно прав для просмотра информации")+"</span>"),s._emptyDataTextSet=false;else if(d)if(this._nowLoading)this._nowLoading=false,this.setAllowScrollLoading(false),s._emptyDataBlock.html('<span class="ws-browser-deny">'+rk("Произошла ошибка при загрузке данных")+"</span>"),s._emptyDataTextSet=false;if(s._emptyDataText)s._emptyDataBlock.removeClass("ws-hidden");if(s._foot.addClass("ws-hidden"),s._heightChangedIfVisible(),_&&!h)g.alert(o,{checkAlreadyProcessed:true},s);o.processed=true}}return e}return this._runInBatchUpdate("_onDataLoaded",function(){try{r.call(s)}finally{if(!(!i&&0===o.code))s._hideLoadingIndicator()}})},_filterState:function(e){for(var t in e)if(e.hasOwnProperty(t)){var i=this._options.dataSource.filterParams[t];if(i&&"[object Object]"===Object.prototype.toString.call(i)&&false===i.saveToState)delete e[t];else if(e[t]instanceof Date)e[t]=e[t].toSQL(true)}},_getState:function(){var e;if(this._isNavigation()){var t=this.getActiveRecord();e=t?t.getKey():null}else{var i=this.getQuery();this._filterState(i),e=JSON.stringify(i)}return e},_changeState:function(e){if(!this._applyingState){var t=this._getState();if(t)this._notify("onStateChanged",t,this._isNavigation()?!e:false)}},_isNavigation:function(){return"navigationMode"===this._options.mode},applyState:function(e){var t=this;if(this._isNavigation()){var i=this.getActiveRecord(),o=i?i.getKey():null;if("null"!==e&&e!=o)this._applyingState=true,this._firstLoadDeferred.addCallback(function(){E.callbackWrapper("function"===typeof t.showBranch?t.showBranch(e):t.setActiveElement(t._body.find('[rowkey="'+e+'"]'),void 0,void 0,true),function(){t._applyingState=false})});else this.setActiveElement(this._body.find('[rowkey="'+(null===this._rootNode?"null":this._rootNode.toString())+'"]'))}else{var s;if(e===this._getState())return;try{s=$.parseJSON(e)}catch(e){s={}}if(s="object"==typeof s?s:{},$.isEmptyObject(this._initialSource))t._filterFromState=s;else this._dReady.addCallback(function(){t.setQuery(s)});var r=function(e,t){if(!e)return false;if(e.hasChildControlByName(t))return e.getChildControlByName(t);else return r(e.getParent(),t)};for(var n in s)if(s.hasOwnProperty(n)&&!(n in{pageCount:0,usePages:0}))if("pageNum"!==n){var a=this._initialFilter[n],l=a?a.fieldName:void 0,h=void 0!==l?r(this.getParent(),l):void 0;if(h instanceof T.DataBoundControl)h.setValue(s[n]);else if(void 0!==l)this.getLinkedContext().setValue(l,s[n])}else if(s[n])this._savedPageNum=s[n]}},_onBeforeRenderActions:function(){return true},_hideLoadingIndicator:function(){if(!this._ajaxLoader)this._ajaxLoader=this._container.find(".ws-browser-ajax-loader");this._clearTimeOutLoadingIndicator(),this._ajaxLoader.addClass("ws-hidden")},_showLoadingIndicatorInTime:function(){this._ajaxLoader.removeClass("ws-hidden")},_clearTimeOutLoadingIndicator:function(){if(void 0!==this._loadingTimer)clearTimeout(this._loadingTimer),this._loadingTimer=void 0},_processPaging:function(){var e=this._currentRecordSet.hasNextPage();if(this._pageChangeDeferred)this._pageChangeDeferred.callback([this._currentRecordSet.getPageNumber()+1,e,e]),this._pageChangeDeferred=void 0;if(this._paging){var t=this._paging.getPage();if(0===this.getRecordSet().getRecordCount()&&t>1)this._paging.setPage(t-1);this._paging.update(void 0,e,e)}},_reloadAfterRecordsChange:function(e){this._currentRecordSet.updatePages(),this._currentRecordSet.reload()},_updateAfterRecordsDelete:function(e){if(this._notify("onRecordsChanged"),this._options.reloadAfterChange){if(this._options.saveMarkerPositionAfterReload)this._updatingAfterRemoveRecord=true;this._reloadAfterRecordsChange(e)}},_onRecordDeleted:function(e,t,i){if(true===this._isFakeDelete)this._isFakeDelete=false;else{if(this._selected[t]>=0){if(!this._isGroupDelete)delete this._selectedRecords[this._selected[t]],this._recalcSelected(this._selected[t]),this._selectedRecords=this._getSelectedRecords(),delete this._selected[t];this._notifyBatchDelayed("onChangeSelection",i,false)}this._notify("onRecordsDeleted"),this._updateAfterRecordsDelete(i?[i]:[])}},_isIdEqual:function(e,t){if(void 0===e||void 0===t)return false;if("null"==e)e=null;if("null"==t)t=null;return e==t},_onRecordUpdated:function(e,t){if(this._minimized=false,this._isShowSelection=false,this._initialRecordSet=false,this._notify("onRecordsChanged"),this._isUpdatingRecords||this._notifyOnAfterInsert(t))return;if(this._options.reloadAfterChange)this.reload();else this._drawBody()},_notifyOnAfterInsert:function(e){var t=this;if("Insert"==this._updateRecordMethodName){var i=t.getRecordSet(),o;if(o=t._notify("onAfterInsert",e),"string"===typeof o)this.once("onAfterRender",function(){var e=t._body.find('[rowkey="'+o+'"]');if(0!==e.length)this.setActiveElement(e)});else if(o){t._isUpdatingRecords=true,t._updateRecordMethodName=false;var s=i.getRecordCount(),r=true===o?s:o.position?o.position:o,n=o.record?o.record:e;if(s>=r)i.clearRecord(i.getRecords()[s-1].getKey()),i.insertAfter(i.getRecords()[r-1-(s===r?1:0)].getKey(),n);return t.refresh(),t._isUpdatingRecords=false,true}}return false},_getNodeForRecordUpdate:function(){return null},_applySorting:function(){if(this._currentRecordSet&&this._currentRecordSet instanceof c){for(var e=[],t=0,i=this._sortingStack.length;t<i;++t)e.push();this._currentRecordSet.setPage(0,true),this._currentRecordSet.setSorting(e,false)}},checkRecord:function(e,t,i){return true},_initEvents:function(){var e=this,t=e._body.parent(),i=this._createBatchUpdateWrapper("DataViewAbstract.clickHandler",function(t){if(e._dropped||false===e._onBeforeChangeRowEventResult)return t.stopPropagation(),true;var i=$(this),o=i.closest("[rowkey]"),s=o.attr("rowkey"),r=o.hasClass("ws-browser-folder")?e._options.editBranchMode:e._options.editMode,n=s&&e._currentRecordSet.contains(s)?e._currentRecordSet.getRecordByPrimaryKey(s):void 0;if(e._onClickHandler(t),e.isEnabled()){var a=i.attr("coldefindex")?parseInt(i.attr("coldefindex"),10):void 0,l=void 0,h=void 0,d=e._isCorrectClickTarget(t);if(void 0!==a&&e._columnMap&&a>=0)l=e._columnMap[a].title,h=e._columnMap[a].field;if(e.checkRecord(n,o,t))if("dblclick"===t.type)e._dblClickHandler.apply(e,[o,n,l,h,d]);else e._oneClickHandler.apply(e,[o,n,l,h,d,t])}return d||"thisWindow"===r},true);this._rootElement.find(".ws-browser-container").bind("scroll",function(){if(e._hasRowOptions)e._hideRowOptions()}),t.on("click","[rowkey] > .ws-browser-cell",this._rowSelect=function(t){if(e.isEnabled()&&0===t.button&&!t._rowSelect){var i=$(this).closest(".ws-browser-table-row",e._body);if(e._onBeforeChangeRowEventResult=e._notify("onBeforeChangeRow"),i.length&&false!==e._onBeforeChangeRowEventResult&&e._currentRecordSet.isLoaded())e.setActiveElement(i,false,true,true);else t.stopImmediatePropagation()}}),t.wsFixedClick("[rowkey] > .ws-browser-cell",i,i)},_isCorrectClickTarget:function(e){var t=e.target,i=$(t);return"A"===t.tagName&&!(i.hasClass("ws-browser-edit-link")||i.hasClass("ws-browser-link"))&&(""!==t.href||"#"!==t.href)||!!i.closest("a",this.getContainer()[0]).length},_onScrollActions:function(){if(this._hasRowOptions)this._hideRowOptions()},getFiltersDialogName:function(){return this._options.filterDialogTemplate},createFiltersDialog:function(e,t){var i=this,o={onAfterClose:i._mouseMonitor.bind(i)},r={};if(t)r=i._columnMap[t];if(!e)e=this._options.filterDialogTemplate;else o["onBeforeApplyFilter"]=function(e,t){var o={},s=i.getQuery(),a=r.title;if(!Object.isEmpty(r))if(!Object.isEmpty(t)){for(var l in t)if(t.hasOwnProperty(l))if(l===a){o[l]=t[l];break}o=n(s,o)}else if(s[a])delete s[a],o=s;e.setResult(o)};this._useKeyboard=true,s.attachInstance("Deprecated/Controls/FiltersWindow/FiltersWindow",{template:e,context:D.createContext(i,null,i.getLinkedContext()),linkedBrowsers:[this.makeOwnerName()],handlers:o})},_drawBody:function(){if(this._hideRowOptions(),this._beforeDrawActions(),this._drawBodyCycle(),this._updateDataContainerClasses(),this._currentRecordSet.isInit()){var e=false;if(this._head.removeClass("ws-hidden"),!this._emptyDataTextSet){if(this._emptyDataTextSet=true,this._currentRecordSet.isEmptyTable())this._emptyDataText=this._options.display.emptyTableHtml,e=0===this._count,this._head.toggleClass("ws-hidden",e);else this._emptyDataText=this._options.display.emptyHtml;this._emptyDataBlock.html(this._emptyDataText)}else if(this._currentRecordSet.isEmptyTable())this._emptyDataTextSet=false,this._emptyDataText=this._options.display.emptyTableHtml,this._emptyDataBlock.html(this._emptyDataText),e=0===this._count,this._head.toggleClass("ws-hidden",e);if(e)this._headerContentFlags["headerRows"]=false;this._emptyDataBlock.toggleClass("ws-hidden",0!==this._count||!this._emptyDataText),this._foot.toggleClass("ws-hidden",0===this._count&&!!this._emptyDataText&&0===this.getPageNumber())}if(this._rootElement.height("auto"),this._updateHeaderContentStyles(),this._heightChangedIfVisible(),this._updateSelection(),this._updateSelectedCheckboxes(),this._body.find(".ws-browser-table-row[rowkey]").eq(-1).addClass("ws-browser-no-table-row-last"),this._options.delayedEvents.onAfterRender)this._runBatchDelayedFunc("drawBody.onAfterRender",function(){this._notifyOnAfterRender()});else this._notifyOnAfterRender();this._lastActiveElement=this._activeElement},_notifyOnAfterRender:function(){if(true===this._notify("onAfterRender"))this.recalcBrowserOnDOMChange()},_updateDataContainerClasses:function(){this._data.addClass(this._options.useSelection?this._options.useHoverRowAsActive?"ws-browser-active-hover":"ws-browser-hover":"ws-browser-selection-none"),this._data.toggleClass("ws-browser-hasZebra",!!this._options.display.hasZebra).toggleClass("ws-browser-hasToolbar",!!this._options.display.showToolbar&&!this._options.display.showHead).toggleClass("ws-one-click-browser","oneClickMode"===this._options.mode)},_beforeDrawActions:function(){if(this._options.display.rowOptions)this._hideRowOptions()},_contentHeightChanged:function(){this._setHeight()},_drawBodyCycle:function(){throw new Error("DataViewAbstract::_drawBodyCycle must be implemented in child classes")},_reloadBody:function(){this._drawBody()},_updateSelection:function(e){var t=this.isActive(),i=this._options.useHoverRowAsActive&&t,o=this._hovered||!this._hovered&&!this._options.useHoverRowAsActive&&this._options.setCursorOnLoad,s=this.getActiveElement(),r=[s,s&&s.prev(),s&&s.next()],n,a,l,h;if(this._options.saveMarkerPositionAfterReload&&this._isUpdateAfterReload)if(a=this._currentRecordSet.checkSnapShot(),this._isUpdateAfterReload=false,a.length){if(this._updatingAfterRemoveRecord)this._updatingAfterRemoveRecord=false;else if(a.length>1)n=this._getLastActiveRow(),this.setActiveElement(n.is(":visible")?n:this._body.find('[rowkey="'+a[0].id+'"]'));else this.setActiveElement(this._body.find('[rowkey="'+a[0].id+'"]'));this._currentRecordSet._snapShotColumns=[]}else for(var d,c=0;c<r.length;c++)if(r[c].length)if(d=this._body.find('[rowkey="'+r[c].attr("rowkey")+'"]'),d.length){this.setActiveElement(d),h=true;break}if(!this._options.saveMarkerPositionAfterReload||!h){if(i||o)if(l=this._getLastActiveRow(),1!==l.length||l.hasClass("ws-hidden"))l=this._body.find("[rowkey]").eq(0);if(o)if(!l.length){if(this._activeElement=void 0,this._hovered=void 0,!e)this._notifySetCursor(void 0);if(t)this._getElementToFocus().focus()}else this.setActiveElement(l,void 0,e);else if(i)if(l.length&&t)l.attr("tabindex","-1"),this._focusRow(l)}},_getLastActiveRow:function(){return this._body.find(this._hovered?'[rowkey="'+this._hovered+'"]':":first")},_notifySetCursor:function(e){if(!this._rowSelectionSetted)this._runBatchDelayedFunc("onSetCursor",function(){var t=e?this._body.find('[rowkey="'+e.getKey()+'"]'):$();this._notify("onSetCursor",t,e)});else this._rowSelectionSetted=false},_drawFooter:function(){if(!this._footerDrawed)if(this._footerDrawed=true,this._options.display.showRecordsCount)if(this._options.display.usePaging&&this._options.display.usePageSizeSelect){this._pageOptions=this._pageOptions.concat(M.Browser.pageSizes);var e=this,t=D.createContext(e,null,e.getLinkedContext());t.setValue("page-select-dropdown"+this._id,this._options.display.recordsPerPage),this._insertPageCount(this._options.display.recordsPerPage),this._pageOptionsDropdown=new x({enabled:true,parent:this.getParent(),flipVertical:true,element:this._container.find(".ws-browser-pager-select"),width:"100%",renderStyle:"simple",showSelectedInList:false,data:{keys:this._pageOptions,values:this._pageOptions},wordWrap:false,allowChangeEnable:false,linkedContext:t,name:"page-select-dropdown"+this._id,value:this._options.display.recordsPerPage,handlers:{onChange:function(){e._dropPageSave(),e._setPageSize(this.getValue())}}}),this._foot.find(".ws-browser-pager").removeClass("ws-hidden").bind("click",function(t){var i=e._foot.find(".custom-select-arrow");if(i.is(":visible"))i.click();return t.stopImmediatePropagation(),true})}},isHierarchyMode:function(){return false},_elementActivated:function(e,t){var i=this.getActiveRecord(e);if(i instanceof d){if(t=t?t:false,this._selectMode&&!t)return void this.confirmSelection([i]);if(false!==this._notify("onRowActivated",e,i))this._showDialogForRecord(i)}},_showDialogForRecord:function(e){this._showRecordDialog({recordId:e.getKey()})},_dblClickHandler:function(e,t,i,o,s){var r=this._handlersNotifier("onRowDoubleClick",e,t,i,o);if(!s&&false!==r&&"oneClickMode"!==this._options.mode)this._elementActivated(e);return r},_oneClickHandler:function(e,t,i,o,s,r){var n=this._handlersNotifier("onRowClick",e,t,i,o,r);if(!s&&false!==n&&"oneClickMode"===this._options.mode)this._elementActivated(e);return n},_handlersNotifier:function(e,t,i,o,s,r){if("onRowDoubleClick"===e)m.clearSelection();return this._notifySetCursor(i),this._notify(e,t,i,o,s,r)},_processElementClick:function(e,t){this._notifySetCursor(t)},_insertRecordItem:function(e){return this._showRecordDialog({parentId:null},e)},_editRecord:function(e,t){if(t)this._editDeferred=t;if(e){var i=this._body.find('.ws-browser-table-row[rowkey="'+e+'"]');if(i.length)this.setActiveRow(i);else{if(false!==this._notify("onRowActivated",null,null))this._showRecordDialog({recordId:e});return true}}return this._elementActivated(this.getActiveElement(),true),true},deleteRecordsByFilter:function(e,t){var i=new E;if(!this.isReadOnly()&&false!==this._options.allowDelete){var o=this,r=e?e:this.getQuery(),n=function(e){o.getRecordsCount().addCallback(function(n){if(0!==n)s.attachInstance("Deprecated/Controls/DialogConfirm/DialogConfirm",{resizable:false,opener:o,message:e?e:rk("Удалить")+" "+(n?n:"")+(n?+l(n," "+rk("записей")," "+rk("запись","множественное")," "+rk("записи")):" "+rk("записи"))+"?",detail:rk("Внимание: данные удаляются окончательно без возможности восстановления"),handlers:{onConfirm:function(e,s){if(s)o.getRecordSet().deleteRecordsByFilter(r,t).addCallback(function(){i.callback(true)});else i.callback()}}})})};this._onDeleteStartHandler(n,r)}return i},deleteSelectedRecords:function(e,t){var o;if("array"===b(e))o=e.length&&e[0]instanceof d;else o=this.getSelection().length;if(this._options.display.readOnly||false===this._options.allowDelete||!o)return E.fail();var s=[],r=e&&e[0]instanceof d,n=r?e:this.getSelection(),a=n.length,h=new E,c=this,_,f=c.getActiveElement();return _=function(o){c._useKeyboard=true;var d=c.getSelection(true);if(r)d=t?[]:e;var _=d.length,u=_?(_>1?rk("отмечено")+" ":rk("отмечена")+" ")+_+" "+l(_,rk("записей"),rk("запись","множественное"),rk("записи")):"";if(!o)o=_?rk("Удалить")+" "+(1===_?" "+rk("отмеченную запись"):" "+rk("отмеченные записи"))+"?":rk("Удалить текущую запись?");g.question(o?o:rk("Удалить отмеченные записи?"),{detail:u},c).addCallback(function(t){if(true===t){c._toggleIndicator(true,true);var o=0;for(o=0;o<a;o++)s.push(n[o].getKey());var r=c._notify("onBeforeDelete",n);if(false!==r){if(r instanceof Array)s=r;for(var l={},d=[],_=c._recordsOpened.length-1;_>=0;--_){var u=false,p,m=c._recordsOpened[_];try{u=(p=(p=(p=m.win.location.href).substr(0,p.search(/\?/))).substr(p.search(/[^\/]\/[^\/]/)+2))===m.url}catch(e){}if(!u)c._recordsOpened.splice(_,1);else l[m.rec]=true}if(!Object.isEmpty(l)){var y=[];for(o=0,a=s.length;o<a;o++)if(l[s[o]])d.push(rk("Запись уже открыта в другой вкладке"));else y.push(s[o]);s=y}c._beforeDeleteActions(s),i.setCursor(false),c.getRecordSet().deleteRecord(s).addCallback(function(){if(!c._options.reloadAfterChange)c._toggleIndicator(true,false);if(f){var e=f.next();if(e=!e.hasClass("ws-browser-add-at-place-link-row")&&e.length?e:f.prev(),e&&e.length>0)c.setActiveElement(e,false)}h.callback(true)}).addErrback(function(e){var t=c._options.dataSource.readerParams,i=t.linkedObject+".";if(c._toggleIndicator(true,false),i+=t.destroyMethodName||"Удалить",e instanceof q&&0!==e.httpError&&true!==c._notify("onLoadError",e,i))d.push(e),e.processed=true;return s=[],e}).addBoth(function(){if(i.setCursor(true),d.length)if(d.length>1)w({title:rk('Итоги операции: "Удалить"'),numSelected:e.length,numSuccess:s.length,errors:d});else g.alert(d[0],{},c)})}else c._toggleIndicator(true,false),h.callback();c.removeSelection()}c.setActive(true),c._useKeyboard=false;var R=c.getActiveElement();if(R)R.focus()})},this._onDeleteStartHandler(_,n),h},_beforeDeleteActions:function(e){},_onDeleteStartHandler:function(e,t){var i=this._notify("onDeleteStart",t);if("string"===typeof i)e.apply(this,[i]);else if(i instanceof E)i.addCallback(e);else if(false!==i)e.apply(this)},getPagingMode:function(){return this._options.display.usePaging},getRecordsCount:function(){var e=new E,t=this.getQuery(),i=this.getDataSource().readerParams,o=this.getRecordSet();if(e.addErrback(function(e){return e}),"parts"===this.getPagingMode()&&!(0===o.getPageNumber()&&!o.hasNextPage()))new h(i.linkedObject).query(i.queryName||"Список",t,{type:"full",page:0,pageSize:0}).addCallbacks(function(t){e.callback(0!==t.getRecordCount()?t.hasNextPage():void 0)},function(t){e.errback(t.message)});else if("full"===this.getPagingMode())e.callback(o.hasNextPage());else e.callback(o.getRecordCount());return e},clearSorting:function(){if(!this._sortingStack.length)return;this._head.find(".ws-browser-sortable").removeClass("asc").removeClass("desc").addClass("none"),this._sortingStack=[],this._currentRecordSet.setPage(0,true),this._currentRecordSet.setSorting([],this.getQuery(),false)},_isCtrl:function(e){return e.ctrlKey&&!e.altKey&&!e.shiftKey},_isNotModified:function(e){return!e.ctrlKey&&!e.altKey&&!e.shiftKey},_mouseMonitor:function(){var e=this,t=function(){e._useKeyboard=false,e._body.parent().off("mousemove","[rowkey]",t)};e._body.parent().on("mousemove","[rowkey]",t)},_keyboardHover:function(e){var t=this._keyboardShortcut(e),i=t||false,o=this;if(!this._currentRecordSet||!this._currentRecordSet.isLoaded())return i;if(this.isActive()){var s=this.getActiveElement(),r=s?s.next(".ws-visible:first"):[],n=s?s.prev(".ws-visible:first"):[],a=r.length>0?r:null,l=n.length>0?n:null;if(e.ctrlKey&&e.which===M.key.space)if(!this._isShowSelection)this.showSelection(true);else this.showSelection(false);else if(this._isNotModified(e)&&(e.which===M.key.f5||e.which===M.key.pageUp||e.which===M.key.pageDown))i=true;else if(this._isCtrl(e)&&e.which===M.key.n)this.reload();else if(this._isNotModified(e)&&e.which===M.key.minus)this.removeSelection();else if(this._isCtrl(e)&&e.which===M.key.q){if(this._options.filterDialogTemplate)this.createFiltersDialog()}else if(e.which===M.key.enter&&(this._selectMode||e.ctrlKey)&&!e.altKey&&!e.shiftKey){if(false===this._options.multiSelect)if(false!==this.getActiveRow())this._selectedRecords=[],this._selectActiveElement();if(this.confirmSelection(),e.ctrlKey||this._selectMode)e.stopPropagation(),e.preventDefault()}else if(this._isCtrl(e)&&(e.which===M.key.pageDown||e.which===M.key.pageUp))this.setActiveElement(this._body.find(".ws-visible:"+(e.which===M.key.pageDown?"last":"first"))),e.stopPropagation(),e.preventDefault();else if(this._isNotModified(e)&&(e.which===M.key.down||e.which===M.key.up)){if(this._options.useHoverRowAsActive&&!this._useKeyboard)this._useKeyboard=true,this._mouseMonitor();var h=e.which===M.key.down?a:l;if(h&&!h.hasClass("ws-browser-add-at-place-link-row"))if(this.setActiveElement(h),this._options.useHoverRowAsActive)o._showRowOptions.apply(o,[h[0]])}else if(this._isNotModified(e)&&e.which===M.key.space){if($(e.target).hasClass("input-string-field")||$(e.target).hasClass("textarea-field"))i=true;else if(false!==this._options.useSelection){if(this._options.multiSelect||this._activeElement&&this._activeElement.hasClass("ws-browser-selected"))this._selectActiveElement();if(a&&!a.hasClass("ws-browser-add-at-place-link-row"))this.setActiveElement(a)}}else if(this._isNotModified(e)&&e.which===M.key.esc)i=true;else if(void 0===t)i=true}else if(void 0===t)i=true;return i},_initKeys:function(){this._registerShortcut(M.key.del,M.modifiers.nothing,this.deleteSelectedRecords),this._registerShortcut(M.key.insert,M.modifiers.nothing,this._insertRecordKey),this._registerShortcut(M.key.f3,M.modifiers.nothing,this._editCurrentRow),this._registerShortcut(M.key.enter,M.modifiers.nothing,this._enterKey)},_insertRecordKey:function(){var e=this._actions["addItem"];if(this.isEnabled()&&e&&!this.isReadOnly())e(this.getActiveElement(),false)},_editCurrentRow:function(){var e=this.getActiveRow();if(this.isEnabled()&&e&&!this._selectMode)return this._elementActivated(e,true),false;return true},setActiveRow:function(e){this.setActiveElement(e)},getActiveRow:function(){return this.getActiveElement()},_enterKey:function(){if(!this._selectMode)return this._editCurrentRow();return true},_prepareCreateFilter:function(){return n({},this.getQuery())},_readRecord:function(e,t){var i=this,o;if(void 0===e){var s=i._prepareCreateFilter.apply(i,arguments),r;if(s=n(s,t||{}),r=i._notify("onBeforeCreate",null,null,s),false===r)return false;if(r instanceof E){var a=new E;return a.addErrback(function(e){return e}),r.addCallbacks(function(e){if(e instanceof d)a.callback(e);else{if(e&&"[object Object]"==Object.prototype.toString.call(e))s=n(s,e);s["ВызовИзБраузера"]=true,i._currentRecordSet.createRecord(s).addCallbacks(function(e){a.callback(e)},function(e){return a.errback(e),e})}},function(e){return a.errback(e),e}),a}else if(r instanceof d)return(new E).callback(r);else{if(r&&"[object Object]"===Object.prototype.toString.call(r))s=n(s,r);return s["ВызовИзБраузера"]=true,o=i._notify("onSelectFormat",void 0,this._options.dataSource.readerParams.format),i._currentRecordSet.createRecord(s,o)}}else{var l=i._notify("onBeforeRead",e);if(l instanceof E)return l;else if(l instanceof d)return(new E).callback(l);else return o=i._notify("onSelectFormat",e,this._options.dataSource.readerParams.format),i._currentRecordSet.readRecord(e,o)}},_recordErrorHandler:function(e,t){var i=this._options.dataSource.readerParams,o=i.linkedObject+".";if(void 0===t)o+=i.createMethodName||"Создать";else o+=i.readMethodName||"Прочитать";if(e instanceof q&&0!==e.httpError&&true!==this._notify("onLoadError",e,o))g.alert(e,{checkAlreadyProcessed:true},this);return e.processed=true,e},_checkShowDialog:function(e,t){return this._options.display.readOnly&&!e||void 0===e&&false===this._options.allowAdd},_showRecordDialog:function(e,t){if(this.isEnabled()&&this._checkShowDialog(e.recordId,t))return false;var i=this._options.editMode,o=this._options.editDialogTemplate;if(""!==o)return this._editRecordWithMode(e,i,o,this._options.editFullScreenTemplate,t),true;return false},_editRecordWithMode:function(e,t,i,o,s){var r=this._notify("onSelectEditMode",e.recordId,e.isBranch||false,e.parentId||null,t,i);if("string"===typeof r&&r in{newDialog:0,newWindow:0,thisWindow:0,thisPage:0,newFloatArea:0})t=r;if("newWindow"===t||"thisWindow"===t)this._openEditWindow(e,void 0,t);else if("thisPage"===t)this._editRecordInThisPage(e,i);else if(!this._blockEdit)this._showDialogForRecordId(e,i,"newFloatArea"===t?"RecordFloatArea":"DialogRecord",o,s)},_editRecordInThisPage:function(e,t){var i=this.getTopParent();if(D.global.setValue("editParams",this._generateEditPageURL(e)),r.instanceOfModule(i,"Lib/Control/AreaAbstract/AreaAbstract"))U(t,void 0,i.getTemplateName())},_getRecordFromConfig:function(e,t){return this._readRecord(e.recordId,t)},_showDialogForRecordId:function(e,t,o,s,n){var a=this,l;i.setCursor(false),this._blockEdit=true,this._showIndicator("RecordFloatArea"===o),function(){var t=new E,i=a.getTopParent();if(t.addCallback(function(){return a._getRecordFromConfig.apply(a,[e,n])}),r.instanceOfModule(i,"Lib/Control/AreaAbstract/AreaAbstract"))i.waitAllPendingOperations(t);else t.callback();return t}().addBoth(function(e){return i.setCursor(true),e}).addCallback(function(i){if(false===i)return a._blockEdit=false,void a._hideIndicator("RecordFloatArea"===o);if(a._updateRecordMethodName=void 0===e.recordId?"Insert":"Update",l=a._notify("onBefore"+a._updateRecordMethodName,i),"boolean"!==typeof l){if("string"==typeof l)t=l;else if("object"==typeof l&&null!==l)t=l.editTemplate,s=l.editFullScreenTemplate?l.editFullScreenTemplate:s;a._showDialog(t,i,e.recordId,o,s)}else if(a._blockEdit=false,a._useKeyboard=false,a._hideIndicator("RecordFloatArea"===o),void 0===e.recordId&&false===l&&null!==i.getKey())a._isFakeDelete=true,i.destroy()}).addErrback(function(t){return a._blockEdit=false,a._useKeyboard=false,a._hideIndicator("RecordFloatArea"===o),a._recordErrorHandler(t,e.recordId)})},_toggleIndicator:function(e,t){if(true===e){if(!this._ajaxLoader)this._ajaxLoader=this._container.find(".ws-browser-ajax-loader");this._ajaxLoader.toggleClass("ws-hidden",!t)}else p.toggleIndicator(t)},_showIndicator:function(e){var t=this;t._needHide=false,this._loadingReadTimer=setTimeout(function(){t._toggleIndicator(e,true),t._needHide=true},M.Browser.loadingIndicatorForReadDelay)},_hideIndicator:function(e){if(this._loadingReadTimer)clearTimeout(this._loadingReadTimer),this._loadingReadTimer=void 0;if(this._needHide)this._toggleIndicator(e,false)},_onAfterCloseRecordDialog:function(e,t,i,o){if(this._useKeyboard=false,this._hideIndicator(true),!e&&void 0===t&&null!==i.getKey())this._isFakeDelete=true,i.destroy();else if(null!==o){var s=this,r=function(){var e=s._body.find('[rowkey="'+o+'"]');if(0!==e.length)this.setActiveElement(e)},n=this.getActiveElement(),a;if("Идентификатор"===s._currentRecordSet.getPkColumnType()&&(!n||(a=n.attr("rowkey"))&&-1!==a.indexOf(",")))o=[o,s._currentRecordSet.getLinkedObjectName()].join(",");if(0!==this._body.find('[rowkey="'+o+'"]').length)r.call(this);else this.once("onAfterRender",r)}},_onBeforeSaveRecordDialog:function(e,t){},_showDialog:function(e,t,i,o,a){var l=this,h=false,d=null,c=D.createContext(l,null,l.getLinkedContext()),_={onAfterClose:function(){if("RecordFloatArea"===o)if(this===l._isRecordFloatAreaOpen)l._isRecordFloatAreaOpen=false;l._onAfterCloseRecordDialog(h,i,t,d)},onRecordUpdate:function(e,o){if(h=true,void 0===i)d=o;l._onBeforeSaveRecordDialog(e,t)},onReady:function(){if("RecordFloatArea"===o)l._isRecordFloatAreaOpen=this;else l._blockEdit=false,l._hideIndicator("RecordFloatArea"===o)},onAfterShow:function(){if(l._editDeferred instanceof E)l._editDeferred.callback(this)},onBeforeShow:function(){if(r.instanceOfModule(l._rowOptionsMenu,"Deprecated/Controls/Menu/Menu")&&l._rowOptionsMenu.isShow())l._rowOptionsMenu.hide()},onDestroy:function(){if("RecordFloatArea"===o)l._blockEdit=false,l._hideIndicator(true);c.destroy(),c=null}},f=n({opener:l,template:e,record:t,linkedContext:c,readOnly:l._options.display.readOnly,newRecord:void 0===i,handlers:_},this._options.editDialogTemplateSettings);if("RecordFloatArea"===o)this._showRecordFloatArea(f,e,t,a);else s.attachInstance("Deprecated/Controls/DialogRecord/DialogRecord",f)},_showRecordFloatArea:function(e,t,i,o){var r=this,n=r._isRecordFloatAreaOpen&&r._isRecordFloatAreaOpen.getTemplateName()!==t,a=function(){r._lastActiveElement=r._activeElement,s.attachInstance("Deprecated/Controls/RecordFloatArea/RecordFloatArea",e)};if(e.name=this.getName()+"-area",e.target=null===this.getParent()?this.getContainer():this.getParent().getContainer(),e.side="right",e.autoHide=!!this._options.editDialogTemplateSettings.autoHide,e.doNotLossFocus=true,e.showDelay=300,e.animationLength=300,e.parent=null,e.isModal=false,e.isStack=true,e.overlay=this._selectMode,e.handlers["onAfterShow"]=[e.handlers["onAfterShow"]],e.handlers["onAfterShow"].push(function(){r._blockEdit=false,r._hideIndicator(true)}),e.offset={x:1,y:0},o)e.editFullScreenTemplate=o;if(this._isRecordFloatAreaOpen)r._blockEdit=false,r._hideIndicator(true),this._isRecordFloatAreaOpen.openConfirmDialog(true).addCallback(function(t){if(t){if(n||r._isRecordFloatAreaOpen.isNewRecord()!==e.newRecord)r._blockEdit=true,r._isRecordFloatAreaOpen.subscribe("onDestroy",a),r._isRecordFloatAreaOpen.close();else if(i.getKey()!==r._isRecordFloatAreaOpen.getRecord().getKey())r._isRecordFloatAreaOpen.setRecord(i,true),r._lastActiveElement=r._activeElement,r._isRecordFloatAreaOpen&&r._isRecordFloatAreaOpen.setActive(true)}else if(r._lastActiveElement)r.setActiveElement(r._lastActiveElement)});else if(!n)a()},openWindowRecord:function(e,t){this._openEditWindow({recordId:e},t)},_prepareEditParams:function(e){var t=this._options.dataSource.readerParams,i=e.dataSource,o=i.readerParams,s=t.format;if(void 0!==s)i.readerParams["format"]=s;if(s=this._options.dataSource.readerType,s&&"ReaderUnifiedSBIS"!==s)i["readerType"]=s;if(s=t.otherURL,s&&s!==M.defaultServiceUrl)o["otherURL"]=s;if(s=t.dbScheme,s)o["dbScheme"]=s;if(s=t.queryName,s&&"Список"!==s)o["queryName"]=s;if(s=t.readMethodName,s&&"Прочитать"!==s)o["readMethodName"]=s;if(s=t.createMethodName,s&&"Создать"!==s)o["createMethodName"]=s;if(s=t.updateMethodName,s&&"Записать"!==s)o["updateMethodName"]=s;if(s=t.destroyMethodName,s&&"Удалить"!==s)o["destroyMethodName"]=s;if(e.handlers["onBeforeRead"]=this._handlersPath("onBeforeRead"),e.handlers["onBeforeUpdate"]=this._handlersPath("onBeforeUpdate"),this._options.reports&&!Object.isEmpty(this._options.reports))e["reports"]=this._options.reports,e.handlers["onBeforeShowPrintReports"]=this._handlersPath("onBeforeShowPrintReports"),e.handlers["onPrepareReportData"]=this._handlersPath("onPrepareReportData"),e.handlers["onSelectReportTransform"]=this._handlersPath("onSelectReportTransform");return e},_generateEditPageURL:function(e,t){return this.generateEditPageURL(e.recordId,t)},generateEditPageURL:function(e,t,i,o){if(this._options.editDialogTemplate||this._options.editFullScreenTemplate){var s=this._options.editMode,r=this._options.editFullScreenTemplate,n={onBeforeRead:this._handlersPath("onBeforeRead"),onBeforeUpdate:this._handlersPath("onBeforeUpdate"),onBeforeShowPrintReports:this._handlersPath("onBeforeShowPrintReports"),onPrepareReportData:this._handlersPath("onPrepareReportData"),onSelectReportTransform:this._handlersPath("onSelectReportTransform"),onLoadError:this._handlersPath("onLoadError")},a={recordId:e,editDialogTemplate:o?o:r&&"newFloatArea"==s?r:this._options.editDialogTemplate,id:this.getId(),readOnly:this._options.display.readOnly||false,dataSource:{readerParams:{linkedObject:this._options.dataSource.readerParams.linkedObject}},reports:this._options.reports,handlers:n,changedRecordValues:i,history:"thisWindow"===s};if(void 0===e)a["filter"]=this.getQuery(),a.handlers["onBeforeCreate"]=this._handlersPath("onBeforeCreate"),a.handlers["onBeforeInsert"]=this._handlersPath("onBeforeInsert");return a=this._prepareEditParams(a),f.generatePageURL(a,"thisPage"===s,t)}else return false},_openEditWindow:function(e,t,i){var o=t?t:this._generateEditPageURL(e,t),s=i||this._options.editMode;this._openEditWindowByUrl(o,s,e.recordId)},_openEditWindowByUrl:function(e,t,i){var o=this._notify("onBeforeOpenEditWindow",e),s;if("string"===typeof o)e=o;if(false!==o)if("thisWindow"==t)P.set("previousUrl",window.location.href),window.open(e,"_self");else if(s=window.open(e,"_blank"),this._recordsOpened.push({rec:i,url:e.substr(0,e.search(/\?/)),win:s}),s)s.focus()},scrollToActive:function(e){if(this._updateBodyHeight(),this._bodyHeight<this._bodyRealHeight&&e&&"jquery"in e){if(!this._wsBrowserContainer)this._wsBrowserContainer=this._data.parent();var t=this._wsBrowserContainer.position().top,i=this._wsBrowserContainer[0].clientHeight,o=e.height(),s=this._wsBrowserContainer.scrollTop(),r=s+e.position().top-t;if(r+o>s+i)this._wsBrowserContainer.scrollTop(r+o-i);else if(r<s)this._wsBrowserContainer.scrollTop(r)}},refresh:function(){if(this._dReady.isReady()&&this._currentRecordSet)if(this._rowSelectionSetted=false,this._onBeforeRenderActions())this._drawBody()},reload:function(){if(this.isDestroyed())return(new E).callback();this._useKeyboard=false,this._isUpdateAfterReload=true,this._currentRecordSet&&this._currentRecordSet.storeSnapShot(this._currentRecordSet.getColumns());var e=this.getQuery(true);return this._runQuery(e,true)},clear:function(){var e=this.getRecordSet();if(0!==e.getRecordCount()){if(e.clear(),this.refresh(),this._paging)this._paging.update(void 0,0);this._updatePager(),this.removeSelection()}},performFunction:function(e){var t=this.getSelection(),i=new A,o=this;o._isUpdatingRecords=true;for(var s=0,r=t.length;s<r;s++)i.push(e(t[s]));i.done(),i.getResult().addCallback(function(){o._isUpdatingRecords=false,o.reload()})},getActiveElement:function(){if(true===this._options.useHoverRowAsActive&&this._hovered){var e=this._body.find("[rowkey].ws-browser-row-selected");return e.length>0?e:false}else if(this._activeElement)return this._activeElement;else return false},_isDisabledRow:function(e){if(e&&e instanceof jQuery)return e.hasClass("ws-browser-disabled-item");return false},getEmptyDataText:function(){return this._emptyDataText},setActiveElement:function(e,t,i,o){if((null===e||void 0===e)&&this._activeElement&&!this._options.setCursorOnLoad)this._activeElement.removeClass("ws-browser-item-over"),this._activeElement=void 0,this._hovered=void 0;else if(this._isDisabledRow(e))return;if(false!==this._options.useSelection&&e&&"jquery"in e&&e.length>0&&(this._activeElement&&this._activeElement[0]!==e||!this._activeElement)&&e.closest(".ws-browser")[0]==this._data[0]){if(this._activeElement)this._activeElement.removeClass("ws-browser-item-over");if(e.addClass("ws-browser-item-over"),this._setSelection(e,false),e.attr("tabindex","-1"),false!==t&&this._checkScrollPaging()){if(!this._wsBrowserContainer)this._wsBrowserContainer=this._data.parent();var s=this._wsBrowserContainer.scrollTop();if(this.isActive())this._focusRow(e);this.scrollToActive(e),this._scrolledToActive=s!==this._wsBrowserContainer.scrollTop()}if(this._activeElement=e,this._hovered="null"!==e.attr("rowKey")?e.attr("rowKey"):null,!i)this._notifySetCursor(this._hovered?this.getActiveRecord():null);if(this._isNavigation())this._changeState(o)}},_focusRow:function(e){if(e.is(":focus"))e.blur();e.focus()},_checkScrollPaging:function(){return true},_setSelection:function(e,t){this._findSelectedElement().removeClass("ws-browser-row-selected"),e.addClass("ws-browser-row-selected")},_findSelectedElement:function(){return this._container.find(".ws-browser-row-selected")},destroy:function(){if(this._paging)this._paging.destroy(),this._paging=void 0;if(this._pageOptionsDropdown){if(this._container.hasClass("ws-browser-ignore-local-page-size"))this._pageOptionsDropdown.getLinkedContext().removeValue("page-select-dropdown"+this._id,true);this._pageOptionsDropdown.destroy()}if(this._pageOptionsContainer)this._pageOptionsContainer.remove().empty(),this._pageOptionsContainer=null;if(this._sequenceNumberObject)this._sequenceNumberObject=void 0;if(K&&r.instanceOfModule(this._isRecordFloatAreaOpen,"Deprecated/Controls/RecordFloatArea/RecordFloatArea"))this._isRecordFloatAreaOpen.destroy();if(this._unbindParentHandlers(),this._clearTimeOutLoadingIndicator(),this._rowSelect=null,null!==this._currentRecordSet)this._currentRecordSet.abort();if(this._scrollGapPlaceholder)this._scrollGapPlaceholder=null;if(this._options.display.rowOptions)this._destroyRowOptions();if(this._ajaxLoader)this._ajaxLoader=null;var e=this.getLinkedContext();if(e)e.unsubscribe("onFieldChange",this._filterContextChangeHandlerBound).unsubscribe("onDataBind",this._filterContextChangeHandlerBound);Z.superclass.destroy.apply(this,arguments)},_selectRow:function(e){var t=this._body.find('[rowkey="'+e+'"]'),i=this._body.find(".ws-browser-table-row"),o=true;if(t.addClass("ws-browser-selected"),t.find(".ws-browser-checkbox").css("border","none"),void 0===this._selected[e]&&this._currentRecordSet.contains(e)){var s=this._currentRecordSet.getRecordByPrimaryKey(e);this._selectedRecords.push(s),this._selected[e]=this._selectedRecords.length,this._notifyBatchDelayed("onChangeSelection",s,true)}for(var r=0,n=i.length-1;r<=n;r++)if(!$(i[r]).hasClass("ws-browser-selected")){o=false;break}return o},_unselectRow:function(e){var t;if(this._body.find('[rowkey="'+e+'"]').removeClass("ws-browser-selected"),void 0!==this._selected[e]){if(t=this._selected[e],delete this._selected[e],t>=0){var i=this._currentRecordSet.contains(e)?this._currentRecordSet.getRecordByPrimaryKey(e):void 0;delete this._selectedRecords[t-1],this._recalcSelected(t),this._selectedRecords=this._getSelectedRecords()}this._notifyBatchDelayed("onChangeSelection",i,false)}},_toggleRowSelection:function(e){if(void 0===this._selected[e])this._selectRow(e);else this._unselectRow(e)},_selectActiveElement:function(e){var t=(e||this.getActiveElement()).attr("rowkey");t="null"===t?null:t,this._toggleRowSelection(t),this._updatePager()},getSelection:function(e){var t=[];if(e=void 0===e?false:e,!this.hasSelectedRecords()&&true!==e||this.getSelectionMode()&&!this._options.multiSelect){var i=this.getActiveRecord();if(i)t.push(i)}else t=this._getSelectedRecords();return t},_getSelectedRecords:function(){for(var e=[],t=0,i=this._selectedRecords.length;t<i;t++)if(void 0!==this._selectedRecords[t])e.push(this._selectedRecords[t]);return e},_getAllSelectedRecordsCount:function(){var e=0;for(var t in this._selected)if(this._selected.hasOwnProperty(t))e++;return e},hasSelectedRecords:function(){return!Object.isEmpty(this._selected)},_normalizeArgs:function(e){var t=[];if(e instanceof Array)t=e;else if("string"===typeof e||"number"==typeof e)t.push(e);return t},setSelection:function(e){var t=this._normalizeArgs(e),i;if(t.length>=1){for(var o=[],s=0,r=t.length;s<r;s++){if(this._currentRecordSet&&this._currentRecordSet.contains(t[s])){if(i=this._currentRecordSet.getRecordByPrimaryKey(t[s]),-1!==$.inArray(i,this._selectedRecords))continue;this._selectedRecords.push(i),this._selected[t[s]]=this._selectedRecords.length,o.push(i)}else this._selected[t[s]]=-1;this._body.find('[rowkey="'+t[s]+'"]').addClass("ws-browser-selected")}this._notifyBatchDelayed("onChangeSelection",o,true)}if(void 0!==t[0])this.setActiveElement(this._body.find('[rowkey="'+t[0]+'"]'),false);else if(this._activeElement&&!this._options.setCursorOnLoad)this._activeElement.removeClass("ws-browser-item-over"),this._hovered=void 0;this._updatePager()},_recalcSelected:function(e){for(var t in this._selected)if(this._selected.hasOwnProperty(t))if(this._selected[t]>=e)this._selected[t]--},clearSelection:function(e,t){var i,o;if(i=this._normalizeArgs(e),i.length>=1){for(var s=[],r=0,n=i.length;r<n;r++){if(o=this._selected[i[r]],delete this._selected[i[r]],o>=0)this._selectedRecords[o]=void 0;if(this._body.find('[rowkey="'+i[r]+'"]').removeClass("ws-browser-selected"),this._currentRecordSet.contains(i[r]))s.push(this._currentRecordSet.getRecordByPrimaryKey(i[r]))}if(this._selectedRecords=this._selectedRecords.filter(function(e){return!!e}),this._resetSelectedRecords(),!t)this._notifyBatchDelayed("onChangeSelection",s,false)}this._head.find("tr:first").removeClass("ws-browser-selected"),this._updatePager()},removeSelection:function(){var e=this._selectedRecords;if(this._selected={},this._selectedRecords=[],this._container.find(".ws-browser-selected").removeClass("ws-browser-selected"),this._updatePager(),e.length>0)this._notifyBatchDelayed("onChangeSelection",e,false);return true},showSelection:function(e){var t=this.getSelection(true),o=this._foot.find(".ws-browser-dropdown-container"),r=this;if(!this._options.useSelection)return;if(e=void 0===e?true:e,this._isShowSelection=e,this._isShowSelection){if(!this._minimized){this._initialRecordSet=this._currentRecordSet||this._initialRecordSet,i.setCursor(false);var a=n({},this._options.dataSource),h=t.length,d=l(h,rk("Выбрано"),rk("Выбрана"),rk("Выбраны"))+" "+h+l(h," "+rk("записей")," "+rk("запись","множественное")," "+rk("записи"))+".",_=this._foot.find(".ws-browser-pager-text");if(s.attachInstance("Deprecated/RecordSet",n(a,{firstRequest:false,filterParams:this.getRecordSet()._options.filterParams})).addCallback(function(i){i.setColumns(r._currentRecordSet.getColumns());for(var o=0,s=t.length;o<s;o++)i.appendRecord(t[o]);if(r._paging)r._paging.setCurrentPage(1);r._selectedBeforeChoice={selected:r._selected,selectedRecords:r._selectedRecords},r.once("onAfterLoad",function(){r._minimized=true}),r._prepareHierarchyRollUp(e),r.setData(i)}).addErrback(function(e){g.alert(e,{checkAlreadyProcessed:true},r)}).addBoth(function(){i.setCursor(true)}),_.css("margin-top",h?"":"-32px"),_.text(d),this._paging)o.addClass("ws-hidden")}}else if(this._minimized){if(this._initialRecordSet instanceof c){var f=this.getActiveRecord(),u=f?f.getKey():void 0;this.removeSelection(),this.once("onAfterRender",function(){var e=r._body.find('[rowkey="'+u+'"]'),t;if($.isPlainObject(r._selectedBeforeChoice))r._selected=r._selectedBeforeChoice.selected,r._selectedRecords=r._selectedBeforeChoice.selectedRecords,r._selectedBeforeChoice=void 0;r._resetSelectedRecords();for(var i in r._selected)if(r._selected.hasOwnProperty(i))if(t=r._selected[i],-1!==t&&r._currentRecordSet&&r._currentRecordSet.contains(i))r._body.find('[rowkey="'+i+'"]').addClass("ws-browser-selected");if(r._notifyBatchDelayed("onChangeSelection",r._selectedRecords,true),e.length)r.setActiveElement(e);r._updatePager()}),this.once("onAfterLoad",function(){r._minimized=false}),r._prepareHierarchyRollUp(e),this.setData(this._initialRecordSet),this._minimized=false,this._initialRecordSet=false}if(this._paging)o.removeClass("ws-hidden")}return true},_prepareHierarchyRollUp:function(e){},isShowSelection:function(){return this._isShowSelection},isMinimized:function(){return this._minimized},confirmSelection:function(e){e=e||this.getSelection();var t=[];for(var i in e)if(e.hasOwnProperty(i)&&this._testSelectedRecord(e[i]))t.push(e[i]);if(t&&t.length>0)this._notifyBatchDelayed("onSelectionConfirm",t);else this._notifyBatchDelayed("onSelectionConfirm",[null]);return true},_testSelectedRecord:function(e){return true},_selectRecords:function(e,t){var i=e.find(this._rowSelector);this._selected={},this._selectedRecords=t;for(var o=0;o<t.length;o++)this._selected[t[o].getKey()]=o+1;for(var s=0,r=i.length;s<r;s++)if(this._selected[$(i[s]).attr("rowkey")])i.eq(s).addClass("ws-browser-selected")},selectAll:function(){var e=new E,t=this;if(this._selected={},this._selectedRecords=[],"full"===this._options.display.usePaging&&this._currentRecordSet.getRecordCount()<this._currentRecordSet.hasNextPage()||"parts"===this._options.display.usePaging&&this._currentRecordSet.hasNextPage()){var i=n({},this.getDataSource());i.filterParams=this.getQuery(),delete i.filterParams["pageNum"],delete i.filterParams["pageCount"],i.filterParams["usePages"]="",i.usePages="",i.firstRequest=true,i.handlers={onAfterLoad:function(){t._selectRecords(t._body,this.getRecords()),e.callback()}},s.attachInstance("Deprecated/RecordSet",i)}else this._selectRecords(this._body,this._currentRecordSet.getRecords()),e.callback();return e.addCallback(function(e){return t._notifyBatchDelayed("onChangeSelection",t._selectedRecords,true),t._updatePager(),t.setCheckboxState(true),t._notifyOnSizeChanged(true),e}),e},selectCurrentPage:function(){this._selected={},this._selectedRecords=[],this._selectRecords(this._body,o(this._currentRecordSet.getRecords())),this._notifyBatchDelayed("onChangeSelection",this._selectedRecords,true),this._updatePager(),this.setCheckboxState(true),this._notifyOnSizeChanged(true)},setCheckboxState:function(e){if(this._selectAllCheckboxRow&&this._selectAllCheckbox)this._selectAllCheckboxRow.toggleClass("ws-browser-selected",e),this._selectAllCheckbox.attr("title",e?rk("Снять отметку"):rk("Отметить всю страницу"))},invertSelection:function(){for(var e=[],t=this,i=this.getSelection(true),o=function(e,t){if(e.length)if(t)this.removeSelection();else this.clearSelection(e,true);this._notifyBatchDelayed("onChangeSelection",this._selectedRecords,true),this._updatePager(),this._notifyOnSizeChanged(true)},s=0,r=i.length;s<r;s++)e.push(i[s].getKey());var n=e.length,a=n===this._currentRecordSet.getRecordCount();if(0===n||!a)this.selectCurrentPage();o.apply(t,[e,a])},getSumFields:function(){return this._options.sumFields},setSumFields:function(e){if(e)this._options.sumFields=e,this._setSumFieldsArray(e)},_setSumFieldsArray:function(e){this._sumFieldsArray=[];for(var t in e)if(e.hasOwnProperty(t))this._sumFieldsArray.push(t)},_createSumDialog:function(e){var t=this;new N({template:"Deprecated/res/wsmodules/SumDialog/SumDialog",resizable:false,opener:S.getActiveWindow(),handlers:{onAfterLoad:function(){if(e)$(".ws-sumDialog-content",this.getContainer()).html(t._prepareHTMLForRecord(e))},onAfterShow:function(){this.moveWindowToCenter()}}})},_prepareHTMLForRecord:function(e){var t='<table class="ws-dataview-sum-table">',i=function(e,t){return['<tr class="ws-sum-tr">','<td class="ws-sum-left">',e,"</td>",'<td class="ws-sum-right">',t,"</td>","</tr>"].join("")},o=this;return e.getColumns().forEach(function(s){var r=e.get(s),n=o._options.sumFields[s]||s;switch(e.getColumnType(s)){case"Деньги":r=B.money(r);break;case"oid":case"int2":case"int4":case"int8":case"Число целое":r=B.integer(r)}t+=i(n,r)}),t+="</table>",t},_sum:function(e){var t=this,i=new L({message:rk("Суммирование записей..."),name:"ws-load-indicator"});E.callbackWrapper(e?this._sumSelectedRecords.call(this):this._sumRecords.call(this),function(e){if(i.hide(),i.destroy(),e)t._createSumDialog(e)})},_makeArgsForSum:function(e,t,i){return{"ИмяМетода":this._options.dataSource.readerParams.linkedObject+"."+e,"Фильтр":this._currentRecordSet.getReader().prepareFilter(t),"Поля":i}},sumRecords:function(){this._sum()},sumSelectedRecords:function(){this._sum(true)},_sumRecords:function(){if(this._minimized)return this._sumSelectedRecords();var e=new h("Сумма"),t=this._options.dataSource.readerParams.queryName,i=this._notify("onCalculateSum");return i instanceof E?i:e.call("ПоМетоду",this._makeArgsForSum(void 0!==t?t:"Список",this.getQuery(),this._sumFieldsArray),h.RETURN_TYPE_RECORD)},_sumSelectedRecords:function(){var e=this.getSelection(true),t=this._minimized&&!e.length?this.getRecordSet().getRecords():e,i,o,s;if(o=this._notify("onCalculateSum",t),o instanceof E)return o;if(t.length>0){i=new h("Сумма"),s=new c({readerType:"ReaderUnifiedSBIS",readerParams:{adapterType:"TransportAdapterStatic",adapterParams:{data:{s:V.serialize(t[0]).s,d:[]}}}});for(var r=0,n=t.length;r<n;r++)s.appendRecord(t[r].cloneRecord());return i.call("ПоВыборке",{"Записи":V.serialize(s),"Поля":this._sumFieldsArray},h.RETURN_TYPE_RECORD)}else return(new E).callback(false)},getActiveRecord:function(e){if(e=e||this.getActiveElement(),!e)return false;var t=false,i=e.attr("rowkey");if(void 0!==i&&this._currentRecordSet.contains(i))t=this._currentRecordSet.getRecordByPrimaryKey(i);return t},_checkPager:function(e,t){return this._options.display.usePaging&&e!==t},_updatePager:function(){if(this._currentRecordSet){var e=0===this._count?this._currentRecordSet.getRecordCount():this._count,i=this._currentRecordSet.hasNextPage()||"full"===this._options.display.usePaging&&e,o="";if(this._currentRecordSet.getRecordCount()>0)if(this._options.display.showRecordsCount)if(this._checkPager(e,i)){var s="full"===this._options.display.usePaging&&i?true:false,r=this._currentRecordSet.getPageNumber(),n=r*this._options.display.recordsPerPage+1,a="";if(0===e)o="";else if(1===e&&0===r)o="1 запись";else a=n+e-1,o="$startRecord$d$ - $finishRecord$d$"+(s?" из $hasNextPage$d$":"")}else o="Всего : $recordsCount$d$";for(var l=0,h=0,d=this._selectedRecords.length;h<d;++h)if(this._selectedRecords[h])++l;if(this._options.multiSelect&&l>0)o=rk("Выбрано записей: $count$d$. Всего : $recordsCount$d$",l);if(o=t({recordsCount:e,hasNextPage:i,startRecord:n,finishRecord:a,count:l},rk(o)),this._rootElement.find(".ws-browser-dropdown-container").toggleClass("ws-hidden",!(e>0||0!==this._currentRecordSet.getPageNumber())),this._foot.find(".ws-browser-pager").removeClass("ws-hidden"),this._rootElement.find(".ws-browser-pager-text").text(o),!this._paging&&this._options.display.usePaging&&this._options.display.showPaging){var c=this._rootElement.find(".ws-browser-paging");if(c.length){this._rootElement.find(".ws-browser-pager-cont").addClass("ws-browser-has-paging");var _=this,f=c.closest(".ws-browser-foot"),u=f.width(),p=f.height();if(void 0===i)i=0;if(this._paging=new I({recordsPerPage:this._options.display.recordsPerPage,currentPage:this._currentRecordSet.getPageNumber()+1,recordsCount:i,pagesLeftRight:this._options.display.pagesLeftRight,onlyLeftSide:"parts"===this._options.display.usePaging,rightArrow:i,element:c,parent:this.getParent(),allowChangeEnable:false,handlers:{onPageChange:function(e,t,i){_._setPageSave(t),_._pageChangeDeferred=i,_._currentRecordSet.setPage(t-1,false,false)}}}),this._processPaging(),this._paging.setRecordSet(this._currentRecordSet),this._paging.update(this._currentRecordSet.getPageNumber()+1),f.width()!==u||f.height()!==p)this._notifyOnSizeChanged(true);else if(this._resizer)this._resizer.height(this._rootElement.height())}}}},_setPageSave:function(e){},_dropPageSave:function(){},_updateSizeVariables:function(){this._getVerticalScrollShowed.reset(),this._fixVerticalScrollGap()},_getVerticalScrollShowed:u(function(){var e=this._data.parent();return!this._isHeightGrowable()&&R.vertical(e)},"_getVerticalScrollShowed"),_fixVerticalScrollGap:function(){var e=this._scrollGapPlaceholder,t;if(e&&e.length>0)if(t=this._getVerticalScrollShowed(),e.lastState!==t)e.lastState=t,e.toggle(t)},_updateBodyHeight:function(){this._bodyHeight=this._data.parent().height(),this._bodyRealHeight=this._body.height()},_setHeight:function(e){var t,i,o,s,r,n=this._isHeightGrowable(),a,l;if(t=this._data.parent(),s=0!==this._options.minHeight,r=this._options.maxHeight!==1/0,n){if(!e){if(s||r)i=this._getAdditionalHeight()+2;if(t.height("auto"),this._container.height("auto"),r)this._browserContainerWrapper.css("max-height",i>this._options.maxHeight?0:this._options.maxHeight-i);else this._browserContainerWrapper.css("max-height","");if(this._browserContainerWrapper.css("min-height",""),s&&i<=this._options.minHeight)if(a=parseInt(this._browserContainerWrapper.css("min-height"),10)||0,l=Math.max(a,this._options.minHeight-i),a!==l)this._browserContainerWrapper.css("min-height",l)}}else if(i=this._getAdditionalHeight()+2,o=this._container.height()-i,this._emptyDataBlock.hasClass("ws-hidden"))t.height(Math.max(o,0));else t.height("auto"),o-=t.height(),this._emptyDataBlock.css("max-height",Math.max(o,0)+"px");if(this._updateSizeVariables(),this._updateDataBlockSize(e),n){if(v(t))t.height("auto"),t.height(t.outerHeight());if(this._resizer)this._resizer.height(this._rootElement.height())}if(n&&e)this._checkContainerHeightForRecalk()},_getAdditionalHeight:function(){return(this._foot.height()||0)+(this._headContainer.height()||0)},_onResizeHandler:function(e,t){if(this!==t)this._setHeight(true);if(Z.superclass._onResizeHandler.apply(this,arguments),this._options.display.rowOptions&&this._rowOptionsElement)if(this._resetRowOptionsShift(),this._rowOptionsTargetRow===this._rowOptionsHoverRow)this._showRowOptionsForRow(this._rowOptionsTargetRow)},getRecordSet:function(){return this._currentRecordSet},setSelectionMode:function(e){this._selectMode=!!e,this._options.display.showSelectionCheckbox=!!e,this._colgroupCache=void 0},getSelectionMode:function(){return this._selectMode},_rebuildActions:function(){this._initActionsFlags(),this._notifyOnUpdateActions()},_notifyOnUpdateActions:function(){var e={};for(var t in this._actions)if(this._actions.hasOwnProperty(t))e[t]=!!this._actions[t];this._notify("onUpdateActions",e)},setReadOnly:function(e){if(this._options.display.readOnly!==!!e)if(this._options.display.readOnly=!!e,this._rebuildActions(),this._options.display.rowOptions)for(var t=0;t<this._rowOptionsDefault.length;++t)if("edit"===this._rowOptionsDefault[t][2]){this._rowOptionsDefault[t][0]=e?rk("Просмотреть")+" (F3)":rk("Редактировать")+" (F3)";break}},setAllowAdd:function(e){if(this._options.allowAdd!=e)this._options.allowAdd=e,this._rebuildActions()},getAllowAdd:function(){return this._options.allowAdd},setAllowEdit:function(e){if(this._options.allowEdit!=e)this._options.allowEdit=e,this._rebuildActions()},getAllowEdit:function(){return this._options.allowEdit},setAllowDelete:function(e){if(this._options.allowDelete!=e)this._options.allowDelete=e,this._rebuildActions()},getAllowDelete:function(){return this._options.allowDelete},getPaging:function(){return(new E).callback(this._paging)},_setEnabled:function(e){if(Z.superclass._setEnabled.apply(this,arguments),this._paging)this._paging.setEnabled(e);if(this._pageOptionsDropdown)this._pageOptionsDropdown.setEnabled(e);if(this._options.display.rowOptions)if(!e&&this._rowOptionsIsInit)this._hideRowOptions(),this._uninitRowOptions();else if(!this._rowOptionsIsInit)this._initRowOptions()},setReload:function(e){this._options.reloadAfterChange=e},getReload:function(){return this._options.reloadAfterChange},_updateDataBlockSize:function(e){},setSelectionType:function(e){},_showEmptyDataBlock:function(){},_keyboardShortcut:function(e){if(!this._currentRecordSet||!this._currentRecordSet.isLoaded())return false;var t=e.which;if(t in this._keysActions){var i=this._keysActions[t],o=this._modifiersFromEvent(e);if(o in i){var s=i[o].call(this,e);if(!s)e.stopPropagation();return s}else return true}return},_modifiersFromEvent:function(e){var t=0;if(e.ctrlKey)t+=M.modifiers.control;if(e.altKey)t+=M.modifiers.alt;if(e.shiftKey)t+=M.modifiers.shift;return t},_registerShortcut:function(e,t,i){if(!this._keysActions[e])this._keysActions[e]={};if(t instanceof Array)for(var o=1<<t.length,s=0;s<o;++s){for(var r=0,n=0;n<t.length;++n)if(s&1<<n)r|=t[n];this._keysActions[e][r]=i}else this._keysActions[e][t]=i},isTree:function(){return false},isHierarchy:function(){return false},isCustomView:function(){return false},setEmptyHtml:function(e){this._emptyDataBlock.html(e),this._options.display.emptyHtml=this._emptyDataText=e,this._emptyDataTextSet=false},_unbindParentHandlers:function(){if(this._parent)this._parent.unsubscribe("onReady",this._dataBindHandler);if(this._setDataHandler)this._parent.unsubscribe("onReady",this._setDataHandler)},_createFooterArea:function(){var e=this._options.display.showRecordsCount||this._options.display.showPaging||this._needShowSelectionCheckbox();return this._useShowingFooter()?['<table class="ws-browser-foot" cellspacing="0">',"<tfoot>",e?["<tr>",'<td class="ws-browser-pager-cont">',this._options.display.showPaging?'<div class="ws-browser-paging"></div>':"",this._options.display.showRecordsCount?['<div class="ws-browser-pager ws-hidden">','<span class="ws-browser-pager-text">&nbsp;</span>',this._options.display.usePaging&&this._options.display.usePageSizeSelect?['<div class="ws-browser-dropdown-container">','<span class="ws-browser-page-selector ws-browser-pager-select-text">, по</span>','<div  class="ws-browser-page-selector ws-browser-pager-select"></div>','<span class="ws-browser-page-selector ws-browser-pager-select-text"></span>',"</div>"].join(""):"","</div>"].join(""):"","</td>","</tr>"].join(""):"","</tfoot>","</table>"].join(""):""},setUsePaging:function(e,t){if(!e)this._options.display.usePaging="full",this._options.display.showPaging=false,this._footer[0].innerHTML="";else this._options.display.usePaging=e,this._options.display.showPaging=true,this._pageOptions=[],this._footer[0].innerHTML=this._createFooterArea(),this._foot=this._footer.find("tfoot"),this._footerDrawed=false,this._drawFooter();if(this._paging=null,this._updatePager(),this._currentRecordSet)this._currentRecordSet.setUsePages(e);if(void 0!==t)this.setPageSize(t);if(this._paging)this._paging.update(1)},_getColumnIndex:function(e){var t=this.getColumnMap();for(var i in t)if(e===t[i].field)return t[i].index},setSorting:function(e,t){this._head.find(".ws-browser-sortable").removeClass("asc desc").addClass("none"),this._sortingStack=[];for(var i=[],o=0;o<e.length;++o){var s=e[o].field,r=e[o].order,n=this._getColumnIndex(s);if(this._sortingStack.push({field:s,type:"asc"===r?0:1}),i.push([s,"desc"===r]),void 0!==n)this.getContainer().find('td[columnid="'+n+'"] .ws-browser-sortable').removeClass("none").addClass(r)}if(this._currentRecordSet)this._currentRecordSet.setSorting(i,this.getQuery(),false,t)},setTextHighlight:function(e,t){if(this._highlight=e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),e&&t)for(var i=this._body.find(".ws-browser-text-highlight"),o=0,s=i.length;o<s;++o)this._highlightNode($(i[o]))},_highlightNode:function(e){if(e.attr("highlight")===this._highlight)return;e.attr("highlight",this._highlight),e.html(this._highlightData(e.html()))},_highlightData:function(e){if(this._highlight&&e&&"string"===typeof e)e=e.replace(new RegExp(this._highlight,"gi"),'<span class="ws-browser-highlight">$&</span>');return e},clearTextHighlight:function(e){if(this._highlight="",e)this.refresh()},_checkRowOptions:function(){if(this._options.display.rowOptions)if(!this._rowOptionsInitialized)this._rowOptionsInitialized=true,this._initRowOptionsDefaults(),this._resetRowOptionsShift(),this._initRowOptions(),this.once("onReady",function(){if(this._createRowOptions(),this._options.display.userRowOptions.length)this._addUsersRowOptions()})},_initRowOptions:function(){if(this.isEnabled()){var e=this,t=this._rootElement.find(".ws-browser-container-wrapper");e._rowOptionsIsInit=true,e._body.parent().on("mouseenter mouseleave mousemove",e._rowSelector,function(t){if(e._checkMoveRowOptions())if("mouseenter"===t.type||"mousemove"===t.type&&!e.isRowOptionsVisible()){if(M.browser.isMobileSafari){var i=$(t.target).closest("tr.ws-browser-table-row");e.setActiveElement(i,false,false,true)}e._showRowOptions.apply(e,[t.target])}else if("mouseleave"===t.type)e._rowMouseLeave.call(e,false,t)}),t.find(".ws-browser").bind("mouseleave",this._rowMouseLeave.bind(this,false))}},_createRowOptions:function(){if(this._rowOptionsElement)return;var e=this,t=this._rootElement.find(".ws-browser-container-wrapper"),i=this._rowOptionsDefault;if(i.length){var o=$('<div class="ws-browser-row-options-block ws-hidden '+("top"===e._options.display.rowOptionsPosition?"ws-browser-rowOptions-top":"")+'"></div>'),s=$('<div class="'+this._rowOptionsContainer+'"></div>').prependTo(o);if(!M.browser.isMobileSafari)o.bind("mouseenter mouseleave",$.proxy(this._rowOptionsEventHandler,e));this._rowOptionsMenuButton=$('<span class="ws-browser-row-option-border ws-browser-row-option-menu-button">'+'<span class="ws-browser-row-option menu"></span></span>').appendTo(s).click(function(t){t.stopImmediatePropagation(),e._rowOptionsShowMenu(this)});for(var r=0,n=i.length;r<n;++r)this._createRowOptionButton(i[r]).appendTo(s);this._rowOptionsElement=o.appendTo(t).bind("mouseleave",this._rowMouseLeave.bind(this,true)).bind("mousemove",function(){e._rowOptionsTargetRow=e._rowOptionsHoverRow})}else this._rowOptionsElement=void 0},_addUsersRowOptions:function(){for(var e,t=0,i=this._options.display.userRowOptions.length;t<i;t++)if(e=this._options.display.userRowOptions[t],"object"===typeof e)e.isMainOption=void 0===e.isMainOption?true:e.isMainOption,this.addRowOption(e)},_initRowOptionsDefaults:function(){this._rowOptionsDefault=this._getRowOptions()},hideRowOption:function(e,t){if(this._hiddenRowOptions.hasOwnProperty(t)){if(this._hiddenRowOptions[t].hasOwnProperty(e))return;this._hiddenRowOptions[t][e]=true}else this._hiddenRowOptions[t]={},this._hiddenRowOptions[t][e]=true;if(this._rowOptionsHoverRow)this._applyRowOptions()},showHiddenRowOption:function(e,t){if(!Object.isEmpty(this._hiddenRowOptions))if(this._hiddenRowOptions.hasOwnProperty(t)&&this._hiddenRowOptions[t].hasOwnProperty(e)){if(delete this._hiddenRowOptions[t][e],Object.isEmpty(this._hiddenRowOptions[t]))delete this._hiddenRowOptions[t];if(this._rowOptionsHoverRow)this._applyRowOptions()}},_isHiddenOptionForHoveredRow:function(e){if(this._rowOptionsHoverRow){var t=this._rowOptionsHoverRow.attr("rowKey");if(!Object.isEmpty(this._hiddenRowOptions))return this._hiddenRowOptions.hasOwnProperty(t)&&this._hiddenRowOptions[t].hasOwnProperty(e)}return false},_hideRowOptions:function(){if(this._rowOptionsMenuVisible)if(this._scrolledToActive)return void(this._scrolledToActive=false);else this._rowOptionsMenuVisible=false,this._rowOptionsMenu&&this._rowOptionsMenu.hide();if(this._rowOptionsElement)this._rowOptionsElement.addClass("ws-hidden");if(this._rowOptions={},this._rowOptionsTargetRow=this._rowOptionsHoverRow=void 0,this._rowOptionsHoverRecord=void 0,this._options.useSelection&&this._options.useHoverRowAsActive)this._activeHoverHideSelection()},_activeHoverHideSelection:function(e){if(!this._useKeyboard&&this._activeElement&&"jquery"in this._activeElement){var t=e?$(e.relatedTarget||e.toElement):false;if(t&&"jquery"in t)t=t.closest(".ws-browser-row-options-block");if(false===t||0===t.length)this._activeElement.removeClass("ws-browser-item-over"),this._activeElement=void 0,this._hovered=false}},addRowOption:function(e){if(this._addRowOption([e["title"],e["icon"],e["callback"],e["name"],e["weight"],e["linkText"],void 0===e["isMainOption"]?true:e["isMainOption"]]),this._rowOptionsHoverRow)this._applyRowOptions()},addRowOptions:function(e){for(var t=[],i=0,o=e.length;i<o;++i){if(e[i]instanceof Array)t=e[i];else if(e[i]instanceof Object)t.push(e[i]["title"],e[i]["icon"],e[i]["callback"],e[i]["name"],e[i]["weight"],e[i]["linkText"],e[i]["isMainOption"]);t[6]=void 0===t[6]?true:t[6],this._addRowOption(t),t=[]}if(this._rowOptionsHoverRow)this._applyRowOptions()},isRowOptionsVisible:function(){return this._rowOptionsElement&&this._rowOptionsElement.is(":visible")},_getRowOptions:function(){var e=[];if(this._hasSequenceNumbers())e.push([rk("Переместить вверх")+" (Ctrl+↑)","sprite:icon-16 icon-ArrowUp icon-primary","recordUp","recordUp",10]),e.push([rk("Переместить вниз")+" (Ctrl+↓)","sprite:icon-16 icon-ArrowDown icon-primary","recordDown","recordDown",20]);return e.push([rk("Удалить"),"sprite:icon-16 icon-Erase icon-error","delete","delete",30]),e.push([this._options.display.readOnly?rk("Просмотреть")+" (F3)":rk("Редактировать")+" (F3)","sprite:icon-16 icon-Edit icon-primary","edit","edit",40]),e},_showRowOptionsForRow:function(e){var t,i;if(this._useKeyboard||!e)return;if(t=e.attr("rowkey"),i=this._currentRecordSet.contains(t)&&this._currentRecordSet.getRecordByPrimaryKey(t),i){var o=[];if(!i)o=["edit","delete","recordUp","recordDown"];else if(true===this._rowOptionsDisableStandart)o=["edit","delete","recordUp","recordDown"];else if(false!==this._rowOptionsDisableStandart)o=Array.isArray(this._rowOptionsDisableStandart)?this._rowOptionsDisableStandart.slice():[];this._additionalFilterRowOptions(o,i),o=this._rowOptionsFilterConcat(o),this._refilterRowOptions(o);var s=n({},this._rowOptions,{clone:true}),r=this._isAllowRowOptionsForRecord(i,t)?this._notify("onRowOptions",i,e,this._rowOptions):false;if(false!==r){var a=e.outerHeight();if(this._rowOptionsHoverRow=this._rowOptionsTargetRow=e,this._rowOptionsHoverRecord=i,!(r instanceof Array))r=[];if(this._createRowOptions(),r=r.concat(this._updateRowOptions(s)),this._refilterRowOptions(o.concat(r)),this._applyRowOptions(),this._hasRowOptions&&this._rowOptionsElement&&e.parent().parent().length)return void this._rowOptionsElement.removeClass("ws-hidden").css(this._getRowOptionPositionForRow(e))}}if(this._rowOptionsElement)!this._rowOptionsElement.hasClass("ws-hidden")&&this._hideRowOptions()},_isAllowRowOptionsForRecord:function(e,t){return true},setRowOptionsPosition:function(e){if(!this._rowOptionsElement||"top"!==e&&"bottom"!==e||e===this._options.display.rowOptionsPosition)return;this._options.display.rowOptionsPosition=e,this._rowOptionsElement.toggleClass("ws-browser-rowOptions-top","top"===e),this._showRowOptionsForTargetRow()},getRowOptionsPosition:function(){return this._options.display.rowOptionsPosition},setRowOptionsOffset:function(e){if("object"===typeof e)if("number"===typeof e.bottom&&"number"===typeof e.right)this._options.display.rowOptionsOffset=e,this._resetRowOptionsShift();else throw new Error('setRowOptionsOffset: "offset" argument have invalid structure ')},_getRowOptionPositionForRow:function(e){return this._calcRowOptionsPosition(e,this._getRowOptionMargin(e))},_getRowOptionMargin:function(e){var t=Math.abs(e[0].getBoundingClientRect().bottom-e[0].getBoundingClientRect().top),i=this._rowOptionsElement[0].offsetHeight,o=t>i,s;return this._rowOptionsElement[o?"removeClass":"addClass"]("ws-browser-row-options-withoutShadow"),o&&"bottom"===this._options.display.rowOptionsPosition?t-i:0},_calcRowOptionsPosition:function(e,t){return{top:e[0].getBoundingClientRect().top-this._browserContainer[0].getBoundingClientRect().top+this._rowOptionsShift.top+(t?t:0),right:this._rowOptionsShift.right}},_rowOptionsFilterConcat:function(e){var t=[];if(this._options.display.readOnly){if((!this._options.allowEdit||this._options.useHoverRowAsActive)&&!this._selectMode)t.push("edit");if(!this._options.allowDelete)t.push("delete");if(this._hasSequenceNumbers())t.push("recordUp","recordDown")}for(var i=0,o=t.length;i<o;++i){for(var s=false,r=0;r<e.length;++r)if(e[r]==t[i]){s=true;break}if(!s)e.push(t[i])}return e},_refilterRowOptions:function(e){for(var t={},i=this._rowOptions,o=0;o<e.length;++o)t[e[o]]=true;for(this._rowOptions={},o=0;o<this._rowOptionsDefault.length;++o){var s=this._rowOptionsDefault[o],r=s[3]||s[2];if(!t[r]&&!("string"===typeof s[2]&&!this._actions[s[2]]))this._rowOptions[r]={title:s[0],icon:s[1],callback:"string"===typeof s[2]?this._actions[s[2]]:s[2],name:r,linkText:s[5],isMainOption:i[r]?i[r]["isMainOption"]:s[6]}}},_rowOptionsShowMenu:function(e){if(this.setActiveElement(this._rowOptionsHoverRow),this._rowOptionsMenu instanceof Object)this._applyRowOptions(),this._rowOptionsMenuVisible=true,this._rowOptionsMenu.show.apply(this._rowOptionsMenu,n(M.Browser.rowOptionsMenuConfig,[$(e)]));else if(void 0===this._rowOptionsMenu)this._createRowOptionsMenu(e),this._rowOptionsMenuVisible=true},_rowOptionsEventHandler:function(e){if(this._rowOptionsHoverRow&&!this._rowOptionsMenuVisible)this._rowOptionsHoverRow.toggleClass("ws-browser-row-hover","mouseenter"===e.type)},_calculateImagePath:function(e,t){return!t||t.indexOf("/")>-1||-1!==t.indexOf("sprite:")?t:e+t},_isMainRowOption:function(e){return void 0!==e.isMainOption?e.isMainOption:!!this._options.display.mainRowOptions[e.name]},_assembleRowOptionButtonSpan:function(e){var t=true===e[5]&&e[0]||"string"===typeof e[5]&&e[5],i=[],o={},s=false,r;if(e[1])if(-1!=e[1].indexOf("sprite:"))if(s=true,i.push("ws-browser-row-option-sprite"),i.push(e[1].split("sprite:")[1]),e[1].indexOf("primary")>-1)i.push("action-hover");return o={icon:i.join(" "),linkText:t,title:e[0]},r=$(j(o)),r},_assembleRowOptionButton:function(e){var t=this._rowOptionsButtonCallback(e),i=this._assembleRowOptionButtonSpan(e);if(i.on("mousedown",function(e){e.stopPropagation(),e.preventDefault()}),t)i.bind("click",t);return i},_createRowOptionButton:function(e){var t=this._assembleRowOptionButton(e),i="string"===typeof e[2]?e[2]:e[3],o=e[4];if(i)this._rowOptionsButtons[i]=t;if(o)this._rowOptionsButtons[i].weight=o;return this._rowOptionsButtons[i]["isVisible"]=true,t},_showRowOptionsForTargetRow:function(){if(void 0===this._rowOptionsTargetRow)this._hideRowOptions();else if(this._rowOptionsTargetRow!==this._rowOptionsHoverRow)this._showRowOptionsForRow(this._rowOptionsTargetRow);else this._rowOptionsTargetRow=void 0},disableStandartRowOptions:function(e){this._rowOptionsDisableStandart=void 0===e?true:e},_rowOptionsButtonCallback:function(e){var t,i=this;if("function"===typeof e[2])t=this._rowOptionsCallbackWrapper(e[2]);else t=function(t){if(t&&t.stopPropagation)t.stopPropagation();i.setActiveRow(i._rowOptionsHoverRow),i._actions[e[2]](i._rowOptionsHoverRow,true,t)};return t},_rowOptionsCallbackWrapper:function(e){var t=this;return function(i){if(i&&i.stopPropagation)i.stopPropagation();if(t.setActiveRow(t._rowOptionsHoverRow),e.apply(t,[t._rowOptionsHoverRecord,t._rowOptionsHoverRow,arguments[2]||this,i]),M.browser.isMobileSafari)t._hideRowOptions()}},_createRowOptionsSubMenu:function(e,t){},getRowOptionsMenuDeferred:function(){if(!this._rowOptionsMenuDeferred)if(this._rowOptionsMenuDeferred=new E,e&&this._rowOptionsMenu instanceof e)this._rowOptionsMenuDeferred.callback(this._rowOptionsMenu);return this._rowOptionsMenuDeferred},_createRowOptionsMenu:function(e){var t=this._rowOptionsDefault,i=[],o=this._calcImgPath(),r=this,a=false;this._rowOptionsMenu=true;for(var l=0,h=t.length;l<h;++l)if(t[l][0]){var d=this._rowOptionsButtonCallback(t[l]),c=function(e,t,i){if(!i.subMenu)e.call(r._rowOptionsMenu)}.bind(this,d),_={caption:t[l][0],id:r.getId()+"_"+(t[l][3]||t[l][2]),imgSrc:this._calculateImagePath(o,t[l][1]),handlers:{onActivated:c}};this._createRowOptionsSubMenu(t[l][2],_),i.push(_),a=false}else if(i.length)i.push({caption:""}),a=true;if(a)i.pop();this._rowOptionsMenu=$('<div class="ws-browser-row-option-menu-container"></div>').appendTo(document.body),s.attachInstance("Control/Menu",{data:i,cssClassName:"ws-browser-row-options-menu",element:this._rowOptionsMenu,parent:this.getParent(),allowChangeEnable:false,handlers:{onReady:function(){if(r._rowOptionsMenu=this,r._rowOptionsMenuDeferred)r._rowOptionsMenuDeferred.callback(this);r._applyRowOptions(),this.show.apply(this,n(M.Browser.rowOptionsMenuConfig,[$(e)]))},onClose:function(){if(r._rowOptionsMenuVisible){if(r._rowOptionsMenuVisible=false,r._rowOptionsHoverRow)r._rowOptionsHoverRow.removeClass("ws-browser-row-hover");r._showRowOptionsForTargetRow()}}}}).addCallback(function(e){r._appendRowOptionsMenuHideButton()})},_appendRowOptionsMenuHideButton:function(){this._rowOptionsMenu.getMenuUL().append('<div class="ws-browser-row-options-hide"></div>').bind("click",function(){if(this._showRowOptionsForRow(this._activeElement),this._rowOptionsMenu.hide(),M.browser.isIE)this._activeElement.addClass("ws-browser-row-hover")}.bind(this))},_updateRowOptions:function(e){for(var t=[],i=0;i<this._rowOptionsDefault.length;++i){var o=this._rowOptionsDefault[i][3]||this._rowOptionsDefault[i][2];if(e.hasOwnProperty(o)&&this._rowOptions.hasOwnProperty(o)){if(!this._rowOptionsButtons[o]||JSON.stringify(this._rowOptions[o])===JSON.stringify(this._rowOptionsDefault[i]))continue;var s=[this._rowOptions[o]["title"],this._rowOptions[o]["icon"],this._rowOptions[o]["callback"],this._rowOptions[o]["name"],void 0,this._rowOptions[o]["linkText"],this._rowOptions[o]["isMainOption"]],r=this._assembleRowOptionButton(s);if(this._rowOptionsButtons[o].replaceWith(r),this._rowOptionsButtons[o]=r,this._rowOptionsButtons[o].isVisible=true,this._rowOptionsMenu){var n=this._rowOptionsCallbackWrapper(this._rowOptions[o]["callback"]);this._rowOptionsMenu.setItemClickHandler(this.getId()+"_"+o,n),this._rowOptionsMenu.setItemText(this.getId()+"_"+o,this._rowOptions[o]["title"]),this._rowOptionsMenu.setItemIcon(this.getId()+"_"+o,this._rowOptions[o]["icon"])}}else if(e.hasOwnProperty(o))t.push(o)}for(i in this._rowOptions)if(this._rowOptions.hasOwnProperty(i)&&!e.hasOwnProperty(i))this.addRowOption(this._rowOptions[i]);return t},_applyRowOptions:function(){var e=0,t=true,i=this._rowOptionsDefault,o=this._rowOptions,s,r,n,a;for(var l in o)if(o.hasOwnProperty(l))++e,t&=this._isMainRowOption(o[l]);if(this._rowOptionsMenuButton)this._rowOptionsMenuButton[0].style.display=!t?"inline-block":"none";for(l=0;l<i.length;++l){if(s=i[l],r=s[3]||s[2],n=o[r],a=o[r]&&t&&!this._isHiddenOptionForHoveredRow(r),n&&this._isMainRowOption(n))a=this._showRowOption(r,true);if(this._rowOptionsButtons[r]["isVisible"]!==a)this._rowOptionsButtons[r]["isVisible"]=a,this._rowOptionsButtons[r][0].style.display=a?"inline-block":"none";this._rowOptionsMenu&&!(this._rowOptionsMenu instanceof jQuery)&&this._rowOptionsMenu[n&&this._showRowOption(r,n)?"showItem":"hideItem"](this.getId()+"_"+r)}this._hasRowOptions=e>0},_showRowOption:function(e,t){if("recordUp"===e||"recordDown"===e)t=this._isShowSequenceOptions(e);if(this._isHiddenOptionForHoveredRow(e))t=false;return t},_isShowSequenceOptions:function(e){var t="recordUp"===e,i=!!this._getNearestRow(this._rowOptionsHoverRow,t);if(this._checkOnPaging()){var o=this._rowOptionsHoverRow.index(),s=this._currentRecordSet,r=s.getPageNumber(),n=s.hasNextPage(),a=s.getRecordCount(),l;if("full"===this.getPagingMode())n=((l=r+1)>1?(l-1)*s.getPageSize()+a:a)<n;return t?0!==o||0!==r:i||n}else return i},_addRowOption:function(e){var t=this._rowOptionsButtonCallback(e),i="";if("string"===typeof e[2])i=e[2];else if(e[3])i=e[3];for(var o=0;o<this._rowOptionsDefault.length;++o)if(i===(this._rowOptionsDefault[o][3]||this._rowOptionsDefault[o][2]))return;if(this._createRowOptions(),this._rowOptionsElement){var s=e[1],r=this._createRowOptionButton(e),n;if(e[4]&&"number"===typeof e[4])n=this._getRowOptionNameInsertBefore(e);if(e[4]===M.Browser.rowOptionBeforeAll)r.prependTo(this._rowOptionsElement.find(".ws-browser-row-options-container"));else if(e[4]&&n)r.insertBefore(this._rowOptionsButtons[n]);else r.appendTo(this._rowOptionsElement.find(".ws-browser-row-options-container"));if(this._rowOptionsMenu instanceof Object){var a={imgSrc:s,id:this.getId()+"_"+i,caption:e[0],handlers:{onActivated:t}};if(e[4]===M.Browser.rowOptionBeforeAll)this._rowOptionsMenu.insertItem(a,M.Menu.insertItemBeforeAll);else if(void 0!==e[4]&&n)this._rowOptionsMenu.insertItem(a,this.getId()+"_"+n);else this._rowOptionsMenu.addItem(a)}}if(e[4]===M.Browser.rowOptionBeforeAll)this._rowOptionsDefault.unshift(e);else if(e[4]&&n)for(o=0;o<this._rowOptionsDefault.length;++o){var l=this._rowOptionsDefault[o];if((l[3]||l[2])===n){this._rowOptionsDefault.splice(o,0,e);break}}else this._rowOptionsDefault.push(e)},_getRowOptionNameInsertBefore:function(e){var t=[],i=e[4];for(var o in this._rowOptionsButtons)if(this._rowOptionsButtons.hasOwnProperty(o)&&this._rowOptionsButtons[o].weight!==i)t.push(this._rowOptionsButtons[o].weight);t.sort();for(var s=0,r=t.length;s<r;s++){if(i<=t[s])for(o in this._rowOptionsButtons)if(this._rowOptionsButtons.hasOwnProperty(o)&&this._rowOptionsButtons[o].weight===t[s])return o;if(t[s]<i&&void 0===t[s+1])return false}},_hideRowOptionsForRow:function(e,t){if(!t||0===t.length||t.parents(".ws-browser").get(0)!=this._data.get(0)){if(0===e.parents(".ws-browser-row-options-block").length&&!e.hasClass("ws-browser-row-options-block"))if(!this._rowOptionsMenuVisible)this._hideRowOptions();else this._rowOptionsTargetRow=void 0;return true}},_showRowOptions:function(e){var t=$(e),i=t;if(!t.hasClass(this._rowSelector.replace(/\./g,"")))i=i.parents(".ws-browser "+this._rowSelector);if(this._hideRowOptionsForRow.apply(this,[t,i]),this._rowOptionsMenuVisible)return this._rowOptionsTargetRow=i,true;if(this._rowOptionsHoverRow&&this._rowOptionsHoverRow.hasClass("ws-browser-row-hover"))this._rowOptionsHoverRow.removeClass("ws-browser-row-hover");this._showRowOptionsForRow(i)},_rowMouseLeave:function(e,t){if(this._checkMoveRowOptions()&&!this[e?"_isMouseMovedToTable":"_isMouseMovedToRowOptions"](t))if(this._rowOptionsMenuVisible)this._rowOptionsTargetRow=void 0;else this._hideRowOptions()},_isMouseMovedToTable:function(e){return $(e.toElement||e.relatedTarget).closest(this._data).length>0},_isMouseMovedToRowOptions:function(e){return $(e.toElement||e.relatedTarget).closest(".ws-browser-row-options-block").length>0},_uninitRowOptions:function(){this._rowOptionsIsInit=false,this._browserContainer.unbind("mousemove"),this._body.parent().off("hover",this._rowSelector),this._rootElement.find(".ws-browser-container-wrapper").unbind("mouseleave")},_checkMoveRowOptions:function(){return this.isEnabled()},_calcImgPath:function(){return M.Browser.imgPath},_onRecordUpHandler:function(){this._verifySequenceNumber(true)},_onRecordDownHandler:function(){this._verifySequenceNumber()},_getNearestRow:function(e,t){return e[(t?"prev":"next")+"All"]().filter("[rowkey]")[0]},_collectDataSource:function(e,t){var i=n({},this.getDataSource()),o=this;return i.filterParams=this.getQuery(),i.usePages="parts",i.filterParams.usePages="parts",i.pageNum=t,i.filterParams.pageNum=t,i.firstRequest=true,i.handlers=i.handlers||{},i.handlers.onAfterLoad=function(){var i=this.getRecords(),s=i.length,r,n;if(s>0){if(e)n=i[s-1],r=i[s-2];else n=i[0],r=i[1];o._changeSequenceNumber(e,n,r,t).addCallback(function(){o._allowChangePorNomer=true})}},i},_hasNearestRow:function(){return this.getPagingMode()},_hasSequenceNumbers:function(){return this._options.display.sequenceNumberColumn&&this._allowChangePorNomer},_verifySequenceNumber:function(e){if(this._hasSequenceNumbers()){var t=this.getActiveRow(),i=$(this._getNearestRow(t,e)),o=this._currentRecordSet.getPageNumber(),s=this,r,n,a,l;if(i.length>0){if(r=this._currentRecordSet.getRecordByPrimaryKey(i.attr("rowkey")),a=$(i[(e?"prev":"next")+"All"]().filter("[rowkey]")[0]),a.length>0)n=this._currentRecordSet.getRecordByPrimaryKey(a.attr("rowkey"));this._changeSequenceNumber(e,r,n).addBoth(function(){s._allowChangePorNomer=true})}else if(this._hasNearestRow()){if(e){if(0!==o)l=--o}else if(this._currentRecordSet.getRecords().length>=this._currentRecordSet.getPageSize())l=++o;if("undefined"!==typeof l)new c(this._collectDataSource(e,l))}}},_changeSequenceNumber:function(e,t,i,o){var s=this.getActiveRecord(),r=new E,n=this._options.display.sequenceNumberColumn,a=s.get(n),l=t.get(n),d=this,c,_,f,u,p;if(e){if(f=t,u=i,_="До",c="Up",a<l)_="После"}else if(f=i,u=t,_="После",c="Down",a>l)_="До";if(r.addErrback(function(e){return e}),false!==this._notify("onBeforeChangeOrder",s,f,u,!!e))this._allowChangePorNomer=false,(p={"Объект":this.getDataSource().readerParams.linkedObject,"ИдО":this._getComplexKey(s.getKey()),"ПорядковыйНомер":n,"Иерархия":null})["ИдО"+_]=this._getComplexKey(t.getKey()),this._sequenceNumberObject.call("Вставить"+_,p,h.RETURN_TYPE_ASIS).addCallback(function(){if(d.once("onAfterLoad",function(){d._hideRowOptions(),d.setActiveRow(d._body.find('.ws-browser-table-row[rowkey="'+s.getKey()+'"]')),d._notify("onRecord"+c,s),r.callback()}),"undefined"!==typeof o)d.setPage(o,true);else d.reload()}).addErrback(function(){r.errback()});return r},_isDisableEditOptionForRecord:function(e){return!this._selectMode&&"oneClickMode"===this._options.mode},_additionalFilterRowOptions:function(e,t){if(this._isDisableEditOptionForRecord(t))e.push("edit")},_updateSelectedCheckboxes:function(){var e;if(this.isMultiSelect()&&this._needShowSelectionCheckbox()){e=this._getSelectedRecords(true);for(var t=0;t<e.length;t++)e[t]&&this._body.find('[rowkey="'+e[t]._pkValue+'"]').addClass("ws-browser-selected")}},_destroyRowOptions:function(){if(this._rowOptionsMenu)this._rowOptionsMenu.destroy();this._uninitRowOptions(),this._rowOptionsElement=void 0,this._rowOptions={},this._rowOptionsMenuDeferred=null,this._rowOptionsHoverRow=void 0,this._rowOptionsHoverRecord=void 0,this._rowOptionsTargetRow=void 0,this._rowOptionsButtons={},this._rowOptionsMenuButtons=[],this._rowOptionsDefault=[],this._hiddenRowOptions={},this._rowOptionsShift={}}});return Z.PRELOAD_ENABLED_MODES=Q,Z});
//# sourceMappingURL=DataViewAbstract.js.map