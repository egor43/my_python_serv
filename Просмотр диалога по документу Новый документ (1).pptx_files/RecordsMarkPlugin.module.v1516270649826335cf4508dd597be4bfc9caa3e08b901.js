define("js!SBIS3.ENGINE.RecordsMarkPlugin",["Core/ParallelDeferred","Core/Indicator","Core/core-functions","Core/core-attach","Core/helpers/dom&controls-helpers","Core/helpers/collection-helpers","Deprecated/Controls/DataViewAbstract/DataViewAbstract"],function(e,o,r,t,i,n,s){var a=134217728,l=67108864,c=33554432,d=16777216,f={},p=["#000000","#EF463A","#72BE44","#0055BB","#A426D9","#999999"],u=["Черный","Красный","Зеленый","Синий","Фиолетовый","Серый","Жирный","Курсив","Подчеркнутый","Перечеркнутый"];function h(e){return"000000".substr(0,6-e.length)+e}function C(e){if(!e)return 0;else if("string"==typeof e){if(e=Number(e),isNaN(e))e=0}else if("object"==typeof e){var o=Number((e.color||"0").replace("#","0x"));return o|=e.isBold?a:0,o|=e.isItalic?l:0,o|=e.isUnderline?c:0,o|=e.isStrike?d:0,o}return e}function k(e){return e=C(e),{color:"#"+h((16777215&e).toString(16)).toUpperCase(),isBold:!!(e&a),isItalic:!!(e&l),isUnderline:!!(e&c),isStrike:!!(e&d)}}function g(e){var o=k(e),r;if(r=["color: "+o.color+" !important"],o.isBold)r.push("font-weight: bold !important");else r.push("font-weight: normal !important");if(o.isItalic)r.push("font-style: italic !important");else r.push("font-style: normal !important");if(o.isUnderline||o.isStrike)r.push("text-decoration: "+[o.isUnderline?"underline":"",o.isStrike?"line-through":""].join(" ")+" !important");else r.push("text-decoration: none !important");return".ws-colorize-"+e+"{"+r.join(";")+"}"}function M(e){if(e=C(e),!isNaN(e)){var o="ws-colorize-"+e;if(!f[o])f[o]=g(e),i.insertCss(f[o]);return o}else return""}function R(e){if(e=C(e),!isNaN(e)){var o="ws-colorize-"+e;if(f[o])return o;else return false}else return false}function w(e,o){var r=o.data("current-colorize-class"),t=C(e.get("Code")),i=M(t);if(o.data({"current-colorize-spec":t,"current-colorize-class":i}),r)o.removeClass(r);o.addClass(i)}function m(r){var i=this.getContainer().offset(),s=false,a=this.getCurrentView(),l=a.getRecordsMarkOptions();n.forEach(r,function(e){if(e.hasColumn("ColorMark")&&e.get("ColorMark"))s=true}),t.attachInstance("Control/Area:Dialog",{opener:a,template:"js!SBIS3.ENGINE.RecordsMarkPlugin.DialogSelector",top:i.top,left:i.left+200,componentOptions:{massOperation:true,existMarkedRecords:s,records:r,handlers:{onApply:function(t,i){if(false===a._notify("onBeforeApplyMark",r,i,this))return;o.show();var s=a._options.reloadAfterChange,c=new e;if(s)a._options.reloadAfterChange=false;a._isUpdatingRecords=true,n.forEach(r,function(e){c.push(a._readRecord(e.getKey()).addCallback(function(e){return e.set(l.colorMarkLinkName,i),a.getRecordSet().updateRecord(e,[false])}))}),c.done().getResult().addCallback(function(){a._options.reloadAfterChange=s,a._isUpdatingRecords=false,a.reload(),o.hide()})}}}})}return s.extendPlugin({$protected:{_options:{recordsMark:{visible:false,colorMarkLinkName:"ColorMark",object:"",isMainOption:false,icon:"sprite:icon-16 icon-Unfavourite icon-primary",title:"Пометить",weight:null,userMarks:[],renderClasses:"",defaultColorClass:"",accessArea:"Конфигурация"}}},$condition:function(){return this._options.recordsMark&&this._options.recordsMark.visible},$constructor:function(){var e=this,i=this.getRecordsMarkOptions();if(this._options.recordsMark&&this._options.recordsMark.visible)if(this._publish("onBeforeAppendUserMarks","onBeforeResetUserMarks","onBeforeApplyMark","onBeforeEditMark"),this._convertClasses(i.renderClasses,i),this._wrapRowRenderColor(),this.isEnabled()&&!this.isReadOnly())this.addRowOption({title:i.title,icon:i.icon,name:"RecordsMark",weight:i.weight,callback:function(n,s){var a=s.offset();t.attachInstance("Control/Area:Dialog",{opener:e,template:"js!SBIS3.ENGINE.RecordsMarkPlugin.DialogSelector",top:a.top+20,left:a.left+s.width()-300,componentOptions:{handlers:{onApply:function(t,s){if(false===e._notify("onBeforeApplyMark",[n],s,this))return;o.show(),e._readRecord(n.getKey()).addCallback(function(t){t.set(i.colorMarkLinkName,s),e.getRecordSet().updateRecord(t).addCallback(function(){o.hide()}).addErrback(function(){o.hide(),r.alert("Ошибка записи.","","error")})}).addErrback(function(){o.hide(),r.alert("Ошибка чтения.","","error")})}}}})},isMainOption:i.isMainOption})},getRecordsMarkOptions:function(){return this._options.recordsMark},_convertClasses:function(e,o){if(o.massClasses=[],!e)return;n.forEach(e.split(","),function(e){if(e)o.massClasses.push(e)})},_colorizeNew:function(e,o,r){var t=this,i=e.data("current-colorize-class"),s=this.getRecordsMarkOptions().massClasses;e.data({"current-colorize-spec":o,"current-colorize-class":r}),n.forEach(s,function(o){var t=e.find("."+o);if(i)t.removeClass(i);t.addClass(r)})},_rowRenderColorizeNew:function(e,o){if(e.hasColumn("ColorMarkCode")&&(e.get("ColorMarkCode")||0===e.get("ColorMarkCode"))){var r=C(e.get("ColorMarkCode"));this._colorizeNew(o,r,M(r))}},_wrapRowRenderColor:function(){var e=this;if(!this._options.display.rowRender)this._options.display.rowRender=this._rowRenderColorizeNew.bind(this);else(function(o){e._options.display.rowRender=function(r,t){o.apply(e,arguments),e._rowRenderColorizeNew(r,t)}})(this._options.display.rowRender)},setRowRender:function(){this._wrapRowRenderColor()}}),{specToObject:k,specToNumber:C,specToStyle:g,appendSpec:M,colorizeElement:w,openFromPMO:m,definedColors:p,definedColorsName:u}});
//# sourceMappingURL=RecordsMarkPlugin.module.js.map