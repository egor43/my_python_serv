if("undefined"!=typeof document)requirejs.undef("webrtc");else{var global=function(){return this||(0,eval)("this")}();global.requirejs=require,define("js",{}),define("optional",{}),define("Lib/ServerEvent/Bus",{}),define("js!SBIS3.Plugin.Source.LocalService",{}),define("js!SBIS3.CORE.DialogConfirm",{}),define("Transport/Source",{}),define("Core/Deferred",{}),define("Transport/BLObject",{}),define("vmsg/vm",{}),define("SBIS.VideoCall/Environment",{}),define("Core/core-base",{}),define("Core/core-functions",{}),define("Core/core-extend",{}),define("Core/core-merge",{}),define("Core/Indicator",{}),define("Core/HashManager",{}),define("Core/EventBus",{}),define("Core/UserInfo",{}),define("js!SBIS3.CORE.Control",{}),define("Transport/RPCJSON",{}),define("WS.Data/Query/Query",{}),define("SBIS3.CONTROLS/WaitIndicator",{}),define("optional!js!SBIS3.Contacts.SingleChat",{}),define("optional!js!SBIS3.Meetings.WebinarOpenAuth",{}),define("optional!js!SBIS3.Meetings.WebinarBodyAttachments",{}),define("optional!js!SBIS3.Meetings.WebinarCard.WebinarSpeakers",{}),define("optional!js!SBIS3.Meetings.WebinarCard.WebinarOrganizers",{}),define("optional!js!SBIS3.Meetings.WebinarContacts",{}),define("js!SBIS3.Engine.Clipboard",{}),define("SBIS3.CONTROLS/TextBox",{}),define("optional!js!SBIS3.Person.PersonPhoto",{}),define("SBIS3.CONTROLS/ScrollContainer",{}),define("optional!js!SBIS3.Contacts.MessagesExchangeEvents",{}),define("optional!js!SBIS3.Meetings.MeetingDialog",{}),define("optional!js!SBIS3.Meetings.WebinarUtils",{}),define("optional!js!SBIS3.Meetings.ActiveQuiz",{}),define("optional!js!SBIS3.Meetings.QuizModel",{}),define("WS.Data/Entity/Record",{}),define("WS.Data/Collection/RecordSet",{}),define("js!SBIS3.EDO2.OpenDialogAction",{}),define("SBIS3.CONTROLS/CompoundControl",{}),define("SBIS3.CONTROLS/ComboBox",{}),define("SBIS3.CONTROLS/CheckBox",{}),define("SBIS3.CONTROLS/ComboBox",{}),define("SBIS3.CONTROLS/Tab/Control",{}),define("SBIS3.CONTROLS/DropdownList",{}),define("SBIS3.CONTROLS/Utils/ControlsValidators",{}),define("WS.Data/Source/SbisService",{}),define("Core/helpers/dom&controls-helpers",{}),define("js!SBIS3.CORE.Button",{}),define("SBIS3.CONTROLS/Button",{}),define("SBIS3.CONTROLS/Utils/InformationPopupManager",{}),define("Deprecated/BLObject",{}),define("Core/helpers/random-helpers",{}),define("Core/helpers/fast-control-helpers",{}),define("Core/helpers/collection-helpers",{}),define("Core/helpers/i18n/wordCaseByNumber",{}),define("Core/WindowManager",{}),define("Deprecated/helpers/collection-helpers",{}),define("optional!js!SBIS3.Painter.Editor",{}),define("WS.Data/Chain",{}),define("optional!js!SBIS3.Meetings.VoteParticipants",{}),define("optional!js!SBIS3.Interview.Helper",{}),define("optional!js!SBIS3.Interview.VoteList",{}),define("optional!js!SBIS3.Interview.Vote",{}),define("webrtc/static/focus-watcher",{}),define("webrtc/static/socket",{})}define("webrtc",["Core/js-template-doT"],function(e){function n(e){var n=e.split("!");return{plugin:n[0],path:n[1]}}function t(e){var n,t,i=function(e){return["undefined"==typeof process?"/webrtc/static/":"",e,"/"].join("")},o=function(e){return e.split(".").pop()},r=function(e){return"js"===e?"":a[e]+"!"},s=function(e,n){return"."+{css:"css",html:"xhtml",js:n?"module.js":"js"}[e]},a={html:"text",css:"native-css"},c=e.plugin,u=e.path;if(-1===u.indexOf("/"))t=o(u),n=[i(t),t,s(c,!0)].join("");else{var d=u.split("/");t=o(d.shift()),n=[i(t),d.join("/"),s(c,!1)].join("")}return[r(c),n].join("")}var i={};return{write:function(e,o,r){var s=n(o),a=s.plugin;if("html"===a){var c=t(s);r("define('"+e+"!"+o+"', function () { return "+i[c]+";});\n")}else"css"==a&&r("define('"+e+"!"+o+"', function () {});\n")},loadHTML:function(n,t,o,r){var s=require.nodeRequire("fs"),a=s.readFileSync("static/"+n.replace("text!",""),"utf8"),c=i[n]=e.template(a);o(c)},load:function(i,o,r,s){var a=n(i),c=t(a),u=a.plugin;s.isBuild&&"html"===u?this.loadHTML(c,o,r,s):s.isBuild&&"css"===u?r():o([c],function(n){r("html"===u?e.template(n):n)})},createRoom:function(e){return"/webrtc/room/"+$ws.helpers.createGUID()+"?video=true"+(e?"&meeting="+e:"")},createWebinar:function(e){return"/webinar/"+e}}}),define("webrtc/static/startup",["webrtc!js!SBIS3.WebRTC.Core/resources/RTCChecker","Core/EventBus"],function(e,n){var t=n.channel("videoCall");t.setEventQueueSize("onReady",1),t.notify("onReady"),e.gatherCandidates()}),define("webrtc!js!SBIS3.WebRTC.EventEmitter",[],function(){"use strict";function e(){e.init.call(this)}function n(n){return void 0===n._maxListeners?e.defaultMaxListeners:n._maxListeners}function t(e,n,t){if(n)e.call(t);else for(var i=e.length,o=u(e,i),r=0;i>r;++r)o[r].call(t)}function i(e,n,t,i){if(n)e.call(t,i);else for(var o=e.length,r=u(e,o),s=0;o>s;++s)r[s].call(t,i)}function o(e,n,t,i,o){if(n)e.call(t,i,o);else for(var r=e.length,s=u(e,r),a=0;r>a;++a)s[a].call(t,i,o)}function r(e,n,t,i,o,r){if(n)e.call(t,i,o,r);else for(var s=e.length,a=u(e,s),c=0;s>c;++c)a[c].call(t,i,o,r)}function s(e,n,t,i){if(n)e.apply(t,i);else for(var o=e.length,r=u(e,o),s=0;o>s;++s)r[s].apply(t,i)}function a(e){var n=this._events;if(n){var t=n[e];if("function"==typeof t)return 1;if(t)return t.length}return 0}function c(e,n){for(var t=n,i=t+1,o=e.length;o>i;t+=1,i+=1)e[t]=e[i];e.pop()}function u(e,n){for(var t=new Array(n);n--;)t[n]=e[n];return t}return e.EventEmitter=e,e.prototype._events=void 0,e.prototype._maxListeners=void 0,e.defaultMaxListeners=10,e.init=function(){this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events={},this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},e.prototype.setMaxListeners=function(e){if("number"!=typeof e||0>e||isNaN(e))throw new TypeError("n must be a positive number");return this._maxListeners=e,this},e.prototype.getMaxListeners=function(){return n(this)},e.prototype.emit=function(e){var n,a,c,u,d,f,l="error"===e;if(f=this._events)l=l&&null==f.error;else if(!l)return!1;if(l){if(n=arguments[1],n instanceof Error)throw n;var p=new Error('Uncaught, unspecified "error" event. ('+n+")");throw p.context=n,p}if(a=f[e],!a)return!1;var h="function"==typeof a;switch(c=arguments.length){case 1:t(a,h,this);break;case 2:i(a,h,this,arguments[1]);break;case 3:o(a,h,this,arguments[1],arguments[2]);break;case 4:r(a,h,this,arguments[1],arguments[2],arguments[3]);break;default:for(u=new Array(c-1),d=1;c>d;d++)u[d-1]=arguments[d];s(a,h,this,u)}return!0},e.prototype.addListener=function(e,t){var i,o,r;if("function"!=typeof t)throw new TypeError("listener must be a function");return o=this._events,o?(o.newListener&&(this.emit("newListener",e,t.listener?t.listener:t),o=this._events),r=o[e]):(o=this._events={},this._eventsCount=0),r?("function"==typeof r?r=o[e]=[r,t]:r.push(t),r.warned||(i=n(this),i&&i>0&&r.length>i&&(r.warned=!0,console&&(console.error("(node) warning: possible EventEmitter memory leak detected. %d %s listeners added. Use emitter.setMaxListeners() to increase limit.",r.length,e),console.trace())))):(r=o[e]=t,++this._eventsCount),this},e.prototype.on=e.prototype.addListener,e.prototype.once=function(e,n){function t(){this.removeListener(e,t),i||(i=!0,n.apply(this,arguments))}if("function"!=typeof n)throw new TypeError("listener must be a function");var i=!1;return t.listener=n,this.on(e,t),this},e.prototype.removeListener=function(e,n){var t,i,o,r;if("function"!=typeof n)throw new TypeError("listener must be a function");if(i=this._events,!i)return this;if(t=i[e],!t)return this;if(t===n||t.listener&&t.listener===n)0===--this._eventsCount?this._events={}:(delete i[e],i.removeListener&&this.emit("removeListener",e,n));else if("function"!=typeof t){for(o=-1,r=t.length;r-- >0;)if(t[r]===n||t[r].listener&&t[r].listener===n){o=r;break}if(0>o)return this;if(1===t.length){if(t[0]=void 0,0===--this._eventsCount)return this._events={},this;delete i[e]}else c(t,o);i.removeListener&&this.emit("removeListener",e,n)}return this},e.prototype.removeAllListeners=function(e){var n,t;if(t=this._events,!t)return this;if(!t.removeListener)return 0===arguments.length?(this._events={},this._eventsCount=0):t[e]&&(0===--this._eventsCount?this._events={}:delete t[e]),this;if(0===arguments.length){for(var i,o=Object.keys(t),r=0;r<o.length;++r)i=o[r],"removeListener"!==i&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events={},this._eventsCount=0,this}if(n=t[e],"function"==typeof n)this.removeListener(e,n);else if(n)do this.removeListener(e,n[n.length-1]);while(n[0]);return this},e.prototype.listeners=function(e){var n,t,i=this._events;return i?(n=i[e],t=n?"function"==typeof n?[n]:u(n,n.length):[]):t=[],t},e.prototype.flush=function(){this._events=null,this._eventsCount=null},e.listenerCount=function(e,n){return"function"==typeof e.listenerCount?e.listenerCount(n):a.call(e,n)},e.prototype.listenerCount=a,e}),define("EventEmitter/EventEmitter.module.js",function(){}),define("webrtc!js!SBIS3.WebRTC.GUI/resources/uuid",[],function(){function e(e,n,t){var i=n&&t||0,o=0;for(n=n||[],e.toLowerCase().replace(/[0-9a-f]{2}/g,function(e){16>o&&(n[i+o++]=c[e])});16>o;)n[i+o++]=0;return n}function n(e,n){var t=n||0,i=a;return i[e[t++]]+i[e[t++]]+i[e[t++]]+i[e[t++]]+"-"+i[e[t++]]+i[e[t++]]+"-"+i[e[t++]]+i[e[t++]]+"-"+i[e[t++]]+i[e[t++]]+"-"+i[e[t++]]+i[e[t++]]+i[e[t++]]+i[e[t++]]+i[e[t++]]+i[e[t++]]}function t(e,t,i){var o=t&&i||0,r=t||[];e=e||{};var s=void 0!==e.clockseq?e.clockseq:l,a=void 0!==e.msecs?e.msecs:(new Date).getTime(),c=void 0!==e.nsecs?e.nsecs:h+1,u=a-p+(c-h)/1e4;if(0>u&&void 0===e.clockseq&&(s=s+1&16383),(0>u||a>p)&&void 0===e.nsecs&&(c=0),c>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");p=a,h=c,l=s,a+=122192928e5;var d=(1e4*(268435455&a)+c)%4294967296;r[o++]=d>>>24&255,r[o++]=d>>>16&255,r[o++]=d>>>8&255,r[o++]=255&d;var v=a/4294967296*1e4&268435455;r[o++]=v>>>8&255,r[o++]=255&v,r[o++]=v>>>24&15|16,r[o++]=v>>>16&255,r[o++]=s>>>8|128,r[o++]=255&s;for(var m=e.node||f,g=0;6>g;g++)r[o+g]=m[g];return t?t:n(r)}function i(e,t,i){var o=t&&i||0;"string"==typeof e&&(t="binary"==e?new Array(16):null,e=null),e=e||{};var r=e.random||(e.rng||s)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t)for(var a=0;16>a;a++)t[o+a]=r[a];return t||n(r)}var o,r=new Array(16);o=function(){for(var e,n=0;16>n;n++)0===(3&n)&&(e=4294967296*Math.random()),r[n]=e>>>((3&n)<<3)&255;return r};for(var s=o,a=[],c={},u=0;256>u;u++)a[u]=(u+256).toString(16).substr(1),c[a[u]]=u;var d=s(),f=[1|d[0],d[1],d[2],d[3],d[4],d[5]],l=16383&(d[6]<<8|d[7]),p=0,h=0,v=i;return v.v1=t,v.v4=i,v.parse=e,v.unparse=n,v}),define("GUI/resources/uuid.js",function(){}),define("webrtc!js!SBIS3.WebRTC.Report",["webrtc!js!SBIS3.WebRTC.GUI/resources/uuid","SBIS.VideoCall/Environment","webrtc/static/socket"],function(e,n,t){var i=[],o=!0,r=t("report",!0),s=function(e,n,t,i){if("function"==typeof navigator.sendBeacon)try{var o=new Blob([JSON.stringify(e)],{type:"application/json"});return navigator.sendBeacon("/webrtc/report",o),void("function"==typeof t&&t())}catch(r){}$.ajax({type:"POST",url:"/webrtc/report",contentType:"application/json",data:JSON.stringify(e),async:n,success:t,error:i})},a=function(e,t,i,o){var a=arguments;t&&n.inProgress?r.send(JSON.stringify(e)).addCallback(function(){"function"==typeof i&&i()}).addErrback(function(){s.apply(null,a)}):s.apply(null,a)},c=function(e){e=e&&"function"==typeof e?e:function(){},i.length>0?a(i,!1,e,e):e()},u=function(){if(o&&i.length>0&&n.CpsUserId){var e=i.splice(0),t=function(){setTimeout(function(){o=!0,u()},1e3)};o=!1,a(e,!0,function(){t()},function(){i=i.concat(e),t()})}};return{insertIntoUserInfo:function(e){function n(n){var t;switch(n){case"uuid":t=e.uuid;break;case"client_id":t=e.clientId;break;case"department_external":t=e.departmentExternal;break;case"department_internal":t=e.departmentInternal;break;case"face_id":t=e.faceId;break;case"name":t=e.name}return t}var t=["uuid","name","client_id","department_external","department_internal","face_id"],o={type:"userInfo",content:{}};t.forEach(function(e){o.content[e]=n(e)}),i.push(o),u()},insertIntoConversationMember:function(e){var t=e.userAgent,o="",r="";if(t){for(var s in n.browser)if(n.browser.hasOwnProperty(s)&&"version"!==s&&n.browser[s]){o=s;break}for(var a in n.os)if(n.os.hasOwnProperty(a)&&n.os[a]){r=a;break}e.userAgent={},e.userAgent.architecture=/x86_64|x86-64|win64|x64;|wow64|x64_64/i.test(t.toLowerCase())?64:32,e.userAgent.os=r,e.userAgent.agent_version=n.browser.version,e.userAgent.agent_name=o}var c={type:"conversationMember",content:e};i.push(c),u()},saveEvent:function(e,t){if(!n.isWebinar&&!n.debug&&(n.inProgress||t.conversationId)){t.id=e;var o={type:"event",content:t};i.push(o),u()}},sendLastMessages:function(e){c(e)},insertIntoConversation:function(){var e={};e.id=n.roomId,e.creator=n.CpsUserId,e.time=+new Date;var t={type:"conversation",content:e};i.push(t),u()},saveStat:function(e,n){i.push({type:e,content:n}),u()}}}),define("Report/Report.module.js",function(){}),define("webrtc!js!SBIS3.WebRTC.Event",["webrtc!js!SBIS3.WebRTC.Report","webrtc!js!SBIS3.WebRTC.GUI/resources/uuid","SBIS.VideoCall/Environment"],function(e,n,t){function i(n,i,o){i=i||{},i.name=o,i.endTime=i.endTime||+new Date,i.endPointContent=JSON.stringify(i.endPointContent)?JSON.stringify(i.endPointContent).replace(/'/g,'/"'):null,i.conversationId=i.conversationId||t.roomId,e.saveEvent(n,i)}function o(i,o){o=o||{},o.id=o.id||n.v4(),this.id=o.id,this.name=i,this.conversationId=o.conversationId=o.conversationId||t.roomId,this.isStopped=o.isPoint===!0,o.name=i,o.src=t.CpsUserId,o.browser=t.browser.name+" "+t.browser.version,o.startPointContent=JSON.stringify(o.startPointContent)?JSON.stringify(o.startPointContent).replace(/'/g,'/"'):null,o.startTime=o.startTime||+new Date,o.src?(r.forEach(function(n){n.src=o.src,e.saveEvent(n.id,n)}),r=[],e.saveEvent(this.id,o)):r.push(o)}var r=[];return o.prototype.stop=function(e){e=e||{},e.conversationId=this.conversationId,i(this.id,e,this.name),this.isStopped=!0},o.prototype.update=function(n){n.startPointContent=JSON.stringify(n.startPointContent),n.endPointContent=JSON.stringify(n.endPointContent),n.conversationId=n.conversationId||t.roomId,e.saveEvent(this.id,n)},o.prototype.error=function(e){e=e||{},e.conversationId=this.conversationId,e.isError=!0,this.isStopped=!0,i(this.id,e,this.name)},o.prototype.warning=function(e){e=e||{},e.conversationId=this.conversationId,e.isWarning=!0,this.isStopped=!0,i(this.id,e,this.name)},o.prototype.getId=function(){return this.id},o.closeRemote=function(e,n,o){e&&(n=n||{},n.dst=t.CpsUserId,i(e,n,o))},o}),define("Event/Event.module.js",function(){}),define("webrtc!js!SBIS3.WebRTC.Listener/resources/newIO",["Core/core-functions","Core/Deferred","Lib/ServerEvent/Bus","webrtc!js!SBIS3.WebRTC.EventEmitter","webrtc!js!SBIS3.WebRTC.Event","SBIS.VideoCall/Environment","webrtc/static/socket"],function(e,n,t,i,o,r,s){var a={COMMON:"videocall.common",ACTIVE:"videocall.active"},c="/webrtc/message/",u=6e3,d="no current room",f="request roomId and line roomId are not match",l=3,p=s("message"),h=function(e){return e.toJSON().replace(/^.+T/,"").replace("Z","")},v=function(){if(this._receivedMessages=[],this._sentMessages=[],r.inProgress){var e,n=function(){e=+new Date},t=function(){e&&new o("offline",{startTime:e}).warning()},i="function"==typeof window.addEventListener?"addEventListener":"attachEvent";window[i]("offline",n),window[i]("online",t)}};return e.classicExtend(v,i),v.prototype.connect=function(e){var i,r,s,c,u,d=new n;return!e&&(e={}),!e.type&&(e.type="common"),e.connectionTimeout&&(u=new o("subscribe_to_sc")),c=t.serverChannel(a[e.type.toUpperCase()],{exclusive:e.exclusiveMode}).subscribe("onReady",r=function(){d.isReady()||(u&&u.stop(),clearTimeout(s),d.callback())}).subscribe("onMessage",i=this._onMessage.bind(this)),e.connectionTimeout&&(s=setTimeout(function(){if(!d.isReady()){var n=new Error("ServerEventBus.connectionTimeout: "+e.connectionTimeout+" ms");u.error({endPointContent:{error:n.message}}),c.unsubscribe("onReady",r),c.unsubscribe("onMessage",i),this.generateSharedBusDump(),d.errback(n)}}.bind(this),e.connectionTimeout)),e.privateChannel&&(this._privateChannel=e.privateChannel),d},v.prototype.send=function(e,t,i){!i&&(i={});var s,a,v=new n,m={_type:e,_data:t,_roomId:i.ignoreRoomId?void 0:r.roomId},g=this,S=new Date,b=1,w=function(e,n){var t={isPoint:!0,startPointContent:{data:m,error:e,duration:new Date-S}};n?t.isWarning=!0:t.isError=!0,new o("IO.send",t)},C=function(n,t){var i={},o=new Date;clearTimeout(s),!v.isCallbacksLocked()&&v.callback(t.result),i[e]=[h(S),h(o),o-S+"ms",n].join("|"),g._sentMessages.push(i)},I=function(){if(window.$&&"function"==typeof $.ajax){if(i&&i.ignoreResponse===!0&&"function"==typeof navigator.sendBeacon){var e=!1;try{var n=new Blob([JSON.stringify(m)],{type:"application/json"});e=navigator.sendBeacon(i.serviceUrl||c,n)}catch(t){e=!1}if(e===!0)return void v.callback();i.ignoreResponse=!1}a&&a.abort(),clearTimeout(s),s=setTimeout(I,u),a=$.ajax({type:"POST",url:i.serviceUrl||c,data:JSON.stringify(m),async:i.async,contentType:"application/json",success:C.bind(null,"XHR"),error:function(e,n){clearTimeout(s);var t="error"===n&&401===e.status,i="error"===n&&0===e.status,r=e.responseJSON&&e.responseJSON.error,a=r===d,c=new RegExp(f).test(r),p=function(){!v.isCallbacksLocked()&&!v.isReady()&&v.errback(r)};"abort"===n||i||t?(new o(t?"session disabled":"abort request",{isPoint:!0,isWarning:!0,startPointContent:m}),g.emit("internal.abort")):(w(["status: ",n," ",e.status,"; response: ",e.responseText,"; headers: ",e.getAllResponseHeaders()].join(""),a||c),a?(g.emit("internal.noroom"),p()):c?(g.emit("internal.invalidRoomId"),p()):l>b?(b++,setTimeout(I,u)):p())}})}else v.errback("$.ajax is not a function")};return this._privateChannel&&(m._channel=this._privateChannel),i.async!==!1?p.send(JSON.stringify(m)).addCallback(function(e){return C("WS",e),e}).addErrback(function(e){return I(),e}):I(),v},v.prototype._onMessage=function(e,n){try{n=JSON.parse(n)}catch(t){}if(!(this._privateChannel&&this._privateChannel!==n._channel||n._roomId&&r.roomId&&n._roomId!==r.roomId)){var i=function(){var e={};e[n._type||"unknown"]=h(new Date)+"|STOMP",this._receivedMessages.push(e),n._type?this.emit(n._type,n._data):this.emit("message",n)}.bind(this);window.PROCESS_EVENT_DELAY&&window.PROCESS_EVENT_DELAY[n._type]?setTimeout(i,1e3*window.PROCESS_EVENT_DELAY[n._type]):i()}},v.prototype.getDump=function(){return{received:this._receivedMessages,sent:this._sentMessages}},v.prototype.generateSharedBusDump=function(){if("function"==typeof window.sharedBusDump){var e=new o("shared_bus_dump");window.sharedBusDump().addBoth(function(n){e.stop({endPointContent:{dump:n}})})}},v.prototype.pushReceivedMessage=function(e){this._pushMessage("_receivedMessages",e)},v.prototype.pushSentMessage=function(e){this._pushMessage("_sentMessages",e)},v.prototype._pushMessage=function(e,n){var t={};t[n]=h(new Date)+"|DataChannel",this[e].push(t)},new v}),define("Listener/resources/newIO.js",function(){}),define("webrtc!js!SBIS3.WebRTC.LocalStorageCache",["Core/Deferred"],function(e){var n="VideoCall_LSCache_isStarted_",t="VideoCall_LSCache_Result_",i=1e4,o=new RegExp(t),r=new RegExp(n),s={},a=function(e){var n;try{n=JSON.parse(localStorage.getItem(e))}catch(t){}return n};return window.addEventListener("storage",function(e){e=e||window.event;var n=e.key;o.test(n)&&s.hasOwnProperty(n)&&(s[n].callback(a(n)),delete s[n])}),{isStarted:function(e){return localStorage.hasOwnProperty(n+e)},isReady:function(e){return localStorage.hasOwnProperty(t+e)},setStarted:function(e){localStorage.setItem(n+e,"")},removeStarted:function(e){localStorage.removeItem(n+e)},setReadyValue:function(e,o){localStorage.removeItem(n+e),localStorage.setItem(t+e,JSON.stringify(o)),clearTimeout(this._expireTimer),this._expireTimer=setTimeout(this.removeReadyValue.bind(this,e),i)},getReadyDeferred:function(n){var i=new e,o=t+n;return this.isReady(n)?i.callback(a(o)):s[o]=i,i},clearLS:function(){for(var e in localStorage)localStorage.hasOwnProperty(e)&&(r.test(e)||o.test(e))&&localStorage.removeItem(e)},removeReadyValue:function(e){localStorage.removeItem(t+e)},init:function(e,n,t){var i=this;this.isStarted(e)||this.isReady(e)?this.getReadyDeferred(e).addCallback(function(e){return t(e),e}):(this.setStarted(e),n().addCallback(function(n){return t(n),i.setReadyValue(e,n),n}).addErrback(function(n){return i.removeStarted(e),n}))}}}),define("LocalStorageCache/LocalStorageCache.module.js",function(){}),define("webrtc!js!SBIS3.WebRTC.Listener/resources/MeetingListener",["Lib/ServerEvent/Bus","webrtc!js!SBIS3.WebRTC.Listener/resources/newIO","webrtc!js!SBIS3.WebRTC.Event","webrtc!js!SBIS3.WebRTC.LocalStorageCache"],function(e,n,t,i){return{$protected:{_meetingNotificationDict:{},_meetingInProgressDict:{}},after:{_onIOConnect:function(){e.serverChannel("Notification.Videoconf.Start").subscribe("onMessage",this._onVideoconfStart.bind(this)),e.serverChannel("notification.videoconf.end").subscribe("onMessage",this._onVideoconfEnd.bind(this))},_onCancel:function(e){this._onVideoconfEnd(null,e.meetingId)}},_onVideoconfStart:function(e,o){var r=this,s=JSON.parse(o.Params),a=/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/.exec(s["Ссылка"]),c=s.UUID,u=function(e){var i=new t("show_meeting_notification",{conversationId:a});s&&s.eventId&&"string"==typeof s.eventId&&s.eventId.length>0&&(e.eventId=s.eventId),e.date_to=s.DateTo||new Date((new Date).getTime()-60*(new Date).getTimezoneOffset()*1e3+18e5).toISOString().replace("T"," ").match(/(.*:.*):/)[1],require(["webrtc!js!SBIS3.WebRTC.GlobalInformer"],function(o){o.show(e).addCallback(function(o){var s,u=o[0],d=o[1];if(i.stop({endPointContent:{type:u.getType(),owner:d.owner,notificationId:e.notificationId}}),!r._meetingInProgressDict[c])return u.close();if(r._meetingNotificationDict[c]=u,delete r._meetingInProgressDict[c],u.on("close",function(){delete r._meetingNotificationDict[c],s&&!s.isStopped&&s.stop()}).on("error",function(e,n){new t("system_info_message_error",{isPoint:!0,isError:!0,conversationId:a,startPointContent:{name:e.name,message:n}}),delete r._meetingNotificationDict[c],s&&!s.isStopped&&s.error()}),d.owner){s=new t("browser_meeting_waiting_for_an_action",{conversationId:a});var f=function(){s.stop({endPointContent:{action:"accept"}}),n.send("meeting_accept",{meetingId:c,roomId:a})};u.on("accept",f.bind(null)).on("accept_video",f.bind(null)).on("reject",function(e,t){s.stop({endPointContent:{action:"reject",hasMessage:!!t}}),n.send("meeting_reject",{meetingId:c,roomId:a,message:t})})}}).addErrback(function(n){i.error({endPointContent:{message:n.message,notificationId:e.notificationId}})})})},d=function(){var e=new t("browser_get_markup",{conversationId:a,startPointContent:s});return n.send("get_meeting_markup_json",{members:s["Участники"],url:s["Ссылка"],meetingId:c,title:s["Примечание"],_responseType:"xhr"}).addCallback(function(n){return n&&n.error?e.warning({endPointContent:n.error}):e.stop(),n}).addErrback(function(n){return e.error({endPointContent:n.message}),n})};a=a&&a[0]||"",r._meetingInProgressDict[c]=!0,i.init(c,d,u)},_onVideoconfEnd:function(e,n){n in this._meetingNotificationDict?(this._meetingNotificationDict[n].close(),delete this._meetingNotificationDict[n]):n in this._meetingInProgressDict&&delete this._meetingInProgressDict[n]}}}),define("Listener/resources/MeetingListener.js",function(){}),define("webrtc!js!SBIS3.WebRTC.GlobalInformer/resources/VisibilityMonitor",["SBIS.VideoCall/Environment"],function(e){var n=function(){localStorage.setItem("__webrtc__tab__activity",!0)},t=function(){localStorage.removeItem("__webrtc__tab__activity")};n(),window.onfocus=function(){n()},window.onblur=function(){t()},e.$win.on("beforeunload",function(){t()}),e.$win.on("unload",function(){t()})}),define("GlobalInformer/resources/VisibilityMonitor.js",function(){}),define("webrtc!js!SBIS3.WebRTC.Listener",["Core/core-extend","Core/EventBus","Core/Deferred","Core/helpers/collection-helpers","Lib/ServerEvent/Bus","webrtc!js!SBIS3.WebRTC.Listener/resources/newIO","webrtc!js!SBIS3.WebRTC.Event","js!SBIS3.Plugin.Source.LocalService","SBIS.VideoCall/Environment","webrtc!js!SBIS3.WebRTC.GUI/resources/uuid","webrtc!js!SBIS3.WebRTC.Listener/resources/MeetingListener","webrtc!js!SBIS3.WebRTC.LocalStorageCache","webrtc!js!SBIS3.WebRTC.GlobalInformer/resources/VisibilityMonitor"],function(e,n,t,i,o,r,s,a,c,u,d,f){var l,p=$(window),h=5e3,v=function(){if(l)return l;var e=window.screen.availWidth||window.screen.width||window.outerWidth,n=window.screen.availHeight||window.screen.height||window.outerHeight,t=Math.ceil(.8*n),o=Math.ceil(t/(c.browser.ie?.6:.75)),r=Math.ceil((n-t)/4),s=Math.ceil((e-o)/2),a="window",u={width:o,height:t,top:r,left:s,target:a},d=[];return i.forEach(u,function(e,n){d.push([n,e].join("="))}),l=d.join(",")};p.on("unload",f.clearLS.bind(f));var m=e({},{$protected:{_notificationDict:{},_showingNotificationDict:{}},$constructor:function(){if(c.browser.chrome&&this._createSilence(),!c.inProgress){if("Notification"in window){var e=new a({endpoint:{address:"VideoCallService-0.0.0.5",contract:"VideoCallService"},options:{mode:"silent"}});e.isReady().addErrback(function(){Notification.requestPermission()})}r.connect().addCallback(this._onIOConnect.bind(this))}},_createSilence:function(){try{var e=document.createElement("div");e.style.position="absolute",e.style.display="none";var n=document.createElement("audio");n.src="/webrtc/static/sounds/silence_250ms.mp3",n.autoplay=!0,e.appendChild(n),document.body.appendChild(e)}catch(t){}},_onWebinarStart:function(e,n){var t=this,o=JSON.parse(localStorage.getItem("webinars_list")),s=!1,a=JSON.parse(n.Params),c=a.UUID,u=function(){return r.send("get_webinar_markup",{url:a["Ссылка"],title:a["Примечание"],time:n.Date,_responseType:"xhr"})};a.OrangeNotice||(o instanceof Array&&o.length&&i.forEach(o,function(e){a&&a.link&&a.link.indexOf("webinar="+e)&&(s=!0)}),setTimeout(function(){f.init(c,u,function(e){e.date_to=a.DateTo,t._onWebinarMarkup(e)})},Math.round(Math.random()*h)))},_onIOConnect:function(){r.on("invite",this._onInvite.bind(this)),r.on("cancel",this._onCancel.bind(this)),r.on("update_notification",this._onUpdateNotification.bind(this)),o.serverChannel("Notification.Webinar.Start").subscribe("onMessage",this._onWebinarStart.bind(this))},call:function(e,n){require(["webrtc!js!SBIS3.WebRTC.Report","webrtc!js!SBIS3.WebRTC.DataProvider"],function(e,n){n.getUserInfo(c.CpsUserId,!0).addCallback(function(n){return e.insertIntoUserInfo(n),n})}),n&&"string"!=typeof n?void 0==n.video?n.video=!0:void 0==n.audio&&(n.audio=!0):n={video:!0,audio:!0};var t=[];e instanceof Array?t=e:t.push(e),this.open(t.map(function(e){return"string"==typeof e?e:(delete e.video,delete e.audio,JSON.stringify(e))}),n)},open:function(e,n){function t(){o&&!o.closed&&o.focus()}function i(){p.unbind("focus",t)}var o,r=n.roomId||u.v4(),a=["/webrtc/room/",r,"?toInvite=",e.join("|"),"&video=",n.video],d=new Error;n.docGUID&&a.push("&d=",n.docGUID),new s("initCall",{conversationId:r,isPoint:!0,startPointContent:{stack:d.stack,href:location.href,toInvite:e}}),o=window.open(a.join(""),"",v()),o&&o.focus(),c.browser.ie&&(p.bind("focus",t),$(o).on("unload",i),setTimeout(i,5e3))},_getMarkup:function(e){var n=new t,i=function(){var n=new s("browser_get_markup",{conversationId:e});return r.send("get_markup_json",{roomId:e,_responseType:"xhr"}).addCallback(function(e){return e.error?(n.warning({endPointContent:e.error}),new Error):(n.stop({endPointContent:e}),e)}).addErrback(function(e){return!n.isStopped&&n.error({endPointContent:e}),e})};return f.init(e,i,function(e){n.callback(e)}),n},_onInvite:function(e){e=e||{};var n=this,t=e.roomId,i=e.from,o=e.eventId;o&&s.closeRemote(o,{conversationId:t}),n._showingNotificationDict[t]=!0,t&&i&&n._getMarkup(t).addCallback(function(e){var a=new s("show_notification",{conversationId:t});e.eventId=o,e.from=i,e.conversationId=t;var c=new s("require_global_informer",{conversationId:t});require(["webrtc!js!SBIS3.WebRTC.GlobalInformer"],function(i){c.stop(),i.show(e).addCallback(function(i){var o,c=i[0],u=i[1];if(a.stop({endPointContent:{type:c.getType(),owner:u.owner,notificationId:e.notificationId}}),!n._showingNotificationDict[t])return c.close();if(delete n._showingNotificationDict[t],r.send("show_notification",{type:c.getType(),roomId:t}),n._notificationDict[t]=c,c.on("close",function(){delete n._notificationDict[t],o&&!o.isStopped&&o.stop({endPointContent:"canceled"})}).on("error",function(e,i){new s("system_info_message_error",{isPoint:!0,isError:!0,conversationId:t,startPointContent:{name:e.name,message:i}}),delete n._notificationDict[t],o&&!o.isStopped&&o.error({endPointContent:{name:e.name,message:i}})}),u.owner){var d=function(e){r.send("accept",{roomId:t}),o.stop({endPointContent:{action:"accept",withVideo:e}})},f=function(e){r.send("reject",{roomId:t,message:e}),o.stop({endPointContent:{action:"reject",hasMessage:!!e}})},l=function(){r.send("merge_with_active_room",{roomId:t}),o.stop({endPointContent:{action:"merge_with_active_room"}})};o=new s("browser_waiting_for_an_action",{conversationId:t}),c.on("accept",d.bind(null,!1)).on("accept_video",d.bind(null,!0)).on("reject",function(e,n){"null"!==n&&n||(n=""),f(n)}).on("merge_with_active_room",l)}}).addErrback(function(n){a.error({endPointContent:{message:n.message,notificationId:e.notificationId}})})})})},_onCancel:function(e){e=e||{};var n=e.roomId,t=e.reason,i=e.eventId,o=e.parentId,r={isPoint:!0,conversationId:n,startPointContent:{reason:t}};i?s.closeRemote(i):(o&&(r.parent=o),new s("cancel",r)),n in this._notificationDict?this._notificationDict[n].close():n in this._showingNotificationDict&&delete this._showingNotificationDict[n]},_onUpdateNotification:function(e){var n=e.roomId;new s("update_notification",{conversationId:n,isPoint:!0}),n in this._notificationDict&&this._getMarkup(n).addCallback(function(e){n in this._notificationDict&&this._notificationDict[n].redraw(e)}.bind(this))},_onWebinarMarkup:function(e){var n=e.uuid;e.html=e.markup,e.callType=e.type,require(["webrtc!js!SBIS3.WebRTC.GlobalInformer"],function(t){t.show(e,!1,!0).addCallback(function(e){var t,i,r,s=o.serverChannel("Notification.Webinar.Reject"),a=o.serverChannel("Notification.Webinar.BroadcastingStateChanged"),c=o.serverChannel("Notification.Webinar.OnBroadcastWindowOpen"),u=function(){s.unsubscribe("onMessage",t),a.unsubscribe("onMessage",i),c.unsubscribe("onMessage",r),e.closeAll()};e=e[0],s.subscribe("onMessage",t=function(e,t){t.uuid==n&&u()}),a.subscribe("onMessage",i=function(e,t){t.uuid==n&&3==t.state&&u()}),c.subscribe("onMessage",r=function(e,t){t.uuid==n&&u()}),e.on("accept",u.bind(this)).on("reject",u.bind(this))})})}});return f.clearLS(),c.isWebRTCAvailable=!c.inProgress,new(m=e.mixin(m,[d]))}),define("Listener/Listener.module.js",function(){}),define("webrtc!js!SBIS3.WebRTC.Core/resources/IceServers",[],function(){return[{urls:"stun:91.213.144.168:3478"},{urls:"turn:91.213.144.168:3478?transport=tcp",username:"myuser",credential:"mypass"},{urls:"turn:91.213.144.168:3478?transport=udp",username:"myuser",credential:"mypass"},{urls:"turn:91.213.144.168:443?transport=udp",username:"myuser",credential:"mypass"},{urls:"turn:91.213.144.168:443?transport=tcp",username:"myuser",credential:"mypass"}]}),define("Core/resources/IceServers.js",function(){}),define("webrtc!js!SBIS3.WebRTC.Manager/resources/WaitingDeferred",["Core/core-functions","Core/Deferred"],function(e,n){function t(e,n,i){t.superclass.constructor.apply(this,arguments),"boolean"==typeof n&&(i=n,n="");var o=this,r=setTimeout(function(){o.isReady()||o[i?"callback":"errback"](n||"time out")},e);this.addBoth(function(e){return clearTimeout(r),e}),this._timer=r}return e.classicExtend(t,n),t.prototype.clear=function(){clearTimeout(this._timer)},t}),define("Manager/resources/WaitingDeferred.js",function(){}),define("webrtc!js!SBIS3.WebRTC.Core/resources/SDManager",[],function(){
var e=/m=/,n=/m=video/,t="a=rtpmap:(\\d+)",i="(a=rtcp-fb:|a=fmtp:)";return{splitLines:function(e){return e.split("\n")},joinLines:function(e){return e.join("\n")},removeVideoCodecs:function(e,n){var t=e.split("\n"),i="m=",o=i+"video",r="a=rtpmap:(\\d+)",s="(a=rtcp-fb:|a=fmtp:)",a=0,c=[];return n instanceof Array||(n=[n]),n.forEach(function(e){e=e.toLowerCase();var n,u,d=[],f=null;for(u=a;u<t.length;u++)if(n=t[u].toLowerCase(),a){if(new RegExp(r+".*"+e).test(n))c.push(f=new RegExp(r).exec(n).pop()),d.push(u);else if(f&&new RegExp(s+f).test(n))d.push(u);else if(u!==a&&new RegExp(i).test(n))break}else new RegExp(o).test(n)&&(a=u);t.splice(d[0],d.length)}),c.forEach(function(e){t[a]=t[a].replace(new RegExp(e+"\\s?"),"")}),t.join("\n")},setPreferVideoCodec:function(e,i){var o,r=this.splitLines(e),s=[];if(r.forEach(function(e,r){n.test(e)?o=r:new RegExp(t+".*"+i).test(e)&&s.push(new RegExp(t).exec(e).pop())}),o&&s.length){var a,c=r[o],u=c.split(" "),d=[];for(a=u.length-1;a>0&&/^\d+$/.test(u[a].trim());a--)d.unshift(u[a]),u.pop();s.forEach(function(e){d.splice(d.indexOf(e),1)}),d.unshift.apply(d,s),r[o]=u.concat(d).join(" ")}return this.joinLines(r)},isSupportVideoCodec:function(e,n){var o,r=this.splitLines(e),s=!1;return r.forEach(function(e){!o&&new RegExp(t+".*"+n).test(e)?o=new RegExp(t).exec(e).pop():o&&new RegExp(i+o).test(e)&&(s=!0)}),s},toStandart:function(n){var o=this.splitLines(n),r=[];return o.forEach(function(n,t){e.test(n)&&r.push(t)}),r.forEach(function(e,n){var s,a,c,u=r[n+1]||o.length-1,d={},f=[];for(c=e+1;u>c;c++)s=o[c],new RegExp(i).test(s)?(a=new RegExp(i+"(\\d+)").exec(s).pop(),-1===f.indexOf(a)&&(!d[a]&&(d[a]=[]),d[a].push(s),o.splice(c,1),c--)):new RegExp(t).test(s)&&(a=new RegExp(t).exec(s).pop(),f.push(a),d[a]&&d[a].forEach(function(e){o.splice(c+1,0,e),c++}))}),this.joinLines(o)},setMaxBandwidth:function(e,n){return n="\nb=AS:"+n,e.replace(/a=mid:video/,"a=mid:video"+n).replace(/a=mid:sdparta_1/,"a=mid:sdparta_1"+n)},removeRTXStream:function(e){var n,t=this.splitLines(e),i=[];return t.forEach(function(e,t){/a=ssrc-group/.test(e)?(n=e.split(" ").pop().trim(),i.push(t)):n&&new RegExp("a=ssrc:"+n).test(e)&&i.push(t-i.length)}),i.forEach(function(e){t.splice(e,1)}),this.joinLines(t)},renameBoundle:function(e){return e.replace(/sdparta_0/g,"audio").replace(/sdparta_1/g,"video").replace(/sdparta_2/g,"data")}}}),define("Core/resources/SDManager.js",function(){}),define("webrtc!js!SBIS3.WebRTC.Core/resources/RTCChecker",["webrtc!js!SBIS3.WebRTC.Core/resources/IceServers","webrtc!js!SBIS3.WebRTC.Manager/resources/WaitingDeferred","webrtc!js!SBIS3.WebRTC.Core/resources/SDManager","SBIS.VideoCall/Environment"],function(e,n,t,i){var o=3e3,r="WebRTC-Support-H264-";return{createTestConnection:function(s){var a,c,u=new n(2.5*o),d=!1,f=function(n){c&&c.close();try{c=new n.RTCPeerConnection(s&&{iceServers:e})}catch(i){return void(!u.isReady()&&u.errback("no internet"))}c.createOffer(function(e){null===localStorage.getItem(r+navigator.userAgent)&&localStorage.setItem(r+navigator.userAgent,t.isSupportVideoCodec(e.sdp,"H264")?!0:""),c.setLocalDescription(e,function(){a=setTimeout(function(){d||u.isReady()?!u.isReady()&&u.errback("gathering timed out"):(d=!0,f(n))},o)},function(e){!u.isReady()&&u.errback(e)}),c.onicecandidate=function(e){e.candidate?!u.isReady()&&u.callback():!u.isReady()&&u.errback("gathering completed without candidates")}},function(e){!u.isReady()&&u.errback(e)},n.processCreateOfferOptions({receiveAudio:!0,receiveVideo:!0}))};return navigator.webkitGetUserMedia||i.browser.mozilla?(require(["webrtc!js!SBIS3.WebRTC.Core/resources/Adapter"],f),u.addBoth(function(e){clearTimeout(a);try{c.close()}catch(n){}return e})):u.callback()},gatherCandidates:function(){window.sessionStorage&&!sessionStorage.getItem("__webrtc__checker")&&this.createTestConnection().addBoth(function(){sessionStorage.setItem("__webrtc__checker",1)})}}}),define("Core/resources/RTCChecker.js",function(){});
//# sourceMappingURL=small.main.min.js.map