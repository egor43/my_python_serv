(function() {
   var availableDict = {"en-US":true,"ru-RU":true},
      langMatch = String(typeof document === 'undefined' ? '' : document.cookie).match(/lang=([A-z-]+)/),
      langName = langMatch ? langMatch[1] : 'ru-RU',
      langModule = 'text!Docview/lang/' + langName + '/' + langName + '.json';
   if (langName in availableDict) {
      define('Docview_localization', ['Core/i18n', langModule], function(i18n, data) {
         if (data){
            i18n.setDict(JSON.parse(data), langModule, langName);
         }
      });
   } else {
      define('Docview_localization', function() {});
   }
})();

define('js!SBIS3.DOCVIEW.signs',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.signs','js!SBIS3.DOCVIEW.Funcs','WS.Data/Entity/Record','SBIS3.CONTROLS/Button/IconButton','css!SBIS3.DOCVIEW.signs','i18n!SBIS3.DOCVIEW.signs','Docview_localization'],function(i,n,t,s){'use strict';var e=i.extend({$protected:{idCmd:'signs',_options:{attachId:null,signs:void 0,count:void 0,disabled:false},_play:function(){var i=this,n=i.getParent(),e=i._options.records[0],o=function(e){var o=new s();o.addField({type:'string',name:'redactionId'}),o.set('redactionId',e),t.showCertificates({filter:o,opener:n,objectName:i._options.mainOptions.objectName,serviceUrl:i._options.mainOptions.serviceUrl});};if(e.get('signs'))o(e.get('redactionId')||e.get('attachId'));else t._getAttachmentInfo(i._options,e).addCallback(function(i){if(i.get('idPreviousRedactionSign'))o(i.get('idPreviousRedactionSign'));});}},_dotTplFn:n,_modifyOptions:function(){var i=e.superclass._modifyOptions.apply(this,arguments),n=i.records&&i.records[0];if('undefined'===typeof i.signs)i.signs=n&&n.get('signs');if(i.signs=Number(i.signs)||0,'undefined'===typeof i.count)i.count=i.signs&&n&&(n.get('CountSigns')||n.get('countSigns'))||0;if(i.count>1&&(1===i.signs||2===i.signs))i.displayCount=String(i.count>99?'99+':i.count);if('boolean'===typeof i.disabled)i.disabled=Boolean(!i.signs&&(n?n.get('idPreviousRedactionSign')||n.get('hasPreviousRedactionSign'):true));return i;},init:function(){e.superclass.init.call(this);var i=this;function n(){i._notify('onCommandActivated',i.idCmd,{records:i._options.records});}if(this.subscribeTo(this,'onClick',n),this.hasChildControlByName('ownSignature'))this.subscribeTo(this.getChildControlByName('ownSignature'),'onActivated',n);}});return e;});
define('js!SBIS3.DOCVIEW.linkActivated',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.linkActivated','js!SBIS3.DOCVIEW.Funcs','Docview_localization'],function(t,i,n){'use strict';return t.extend({$protected:{idCmd:'linkActivated',_play:function(){var t=this._options.records[0],i=n.getLinkUrl(t,this._options.mainOptions);if(i)window.open(i);}},_dotTplFn:i});});
define('js!SBIS3.DOCVIEW.List',['Core/core-clone','Core/core-instance','Core/core-merge','Core/helpers/Hcontrol/isElementVisible','Core/constants','Core/helpers/Function/debounce','SBIS3.CONTROLS/CompoundControl','tmpl!SBIS3.DOCVIEW.List','js!SBIS3.DOCVIEW.DocviewDataSetMixin','tmpl!SBIS3.DOCVIEW.List/templates/big_preview','tmpl!SBIS3.DOCVIEW.List/templates/classic','js!SBIS3.DOCVIEW.CommandsManager','js!SBIS3.DOCVIEW.Command','js!SBIS3.DOCVIEW.LoadVisibilityModeMixin','js!SBIS3.DOCVIEW.Funcs','js!SBIS3.DOCVIEW.CheckEditingMixin','js!SBIS3.DOCVIEW.UpdaterMixin','js!SBIS3.DOCVIEW.HistoryMonitor','SBIS3.CONTROLS/ComponentBinder','WS.Data/Entity/Model','Core/Serializer','WS.Data/Collection/RecordSet','js!SBIS3.DOCVIEW.DocviewModel','WS.Data/Di','Core/EventBus','Core/Indicator','Core/Deferred','Core/ParallelDeferred','js!SBIS3.DOCVIEW.List.DiskClassicColumns','WS.Data/Chain','SBIS3.CONTROLS/Tree/CompositeView','Core/CommandDispatcher','SBIS3.CONTROLS/BreadCrumbs','SBIS3.CONTROLS/Button/BackButton','SBIS3.CONTROLS/Tree/CompositeView','SBIS3.CONTROLS/Link','SBIS3.CONTROLS/ScrollContainer','css!SBIS3.DOCVIEW.List','css!SBIS3.DOCVIEW.List/resources/diskClassic/DiskClassic','css!SBIS3.DOCVIEW.List/resources/bigPreview/BigPreview','css!SBIS3.DOCVIEW.List/resources/classic/Classic','i18n!SBIS3.DOCVIEW.List','js!SBIS3.DOCVIEW.linkActivated','Docview_localization'],function(e,t,i,s,o,n,r,a,l,d,c,h,u,f,m,_,p,g,v,C,w,I,b,y,S,O,M,T,k,B,R,D){'use strict';var A=30,E=8,F=k.getColumnsExcept(['folder','daysLeft']);function V(e,t){var i,s,o;if(e.getCount()!==t.length)return false;for(o=0;o<t.length;o++)if(i=e.at(o),s=t[o],i.get('name')!==s.name||i.get('isMainAction')!==s.isMainAction)return false;return true;}function P(e,t){var i=[],s=t,o;while((o=s.get('folder'))&&(s=e.getRecordById(o)))i.unshift(s);return i;}var x=[{name:'attachId',type:'string'},{name:'folder',type:'string'},{name:'title',type:'string'}];function H(e,t){var i=new C({adapter:'adapter.sbis',format:x});return i.set({attachId:e.get('attachId')+(t||''),folder:e.get('folder'),title:e.get('title')}),i;}function W(e){var t=e.visibilityMode&&e.visibilityMode.defaultMode,i={'min-height':'','max-height':'none','overflow-y':''};if('classic'===t&&e.countDocWithoutScroll)i['max-height']=e.countDocWithoutScroll*A+'px',i['overflow-y']=e.wrapInScrollContainer?'':'auto';else if('bigPreview'===t)i['min-height']=e.previewHeight+'px';return i;}function N(e){var t='';for(var i in e)if(e.hasOwnProperty(i)&&''!==e[i])t+=i+': '+e[i]+'; ';return t;}function L(e,t){var i,s,o,n;if(e instanceof I)return e;if('string'===typeof e)s=new w(),i=(o=JSON.parse(e,s.deserialize)).getRawData(true);else if(e instanceof Object)i=e;if(n={rawData:i,adapter:'adapter.sbis',idProperty:'attachId'},t)n.model=t;return new I(n);}function z(e){return function t(s){var o=e.mainOptions,n=e.listOptions,r={serviceUrl:o.serviceUrl,objectName:o.objectName,previewWidth:n.previewWidth,previewHeight:n.previewHeight,calcMargin:n.calcMargin,_isAuth:o._isAuth};return new b(i(s,r));};}var j={};function K(e,t){if('undefined'===typeof window||!t)return z(e);var i='docview.model.'+t;if(!y.isRegistered(i))y.register(i,z(e)),j[i]=false;return i;}function U(e,i,s){if('table'==i.viewMode||s)return i._getRecordsForRedrawTree.call(this,e,i);else{var o={folders:[],leafs:[]};return e.each(function(e,s,n){if(!t.instanceOfModule(e,'WS.Data/Display/GroupItem'))o.leafs.push(e),i._hideEmpty=true;}),o;}}var G=['signDocument','upload','copyToBuffer','edit','saveToPdf','print','imageEdit','xmlEdit'],q=r.extend([h,l,f,_,p],{_dotTplFn:a,$protected:{_options:{mainOptions:{objectName:'',serviceUrl:'/',serviceBLName:'ОсновнойСервис',ctxLinkId:null,fixId:null,filter:null,useOnlyCtx:true,ctxLinkList:'record/РП.Документ/СписокВложений',_isAuth:true,_isOldAuth:false,redactionWindow:{renderPhotos:true},viewModel:null,commands:{deleteDoc:true,directLink:true,copyToBuffer:true,addPage:false,editPdf:false,edit:true,fullScreen:true,print:true,saveToPdf:true,upload:true,editGroup:true,zoomMinus:true,zoomPlus:true,links:true,redactions:true,move:true},commandsOptions:{imageEdit:{deleteRedactionsOnSave:false}},multiPage:true,isCreate:false,directLinkRouting:'disk',userCommands:[],isDisk:true},viewOptions:{showStampFED:false},listOptions:{activableByClick:false,allowEmptySelection:false,columns:F,displayField:'title',emptyHTML:'',groupBy:{},infiniteScroll:true,includedTemplates:{subtitle:null},items:null,itemsDragNDrop:true,multiselect:true,pageSize:20,parentProperty:'folder',root:null,showPaging:false,autoQuery:true,calcMargin:true,countDocWithoutScroll:5,defaultRecordPK:null,doNotRequestPreview:false,enableExpand:true,goToFolder:true,hasHierarchy:true,hideBreadCrumbs:false,hideEmptyBackButton:true,maxTileCount:0,maxTileRows:0,needMoreButton:false,pathPlaceholderTemplate:null,previewHeight:150,previewWidth:200,saveState:false,stateKey:null,serializedItems:'',stickyPath:false,visibilityMode:{savedModeField:null,autoSelect:false,setFromCookie:false,defaultMode:'classic',changedId:'default',folderAsPreview:false,hasSeparator:true,withoutMarker:false},wrapInScrollContainer:false},_gotozip:false,_privateMegaFixOption:false,_processAutoClick:false,activableByClick:false,_dontHandleDocumentChangedChannels:false},_visibilityMode:{bigpreviewTpl:d,classicTpl:c},_archiveStack:[],_isAutoClick:false,_typeCmd:'list',itemsActions:[],rowOptionsForRow:{},oldRecordSet:null,_currentSelection:null,_initedDataSet:false,_isDataLoaded:false,savedParams:{},DEFAULT_RECORDS_COUNT:20,_backButton:null,_breadCrumbs:null,_attachments:null,_lockedItems:{},_$path:null,_$listContainer:null,_lastWidth:0,_historyMonitor:void 0},_modifyOptions:function(){var e=q.superclass._modifyOptions.apply(this,arguments),t=e.listOptions;if(!e.mainOptions.modelAlias&&t.serializedItems&&'undefined'!==typeof window)e._randomAlias=K(e,String(Math.random()).substring(2));if(t.items=q.deserializeItemsWithModel(e,e.id||this._getAliasId(e)),!t.visibilityMode)t.visibilityMode={};if(!t.visibilityMode.defaultMode)t.visibilityMode.defaultMode='classic';switch(t.visibilityMode.defaultMode){case'bigPreview':t.itemTpl=d;break;case'diskClassic':if(!t.columns)t.columns=F;break;default:t.itemTpl=c;}var i=W(t);if(t.items&&t.items.getCount()>1&&t.maxTileRows>0)if(!this._setMoreTileCounter(t.items,t.maxTileCount))i['max-height']=t.maxTileRows*t.previewHeight+E-E/2+'px',i.overflow='hidden';return e._containerStyle=N(i),e._hidePath=!t.hideBreadCrumbs&&t.hideEmptyBackButton&&null==t.root,e;},_setMoreTileCounter:function(e,t){var i=e.getCount(),s;if('undefined'===typeof window&&t>0&&i>t){if(s=e.at(t-1),!s.has('moreTileCount'))e.addField({name:'moreTileCount',type:'integer'},void 0,void 0);return s.set('moreTileCount',i-t),true;}return false;},_updateHoveredItem:function(e){if(this._hasHoveredItem())this.getHoveredItem().container.removeClass('controls-ListView__hoveredItem');if(this._options.itemsHover&&!e.hasClass('controls-EditAtPlace')&&!e.hasClass('docview-list__item_more'))e.addClass('controls-ListView__hoveredItem');this._hoveredItem=this._getElementData(e),this._notifyOnChangeHoveredItem();},_applyNewVisibilityMode:function(){if(this._setTreeViewTemplate(this.getVisibilityMode()),this._setMaxHeight(),this.viewerRecordSet)this.getTreeView().redraw();this.reloadItemInstances();},setHasHierarchy:function(e){if(!this._options.listOptions.hideBreadCrumbs)this._options.listOptions.hasHierarchy=!!e,this.getChildControlByName('MyBackButton').toggle(this._options.listOptions.hasHierarchy);},_hideEmptyBackButton:function(){if(!this._options.listOptions.hideBreadCrumbs&&this._options.listOptions.hideEmptyBackButton)this._$path.toggleClass('ws-hidden',!this._backButton||!this._backButton.getCaption());},_setTreeViewTemplate:function(e){var t=this.getTreeView(),i={bigPreview:{listTemplate:this._visibilityMode.bigpreviewTpl,withoutMarker:true,viewMode:'list',cssClass:'docview-list_mode-bigpreview'},diskClassic:{columns:this._options.listOptions.columns,withoutMarker:false,viewMode:'table',cssClass:'docview-list_mode-diskclassic'},classic:{listTemplate:this._visibilityMode.classicTpl,withoutMarker:false,viewMode:'list',cssClass:'docview-list_mode-classic'}}[e]||e['classic'],s=this._options.listOptions.visibilityMode&&'boolean'===typeof this._options.listOptions.visibilityMode.withoutMarker?this._options.listOptions.visibilityMode.withoutMarker:i.withoutMarker;if(i.listTemplate)t._options.listTpl=t._options.listFolderTpl=i.listTemplate;else if(i.columns){if('function'===typeof i.columns)i.columns=[{cellTemplate:i.columns}];t._options.columns=i.columns;}if(t.getContainer().toggleClass('controls-ListView__withoutMarker',s),t.setViewMode(i.viewMode),this.getContainer().removeClass('docview-list_mode-bigpreview docview-list_mode-diskclassic docview-list_mode-classic').addClass(i.cssClass),o.browser.IEVersion>=15){var n=this._$path.find('.docview-list__path-placeholder');n.css('z-index','2'),setTimeout(function(){n.css('z-index','');},0);}},_getCommandsForAttachment:function(t){var i=this.getCommands(t),s='bigPreview'===this.getVisibilityMode(),o;i=m._addSubmenuItemsToCommandsArray(i);for(var n=0;n<i.length;n++){if(o=i[n],!o.onActivated)this._addActivateHandlerForItemsAction(o);if(o.isMainAction&&'PDF'!==this._options.mainOptions.objectName&&s)i[n]=e(o),i[n].isMainAction=false;}return i=[].concat(i),i=this.sort(i,'list'),i;},_addActivateHandlerForItemsAction:function(e){var t=this,i=e.cmdClass?'':e.parent;e.onActivated=function(s,o,n){var r;if(!(n.get('link')&&n.get('ShareId'))||-1===G.indexOf(e.name))a();else{if('edit'===e.name)r=window.open('about:blank','_blank');m.getFileInfo(n,t._options.mainOptions).addCallbacks(a,function(e){n._options.noRights=e.message.indexOf('Недостаточно прав')>-1,n._options.isError=true,requirejs(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(e){e.showNotification({caption:rk('Недостаточно прав для выполнения действия'),status:'error'}),t.redrawItemDocview(n.get('attachId'));});});}function a(){if(i)t.startCommand(i,[n],{item:e.name,window:r});else t.startCommand(e.name,[n],{window:r});}};},_setItemActionsForAttachment:function(e,t){if(!t)t=this._getCommandsForAttachment(e);this.rowOptionsForRow[e.get('attachId')]=t;},_addItemsInstances:function(e){for(var t=this,i=e.getCount(),s=[],o,n,r=function(e){return s.some(function(t){return e.name===t.name;});},a=false,l=false,d=0;d<i;d++){if(o=e.at(d),n=this._getCommandsForAttachment(o),n.forEach(function(e){if(!r(e))s.push(e);if(!a&&'xmlEdit'===e.name)a=true;}),!l&&3===o.get('Type')&&!o.get('versionForm'))l=true;this._setItemActionsForAttachment(o,n);}if(!a&&l)this._addActivateHandlerForItemsAction(this._commandsSetting.xmlEdit),s.push(this._commandsSetting.xmlEdit);s=this._filterMoveCommand(s,e),s=this.sort(s,'list'),setTimeout(function(){if(t.isDestroyed())return;var e=t.getTreeView(),i=e._itemsToolbar&&e.getItemsActions(),o=i&&i.getTarget&&i.getTarget(),n=i&&i._itemActionsMenu,r=n&&n.getItemsInstances();if(o&&n&&!n._container.hasClass('ws-hidden')&&r)t._showHideItemsInstances(o.record,r);else if(!i||!V(i.getItems(),s)){if(t._ensureFirstItemHasNoSubitems(s),'classic'===t.getVisibilityMode())t._ensureListHasThreeMainActions(s);e.setItemsActions(s);}},10);},_ensureFirstItemHasNoSubitems:function(e){for(var t=0;t<e.length;t++)if(!e[t].items){if(t>0)e.unshift(e.splice(t,1)[0]);return;}},_ensureListHasThreeMainActions:function(t){var i=0,s=0;t.forEach(function(e){e.isMainAction&&i++;});while(i<3&&s<t.length){if(!t[s].isMainAction)t[s]=e(t[s]),t[s].isMainAction=true,i++;s++;}},reloadItemInstances:function(){if(this.viewerRecordSet)this._addItemsInstances(this.viewerRecordSet);},setUserCommands:function(t){this._options.mainOptions.userCommands=e(t),this._options.mainOptions.userCommandsCopy=e(t),this.reloadItemInstances();},_containsOnlyImages:function(e){var t=false;if(e)for(var i=0;i<e.getCount();i++){var s=e.at(i),o=s.get('fileName');if(s.get('folder@')||!o)continue;t=true;var n=m.getFileExtension(o);if(n&&!m._isFileExtensionIn(n,this.imageExts))return false;}return t;},_getItemsContainerWidth:function(){return this.getContainer().find('.controls-CompositeView__itemsContainer').width()||0;},_onAfterVisibilityChange:function(e,t){if((this._options.listOptions.calcMargin||this._options.listOptions.maxTileRows)&&t&&this._isInvisible())if(!this._lastWidth)this._calcMargin();else this._setInvisibility(false);},_isInvisible:function(){return this.getContainer().hasClass('docview-list_invisible');},_setInvisibility:function(e){this.getContainer().toggleClass('docview-list_invisible',e);},_calcTileWidth:function(e,t){if('number'!==typeof e){if(!this._options.listOptions.calcMargin)return Number(this._options.listOptions.previewWidth)+E;return t.outerWidth(true)||0;}return e;},_setMoreTile:function(e,t,i){var s=this._options.listOptions.maxTileRows,o,n,r,a;if('bigPreview'!==this.getVisibilityMode()||!s||0===e||0===t)return;if(o=this.getContainer().find('.controls-CompositeView__itemsContainer'),n=o.find('.controls-ListView__item'),'number'!==typeof t)i=this._calcTileWidth(i,n.eq(0)),e='number'===typeof e?e:o.width()||0,t=Math.floor(e/ i);if(!e)return void this._$listContainer.css({maxHeight:s*(Number(this._options.listOptions.previewHeight)+E)-E/2+'px',overflow:'hidden'});if(a=s*t-1,r=o.find('.docview-list__item_more').eq(0),this._$listContainer.css({maxHeight:'',overflow:''}),a>=n.length-1)return void r.removeClass('docview-list__item_more');if(n.eq(a).addClass('docview-list__item_more').find('.docview-list__more-overlay').attr('data-more','+'+(n.length-a-1)),r.length&&r.get(0)!==n.get(a))r.removeClass('docview-list__item_more');},_calcMargin:function(e){if('bigPreview'!==this.getVisibilityMode()||!this._options.listOptions.calcMargin){if('number'!==typeof e||e>0&&e!==this._lastWidth)this._lastWidth=e,this._setMoreTile();return void this._setInvisibility(false);}if('number'!==typeof e)e=this._getItemsContainerWidth();if(!e)this._setInvisibility(true);if(0===e&&!this._lastWidth)return;if(e>0)this._lastWidth=e;var t=this.getContainer(),i=Number(this._options.listOptions.previewWidth),s=Number(this._options.listOptions.previewHeight),o=i+E,n=Math.floor(e/o),r=e/n-o-1,a=r*s/ i,l=this._currentPreviewWidth=i+r,d=this._currentPreviewHeight=s+a,c=t.find('.dv-bigpreview-item .dv-bigpreview-vis, .dv-bigpreview-item .dv-folder-background, .dv-bigpreview-item .dv-bigpreview-title, .dv-icon.icon-24.dv-forEmptyLink-icon'),h=t.find('.dv-bigpreview-item .dv-bigpreview-vis, .dv-icon.icon-24.dv-forEmptyLink-icon, .dv-folder-as-preview .dv-folder-background');c.css('width',l),h.css('height',d),this._lastWidth=this._getItemsContainerWidth(),this._setMoreTile({tilesInRow:n,tileWidth:l+E}),this._setInvisibility(false);},setProperties:function(e){q.superclass.setProperties.call(this,e),this._setProperties(e);},_setProperties:function(e){var t=this.getTreeView(),i=this._options.mainOptions.useOnlyCtx||this._options.listOptions.autoQuery||this.isInitialized();if(this._options.mainOptions.objectName&&!this._initedDataSet&&i)this._initDataSet(t,true);if(e.listOptions&&e.listOptions.pageSize&&!this._options.listOptions.needMoreButton&&t._options.pageSize!=e.listOptions.pageSize)t.setPageSize(e.listOptions.pageSize,true);if(e.mainOptions){if(e.mainOptions.filter){var s=true,n=t.getFilter();if(Object.keys(e.mainOptions.filter).forEach(function(t){var i=e.mainOptions.filter[t];if('Path'!==t&&('object'===typeof i||n[t]!==i))s=false;}),!s)this._moreButtonCount=null;if(s||!i)t.setFilter(e.mainOptions.filter,true);else t.reload(e.mainOptions.filter);if(!this._initedDataSet&&i)this._initDataSet(t);}if(e.mainOptions.commands&&this.viewerRecordSet)this._addItemsInstances(this.viewerRecordSet);if(e.mainOptions._isAuth&&e.mainOptions._isOldAuth!==e.mainOptions._isAuth)t.redraw();}if(e.listOptions){if(e.listOptions.itemsDragNDrop!=t.getItemsDragNDrop())t.setItemsDragNDrop(e.listOptions.itemsDragNDrop);var r=t._options.root,a=e.listOptions.root;if(a||a!==r)if(t._options.root=a,r!==a)t.setCurrentRoot(a);if(e.listOptions.defaultRecordPK)if(t.getSelectedKey()!==e.listOptions.defaultRecordPK)this._currentSelection=null;else{var l=this._getItemElement(e.listOptions.defaultRecordPK).offset();if(l)o.$body.scrollTop(l.top-400);}}},$constructor:function(){if(this._options.mainOptions.useOnlyCtx)this._options.listOptions.infiniteScroll=null;if(this._publish('onDrawItems','onMergeFromContext','onBeforeChangeHoverItem','onAfterChangeHoverItem'),this._options.mainOptions._isOldAuth=this._options.mainOptions._isAuth,this._options.listOptions.saveState)this._historyMonitor=new g({list:this});},_getParentFolder:function(e){var t=e.getOwner(),i=e.get('folder');return i&&t&&t.getRecordById(i)||void 0;},_onBeginMove:function(e,t,i,s){if(e.setResult('Custom'),'on'!==s)return;if(i&&!i.get('folder@'))if(i=this._getParentFolder(i),!i)return;var o=this,n=this._getSbisService(),r=i&&i.get('attachId'),a,l,d,c;if(l=t.filter(function(e){return e&&e.get('folder')!==r&&e.get('attachId')!==r;}),!l.length)return;return a=new C({adapter:'adapter.sbis',format:[{name:'folder',type:'string'}]}),a.set('folder',r),d=l.map(function(e){var t=e.get('attachId');return n.createDependent().addCallback(function(e){return e.call('MoveAttachment',{'ИдО':t,info:a});}).addCallback(function(e){if(false!==e.getScalar())o.deleteItem(t);});}),c=setTimeout(function(){O.setMessage(rk('Подождите')+'...');},500),new T({steps:d}).done().getResult().addCallback(function(){clearTimeout(c),o._notify('onFinishCommand','moveDocuments',{from:l,to:i,records:l}),O.hide();}).addErrback(function(e){clearTimeout(c),o._notify('onErrorCommand','moveDocuments',e),O.hide(),m.showErrorNotification({message:rk('Не удалось выполнить'),details:e.message});});},_getCurrentPathToZip:function(e,t){var i=e&&e.getMetaData(),s=(i&&i.path&&B(i.path).toArray()||[]).concat(P(e,t)).map(function(e){return H(e);}).concat(H(t,'_ZIP')),o=new I({adapter:'adapter.sbis',format:x});return o.append(s),o;},saveFedDocument:function(){var e=this.getParent();if(t.instanceOfModule(e,'SBIS3.DOCVIEW.FullViewer')){var i=e.getView();if(i){var s=i.savedRec;if(i._activeControl&&s&&s.get('versionForm'))return i.saveFedDocument();}}return new M().callback();},_fillInlineRedactionsControls:function(e){var t=this.getParent(),i=e?'div[data-id="'+e+'"]':'.dv-classic-item__hasRedactions',s=this.getContainer().find(i);if(s.length)require(['js!SBIS3.DOCVIEW.redactionsInline'],function(e){s.each(function(i,s){if($(s).find('.dv-classic-redactions').length)return;new e({element:$('<div></div>').appendTo(s),viewer:t,opener:t,linkedContext:t.getLinkedContext(),attachId:$(s).attr('data-id')});});});},_resizeHead:function(){var e=this._$path,t=this._breadCrumbs?this._breadCrumbs.getItems():null,i=t?t.getCount():0,o=this._backButton?this._backButton.getCaption():null;if(this._hideEmptyBackButton(),this._options.listOptions.hideBreadCrumbs||!this._backButton||!this._breadCrumbs||!o)return;if(s(e)&&(i>0||o)){var n=this._backButton.getContainer(),r=this._breadCrumbs.getContainer(),a=e.width();if(n.css('max-width',''),0===i)r.addClass('ws-hidden');else r.removeClass('ws-hidden'),r.width('10000px'),this._breadCrumbs._redraw(),r.width('auto');var l=n.outerWidth(true),d=i>0?r.outerWidth(true):0,c=l-n.width(),h=d-r.width(),u=a-(Number(e.find('.docview-list__path-placeholder').width())||8),f=u/2,m,_;if(e.find('.docview-list__path-navigation').width(u),l>f)if(d>f)m=f-c,_=f-h;else m=u-d-c-1;else _=u-l-h-1;if(m)n.css('max-width',Math.floor(m));if(_)r.width(Math.floor(_)),this._breadCrumbs._redraw();S.channel('navigation').notify('onAccTransform');}},_getSbisService:function(){var e={contract:this._options.mainOptions.objectName,address:this._options.mainOptions.serviceUrl+'service/'},t=new M();return require(['WS.Data/Source/SbisService'],function(i){t.callback(new i({endpoint:e}));},function(e){t.errback(e);}),t;},_openLinkInNewWindow:function(e){var t=window.open('about:blank','_blank');this._getSbisService().addCallback(function(t){return t.call('GetLinkInfo',{Id:e});}).addCallback(function(e){t.location.href=e.getRow().get('url');}).addErrback(function(){t.close();});},_updateModelAlias:function(){var e=this.getTreeView()&&this.getTreeView().getItems(),t=e&&e.getModel();if(e&&t!==this._options.mainOptions.modelAlias){if(this._isDocviewModels(e))this._options._randomAlias=t;j[this._options._randomAlias]=true;}},init:function(){q.superclass.init.call(this);var i=this,s=this.getTreeView(),n=this._options.mainOptions,r=this._options.listOptions;if(!r.hasHierarchy)r.hideBreadCrumbs=true;if(this._updateModelAlias(),r.maxTileRows>0)s._updateHoveredItem=this._updateHoveredItem;if('folder@'!==s.getNodeProperty())s.setNodeProperty('folder@');if(this._applyFolderAsPreview(r.visibilityMode&&r.visibilityMode.folderAsPreview),this._$path=this.getContainer().find('.docview-list__path'),this._$listContainer=this.getContainer().find('.docview-list__container'),n.filter)s.setFilter(n.filter);if(n.userCommands=e(n.userCommands),n.userCommandsCopy=e(n.userCommands),r.root)if(s.setCurrentRoot(r.root),!s._options.root)s._options.root=r.root;if(!r.hideBreadCrumbs){this._breadCrumbs=this.getChildControlByName('MyBreadCrumbs'),this._backButton=this.getChildControlByName('MyBackButton'),this._componentBinder=new v({view:s,backButton:this._backButton,breadCrumbs:this._breadCrumbs}),this._componentBinder.bindBreadCrumbs();var a=function e(){i._clickedFolderId='back';};this.subscribeTo(this._backButton,'onActivated',a),this.subscribeTo(this._backButton,'onArrowActivated',a),this._breadCrumbs._onResizeHandler=function(){},this.subscribeTo(this._breadCrumbs,'onItemClick',function(e,t){i._clickedFolderId=t;}),this.subscribeTo(s,'onSetRoot',function(){var e=i._$listContainer.css('width','100%');if(setTimeout(function(){e.css('width','');},0),i._resizeHead(),'string'===typeof this._previousRoot)this._previousRoot=this._previousRoot.replace(/_ZIP$/,'');});}this._resizeHead(),s.subscribe('onItemClick',function(e,t,s,o){e.setResult(i._openItem(s,o));}),this.subscribeTo(S.channel('docview.commandsEvents'),'onFinishCommand',function(e,t){if(!i.viewerRecordSet||!i.viewerRecordSet.getRecordById(t.params.records[0].get('attachId')))return;if('signDocument'===t.commandName&&t.rec)i.redrawItemDocview(t.rec.get('attachId'),t.rec);i._notify('onFinishCommand',t.commandName,t.params);}),s.subscribe('onBeginMove',this._onBeginMove.bind(this)),this.subscribe('onChangeCommandsSetting',function(){if(i.viewerRecordSet)i._addItemsInstances(i.viewerRecordSet);}),s.subscribe('onSelectedItemChange',function(e,t){if(i._doNotHandleSelectedItemsChange||!i.viewerRecordSet)return;var s=i.viewerRecordSet.getRecordById(t);if(!s)return;if(i._scrollListToSelectedItem(),'bigPreview'!==i.getVisibilityMode()&&i._options._processAutoClick&&!s.isRequired()&&t==this.getSelectedKey())i.startCommand('fullScreen',[s],{inline:true});});var l=function(e){if(e instanceof u&&e.getParent()===s&&(!e._eventBusChannel.getEventHandlers('onCommandActivated')||!e._eventBusChannel.getEventHandlers('onCommandActivated').length))e.subscribe('onCommandActivated',function(t,s,o){i.startCommand(s,[i.viewerRecordSet.getRecordById(e._options.attachId)],o);});};if(this.subscribeTo(S.channel('luntik'),'onInit',function(e,t){l(t);}),setTimeout(function(){if(!i.isDestroyed())(i.getChildControls()||[]).forEach(function(e){l(e);});},0),s._getItemsToolbar().subscribe('onShowItemActionsMenu',this._onShowItemActionsMenu.bind(this)),s.subscribe('onDrawItems',function e(){if(i._doNotHandleDrawItems)return;var t=!this.getItems()||0===this.getItems().getCount();if(i._$listContainer.toggleClass('docview-list__container_empty',t),i._updateLockedItems(),i.saveFedDocument(),!i._drawItemsWasCalledAfterDataLoad)i._drawItemsWasCalledAfterDataLoad=true,this.setSelectedKey(this.getSelectedKey()),i._setDefaultCursor();if(i._calcMargin(),i._notify('onDrawItems'),'classic'!==i.getVisibilityMode())i._setJustInCasePreviewUpdater();}),r.autoQuery)this._initDataSet(s);if(s.subscribe('onDataLoad',function e(t,o){i._drawItemsWasCalledAfterDataLoad=false,i._$listContainer.toggleClass('docview-list__container_empty',0===o.getCount()),i._hideMoreButton(o);try{if(!i._presetMode)i._presetMode=i.getVisibilityMode();var n=i.getParent();if('cdReestr'===n.getName()||'edoFileViewer'===n.getName()){var r=t._target.getCurrentRoot();if(r)i._clickedFolderId=r;if('edoFileViewer'===n.getName())i._clickedFolderId=n._options.mainOptions.objectName+'_'+n._options.mainOptions.fixId;i._saveDocumentId(i._clickedFolderId);var a='';try{a=i._getSavedVisibilityModeFromCookie(i._clickedFolderId);}catch(e){}if(i._options.listOptions.visibilityMode.autoSelect&&i._containsOnlyImages(o)){if(!a&&i._setVisibilityMode('bigPreview',i._clickedFolderId))i._saveVisibilityMode('bigPreview',false,i._clickedFolderId);}else if(!a&&i._presetMode&&i._options.listOptions.visibilityMode.defaultMode!==i._presetMode)i._options.listOptions.visibilityMode.defaultMode=i._presetMode,i._saveVisibilityMode(i._options.listOptions.visibilityMode.defaultMode,false,i._clickedFolderId);else if(a&&i._options.listOptions.visibilityMode.defaultMode!==a)i._options.listOptions.visibilityMode.defaultMode=a,i._savedMode=a,i._saveVisibilityMode(i._savedMode,false,i._clickedFolderId,!i._setVisibilityMode(i._savedMode,i._clickedFolderId));}}catch(e){}setTimeout(function(){if(i.isDestroyed())return;if('cdReestr'!==i.getParent().getName()&&'edoFileViewer'!==i.getParent().getName())if(i._options.listOptions.visibilityMode.autoSelect&&i._containsOnlyImages(o)){if(i._setVisibilityMode('bigPreview'))i._saveVisibilityMode('bigPreview');}else if(i._setVisibilityMode(i._savedMode))i._saveVisibilityMode(i._savedMode);for(var e=s.getItems(),t=0;t<e.getCount();t++)s.getContext().setValue('attachId_'+e.at(t).get('attachId'),e.at(t));},1);}),this._calcMargin(),s.subscribe('onKeyPressed',function(e,t){if(i.isEnabled()&&t.keyCode===o.key.del){var n=B(s.getSelectedItems()).toArray();if(0===n.length)n=[s.getHoveredItem().record];if(!n[0])return void e.setResult(false);if(n[0].get('Deleted'))i.startCommand('deletePermanentlyDoc',n);else i.startCommand('deleteDoc',n);}}),r.calcMargin||r.maxTileRows||!r.hideBreadCrumbs)this._subscribeOnResize();if(s.subscribe('onChangeHoveredItem',function(e,t){if(t&&s)e.setResult(i._notify('onChangeHoveredItem',t));}),this.subscribe('onChangeHoveredItem',function(e,t){if(t.key)i._onChangeHoverItem(t);}),r.needMoreButton)this.getChildControlByName('moreButton').subscribe('onActivated',function(){i._moreButtonCount=(i._moreButtonCount||1)+1,i.mergeFromBL({offset:i.viewerRecordSet.getCount(),recordCount:i._options.listOptions.pageSize||i.DEFAULT_RECORDS_COUNT,append:true});}),this.subscribeTo(s,'onItemsReady',function(){i._moreButtonCount=null;}),this.subscribeTo(this,'onMergeFromBL',function(){i._hideMoreButton();});if(n.useOnlyCtx&&n.ctxLinkList&&r.serializedItems&&!this._getContextRecordSet()&&s.getItems())this.getLinkedContext().setValue(n.ctxLinkList,s.getItems());if(this._options.buildMarkupWithContext)this._setProperties(this._options);if(!this._dataController)this._dataController=s;if(this.subscribeTo(this,'onFinishCommand',this._onFinishCommand.bind(this)),this.subscribeTo(this,'onStartCommand',this._onStartCommand.bind(this)),this.subscribe('onProcessCommand',this._onProcessCommand),!this._options._dontHandleDocumentChangedChannels){var d=this._onDocumentHasChanged.bind(this);this.subscribeTo(S.serverChannel('wopi.documentHasChanged'),'onMessage',d),this.subscribeTo(S.serverChannel('webdav.documentHasChanged'),'onMessage',d);}D.declareCommand(this,'xmlEdit',function(e){if('bigPreview'===this.getVisibilityMode()||!t.instanceOfModule(this.getParent(),'SBIS3.DOCVIEW.FullViewer'))return this.startCommand('fullScreen',e,{mainOptions:this._options.mainOptions,listOptions:this._options.listOptions,viewOptions:{mode:'edit'}}),true;}),this.subscribeTo(this,'onAfterVisibilityChange',this._onAfterVisibilityChange);},destroy:function(){if(q.superclass.destroy.call(this),this._componentBinder&&!this._componentBinder.isDestroyed())this._componentBinder.destroy();if(this._attachments=this._componentBinder=this._backButton=this._breadCrumbs=this._$path=null,this._$listContainer=null,this._historyMonitor)this._historyMonitor.destroy(),this._historyMonitor=null;if(this._windowHandlers)o.$win.off(this._windowHandlers);if(this._options._randomAlias)delete j[this._options._randomAlias];setTimeout(function(){Object.keys(j).forEach(function(e){if(!j[e])y.unregister(e),delete j[e];});});},_onDocumentHasChanged:function(e,t){var i=this,s=this.viewerRecordSet&&this.viewerRecordSet.getRecordById(t.fileId);if(!s)return;m._getAttachmentInfo(this._options,s).addCallback(function(e){if((null==s.get('redactionId')||s.get('redactionId')===e.get('redactionId'))&&s.get('hash')!==e.get('hash'))i.redrawItemDocview(t.fileId,e);});},_onResize:function(){var e=this._getItemsContainerWidth();if(e!==this._lastWidth)this._calcMargin(e);},_onResizeWindow:function(){if(this.isDestroyed())return;if(this._resizeHead(),this._options.listOptions.calcMargin||this._options.listOptions.maxTileRows)this._onResize();},_subscribeOnResize:function(){var e=this._onResizeWindow.bind(this);if(this._windowHandlers={resize:this._options.listOptions.maxTileRows>0?e:n(this._onResizeWindow,50).bind(this),orientationchange:e},o.$win.on(this._windowHandlers),this._options.listOptions.calcMargin||this._options.listOptions.maxTileRows)this.subscribeTo(this,'onResize',this._onResize);},_openItem:function(e,t){var i=this,s=e.get('attachId');if(e.isRequired()){if(i.isEnabled()){if($.cookie('isWebView'))return void require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(e){e.showMessageDialog({message:rk('Вы используете мобильную версию браузера')+'.',status:'error',opener:i});});i.startCommand('scanFromFile',[e]);}return;}if(e.get('folder@')&&i._options.mainOptions.isDisk&&!i._options.listOptions.goToFolder)return i._openLinkInNewWindow(s),false;i._clickedFolderId=s;var n=m.getFileExtension(e.get('fileName')),r=$(t).hasClass('ws-listView-flkErrors'),a=null,l='bigPreview'===i.getVisibilityMode(),d='url'===n;if(i.getParent()&&i.getParent().hasChildControlByName('view')){if(a=i.getParent().getChildControlByName('view'),a.savedRec)if(a.savedRec.get('attachId')===s&&!l){if(!m._isFileExtensionIn(n,i.archiveExts)&&!d){if(r)i.startCommand('flkErrors',[e]);return;}}else i.saveFedDocument().addCallback(function(){i.getParent().setMode('view');});var c=function(){this._activeControl.open();};if(r)a.once('onShowFile',c);}if(i._currentSelection=e,i._isAutoClick=false,o.browser.isMobilePlatform)setTimeout(function(){i._getItemElement(s).focus();},1);if(d&&(l||!t||$(t).hasClass('dv-title-text_link')))return i.startCommand('linkActivated',[e],{target:t}),false;else if(m._isFileExtensionIn(n,i.archiveExts)&&!i._isAutoClick&&i._options._gotozip&&!e.isEncrypted())if(e.get('Deleted')||e.isEncrypted())return;else if(e.get('size')>100*1024*1024||e._options.isError)i.startCommand('fullScreen',[e],{inline:true});else return i._goToZip(e),false;else if(!e.get('folder@'))i.startCommand('fullScreen',[e],{inline:true});},_onShowItemActionsMenu:function(){var e=this.getTreeView(),t=e.getSelectedKey(),i=this.viewerRecordSet.getRecordById(t);if(3===i.get('Type')&&!i.get('versionForm')&&!a(this.rowOptionsForRow[t],'xmlEdit')){var s=this,o=e._getItemsToolbar(),n=(o&&o.getItemsActions())._itemActionsMenu,r=n.getContainer();if(n)r.css('opacity',0),m._getAttachmentInfo(this._options,i).addBoth(function(e){if(!(e instanceof Error))if(s._setItemActionsForAttachment(e),a(s.rowOptionsForRow[t],'xmlEdit'))n.redraw(),s._showHideItemsInstances(i,n.getItemsInstances());r.css('opacity','');});}function a(e,t){return(e||[]).some(function(e){return e.name===t;});}},_onProcessCommand:function(e,t,i){if('redactions'===t)this.redrawItemDocview(i.mainRecord.getId(),i.records[0]);},_onStartCommand:function(e,t,i){if('decrypt'===t)e.setResult(this._notify('onStartDecrypt',i));if('imageEdit'===t)this._onStartImageEditCommand(e,t,i);},_onFinishCommand:function(e,i,s){var o=this,n=s.records[0];if('imageEdit'===i)this._onFinishImageEditCommand(s.records,s.finishParams);else if(['signDocument','encrypt','decrypt'].indexOf(i)>-1){if(!t.instanceOfModule(this.getParent(),'SBIS3.DOCVIEW.FullViewer'))s.records.forEach(function(e){if(!e.isFolder())m._getAttachmentInfo(o._options,e).addCallback(function(t){var i=e.get('signs'),s=t.get('signs');if(true===s&&('number'===typeof i||!i)){if(!i)s=2;else if(1===i)s=3;else if(2===i||3===i)s=i;t.removeField('signs'),t.addField({name:'signs',type:'integer'},void 0,s);}t.set('canEdit',e.get('canEdit')),o.redrawItemDocview(e.get('attachId'),t);});});}else if('saveChanges'===i&&'pdf'===n.getFileExtension())m._getAttachmentInfo(this._options,n).addCallback(function(e){o.redrawItemDocview(n.get('attachId'),e);});},_onStartImageEditCommand:function(e,t,i){var s=this;function o(e,t){S.channel('imageEditor').unsubscribe('onCLose',o),s._onFinishImageEditCommand(i.records,{saving:t.saving});}S.channel('imageEditor').subscribe('onCLose',o);},_onFinishImageEditCommand:function(e,t){if(false===this._options.redrawOnEdit)return;var i=t&&t.saving,s=e[0]&&e[0].getId(),o=s&&this.getTreeView().getItems().getRecordById(s),n=this;if(i instanceof M&&o)delete o._options.previewId,this._lockItem(o),i.addCallback(function(){m.readAttachmentInfo({objectName:n._options.mainOptions.objectName,serviceUrl:n._options.mainOptions.serviceUrl,id:s}).addCallback(function(e){if(!n.isDestroyed())n._unlockItem(s),n.redrawItemDocview(s,e);});});},_lockItem:function(e){var t=e.getId();this._lockedItems[t]=e.get('redactionId'),this._getItemElement(t).addClass('dv-item_locked');},_unlockItem:function(e){delete this._lockedItems[e],this._getItemElement(e).removeClass('dv-item_locked');},_getItemElement:function(e){return this.getContainer().find('[data-id="'+e+'"]');},_updateLockedItems:function(){var e=this.getTreeView().getItems();Object.keys(this._lockedItems).forEach(function(t){var i=e.getRecordById(t),s=this._lockedItems[t];if(i)if(i.get('redactionId')===s)this._lockItem(i);else this._unlockItem(t);else delete this._lockedItems[t];},this);},bindOperationPanel:function(e,t){if(this._componentBinder)this._componentBinder.bindOperationPanel(e,t);},_setMaxHeight:function(){var e=W(this._options.listOptions);this._$listContainer.css(e);},setEnabled:function(e){var t=this.isEnabled();q.superclass.setEnabled.call(this,e);try{if(t!==e&&this._isDataLoaded&&!this._isWaitingDataSource)this.reload();}catch(e){}},_scrollListToSelectedItem:function(){if('classic'!==this.getVisibilityMode())return;var e=this.getTreeView(),t=e.getSelectedIndex();if(t>=0){var i=e.getItems().at(t);if(i)e.scrollToItem(i,false,1);}},_setDefaultCursor:function(){var e=this.getContainer().find('.controls-ListView__item'),t=false,i,s,o=this,n=function e(){if(o.isDestroyed())return;var t=o.getTreeView();if(t.getItems()&&t.getItems().getRecordById(i))t.setSelectedKey(i),t._scrollToItem(i,false,1);};if(this._currentSelection||this._options.listOptions.defaultRecordPK)if(i=this._currentSelection?this._currentSelection.get('attachId'):this._options.listOptions.defaultRecordPK,s=this._getItemElement(i),0===s.length)s=e.eq(0);else t=true;else s=e.eq(0);if(this._options._processAutoClick)this._isAutoClick=true,this._scrollListToSelectedItem();else if(t)n(),setTimeout(n,1),this._options.listOptions.defaultRecordPK=null,this._notifyOnPropertyChanged('listOptions');},_onChangeHoverItem:function(e){var t=this.getTreeView(),i=t.getItems().getRecordById(e.key);if(!i)return;this._notify('onBeforeChangeHoverItem',e);var s=t.getItemsActions(),o=s?s.getItemsInstances():{};if(e.container.hasClass('docview-list__item_more'))return B(o).each(function(e){e.hide();}),void this._notify('onAfterChangeHoverItem',e,o);this._showHideItemsInstances(i,o),this._notify('onAfterChangeHoverItem',e,o);},_showHideItemsInstances:function(e,t){var i=this.canEditInApp(m.getFileExtension(e.get('fileName'))),s=this.rowOptionsForRow[e.get('attachId')],o=m._addSubmenuItemsToCommandsArray(s).map(function(e){return e.name;}),n={edit:false,editInApp:false,editGroup:false,editOnly:false,editInAppOnly:false},r,a;for(a in t)if(t.hasOwnProperty(a))if(r=o.indexOf(a)>=0,a in n){if(('editInApp'===a||'editInAppOnly'===a)&&!i)r=false;n[a]=r;}else t[a].toggle(r);n.editGroup=n.edit&&n.editInApp,n.editOnly&=!n.editGroup,n.editInAppOnly&=!n.editGroup;for(a in n)if(n.hasOwnProperty(a)&&t.hasOwnProperty(a))t[a].toggle(n[a]);},setUserTemplate:function(e,t){switch(e){case'bigPreview':this._visibilityMode.bigpreviewTpl=t;break;case'diskClassic':this._options.listOptions.columns=t;break;default:this._visibilityMode.classicTpl=t;}var i=this.getVisibilityMode();if(e===i)if(this._setTreeViewTemplate(i),'diskClassic'===e)this.getTreeView().setColumns(t);else if(this.viewerRecordSet)this.getTreeView().redraw();},getCurrentRoot:function(){return this.getTreeView().getCurrentRoot();},getFilter:function(){return this.getTreeView().getFilter();},getTreeView:function(){if(!this._attachments&&this.hasChildControlByName('attachments'))this._attachments=this.getChildControlByName('attachments');return this._attachments;},redraw:function(){this.getTreeView().redraw();},openProtocolDLC:function(){var e=this,t=null;if(e.getParent()&&e.getParent().hasChildControlByName('view'))t=e.getParent().getChildControlByName('view');if(t)t.openProtocolDLC();},printDocuments:function(e){var t=[],i=this,s=(e=e||{}).recordSet||function(){var e=i.getTreeView().getItems(),t=i.getSelectedItems(),s=new I({adapter:'adapter.sbis'});if(t.getCount())e.each(function(e){for(var i=0;i<t.getCount()&&s.getCount()<t.getCount();i++)if(e.get('attachId')===t.at(i).get('attachId')){s.add(e);break;}});return s;}();if(s.getCount())s.each(function(e){t.push(e);}),this.startCommand('print',t,e);},getSelectedKey:function(){return this.getTreeView().getSelectedKey();},setFolderAsPreview:function(e,t){if(e=Boolean(e),this._options.listOptions.visibilityMode=this._options.listOptions.visibilityMode||{},this._options.listOptions.visibilityMode.folderAsPreview!==e)if(this._applyFolderAsPreview(e),false!==t)this.redraw();},_applyFolderAsPreview:function(e){e=Boolean(e),this._options.listOptions.visibilityMode=this._options.listOptions.visibilityMode||{},this._options.listOptions.visibilityMode.folderAsPreview=e;var t=this.getTreeView();if(e){if(!this._originalGetTargetContainer)this._originalGetTargetContainer=t._getTargetContainer;if(!this._insertItemContainer)this._originalInsertItemContainer=t._insertItemContainer;if(!this._originalGetRecordsForRedraw)this._originalGetRecordsForRedraw=t._options._getRecordsForRedraw;t._options._getRecordsForRedraw=U,t._getTargetContainer=t._getItemsContainer,t._insertItemContainer=R.superclass._insertItemContainer;}else if(this._originalGetTargetContainer)t._getTargetContainer=this._originalGetTargetContainer,t._insertItemContainer=this._originalInsertItemContainer,t._options._getRecordsForRedraw=this._originalGetRecordsForRedraw;t._options.templateBinding.folderAsPreview=e,this.getContainer().toggleClass('dv-folder-as-preview',e);},selectItemAndScroll:function(e){var t=this.getTreeView();if(t){var i=t.getItems().getRecordById(e);if(i)t.setSelectedKey(e),t.scrollToItem(i,false,1);}},setFilter:function(e,t){var i=this.getTreeView();if(i)if(i.setFilter(this._options.mainOptions.filter=e,t),!t&&!i.getDataSource())this.reload();},_hideMoreButton:function(e){var t,i,s;if(!this._options.listOptions.needMoreButton)return;if(e)t=e.getMetaData()&&e.getMetaData().more;else i=this._options.listOptions.pageSize||this.DEFAULT_RECORDS_COUNT,s=this._moreButtonCount||1,t=this.viewerRecordSet&&this.viewerRecordSet.getCount()>=s*i;if(this.getChildControlByName('moreButton').toggle(t),!t)this._moreButtonCount=null;},isCurrentFolderEmpty:function(e){for(var t=this.getTreeView().getCurrentRoot(),i=this.viewerRecordSet.getCount(),s=0;s<i;s++)if(this.viewerRecordSet.at(s).get('folder')==t)if(!e||!this.viewerRecordSet.at(s).get('folder@'))return false;return true;},hasFolders:function(e){var t=this.getTreeView();if(e=e||t&&t.getItems(),e)for(var i=0,s=e.getCount();i<s;i++)if(e.at(i).get('folder@'))return true;return Boolean(t&&t.getCurrentRoot()!=t.getRoot());},_filterMoveCommand:function(e,t){if(!this.hasFolders(t))return(e||[]).filter(function(e){return'move'!==e.name;});return e;},setSelectedKeySilently:function(e){this._doNotHandleSelectedItemsChange=true,this.getTreeView().setSelectedKey(e),this._doNotHandleSelectedItemsChange=false;},setCommandOptions:function(e,t){this._options.mainOptions.commandsOptions=this._options.mainOptions.commandsOptions||{},this._options.mainOptions.commandsOptions[e]=t;}});return q.deserializeItems=L,q.deserializeItemsWithModel=function(e,t){var i=e.mainOptions,s=e.listOptions,o;if(s.serializedItems)return o=i.modelAlias||e._randomAlias||K(e,t),L(s.serializedItems,o);},q;});
define('js!SBIS3.DOCVIEW.SwitchVisibilityMode',['Core/helpers/Object/findKey','SBIS3.CONTROLS/CompoundControl','html!SBIS3.DOCVIEW.SwitchVisibilityMode','js!SBIS3.DOCVIEW.LoadVisibilityModeMixin','html!SBIS3.DOCVIEW.SwitchVisibilityMode/SwitchVisibilityModeItemTemplate','css!SBIS3.DOCVIEW.SwitchVisibilityMode','SBIS3.CONTROLS/DropdownList','SBIS3.CONTROLS/Button/IconButton','i18n!SBIS3.DOCVIEW.SwitchVisibilityMode','Docview_localization'],function(i,t,e,s,o){'use strict';var n={classic:'ArrangeList',preview:'ArrangeLargeIcons1',bigPreview:'ArrangePreview',diskClassic:'ArrangeList'},a={classic:rk('Список'),diskClassic:rk('Список'),bigPreview:rk('Плитка'),preview:rk('Плитка')},c=t.extend([s],{_dotTplFn:e,$protected:{_options:{listOptions:{visibilityMode:{savedModeField:null,setFromCookie:false,defaultMode:'classic',changedId:'default'}},itemTemplate:o,hasSwitch:{classic:true,bigPreview:true,diskClassic:false},buttonType:'list',iconSize:16},_data:{classic:'classic',preview:'preview',bigPreview:'bigPreview'}},_applyNewVisibilityMode:function(i){if('list'===this._options.buttonType){var t=this.getChildControlByName('fddSwitch');if(i!==t.getSelectedKeys()[0])this.setQueue(i),t.setSelectedKeys([i]);}else this._indexState=Math.max(this._stateSwitch.indexOf(i),0),this._updateIconAndTooltip();},init:function(){if(c.superclass.init.call(this),'string'!==typeof this._options.buttonType||'list'===this._options.buttonType)this._initListMode();else this._initButtonMode();},_initListMode:function(){var i=this,t=this.getChildControlByName('fddSwitch');t._options.iconSize=this.getIconSize(),this.setQueue(this._options.listOptions.visibilityMode.defaultMode),this.subscribeTo(t,'onSelectedItemsChange',function(e,s){var o=i._options.listOptions.visibilityMode.defaultMode,n=s[0];if('undefined'===typeof n)t.setSelectedKeys([o]);else if(n!==o)i._saveVisibilityMode(n,true);});},_initButtonMode:function(){var t=this,e=this.getChildControlByName('buttonSwitch'),s=this._options.listOptions.visibilityMode.defaultMode,o=i(this._options.hasSwitch,function(i,t){return i&&t!==s;});this._indexState=0,this._stateSwitch=[s,o],this._updateIconAndTooltip(),this.subscribeTo(e,'onActivated',function(){t._indexState^=1,t._saveVisibilityMode(t.getMode(),true);});},_updateIconAndTooltip:function(){var i=1^this._indexState,t=this._stateSwitch[i],e='sprite:icon-'+this.getIconSize()+' icon-'+n[t]+' icon-primary',s=a[t],o=this.getChildControlByName('buttonSwitch');o.setIcon(e),o.setTooltip(s);},_prepareData:function(i){var t=this._options.hasSwitch,e=this.getIconSize();return i.reduce(function(i,s){if(true===t[s])i.push({key:s,size:e});return i;},[]);},getIconSize:function(){return 24===this._options.iconSize?24:16;},setQueue:function(i){if(this._isSettedData)return;var t;if('classic'===i)t=['classic','diskClassic','bigPreview'];else if('bigPreview'===i)t=['bigPreview','diskClassic','classic'];else t=['diskClassic','classic','bigPreview'];this.setData(this._prepareData(t));},setMode:function(i){this._saveVisibilityMode(i);},getData:function(){return this._data;},getMode:function(){return this._stateSwitch[this._indexState];},setData:function(i){var t=this.getChildControlByName('fddSwitch');this._data=i,t.setItems(i);}});return c;});
define('js!SBIS3.DOCVIEW.CreateAttach',['WS.Data/Entity/Record','WS.Data/Source/SbisService','Core/EventBus','optional!js!SBIS3.BL.FileSD','Core/Indicator','Core/Context','Core/Deferred','SBIS3.CONTROLS/CompoundControl','html!SBIS3.DOCVIEW.CreateAttach','js!SBIS3.DOCVIEW.UploadMixin','js!SBIS3.DOCVIEW.Funcs','js!SBIS3.DOCVIEW.EditInBrowserMixin','js!SBIS3.DOCVIEW.AttachButtonsMixin','css!SBIS3.DOCVIEW.CreateAttach','SBIS3.CONTROLS/Menu/MenuLink','i18n!SBIS3.DOCVIEW.CreateAttach','Docview_localization'],function(e,t,i,o,n,r,a,s,c,l,d,u,p){'use strict';return s.extend([l,u,p],{$protected:{_options:{mainOptions:{sbisDiskMode:false,catalogId:''},tooltip:rk('Создать'),caption:rk('Создать'),linkedList:null,emptyCaption:false,userButtons:[],icon:'sprite:icon-24 icon-Upload icon-primary',addFolder:true},_buttons:[{id:'createFolder',title:rk('Папку'),icon:'sprite:icon-16 icon-CreateFolder icon-primary'},{id:'createMS.docx',title:rk('Документ Word'),icon:'sprite:icon-16 icon-TFDocumentW icon-primary'},{id:'createMS.xlsx',title:rk('Таблицу Excel'),icon:'sprite:icon-16 icon-TFDocumentX icon-done'},{id:'createMS.pptx',title:rk('Презентацию PowerPoint'),icon:'sprite:icon-16 icon-TFDocumentP icon-error'}],_createNewFolder:function(e){var i=this,n=this.getLinkedList(),r=n&&n._options.mainOptions&&n._options.mainOptions.filter&&n._options.mainOptions.filter.folder||this._options.mainOptions.fixId||this._options.mainOptions.catalogId;if(i._options.mainOptions.sbisDiskMode)o.GenerateFolderName(r,e).addCallback(function(e){o.CreateFolder(r,e).addCallback(function(e){i._notify('onFinishCreateAttachment',e.get('Id'));}).addErrback(function(e){i._showError(e);});}).addErrback(function(e){i._showError(e);});else this.filters.set('title',e),new t({endpoint:{address:'/service/',contract:this._options.mainOptions.objectName}}).call('CreateFolder',{filter:this._prepareFilterToRec()}).addCallback(function(e){i._notify('onFinishCreateAttachment',e.getScalar()),i.filters.set('title',void 0);}).addErrback(function(e){i._showError(e),i._notify('onErrorCreateAttachment',e);});},_showCreateFolderDialog:function(){var e=this,t=false,i=new a(),o=r.createContext(i),n=d.uniqueName(rk('Новая папка'),this._getExistingFolderNames(),true),s;o.setValue('НазваниеДокумента',n),s={template:'js!SBIS3.DOCVIEW.RenameDialog',enable:true,allowChangeEnable:false,opener:this,context:o,parent:this.getParent(),autoHeight:true,resizeable:false,width:'340px',autoWidth:false,componentOptions:{validators:[{option:'text',validator:this._isFolderNameUnique.bind(this),errorMessage:rk('Папка с таким именем уже существует')}],handlers:{onFinishEditTitle:function(i,o){e._createNewFolder(o.newTitle),t=false;},onStartChangeTitle:function(){t=true;}}},handlers:{onBeforeClose:function(i){if(!t||!this.hasChildControlByName('НазваниеДокумента'))return;var o=this.getChildControlByName('НазваниеДокумента'),n=o.getValue(),r=this;i.setResult(false),t=false,require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(i){i.showConfirmDialog({message:rk('Сохранить изменения?'),opener:r},function i(){if(o.validate())t=false,e._createNewFolder(n),r.close();else t=true;},function e(){r.close();},function e(){r.close();});});}},onDestroy:function(){i.callback();}},require(['Lib/Control/Dialog/Dialog'],function(e){new e(s);});},_play:function(i){var o=this;if(this._options.linkedList&&this._options.linkedList.isArchive())return void o._showError(rk('Создание')+' '+('createFolder'===i.item?rk('папок'):rk('файлов'))+' '+rk('в архивах невозможно'));switch(i.item){case'createFolder':o._showCreateFolderDialog();break;case'createMS.docx':case'createMS.xlsx':case'createMS.pptx':var n=new e({adapter:'adapter.sbis',format:[{name:'extDoc',type:'string'}]});n.set('extDoc',i.item.split('.')[1]||i.item);var r=window.open('about:blank','_blank');if(this._options.mainOptions.sbisDiskMode){var a=!this._options.linkedList||!this._options.linkedList._clickedFolderId||'back'===this._options.linkedList._clickedFolderId?this._options.mainOptions.catalogId:this._options.linkedList._clickedFolderId,s=this._getURLForCreateOfficeAttachment(i.item.split('.')[1],'FileSD',a,'disk');r.location.href=s;}else new t({endpoint:{contract:'DocView',address:'/docview/service/'}}).call('CreateAttachment',{Service:location.protocol+'//'+location.host+'/'+o._options.mainOptions.serviceUrl,Object:o._options.mainOptions.objectName,Filter:n}).addCallback(function(e){return o._onFinish(e.getScalar());}).addCallback(function(t){var i=new e();i.set('attachId',t),r.location.href=o._getUrlForEdit(i)+'&isCreate=1';}).addErrback(function(e){r.close(),o._showError(e);});}}},createOfficeDocHandler:function(e,t){o.NotifyRecentFileById(t),this._notify('onFinishCreateAttachment',t);},_dotTplFn:c,$constructor:function(){var e=this;if(this._attachObjects=[],this._publish('onFinishCreateAttachment','onFinishCreateAttachments'),e.getEventBusOf('LoadDocumentBtn').subscribe('onMenuItemActivate',function(t,i){var o=e._notify('onStartCreateAttachment',e.filters);d.wrapperDef(o).addCallback(function(){if(false===o)return;e._play({item:i});});}).subscribe('onInit',function(){if(!e._options.addFolder)e._removeButton('createFolder',true);var t=d.checkDeviceSupportOfficeOnline(true);!t.word&&e._removeButton('createMS.docx',true),!t.excel&&e._removeButton('createMS.xlsx',true),!t.powerpoint&&e._removeButton('createMS.pptx',true),e.reloadButtons();}),e.subscribe('onStartCreateAttachment',function(e,t,i){this.setFilter();}),e.subscribe('onFinishCreateAttachment',function(){n.hide();}),this._options.mainOptions.sbisDiskMode)this.subscribeTo(i.channel('createOfficeDocument'),'onCreate',e.createOfficeDocHandler.bind(e));},_getExistingFolderNames:function(){return d.getItemsInCurrentFolder(this._options.linkedList).filter(function(e){return e.get('folder@');}).map(function(e){return e.get('title')||'';});},_isFolderNameUnique:function(e){return this._getExistingFolderNames().indexOf(e)<0;},_showError:function(e){var t=this,i='string'===typeof e?e:e.message;require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(e){e.showMessageDialog({message:i,status:'error',opener:t});});},_getURLForCreateOfficeAttachment:function(e,t,i,o,n){var r=n?n+'/':'',a=location.protocol.split(':')[0];return'//'+location.host+'/docview/create/'+e+'/'+o+'/'+encodeURIComponent(t)+'/'+encodeURIComponent(a+'/')+'/'+i+'/'+r;}});});
define('js!SBIS3.DOCVIEW.AttachTo',['Core/helpers/Object/find','Core/helpers/Hcontrol/isElementVisible','Core/EventBus','Core/constants','Core/WindowManager','Core/moduleStubs','SBIS3.CONTROLS/CompoundControl','html!SBIS3.DOCVIEW.AttachTo','js!SBIS3.DOCVIEW.UploadMixin','js!SBIS3.DOCVIEW.ScanMixin','js!SBIS3.DOCVIEW.FileLoadMixin','js!SBIS3.DOCVIEW.AddLinkMixin','js!SBIS3.DOCVIEW.AttachButtonsMixin','js!SBIS3.DOCVIEW.SBISBufferMixin','js!SBIS3.DOCVIEW.VideoMixin','js!SBIS3.DOCVIEW.Funcs','optional!js!SBIS3.FL.FileChooser','WS.Data/Source/SbisService','WS.Data/Di','Core/Deferred','Lib/FloatAreaManager/FloatAreaManager','optional!js!SBIS3.FL.Helper','WS.Data/Entity/Model','WS.Data/Entity/Record','Core/UserInfo','browser!js!SBIS3.Plugin/components/Extensions/Integration/DeviceSelector/ScanDeviceSelectorRender/ScanDeviceSelectorRender','css!SBIS3.DOCVIEW.AttachTo','js!SBIS3.DOCVIEW.BufferList','SBIS3.CONTROLS/Menu/MenuLink','SBIS3.CONTROLS/Menu/MenuIcon','SBIS3.CONTROLS/Menu/MenuButton','Docview_localization'],function(e,t,i,o,n,s,r,a,l,f,d,c,u,h,p,_,m,g,v,b,k,S,C,D,w){'use strict';function y(){var e=navigator&&navigator.userAgent||process&&process.domain&&process.domain.req&&process.domain.req.headers&&process.domain.req.headers['user-agent'];return!e||e.indexOf('Windows')>=0;}var I,F=5;function E(e){require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(t){t.showMessageDialog({message:e,status:'error'},function(){});});}function L(e){(e||event).preventDefault();}var B=r.extend([l,f,d,c,u,h,p],{$protected:{_options:{mainOptions:{serviceUrl:'/',useVersionId:true},tooltip:rk('Прикрепить'),caption:rk('Прикрепить'),linkedList:null,showCaption:true,userButtons:[],icon:'',iconSize:16,maxFileSizeInMB:100,uploadEmptyFiles:false,insertMode:'Link',hideInsertMode:false,hasBuffer:true,hasMobileBuffer:true,hasScan:true,hasWebCam:false,hasVideoMessage:false,hasLink:false,hasLinkToPerson:false,hasLinkToCompany:false,hasSbisDiskLink:false,useDefaultWindow:false,hasClipboardLink:true,isWindowsOS:y(),textModificator:'',isMenu:true,loadWithoutServerEvents:false,groupDocsCatalogId:null,groupPhotoCatalogId:null,content:null,fileMask:[],extensions:[],publicAccess:false,allowDragNDrop:true,dropElement:null,dragText:rk('Загрузить файлы'),linkAsUrlFile:false,useStorageMode:false,doNotCopyToBuffer:false,canSelectFolderFromDisk:true,multiselect:void 0,allowSharedLinks:true},_buttonsHistory:[{id:'lastfolder0',parent:'frompc',title:'0'},{id:'lastfolder1',parent:'frompc',title:'1'},{id:'lastfolder2',parent:'frompc',title:'2'},{id:'lastfolder3',parent:'frompc',title:'3'},{id:'lastfolder4',parent:'frompc',title:'4'},{id:'desktop',parent:'frompc',title:rk('Рабочий стол'),icon:'icon-TFDesktop icon-primary'},{id:'mydocuments',parent:'frompc',title:rk('Мои документы'),icon:'icon-TFMyDocuments icon-primary'},{id:'mycomputer',parent:'frompc',title:rk('Мой компьютер'),icon:'icon-TFComputer icon-primary'}],_buttons:[{id:'frompc',title:o.browser.isMobilePlatform?rk('С устройства'):rk('С компьютера')},{id:'sbisbuffer',title:'<component data-component="SBIS3.DOCVIEW.BufferList"></component>',icon:'icon-Paste icon-primary',className:'docview-attachTo__buffer-menu-item'},{id:'mobilebuffer',title:'<component data-component="SBIS3.DOCVIEW.BufferList">'+'<option name="typeBuffer">mobile</option>'+'<option name="isActiveButton">true</option>'+'</component>',icon:'icon-Paste icon-primary',className:'docview-attachTo__buffer-menu-item'},{id:'fromsbisdisk',title:rk('Из документов'),icon:'icon-Unfavourite icon-primary'},{id:'scan',title:'<component data-component="SBIS3.Plugin/components/Extensions/Integration/DeviceSelector/ScanDeviceSelectorRender/ScanDeviceSelectorRender"></component>',icon:'icon-Scan icon-primary'},{id:'webcam',title:rk('С веб-камеры'),icon:'icon-WebCamera icon-primary'},{id:'video',title:rk('Видеосообщение'),icon:'sprite:icon-16 icon-TFVideoMessage icon-primary'},{id:'link',title:rk('Ссылку на Web-ресурс'),icon:'icon-Link icon-primary'},{id:'company',className:'docview-attachTo__company-menu-item',title:rk('Компанию')},{id:'person',className:'docview-attachTo__person-menu-item',title:rk('Сотрудника')}],_newFileLoader:null,_newFileChooser:null,_loadDeferred:void 0,_lastFolders:new Array(F),_filesInFolders:[],_play:function(e){if(_.isDemoMode()&&this._options.mainOptions.isDisk&&'sbisbuffer'!==e.item)return void E(rk('Загрузка файлов недоступна в демо-режиме'));if(this._options.linkedList&&this._options.linkedList.isArchive()&&'sbisbuffer'!==e.item)return void E(rk('Добавление файлов в архивы невозможно'));if(!this.filters)this.filters=new C();switch(this.setFilter(),this._activeItem=e.item,e.item){case'frompc':this._maxFileLoad(),this._getAttachButton().hidePicker();break;case'lastfolder0':case'lastfolder1':case'lastfolder2':case'lastfolder3':case'lastfolder4':var t=this._lastFolders[+e.item.substring(10)];this._maxFileLoad(t);break;case'fromsbisdisk':this._fromSbisDisk();break;case'desktop':case'mydocuments':case'mycomputer':this._maxFileLoad(e.item);break;case'scan':this._scan();break;case'webcam':this._webCam();break;case'person':this._person();break;case'company':this._company();break;case'link':this._link();break;case'video':this._video();}}},_dotTplFn:a,_modifyOptions:function(){var e=B.superclass._modifyOptions.apply(this,arguments);if(!(e.extensions&&e.extensions.length)&&e.fileMask&&e.fileMask.length)e.extensions=e.fileMask.map(function(e){return e.replace('*.','');});if(!e.allowSharedLinks)e.hideInsertMode=true,e.insertMode='copy';return e;},$constructor:function(){var e=this;if(e.once('onReady',function(){var t=e._getAttachButton();e.setIcons(),e._setMenuItems(),e.subscribeTo(t,'onMenuItemActivate',function(t,i){e._play({records:e._options.records,item:i});}),e.subscribeTo(t,'onPickerOpen',function(){e._updateLastFolders();});}),e._easyLoadingMode=(this._options.mainOptions.isDisk||e._options.mainOptions.serviceUrl.length>1)&&!this._options.useStorageMode,e._easyLoadingMode){if(!e._newFileChooser)e._newFileChooser=m;}else if(!e._newFileLoader)require(['js!SBIS3.FL.FileLoader'],function(t){if(!e._newFileChooser)e._newFileLoader=t;});},_setMenuItems:function(){var e=this,t=[],i=!this._options.isWindowsOS||o.browser.isMobilePlatform;if(!this._options.hasBuffer)t.push('sbisbuffer');if(!this._options.hasBuffer||!this._options.hasMobileBuffer||o.browser.isMobilePlatform||'__сбис__биллинг'===w.get('ЛогинКлиента'))t.push('mobilebuffer');if(!this._options.hasLink)t.push('link');if(!this._options.hasLinkToPerson||!this._options.hasLink)t.push('person');if(!this._options.hasLinkToCompany||!this._options.hasLink)t.push('company');if(!this._options.hasSbisDiskLink||!this.checkFileSD())t.push('fromsbisdisk');if(!this._options.hasScan||i)t.push('scan');if(!this._options.hasWebCam||i)t.push('webcam');if(this._options.hasVideoMessage)s.requireModule(['SBIS.VideoCall/VideoMessage'],function(t){if(!t||!t.isVmsgAvailable||!t.isVmsgAvailable())e.removeButtons(['video'],true);},function(){e.removeButtons(['video'],true);});else t.push('video');if(t.length)this.removeButtons(t,true);else this.reloadButtons();},_cutPath:function(e,t){var i='',o='',n='',s='';if(e.length>t)if(o=e.slice(e.lastIndexOf('\\')),o.length<t/2)s=e.slice(0,t-o.length-3)+'...'+o;else n=o.slice(0,Math.ceil(t/2))+'...',s=e.slice(0,t-n.length-3)+'...'+n;else s=e;return s;},_updateLastFolders:function(){var e=(S.getFolderPathHistory()||[]).slice(0,F),t,i,o;for(i=0;i<F;i++)t=e[i]&&e[i].split('|')[1]||'',o=this._cutPath(t,40),$('.controls-Menu__submenu .controls-MenuItem[data-id="lastfolder'+i+'"]').toggleClass('ws-hidden',!t).toggleClass('docview-attachTo__last-history-item',i===e.length-1).find('.controls-MenuItem__text').attr('title',t).text(o),this._lastFolders[i]=e[i];},setIcons:function(){var e=this._options.content?this._options.iconSize:this._options.showCaption?16:24;this._buttons.forEach(function(t){if(t.icon)t.icon='sprite:icon-'+e+' '+t.icon;});},init:function(){B.superclass.init.call(this);var e=this;if(e._attachObjects=[],this._options.hasBuffer){if(this.setSbisBufferEventHandlers(this._getAttachButton()),this._options.hasClipboardLink)this.subscribeTo(i.channel('SbisBufferEvents'),'onInsertLink',function(t,i,o,n){if(e.getId()===n)e.addLink(i,o);});this.subscribeTo(i.channel('SbisBufferEvents'),'onBufferListRedraw',this._recalcPopupPosition.bind(this)),e._initBufferHotKeys();}if(!this._options.useDefaultWindow&&this._options.isWindowsOS&&!o.browser.isMobilePlatform)e._getFileLoaderPlugin().addCallback(function(){if(e._buttons=e._buttons.concat(e._buttonsHistory),e.setIcons(),!e._getAttachButton().isPickerVisible())e.reloadButtons();else e._getAttachButton().once('onPickerClose',function(){setTimeout(function(){e.reloadButtons();},0);});});if(this._options.allowDragNDrop)this._options.dropElement=this._options.dropElement?$(this._options.dropElement):this.getParent()?this.getParent().getContainer():null,e._initDragNDrop();},_initBufferHotKeys:function(){if(this._options.dropElement){var e=this;$(this._options.dropElement).on('paste',function(t){if(t.originalEvent.clipboardData.types.indexOf('text/plain')<0)t.preventDefault(),e.attachFromClipboard();});}},destroy:function(){this._newFileLoader=this._newFileChooser=this._filesArray=null,B.superclass.destroy.call(this);},setDropElement:function(e){this._removeDragNDropHandlers(),this._options.dropElement=e,this._setDragNDropHandlers();},startFileLoad:function(e,t,i){var o=new b(),n={},s=function(e,t){if(!o.isReady())n=t,this.unsubscribe('onLoaded',s),o.callback();}.bind(this);if(this.subscribe('onLoaded',s),this._filesArray=[],!this._getAttachButton()._picker)this._getAttachButton().setProperty('pickerConfig',{opener:e.wsControl(),target:e});else this._getAttachButton().getPicker().setTarget(e),this._getAttachButton().getPicker().setOpener(e.wsControl());if(this._options.multiSelect=t,this._options.destinationDir=i,this._getAttachButton().showPicker(),this._loadDeferred&&!this._loadDeferred.isReady())this._loadDeferred.cancel();return this._loadDeferred=o,o.addCallback(function(){return n;}),o;},setLoadWithoutServerEvents:function(e){if(this._options.loadWithoutServerEvents!==e)if(this._options.loadWithoutServerEvents=e,this._notifyOnPropertyChanged('loadWithoutServerEvents'),'__сбис__биллинг'===w.get('ЛогинКлиента'))this._options.mainOptions.isDisk=true,this._options.mainOptions.useVersionId=true,this._easyLoadingMode=true,this._newFileChooser=m,this._newFileLoader=null;},_webCam:function(){var e=this;this._createPhotoCam().addCallback(function(t){t.getFiles().addCallback(function(t){e._maxFileLoad(null,[t.getData()]);});});},_createPhotoCam:function(){if(this._photoCam)return b.success(this._photoCam);var e=this,t=new b();return require(['Lib/File/ResourceGetter/PhotoCam'],function(i){e._photoCam=new i({extensions:['image'],parent:e}),t.callback(e._photoCam);}),t;},_initDragNDrop:function(){if(this._dragSubscribed)return;var e=this;this._setDragNDropHandlers(),this.subscribeTo(this,'onFinishCreateAttachments',function(){e.nowUploading=false;}),this.once('onDestroy',function(){e._removeDragNDropHandlers();});},_setDragNDropHandlers:function(){if(!this._options.allowDragNDrop||!this._options.dropElement||!this._options.dropElement.length)return;var e=this,i=this.uploadFile.bind(this),o=false,s=-1,r=false,a=this.findParent(function(e){return e.getZIndex&&e.getZIndex()>0;}),l=a?a.getZIndex():1000;function f(t){if(t){var i=n.getMaxZIndex();if(!e._dragOverlayEl){e._dragOverlayEl=document.createElement('div'),e._dragOverlayEl.setAttribute('id','attachTo__dragOverlay'),document.body.insertBefore(e._dragOverlayEl,document.body.firstChild);var o=$(e._options.dropElement),s=$(e._dragOverlayEl);s.css({top:o.offset().top,left:o.offset().left,width:o.width(),height:o.height(),zIndex:i+1}),e._dndHandlers={dragstart:c.bind(this),dragover:h.bind(this),dragleave:p.bind(this),drop:_.bind(this)},s.on(e._dndHandlers);}$(e._dragOverlayEl).attr('data-dragtext',e._options.dragText);}else if(e._dragOverlayEl)$(e._dragOverlayEl).off(e._dndHandlers),$(e._dragOverlayEl).remove(),e._dragOverlayEl=null;}function d(){return!r&&!e.nowUploading&&t(e.getContainer())&&k._getMaxZIndex()<=l;}function c(e){e.preventDefault(),r=true;}function u(t){if(t.preventDefault(),new Date().getTime()-e._lastLeave<100)return;var i=true;if(t&&t.originalEvent&&t.originalEvent.dataTransfer&&t.originalEvent.dataTransfer.types&&t.originalEvent.dataTransfer.types[0])i=t.originalEvent.dataTransfer.types.indexOf?t.originalEvent.dataTransfer.types.indexOf('Files')>=0:'Files'==t.originalEvent.dataTransfer.types[0];if(i&&d())f(true),o=true;}function h(e){if(e.preventDefault(),d())o=true;}function p(t){if(t.preventDefault(),d())o=false,clearTimeout(s),s=setTimeout(function(){if(!o)f(false),e._lastLeave=new Date().getTime();},0);}function _(t){if(t.preventDefault(),e._options.linkedList&&e._options.linkedList.isArchive())return E(rk('Добавление файлов в архивы невозможно')),f(false),void(o=false);e._filesCount=0,e._foldersCount=0;var n=e._options.extensions,s=[];if(e._dropFolderId=e._options.parentFolderId||e.filters.get('folder')||e._options.linkedList&&e._options.linkedList.getCurrentRoot()||e._options.linkedList&&e._options.linkedList.getFilter().folder,d()){if(f(false),e.nowUploading=true,e._filesInFolders.length)e._filesInFolders.splice(0,e._filesInFolders.length);e._getEntries(t.originalEvent.dataTransfer).addCallback(function(t){if(n.length)if(m(t,n,s),s.length)if(g(e._options.extensions),0===t.folders.length&&0===t.files.length)e.nowUploading=false;b.callbackWrapper(e._notify('onStartCreateAttachment',e.filters),function(e){if(false!==e)i(t.files,t.folders);});});}else r=false;}function m(e,t,i){var o=[],n=[];if(e.files.length)e.files.forEach(function(e){if(t.indexOf(e.name.slice(e.name.lastIndexOf('.')+1).toLowerCase())>-1)o.push(e);else n.push(e.name);}),n.forEach(function(e){i.push(e);}),e.files=o;if(e.folders.length)e.folders.forEach(function(e){m(e,t,i);});}function g(e){require(['Core/helpers/String/format'],function(t){E(t({extensions:e.join(', ')},rk('Для загрузки разрешены файлы с расширениями: $extensions$s$')));});}this._options.dropElement.on('dragenter.docview-attachto',u),$('html').on('dragenter.docview-attachto',function(){$(e._options.dropElement).find('iframe').each(function(){if(!$(this).attr('dragndrop'))$(this).attr('dragndrop','blocked'),this.contentWindow.addEventListener('dragover',L,false),this.contentWindow.addEventListener('drop',L,false);});}),this._dragSubscribed=true;},_removeDragNDropHandlers:function(){if(this._options.dropElement)$(this._options.dropElement).off(self._dndHandlers);$('html').off('dragenter.docview-attachto'),this._dragSubscribed=false;},_createNewFolder:function(e,t){var i=this,o=new b(),n,s,t,r=!t;if(this._options.mainOptions.isDisk){var a=new D({adapter:'adapter.sbis',format:[{name:'ParentId',type:'string'},{name:'Name',type:'string'}]});t=t||this._options.mainOptions.fixId||this._options.destinationDir||this._options.mainOptions.filter.catalogId,a.set('ParentId',t),a.set('Name',e),n={Object:a};}else n={filter:this._prepareFilterToRec(null,{folderName:e,parentFolderId:t})};return new g({endpoint:{contract:this._options.mainOptions.objectName,address:'/service/'}}).call('CreateFolder',n).addCallback(function(e){if(i.nowUploading&&i._options.mainOptions.isDisk){if(s=e.getRow().get('Id'),r)i._onFinish(s,true,void 0,{fileId:s});}else s=e.getScalar();i._notify('onFinishCreateAttachment',s),o.callback(s);}).addErrback(function(e){o.errback(e);}),o;},uploadFolder:function(e,t){var i=this;this._createNewFolder(e.name,t).addCallbacks(function(t){if(i._foldersCount)i._foldersCount--;if(e.files.length||e.folders.length)e.files.forEach(function(e){e.folder=t,i._filesInFolders.push(e);}),i.uploadFile(e.files,e.folders,t);else if(void 0!==i._foldersCount&&0===i._foldersCount&&0===i._filesCount)i.nowUploading=false;},function(e){if(i._foldersCount)i._foldersCount--;E(e.message);});},uploadFile:function(e,t,i){if(void 0!==this._foldersCount&&void 0!==this._filesCount)this._foldersCount+=t.length,this._filesCount+=e.length;var o=this;if(_.isDemoMode())return E(rk('Загрузка файлов недоступна в демо-режиме')),void(o.nowUploading=false);if(!e.length&&!t.length)o.nowUploading=false;else{if(t.length)t.forEach(function(e){o.uploadFolder(e,i);});if(e.length)this._maxFileLoad(null,e);}},_getEntries:function(t){function i(e,t){this.name=e,this.path=t,this.size=0,this.isFolder=true,this.folders=[],this.files=[];}var n=new b(),s=0,r=0,a={files:[],hasFolders:false,folders:[],errors:[]};function l(){if(0===r)a.hasFolders=!!a.folders.length,f();}function f(){n.callback(a);}function d(e){if(e.onprogress=e.onerror=null,++s===t.files.length)f();}if(!t.files)f();else if(0===t.files.length)a.hasFolders=true,f();else if(t.items&&!o.browser.firefox)r=t.items.length,[].forEach.call(t.items,function(e){c(e.webkitGetAsEntry(),a);});else if(o.browser.firefox&&window.FileReader)[].forEach.call(t.files,function(e){var t=new FileReader();t.onprogress=function(){a.files.push(e),t.abort(),d(t);},t.onerror=function(){a.hasFolders=true,d(t);};try{t.readAsArrayBuffer(e);}catch(e){t.onerror();}});else if(o.safari&&window.FileReader)[].forEach.call(t.files,function(e){if(''!==e.type)a.files.push(e);}),f();else a.files=Array.prototype.slice.call(t.files),f();function c(t,o){if(!t)r--,l();else if(t.isFile)t.file(function(i){var n=t.fullPath.split('/')[1],s=e(a.folders,function(e){return e.name===n;});if(o.files.push(i),s)s.size+=i.size;r--,l();});else if(t.isDirectory){var n=t.createReader(),s=new i(t.name,t.fullPath);o.folders.push(s);var f=n.readEntries.bind(n,function(e){var t=e.length;if(t>0){r+=t,l();while(t--)c(e[t],s);f();}else r--;l();});f();}}return n;},_recalcPopupPosition:function(){this._getAttachButton()._picker&&this._getAttachButton()._picker.recalcPosition(true);}});return v.register('ImageUploader',{getFileLoader:function(e){return I=I&&!I.isDestroyed()?I:new B({parent:e,allowDragNDrop:false,hasScan:false,hasClipboardLink:false,extensions:['jpeg','jpg','png','gif'],element:$('<div>'),showCaption:false,icon:'sprite:icon-24 icon-Attach icon-primary',caption:rk('Загрузить'),mainOptions:{isDisk:true,objectName:'FileSD',serviceUrl:'/disk/api/v1/'},publicAccess:true,insertMode:'Copy',hideInsertMode:true,preloadClipboardContent:false,useDefaultWindow:true,closeOnTargetMove:false}),I;},canMultiSelect:true},{instantiate:false}),B;});
define('js!SBIS3.DOCVIEW.View',['Core/helpers/random-helpers','Core/IoC','Core/constants','SBIS3.CONTROLS/CompoundControl','tmpl!SBIS3.DOCVIEW.View','js!SBIS3.DOCVIEW.CommandsManager','js!SBIS3.DOCVIEW.CommandPanel','js!SBIS3.DOCVIEW.Funcs','js!SBIS3.DOCVIEW.UpdaterMixin','js!SBIS3.DOCVIEW.CheckEditingMixin','WS.Data/Entity/Record','Core/EventBus','Core/Deferred','WS.Data/Source/SbisService','SBIS3.CONTROLS/WaitIndicator','Core/helpers/Object/isEmpty','Core/CommandDispatcher','Core/utf8-base64','Core/core-clone','css!SBIS3.DOCVIEW.View','Docview_localization'],function(e,t,n,i,o,a,s,r,d,c,l,h,f,u,m,_,g,v,C){'use strict';function p(e,t,n){var i={};if(n.forEach(function(n){var o=e.get(n),a=t.get(n);if(o!==a&&(o||a))i[n]=a;}),!_(i))e.set(i);return i;}function w(e,t){return requirejs(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(n){var i={message:e.message,status:'error'};if(!I(e))i.details=rk('Мы знаем об этом и уже исправляем. Попробуйте заглянуть сюда через 15 минут.');n.showMessageDialog(i,t);}),e;}function I(e){return-1===e.message.indexOf('временно недоступен')&&-1===e.message.indexOf('Повторите попытку позже')&&e.details!==rk('Мы знаем об этом и уже исправляем. Попробуйте заглянуть сюда через 15 минут.');}function E(e){return e.message.indexOf('Недостаточно прав')>-1;}function b(e){return e.message.indexOf('не найден')>-1||e.message.indexOf('удален')>-1||e.message.indexOf('удалён')>-1;}var y,S=40,R=/\/obj\/([a-z0-9\-]+)\/([a-z0-9\-]+)\/attachment\/([a-z0-9\-]+)\//i,F='ws-popup-mixin-ignore-iframe';return y=i.extend([a,c,d],{_dotTplFn:o,$protected:{_options:{mainOptions:{objectName:'',serviceUrl:'/',serviceBLName:'ОсновнойСервис',ctxLinkId:null,fixId:null,filter:null,useOnlyCtx:true,ctxLinkList:'record/РП.Документ/СписокВложений',redactionWindow:{renderPhotos:true},commands:{deleteDoc:true,directLink:true,copyToBuffer:false,addPage:true,edit:true,fullScreen:true,print:true,saveToPdf:true,upload:true,zoomMinus:true,zoomPlus:true,links:true,redactions:true},multiPage:true,directLinkRouting:'disk',userCommands:[],isDisk:true},viewOptions:{mode:'view',canEditFED:true,showStampFED:false,autoWidth:false,justAttach:false,showMarker:false},listOptions:{},record:null,_dontHandleDocumentChangedChannels:false},_typeCmd:'inline',_ifr_id:'',_iFrame:null,_oldIFrames:[],savedRec:null,_commandPanel:null,_iframeTimeout:0,_waitIndicatorStopper:null,_subscribed:false,_hash:'',_createPanelHash:'',_activeControl:null,_oldActiveControls:[],_savingDeferred:null},_getViewerHeight:function(){var e=document.documentElement.clientHeight||$(document).height();if(this._options.fullScreenMode){if(!this.savedRec||!this.savedRec.isImage())e-=S;}else if(this.savedRec&&r._isFileWithExtensions(this.savedRec.get('fileName'),this.videoExts)){var t=this.getContainer(),n=t.find('.docview-CommandPanel').height();e=Math.max(e-t.offset().top-n,400);}return e;},_takeShotWhenFileWillBeLoaded:function(){var e=this.getContainer(),t=this.savedRec&&r._isFileWithExtensions(this.savedRec.get('fileName'),this.pdfExts.concat(['doc','docx']))?700:100,n=setInterval(function(){if(!e.find('.docview-notLoadedYet').length)clearInterval(n),setTimeout(function(){window.callPhantom({takeShot:true});},t);},100);},setMode:function(e){if(this._options.viewOptions.mode!==e){this._options.viewOptions.mode=e;var t=this.savedRec;this.savedRec=null,this.paint(t);}},isEditMode:function(){return Boolean(this._options.viewOptions&&'edit'===this._options.viewOptions.mode);},_getIframeWindow:function(){return this._iFrame&&(!this._iFrame.contentDocument||$(this._iFrame.contentDocument.body).is('[class^="skin_"]'))&&this._iFrame.contentWindow||null;},_saveRec:function(e){var t=this.savedRec,n=!t||t.get('attachId')!=e.get('attachId')||t.get('redactionId')!=e.get('redactionId')||t.get('hash')!==e.get('hash')||t.get('encrypted')!==e.get('encrypted')||t.get('editable')!==e.get('editable')||t.get('errorText')!==e.get('errorText');if(this.savedRec=r.cloneMyRec(e),this.savedRec.setIdProperty('attachId'),n)this._notify('onViewRecordChanged',this.savedRec);return n;},setProperties:function(e){if(y.superclass.setProperties.call(this,e),e.record)this.paint(e.record);if(e.mainOptions&&e.mainOptions.commands&&this.savedRec)this.reCreatePanel(this.savedRec);},_getIFrame:function(){return this._ifr_id?document.getElementById(this._ifr_id):null;},_removeIFrame:function(e){if(e=e||this._getIFrame(),e&&e.parentNode)e.parentNode.removeChild(e);},_removeOldIFrames:function(){while(this._oldIFrames.length)this._removeIFrame(this._oldIFrames.pop());},_destroyOldActiveControls:function(){this._oldActiveControls.forEach(function(e){if(e&&e.destroy&&!e.isDestroyed())e.destroy();}),this._oldActiveControls.length=0;},_destroyActiveControl:function(){if(this._activeControl&&this._activeControl.destroy&&!this._activeControl.isDestroyed())this._activeControl.destroy();if(this._$activeControl)this._$activeControl.remove();this._$activeControl=null,this._activeControl=null;},$constructor:function(){this._publish('onProcessCommand','onStartDecrypt','onCreateCommandPanel','onStartShowFedDocument','onBeforeSaveFedDocument','onBeforeSave','onReadAttachmentInfo','onErrorShowFile');},init:function(){y.superclass.init.call(this);var e=this;this.getContainer().find('.docview-Transparent').click(this._hideTransparentDiv.bind(this)),this._documentChanged=this.getContainer().find('.docview-View__documentChanged'),this._documentChangedCloseBtn=$('.docview-View__documentChangedClose',this._documentChanged),this._documentChangedCloseBtn.click(this._documentChanged.addClass.bind(this._documentChanged,'ws-hidden')),e.subscribe('onProcessCommand',function(e,t,n){if('redactions'===t)this._changeFileRedaction(n.records[0],n);}),g.declareCommand(this,'updateRenameWidth',function(t){var n=e.getCommandPanel();if(n)n.updateRenameWidth(t);else e.subscribeOnceTo(e,'onCreateCommandPanel',function(e,n){n.updateRenameWidth(t);});}),g.declareCommand(this,'xmlEdit',function(){return this.setMode('edit'),true;}),g.declareCommand(this,'docviewDecrypt',function(t){if(4===t.records[0].get('encrypted'))e._notify('onStartCommand','decrypt',t),e.setEnabledButtons(t);else this.startCommand('decrypt',t.records,{password:t.password});return true;}),g.declareCommand(this,'docviewDownload',function(e,t){var n=function(e,t,n){if('upload'===t&&n.records[0].isEncrypted())this._activeControl.toggleDownloadIndicator(false);}.bind(this);return this.subscribeOnceTo(this,'onFinishCommand',n),this.subscribeOnceTo(this,'onCancelCommand',n),this.startCommand('upload',e,{password:t}),true;}),e.subscribe('onErrorCommand',function(t,n,i){e.setEnabledButtons(i);}),e.subscribe('onFinishCommand',function(t,n,i){var o=i.records[0];if('sendMessage'===n){if(e.savedRec)setTimeout(function(){var e=this;this._readAttachmentInfo(e._options,o).addCallback(function(t){e.reCreatePanel(t);});}.bind(e),1);}else if('rights'===n&&i&&i.finishParams&&!i.finishParams.withoutReload)e._readAttachmentInfo(e._options,o).addCallback(function(t){e.reCreatePanel(t,{dontUpdatePanelCounters:true});});else if(-1!==['rotateLeft','rotateRight','zoomMinus','zoomPlus'].indexOf(n)){if(o.isImage())this.switchStateOneCommand('originalImage',true);e._updateScaleLabel(e.savedRec);}else if('imageEdit'===n)e._onFinishImageEditCommand(i.finishParams);else if(o.isImage&&o.isImage()&&'originalImage'===n)e._updateScaleLabel(e.savedRec,100);else if('addPage'===n)e._onAddPageFinish(i);else if('encrypt'===n||'decrypt'===n)e._readAttachmentInfo(e._options,i.records[0]).addCallback(function(t){e.paint(t),e.reCreatePanel(t,{dontUpdatePanelCounters:true});});else if('signDocument'===n&&!e._options.fullScreenMode&&!e._options._dontHandleDocumentChangedChannels)e._readAttachmentInfo(e._options,i.records[0]).addCallback(function(t){e.reCreatePanel(t,{dontUpdatePanelCounters:true});});}),e.subscribe('onChangeCommandsSetting',function(t,n){if(e.savedRec)if(n instanceof Array){var i=(e.savedRec.get('title')||e.savedRec.get('fileName')).split('.').pop();if(-1!==n.indexOf(i))e.reCreatePanel(e.savedRec);}else e.reCreatePanel(e.savedRec);});var t=0,i=function(){var n=e.getContainer().width(),i=e._getIframeWindow();if(t!==n||e._options.fullScreenMode||e._activeControl&&e._activeControl.getContainer().hasClass('docview-needSetHeight'))if(e.execCommand('resize',{h:!e._options.fullScreenMode&&i?i.getHeight():e._getViewerHeight()}),e._updateScaleLabel(e.savedRec),t=n,e.savedRec&&e.savedRec.isImage())e.switchStateOneCommand('originalImage',true);},o=function(){e.saveFedDocument();};if(this._options.fullScreenMode)$(window).on('resize',i);else this.subscribe('onResize',i);if($(window).on('orientationchange',i).on('beforeunload',o),e.once('onDestroy',function(){$(window).off('resize',i).off('orientationchange',i).off('beforeunload',o);}),!e._options._dontHandleDocumentChangedChannels&&r.isAuthenticated()){var a=e._officeDocumentChangeHandler.bind(e);e.subscribeTo(h.serverChannel('wopi.documentHasChanged'),'onMessage',a),e.subscribeTo(h.serverChannel('webdav.documentHasChanged'),'onMessage',a),e.subscribeTo(h.channel('DocviewFileEditorChannel'),'onDocumentChanged',a);}if(e.subscribe('onStartCommand',function(t,n,i){if('decrypt'===n)t.setResult(e._notify('onStartDecrypt',i));else if('imageEdit'===n)e.waitChildControlByName('imageEditor').addCallback(function(t){return e.subscribeTo(t,'onBeforeSave',r.createEventTransmitter(e)),t;});}),e.subscribe('onShowFile',function(t,n,i){if(i=i||{},this.isEmpty()||i.fullScreenMode&&!e._options.fullScreenMode)return;if($(this._getIFrame()).removeClass('docview-notLoadedYet'),this._removeOldIFrames(),this._destroyOldActiveControls(),e.getContainer().removeClass('docview-white-background').find('.docview-CommandPanel').removeClass('ws-hidden'),e._activeControl)if(!e._activeControl.isDestroyed()){var o=e._activeControl.getContainer(),a=o.find('iframe');if(e.execCommand('resize'),o.removeClass('docview-notLoadedYet').css('width',''),e._options.fullScreenMode&&!e.isEditMode())e._addSwipeSwitching({target:a.length?a[0].contentDocument:o,movingContainer:o});}else e._activeControl=null;var s=this._getIframeWindow(),r=this._getIFrame(),d=function(){var t=e._getIframeWindow();if(!t)return;if('img'===t.getPreClass())t.startNewZoom();else try{t.setSpecificNewHeight(),e.execCommand('resize');}catch(e){}};if(s){if(!s.initView)return;d(),e._updateScaleLabel(e.savedRec);}if($(r).on('load',d),!e._commandPanel||e.isEditMode()||e._commandPanel._options.records[0].get('attachId')!==e.savedRec.get('attachId')||e._commandPanel._options.records[0].getFileExtension()!==e.savedRec.getFileExtension()||e._commandPanel._options.records[0].get('redactionId')!==e.savedRec.get('redactionId'))e.reCreatePanel(n);this._removeIndicator();}),n.browser.isMobilePlatform)e.getContainer()[0].addEventListener('touchstart',function(e){if(e.targetTouches.length>1)e.preventDefault?e.preventDefault():e.returnValue=false;},false);this.subscribe('onKeyPressed',this._onKeyPressed);},setEnabledButtons:function(e){if(this.hasChildControlByName('docview-download')&&e.records[0].isEncrypted())this.getChildControlByName('docview-download').setEnabled(true);if(this.hasChildControlByName('docview-decrypt')&&e.records[0].isEncrypted())this.getChildControlByName('docview-decrypt').setEnabled(true);},destroy:function(){if(this._removeIndicator(),this._destroyActiveControl(),this._removeOldIFrames(),this.isEditMode()&&r._isFileExtensionIn(this.savedRec.getFileExtension(),this.editInBrowse))r.setLock({lock:false,record:this.savedRec,options:this._options.mainOptions});this._commandPanel=this.savedRec=this._iFrame=this._savingDeferred=null,y.superclass.destroy.call(this);},_officeDocumentChangeHandler:function(e,t){if(t.fileId!=this.getAttachmentId()||this.isEditMode())return;var n=this,i,o=r.getUserID(),a=false||t.isCurrentUser;if(!a&&o&&t.client)a=t.client.some(function(e){return o===parseInt(e,16);});if(!t.attachmentInfo)i=n._readAttachmentInfo(this._options,this.savedRec);else i=new f().callback(t.attachmentInfo);i.addCallback(function(e){if(a)n.paint(e);else n._documentChanged.removeClass('ws-hidden').find('.docview-View__documentChangedLink').one('click',function(t){t.preventDefault(),n.paint(e);});});},_onAddPageFinish:function(e){var t=this;if('pdf'===e.records[0].getFileExtension())if(e.newPagesKeys&&t._activeControl){var n=t._activeControl.getPages(),i=n.at(n.getCount()-1);e.newPagesKeys.forEach(function(e){r.readAttachmentInfo({objectName:'PDF',serviceUrl:'/docview/',id:e}).addCallback(function(t){var o=i.clone();o.set({attachId:e,redactionId:e,hash:t.get('hash')||t.get('Версия'),Height:t.get('Height'),Width:t.get('Width')}),n.add(o);});});}},_changeFileRedaction:function(e,t){t=t||{};var n=r.cloneMyRec(this.savedRec),i=this._getDataForMergeFromRedaction(e,t),o=t.needUpdatePanelCounters;n.set(i),this.savedRec=null,this.paint(n,!o);},_getDataForMergeFromRedaction:function(e,t){var n={redactionId:e.get('redactionId'),hash:e.get('hash'),lastChange:e.get('lastChange')};if(!this._options.mainOptions.isDisk)n.fileName=e.get('fileName'),n.title=e.get('title'),n.versionForm=e.get('versionForm'),n.typeDoc=e.get('typeDoc'),n.relativeUrl='',n.countSigns=e.get('countSigns'),n.signs=e.get('signs');else{var i=null;if(!t.needUpdatePanelCounters){var o=e.getOwner(),a=null;i=0,o.each(function(t){if(t.get('isRedactionRecord'))i++;else if(t.get('signId')&&t.get('redactionId')!==e.get('redactionId'))a=t.get('signId');}),n.idPreviousRedactionSign=a,n.hasPreviousRedactionSign=!!a,n.signs=!!e.get('signs'),n.countSigns=e.get('signsCount');}n.ModifyDate=e.get('lastChange'),n.Editor=e.get('profileId'),n.EditorPhotoId=e.get('profilePhotoId'),n.relativeUrl=e.get('relativeUrl'),n.countRedactions=i,n.redactionsNumber=null;}return n;},_onFinishImageEditCommand:function(e){if((e&&e.saving)instanceof f)this._showIndicator();},setEnabled:function(e){var t=this.isEnabled();if(y.superclass.setEnabled.call(this,e),t!==e)this.reload();},reload:function(e){var t=this.savedRec;if(e)if(this.savedRec=null,this._activeControl&&!this._activeControl.isDestroyed())this._activeControl.getContainer().attr('data-file-id','');this.paint(t);},empty:function(){this._removeIFrame(),this._removeOldIFrames(),this._destroyActiveControl(),this._destroyOldActiveControls(),this._removeIndicator(),this.savedRec=null,this.getContainer().find('.docview-CommandPanel').addClass('ws-hidden'),this._documentChanged.addClass('ws-hidden');},updatePanel:function(e){this._saveRec(e),this.reCreatePanel();},paint:function(t,n){if(!t)return;var i=this,o=this._getIFrame();if(t.get('folder@')||this.savedRec&&this.isEditMode()&&r._isFileWithExtensions(t.get('fileName'),['docx'])||!this._saveRec(t))return;this._documentChanged.addClass('ws-hidden');var a=e.randomId('hash-');if(i._hash=a,this._activeControl&&!this._activeControl.isDestroyed())this._destroyOldActiveControls(),this._oldActiveControls.push(this._activeControl);if(o)this._oldIFrames.push(o);var s=new f(),d=i._notify('onStartCommand','startShowDocument',{records:[t]}),c={rec:t,hash:a};if(3===t.get('Type')&&void 0===t.get('versionForm')||null===t.get('canEdit')||'Archive'===i._options.mainOptions.objectName||d)i._readAttachmentInfo(i._options,t).addCallback(function(e){e.set('linkedRecord',t.get('linkedRecord')),e.set('signs',r._getValidSignsValue(t,e)),c.rec=e,s.callback(c);}).addErrback(function(){s.callback(c);});else if(t.isLink()&&!t.get('errorText')){var l=r.getLinkUrl(t,i._options.mainOptions);if(c.url=l,!t.get('isError')&&l.indexOf('/opendoc.html?guid=')>0)c.isEDODialogCardLink=true,s.callback(c);else if(!t.get('isError')&&(l.indexOf('/shared/disk/')>0||R.test(l)))c.isFileLink=true,s.callback(c);else if(!t.get('isError')&&l.indexOf('/extract/')>0)c.contragentCard=function(){var e=l.substring(0,l.lastIndexOf('/'));return e.substring(e.lastIndexOf('/')+1);}(),s.callback(c);else if(!t.get('isError')&&l.indexOf('/cncard')>0)c.contragentCard=JSON.parse(v.decode(decodeURIComponent(l.substring(l.indexOf('editParams=')+11))))['pk'],s.callback(c);else if(!t.get('isError')&&l.indexOf('/person/')>0)c.personCard=l.substring(l.lastIndexOf('/')+1),s.callback(c);else if(!i._options.fullScreenMode)i._getDecoratedLink(l).addCallback(function(e){c.decoratedLink=e,s.callback(c);});else s.callback(c);}else r.getFileInfo(t,i._options.mainOptions).addBoth(function(e){if(e instanceof Error)t._options.noRights=E(e),t._options.notFound=b(e),t._options.isError=!t._options.noRights&&!t._options.notFound;s.callback(c);});return s.addCallback(function(e){var o=e.hash,a=e.rec,s=a.get('linkedRecord')||a,d=new f(),c=r.getFileExtension(s.get('fileName')),l=s.get('typeDoc'),h=s.get('versionForm')&&'null'!==s.get('versionForm')&&l&&'null'!==l&&'ДокументКл'!==l;if(o!==i._hash)return;if(i._$activeControl)i._$activeControl.remove(),i._$activeControl=null;if(i._saveRec(a),!i.isEditMode())i.reCreatePanel(i.savedRec,{dontUpdatePanelCounters:n});if(s._options.noRights||s._options.notFound)i.createIFrame(s,o);else if(s.isEncrypted())i._showIndicatorAsync(o),i._readAttachmentInfo(i._options,s).addCallbacks(function(e){if(h)i._showEncryptedFed(s,e);else i._showCrypt(s,e);},function(e){i._removeIndicator(),w(e);});else if('pdf'===c&&i.isEditMode())i._showPDFAsImages(s),i._showIndicatorAsync(o);else if(e.isEDODialogCardLink)i._showEDODialogCard(s,e.url),i._showIndicatorAsync(o);else if(e.isFileLink&&!a.get('linkedRecord'))i._showFileByLink(a,e.url),i._showIndicatorAsync(o);else if(r._isFileExtensionIn(c,i.audioExts))i._showAudioPlayer(s);else if(h&&!s.has('redactionId'))i._showFedTemplate(s),i._showIndicatorAsync(o);else if(h&&!s.get('errorText'))return i._showFED(s).addCallback(function(e){if(e)i.savedRec._options.printTemplateId=e,t._options.printTemplateId=e,i.reCreatePanel(i.savedRec);i._notify('onShowFile',a),d.callback();}).addErrback(function(e){if(I(e))i.savedRec.set('errorText',e.message),i.savedRec._options.isError=true;else i.savedRec._options.notFound=true,i.savedRec.set('notFound',true),w(e);i.reload(true),d.errback(e);}),i._showIndicatorAsync(o),d;else if(e.decoratedLink)i._showDecoratedLink(e.decoratedLink);else if(r._isFileExtensionIn(c,i.archiveExts)&&'undefined'===typeof s.get('errorText')&&!s._options.isError&&('number'!==typeof s.get('size')||s.get('size')<100*1024*1024))i._showArchive(s),i._showIndicatorAsync(o);else if(e.contragentCard)i._showContragentCard(t,e.contragentCard),i._showIndicatorAsync(o);else if(e.personCard)i._showPersonCard(t,e.personCard),i._showIndicatorAsync(o);else{var d=new f();if(i.isEditMode())if(r._isFileExtensionIn(c,i.editInBrowse))d=r.setLock({lock:true,options:i._options.mainOptions,record:a}).addErrback(function(e){if(409===e.httpError)e.message=rk('Вы уже редактируете этот документ.');return w(e,function(){if(i._notify('onShowFile'),i._options.viewOptions.mode='view',i._options.viewOptions.justAttach)i.startCommand('closeFullScreen',[i.savedRec]);});});else d.callback();else if(!s.isImage()||!i._options.fullScreenMode||s.get('redactionId')||n||!Object.keys(i._getCommandsCountersToUpdate(i.getCommands(s),s)).length)d.callback();else i.subscribeOnceTo(i,'onReadAttachmentInfo',function(e,t){s.set({hash:t.get('hash'),redactionId:t.get('redactionId')}),d.callback();});d.addCallback(function(e){var t=s;if(e&&e.record)(t=s.clone())._options=C(s._options),t._options.objectName=e.objectName,t._options.serviceUrl=e.serviceUrl,t.merge(e.record);i.createIFrame(t,o);});}});},_getDecoratedLink:function(e){var t=new f();return require(['js!SBIS3.Engine.Utils.LinkDecorateUtil'],function(n){t.dependOn(n.decorateLink(e).addCallback(function(t){return t.decorated?t.html:e;}));},function(e){t.errback(e);}),t;},_showDecoratedLink:function(e){if(this._removeIFrame(),this._$activeControl)this._$activeControl.remove(),this._$activeControl=null;if(this._$activeControl=$('<div class="docview-decoratedLink ws-basic-style"><div style="text-align: left; display: inline-block;">'+e+'</div></div>'),this._options.fullScreenMode)this._$activeControl.css({'padding-top':S+'px',height:this._getViewerHeight()+'px'});this.getContainer().append(this._$activeControl),this._notify('onShowFile',this.savedRec);},reCreatePanel:function(e,t){t=t||{};var n=this,i=e||this.savedRec,o=this.getCommands(i);if(t.saveButtonsEnabled&&this._commandPanel&&!this._commandPanel.isDestroyed()){var a={};this._commandPanel._forEachCommandControl(function(e){a[e.getName()]=e.isEnabled();}),this.subscribeOnceTo(this,'onCreateCommandPanel',function(e,t){t._forEachCommandControl(function(e){var t=e.getName();if(a.hasOwnProperty(t)&&e.isEnabled()!==a[t])e.setEnabled(a[t]);});});}this._loadCommandModules(o).addCallback(function(e){n.createPanel(e,i,n._hash,t.dontUpdatePanelCounters);});},_createIFrameElement:function(){return $('<iframe class="docview-iFrame" allowfullscreen="allowfullscreen" mozallowfullscreen="mozallowfullscreen" msallowfullscreen="msallowfullscreen" oallowfullscreen="oallowfullscreen" webkitallowfullscreen="webkitallowfullscreen"></iframe>');},_getIFrameSrc:function(e,i,o){o=o||{};var a=[],s=[],d=['id='+this.getId()],c=r.getFileExtension(e.get('fileName'))||'unknown',l=this._getServiceUrl(e),h=this._getObjectName(e),f=e.get('size')||e.get('Size'),u=1048576;function m(e){if(s.push('iserror=1'),e)s.push('errorText='+encodeURIComponent(e));}if(this.isEditMode()&&l.indexOf('disk/api/v1')>-1)l='/';if(e.get('imageUrl'))h='ws-image',l=e.get('imageUrl');if(a.push(window.location.protocol+'//'+window.location.host,'docview/doc',window.location.protocol.split(':')[0],encodeURIComponent(l),encodeURIComponent(h),encodeURIComponent(e.get('attachId')),encodeURIComponent(e.get('redactionId')),encodeURIComponent(e.get('hash')||'null'),encodeURIComponent(c)),r._isFileExtensionIn(c,this.pdfExts)&&n.browser.isMacOSMobile&&f>10*u)a.push(f);if(this._options.fullScreenMode)d.push('fullScreenMode=1');if(d.push('height='+i),this._options.viewOptions.showMarker)d.push('showMarker=1');if(o.notFound||e.get('notFound')||e._options.notFound)s.push('notFound=1');if(o.noRights||e._options.noRights)s.push('noRights=1');if(o.isError)m(o.errorText);if(f>10*u&&r._isFileExtensionIn(c,this.excelExts))m('К сожалению, невозможно открыть эту книгу в Excel Online, так как ее размер превышает ограничение на размер файла (10 МБ).');if(e.get('errorText'))if(m(e.get('errorText')),e.isLink())s.push('buttonCaption='+encodeURIComponent('Перейти по ссылке'));if(r._isFileExtensionIn(c,this.videoExts)){var _=r.getSyncPreviewUrl(this.savedRec,{width:1900,height:900});d.push('videoPosterUrl='+encodeURIComponent(_));}if(r._isFileExtensionIn(c,this.archiveExts)&&f>100*u)m(rk('Размер архива превышает 100МБ'));if('txt'===c&&f>u)m(rk('Размер текстового файла слишком большой для безопасного отображения'));if(this.isEditMode())s.push('mode=edit');if(!e.get('hash'))t.resolve('ILogger').info('SBIS3.DOCVIEW.View: Для файла не указан hash, из-за этого страница не кешируется! См. https://wi.sbis.ru/doc/docview/api/#attachlist'),s.push('nocache=1');if(r._isFileExtensionIn(c,this.officeExts.concat(this.editInBrowse,this.wordExts))){var g=r.checkDeviceSupportOfficeOnline(this.isEditMode());if(!g.word&&r._isFileWithExtensions(c,['docx','doc','docm'])||!g.excel&&r._isFileWithExtensions(c,['xls','xlsx'])||!g.powerpoint&&r._isFileWithExtensions(c,['ppt','pptx']))m(rk('К сожалению, Office Online не поддерживается на вашем устройстве'));}return a.join('/')+'/?'+s.join('&')+'#'+d.join('&');},createIFrame:function(t,n,i){if(n!==this._hash)return;var o=r.getFileExtension(t.get('fileName'))||'unknown',a='docview-notLoadedYet',s=this._getViewerHeight(),d=this._getIFrameSrc(t,s,i);if(r._isFileExtensionIn(o,this.editInBrowse.concat(this.officeExts).concat(this.editOnlyInApp)))if(a+=' '+F,r._isFileExtensionIn(o,['ppt','pptx','odp']))a+=' docview-pptx-background';else a+=' docview-white-background';this._iFrame=this._createIFrameElement().addClass(a).attr({id:this._ifr_id=e.randomId(),height:s,src:d}).on('load',function(e){if(e.target===this._iFrame&&!this._getIframeWindow())w(new Error(rk('Сервис визуализации временно недоступен.'))),this.reCreatePanel();}.bind(this)).appendTo(this.getContainer())[0],this._showIndicatorAsync(n);},_showIndicator:function(){this._removeIndicator(),this._waitIndicatorStopper=new f(),m.make({target:this.getContainer(),delay:0},this._waitIndicatorStopper);},_showIndicatorAsync:function(e){var t=this;if(t._hash===e)clearTimeout(this._iframeTimeout),this._iframeTimeout=setTimeout(function(){t._showIndicator();},1000);},_removeIndicator:function(){if(clearTimeout(this._iframeTimeout),this._waitIndicatorStopper&&!this._waitIndicatorStopper.isReady())this._waitIndicatorStopper.callback(),this._waitIndicatorStopper=null;},_destroyCommandPanel:function(e){if(e=e||this._commandPanel,e&&!e.isDestroyed())e.destroy();},_checkEditCommand:function(e,t,n,i,o){if(this._createPanelHash!==n)return;for(var a=this,s,d=-1,c=0;c<e.length;c++)if('edit'===e[c].name)s=e[c];else if('editInApp'===e[c].name)d=c;if(s||d>=0){var l=r.getFileExtension(t.get('fileName')),h=r._isFileExtensionIn(l,this.editInBrowse),u=this.getEditInAppChecking(l),m='boolean'===typeof u?u:void 0;if(d>=0)if(m&&h||false===m)if(o)i.addCallback(function(e){return e.removeCommand('editInApp'),e;});else e.splice(d,1);else if(o)i.addCallback(function(t){return t.showCommand('editInApp'),e[d].hidden=false,t;});else if(void 0===m)e[d].hidden=true;if(s)s.isMenu=m&&h;if(m&&h){if(o)i.addCallback(function(e){return e.rerenderCommand('edit'),e;});}else if(void 0===m){if(this.isEnabled()&&'edit'!==this._options.viewOptions.mode){if(!(u instanceof f))u=this._startPluginForCheck([l]);u.addCallback(function(){if(a._createPanelHash===n)a._checkEditCommand(e,t,n,i,true);}).addErrback(function(){i.addCallback(function(e){return e.removeCommand('editInApp'),e;});});}}else if(m&&true===u&&e[d].hidden)e[d].hidden=false;}},_updatePanelCounters:function(e,t,n,i){var o=this,a=this._getCommandsCountersToUpdate(e,t),s=Object.keys(a);if(s.length)o._readAttachmentInfo(this._options,t).addCallback(function(e){if(n!==o._createPanelHash)return;var d=[],c;s.forEach(function(e){Array.prototype.push.apply(d,a[e]);}),c=p(t,e,d),i.addCallback(function(n){return s.forEach(function(e){if(a[e].some(function(e){return c.hasOwnProperty(e);}))n.rerenderCommand(e);}),t.set('signs',r._getValidSignsValue(t,e)),t.set('CountSigns',e.get('CountSigns')),t.set('idPreviousRedactionSign',e.get('idPreviousRedactionSign')),n.rerenderCommand('signs'),n;});});},_getCommandsCountersToUpdate:function(e,t){var n={redactions:['redactionsNumber','countRedactions'],sendMessage:['countMessages'],rights:['countRights']},i={};return e.forEach(function(e){if(n.hasOwnProperty(e.name)){var o=n[e.name];if(o.every(function(e){return null==t.get(e);}))i[e.name]=o;}}),i;},createPanel:function(e,t,n,i){if(this._subscribed||t.get('folder@')||n!==this._hash)return;this._createPanelHash=new Date().getTime();var o=this,a=new f(),r=!t.get('versionForm')||!!this._options.fullScreenMode;if(!i)this._updatePanelCounters(e,t,this._createPanelHash,a);this._checkEditCommand(e,t,this._createPanelHash,a),this._loadCommandModules(e).addCallback(function(e){if(o.isDestroyed())return;var n=o._commandPanel;if(n)setTimeout(function(){o._destroyCommandPanel(n);},1);o.getContainer().find('.docview-CommandPanel:not(.painter-Panel)').remove(),o.getContainer().toggleClass('docview-View__has-title',r),o._commandPanel=new s({element:$('<div>').prependTo(o.getContainer()),commands:e,records:[t],mainOptions:o._options.mainOptions,enabled:true,fullScreenMode:!!o._options.fullScreenMode,name:'CommandPanel',allowChangeEnable:false,parent:o,handlers:{onClickCmd:function(e,t,n){o.startCommand(t,n.records,n);}}}),a.callback(o._commandPanel),o._notify('onCreateCommandPanel',o._commandPanel),o._updateScaleLabel(o.savedRec);});},_showAudioPlayer:function(e){var t=this,n=$('<div>').addClass('docview-AudioPlayer docview-notLoadedYet');if(this._options.fullScreenMode)n.addClass('docview-needSetHeight');this.getContainer().append(n),this._removeIFrame(),this._removeIndicator(),requirejs(['js!SBIS3.DOCVIEW.AudioPlayer'],function(i){if(!t._isRecordKeyEqualToSaved(e))return;t._activeControl=new i({src:r.getUrlForDownloadFile(e,t._options.mainOptions),element:n,opener:t,name:'AudioPlayer',handlers:{onReady:function(){setTimeout(function(){t._notify('onShowFile',t.savedRec);},1);}}});});},_getIdForPDF:function(e){return['http://'+window.location.host,this._options.mainOptions.objectName,e.get('attachId'),e.get('redactionId')].join(';');},_onKeyPressed:function(e,t){var n=this._getIframeWindow();if(70===t.keyCode&&n&&'pdf'===n.getPreClass())if(t.preventDefault(),false===n.keypress(t))t.stopPropagation();},_reloadIframe:function(e){if(!this.getIframeWindow())return;var t=new f(),n=this;if(e.isError){var i=['zoomPlus','zoomMinus','rotateLeft','rotateRight','saveChanges','imageEdit','editOnly','originalImage','editPdf'],o=function(i){if(e.notFound=b(i),e.noRights=E(i),502===i.status||503===i.status||!I(i))e.errorText=rk('Сервис на техническом обслуживании.')+'<br/>'+rk('Мы знаем об этом и уже исправляем. Попробуйте заглянуть сюда через 15 минут.');else if(e.notFound||e.noRights)if(e.onlyRecreatePanel=false,n._commandPanel)a(['edit','signDocument','print','upload','encrypt']);t.callback();};if(this._commandPanel)a(i);if(this.savedRec._options.isError=true,e.error)o(e.error);else r.readAttachmentInfo({objectName:this._options.mainOptions.objectName,serviceUrl:this._options.mainOptions.serviceUrl,id:this.savedRec.get('attachId')}).addCallbacks(function(){t.callback();},o);}else t.callback();t.addCallback(function(){if(e.needReload)this.reload(true);else if(!e.onlyRecreatePanel)this._oldIFrames.push(this._getIFrame()),this.createIFrame(this.savedRec,this._hash,e);}.bind(this));function a(e){e.forEach(function(e){n._commandPanel.hideCommand(e);});}this._notify('onErrorShowFile',this.savedRec);},saveFedDocument:function(){var e=this,t=this._activeControl&&this._activeControl.isChanged&&this._activeControl.isChanged(),n=this._savingDeferred&&!this._savingDeferred.isReady(),i;if(!t)return n?this._savingDeferred:f.success();if(i=new f(),n)this._savingDeferred.dependOn(i);else this._savingDeferred=i;var o={saveWithValidation:true},a=function(){e._activeControl.saveDocument().addCallback(function(){i.callback();});};if(false!==e._notify('onBeforeSaveFedDocument',o))if(!o.saveWithValidation)a();else this._activeControl.validateFLC().addCallback(function(e){if(e)a();else i.errback(new Error(rk('Некорректно заполнены обязательные поля!')));});return i;},_showEncryptedFed:function(e,t){var n=this,i={attachId:e.get('attachId'),redactionId:e.get('redactionId')||null,objectName:this._getObjectName(e),serviceUrl:this._getServiceUrl(e)};this.getContainer().addClass('docview-white-background'),require(['js!SBIS3.DOCVIEW.Encryption','Core/base64'],function(o,a){return o.downloadDecryptedAttachment(i,t).addCallback(function(i){if(!i||!i['Данные'])return new Error(rk('Не удалось получить расшифрованное содержимое'));return n._visualizeDecryptedFed(e,a.decode(i['Данные'],'AUTO'),t);}).addErrback(function(i){if('cancel'!==i.message)w(i);n._showCrypt(e,t);});});},_visualizeDecryptedFed:function(e,t,n){var i=this;requirejs(['js!SBIS3.DOCVIEW.EncryptedFedView'],function(o){var a=$('<div>').addClass('docview-EncryptedFedView');if(!t)return void i._showCrypt(e,n);i._destroyActiveControl(),i._activeControl=new o({element:a.appendTo(i.getContainer()),parent:i,name:'EncryptedFedView',isDisk:i._options.mainOptions.isDisk||false,showRecord:e,xmlData:t,formatRecord:i._createFEDFormatRecord(e),handlers:{onInit:function(){i._notify('onShowFile',i.savedRec);}}});});},_showCrypt:function(e,t){var n=this,i=$('<div>').addClass('docview-CryptView docview-notLoadedYet');if(this.getContainer().addClass('docview-white-background'),n._options.fullScreenMode)n.getContainer().find('.docview-View__controlContainer').append(i.addClass('docview-CryptView__large'));else n.getContainer().append(i);requirejs(['js!SBIS3.DOCVIEW.EncryptView'],function(o){if(!n._isRecordKeyEqualToSaved(e))return;n._destroyActiveControl();var a=r.getFileOpt(e.get('fileName')),s=t.get('RecipientsInfo');n._activeControl=new o({element:i,parent:n,name:'cryptView',linkedContext:n.getLinkedContext(),msgText:!s?rk('Документ зашифрован'):rk('Документ зашифрован для пользователей')+':',icoFont:a['ico_font'],extension:a.isUnknown?a.extension:void 0,color:a['color'],isDisk:n._options.mainOptions.isDisk||false,showRecord:e,certificatesRS:s,isAuthenticated:r.isAuthenticated(),mainOptions:n._options.mainOptions,handlers:{onReady:function(){setTimeout(function(){n._notify('onShowFile',n.savedRec);},1);}}});});},_showEDODialogCard:function(e,t){var n=this,i=$('<div>').addClass('docview-notLoadedYet edo-DialogCard--border'),o=/[\\?&]guid=([^&#]*)/.exec(t),a=o&&o[1],s=function(){var e=n.savedRec;e.set('isError',true),n.savedRec=null,n.paint(e);};if(a)requirejs(['js!SBIS3.EDO2.DialogCard'],function(t){if(!n._isRecordKeyEqualToSaved(e))return;if(n._options.fullScreenMode)n.getContainer().find('.docview-View__controlContainer').append(i);else n.getContainer().append(i);n._activeControl=new t({docId:a,opener:n,largeCard:true,hover:true,inNewTabOnly:true,element:i,handlers:{onReady:function(){setTimeout(function(){n._notify('onShowFile',n.savedRec);},1);},onErrorReadData:function(e){e.setResult(false),s();}}});});else s();},_showFileByLink:function(e,t){var n=this,i=t.indexOf('/shared/disk/')>0,o,a,s,d,c,l={document:'Документ',disk:'FileSD',candidatescans:'CandidateScans',staffscans:'PrivateFaceScans'},h=true;if(i)d='FileSD',c='/disk/api/v1/',s=/\/shared\/disk\/([^&#?/ ]*)/.exec(t),o=s[1];else s=R.exec(t),o=s[3],a=s[1],d=/objectName=([a-z0-9%\-]+)/i.exec(t),c=/serviceUrl=([a-z0-9%\-]+)/i.exec(t),d=d?decodeURIComponent(d[1]):l[a],c=c&&decodeURIComponent(c[1]),h=window.location.protocol+'//'+window.location.host===t.match(/^(https?:)\/\/([^:\/?#]*)/)[0];if(!d||!h)return f();requirejs(['js!SBIS3.DOCVIEW.DocviewModel'],function(t){if(!n._isRecordKeyEqualToSaved(e))return;var a,s={endpoint:d},l=function(e){if(e=e||{},n._options.fullScreenMode)n.savedRec.set('isError',true),h(null,e.message);else f().addErrback(function(){h(null,e.message);});};if(c)s.endpoint={contract:d,address:c+'service/'};if(a=new u(s),i)r.readByObject(o).addCallback(function(e){if(0===e.get('Type')){if(n._options.fullScreenMode)return l();return f();}return m(e.get('Id'));}).addErrback(l);else m(o).addErrback(l);function h(t,i){if(!n._isRecordKeyEqualToSaved(e))return;if(t)n.savedRec.set('linkedRecord',t);if(i)n.savedRec.set('errorText',i);n.reload(true);}function m(e){return a.call('ReadAttachmentInfo',{'ИдО':e}).addCallback(function(n){var i=new t();i.merge(n.getRow()),i.set({attachId:e,objectName:d,serviceUrl:c}),h(i);});}});function f(){return n._getDecoratedLink(t).addCallback(function(e){n._showDecoratedLink(e);});}},_showPDFAsImages:function(e){var t=this,n=$('<div>').addClass('docview-notLoadedYet docview-needSetHeight').height(this._getViewerHeight());requirejs(['js!SBIS3.DOCVIEW.PDFView'],function(i){if(!t._isRecordKeyEqualToSaved(e))return;t.getContainer().append(n),t._activeControl=new i({record:e,objectName:t._options.mainOptions.objectName,element:n,parent:t,name:'PDFView',_id:t._getIdForPDF(e)}),t.subscribeOnceTo(t._activeControl,'onFirstPageLoad',function(){t._notify('onShowFile',t.savedRec);}),t.subscribeOnceTo(t._activeControl,'onError',function(e,n){t._options.viewOptions.mode='view',t._destroyActiveControl(),t._removeIndicator(),w(n);});});},_showContragentCard:function(e,t){var n=this,i=$('<div>').addClass('docview-notLoadedYet docview-contragentMiniCard');requirejs(['js!SBIS3.Contragents.ContragentMiniCard'],function(o){if(!n._isRecordKeyEqualToSaved(e))return;if(n._options.fullScreenMode)n.getContainer().find('.docview-View__controlContainer').append(i);else n.getContainer().append(i);n._activeControl=new o({element:i,parent:n,key:-1*t,write:false}),n._notify('onShowFile',n.savedRec);});},_showPersonCard:function(e,t){var n=this,i=$('<div>').addClass('docview-notLoadedYet docview-contragentMiniCard');requirejs(['js!SBIS3.PersonalOffice.MiniCard'],function(o){if(!n._isRecordKeyEqualToSaved(e))return;if(n._options.fullScreenMode)n.getContainer().find('.docview-View__controlContainer').append(i);else n.getContainer().append(i);n._activeControl=new o({element:i,parent:n,oid:t}),n._notify('onShowFile',n.savedRec);});},zoom:function(e){var t=this._activeControl;if(t&&!t.isDestroyed()&&'function'===typeof t.zoom)t.zoom(e),this.switchStateOneCommand('zoomMinus',t.canReduceZoomValue()),this.switchStateOneCommand('zoomPlus',t.canEncreaseZoomValue());else this.getIframeWindow().zoom(e);},_showArchive:function(e){var t=this;requirejs(['js!SBIS3.DOCVIEW.ArchiveView','Core/Context','js!SBIS3.DOCVIEW.List.DiskClassicColumns'],function(n,i,o){if(!t._isRecordKeyEqualToSaved(e))return;var a=t._getObjectName(e),s=t._getServiceUrl(e),r=$('<div>').addClass('docview-notLoadedYet docview-needSetHeight'),d=i.createContext(t),c=C(t._options.viewOptions),l={autoQuery:true,multiselect:false,wrapInScrollContainer:true,visibilityMode:{setFromCookie:false,defaultMode:'diskClassic'},root:e.get('attachId')+'_ZIP',itemsDragNDrop:false,columns:o.getColumns(['title','size'])},h={ctxLinkId:'????',fixId:['http://'+window.location.host+s+'service/',a,e.get('attachId'),e.get('redactionId')||''].join(';'),useOnlyCtx:false,objectName:'Archive',serviceUrl:'/docview/',isDisk:false,commands:{deleteDoc:false,directLink:false,addPage:false,edit:false,redactions:false,copyToDisk:false,deletePermanentlyDoc:false,editInApp:false,move:false,print:false,rename:false,signDocument:false,sendMessage:false,rights:false,upload:true,saveToPdf:false,links:false,copyToBuffer:false,fullScreen:true},userCommands:[]};d.setValue('mainOptions',h),c.justAttach=false,t.getContainer().append(r),t._activeControl=new n({element:r,record:e,name:'ArchiveView',mainOptions:h,viewOptions:c,listOptions:l,fullScreenMode:t._options.fullScreenMode,_gotozip:true,context:d,enable:true,parent:t}),t.subscribeOnceTo(t._activeControl,'onDrawItems',function(){if(e.get('attachId')==t.savedRec.get('attachId')||t.savedRec.get('linkedRecord')===e)t._notify('onShowFile',t.savedRec);else t._oldActiveControls.push(t._activeControl);}),t.subscribeOnceTo(t._activeControl,'onDataLoadError',function(e,n){var i=n.details.indexOf('100Мб')>-1?n.details:'';t.savedRec.set('errorText',i),t.reload(true);});});},_showFED:function(e){var t=this,n=$('<div>').addClass('docview-View__FED docview-notLoadedYet').attr({'data-file-id':e.get('attachId'),'data-file-hash':e.get('hash')}),i=new f();return requirejs(['js!SBIS3.FED.Document','preload!js!SBIS3.FED.CheckFLC','Deprecated/Record'],function(o,a,s){var d=t._options.viewOptions.mode;if('edit'!==d&&e.get('editable'))d='edit';if(!t._isRecordKeyEqualToSaved(e)||!t.savedRec.get('versionForm')&&!t.savedRec.get('linkedRecord')||t._activeControl&&!t._activeControl.isDestroyed()&&t._activeControl.getContainer().attr('data-file-id')===t.getAttachmentId()&&t._activeControl.getContainer().attr('data-file-hash')===t.savedRec.get('hash')&&t._activeControl.documentId()===t.savedRec.get('redactionId')&&t._activeControl.getMode()===d)return;var c=new s(),l=t._createFEDFormatRecord(e,s),h=t._getObjectName(e),f=t._options.viewOptions.showStampFED?'Документ.ReadStampInfo':'';if(e.get('countError'))c.addColumn('КоличествоОшибок',s.FIELD_TYPE_INTEGER),c.set('КоличествоОшибок',parseInt(e.get('countError'),10));if(e.get('countRedactions')>1){var u=new s();u.addColumn('Название',s.FIELD_TYPE_STRING),u.set('Название','Изменения'),c.addColumn('СценарийОбработки',s.FIELD_TYPE_RECORD),c.set('СценарийОбработки',u);}if(('print'===d||'view'===d)&&parseInt(e.get('redactionId'),10)>0){c.addColumn('ИмяМетода',s.FIELD_TYPE_STRING),c.set('ИмяМетода',f),c.addColumn('ПараметрыМетода',s.FIELD_TYPE_RECORD);var m=new s();if(m.addColumn('ИдО',s.FIELD_TYPE_STRING),m.set('ИдО',e.get('redactionId')),c.set('ПараметрыМетода',m),e.has('specificationId'))c.addColumn('СпециализацияСпособа.ИдентификаторСпециализации',s.FIELD_TYPE_STRING),c.set('СпециализацияСпособа.ИдентификаторСпециализации',e.get('specificationId'));}if(t._options.fullScreenMode)n.height(t._getViewerHeight());else n.width(t.getContainer().width());t.getContainer().append(n);var _=r.getServiceUrl(t._getServiceUrl(e)),g={'ПараметрыОтображения':c,'ИдО':e.get('redactionId'),'ИмяОбъекта':h,forceEdit:true,'ФорматДокумента':l,element:n,parent:t,autoWidthContent:t._options.viewOptions.autoWidth,autoHeight:true,serviceUrl:_,autosave:t._options.mainOptions.autoSaveFED?10000:null,mode:d,journalOptions:{objectId:e.get('redactionId')+'$'+h,objectName:'Документ'}};if(e.get('canEdit'))g.enable=true,g.allowChangeEnable=false;var v=t._notify('onStartShowFedDocument',e,g);if(v)g=v;if('edit'===g.mode)a();if(t._activeControl)t._oldActiveControls.push(t._activeControl);t._activeControl=new o(g),t.subscribeTo(t._activeControl,'onFocusOut',function(e,n,i){if(!i||'function'!==typeof i.isAutoHide||!i.isAutoHide())t.saveFedDocument();}),t.subscribeTo(t._activeControl,'onReady',function(e,n,o){if(o){var a=new Error(o.message),s;if(o.payload)s=JSON.parse(o.payload).error.message;else s=o.details;a.details=s,i.errback(a);}else if(!i.isReady())i.callback(this.getPrintTemplateId());t._notifyOnSizeChanged();});}),i;},_showFedTemplate:function(e){var t=this,n=$('<div>').addClass('docview-View__FED docview-notLoadedYet');requirejs(['js!SBIS3.FED.SubTypeVisualisationView'],function(i){var o=new l({format:e.getFormat(),adapter:'adapter.sbis'});o.set(e.getRawData()),t.getContainer().append(n),t._activeControl=new i({element:n}),t._activeControl.setDocument({'ФорматДокумента':o}),t.subscribeTo(t._activeControl,'onReady',function(){t._notify('onShowFile',t.savedRec);});});},_createFEDFormatRecord:function(e,t){var n=!t?new l({adapter:'adapter.sbis'}):new t();if(!t)n.addField({name:'ТипДокумента',type:'string'}),n.addField({name:'ПодТипДокумента',type:'string'}),n.addField({name:'ВерсияФормата',type:'string'}),n.addField({name:'ПодВерсияФормата',type:'string'});else n.addColumn('ТипДокумента',t.FIELD_TYPE_STRING),n.addColumn('ПодТипДокумента',t.FIELD_TYPE_STRING),n.addColumn('ВерсияФормата',t.FIELD_TYPE_STRING),n.addColumn('ПодВерсияФормата',t.FIELD_TYPE_STRING);return n.set('ТипДокумента',e.get('typeDoc')),n.set('ПодТипДокумента',e.get('subTypeDoc')),n.set('ВерсияФормата',e.get('versionForm')),n.set('ПодВерсияФормата',e.get('subVersionForm')),n;},openProtocolDLC:function(){if(this._activeControl)this._activeControl.open();},_hideTransparentDiv:function(){this.getContainer().removeClass('docview-CatchClick');},_showTransparentDiv:function(){this.getContainer().addClass('docview-CatchClick');},getAttachmentId:function(){return this.savedRec&&this.savedRec.get('attachId');},_isRecordKeyEqualToSaved:function(e){function t(e){return e?e.get('linkedRecord')?e.get('linkedRecord').get('attachId'):e.get('attachId'):'';}return t(e)===t(this.savedRec);},getCommandPanel:function(){return this._commandPanel;},_updateScaleLabel:function(e,t){if(!this.hasChildControlByName('zoomMinus')||!e)return;var n=this.getContainer().find('.dv-command--scaleLabel'),i;if(e.isImage()){if('number'!==typeof t){var o=this._getIframeWindow();if(o&&o.getCurrentZoomPercent)t=o.getCurrentZoomPercent();else i='   ';}n.text(i||(isNaN(Math.floor(t))?100:Math.floor(t))+'%').removeClass('ws-hidden');}else n.addClass('ws-hidden');},execCommand:function(e,t){var n={addSwipeSwitching:this._onExecCommandAddSwipeSwitching,downloadDocument:this._onExecCommandDownloadDocument,keypress:this._onExecCommandKeyPress,mousemove:this._onExecCommandMousemove,mouseup:this._onExecCommandMouseup,notifyOnFinishCommand:this._onExecCommandNotifyOnFinishCommand,officeDocumentReady:this._onExecCommandOfficeDocumentReady,ready:this._onExecCommandReady,readylight:this._onExecCommandReadylight,reload:this._reloadIframe,resize:this._onExecCommandResize,setEnabledButton:this._onExecCommandSetEnabledButton,setToggleButton:this._onExecCommandSetToggleButton}[e];if(n)n.call(this,t);},_onExecCommandResize:function(e){if(!this.isVisible())return;var t=this._getIframeWindow(),n=t&&t.config,i,o;if(n)i=$(t.frameElement),o=!this._options.fullScreenMode?t.getHeight():this._getViewerHeight(),i.height(o);else if(this._activeControl&&!this._activeControl.isDestroyed()&&this._activeControl.getContainer().hasClass('docview-needSetHeight'))this._activeControl.getContainer().height(this._getViewerHeight()+S);if(n&&e&&e.h)t.setNewHeight(e.h);if(this._commandPanel)this._commandPanel.resize();this._notifyOnSizeChanged();},_onExecCommandOfficeDocumentReady:function(){var e=this._iFrame;if(setTimeout(function(){$(e).removeClass(F);},1000),this._options.mainOptions.isCreate)this.waitChildControlByName('CommandPanel').addCallback(function(e){if(e.hasChildControlByName('rename')){var t=e.getChildControlByName('rename').getChildControlByName('editName');t.setInPlaceEditMode(true),t.setActive(true);}return e;});else if(this._options.viewOptions.justAttach&&this._options.fullScreenMode&&'function'===typeof window.callPhantom)this._takeShotWhenFileWillBeLoaded();this._notify('onOfficeDocumentReady');},_onExecCommandKeyPress:function(e){this._notify('onKeyPressIframe',e);},_onExecCommandDownloadDocument:function(){if('url'===this.savedRec.getFileExtension())return void this.startCommand('linkActivated',[this.savedRec]);this.startCommand('upload',[this.savedRec]);},_onExecCommandNotifyOnFinishCommand:function(e){if(this.hasChildControlByName(e))this._notify('onFinishCommand',e,{records:this.getChildControlByName(e)._getRecords()});},_onExecCommandSetEnabledButton:function(e){this.switchStateOneCommand(e.id,e.enable);},_onExecCommandSetToggleButton:function(e){this.switchVisibleOneCommand(e.id,e.enable);},_onExecCommandReadylight:function(){this._notify('onReadyFile',this.savedRec);},_onExecCommandReady:function(){var e=this._getIframeWindow();if(e&&'pdf'===e.getPreClass())$(this._iFrame).removeClass(F);this._notify('onShowFile',this.savedRec);},_onExecCommandMouseup:function(){$(this._iFrame).trigger('mouseup');},_onExecCommandMousemove:function(e){var t=$(this._iFrame),n=t.offset();if(n)e.event.clientX+=n.left,e.event.clientY+=n.top,e.event.offsetX+=n.left,e.event.offsetY+=n.top,e.event.pageX+=n.left,e.event.pageY+=n.top,e.event.target=t[0],t.trigger(e.event);},_onExecCommandAddSwipeSwitching:function(e){this._addSwipeSwitching(e);},_getServiceUrl:function(e){return e.getServiceUrl()||this._options.mainOptions.serviceUrl;},_getObjectName:function(e){return e.getObjectName()||this._options.mainOptions.objectName;},_addSwipeSwitching:function(e){var t=this,n,i,o,a=150,s=150,r=200,d,c=$(e.movingContainer),l=$(e.scrollContainer),h=parseInt(c.css('margin-left'),10),f,u,m,_=false,g=function(e){var t=e.originalEvent.changedTouches[0];o=0,n=t.screenX,i=t.screenY,d=+new Date();};$(e.target).on('touchstart',g).on('touchmove',function(e){var t=e.originalEvent.changedTouches;if(t.length>1)return;var o=l.scrollLeft();if(o>0&&l.get(0).scrollWidth>=o+l.width())return void(_=true);if(_)_=false,g(e);if(f=t[0].screenX-n,u=Math.abs(f),m=t[0].screenY-i,u>50&&1.5*u>Math.abs(m))c.css('margin-left',f);}).on('touchend',function(e){var l=e.originalEvent.changedTouches[0];if(o=l.screenX-n,+new Date()-d<=s&&Math.abs(o)>a&&Math.abs(l.screenY-i)<=200||u>r)t._notify('onKeyPressIframe',o<0?39:37);else c.animate({duration:200,marginLeft:h});});},isEmpty:function(){return!this.savedRec;},_readAttachmentInfo:function(e,t){var n=this;return r._getAttachmentInfo(e,t).addCallback(function(e){return n._notify('onReadAttachmentInfo',e),e;});}}),y;});
define('js!SBIS3.DOCVIEW.FullViewer',['SBIS3.CONTROLS/CompoundControl','html!SBIS3.DOCVIEW.FullViewer','js!SBIS3.DOCVIEW.Funcs','Core/EventBus','Core/Deferred','Core/CommandDispatcher','js!SBIS3.DOCVIEW.List','js!SBIS3.DOCVIEW.DocviewModel','js!SBIS3.DOCVIEW.CommandPanel','css!SBIS3.DOCVIEW.FullViewer','js!SBIS3.DOCVIEW.View','SBIS3.CONTROLS/Link','Docview_localization'],function(e,t,i,o,n,s,r,a){'use strict';var d;return d=e.extend({_dotTplFn:t,$protected:{_options:{mainOptions:{objectName:'',serviceUrl:'/',serviceBLName:'ОсновнойСервис',ctxLinkId:null,fixId:null,filter:null,useOnlyCtx:true,ctxLinkList:'record/РП.Документ/СписокВложений',redactionWindow:{renderPhotos:true},viewModel:null,commands:{deleteDoc:true,directLink:true,copyToBuffer:true,addPage:false,edit:true,fullScreen:true,print:true,saveToPdf:true,upload:true,zoomMinus:true,zoomPlus:true,links:true,redactions:true,editPdf:false,move:true},multiPage:true,isCreate:false,isOneRec:false,directLinkRouting:'disk',userCommands:[],isDisk:true,autoSaveFED:true},viewOptions:{mode:'view',autoWidth:false,canEditFED:true,showStampFED:false,justAttach:false,showMarker:false},listOptions:{countDocWithoutScroll:5,visibilityMode:{savedModeField:null,setFromCookie:false,autoSelect:false,defaultMode:'classic',changedId:'default',folderAsPreview:false},defaultRecordPK:null,displayField:'title',root:null,itemsDragNDrop:true,pageSize:20,multiselect:false,infiniteScroll:true,needMoreButton:false,allowEmptySelection:false,saveState:false,previewWidth:200,previewHeight:150,hasHierarchy:true,hideEmptyBackButton:false,autoQuery:true,calcMargin:true,emptyHTML:'',showPaging:false,groupBy:{},doNotRequestPreview:false,includedTemplates:{subtitle:null},enableExpand:true,stickyPath:false,goToFolder:true,wrapInScrollContainer:false},hiddenWithOneDoc:true},_typeCmd:'inline',_gotozip:false,_fileEditor:void 0,_list:null,_view:null},_modifyOptions:function(){var e=d.superclass._modifyOptions.apply(this,arguments),t;if(e.hiddenWithOneDoc&&e.listOptions.serializedItems)t=r.deserializeItems(e.listOptions.serializedItems),e._isListVisible=!this._needToHideList(t,e.listOptions);return e;},$constructor:function(){this._publish('onStartCommand','onFinishCommand','onCancelCommand','onErrorCommand','onProcessCommand','onShowFile','onDrawItems','onStartDecrypt','onStartShowFedDocument','onBeforeSaveFedDocument','onItemChanged');},setCommandCfg:function(e,t){this.getView().setCommandCfg(e,t),this.getList().setCommandCfg(e,t);},setMode:function(e){var t=this.getView();this._options.viewOptions.mode=e,t.setMode(e);},_needToHideList:function(e,t){var i;return'bigPreview'!==t.visibilityMode.defaultMode&&e&&1===e.getCount()&&(i=e.at(0))&&!a.prototype.isRequired.call(i)&&!a.prototype.isFolder.call(i)&&!a.prototype.isLink.call(i);},_needToHideViewTitle:function(e,t){var i;return Boolean(e&&1===e.getCount()&&(i=e.at(0))&&!a.prototype.isRequired.call(i)&&i.get('versionForm')||t&&t.get('versionForm'));},_hideListWithOneDoc:function(e){var t=this.getList(),i=this.getView(),o=i.getCommandPanel(),n=this._needToHideList(e,t._options.listOptions),s=this._needToHideViewTitle(e,i.savedRec);if(t.toggle(!n),o)o.resize();i.getContainer().toggleClass('docview-View__has-title',!s);},_onChangeVisibilityMode:function(e,t){var i=this.getList(),o=this.getView();if(this._options.hiddenWithOneDoc)this._hideListWithOneDoc(this.viewerRecordSet);var n='bigPreview'!==t;if(n&&o.getAttachmentId()!=i.getSelectedKey())o.paint(i.getSelectedItem());o.toggle(n);},init:function(){d.superclass.init.call(this);var e=this,t=this.getView(),n=this.getList(),r=n.getTreeView(),a=i.createEventTransmitter(e),c=e._onStartDecrypt.bind(this);if(this.subscribeTo(t,'onStartShowFedDocument',a),this.subscribeTo(t,'onBeforeSaveFedDocument',a),this.subscribeTo(n,'onItemChanged',a),this.subscribeTo(t,'onStartCommand',function(o,n,s){var r=s.records[0];if('saveChanges'===n&&t.savedRec&&r.get('versionForm'))i._getAttachmentInfo(e._options,t.savedRec).addCallback(function(e){t.paint(e);});o.setResult(e._notify('onStartCommand',n,s));}),t.subscribe('onProcessCommand',function(i,o,s){if('redactions'===o){this._changeFileRedaction(s.records[0],s);var r=t.savedRec.get('attachId'),a=t._getDataForMergeFromRedaction(s.records[0],s),d=t.getCommandPanel();if(e.viewerRecordSet.getRecordById(r).setMultiple(a),d)d.resize();n.redrawItemDocview(r,e.viewerRecordSet.getRecordById(r));}i.setResult(e._notify('onProcessCommand',o,s));}),n.setCommandCfg('fullScreen',{isMainAction:true}),n.subscribe('onAccessReady',function(e,i){var o=t.getAttachmentId();if(o&&i.getRecordById(o))t.reload(true);}),s.declareCommand(this,'xmlEdit',function(e){if('bigPreview'===this.getList().getVisibilityMode())this.startCommand('fullScreen',e,{mainOptions:this._options.mainOptions,listOptions:this._options.listOptions,viewOptions:{mode:'edit'}});else t.setMode('edit');}),n.subscribe('onStartCommand',function(i,o,s,r){var a='linkActivated'===o&&r&&r.target&&!r.target.classList.contains('dv-title-text_link'),d=('dynamic_fullScreen'===o||'fullScreen'===o)&&r&&r.inline,c=s.records[0];if(a)this.setSelectedKeySilently(c.getId());if((d||a)&&'bigPreview'!==n.getVisibilityMode()){if(i.setResult(false),r.mainRecord)(c=r.mainRecord.clone()).merge(s.records[0]);t.paint(c);}else i.setResult(e._notify('onStartCommand',o,s));}),t.subscribe('onFinishCommand',function(o,s,r){var a=r.records[0];if('deleteDoc'===s||'imageEdit'===s)n._notify('onFinishCommand',s,r);else if('rename'===s){var d=e.viewerRecordSet&&e.viewerRecordSet.getRecordById(a.get('attachId'));if(d&&d.get('fileName')!==r.finishParams.newTitle)d.set('fileName',r.finishParams.newTitle),d.set('title',r.finishParams.newTitle);n.redrawItemDocview(a.get('attachId'),d),o.setResult(e._notify('onFinishCommand',s,r));}else if('saveChanges'===s&&a.get('versionForm'))t.saveFedDocument().addCallback(function(){t.setMode('view'),o.setResult(e._notify('onFinishCommand',s,r));});else if(['signDocument','encrypt','decrypt'].indexOf(s)>-1)i._getAttachmentInfo(e._options,a).addCallback(function(i){t.reCreatePanel(i,{dontUpdatePanelCounters:true}),n.redrawItemDocview(a.get('attachId'),i),o.setResult(e._notify('onFinishCommand',s,r));});else if('addPage'===s||'saveChanges'===s&&'pdf'===a.getFileExtension())i._getAttachmentInfo(e._options,a).addCallback(function(t){n.redrawItemDocview(a.get('attachId'),t),o.setResult(e._notify('onFinishCommand',s,r));});else o.setResult(e._notify('onFinishCommand',s,r));}),n.subscribe('onFinishCommand',function(o,s,r){var a=t.savedRec,d=r&&Array.isArray(r.records)&&r.records[0],c=d&&d.get('attachId');if(d&&a&&c==a.get('attachId'))if('deleteDoc'===s){if(t.empty(),this.viewerRecordSet.getCount())t.savedRec=a;}else if('rename'===s)t.reCreatePanel();if(['signDocument','encrypt','decrypt'].indexOf(s)>-1&&!d.isFolder())i._getAttachmentInfo(e._options,d).addCallback(function(i){if(!t.isEmpty())t.reCreatePanel(i,{dontUpdatePanelCounters:true});n.redrawItemDocview(c,i),o.setResult(e._notify('onFinishCommand',s,r));});else if('addPage'===s&&r.newRecord)n.redrawItemDocview(c,r.newRecord),o.setResult(e._notify('onFinishCommand',s,r));else if(!this._options.mainOptions.useOnlyCtx&&['move','moveDocuments','scan','scanFromFile','addFromBuffer','attachFromSbisDisk'].indexOf(s)>=0)n.reload(),o.setResult(e._notify('onFinishCommand',s,r));else o.setResult(e._notify('onFinishCommand',s,r));}),n.subscribe('onChangeCommandsSetting',function(e,i){t._notify('onChangeCommandsSetting',i);}),e.subscribeTo(t,'onStartDecrypt',c),e.subscribeTo(n,'onStartDecrypt',c),t.subscribe('onShowFile',a),r){var l=r.getItems();if(l&&l.getCount()&&e._options.hiddenWithOneDoc)e._hideListWithOneDoc(l);}if(n.subscribe('onDataLoad',function(i,o,s){if(e._options.hiddenWithOneDoc)e._hideListWithOneDoc(o);if(!s){var r=t.getAttachmentId(),a=r&&o.getRecordById(r);if(!a||n.getCurrentRoot()!==a.get('folder'))t.empty();}if(!n.getTreeView().getItems())e.viewerRecordSet=o;e._notify('onDataLoad',o);}),n.subscribe('onChangeVisibilityMode',this._onChangeVisibilityMode.bind(this)),n.subscribe('onDrawItems',h),n._listDataLoaded)this.viewerRecordSet=n.viewerRecordSet,h();if(i.isAuthenticated()){var u=function(o,s){var r=n.viewerRecordSet&&n.viewerRecordSet.getRecordById(s.fileId),a=n._doNotHandleDrawItems;if(r)i._getAttachmentInfo(e._options,r).addCallback(function(e){if(t.isVisible())s.attachmentInfo=e,t._officeDocumentChangeHandler(o,s);n._doNotHandleDrawItems=true,n.redrawItemDocview(s.fileId,e),n._doNotHandleDrawItems=a;});};this.subscribeTo(o.serverChannel('wopi.documentHasChanged'),'onMessage',u),this.subscribeTo(o.serverChannel('webdav.documentHasChanged'),'onMessage',u),this.subscribeTo(o.channel('DocviewFileEditorChannel'),'onDocumentChanged',u);}if(n.subscribe('onGoToZip',function(o,n,s){var r=/([a-z0-9%\-_#@%$]+)_ZIP$/.exec(String(s.listOptions.root)),a=r&&r[1],d=a&&e.viewerRecordSet.getRecordById(a);if(s.hiddenWithOneDoc=e._options.hiddenWithOneDoc,t.empty(),i.setAllOptions(t,n),i.setAllOptions(e,n),d&&d._options.isError)this.once('onDrawItems',function(){e.viewerRecordSet.getRecordById(a)._options.isError=true,this.getTreeView().setSelectedKey(a);});}),this.subscribeTo(n,'onMergeFromContext',function(){if(e._options.hiddenWithOneDoc)e._hideListWithOneDoc(this.viewerRecordSet);}),n._options._processAutoClick=true,r){var m=r.getSelectedKey();if(m)n.getChildControlByName('attachments')._notify('onSelectedItemChange',m);}function h(){if(e.viewerRecordSet=n.viewerRecordSet,e._options.hiddenWithOneDoc)e._hideListWithOneDoc(e.viewerRecordSet);var i=t.getAttachmentId();if(i){var o=n.viewerRecordSet.getRecordById(i);if(o&&!o.isRequired())t.paint(o);else if(n.isCurrentFolderEmpty(true))t.empty();}if(!e.getLinkedContext().getValue('redactionsListsCache'))e.getLinkedContext().setValue('redactionsListsCache',{});n._fillInlineRedactionsControls(),e._notify('onDrawItems');}},_onStartDecrypt:function(e,t){var i=this._notify('onStartDecrypt',t);if(i instanceof n)e.setResult(i);},destroy:function(){if(this._options.mainOptions.autoSaveFED)if(this.hasChildControlByName('view'))this.getView().saveFedDocument();this._list=this._view=null,d.superclass.destroy.call(this);},setEnabled:function(e){var t=this.isEnabled();d.superclass.setEnabled.call(this,e);try{if(t!==e)this.reload();}catch(e){}},printDocuments:function(e){return this.getList().printDocuments(e);},reload:function(){this.getList().reload();},empty:function(){var e=this.getList();this.getView().empty();try{e.viewerRecordSet.clear(),e.redraw();}catch(e){}},setProperties:function(e){if(d.superclass.setProperties.call(this,e),e.mainOptions)this.getContext().setValue('internalMainOptions',e.mainOptions);this.getList().setProperties(e);},saveFedDocument:function(){var e=this;if(e.hasChildControlByName('view'))return e.getView().saveFedDocument();},getList:function(){return this._list||(this._list=this.getChildControlByName('list'));},getView:function(){if(!this._view&&this.hasChildControlByName('view'))this._view=this.getChildControlByName('view');return this._view;},setUserCommands:function(e){this._options.mainOptions.userCommands=e,this.getList().setUserCommands(e),this.getView().setUserCommands(e);}}),d;});
define('js!SBIS3.DOCVIEW.addFromBuffer',['tmpl!SBIS3.DOCVIEW.addFromBuffer','js!SBIS3.DOCVIEW.Command','WS.Data/Source/SbisService','Core/EventBus','Core/Deferred','Core/Indicator','js!SBIS3.DOCVIEW.SBISBufferMixin','js!SBIS3.DOCVIEW.AddLinkMixin','SBIS3.CONTROLS/Link','Docview_localization'],function(i,e,n,t,s,o,r,a){'use strict';var c=e.extend([r,a],{$protected:{idCmd:'addFromBuffer',_options:{multiSelect:false,hasClipboardLink:true,icon:'sprite:icon-24 icon-Paste icon-primary',extensions:['jpeg','jpg','png','gif','tif','tiff','pdf','url']},_commandResult:null,_play:function(){var i=this;return this._commandResult=new s(),o.show(1),this.fillBufferList().createDependent().addCallbacks(function(){o.hide(),i.openBufferWindow(2);},function(){o.hide();}),this._commandResult;},init:function(){c.superclass.init.call(this);var i=this;this.subscribeTo(t.channel('SbisBufferEvents'),'onInsertLink',function(e,n,t,s){if(i.getId()===s)i.addLink(n,t);}),this._options.maxFileSizeInMB=this._getCommandOptions().maxFileSizeInMB;},_onFinish:function(i){var e=this._options.records[0],t=this;new n({endpoint:{address:this._options.mainOptions.serviceUrl+'service/',contract:this._options.mainOptions.objectName}}).call('ЗагрузитьТиповойДокумент',{'ИдО':i,'ИдОДок':this._options.mainOptions.fixId,'Название':e.get('title'),'ТипДокумента':e.get('typeDoc'),'ПодТипДокумента':e.get('subTypeDoc')}).addErrback(function(i){require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(e){e.showMessageDialog({status:'error',message:rk('При загрузке файла на сервер произошла ошибка'),details:i&&i.message||'',opener:t});});}).addCallback(function(){t._commandResult.callback();});}},_dotTplFn:i});return c;});
define('js!SBIS3.DOCVIEW.attachFromSbisDisk',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.attachFromSbisDisk','WS.Data/Source/SbisService','Core/Indicator','Core/Deferred','js!SBIS3.DOCVIEW.Funcs','SBIS3.CONTROLS/Link','Docview_localization'],function(e,t,i,o,s,n){'use strict';return e.extend({$protected:{idCmd:'attachFromSbisDisk',_options:{icon:'sprite:icon-24 icon-Unfavourite icon-primary'},_commandResult:null,_play:function(){var e=this,t={destinationFolderId:this._options.mainOptions.fixId,multiselect:false,canSelectFolder:false,onlySelect:true,defaultTypeSwitcher:'copy',disableSwitcher:true},a=new i({endpoint:{contract:e._options.mainOptions.objectName,address:e._options.mainOptions.serviceUrl+'service/'}});return this._commandResult=new s(),require(['js!SBIS3.EDO.CD.AttachFromSbisDisk'],function(i){i.show(t).addCallback(function(t){if(!t||!t.length)return;o.setMessage(rk('Пожалуйста, подождите')),a.call('CreateFileCopy',{Id:t[0].id,IsFolder:false}).addCallback(function(t){a.call('ЗагрузитьТиповойДокумент',{'ИдО':t.getRow().get('Id'),'ИдОДок':e._options.mainOptions.fixId,'Название':e._options.records[0].get('title'),'ТипДокумента':e._options.records[0].get('typeDoc'),'ПодТипДокумента':e._options.records[0].get('subTypeDoc')}).addCallback(function(){o.hide(),e._commandResult.callback(),e.destroy();}).addErrback(function(e){o.hide(),n.alert({message:e.message});});});}).addErrback(function(e){n.alert({message:e.message});});}),this._commandResult;}},_dotTplFn:t});});
define('js!SBIS3.DOCVIEW.closeAttach',['Core/Deferred','js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.closeAttach','css!SBIS3.DOCVIEW.closeAttach','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.closeAttach','Docview_localization'],function(t,e,c){'use strict';return e.extend({$protected:{idCmd:'closeAttach',_play:function(){return window.close(),new t();}},_dotTplFn:c});});
define('js!SBIS3.DOCVIEW.closeFullScreen',['Core/Indicator','Core/Deferred','Core/detection','js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.closeFullScreen','js!SBIS3.DOCVIEW.Funcs','WS.Data/Source/SbisService','css!SBIS3.DOCVIEW.closeFullScreen','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.closeFullScreen','Docview_localization'],function(e,o,n,t,i,s,a){'use strict';return t.extend({_dotTplFn:i,$protected:{idCmd:'closeFullScreen',_play:function(){var t=this,i=s.getFileExtension(t._options.records[0].get('fileName')),r=t._getCommandsManager(),c=r._getIframeWindow(),d=new o();if(t._options.records&&t._options.records[0]&&t._options.records[0].get('versionForm')&&r.isEditMode())r._notify('onStartCommand','saveChanges',{records:t._options.records});if('pdf'===i&&r.isEditMode()&&r._activeControl.isChanged())requirejs(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(e){e.showConfirmDialog({message:rk('Сохранить изменения в документе?'),hasCancelButton:true,opener:r},function e(){r._notify('onStartCommand','saveChanges',{records:t._options.records}),d.callback();},function e(){d.callback();});});else if(r.isEditMode()&&c&&'office'===c.getPreClass()&&-1!==r.editInBrowse.indexOf(i)){if(n.isMobilePlatform){var l=c._getIframeWindow(),f=l&&l.document.activeElement;if(f&&'MainApp'!==f.getAttribute('id'))$('<input type="text">').insertBefore(r.getContainer().find('.docview-CommandPanel_absolute-right')).focus().blur().remove();}setTimeout(function(){var n=new o(),t=setTimeout(function(){e.setMessage(rk('Сохранение')+'...');},150);c.office_saveDocument(n),n.addCallback(function(){d.callback(),e.hide(),clearTimeout(t);});},200);}else d.callback();d.addCallback(function(){if(t._options.viewOptions.justAttach){if(!t._options.mainOptions.isCreate&&'edit'===t._options.viewOptions.mode&&!window.opener){var e=t._options.records?t._options.records[0]:null;return s._getAttachmentInfo(t._options,e).addCallback(function(e){r.savedRec=null,r._options.viewOptions.mode='view',r.paint(e,true);});}if(!r._wasChangedName&&t._options.mainOptions.isCreate&&c&&'office'===c.getPreClass()&&!c.office_isDocumentChanged()){var o=function(){window.close();};s.releaseExclusiveLock(t._options.records[0],t._options.mainOptions).addCallbacks(function(){new a({endpoint:{contract:t._options.mainOptions.objectName,address:t._options.mainOptions.serviceUrl+'service/'}}).call('DeleteAttachments',{Ids:[t._options.records[0].get('attachId')]}).addCallback(function(){r._notify('onFinishCommand','deleteDoc',{records:t._options.records}),window.close();}).addErrback(o);},o);}else window.close();}else r.sendCommand('close');return d;});}}});});
define('js!SBIS3.DOCVIEW.copyToBuffer',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.copyToBuffer','Core/moduleStubs','js!SBIS3.DOCVIEW.Funcs','js!SBIS3.Engine.Clipboard','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.copyToBuffer','Docview_localization'],function(t,e,i,o,n){'use strict';return t.extend({$protected:{idCmd:'copyToBuffer',_toObject:function(t){var e=Boolean(t.get('folder@')),i=t.get('title')||'',o=t.get('fileName')||(e?i:'');if((3===t.get('Type')||t.get('versionForm'))&&!t.getFileExtension())o+='.xml';return{attachId:t.get('attachId')||'',redactionId:t.get('redactionId'),hash:t.get('hash')||t.get('fileHash')||'',fileName:o,title:i,size:t.get('size')||0,objectName:this._options.mainOptions.objectName||'',serviceUrl:this._options.mainOptions.serviceUrl||'','folder@':e,signs:Boolean(t.get('signs')),encrypted:Number(t.get('encrypted'))};},_play:function(){var t=this,e=this._options.records.map(function(e){return t._toObject(e);});return e.forEach(function(e){e.documentId=t._options.mainOptions.fixId||t._options.mainOptions.catalogId;}),this._copyLinkToClipboard(),i.require(['js!SBIS3.BL.SbisBuffer']).addCallback(function(t){return t[0].AddObjects(e).addCallback(function(){require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(t){t.showNotification({caption:rk('Скопировано в буфер обмена'),status:'success'});});});});},getIcon:function(){return'sprite:icon-24 icon-Copy icon-primary';},getCaption:function(){return rk('Скопировать');}},_dotTplFn:e,_copyLinkToClipboard:function(){var t,e;if(1!==this._options.records.length)return;if(t=this._options.records[0],t&&t.isLink())e=o.getLinkUrl(t,this._options.mainOptions),new n({showNotification:false}).setText(e);}});});
define('js!SBIS3.DOCVIEW.decrypt',['Core/Deferred','js!SBIS3.DOCVIEW.Command','WS.Data/Source/SbisService','tmpl!SBIS3.DOCVIEW.decrypt','Core/Indicator','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.decrypt','Docview_localization'],function(e,t,r,n,i){'use strict';return t.extend({_dotTplFn:n,$protected:{idCmd:'decrypt',_resultDef:void 0,_play:function(t){t=t||{};var n=this,o=n._options.records[0],c=o.getObjectName()||this._options.mainOptions.objectName,s=o.getServiceUrl()||this._options.mainOptions.serviceUrl,a={contract:c,address:s,id:o.get('attachId')};return this._resultDef=new e(),i.setMessage(rk('Расшифровка')),requirejs(['js!SBIS3.DOCVIEW.Encryption'],function(e){new r({endpoint:{contract:'DocView',address:'/docview/service/'}}).call('ReadAttachmentInfo',{Service:'http://'+window.location.host+s+'service/',Object:c,ID:o.get('attachId'),IDRedaction:o.get('redactionId')}).addCallback(function(r){var o=r.getRow();e.decryptAttachment({fileInfo:a,attachmentInfo:o,password:t.password}).addCallbacks(function(){n._resultDef.callback(),i.hide();},function(t){if('cancel'!==t.message){var r=e.isEncryptedByPassword(o)?rk('Не удалось расшифровать файл. Возможно, был введен неверный пароль.'):t.message;requirejs(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(e){e.showMessageDialog({message:r,status:'error'});});}n._resultDef.errback(),i.hide();});});}),this._resultDef;}},getIcon:function(){return'sprite:icon-24 icon-Unlock icon-primary';},getCaption:function(){return rk('Расшифровать');}});});
define('js!SBIS3.DOCVIEW.deleteDoc',['WS.Data/Source/SbisService','Core/Deferred','js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.deleteDoc','Core/Indicator','js!SBIS3.DOCVIEW.Funcs','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.deleteDoc','Docview_localization'],function(e,t,r,n,i,o){'use strict';function s(e){var t=[];return e.each(function(e){var r=e.get('ErrorMsg');if(r)t.push(r);}),t;}function c(e){var t=e.get('Flags');if(!t){if(e.get('link'))return e.get('link');return false;}if(t.get)return t.get('IsLink');for(var r=0;r<t.s.length;r++)if('IsLink'===t.s[r].n)return t.d[r];}return r.extend({$protected:{idCmd:'deleteDoc',_options:{confirmDialogDefaultButtonIsCancel:true},_play:function(){var r=this,n=new t(),c=r._options.records.map(function(e){return e.get('attachId');});return i.setMessage(rk('Удаление')+'...'),new e({endpoint:{contract:r._options.mainOptions.objectName,address:r._options.mainOptions.serviceUrl+'service/'}}).call('DeleteAttachments',{Ids:c}).addCallback(function(e){i.hide();var t=s(e.getAll());if(t.length)return new Error(t[0]);else n.callback();}).addErrback(function(e){i.hide(),o.showErrorNotification({message:rk('Не удалось выполнить удаление'),details:e.message}),n.errback(e);}),n;},_getConfirmDialogText:function(){var e=rk('Удалить документ')+'?';if(this._options.records.length>1)e=rk('Удалить выбранные документы?');else if(c(this._options.records[0]))if(this._options.records[0].get('folder@'))e=rk('Удалить ссылку на папку?');else e=rk('Удалить ссылку на документ?');else if(this._options.records[0].isLink())e=rk('Удалить ссылку')+'?';else if(this._options.records[0].get('folder@'))e=rk('Удалить папку?');return e;}},_dotTplFn:n,getIcon:function(){return'sprite:icon-24 icon-Erase icon-error';},getCaption:function(){return'Удалить';}});});
define('js!SBIS3.DOCVIEW.deletePermanentlyDoc',['Core/Deferred','js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.deletePermanentlyDoc','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.deletePermanentlyDoc','Docview_localization'],function(e,n,t){'use strict';return n.extend({$protected:{idCmd:'deletePermanentlyDoc',_play:function(){var n=this,t=new e();return require(['js!SBIS3.EDO.CD.DiskOperations'],function(e){e.permanentlyDeleteObjects(n._options.records,{opener:n,confirm:true}).addCallbacks(function(){t.callback();},function(e){t.errback(e);});}),t;}},_dotTplFn:t,getIcon:function(){return'sprite:icon-24 icon-Erase icon-error';},getCaption:function(){return'Удалить навсегда';}});});
define('js!SBIS3.DOCVIEW.directLink',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.directLink','js!SBIS3.DOCVIEW.EditInBrowserMixin','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.directLink','Docview_localization'],function(i,e,n){'use strict';return i.extend([n],{$protected:{idCmd:'directLink',_play:function(){var i=this._getDirectLink(this._options.records[0])+'?objectName='+encodeURIComponent(this._options.mainOptions.objectName)+'&serviceUrl='+encodeURIComponent(this._options.mainOptions.serviceUrl);requirejs(['js!SBIS3.Engine.Clipboard'],function(e){new e().setText(i);});}},_dotTplFn:e});});
define('js!SBIS3.DOCVIEW.edit',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.edit','js!SBIS3.DOCVIEW.EditInAppMixin','js!SBIS3.DOCVIEW.Funcs','js!SBIS3.DOCVIEW.EditInBrowserMixin','Core/Deferred','SBIS3.CONTROLS/Menu/MenuLink','i18n!SBIS3.DOCVIEW.edit','Docview_localization'],function(e,i,t,n,o,s){'use strict';function a(e){var i={doc:'MS Word',xls:'MS Excel',ppt:'MS PowerPoint'}[e.getFileExtension()],t=new s();if(i)requirejs(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(e){e.showConfirmDialog({message:rk('Данный файл был создан в устаревшей версии')+' '+i+'. '+rk('Для редактирования его нужно преобразовать в новый формат. Продолжить?')},function e(){t.callback(true);},function e(){t.callback(false);});});else t.callback(true);return t;}var r=e.extend([t,o],{_dotTplFn:i,$protected:{idCmd:'edit',_options:{isMenu:false,confirmDialogDefaultButtonIsCancel:true},_play:function(e){var i=this,t=this._getCommandsManager(),o=t&&t._options.fullScreenMode,r=new s();if(!e)e={item:'edit'};if(!e.item)e.item='edit';switch(e.item){case'edit':var d,c=function(){if(d)d.close();};a(i._options.records[0]).addCallback(function(s){if(s){if(!o)d=e.window?e.window:window.open('about:blank','_blank');n.getFileInfo(i._options.records[0],i._options.mainOptions).addCallbacks(function(e){n.getLockers({attachId:e.record.get('attachId'),objectName:e.objectName}).addCallback(function(s){if(s.get('WebAppsEdit')||!s.get('Lockers').length)if(!o)d.location.href=i._getDirectLink(e.record,e)+'?mode=edit&checkLockers=0';else{var a=t.getParent();if(a._options.viewOptions)a._oldMode=i._options.viewOptions.mode,a._options.viewOptions.mode='edit';t.setMode('edit');}else c(),n.alert({message:rk('Редактирование недоступно'),details:n._getLockMessage(s),opener:i});}).addErrback(c);},c);}r.callback();});break;case'editInApp':i._goToEditInApp(e).addErrback(function(e){if(e=JSON.parse(e.message),e.WebAppsEdit)n._showConfirmDialog({message:rk('Редактирование в приложении недоступно'),details:e.message+'\n'+rk('Начать редактирование в браузере')+'?',opener:i,myPositiveHandler:function(){r.dependOn(i._play());},myNegativeHandler:function(){r.callback();}});else n.alert({message:rk('Редактирование недоступно'),details:e.message,opener:i}),r.callback();});}return r;},_getConfirmDialogText:function(){if(this._options.records[0].get('signs'))return'Документ подписан.\n Продолжить?';return'';}},_modifyOptions:function(){var e=r.superclass._modifyOptions.apply(this,arguments);if(e.isMenu)e._items=[{id:'edit',title:rk('в браузере')},{id:'editInApp',title:rk('в приложении')}];return e;},init:function(){if(r.superclass.init.call(this),this._setNotificationOnFinishCommand(),this.hasChildControlByName('mainBtn')){var e=this._getCommandsManager(),i=this.getChildControlByName('mainBtn');if(e&&this._options.isMenu)this.subscribeTo(i,'onActivated',e._showTransparentDiv.bind(e)),this.subscribeTo(i,'onMenuItemActivate',e._hideTransparentDiv.bind(e));}}});return r;});
define('js!SBIS3.DOCVIEW.editInApp',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.editInApp','js!SBIS3.DOCVIEW.EditInAppMixin','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.editInApp','Docview_localization'],function(n,t,i){'use strict';var e=n.extend([i],{$protected:{idCmd:'editInApp',_options:{confirmDialogDefaultButtonIsCancel:true},_play:function(n){var t=this;return t._goToEditInApp(n).addErrback(function(n){n=JSON.parse(n.message),requirejs(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(i){i.showMessageDialog({message:n.message,status:'error',opener:t});});});},_getConfirmDialogText:function(){if(this._options.records[0].get('signs'))return'Документ подписан.\n Продолжить?';return'';}},_dotTplFn:t,init:function(){e.superclass.init.call(this),this._setNotificationOnFinishCommand();}});return e;});
define('js!SBIS3.DOCVIEW.encrypt',['Core/Deferred','Core/ParallelDeferred','Core/CommandDispatcher','js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.encrypt','Core/moduleStubs','Core/UserInfo','Core/Indicator','SBIS3.CONTROLS/Link','Docview_localization'],function(e,t,n,r,i,o,s,a){'use strict';return r.extend({_dotTplFn:i,$protected:{idCmd:'encrypt',_resultDef:void 0,_play:function(){var n=this,r=this._options.records.length,i=r>1,s;return s=setTimeout(function(){a.setMessage(rk('Пожалуйста, подождите'));},500),this._resultDef=new e(),new t({steps:{currentUserCertificates:this._getPersonCertificates(),defaultPersonsCertificates:this._getDefaultPersonsCertificates(),modules:o.require(['SBIS3.CONTROLS/Action/OpenDialog','optional!tmpl!SBIS3.Person.PersonPhoto/resources/personPhoto'])}}).done().getResult().addCallbacks(function(e){new(0,e.modules[0])({template:'js!SBIS3.DOCVIEW.EncryptWindow'}).execute({dialogOptions:{title:rk('Зашифровать')+' '+(1===r?rk('файл'):rk('файлы')+' ('+r+')'),resizeable:false,parent:n,handlers:{onAfterShow:c}},componentOptions:{objectName:n._options.mainOptions.objectName,serviceUrl:n._options.mainOptions.serviceUrl,catalogId:n._getCatalogId(),fileRecords:n._options.records,showFilesPreview:i,userCertificates:e.currentUserCertificates,defaultPersonsCertificates:e.defaultPersonsCertificates}});},function(e){c(),n._resultDef.errback(e);}),this._resultDef;function c(){clearTimeout(s),a.hide();}}},$constructor:function(){var e=this;n.declareCommand(this,'onFinishEncryption',function(){e._resultDef.callback();});},getIcon:function(){return'sprite:icon-24 icon-Lock icon-primary';},getCaption:function(){return rk('Зашифровать');},_getPersonCertificates:function(){var t=s.get('ИдентификаторСервисаПрофилей')||null,n;if(!t)return null;return n=new e(),requirejs(['js!SBIS3.DOCVIEW.Encryption'],function(e){n.dependOn(e.getPersonCertificates([t]).addErrback(function(){return null;}));}),n;},_getDefaultPersonsCertificates:function(){var t=this,n=new e();return requirejs(['js!SBIS3.DOCVIEW.Encryption'],function(e){var r=e.getFilesInfo(t._options.records,t._options.mainOptions);n.dependOn(e.getDefaultPersonsCertificates(r,t._getCatalogId()));}),n;},_getCatalogId:function(){return this._options.mainOptions.filter&&this._options.mainOptions.filter.folder||this._options.mainOptions.fixId;}});});
define('js!SBIS3.DOCVIEW.flkErrors',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.flkErrors','SBIS3.CONTROLS/Link','Docview_localization'],function(n,o){'use strict';return n.extend({$protected:{idCmd:'flkErrors',_options:{icon:'sprite:icon-24 icon-Alert icon-attention'},_play:function(){return this._getCommandsManager().openProtocolDLC();}},_dotTplFn:o});});
define('js!SBIS3.DOCVIEW.fullScreen',['Core/core-clone','Core/core-instance','js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.fullScreen','js!SBIS3.DOCVIEW.Funcs','css!SBIS3.DOCVIEW.fullScreen','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.fullScreen','Docview_localization'],function(e,n,o,t,i){'use strict';return o.extend({$protected:{idCmd:'fullScreen',_options:{template:'js!SBIS3.DOCVIEW.FullScreenViewer'},_play:function(o){if(this._options.records[0].get('folder@')||this._options.records[0].get('Deleted'))return;var t=this,s=t._getCommandsManager(),r=t.getParent();if(o=o||{},r.isDestroyed())return;var a=t._options.records[0],d;if(o.mainRecord)d=a.clone(),a=o.mainRecord;if(s._options.mainOptions.userCommandsCopy&&n.instanceOfModule(s,'SBIS3.DOCVIEW.List'))t._options.mainOptions.userCommands=e(s._options.mainOptions.userCommandsCopy);t._options.mainOptions.autoSaveFED=true;var m=function(){var n=i.createEventTransmitter(r),m=o.mainOptions||t._options.mainOptions,c=t._findRecordSet(r);if(c)(m=e(m)).useOnlyCtx=false;i.openFullScreen({_options:{listOptions:o.listOptions||t._options.listOptions,viewOptions:o.viewOptions||t._options.viewOptions,mainOptions:m,enabled:t.isEnabled()},template:t._options.template,viewer:'view'===s.getName()?s:null,opener:r,parent:s,recordSet:c,record:a,redactionRecord:d,enabled:r.isEnabled(),className:t._getCommandOptions().containerClassName,handlers:{onStartCommand:n,onFinishCommand:n,onCancelCommand:n,onErrorCommand:n,onShowFile:n,onProcessCommand:n,onStartShowFedDocument:n,onBeforeSaveFedDocument:n},readyFuncs:function(e){e.setMultiplyCommandCfg(s._changedCmd);}});};if(s&&s.saveFedDocument&&t._options.records&&t._options.records[0]&&t._options.records[0].get('versionForm'))s.saveFedDocument().addCallback(function(){m();});else m();}},_dotTplFn:t});});
define('js!SBIS3.DOCVIEW.imageEdit',['Core/helpers/Hcontrol/toggleLocalIndicator','js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.imageEdit','Core/Deferred','Core/ParallelDeferred','Core/UserConfig','js!SBIS3.DOCVIEW.Funcs','Core/IoC','WS.Data/Source/SbisService','WS.Data/Query/Query','js!SBIS3.DOCVIEW.EditInBrowserMixin','Core/detection','SBIS3.CONTROLS/Link','css!SBIS3.DOCVIEW.imageEdit','i18n!SBIS3.DOCVIEW.imageEdit','Docview_localization'],function(e,t,n,i,o,r,a,s,c,d,l,u){'use strict';var m,p,f=u.isMobilePlatform,g=f?10:300,h=false,_=false;function I(e){var t=new Image(),n=new i();return t.onload=function(){if(!n.isReady())n.callback(t);},t.onerror=function(){if(!n.isReady())n.errback(rk('Изображение недоступно. Перезагрузите&nbsp;страницу'));},t.src=e,n;}function v(){return r.getParam('настройкиРедактораИзображений').addErrback(function(){return null;});}function w(){var e=new i();return require(['js!SBIS3.Painter.Editor'],function(t){e.callback(t);},function(t){e.errback(t);}),e;}function S(e,t){var n=new i(),o=e.get('Size')||e.get('size');if(o)return n.callback(o);return new c({endpoint:{contract:t.objectName,address:t.serviceUrl+'service/'}}).call('ReadFileInfo',{'ИдО':e.get('redactionId')||e.getId()}).addCallback(function(e){var t=e.getRow();n.callback(t.get('size')||t.get('Size'));}),n;}function b(e){require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(t){var n,i;if(502===e.httpError||503===e.httpError)n=rk('Сервис на техническом обслуживании.'),i=rk('Мы знаем об этом и уже исправляем. Попробуйте заглянуть сюда через 15 минут.');else n=rk('Не удалось загрузить редактор'),i=e.message||e;t.showMessageDialog({message:n,details:i,status:'error'});});}function O(e,t){if(e.get('imageUrl')||'PDF'===t.objectName)return i.success(null);var n=new c({endpoint:{contract:'Locks',address:'/wopi/service/'}}),o='http://'+window.location.host;return a.getFileInfo(e,t).addCallback(function(e){return n.call('GetExclusiveLock',{Service:o+e.serviceUrl,Object:e.objectName,ID:e.record.get('attachId'),Timeout:g}).addCallback(function(t){if(p=t.getScalar(),''===p)return a.getLockers({attachId:e.record.get('attachId'),objectName:e.objectName}).addCallback(function(e){var t=a._getLockMessage(e);return new Error(t||rk('Изображение недоступно. Перезагрузите&nbsp;страницу'));});else return m=setInterval(function(){n.call('RefreshExclusiveLock',{Service:o+e.serviceUrl,Object:e.objectName,ID:e.record.get('attachId'),LockID:p,Timeout:g}).addErrback(function(e){s.resolve('ILogger').error('Ошибка при блокировке ',e);});},1000*g-1000),p;});});}function C(e,t){if(!p)return;clearInterval(m),a.getFileInfo(e,t).addCallback(function(e){new c({endpoint:{contract:'Locks',address:'/wopi/service/'}}).call('ReleaseExclusiveLock',{Service:'http://'+window.location.host+e.serviceUrl,Object:e.objectName,ID:e.record.get('attachId'),LockID:p});});}function k(e){var t=new XMLHttpRequest();t.open('POST','https://'+window.location.host+'/wopi/service/',false),t.setRequestHeader('X-CalledMethod','Locks.ReleaseExclusiveLock'),t.setRequestHeader('X-OriginalMethodName','TG9ja3MuR2V0RXhjbHVzaXZlTG9jaw=='),t.setRequestHeader('X-Requested-With','XMLHttpRequest'),t.send(JSON.stringify({jsonrpc:'2.0',protocol:4,method:'Locks.ReleaseExclusiveLock',params:e,id:1}));}function E(e,t){if(e.get('imageUrl'))return i.success(0);return new c({endpoint:{contract:'DocView',address:'/docview/service/'}}).call('ImgOrientation',{Service:'http://'+window.location.host+t.serviceUrl,Object:t.objectName,ID:e.get('attachId'),IDRedaction:e.get('redactionId')}).addCallbacks(function(e){return e.getScalar();},function(){return null;});}var R=t.extend([l],{_dotTplFn:n,$protected:{idCmd:'imageEdit',_options:{confirmDialogDefaultButtonIsCancel:true},_isIndicatorShown:false,_beforeIndicatorTimeout:0,_canHideIndicator:true,_needToHideIndicator:false,_commandResult:null,_play:function(){if(!f&&this._commandResult&&!this._commandResult.isReady())return;if(_)return new i().callback();_=true;var e=new i(),t=this,n=new c({endpoint:{address:t._options.mainOptions.serviceUrl+'service/',contract:t._options.mainOptions.objectName},binding:{query:'RedactionsList'}}),o=new d();if(this._commandResult=e,this._enableRename=this.getParent().getCommands(this._options.records[0]).some(function(e){return'rename'===e.name;}),t._options.mainOptions.objectName&&'PDF'!==t._options.mainOptions.objectName)if(t._options.records[0].get('redactionId'))o.where({attachId:t._options.records[0].get('attachId')}),n.query(o).addCallback(function(n){if(n){var i=n.getAll().getIndexByValue('redactionId',t._options.records[0].get('redactionId'));if(i<0)return new Error(rk('Редакция удалена'));if(i>0)require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(o){o.showConfirmDialog({message:rk('Вы пытаетесь отредактировать не последнюю редакцию.'),details:rk('Продолжить?'),hasCancelButton:true},function o(){e.dependOn(t._loadEditor(n.getAll().at(i).get('relativeUrl')));},function t(){e.callback();},function t(){e.cancel();});});else e.dependOn(t._loadEditor());}}).addErrback(function(t){b(t),e.errback();});else e.dependOn(t._loadEditor());else e.dependOn(t._loadEditor());return h=false,e;},_loadEditor:function(e){var t=this.getParent(),n=this,r=new i(),s='',c=null;return S(this._options.records[0],this._options.mainOptions).addCallback(function(i){if(i/1024/1024>2&&f||i/1024/1024>9&&!f)s=e||a.getSyncPreviewUrl(n._options.records[0],{width:1900,height:900});else s=e||a.getUrlForDownloadFile(n._options.records[0],n._options.mainOptions)+'#hash='+ +new Date();function d(e){var t=e.viewer,i=e.editor,o=$(t._iFrame).contents().find('img')[0],a={Service:'http://'+window.location.host,Object:n._options.mainOptions.objectName,ID:n._options.records[0].get('attachId'),LockID:c},s=k.bind(null,a),d=o.getBoundingClientRect(),l=$(t._iFrame)[0].contentWindow.config,u={top:d.top,left:d.left,width:d.width,height:d.height,angle:null,wrapperScrollTop:l.$wrapper[0].scrollTop,wrapperScrollLeft:l.$wrapper[0].scrollLeft},m=n._options.records[0].has('deleteRedactionsOnSave')&&n._options.records[0].get('deleteRedactionsOnSave')||n._options.mainOptions.commandsOptions&&n._options.mainOptions.commandsOptions.imageEdit&&n._options.mainOptions.commandsOptions.imageEdit.deleteRedactionsOnSave,p;try{p=JSON.parse(e.settings);}catch(e){p=null;}window.addEventListener('unload',s),new i.createInstance({element:t.getContainer(),className:'ws-imageEditor',name:'imageEditor',parent:t,targetImage:e.image,iframeImage:o,openHeight:o.height,openWidth:o.width,commands:false,imageOptions:u,settings:p,enableRename:void 0!==window.enableRename?window.enableRename:n._enableRename,imageAngle:e.angle,deleteRedactionsOnSave:m,syncSave:t._options.viewOptions&&t._options.viewOptions.justAttach,fileOptions:{objectName:n._options.mainOptions.objectName,serviceUrl:n._options.mainOptions.serviceUrl,attachId:t.savedRec.get('attachId'),fileName:t.savedRec.get('fileName'),records:[t.savedRec],mainOptions:n._options.mainOptions},saveCommands:[],config:$(t._iFrame)[0].contentWindow.config,handlers:{onInit:function(){n._hideIndicator(),_=false;},onDestroy:function(){if(this.getSaving())n._finishParams.saving=this.getSaving()&&this.getSaving().isReady()&&!this.getSaving().isSuccessful()?null:this.getSaving();if(C(n._options.records[0],n._options.mainOptions),r.callback(),t._createdByImageEditor||this.getSaving()&&!this._options.syncSave)t.sendCommand('close');$('body').removeClass('imageEdit__hideCommandPanel'),window.removeEventListener('unload',s);}}});}function l(){return!h;}O(n._options.records[0],n._options.mainOptions).addCallback(function(e){return c=e,new o({steps:{settings:v(),image:I(s),viewer:n._getFullScreenView(t,l),editor:w(),angle:E(n._options.records[0],n._options.mainOptions)}}).done().getResult();}).addCallback(d).addErrback(function(e){n._hideIndicator(),b(e),C(n._options.records[0],n._options.mainOptions),h=true,$('body').removeClass('imageEdit__hideCommandPanel'),r.errback(e),_=false;});}),n._options.mainOptions.serviceUrl=n._options.mainOptions.serviceUrl.replace(/\/service\//,'/'),n._preventPreviewBlinking(t),r;},_getConfirmDialogText:function(){if(this._options.records[0]&&this._options.records[0].get('signs'))return rk('Документ подписан.\n Продолжить?');return'';}},_preventPreviewBlinking:function(e){try{var t=/id=?([^&;]*)/.exec(e.getContainer().find('#rename img').attr('src')),n=t&&parseInt(t[1],10);if(n){var i=this._options.records[0],o=e.getParent().viewerRecordSet.getRecordById(i.get('attachId'));i._options.previewId=o._options.previewId=n;}}catch(e){}},_getFullScreenView:function(e,t){if(e._options.fullScreenMode)return this._showIndicator(),i.success(e);var n=this,o=new i(),r=a.createEventTransmitter(e);return a.openFullScreen({_options:e._options,opener:e,recordSet:this._findRecordSet(e),record:this._options.records[0],redactionId:this._options.records[0]&&this._options.records[0].get('redactionId'),enabled:e.isEnabled(),handlers:{onStartCommand:r,onFinishCommand:r,onCancelCommand:r,onErrorCommand:r,onProcessCommand:r,onStartShowFedDocument:r,onBeforeSaveFedDocument:r,onReady:function(){if(t())$('body').addClass('imageEdit__hideCommandPanel'),n._showIndicator();},onShowFile:function(e){var n=e.getTarget().getView();if(t())n._createdByImageEditor=true;o.callback(n);}}}),o;},_showIndicator:function(){var t=this;if(!this._isIndicatorShown)this._isIndicatorShown=true,this._beforeIndicatorTimeout=setTimeout(function(){t._beforeIndicatorTimeout=0,e(t.getContainer(),true),t._canHideIndicator=false,setTimeout(function(){if(t._canHideIndicator=true,t._needToHideIndicator)e(t.getContainer(),false),t._isIndicatorShown=false,t._needToHideIndicator=false;},500);},500);},_hideIndicator:function(){if(this._beforeIndicatorTimeout)clearTimeout(this._beforeIndicatorTimeout),this._beforeIndicatorTimeout=0,this._isIndicatorShown=false;else if(this._isIndicatorShown)if(this._canHideIndicator)e(this.getContainer(),false),this._isIndicatorShown=false;else this._needToHideIndicator=true;},destroy:function(){R.superclass.destroy.call(this),this._commandResult=null;}});return R;});
define('js!SBIS3.DOCVIEW.links',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.links','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.links','Docview_localization'],function(t,e){'use strict';return t.extend({$protected:{idCmd:'links',_play:function(t){var e=this,n=this.getParent(),o=false===e._options.mainOptions._isAuth,i=null,s=e._options.mainOptions.commands.copyToBuffer,r=e._options.records[0],a=e._getCommandOptions().customUrl;if(t&&t.instance){var c=t.instance.getContainer(),l=c?c.offset():null;if(l)i={top:l.top+35,left:l.left-450};}if(r.get('ShareId')){var d=r.clone();d.set('attachId',r.get('ShareId')),d.set('redactionId',null);}require(['js!SBIS3.DOCVIEW.ObjectLinks','Core/UserInfo'],function(t,e){var c='__сбис__биллинг'===e.get('ЛогинКлиента'),l=r.get('ShareId')||r.get('attachId'),f=d||r;t.show(l,{position:i,name:f.get('title')||f.get('fileName'),record:f,isFolder:0===f.get('Type'),isPublic:o,opener:n,needCopyToBuffer:s,showCommonDocs:!c,showMyDocs:!c,customUrl:a});});}},_dotTplFn:e,getIcon:function(){return'sprite:icon-24 icon-Link icon-primary';},getCaption:function(){return'Ссылки';}});});
define('js!SBIS3.DOCVIEW.move',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.move','Core/Deferred','Core/core-instance','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.move','Docview_localization'],function(e,t,n,i){'use strict';return e.extend({$protected:{idCmd:'move',_options:{},_play:function(){return this._options.mainOptions.isDisk?this._moveInDisk():this._move();}},_dotTplFn:t,_getTreeView:function(){var e=this._getCommandsManager(),t;if(i.instanceOfModule(e,'SBIS3.DOCVIEW.OperationPanel'))t=e._options.linkedView;else if(i.instanceOfModule(e,'SBIS3.DOCVIEW.List'))t=e.getTreeView();return t;},_moveInDisk:function(){var e=this,t=new n();return require(['js!SBIS3.EDO.CD.DiskOperations'],function(n){n.moveObjects(e._options.records,{opener:e,rootFolder:e._options.mainOptions.filter.catalogId,InitialRootId:e._options.mainOptions.filter.InitialRootId,objectName:e._options.mainOptions.objectName,withoutNotification:false!==e._options.mainOptions.withoutNotification}).addCallback(function(n){if(n){var i=e._getTreeView();if(i)i.removeItemsSelectionAll();e._finishParams={destinationFolderId:n};}t.callback();}).addErrback(function(e){if(e&&e.canceled)t.callback();else t.errback(e);});},function(e){t.errback(e);}),t;},_move:function(){var e=this,t=new n();return require(['SBIS3.CONTROLS/Action/List/InteractiveMove'],function(n){var i=e._getCommandsManager(),o=i.getTreeView(),r=new n({linkedObject:o,nodeProperty:o.getProperty('nodeProperty'),parentProperty:o.getProperty('parentProperty'),moveStrategy:i});t.dependOn(r.execute());}),t;},getIcon:function(){return'sprite:icon-24 icon-Move icon-primary';},getCaption:function(){return rk('Переместить');}});});
define('js!SBIS3.DOCVIEW.originalImage',['Core/Indicator','js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.originalImage','js!SBIS3.DOCVIEW.Funcs','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.originalImage','Docview_localization'],function(e,t,i,n){'use strict';return t.extend({$protected:{idCmd:'originalImage',_play:function(){var t=this,i=this._getCommandsManager().getIframeWindow(),o=i.getImg(),r=false,a=this._options.records[0];function s(){if(clearTimeout(m),r)e.hide();}function c(){var e=o[0].naturalWidth||o.width(),n=o[0].naturalHeight||o.height(),r=t._options.parent,a=i.getWrapper(),c=a.width(),g=e>c||n>a.height(),m=e/c,d=m>1?4*m:4;s(),o.css({width:e+'px',height:'auto','max-width':'none','max-height':'none'}),i.cancelRotate(),r.switchStateOneCommand(t.idCmd,false),r.switchStateOneCommand('zoomMinus',true),r.switchStateOneCommand('zoomPlus',true),r.execCommand('resize'),i.zoom('1'),i.displayScroll(g),i.config.currentPercent=100,i.config.minPercent=i.config.currentPercent/d,i.config.zoomStep=i.config.minPercent,i.config.isOriginalSize=true;}if(!o.length||!a)return;if(a.get('imageUrl'))return void c();var g=n.getUrlForDownloadFile(a,this._options.mainOptions);if(o.attr('src',g),i.config.isOriginalSize)return;var m=setTimeout(function t(){e.setMessage(rk('Подождите')+'...'),r=true;},200);o.load(c).error(s);}},_dotTplFn:i});});
define('js!SBIS3.DOCVIEW.print',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.print','js!SBIS3.DOCVIEW.ToPdfMixin','js!SBIS3.DOCVIEW.EditInBrowserMixin','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.print','Docview_localization'],function(n,e,t,i){'use strict';function o(n){var e=document.createElement('iframe');e.style.width=0,e.style.height=0,e.style.position='absolute',e.style.top='-10000px',document.body.appendChild(e),e.contentWindow.document.write('<img id="printedImage"/>');var t=e.contentWindow.printedImage;t.onload=function n(){if(!e.contentWindow.document.execCommand('print',false,null))e.contentWindow.print();e.parentElement.removeChild(e);},t.onerror=function n(){e.parentElement.removeChild(e);},t.src=n;}return n.extend([t,i],{$protected:{idCmd:'print',_play:function(n){var e=this,t=e._options.records&&e._options.records[0]||false,i=this._getCatalogId();if(t&&t.get('imageUrl'))return void o(t.get('imageUrl'));var r=e._getCommandsManager(),d=function(){e._process(true,i,n);};if(r&&r.saveFedDocument&&t&&t.get('versionForm'))r.saveFedDocument().addCallback(d);else d();}},_dotTplFn:e,getIcon:function(){return'sprite:icon-24 icon-Print icon-primary';},getCaption:function(){return'Распечатать';}});});
define('js!SBIS3.DOCVIEW.redactions',['Core/Deferred','js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.redactions','WS.Data/Source/SbisService','js!SBIS3.DOCVIEW.Funcs','tmpl!SBIS3.DOCVIEW.redactions/captionTpl/captionTpl','optional!js!SBIS3.Person.PersonPhoto','css!SBIS3.DOCVIEW.redactions','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.redactions','Docview_localization'],function(e,t,n,o,i,s){'use strict';var a=t.extend({$protected:{idCmd:'redactions',_options:{_caption:null,personId:null,personPhotoId:null,count:null},_play:function(){var t=this,n=this._getCommandsManager(),o=this._options.records[0],s=o.get('canEdit')&&n.isEnabled(),a=this.getParent().getContainer().is('.docview-list'),r=new e();return requirejs(['js!SBIS3.DOCVIEW.RedactionsWindow','Core/helpers/Hcontrol/showFloatArea'],function(e,d){d({template:'js!SBIS3.DOCVIEW.RedactionsWindow',name:'RedactionsWindow',target:t,opener:t,autoHeight:true,autoWidth:true,enable:true,allowChangeEnable:false,animation:'slide',isStack:true,autoHide:true,parent:t,modal:true,componentOptions:{isOpenedFromList:a,records:t._options.records,mainOptions:t._options.mainOptions,renderPhotos:t._options.mainOptions.renderPhotos,hasAddRedactionButton:s,commandsManager:n,handlers:{onSelectRedaction:function(e,n){t._notify('onProcessCommand',t.idCmd,{records:[n.selectRedactionRecord],selectRedactionId:n.selectRedactionId,isOpenedFromList:this._options.isOpenedFromList,mainRecord:n.record,needUpdatePanelCounters:n.needUpdatePanelCounters,isLastRedaction:!!n.isLastRedaction});},onClickUpload:function(e,t){n.startCommand('upload',[t],{});},onProcessCommand:function(e,n,o){if(o)o.needUpdatePanelCounters=true;t._notify('onProcessCommand',n,o);},onAddRedaction:function(){if(i._isFileExtensionIn(o.getFileExtension(),n.editInBrowse.concat(n.officeExts).concat(n.editOnlyInApp)))t._publishWopiEvent();}}},handlers:{onClose:function(){this.destroy(),r.callback();}}});}),r;}},_publishWopiEvent:function(){return new o({endpoint:{address:'/wopi/service/',contract:'WOPIServer'}}).call('EventPublish',{FileID:this._options.records[0].get('attachId'),Service:i.getInternalServiceUrl(this._options.mainOptions),Object:this._options.mainOptions.objectName,ChannelName:'wopi.documentHasChanged'});},_dotTplFn:n,_modifyOptions:function(){var e=a.superclass._modifyOptions.apply(this,arguments),t=e.records[0],n=t&&(t.get('ModifyDate')||t.get('lastChange')),o=new Date().strftime('%Y'),i='',r='';if(e.count=t&&(t.get('redactionsNumber')||t.get('countRedactions')),e.personId=t.get('Editor')||t.get('responsibleProfileId'),e.personPhotoId=t.get('EditorPhotoId')||t.get('responsibleProfileId'),n instanceof Date){if(i=n?n.strftime('%d %b %Y'):'',o!==n.strftime('%Y'))r=n.strftime('%d %b %Y');else r+=n.strftime('%d %b %H:%M').toLowerCase();e._caption=s({title:i,value:r});}return e;}});return a;});
define('js!SBIS3.DOCVIEW.rename',['WS.Data/Source/SbisService','WS.Data/Entity/Record','Core/Context','js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.rename','js!SBIS3.DOCVIEW.Funcs','Core/Deferred','js!SBIS3.DOCVIEW.RenameDialogHandlers','css!SBIS3.DOCVIEW.rename','SBIS3.CONTROLS/EditAtPlace','SBIS3.CONTROLS/TextBox','i18n!SBIS3.DOCVIEW.rename','Docview_localization'],function(e,t,n,i,a,s,o,r){'use strict';var l=i.extend({$protected:{idCmd:'rename',_name_small:'',_editor:null,_options:{validators:[]},_play:function(){var e=this,t=e._options.records[0]||null,i=t?t.get('redactionId'):'',a=t?t.get('attachId'):'',r=new o(),l=n.createContext(r),c='',d=Boolean(t.get('folder@')),m=t.get('title')||t.get('fileName'),f=false;if(!d){var h=s.parseFileName(m);c=h.extension,m=h.name,f='url'===c;}var u=t.get('title'),_=u.lastIndexOf('.url');if(_===u.length-4)u=u.substr(0,_);if(l.setValue({'НазваниеДокумента':m,'Адрес':m,'НазваниеСсылки':u}),f){var p=s.getLinkUrl(t,this._options.mainOptions);if(p)l.setValue('Адрес',p);}var g=false,C=new o(),b={template:f?'js!SBIS3.DOCVIEW.RenameLink':'js!SBIS3.DOCVIEW.RenameDialog',opener:e,context:l,autoHeight:true,resizeable:false,width:'400px',autoWidth:false,componentOptions:{rec:t,ext:c,attachId:a,redactionId:i,handlers:{onFinishEditTitle:function(n,i){var a=this._options.rec.get('fileName');if(a!==i.title||a!==i.address)e._renameDocument(t,i).addCallback(function(){C.callback();}).addErrback(function(){C.errback();});else C.errback();},onStartChangeTitle:function(){g=true;}}},handlers:{onBeforeClose:function(n,i){if('boolean'===typeof i)return;var a=this;if(g){n.setResult(false);var s;if(this.hasChildControlByName('НазваниеДокумента'))s='НазваниеДокумента';else if(this.hasChildControlByName('НазваниеСсылки'))s='НазваниеСсылки';if(s){var o=this.getChildControlByName(s),r=o.getText(),l=f?e._name_small.replace('.url',''):e._name_small;if(r!==l)g=false,require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(n){n.showConfirmDialog({message:rk('Сохранить изменения?'),opener:a},function n(){if(o.validate()){g=false;var i=r+(c?'.'+c:''),s=f?rk('Ссылка'):d?rk('Папка'):rk('Файл');e._renameDocument(t,{newTitle:i},s,true).addCallback(function(){C.callback();}).addErrback(function(){C.errback();}),a.unbind('onBeforeClose'),a.close(true);}else g=true;},function e(){a.unbind('onBeforeClose'),a.close(false);});});else a.unbind('onBeforeClose'),a.close();}}else C.errback('cancel');},onAfterClose:function(e,t){if(!t&&!C.isReady())C.errback();},onDestroy:function(){r.callback();}}};return require(['Lib/Control/Dialog/Dialog'],function(e){new e(b);}),C;}},_dotTplFn:a,_modifyOptions:function(){var e=l.superclass._modifyOptions.apply(this,arguments);if(e.records[0]&&e.records[0].get('fileName')&&!e.records[0].get('fileName').match(/url$/))e.validators=[{validator:r.checkTitle,option:'text'}];return e;},$constructor:function(){this.subscribeTo(this,'onReady',this._onReady);},getIcon:function(){return'sprite:icon-24 icon-Rename icon-primary';},getCaption:function(){return rk('Переименовать');},init:function(){l.superclass.init.call(this);var e=this._options.records[0];if(!e)return;var t=e.get('title')||e.get('fileName'),n=s.parseFileName(t),i=this.getLinkedContext();if(t=n.name+(n.extension?'.'+n.extension:''),false===e.get('canEdit')||!this._getCommandsManager().isEnabled())this.setEnabled(false);else this.getContainer().addClass('docview-rename__canChangeName');if(this._name_small=t,this.setName(t),i.setValue('docExt',s.getFileExtension(t)),this.hasChildControlByName('editName'))this._editor=this.getChildControlByName('editName'),this._editor.setTooltip(t);},destroy:function(){l.superclass.destroy.call(this),this._editor=null;},_callUpdateAttachmentInfo:function(n,i){var a=new e({endpoint:{contract:this._options.mainOptions.objectName,address:this._options.mainOptions.serviceUrl+'service/'}}),s=new t({adapter:'adapter.sbis',format:[{name:'fileName',type:'string'},{name:'title',type:'string'}]});return s.set({fileName:i,title:i}),a.call('UpdateAttachmentInfo',{'ИдО':n,info:s});},_renameDocument:function(e,t){var n=this,i=t.newTitle.split('.'),a=i.length,r=a>1?i[a-1]:'',l=n._getCommandsManager(),c=new o();n._finishParams={newTitle:t.newTitle,processDeferred:c};var d=t.needNotify?s.wrapperDef(l._notify('onStartCommand',n._options.id,{records:n._options.records,finishParams:n._finishParams})):o.success();return n.setName(n._finishParams.newTitle),d.addCallback(function(i){if(false===i)return c;if(n._finishParams.newTitle===n._name_small)return void c.callback();if(''===t.onlyName)return n.setName(n._name_small),n.getLinkedContext().setValue('docExt',r),void c.errback();l._wasChangedName=true,n._callUpdateAttachmentInfo(e.get('attachId'),t.newTitle).addCallback(function(){if(e.set({fileName:n._finishParams.newTitle,title:n._finishParams.newTitle}),n.getLinkedContext().setValue('docExt',r),n.setName(n._finishParams.newTitle),n._name_small=n._finishParams.newTitle,e.get('relativeUrl'))e.set('relativeUrl','');if(t.needNotify)l._notify('onFinishCommand',n._options.id,{records:n._options.records,finishParams:n._finishParams});c.callback();}).addErrback(function(e){n.setName(n._name_small),n.getLinkedContext().setValue('docExt',r),s.showErrorNotification({message:rk('Ошибка переименования'),details:e.message}),c.errback();});}),c;},_removeTransparentDiv:function(){this._getCommandsManager()._hideTransparentDiv(),this.getParent().getContainer().focus();},_onCancel:function(){this._removeTransparentDiv(),this.setName(this._name_small);},_onReady:function(){if(this._editor)this.subscribeTo(this._editor,'onShowEditor',this._onShowEditor.bind(this)),this.subscribeTo(this._editor,'onApply',this._onApply.bind(this)),this.subscribeTo(this._editor,'onCancel',this._onCancel.bind(this)),this.subscribeTo(this._editor,'onKeyPressed',function(e,t){t.stopPropagation();});},_onShowEditor:function(){var e=this,t=this.getLinkedContext(),n=e._name_small.indexOf('.url')>-1?e._name_small:t.getValue('nameEditor'),i=s.parseFileName(n).name;this.setName(i),this._getCommandsManager()._showTransparentDiv(),setTimeout(function(){e.getContainer().find('input')[0].setSelectionRange(0,9999);},1);},setName:function(e){if(!this.isDestroyed()){var t=this._getCommandsManager();if(t&&t.savedRec&&t.savedRec.get('attachId')!==this._options.records[0].get('attachId'))return;}var n=s.parseFileName(e);if('url'===n.extension)e=n.name;this.getLinkedContext().setValue('nameEditor',e);},_onApply:function(){this._removeTransparentDiv();var e=this.getLinkedContext(),t=e.getValue('docExt'),n=e.getValue('nameEditor'),i=n+(t?'.'+t:''),a=this;this._renameDocument(this._options.records[0],{newTitle:i,onlyName:n,needNotify:true}).addCallback(function(){if(!a.isDestroyed())a._name_small=i;});}});return l;});
define('js!SBIS3.DOCVIEW.restore',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.restore','Core/Deferred','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.restore','Docview_localization'],function(e,r,n){'use strict';return e.extend({$protected:{idCmd:'restore',_options:{},_play:function(){var e=this,r=new n();return require(['js!SBIS3.EDO.CD.DiskOperations'],function(n){r.dependOn(n.restoreObjects(e._options.records,{opener:e}));}),r;}},_dotTplFn:r,getIcon:function(){return'sprite:icon-24 icon-Restore icon-primary';},getCaption:function(){return rk('Восстановить');}});});
define('js!SBIS3.DOCVIEW.rights',['Core/Deferred','js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.rights','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.rights','Docview_localization'],function(o,t,n){'use strict';return t.extend({$protected:{idCmd:'rights',_options:{},_play:function(){var t=this,n=t._options.records[0].get('ShareId')||t._options.records[0].get('attachId'),e=new o();if(1===t._options.records.length)if('commondocs'===t._options.records[0].get('attachId'))require(['js!SBIS3.SBISDISK.FolderRootRights'],function(o){o.show().addCallback(function(){e.callback();});});else{var i=t._options.mainOptions&&t._options.mainOptions.filter&&'commondocs'===t._options.mainOptions.filter.catalogId;require(['js!SBIS3.SBISDISK.RightsPanel'],function(o){o.show(n,{fileName:t._options.records[0].get('title')||t._options.records[0].get('fileName'),isFolder:0===t._options.records[0].get('Type'),needSettingsIcon:i,opener:t}).addCallback(function(o){t._finishParams={withoutReload:o},e.callback();});});}else{var r=t._options.records.map(function(o){return o.get('attachId');});require(['js!SBIS3.SBISDISK.AddRights'],function(o){o.show(r,{opener:t}).addCallback(function(){e.callback();});});}return e;}},_dotTplFn:n,$constructor:function(){var o=this.getContainer(),t=o.find('.dv-messages-counter');o.hover(n.bind(null,t),e.bind(null,t));function n(o){o.css({color:'#313e78',cursor:'pointer'});}function e(o){o.css({color:'',cursor:''});}},getIcon:function(){return'sprite:icon-24 icon-Groups icon-primary';},getCaption:function(){return'Права доступа';}});});
define('js!SBIS3.DOCVIEW.rotateLeft',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.rotateLeft','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.rotateLeft','Docview_localization'],function(t,e){'use strict';return t.extend({$protected:{idCmd:'rotateLeft',_play:function(){this._getCommandsManager().getIframeWindow().rotateTo(-90);}},_dotTplFn:e});});
define('js!SBIS3.DOCVIEW.rotateRight',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.rotateRight','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.rotateRight','Docview_localization'],function(t,e){'use strict';return t.extend({$protected:{idCmd:'rotateRight',_play:function(){this._getCommandsManager().getIframeWindow().rotateTo(90);}},_dotTplFn:e});});
define('js!SBIS3.DOCVIEW.saveChanges',['Core/Deferred','js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.saveChanges','Core/Indicator','SBIS3.CONTROLS/Button','i18n!SBIS3.DOCVIEW.saveChanges','Docview_localization'],function(e,a,s,n){'use strict';return a.extend({$protected:{idCmd:'saveChanges',_play:function(){var a=new e(),s=this._options.records,t=this._options.records[0],o=this._getCommandsManager(),r=o._getIframeWindow();if(t.get('versionForm'))o.saveFedDocument().addCallback(function(){if(a.callback(),o._options.fullScreenMode)o.startCommand('closeFullScreen',s);}).addErrback(function(e){requirejs(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(a){a.showMessageDialog({message:e.message,status:'error'});});});else if('edit'===this._options.viewOptions.mode&&r&&'office'===r.getPreClass())o.startCommand('closeFullScreen',s),a.callback();else if('pdf'===t.getFileExtension())n.setMessage(rk('Сохранение')+'...'),o._activeControl.saveFile(t).addCallback(function(){n.hide(),a.callback(),o.startCommand('closeFullScreen',s);}).addErrback(function(){n.hide();});else a.callback();return a;}},_dotTplFn:s});});
define('js!SBIS3.DOCVIEW.saveToPdf',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.saveToPdf','js!SBIS3.DOCVIEW.ToPdfMixin','js!SBIS3.DOCVIEW.EditInBrowserMixin','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.saveToPdf','Docview_localization'],function(e,n,o,s){'use strict';return e.extend([o,s],{$protected:{idCmd:'saveToPdf',_play:function(){var e=this,n=e._options.records&&e._options.records[0]||false,o=this._getCatalogId(),s=e._getCommandsManager();if(s&&s.saveFedDocument&&n&&n.get('versionForm'))s.saveFedDocument().addCallback(function(){e._process(false,o);});else e._process(false,o);}},_dotTplFn:n,getIcon:function(){return'sprite:icon-24 icon-PDF icon-primary';},getCaption:function(){return'Сохранить в PDF';}});});
define('js!SBIS3.DOCVIEW.scan',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.scan','WS.Data/Source/SbisService','Core/Indicator','Core/Deferred','SBIS3.CONTROLS/Link','Docview_localization'],function(t,e,n,o,i){'use strict';function s(t){r(rk('При загрузке файла на сервер произошла ошибка'),t&&t.message);}function r(t,e,n){require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(o){o.showMessageDialog({status:'error',message:t,details:e||'',opener:n});});}var a=t.extend({$protected:{idCmd:'scan',_options:{icon:'sprite:icon-24 icon-Scan icon-primary'},_commandResult:null,_button:null,_getButtonOptions:function(){return{element:$('<div>').appendTo(document.body),handlers:{onAppletReady:this._onAppletReady.bind(this),onChange:this._onChange.bind(this),onLoaded:this._onLoaded.bind(this)},name:this.getId()+'_sc',enable:true,allowChangeEnable:false,parent:this,method:this._options.mainOptions.objectName+'.ЗагрузитьФайл',renderStyle:'asLink',createZip:false,installDlg:true,loadTimeout:3600};},_onAppletReady:function(t,e,n,o){if(o&&'object'===typeof o)o=o.message;if(o)this.destroy(),r(o);t.setResult(true);},_onChange:function(t,e,n){if(!this._checkFileSize(n.name,n.size))t.setResult(false);},_onLoaded:function t(e,i){var r=this,a=r._options.records[0],u=i&&i.result;function c(){r._destroyButton(),o.hide(),r._commandResult.callback();}if(!u)return s(i&&i.error),void c();o.setMessage(rk('Сохранение')),new n({endpoint:{contract:r._options.mainOptions.objectName,address:r._options.mainOptions.serviceUrl+'service/'}}).call('ЗагрузитьТиповойДокумент',{'ИдО':u,'ИдОДок':r._options.mainOptions.fixId,'Название':a.get('title'),'ТипДокумента':a.get('typeDoc'),'ПодТипДокумента':a.get('subTypeDoc')}).addErrback(s).addCallback(c);},_createButton:function(){var t=this;require(['Lib/Control/FileScaner/FileScaner'],function(e){t._button=new e(t._getButtonOptions({})),t._button.scan();},function(e){t._commandResult.errback(e);});},_destroyButton:function(){if(this._button&&!this._button.isDestroyed())this._button.destroy(),this._button=null;},_play:function(){return this._commandResult=new i(),o.setMessage(rk('Пожалуйста, подождите')),setTimeout(function(){o.hide();},1000),this._destroyButton(),this._createButton(),this._commandResult;}},_dotTplFn:e,destroy:function(){this._destroyButton(),a.superclass.destroy.call(this);},_checkFileSize:function(t,e){var n=this,o=this._getCommandOptions().maxFileSizeInMB||100;if(!e)return r(rk('Размер файла нулевой')+'.','',this),false;if(e>o<<20)return require(['Core/helpers/String/format'],function(e){r(e({number:o},rk('Размер файла превышает установленное ограничение в $number$s$ МБ')),t,n);}),false;return true;}});return a;});
define('js!SBIS3.DOCVIEW.scanFromFile',['js!SBIS3.DOCVIEW.scan','tmpl!SBIS3.DOCVIEW.scanFromFile','WS.Data/Entity/Record','SBIS3.CONTROLS/Link','Docview_localization'],function(e,n,t){'use strict';return e.extend({$protected:{idCmd:'scanFromFile',_options:{icon:'sprite:icon-24 icon-ScanSave icon-primary'},_prepareLoadParams:function(){var e=new t({adapter:'adapter.sbis'}),n=this._options.mainOptions.filter;if(n)e.addField({name:'Документ',type:'integer'}),e.set('Документ',n.catalogId);return e;},_createButton:function(){var e=this;require(['js!SBIS3.FL.FileLoader'],function(n){e._button=new n({mode:'storage',record:e._prepareLoadParams(),handlers:{onBeforeSend:function(n,t){var r=t.fileArr[0];if(!e._checkFileSize(r.name,r.size))return n.setResult({fileArr:[]});},onSend:function(n,t){var r=t&&t[0],i=r&&r.storageResponse,o=i&&i.fileId&&i.fileId+';'+i.versionId;e._onLoaded(n,{result:o});}}}),e._button.choose({useMultiSelection:false});});}},_dotTplFn:n});});
define('js!SBIS3.DOCVIEW.sendMessage',['Core/Deferred','js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.sendMessage','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.sendMessage','Docview_localization'],function(e,s,t){'use strict';return s.extend({$protected:{idCmd:'sendMessage',_options:{records:[]},_play:function(){var s=this,t=s._options.records[0].get('attachId'),n=s._options.records[0].get('Object'),o=new e();return require(['js!SBIS3.Contacts.MessagePanel','js!SBIS3.BL.FileSD','js!SBIS3.EDO.CD.CommonDocsHelpers'],function(e,s,t){var i={docGUID:n,isDocumentHistory:true,isModal:true,restrictedActions:{isHiddenVideoMessage:true,isHiddenAudioMessage:true,isHiddenDeleteDialog:true,isHiddenCreateTask:true},handlers:{onClose:r}};function r(e,s){o.callback();}t.isPersonalAccount().addCallback(function(){e.open(i);});}),o;}},_dotTplFn:t,$constructor:function(){var e=this;require(['js!SBIS3.Contacts.MessagesExchangeEvents'],function(s){if(s)e.subscribeTo(s,'onNewMessage',e._newMessageHandler.bind(e));});},_newMessageHandler:function(e,s){var t=this._options.records[0].get('Object');if(s&&s.document&&s.document.id===t){var n=this._options.records[0].get('countMessages');if(void 0!==n)n+=1,this._options.records[0].set('countMessages',n),this.getContainer().find('.dv-messages-counter').text(n<100?n:99);}}});});
define('js!SBIS3.DOCVIEW.signDocument',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.signDocument','Core/Deferred','js!SBIS3.DOCVIEW.Funcs','SBIS3.CONTROLS/Link','Docview_localization'],function(t,n,e,i){'use strict';return t.extend({$protected:{idCmd:'signDocument',_options:{id:'signDocument',confirmMessageMaxLength:40},_play:function(){var t=this,n=new e();return this._getRedactionIds(this._options.records).addCallback(function(e){i.signDocuments(e,{opener:t,objectName:t._options.mainOptions.objectName,serviceUrl:t._options.mainOptions.serviceUrl}).addCallbacks(function(){requirejs(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(t){t.showNotification({caption:rk('Документы успешно подписаны'),status:'success'});}),n.callback();},function(t){if(t&&'2'===t.message)return;i.showErrorNotification({message:rk('Не удалось подписать'),details:t.message}),n.errback(t);});}),n;}},_getConfirmDialogText:function(){var t=rk('Подписать')+'\n',n=this._options.confirmMessageMaxLength,e=2,i=3,o=this._options.records,r=n-e,s=o.length>i?i:o.length,a=o.length-s,c='',l='',f=r;if(1===o.length)if((p=O(o[0])).length/n>2){var u=n-4,d='&#8203;';if(l=p.substr(0,u)+d+p.substr(u,u)+d+p.substr(2*u,u-e),p.length>l.length-2*d.length+e)l+='...';}else l=p;else for(var g=0;g<s;g++){var p=O(o[g]),h=g===s-1;if(h&&a)f-=(c=' '+rk('ещё')+' '+a).length,r-=c.length;if(p.length>f){var m=r!==f&&f<10&&f/p.length<0.5;if(m)l+='\n',f=r;if(!m||p.length>f||c&&h)p=I(p,f);if(!h)p+=',\n';f=r;}else{if(h){if(c)p=I(p,f);}else p+=', ';f-=p.length;}l+=p;}return t+l+c+'?';function I(t,n){return t.substr(0,n-3)+'...';}function O(t){return t.get('title')||t.get('fileName');}},_dotTplFn:n,getIcon:function(){return'sprite:icon-24 icon-Signature icon-primary';},getCaption:function(){return rk('Подписать');},_getRedactionIds:function(t){var n=this,o=[],r=n._getCommandsManager(),s='function'===typeof r.getFilter&&r.getFilter(),a=r.viewerRecordSet,c=this._options.mainOptions.fixId||this._options.mainOptions.ctxLinkId&&this.getLinkedContext().getValue(this._options.mainOptions.ctxLinkId)||this._options.mainOptions.filter&&this._options.mainOptions.filter.folder;return l(t);function l(t){var r=[],s=new e();return i.getRedactionIds(t,n._options.mainOptions).addCallback(function(t){if(d(t,r,o),!r.length)s.callback(o);else if(n._options.mainOptions.useOnlyCtx)a.forEach(function(t){var n=t.get('attachId');if(t.get('folder@')&&-1!==r.indexOf(t.get('folder'))&&-1===r.indexOf(n))r.push(n);}),a.forEach(function(t){if(-1!==r.indexOf(t.get('folder'))&&u(t))o.push(t.get('redactionId'));}),s.callback(o);else f(r).addCallback(function(t){requirejs(['WS.Data/Chain'],function(n){l(new n(t).toArray()).addCallback(function(t){s.callback(t);});});});}),s;}function f(t){var i=new e();return requirejs(['WS.Data/Source/SbisService','WS.Data/Query/Query','Core/core-clone'],function(e,o,r){var a=new o(),l=s?r(s):{catalogId:c};l.folder=t,a.where(l),new e({endpoint:{address:n._options.mainOptions.serviceUrl+'service/',contract:n._options.mainOptions.objectName},binding:{query:'AttachList'},idProperty:'attachId',model:n._options.records[0].getOwner().getModel()}).query(a).addCallback(function(t){i.callback(t.getAll());});}),i;}function u(t){return t.get('redactionId')&&!t.get('folder@')&&!t.isEncrypted()&&!t.isLink();}function d(t,n,e){t.forEach(function(t){if(t.isFolder())n.push(t.get('attachId'));else if(u(t))e.push(t.get('redactionId'));});}}});});
define('js!SBIS3.DOCVIEW.upload',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.upload','js!SBIS3.DOCVIEW.Funcs','Core/EventBus','Core/Deferred','Core/detection','WS.Data/Source/SbisService','SBIS3.CONTROLS/Link','SBIS3.CONTROLS/Menu/MenuIcon','i18n!SBIS3.DOCVIEW.upload','Docview_localization'],function(e,n,o,t,i,r,a){'use strict';var s='downloadFileAndDecryptErrorEvent',d='downloadFileAndDecryptCompleteEvent';return e.extend({$protected:{idCmd:'upload',_play:function(e){e=e||{};var n=this._options.records,t=n[0],s=t.isEncrypted(),d=this;this._commandResult=new i();function c(){if('fileWithSigns'===e.item)return d._downloadViaIframe({url:t.get('relativeUrlWithSign')});if(n.length>1||!s)d._downloadWithoutPlugin(l,u);else{if(e.password)return d._downloadViaIframe({isEncrypted:true,password:e.password});requirejs(['js!SBIS3.DOCVIEW.Encryption'],function(e){new a({endpoint:{contract:'DocView',address:'/docview/service/'}}).call('ReadAttachmentInfo',{Service:'http://'+window.location.host+d._options.mainOptions.serviceUrl+'service/',Object:d._options.mainOptions.objectName,ID:t.get('attachId'),IDRedaction:t.get('redactionId')}).addCallback(function(n){var i=n.getRow(),a={isEncrypted:s};if(t.set('redactionId',i.get('redactionId')),e.getEncryptionType(i)===e.ENCRYPTION_TYPE_PASSWORD)e.showPasswordDialog().addCallback(function(e){a.password=e,d._downloadViaIframe(a);}).addErrback(function(e){d._commandResult.errback(e);});else{var c=e.canDecryptOnServer(i);if(o.isAuthenticated()&&c)e.activateServerCert(c).addCallbacks(function(e){if(a.stamp=e,r.isMobileSafari)requirejs(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(e){e.showConfirmDialog({message:rk('Файл расшифрован'),positiveButton:{caption:rk('Скачать')},negativeButton:{caption:rk('Отмена')}},d._downloadViaIframe.bind(d,a),function(){d._commandResult.errback('cancel');});});else d._downloadViaIframe(a);},function(e){d._commandResult.errback(e);});else d._downloadAndDecryptViaPlugin();}});});}}function l(){d._commandResult.callback();}function u(e){d._commandResult.errback(e);}if(t.get('versionForm')&&s){var f=this._getCommandsManager();if(f&&f.saveFedDocument)f.saveFedDocument().addCallback(c).addErrback(u);}else c();return d._commandResult;}},_downloadWithoutPlugin:function(e,n){var o=this,t=this._options.records||[],i=t[0],a=false===o._options.mainOptions._isAuth;if(!r.isMobileSafari&&o._options.mainOptions.isDisk&&(t.length>1||i&&i.get('folder@')))requirejs(['js!SBIS3.EDO.CD.CommonDocsHelpers'],function(n){var o=window.location.protocol+'//'+window.location.host+(a?n.getPublicDiskRestServiceURL():n.getDiskRestServiceURL()),i=t.map(function(e){return o+encodeURI(e.get('attachId'));});n.downloadFiles(i,a?'/disksharedrest/download':null),e();},n);else this._downloadViaIframe({isEncrypted:i.isEncrypted()});},_downloadViaIframe:function(e){var n=this,t=this._options.records[0],i=e.url||(e.isEncrypted?o.getUrlForDownloadEncryptedFile(t,this._options.mainOptions,e.stamp,e.password):o.getUrlForDownloadFile(t,this._options.mainOptions)),a;if(!r.isMobileSafari)(a=$('<iframe>')).addClass('ws-hidden').appendTo($('body')).on('load readystatechange',this._iframeLoadHandler.bind(this,a[0],e.isEncrypted,e.password)).attr('src',i);else{var s=window.open(i);if(e.isEncrypted)$(s).on('load',function(){if(n._getDownloadErrorMessage(s.document))o.alert({message:rk('Не удалось расшифровать файл. Возможно, был введен неверный пароль.')}),s.close();});}this._commandResult.callback();},_iframeLoadHandler:function(e,n,t,i){var r=e.contentDocument||e.contentWindow.document,a;if('readystatechange'===i.type&&'complete'!==r.readyState)return;if(a=this._getDownloadErrorMessage(r),$(i.target).remove(),a&&!n){if(!o.checkServiceAvailable({serviceUrl:'/disk/api/v1/'}))a=rk('Сервис СБИС.Диск на техническом обслуживании.')+'<br/>'+rk('Мы знаем об этом и уже исправляем. Попробуйте заглянуть сюда через 15 минут.');else if('string'!==typeof a||!a.trim())a=rk('При загрузке файла произошла ошибка.');o.alert({message:a});}else if(n)if(!t)this._downloadAndDecryptViaPlugin();else o.alert({message:rk('Не удалось расшифровать файл. Возможно, был введен неверный пароль.')});},_getDownloadErrorMessage:function(e){var n=$(e),o=n.find('body pre').text(),t,i,r;if(o)try{i=JSON.parse(o),r=i.message||i.error.details;}catch(e){r=rk('При загрузке файла произошла ошибка.');}else if(t=n.find('strong font').contents().filter(function(){return 3===this.nodeType;}),t.length)r=t[0].textContent;return r;},_downloadAndDecryptViaPlugin:function(){var e=this,n=this._options.records[0];requirejs(['js!SBIS3.DOCVIEW.Encryption'],function(o){o.downloadAndDecrypt(n,e._options.mainOptions).addBoth(function(n){if(!n||n instanceof Error){if('FILE_DOWNLOAD_EXCEPTION'!==n.errorType)e._downloadEncryptedWithConfirm();}else{var o=t.channel('SbisPluginEvent'),i=e._handleDownloadAndDecryptResult.bind(e);e.subscribeOnceTo(o,d,i),e.subscribeOnceTo(o,s,i);}});});},_downloadWithPlugin:function(e,n){var o=$.cookie('CpsUserId'),t=this._options.records,i=this;if(!o)return void this._downloadWithoutPlugin(e,n);requirejs(['js!SBIS3.Plugin/Source/LocalService'],function(r){var a=new r({endpoint:{address:'SBISDiskService-1.0.0.1',contract:'SBISDiskService'},options:{mode:'silent'}});a.isReady().addCallback(function(){var n=t.map(function(e){return{id:e.get('redactionId')||e.get('attachId'),name:e.get('fileName'),is_folder:Boolean(e.get('folder@'))};});return a.call('DownloadRemoteObject',{userUuid:o,domain:window.location.host,objectsIdName:n}).addCallback(function(n){if(!n)return new Error();e();});}).addErrback(function(){i._downloadWithoutPlugin(e,n);});},function(){i._downloadWithoutPlugin(e,n);});},_downloadEncryptedWithConfirm:function(){var e=this;requirejs(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(n){n.showConfirmDialog({message:rk('Не найден ключ для расшифровки'),details:rk('Скачать зашифрованный файл?'),positiveButton:{caption:rk('Скачать')},negativeButton:{caption:rk('Отмена')}},function(){e._downloadViaIframe({isEncrypted:false});},function(){e._commandResult.errback('cancel');});});},_dotTplFn:n,getIcon:function(){return'sprite:icon-24 icon-Save icon-primary';},getCaption:function(){return rk('Скачать');},_handleDownloadAndDecryptResult:function(e,n){if(n=n||{},'SAVE_ERROR'===n.ErrorType)return this._commandResult.errback('cancel');var o=this._options.records[0].get('redactionId'),t=n.DownloadId||null;if(!o||o!==t)return;if(e.name===s.toLowerCase())this._downloadEncryptedWithConfirm();else this._commandResult.callback();}});});
define('js!SBIS3.DOCVIEW.xmlEdit',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.xmlEdit','SBIS3.CONTROLS/Link','Docview_localization'],function(t,n){'use strict';return t.extend({_dotTplFn:n,$protected:{idCmd:'xmlEdit',_options:{confirmDialogDefaultButtonIsCancel:true},_play:function(){this.sendCommand('xmlEdit',this._options.records);},_getConfirmDialogText:function(){if(this._options.records[0].get('signs'))return rk('Документ подписан.\n Продолжить?');return'';}}});});
define('js!SBIS3.DOCVIEW.zoomMinus',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.zoomMinus','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.zoomMinus','Docview_localization'],function(n,t){'use strict';var e=n.extend({$protected:{idCmd:'zoomMinus',_play:function(){this._getCommandsManager().zoom('-');}},_dotTplFn:t,setEnabled:function(n){e.superclass.setEnabled.call(this,n),this.getChildControlByName('mainBtn').setEnabled(n);},isEnabled:function(){try{return this.getChildControlByName('mainBtn').isEnabled();}catch(n){return e.superclass.isEnabled.call(this);}}});return e;});
define('js!SBIS3.DOCVIEW.zoomPlus',['js!SBIS3.DOCVIEW.Command','tmpl!SBIS3.DOCVIEW.zoomPlus','SBIS3.CONTROLS/Link','i18n!SBIS3.DOCVIEW.zoomPlus','Docview_localization'],function(o,n){'use strict';return o.extend({$protected:{idCmd:'zoomPlus',_play:function(){this._getCommandsManager().zoom('+');}},_dotTplFn:n});});