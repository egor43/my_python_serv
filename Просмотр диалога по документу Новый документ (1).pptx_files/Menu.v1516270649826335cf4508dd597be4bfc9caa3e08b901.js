define("Deprecated/Controls/Menu/Menu",["Deprecated/RecordSet","Core/helpers/string-helpers","Core/helpers/random-helpers","Core/helpers/dom&controls-helpers","Core/helpers/Hcontrol/trackElement","Core/WindowManager","Core/IoC","Core/constants","Lib/Control/Control","Lib/Type/TDataSource/TDataSource","html!Deprecated/Controls/Menu/Menu","html!Deprecated/Controls/Menu/Menu_item","Core/EventObject","css!Deprecated/Controls/Menu/Menu","is!browser?cdn!jquery-ui/1.12.1.2/jquery-ui-position.js"],function(e,t,n,i,s,o,u,a,r,d,h,f,l){"use strict";a.Menu={menuBorderWidth:2,offsetSubMenu:{top:-6,left:0},subMenuIconWidth:24,imagePadding:32};var c=r.Control.extend({$protected:{_keysWeHandle:[a.key.esc],_options:{itemRender:void 0,data:[],turnLeftSubMenu:false,dataSource:d,captionColumn:void 0},_itemEvents:{},_visible:false,_menu:void 0,_windowResizeHandler:void 0,_initialized:false,_fontProperties:{styles:{},underline:false},_focusOutHandler:void 0,_optionsShowMenu:{},_keyDownHandler:void 0,_opener:void 0},$constructor:function(){if(this._initialized)return;this._initialized=true,this._publish("onClose","onOpen","onMouseEnter","onMouseLeave","onActivated","onItemsChange","onAfterRender");var t=a.$doc.find("body"),n;if(this._container)this._container.detach().appendTo(t);else t.append(this._container=$("<div></div>"));if(this._container[0].wsControl=this,!Object.isEmpty(this._options.dataSource||{})&&this._options.dataSource.isConfigured())this.setData(new e(this._options.dataSource)),n=true;if(this._container.addClass("ws-menu ws-menu-container").attr("id",this.getId()),this._container.addClass("ws-hidden"),this._getFontProperties(),!n)this._drawMenu();this._initMenuEvents(),this._notify("onReady",this)},_drawMenu:function(){this._container.empty().prepend(h(this._options,this)),this._menu=$(this._container.find(".menu-ul")[0]).addClass("ws-main-menu"),this._makeMenuItems(this._menu,this._options.data),this._notify("onAfterRender")},setCaptionColumn:function(e){if(e&&"string"===typeof e)this._options.captionColumn=e},_recordSetLoadHandler:function(e){var t=this._getChildItems(e,e.recordChilds(null)),n;if(this.hide(),n=this._buildItems(e,t),n.length>0)this._options.data=n,this._itemEvents={};this._drawMenu()},setData:function(t){var n=this;if(t instanceof e&&this._options.captionColumn)t.isLoaded()?this._recordSetLoadHandler.apply(this,[t]):t.subscribe("onAfterLoad",function(){n._recordSetLoadHandler(this)})},_buildItems:function(e,t){for(var n=[],i,s=0,o=t.length;s<o;s++)if(i=t[s],i.hasColumn(this._options.captionColumn)){var u=i.get(this._options.captionColumn),a=i.getKey(),r;if(u)if(n.push({id:a,caption:u}),i.isBranch())if(r=e.recordChilds(a),r.length>0)n[s].subMenu=this._buildItems(e,this._getChildItems(e,r))}return n},_keyboardHover:function(e){if(e.which===a.key.esc&&this.isShow())return this.hide(),false;else return c.superclass._keyboardHover.apply(this,arguments)},_getChildItems:function(e,t){for(var n=[],i=0,s=t.length;i<s;i++)n.push(e.getRecordByPrimaryKey(t[i]));return n},setSource:function(t){if(t instanceof Object)this.setData(new e(t)),this._options.dataSource=t},_getFontProperties:function(){this._fontProperties.styles={};for(var e=["font-family","font-weight","font-style","text-align","color"],t=this._container,n=this._fontProperties.styles,i=0,s=e.length;i<s;n[e[i]]=t.css(e[i++]));this._fontProperties.underline=-1!=t.css("text-decoration").indexOf("underline")},_applyFontProperties:function(e){var t=this._fontProperties;e.toggleClass("ws-font-with-underline",t.underline),e.css(t.styles)},getMenuUL:function(){return this._menu},_makeMenuItems:function(e,t){var i=this;this._applyFontProperties(e);for(var s=0,o=t.length;s<o;s++)(function(){var o=t[s],u=$(e.children()[s]),a=o.subMenu;if(o.parentCfg=t,a){o.subMenuId=n.randomId(),a.parentMenu=t;var r=$(h(a,i)).attr("id",o.subMenuId);i._container.append(r),i._makeMenuItems.call(i,r,a)}else if(void 0!==o.id&&!Object.isEmpty(o.handlers))i._itemEvents[o.id]=o.handlers;i._initItemEvents(u,o)})();if(e.find(".ws-menu-hasImg").length>0)e.addClass("ws-menu-image-padding")},_renderElement:function(e,n){var i=n,s;if("function"===typeof this._options.itemRender)if(s=this._options.itemRender.apply(this,arguments),s){if(s instanceof Object&&"jquery"in s)s=s[0].outerHTML;if("string"===typeof s)i=t.escapeTagsFromStr(s,["script"])}return i},_initItemEvents:function(e,t){if(t.caption){var n=this,i=t.id;e.bind({click:function(s){if(!n._container.hasClass("ws-disabled")&&!e.hasClass("ws-disabled"))if(!t.subMenu){s.stopImmediatePropagation();var o=n._notify("onActivated",i,t);if(n._activateItemMenuHandler(i,t,s),false!=o)n.hide()}},mouseleave:function(){n._itemHoverHandler(e,t),n._notify("onMouseLeave",i,e)},mouseenter:function(){n._itemHoverHandler(e,t,true),n._notify("onMouseEnter",i,e)}})}},_onKeyDown:function(e){if(27===e.keyCode)this.hide()},_initMenuEvents:function(){var e=this;this._windowResizeHandler=this._closeOnResize.bind(this),this._focusOutHandler=this._hideOnFocusOut.bind(this),this._keyDownHandler=this._onKeyDown.bind(this),this.subscribe("onOpen",function(){a.$win.bind("resize",e._windowResizeHandler),a.$doc.bind("mouseup",e._focusOutHandler),a.$doc.bind("keydown",e._keyDownHandler)}),this.subscribe("onClose",function(){a.$win.unbind("resize",e._windowResizeHandler),a.$doc.unbind("mouseup",e._focusOutHandler),a.$doc.unbind("keydown",e._keyDownHandler)})},_closeOnResize:function(){if(this._visible)this.hide()},_hideOnFocusOut:function(e){var t=$(e.target),n=t.parents(".ws-button-menu-clone-container"),i=t.parents(".ws-menu-container")[0],s=t.closest(".ws-has-parent-menu");if(this._visible&&t.data("openedMenuId")!=this.getId()&&$(i).attr("id")!=this.getId()&&!s.length&&s.attr("for-menu")!=this.getId()||n.length)this.hide()},_hideAllSubMenu:function(e,t){if(e.activeMenu){if(e.activeMenuCfg.activeMenu)this._hideAllSubMenu.call(this,e.activeMenuCfg);if(this._container.find("#"+e.activeMenu).addClass("ws-hidden"),t)this._container.find("#"+t).closest(".menu-ul").find(".ws-menu-item-active").removeClass("ws-menu-item-active"),this._removeActiveClass(e);delete e.activeMenuCfg,delete e.activeMenu}},_removeActiveClass:function(e){if("undefined"!==typeof e)for(var t=0,n=e.length;t<n;t++){var i=e[t].subMenuId;if(i)this._container.find("#"+i+" .ws-menu-item-active").removeClass("ws-menu-item-active"),this._removeActiveClass(e.activeMenuCfg)}},_itemHoverHandler:function(e,t,n){if(!this._container.hasClass("ws-disabled")&&!e.hasClass("ws-disabled")){if(n)if(this._hideAllSubMenu(t.parentCfg,t.id),t.subMenu){if(t.parentCfg)t.parentCfg.activeMenu=t.subMenuId,t.parentCfg.activeMenuCfg=t.subMenu;var i=this._container.find("#"+t.subMenuId);e.addClass("ws-menu-item-active"),i.removeClass("ws-hidden"),i.position({my:(this._options.turnLeftSubMenu?"right":"left")+" top",at:(this._options.turnLeftSubMenu?"left":"right")+" top",collision:"flip",of:e,offset:(this._options.turnLeftSubMenu?-a.Menu.offsetSubMenu.left:a.Menu.offsetSubMenu.left)+" "+a.Menu.offsetSubMenu.top})}}else if(n)this._hideAllSubMenu(t.parentCfg,t.id)},isShow:function(){return this._visible},_checkOnSubMenu:function(){this._container.find(".menu-ul").each(function(e,t){var n=$(t);n.toggleClass("ws-menu-with-submenu",n.find(".ws-with-submenu:not(.ws-hidden)").length>0)})},show:function(e,t,n,i,u,a){if(this._checkOnSubMenu(),this._opener=o.getActiveWindow(),e instanceof Element)e=$(e);var r=this._container,d=this,h=e?e instanceof $?true:"object"===typeof e?false:null:null,f=null!==h?h?e:jQuery.Event("",{pageX:e.left||e.clientX,pageY:e.top||e.clientY}):null;if(this._optionsShowMenu={fixedMenuAngle:{objectTop:n&&void 0!==n.objectTop?n.objectTop:true,objectLeft:n&&void 0!==n.objectLeft?n.objectLeft:true,targetTop:n&&void 0!==n.targetTop?n.targetTop:true,targetLeft:n&&void 0!==n.targetLeft?n.targetLeft:true},menuOffset:{left:t&&t.left?t.left:0,top:t&&t.top?t.top:0},needFlip:{horizontal:i&&void 0!==i.horizontal?i.horizontal:true,vertical:i&&void 0!==i.vertical?i.vertical:true,doFit:i&&void 0!==i.doFit?i.doFit:false},menuTarget:f||e,within:a},this._hideAllSubMenu(this._options.data),this._menu.removeClass("ws-hidden"),r.removeClass("ws-hidden"),this._visible=true,this._notify("onOpen"),this._optionsShowMenu.menuTarget instanceof $)if($(this._optionsShowMenu.menuTarget).data("openedMenuId",this.getId()),true!==u)s(this._optionsShowMenu.menuTarget).subscribe("onMove",function(){d._recalculateMenu()},this);this._recalculateMenu(),r.focus()},getOpener:function(){return this._opener},_recalculateMenu:function(){if(this._visible){var e=this._container,t=this._menu.width()+2*a.Menu.menuBorderWidth,n=this._menu.height(),s=this._optionsShowMenu,o=a.$body.width()/2,u=s.menuTarget instanceof $?s.menuTarget.offset():{left:s.menuTarget.pageX,top:s.menuTarget.pageY},r=0,d=document.body.clientWidth,h=i.getDocumentHeight();if(s.menuTarget&&$(s.menuTarget).hasClass("icon-AddButton")){var f=$(s.menuTarget).closest(".ws-button-link");if(f.length)r=(parseInt(f.width(),10)-24)/2}o-=this._menu.hasClass("ws-menu-with-submenu")?a.Menu.subMenuIconWidth:0+this._menu.hasClass("ws-menu-with-submenu")?a.Menu.subMenuIconWidth:0,e.css({minWidth:t,minHeight:n}),this._menu.find(".menu-span").css({maxWidth:o,overflow:"hidden","text-overflow":"ellipsis"}),e.position({my:(s.fixedMenuAngle.objectLeft?"left":"right")+" "+(s.fixedMenuAngle.objectTop?"top":"bottom"),at:(s.fixedMenuAngle.targetLeft?"left":"right")+" "+(s.fixedMenuAngle.targetTop?"top":"bottom"),collision:(s.needFlip.horizontal?s.needFlip.doFit?"fit":"flip":"none")+" "+(s.needFlip.vertical?s.needFlip.doFit?"fit":"flip":"none"),of:s.menuTarget,within:s.within||a.$win,using:function(i){i.left=Math.round(i.left);var o=i.left<Math.round(u.left),a=Math.round(i.top)<Math.round(u.top);e.toggleClass("menu-left-turn",o).toggleClass("menu-top-turn",a),i.left+=s.fixedMenuAngle.objectLeft?o&&!s.needFlip.doFit?-s.menuOffset.left-r:s.menuOffset.left+r:o&&!s.needFlip.doFit?s.menuOffset.left+r:-s.menuOffset.left-r,i.top+=s.fixedMenuAngle.objectTop?a?-s.menuOffset.top:s.menuOffset.top:a?s.menuOffset.top:-s.menuOffset.top,i.top=i.top+n>h?h-n:i.top,i.left=i.left+t>d?d-t:i.left,e.css({top:i.top,left:i.left})}})}},hide:function(e){if(this._opener=null,!e||this.isShow()){if(this._optionsShowMenu&&this._optionsShowMenu.menuTarget instanceof $)this._optionsShowMenu.menuTarget.removeData("openedMenuId"),s(this._optionsShowMenu.menuTarget,false);if(this._hideAllSubMenu(this._options.data),this._container.find(".ws-menu-item-active").removeClass("ws-menu-item-active"),this._container.addClass("ws-hidden"),this._menu)this._menu.addClass("ws-hidden");this._notify("onClose"),this._visible=false}},toggle:function(){return this[this._visible?"hide":"show"].apply(this,arguments)},getMenuWidth:function(){var e=$("<div id='template_platformMenu' class='ws-menu-container' style='visibility: hidden;'></div>"),t=$(this._menu.clone()).css({width:"auto",visibility:"hidden"}).removeClass("ws-hidden").appendTo(e);e.css("width","auto"),$("body").append(e);var n=t.outerWidth();return $(e).remove(),n},setMenuWidth:function(e){if("number"===typeof e)this._menu.css("width",e+"px");else if("auto"===e)this._menu.css("width",e)},isMenu:function(){return true},_activateItemMenuHandler:function(e,t,n){this._itemHandlers(e,t,"onActivated",n)},_itemHandlers:function(e,t,n,i){var s=this._itemEvents[e]?this._itemEvents[e][n]:false;if(s&&"function"==typeof s)s.apply(this,true===s.isCommand?[new l(i)]:[e,t])},showItem:function(e){if(this.hasItem(e))this._container.find("#"+e).removeClass("ws-hidden"),this._recalculateMenu(),this._notify("onItemsChange")},hideItem:function(e){if(this.hasItem(e)){var t=this._findMenuElementAndDoAction(this._options.data,e);if(t.subMenu&&t.subMenu.parentMenu)this._hideAllSubMenu(t.subMenu.parentMenu);this._container.find("#"+e).addClass("ws-hidden"),this._recalculateMenu(),this._notify("onItemsChange")}},toggleItem:function(e,t){if(this.hasItem(e))this[t?"showItem":"hideItem"](e)},setEnabledById:function(e,t){if(this.hasItem(e))t=!!t,this._container.find("#"+e).toggleClass("ws-disabled",!t)},addSubMenu:function(e,t){if(this.hasSubMenu(e))this.destroySubMenu(e);if(e&&this.hasItem(e)&&t&&t.constructor===Array){var n=this._findMenuElementAndDoAction(this._options.data,e,this._addSubMenu,t),i=$(h(t,this)).attr("id",n.subMenuId),s=this._container.find("#"+n.id);if(this.hide(),this._container.append(i),s.addClass("ws-with-submenu").append($('<span class="ws-submenu-icon"></span>')),delete this._itemEvents[e],this._makeMenuItems(i,t),i.find(".ws-menu-hasImg:first").length>0)i.addClass("ws-menu-image-padding")}},_addSubMenu:function(e,t,i){var s=e[t];s.subMenu=i,s.subMenuId=n.randomId(),s.subMenu.parentMenu=s.subMenu.parentCfg=s},hasSubMenu:function(e){return this.hasItem(e)?this._container.find("#"+e).hasClass("ws-with-submenu"):false},destroySubMenu:function(e){if(e&&this.hasItem(e)){var t=this._findMenuElementAndDoAction(this._options.data,e);if(t.subMenu)this.hide(),this._container.find("#"+t.id+" .ws-submenu-icon").remove(),this._destroySubMenu(t),this._container.find("#"+t.id).removeClass("ws-with-submenu"),this._notify("onItemsChange")}},_destroySubMenu:function(e){for(var t=0,n=e.subMenu.length;t<n;t++)if(e.subMenu[t].subMenu)this._destroySubMenu(e.subMenu[t]);this._container.find("#"+e.subMenuId).remove(),delete e.subMenu,delete e.subMenuId},_addItem:function(e,t,n){n.parentCfg=e[t].parentCfg,e.splice(t,0,n)},addItem:function(e){this.insertItem(e)},insertItem:function(e,t){if(!e&&"[object Object]"!==Object.prototype.toString.call(e))return void u.resolve("ILogger").log("Menu",'element can not be created, because parameter "item" is undefined.');if(this.hasItem(e.id))return void u.resolve("ILogger").log("Menu","element can not be created, because ID "+e.id+'" is already used.');var n=this._options.data.length-1;if(void 0===t)t=this._options.data.length;var i=$(f(e,this)),s;if(this._recalculateMenu(),void 0!==e.id&&void 0!==e.caption){if(e.handlers&&e.handlers instanceof Object)this._itemEvents[e.id]=e.handlers;this._itemEvents[e.id]=e.handlers,this._initItemEvents(i,e)}if("number"===typeof t)if(t<0)this._menu.prepend(i),e.parentCfg=this._options.data,this._options.data.push(e);else if(t>n)this._menu.append(i),e.parentCfg=this._options.data,this._options.data.push(e);else{if(t=this._options.data[t].id,!t)return;s=this._findMenuElementAndDoAction(this._options.data,t,this._addItem,e),i.insertBefore(this._container.find("#"+s.id))}else s=this._findMenuElementAndDoAction(this._options.data,t,this._addItem,e),i.insertBefore(this._container.find("#"+s.id));this._recalculateMenu(),this._notify("onItemsChange")},applyItemStyle:function(e,t){if(!Object.isEmpty(t)){var n=Object.prototype.toString.call(e),i;if(n=n.slice(8,n.length-1),"Number"===n)i=this._container.find(".ws-main-menu li").eq(e-1);else if("String"===n)i=this._container.find("#"+e);if(i.length>0)i.css(t)}},_findMenuElementAndDoAction:function(e,t,n,i){for(var s,o,u=0,a=e.length;u<a;u++)if(s=e[u],s.id&&s.id===t){if(o=s,"function"===typeof n)n(e,u,i);break}else if(s.subMenu)o=this._findMenuElementAndDoAction(s.subMenu,t,n,i);return o},removeItem:function(e){if(e&&this.hasItem(e)){this.destroySubMenu(e);var t=this._container.find("#"+e);if(t.length)t.remove();this._findMenuElementAndDoAction(this._options.data,e,this._removeItem),this._recalculateMenu(),this._notify("onItemsChange")}},_removeItem:function(e,t){e.splice(t,1)},getData:function(){return this._options.data},hasItem:function(e){return"string"===typeof e&&e.length&&this._container.find("#"+e).length>0},getMinWidth:function(){return 0},getMinHeight:function(){return 0},destroy:function(){this._opener=null,this._closeOnResize(),this._menu=null,this._windowResizeHandler=null,this._focusOutHandler=null,c.superclass.destroy.call(this,arguments)},setItemText:function(e,t){if(this.hasItem(e))t=t||"",this._container.find("#"+e+" .menu-span").text(t),this._findMenuElementAndDoAction(this._options.data,e,function(e,n){e[n].caption=t}),this._recalculateMenu(),this._notify("onItemsChange")},setItemIcon:function(e,t){if("string"===typeof t&&this.hasItem(e)&&-1!==t.indexOf("sprite:")){var n=this._container.find("#"+e),i=n.find(".ws-menu-image");if(0===i.length)n.prepend(i=$('<div class="ws-menu-image"></div>')),n.removeClass("ws-menu-item-without-image").addClass("ws-menu-hasImg");i.removeClass(i.attr("class").split("ws-menu-image")[1]).addClass(t.split("sprite:")[1]),this._findMenuElementAndDoAction(this._options.data,e,function(e,n){e[n].imgSrc=t}),this._notify("onItemsChange")}},setItemClickHandler:function(e,t){if(!this.hasSubMenu(e)&&"function"===typeof t){if("undefined"===typeof this._itemEvents[e])this._itemEvents[e]={};this._itemEvents[e].onActivated=t}},setItemTooltip:function(e,t){if(this.hasItem(e))this._container.find("#"+e).attr("title",t),this._findMenuElementAndDoAction(this._options.data,e,function(e,n){e[n].tooltip=t}),this._notify("onItemsChange")}});return c});
//# sourceMappingURL=Menu.js.map