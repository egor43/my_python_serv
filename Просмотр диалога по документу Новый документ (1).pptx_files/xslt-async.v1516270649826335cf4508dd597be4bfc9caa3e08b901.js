define("Core/xslt-async",["Core/constants","Core/detection","Core/core-extend","Core/IoC","Deprecated/helpers/additional-helpers","Core/Deferred","Core/ParallelDeferred","Deprecated/xslt"],function(e,t,n,r,o,a,l,i){var s=o.axo,c={TRANSFORM_TO_TEXT:1,TRANSFORM_TO_DOC:2,TRANSFORM_TO_FRAGMENT:4,LOAD_URL:8,LOAD_TEXT:16};function u(e){if("string"==typeof e)e=e.replace(/[^\x09\x0A\x0D\x20-\uD7FF\uE000-\uFFFD\u10000-\u10FFFF]*/g,"");return e}function d(e,t){var n=/(document\('[0-9A-z\/)(.,-]+'\))/gi,r,o;if(e.length>0){var a=t.createElement("xsl:template");a.setAttribute("match","ws-foreign-documents-namespace"),t.documentElement.appendChild(a);for(var l=0,i=e.length;l<i;l++)if(r=e[l][0].getAttribute("select"),o=r.split(n),o&&o[2])e[l][0].setAttribute("select",e[l][1]+o[2]);else e[l][0].setAttribute("select",e[l][1])}}var f=n.extend({},{$protected:{_xmlDoc:"",_xslDoc:"",_loadedFiles:[],_options:{xml:"",xsl:"",errback:void 0},_nsResolver:null},$constructor:function(){var e=new m({name:this._options.xml,errback:this._options.errback}).getDocument(),n=new m({name:this._options.xsl}).getDocument(),r=e instanceof a?e:(new a).callback(e),o=n instanceof a?n:(new a).callback(n);if(this._mainDef=new l,this._mainDef.push(r),this._mainDef.push(o),this._xmlDoc=null,this._xslDoc=null,t.webkit||t.chrome)this._nsResolver=function(e){switch(e){case"xsl":return"http://www.w3.org/1999/XSL/Transform";default:return null}}},execute:function(){var e=this,n=new a;return e._mainDef.done().getResult().addCallback(function(r){if(e._xmlDoc=e._xmlDoc||r[0],e._xslDoc=e._xslDoc||r[1],t.webkit||t.chrome)e._chromeWorkaround().addCallback(function(){n.callback(e)});else n.callback()}),n},_loadDoc:function(e){if(-1==this._loadedFiles.indexOf(e)){var t=new m({name:e}).getDocument();return this._loadedFiles.push(e),t}else return r.resolve("ILogger").log("XSLTransfor","Potential cyclic dependency on file "+e),null},_chromeWorkaround:function(){var e=this,t=new l,n=new a,r=new a,o;if(this._preparseImports(this._xslDoc).done().getResult().addCallback(function(){e._preparseImportAppliance(e._xslDoc),n.callback()}),this._preparseIncludes(this._xslDoc).done().getResult().addCallback(function(){r.callback()}),o=this._preparseDocumentFunction(this._xmlDoc,this._xslDoc),o instanceof a)t.push(o);return t.push(n),t.push(r),t.done().getResult()},_xslIEWorkaround:function(e){var t=new l,n=new a,r=this;if(e.selectNodes("//xsl:import").length){var o=new a;t.push(o),this._xslIEImports(e,"//xsl:import").addCallback(function(e){e=r._preparseImportApplianceIE(e),o.callback(e)})}if(e.selectNodes("//xsl:include").length){var i=new a;t.push(i),e=this._xslIEIncludes(e,"//xsl:include").addCallback(function(e){i.callback(e)})}return t.done().getResult().addCallback(function(){n.callback(e)}),n},_preparseImportApplianceIE:function(e){var t=e.selectNodes("//xsl:apply-imports");if(t.length>0){var n=t[0],r=n.parentNode,o=e.createElement("xsl:apply-templates");o.setAttribute("select","."),o.setAttribute("mode","imports"),r.replaceChild(o,n)}return e},_moveChildrenIE:function e(t,n){if(n.childNodes.length>0)for(var r=0;r<t.length;r++)n.insertBefore(t[r],n.childNodes[0]);else for(var r=0;r<t.length;r++)n.appendChild(t[r]);return n},_checkTemplates:function e(t,n){if(t.getAttribute("match"))for(var r=0;r<n.length;r++)if(t.getAttribute("match"))if(n[r].getAttribute("match")===t.getAttribute("match"))this._moveChildrenIE(t.childNodes,n[r]),t.setAttribute("mode","imports")},_xslIEImports:function e(t,n){var r=new l,o=new a,i=t.selectNodes(n),s=t.selectNodes("//xsl:template"),c=t.documentElement,u=this,d;if(i.length>0)for(var f=0;f<i.length;f++)(function(e){var t=i[e].getAttribute("href"),n=new h({name:t}).getDocument();if(n)r.push(n.addCallback(function(t){if(t)u._xslIEWorkaround(t).addCallback(function(t){var n=t.documentElement.childNodes;while(n.length>0){if(d=n.nextNode(),"xsl:template"===d.nodeName)u._checkTemplates(d,s);c.insertBefore(d,i[e])}c.removeChild(i[e])});else c.removeChild(i[e])}));else c.removeChild(i[e])})(f);return r.done().getResult().addCallback(function(){o.callback(t)}),o},_xslIEIncludes:function e(t,n){var r=new l,o=new a,i=t.selectNodes(n),s=t.documentElement,c=this,u;if(i.length>0)for(var d=0;d<i.length;d++)(function(e){var t=i[e].getAttribute("href"),n=c._xslIEIncludes(new h({name:t}).getDocument());if(n)r.push(n.addCallback(function(t){if(t){var n=t.documentElement.childNodes;while(n.length>0)u=n.nextNode(),s.insertBefore(u,i[e]);s.removeChild(i[e])}else s.removeChild(i[e])}));else s.removeChild(i[e])})(d);return r.done().getResult().addCallback(function(){o.callback(t)}),o},_convertAbsolutePath:function(e,t){if("/"!==e.charAt(0)){if(""===t)t=window.location.protocol+"//"+window.location.hostname;else if(t.lastIndexOf("/")>t.indexOf("//")+1)t=t.substring(0,t.lastIndexOf("/"));while(/^\.\.\//.test(e)){if(t.lastIndexOf("/")>t.indexOf("//")+1)t=t.substring(0,t.lastIndexOf("/"));e=e.substring(3)}e=(e=t+"/"+e).replace("./","")}return e},_preparseIncludes:function(e){for(var t=new l,n=e.getElementsByTagName("include"),r=n.length,o=this,a=0;a<r;a++)(function(r){var a=n[r],l=o._convertAbsolutePath(a.getAttribute("href"),e.URL),i=o._loadDoc(l),s=a.parentNode;if(i)t.push(i.addCallback(function(t){if(t)for(var n=t.documentElement.childNodes,r=0,o=n.length;r<o;r++)s.insertBefore(e.importNode(n[r],true),a);s.removeChild(a)}));else s.removeChild(a)})(a);return t},_preparseImportAppliance:function(e){var t=e.getElementsByTagName("apply-imports");while(t.length>0){var n=t[0],r=n.parentNode,o=e.createElement("xsl:apply-templates");o.setAttribute("select","."),o.setAttribute("mode","imports"),r.replaceChild(o,n)}},_preparseImports:function(e){var n=new l,o,a,i=this;if(t.isMac)o=e.getElementsByTagName("xsl:import");else o=e.getElementsByTagName("import");a=o.length;for(var s=0;s<a;s++)(function(t){var a=o[t],l=i._convertAbsolutePath(a.getAttribute("href"),e.URL),s=i._loadDoc(l),c=a.parentNode;if(s)n.push(s.addCallback(function(t){if(t)for(var n=t.documentElement.childNodes,o=0,l=n.length;o<l;o++){var s=n[o];if("xsl:template"==s.nodeName){if(s.hasAttribute("name")){var u=s.getAttribute("name"),d=e.evaluate("count(//xsl:template[@name='"+u+"'])",e,i._nsResolver,XPathResult.NUMBER_TYPE,null);if(d&&d.numberValue>0){r.resolve("ILogger").log("xslt","Ignored duplicate named template: "+u);continue}}if(s.hasAttribute("match")){var f=s.getAttribute("match"),m=e.evaluate("count(//xsl:template[@match='"+f+"'])",e,i._nsResolver,XPathResult.NUMBER_TYPE,null);if(m&&m.numberValue>0)s.setAttribute("mode","imports")}}c.insertBefore(e.importNode(s,true),a)}c.removeChild(a)}));else c.removeChild(a)})(s);return n},handleForeignDoc:function(e,t,n,r,o,a,l){var i="x"+e.replace(/[\/)(:]/g,"-")+"-document",s=t.createElement(i);if(this._getForeignDocContainer(t).appendChild(s),s.appendChild(t.importNode(a.documentElement,true)),l)n="//ws-foreign-documents-namespace/"+i;else n="//ws-foreign-documents-namespace/"+i+n.substring(e.length+12);r.push([o,n])},_preparseDocumentFunction:function(e,t){var n=t.evaluate("//*[contains(@select, 'document(')]",t,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null),r,o=[],i=this,s=false,c=new a,u=new l;while(null!==(r=n.iterateNext())){var f=r.getAttribute("select"),m=f.match(/document\('([^]+)'\)/);if(m&&m.length>0){var h=this._convertAbsolutePath(m[1],t.URL),p=this._loadDoc(h);if(p)if(s=p instanceof a,s)(function(t,n){p.addCallback(function(n){i.handleForeignDoc.call(this.xslt,t,e,f,o,this.doc,n,true)}.bind({xslt:i,doc:n}))})(h,r),u.push(p);else i.handleForeignDoc.call(this,h,e,f,o,r,p)}}if(s)return u.done().getResult().addCallback(function(){d(o,t),c.callback(true)}),c;else d(o,t)},_getForeignDocContainer:function(e){var t=e.getElementsByTagName("ws-foreign-documents-namespace")[0];if(!t)t=e.createElement("ws-foreign-documents-namespace"),e.documentElement.appendChild(t);return t},_insertForeignDoc:function(e,t){var n=new m({name:t}),r="xxx",o=this._getForeignDocContainer(e),a=e.createElement(r);a.appendChild(a.importNode(n.getDocument(),true)),o.appendChild(a)},_ieAddParams:function(e,t){if(!t)return e;for(var n in t)try{var r=t[n];if("boolean"===typeof r||isNaN(parseInt(r,10))&&("string"!==typeof r||"'"!==r.charAt(0)))r="'"+r+"'";var o=e.selectSingleNode('//xsl:param[@name="'+n+'"]');if(o)o.setAttribute("select",r)}catch(e){throw new Error("Problems with setting parameter "+n+" in the xsl transform")}return e},transformToText:function(e){var n=new a,r;if(window.XMLSerializer&&(!t.isIE||t.isIE12))return r=this.transformToDocument(e),this.includeCss(r,function(e){n.callback((new XMLSerializer).serializeToString(e))}),n;else if(s){var o=this;return this._xslIEWorkaround(this._xslDoc).addCallback(function(t){o._xslDoc=t,r=o._ieAddParams(o._xslDoc,e),o.includeCss(r,function(e){try{n.callback(o._xmlDoc.transformNode(e))}catch(e){n.errback(e)}},true)}),n}throw new Error("Transform to text is not supported in your environment")},includeCss:function(e,t,n){var r=$(e).find("head"),o=r.find("link"),i=[],s=new l;if(o.length)(o=o.toArray()).forEach(function(e){var t=$(e);i.push(t.attr("href")),t.remove()}),i.forEach(function(e){s.push(function(){var t=new XMLHttpRequest,n=new a;return t.open("GET",e,true),t.send(""),t.onreadystatechange=function(){if(4==t.readyState)n.callback(t)},n})});s.done().getResult().addCallback(function(o){for(var a in o){if(!o.hasOwnProperty(a))continue;var l=o[a];if(n){var i=e.createElement("style");if(i.text=l.responseText,r&&r[0])r[0].appendChild(i)}else r.append($("<style>"+l.responseText+"</style>"))}t(e)})},transformToDocument:i.prototype.transformToDocument,transformToFragment:i.prototype.transformToFragment,getCapabilities:i.prototype.getCapabilities,destroy:i.prototype.destroy}),m=function(e){return r.resolve("IXMLDocument",e)},h=n.extend({},{$protected:{_options:{name:"",errback:void 0},_doc:null},$constructor:function(){this._doc=this._loadDocument(this._options.name)},getDocument:function(){return this._doc},checkDocument:function(e){var t=null;if(e)if(e.parseError){if(0!==e.parseError.errorCode)t=e.parseError.reason}else{var n=e.getElementsByTagName("parsererror");if(n.length)t=n[0].textContent}else t="Empty document";if(null!==t&&!this._options.errback)throw new EvalError("Parse error: "+t);return e},_loadDocument:function(e){var t=null,n=this,r;if(e.documentElement)t=e;else t=this["_loadDocumentFrom"+(this._isUrl(e)?"Url":"String")](e);if(t instanceof a){if(t.addCallback(function(e){return n.checkDocument(e)}),this._options.errback)t.addErrback(this._options.errback);r=t}else(r=new a).callback(this.checkDocument(t));return r},_loadDocumentFromString:function(e){var t=null,n=new a;if(e=u(e),s)(t=s("Microsoft.XMLDOM")).async=false,t.loadXML(e);else if(window.DOMParser)t=(new DOMParser).parseFromString(e,"text/xml");if(null!==t)return n.callback(t),n;throw new Error("Your environment is not able to parse XML documents from string")},_loadDocumentUsingXHR:function(e){var n=new XMLHttpRequest,r=new a;if(t.chrome&&/\.(xml|xsl)$/.test(e))e+="?_="+Math.random();return n.open("GET",e,true),n.send(""),n.onreadystatechange=function(){if(4==n.readyState)r.callback(n)},r},_loadDocumentFromUrl:function(e){var t;if(s){var n=s("Microsoft.XMLDOM");if(window.XMLHttpRequest)(t=this._loadDocumentUsingXHR(e)).addCallback(function(e){return n.loadXML(u(e.responseText)),n});else n.async=false,n.load(e),t.callback(n);return t}else return t=this._loadDocumentUsingXHR(e),t.addCallback(function(e){return e.responseXML}),t},_isUrl:function(e){if(void 0===e.substr||""===e||!e)return false;if(!/^http[s]?:/.test(e)){var t=e.substr(0,1);if("/"!=t&&"."!=t)if("<"==t)return false}return true},destroy:function(){this._doc=null,this._options=null}});return r.bind("IXMLDocument",h),e.XSLTCaps=c,f}),define("js!SBIS3.CORE.XSLT-ASYNC","");
//# sourceMappingURL=xslt-async.js.map