define("Deprecated/Controls/RecordFloatArea/RecordFloatArea",["Deprecated/Controls/DialogRecord/DialogRecord","Lib/Control/Dialog/Dialog","Lib/Control/FloatArea/FloatArea","Deprecated/Controls/ModalOverlay/ModalOverlay","Core/DependencyResolver","Core/CommandDispatcher","Core/IoC","Core/EventBus","Transport/ReportPrinter","Core/core-instance","Core/Deferred","Core/helpers/additional-helpers","Core/helpers/Function/forAliveOnly","css!Deprecated/Controls/RecordFloatArea/RecordFloatArea","i18n!Deprecated/Controls/RecordArea/RecordArea"],function(e,t,o,n,i,r,s,a,l,c,p,d,u){"use strict";i.register("Deprecated/Controls/RecordFloatArea/RecordFloatArea",[],"Lib/Control/FloatArea/FloatArea");var f=a.globalChannel(),h=s.resolve("ILogger"),g=o.extend({$protected:{_options:{readOnly:false,newRecord:false,reports:{},doNotLossFocus:false,editFullScreenTemplate:"",catchScroll:true,autoCloseOnHide:true,clearContext:false,indicatorSavingMessage:rk("Подождите, идёт сохранение")},_pending:[],_waiting:[],_record:null,_recordSaved:false,_loadingIndicator:void 0,_saving:false,_displaysConfirmDialog:false,_reportPrinter:null,_printMenu:null,_printMenuIsShow:false,_lastMenuItemList:[],_window:{remove:function(){},hide:function(){},_titleBar:true},_isClosed:true,_standartYOffset:1,_standartWindowOffset:64,_onFocusOutElements:null,_recordIsChanged:false,_inHideInner:false},$constructor:function(){if(this._publish("onBeforeDelete","onRecordDeleted","onBeforeSave","onSave","onSuccess","onFail","onRecordUpdate","onConfirmDialogSelect","onAfterClose","onBeforeClose","onBeforeShowPrintReports","onPrepareReportData","onSelectReportTransform","onChangeRecord","onBeforeShowConfirmDialog","onBeforeChangeRecord"),e.prototype.subscribeOnBeforeUnload.apply(this),0!==this.getReports().length)this._reportPrinter=new l({});this.subscribe("onBeforeClose",function(){this._isClosed=true}),this.subscribe("onReady",this._onReady),this.subscribe("onAfterShow",function(){this._isClosed=false}),this.subscribe("onBeforeShow",function(){if(this._isClosed=false,this._options.readOnly)this._setEnabledForChildControls(false)});var t=r.declareCommand.bind(r,this),o=e.prototype;if(t("ok",o.ok),t("cancel",o.cancel),t("save",function(){if(!this._displaysConfirmDialog)return o.save.apply(this,arguments)}),t("delete",o.delRecord),t("print",function(e){o.print.apply(this,[e])}),t("printReport",function(e){o.printReport.apply(this,[e])}),void 0!==this._options.isNewRecord)h.error("RecordFloatArea",rk("Опция isNewRecord будет удалена в 3.8.0. Вместо нее используйте опцию newRecord")),this._options.newRecord=this._options.isNewRecord},setSaveDiffOnly:function(){e.prototype.setSaveDiffOnly.apply(this,arguments)},_onBeforeNavigate:function(e,t,o){if(!o)if(!(!c.instanceOfModule(this,"Deprecated/Controls/RecordFloatArea/RecordFloatArea")||this.openConfirmDialog()))e.setResult(false)},_createTitle:function(){if(g.superclass._createTitle.apply(this,arguments),this.getContainer().parent().addClass("ws-record-float-area-border"),this._needNewPageLink()){var e=$('<div class="ws-record-float-area-icon icon-16 icon-NewTab icon-disabled action-hover"></div>');this._title.append(e).hover(function(){e.toggleClass("icon-hover")})}},_needNewPageLink:function(){return this._options.editFullScreenTemplate&&c.instanceOfModule(this.getOpener(),"Deprecated/Controls/DataViewAbstract/DataViewAbstract")},_setTitleContainer:function(){if(g.superclass._setTitleContainer.apply(this,arguments),this._needNewPageLink()){var e=this;this._title.addClass("ws-record-float-area-title"),this._title.bind("click",function(t){for(var o=e.getRecord(),n=o.getColumns(),i={},r={id:o.getKey(),parentId:o.getParentKey(),isBranch:o.isBranch()},s=e.getOpener(),a,l=0,c=n.length;l<c;l++)if(o.isChanged(n[l]))i[n[l]]=o.get(n[l]);return a=s.isHierarchyMode()?s.generateEditPageURL(r.id,r.isBranch,null,false,void 0,i,e._options.editFullScreenTemplate):s.generateEditPageURL(r.id,void 0,i,e._options.editFullScreenTemplate),s.openWindowRecord(r,a),e.hide(),t.stopImmediatePropagation(),false})}},setOpener:function(e){if(this.getOpener())this.getOpener().unsubscribe("onFocusOut",this._getOnFocusOutHandler());if(g.superclass.setOpener.call(this,e),this.getOpener())this.getOpener().subscribe("onFocusOut",this._getOnFocusOutHandler())},_getOnFocusOutHandler:function(){if(!this._onFocusOutElements){var e=this;this._onFocusOutElements=function(t,o,n){if(!o&&n&&!c.instanceOfModule(n,"SBIS3.Navigation.Navigation"))if(n===e.getOpener())e.moveToTop();else if(e.isVisible()&&e.isAutoHide()&&e._shouldHideByFocusMoveTo(n)){var i=e.getOpener(),r=i&&i.getContainer(),s=n.getParentWindow(),a=n.getContainer(),l=n.getTopParent(),p=l.isModal&&l.isModal(),d=l.getOpener&&l.getOpener(),u=e.getContainer();if(!e._isClosed&&"hide"!==e._state&&r&&r.find(a).length<1&&u&&u.find(a).length<1&&!p&&i!==n&&l!==this.getTopParent()&&d!==this&&l!==e){var f=s&&s.getOpener(),h=f&&f.getContainer();if(!s||!f||f&&u&&u.find(h)<1)e.hide()}}}}return this._onFocusOutElements},_onReady:function(){if(!this._options.doNotLossFocus)return true;var e=this._getOnFocusOutHandler();f.unsubscribe("onFocusOut",e,this),f.subscribe("onFocusOut",e,this)},destroy:function(){f.unsubscribe("onFocusOut",this._getOnFocusOutHandler(),this),a.channel("navigation").unsubscribe("onBeforeNavigate",this._onBeforeNavigate,this),g.superclass.destroy.apply(this,arguments)},openConfirmDialog:function(e){var t=this,o=new p;if(this._displaysConfirmDialog=true,o.addCallback(function(e){return t._notify("onConfirmDialogSelect",e),t._displaysConfirmDialog=false,e}),t.getRecord().isChanged()&&!t.isSaved()||t._recordIsChanged)this._openConfirmDialog(false,true).addCallback(function(n){switch(n){case"yesButton":if(void 0===t._result)t._result=true;t.updateRecord().addCallback(function(){t._confirmDialogToCloseActions(o,e)}).addErrback(function(){o.callback(false)});break;case"noButton":if(void 0===t._result)t._result=false;t._confirmDialogToCloseActions(o,e);break;default:o.callback(false)}});else t._confirmDialogToCloseActions(o,e);return o},_confirmDialogToCloseActions:function(e,t){if(a.channel("navigation").unsubscribe("onBeforeNavigate",this._onBeforeNavigate,this),e.callback(true),!t)g.superclass.close.apply(this,arguments)},_openConfirmDialog:function(){return e.prototype._openConfirmDialog.apply(this,arguments)},isSaved:function(){return e.prototype.isSaved.apply(this,[])},_unbindBeforeUnload:function(){e.prototype._unbindBeforeUnload.apply(this)},_beforeUnloadHandler:function(){return e.prototype._beforeUnloadHandler.apply(this)},unsubscribeOnBeforeUnload:function(){e.prototype.unsubscribeOnBeforeUnload.apply(this)},updateRecord:function(){return e.prototype.updateRecord.apply(this,arguments)},_checkPendingOperations:function(){return e.prototype._checkPendingOperations.apply(this,arguments)},save:function(){return e.prototype.save.apply(this,arguments)},_processError:function(t){e.prototype._processError.apply(this,[t])},isReadOnly:function(){return this._options.readOnly},ok:function(){e.prototype.ok.apply(this,arguments)},_setEnabledForChildControls:function(){e.prototype._setEnabledForChildControls.apply(this,arguments)},_showLoadingIndicator:function(){e.prototype._showLoadingIndicator.apply(this,arguments)},_hideLoadingIndicator:function(){e.prototype._hideLoadingIndicator.apply(this,arguments)},isAllReady:function(){return e.prototype.isAllReady.apply(this,arguments)},getChildControls:function(){return e.prototype.getChildControls.apply(this,arguments)},getReports:function(){return e.prototype.getReports.apply(this,arguments)},_printMenuItemsIsChanged:function(){return e.prototype._printMenuItemsIsChanged.apply(this,arguments)},_createPrintMenu:function(t){return e.prototype._createPrintMenu.apply(this,arguments)},showReportList:function(t){return e.prototype.showReportList.apply(this,arguments)},printReport:function(t){return e.prototype.printReport.apply(this,arguments)},_showReport:function(t,o,n){return e.prototype._showReport.apply(this,arguments)},print:function(t){return e.prototype.print.apply(this,arguments)},_hideWindow:function(){},getRecord:function(){return e.prototype.getRecord.apply(this,arguments)},_getTitle:function(){return document.title},setReadOnly:function(t){e.prototype.setReadOnly.apply(this,arguments)},setClearContext:function(e){this._options.clearContext=!!e},getClearContext:function(){return this._options.clearContext},isNewRecord:function(){return e.prototype.isNewRecord.apply(this,arguments)},setRecord:function(e,t){var o=this;if(!t)this.openConfirmDialog(true).addCallback(function(t){if(t)o._setRecord(e)});else this._setRecord(e)},_setRecord:function(e){var t=this.getRecord(),o=this.getLinkedContext(),n=this,i=function(){if(n._options.clearContext)o.setContextData(e);else o.replaceRecord(e);if(n.isNewRecord())n._options.newRecord=null===e.getKey();n._notify("onChangeRecord",e,t)},r;r=this._notify("onBeforeChangeRecord",e,t),d.callbackWrapper(r,i.bind(this))},_hide:u(function(){var e=g.superclass._hide,t;if(t=!this._inHideInner,t)t=e.apply(this,arguments);return t}),_hideInner:u(function(){var e=this,t=arguments,o=g.superclass._hideInner,n;if(e.getRecord().isChanged()&&!e.isSaved()||e._recordIsChanged)this._inHideInner=true,n=e.openConfirmDialog(true).addCallback(function(n){if(n)return o.apply(e,t);else{var i=e.getActiveChildControl(true,true);if(i)i.setActive(true);else e.activateFirstControl()}}).addBoth(function(t){return e._inHideInner=false,t});else n=o.apply(e,t);return n}),setChanged:function(e){this._recordIsChanged=!!e}});return g});
//# sourceMappingURL=RecordFloatArea.js.map