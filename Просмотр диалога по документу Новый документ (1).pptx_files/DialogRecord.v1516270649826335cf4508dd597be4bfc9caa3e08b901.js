define("Deprecated/Controls/DialogRecord/DialogRecord",["Lib/Control/Dialog/Dialog","Deprecated/Controls/LoadingIndicator/LoadingIndicator","Core/CommandDispatcher","Transport/ReportPrinter","Deprecated/Record","Core/IoC","Core/Deferred","Deprecated/RecordSet","Core/helpers/fast-control-helpers","Core/helpers/functional-helpers","Core/constants","Core/core-functions","i18n!Deprecated/Controls/DialogRecord/DialogRecord"],function(e,n,t,o,r,i,s,a,d,l,c,f){"use strict";var u=i.resolve("ILogger"),h=e.extend({$protected:{_options:{readOnly:false,newRecord:false,reports:{},diffOnly:false,indicatorSavingMessage:rk("Подождите, идёт сохранение")},_record:null,_recordSaved:false,_loadingIndicator:void 0,_saving:false,_reportPrinter:null,_printMenu:null,_printMenuIsShow:false,_lastMenuItemList:[]},$constructor:function(){var e=t.declareCommand.bind(t,this);if(e("save",this.save),e("delete",this.delRecord),e("print",this.print),e("printReport",this.printReport),this._publish("onBeforeDelete","onRecordDeleted","onBeforeSave","onSave","onSuccess","onFail","onRecordUpdate","onBeforeShowPrintReports","onPrepareReportData","onSelectReportTransform","onBeforeShowConfirmDialog"),!(this._options.record instanceof r))throw new Error("Valid record required to build DialogRecord");else this._options.newRecord=null===this._options.record.getKey()||this._options.newRecord;if(0!==this.getReports().length)this._reportPrinter=new o({});if(this._options.readOnly){var n=this;this._dRender.addCallback(function(){n._setEnabledForChildControls(false)})}if(void 0!==this._options.isNewRecord)u.error("DialogRecord",rk("Опция isNewRecord будет удалена в 3.8.0. Вместо нее используйте опцию newRecord")),this._options.newRecord=this._options.isNewRecord},_setEnabledForChildControls:function(e){for(var n=this.getImmediateChildControls(),t,o=0,r=n.length;o<r;++o)if(t=n[o],"function"==typeof t.setReadOnly)t.setReadOnly(!e);else t.setEnabled(e)},destroy:function(){this.getRecord().rollback(),h.superclass.destroy.apply(this,arguments)},delRecord:function(e){var n=this,t=new s,o=n._notify("onBeforeDelete");if(false!==o)d.question("string"==typeof o?o:rk("Вы действительно хотите удалить эту запись?"),{},n).addCallback(function(o){if(o)t.dependOn(n.getRecord().destroy().addCallbacks(function(t){if(n._recordSaved=true,n._notify("onSuccess",t),n._notify("onRecordDeleted"),true!==e)n.ok();return t},n._processError.bind(n)));else t.callback()});else t.callback();return t},getRecord:function(){return this.getLinkedContext().getRecord()},save:function(e){var n=new s,t,o,r,i;if(n.addErrback(function(e){return e}),e&&1==arguments.length&&!(e instanceof s))t=e.notifyMe,o=e.withoutClose,r=e.checkChanges,i=e.diffOnly;else t=arguments[0],o=arguments[1],r=arguments[2];if(!this._saving){var a=this;if(this._options.readOnly){if(n.errback(rk("Вы пытаетесь сохранить запись, открытую только на просмотр!")),t instanceof s)t.errback(rk("Вы пытаетесь сохранить запись, открытую только на просмотр!"));if(true!==o)this.ok()}else{var d=new s;this.waitAllPendingOperations(d),d.addCallback(function(){a._saving=true,n.dependOn(function(e){if(t instanceof s)return t.dependOn(e);else return e}(a.updateRecord({checkChanges:r,diffOnly:i})).addBoth(function(e){return a._saving=false,e}).addCallback(function(e){if(true!==o)a.ok();return e}))})}}else if(n.errback(rk("Запись уже сохранена!")),t instanceof s)t.errback(rk("Запись уже сохранена!"));return n},_processError:function(e){var n=this._notify("onFail",e),t=e&&e.message;if(n||void 0===n){if("string"==typeof n)t=n;if(t)d.alert(t,{},this)}return e.processed=true,e},_showLoadingIndicator:l.forAliveOnly(function(){if(this._loadingIndicator&&!this._loadingIndicator.isDestroyed())this._loadingIndicator.show(this._options.indicatorSavingMessage);else this._loadingIndicator=new n({parent:this,showInWindow:true,modal:true,message:this._options.indicatorSavingMessage,name:this.getId()+"-LoadingIndicator"})}),_hideLoadingIndicator:l.forAliveOnly(function(){if(this._loadingIndicator)this._loadingIndicator.hide()}),updateRecord:function(e){var n=new s,t=this,o=e instanceof Object?e.checkChanges:arguments[0],r=e instanceof Object?e.diffOnly:arguments[1],i=function(e){if(false===e)t.onBringToFront(),n.addErrback(function(e){return e}),n.errback(rk("Сохранение записи отменено в обработчике на событие")+" onBeforeSave");else if(t.validate()){t._showLoadingIndicator();var i=t._notify("onSave"),a=t.getRecord();if(false===i)n.errback(rk("Сохранение записи отменено в обработчике на событие")+" onSave");else{var d=i instanceof s?i:a.update({consistencyCheck:o||false,diffOnly:"undefined"!==typeof r?r:t._options.diffOnly});n.dependOn(d.addCallbacks(function(e){var n=a.getKey();if("number"===typeof n)t.getLinkedContext().setValue(a.getKeyField(),n);return t._notify("onRecordUpdate",e),t._recordSaved=true,t._options.newRecord=false,t._notify("onSuccess",e),e},function(e){return t._processError(e),e}))}n.addBoth(function(e){return t._hideLoadingIndicator(),e})}else n.errback(rk("Некорректно заполнены обязательные для заполнения поля!"))},a=function(e){t._processError(e),n.errback(e)};if(this._options.readOnly)n.callback();else{n.addErrback(function(e){return e});try{var d=this._notify("onBeforeSave");if(d instanceof s)d.addCallback(function(e){return i(e),e}).addErrback(function(e){return a(e),e});else i(d)}catch(e){a(e)}}return n},_openConfirmDialog:function(e,n){var t=true,o="noButton",r=new s,i=this.getRecord(),a={useCancelButton:true,invertDefaultButton:true,detail:rk('Чтобы продолжить редактирование, нажмите "Отмена".')};if(false===this._notify("onBeforeShowConfirmDialog",i))r.callback("yesButton");else if(!this._options.readOnly&&(i.isChanged()||this.isNewRecord()))t=false,d.question(rk("Сохранить изменения?"),a,this).addCallback(function(e){if(void 0!==e)e=e?"yesButton":"noButton";r.callback(e)});else r.callback(o);return n?r:t},close:function(e){var n=this;this.waitAllPendingOperations((new s).addCallback(function(){function t(e){n._dialogRecordSuperClassClose([e])}if(this.isDestroyed())return;if(!this._options.readOnly&&!e&&this.getRecord().isChanged())n._openConfirmDialog(false,true).addCallback(function(e){switch(e){case"yesButton":n.updateRecord().addCallback(t.bind(this,true));break;case"noButton":n.getRecord().rollback(),t(false)}});else n._dialogRecordSuperClassClose([e])}.bind(this)))},_dialogRecordSuperClassClose:function(){h.superclass.close.apply(this,arguments[0])},isSaved:function(){if(this._recordSaved&&this.getRecord().isChanged())return false;return this._recordSaved},isReadOnly:function(){return this._options.readOnly},setReadOnly:function(e){this._options.readOnly=!!e,this._setEnabledForChildControls(!e)},isNewRecord:function(){return this._options.newRecord},getReports:function(){var e=[];for(var n in this._options.reports)if(this._options.reports.hasOwnProperty(n)&&void 0!==this._options.reports[n])e.push(n);return e},_printMenuItemsIsChanged:function(e){if(this._lastMenuItemList.length!==e.length)return true;for(var n=0,t=e.length;n<t;n++)if(this._lastMenuItemList[n]!==e[n])return true;return false},_createPrintMenu:function(e){var n=this;if(!e||!(e instanceof Array))e=this.getReports();if(e.length>1&&(null===this._printMenu||this._printMenuItemsIsChanged(e))){if(this._lastMenuItemList=e,null!==n._printMenu)n._printMenu.destroy(),n._printMenu=null;return d.newContextMenu(e,function(e,t){n.printReport.apply(n,[t.caption])}).addCallback(function(e){return n._printMenu=e,e})}else return(new s).callback(this._printMenu)},showReportList:function(e){if(Object.isEmpty(this._options.reports))return;var n=this.getRecord(),t=this.getReports(),o=this,r;if(r=this._notify("onBeforeShowPrintReports",t,n,false),false!==r){var i;if(r instanceof Array){if(i=r,1==r.length)r=r[0]}else i="string"===typeof r?[]:"";this._createPrintMenu(i).addCallback(function(n){if(null===o._printMenu){if(void 0===r)r=t[0];if("string"==typeof r)o.printReport(r)}else try{o._printMenu.show(e),o._printMenuIsShow=true}catch(n){o._printMenu.subscribe("onReady",function(){o._printMenu.show(e),o._printMenuIsShow=true})}return n})}},printReport:function(e){if(Object.isEmpty(this._options.reports))return;var n=this.getRecord(),t="",o=this,i;if($("body").toggleClass("ws-progress",true),null!==o._printMenu&&o._printMenuIsShow)o._printMenu.destroy(),o._printMenu=null,o._printMenuIsShow=false;if(void 0!==e)if(t=this._options.reports[e],i=this._notify("onPrepareReportData",e,n),false!==i)if(i instanceof s)i.addCallback(function(n){if(n instanceof r||n instanceof a||n instanceof Array)o._showReport(e,n,t)});else{if(i instanceof r||i instanceof a||i instanceof Array)n=i;this._showReport(e,n,t)}else $("body").toggleClass("ws-progress",false)},_showReport:function(e,n,t){var o="",r=this;if(void 0!==e){if(o=this._notify("onSelectReportTransform",e,n,t),"string"===typeof o)t=o;t=c.resourceRoot+t,r._reportPrinter.prepareReport(n,t).addCallback(function(e){d.showHTMLForPrint(e).addCallback(function(e){e.subscribe("onReady",function(){this.getChildControlByName("ws-dataview-print-report").subscribe("onContentSet",function(){$("body").toggleClass("ws-progress",false)})})})}).addErrback(function(e){$("body").toggleClass("ws-progress",false),f.alert(e.message)})}},print:function(e){if(Object.isEmpty(this._options.reports))return;this.showReportList(e)},_unbindBeforeUnload:function(){c.$win.unbind("beforeunload",this._beforeUnload)},_beforeUnloadHandler:function(){if(!this.isDestroyed()&&(this.getRecord().isChanged()&&!this.isRecordSaved()||this._recordIsChanged))return rk("Вы покидаете редактируемый документ, все несохраненные данные будут потеряны")},subscribeOnBeforeUnload:function(){this._beforeUnload=this._beforeUnloadHandler.bind(this),c.$win.bind("beforeunload",this._beforeUnload),this.subscribe("onAfterClose",this._unbindBeforeUnload)},unsubscribeOnBeforeUnload:function(){this.unsubscribe("onAfterClose",this._unbindBeforeUnload),this._unbindBeforeUnload()},setSaveDiffOnly:function(e){this._options.diffOnly=!!e}});return h});
//# sourceMappingURL=DialogRecord.js.map