define("Lib/Control/FileStorageLoader/FileStorageLoader",["Core/helpers/random-helpers","Core/EventBus","Lib/Control/FileLoader/FileLoader","WS.Data/Di","Core/Deferred","i18n!Lib/Control/FileStorageLoader/FileStorageLoader"],function(e,i,o,t,r){"use strict";var a,n={};function l(e,i){var o=i.UploadName,t=i.Message;if(n[o])this._logError(t,"FileStorageLoader"),n[o].callback({code:500}),delete n[o]}function s(e,i){var o=i.UploadName,t=i.Message,r=i.UploadGuid;if(n[o])this._getFileLoaderPlugin().addCallback(function(e){e.call("сancelUploadToBigFileStorage",{Guid:r})}),this._logError(t,"FileStorageLoader"),n[o].callback({code:500}),delete n[o]}function d(e,i){var o=i.UploadName,t=i.UploadId;if(n[o])n[o].callback({code:201,url:t}),delete n[o]}var c=o.extend({_loadDeferred:void 0,$constructor:function(){var e=i.channel("SbisPluginEvent");e.subscribe("uploadToBigFileError",l,this),e.subscribe("uploadToBigFileStorageError",s,this),e.subscribe("uploadToBigFileStorageEvent",d,this)},_postFileStorageFinished:function(e,i){var o="";if(201!==e)switch(e){case 413:o=rk("Размер выбранного изображения превышает максимально допустимый.");break;default:o=rk("Не удалось загрузить изображение. Повторите попытку.")}else o=rk("Изображение успешно загружено на сервер");this._postFinished(JSON.stringify({jsonprc:"2.0",result:{code:e,message:o,filePath:i},id:1,protocol:3}))},_postInput:function(i){var o=this,t,r=new XMLHttpRequest,a="/cstorage/img?id="+e.createGUID();for(var n in i)if(i.hasOwnProperty(n)&&"function"!==typeof n){t=i[n];break}this._upload(function(){o._loading=true,r.open("PUT",a,true),r.setRequestHeader("Content-Disposition","inline; filename*=utf-8''"+encodeURI(t.name)),r.setRequestHeader("Content-Type",t.type),r.onreadystatechange=function(){if(4==r.readyState)o._postFileStorageFinished(r.status,a)},r.send(t)})},destroy:function(){var e=i.channel("SbisPluginEvent");e.unsubscribe("uploadToBigFileError",l,this),e.unsubscribe("uploadToBigFileStorageError",s,this),e.unsubscribe("uploadToBigFileStorageEvent",d,this),c.superclass.destroy.apply(this,arguments)},_postPlugin:function(e){if(!e||"undefined"==e)return;e=e[0],this._notify("onChange",this._curval=decodeURIComponent(e));var i=this;this._upload(function(){if(!i._isDestroyed){if(i._loading=true,i._options.showIndicator)i._showIndicator();var o=i._getRequestParameters();o.fileName=e;var t=i._uploadFile(o);if(t instanceof r)t.addErrback(function(e){if(i._options.showIndicator)i._hideIndicator();i._loading=false,i._logError(e)})}})},_uploadFile:function(i){var o=this;return this._getFileLoaderPlugin().addCallback(function(t){var a=[window.location.protocol,window.location.hostname].join("//");if(window.location.port&&"http:"==window.location.protocol)a+=":"+window.location.port;i.targetURL=a+"/cstorage/img?id="+e.createGUID();var l=new r;return l.addErrback(function(e){return e}),n[i.fileName]=l,l.addCallback(function(e){o._postFileStorageFinished(e.code,e.url?e.url.replace(a,""):"")}),t.call("uploadToBigFileStorage",{Params:JSON.stringify(i)}).addErrback(function(e){l.errback(e)}),l})},startFileLoad:function(e){var i=new r,o={},t=function(e,r){if(!i.isReady())if(r.result&&201===r.result.code)o=r.result,i.callback();else i.errback();this.unsubscribe("onLoaded",t)}.bind(this);if(this.subscribe("onLoaded",t),this.selectFile(),this._loadDeferred&&!this._loadDeferred.isReady())this._loadDeferred.errback();return this._loadDeferred=i,i.addCallback(function(){return o}),i}});if(!t.isRegistered("ImageUploader"))t.register("ImageUploader",{getFileLoader:function(){return a=a?a:new c({fileStorage:true,extensions:["image"],element:$("<div></div>")}),a},canMultiSelect:false},{instantiate:false});return c});
//# sourceMappingURL=FileStorageLoader.js.map