define("js!SBIS3.Activity.ActivityMonitor",["Core/EventBus","WS.Data/Source/SbisService","Lib/Storage/LocalStorage","Core/UserInfo","Core/helpers/Function/throttle"],function(e,n,t,i,o){var c="activity",r=0,s=1,a=" ; ",u="s3ai",f=60*1e3,y=2*f,d=1e3,l=15*f,v=3,g=1,p=2,S=p,I=true,C=-1,E=l,m,b;function h(){return e.channel(c)}return e.globalChannel().once("bootupReady",function(){(m=new t(c)).subscribe("onChange",function(e,n,t){if("lastActivity"===n)D(t)});function l(){if(C!=r)C=r,h().notify("onIdle")}function D(e){if(b=e||+new Date,C!=s)C=s,h().notify("onActive")}function w(){$(document).bind("mousemove keyup",function(){var e;return o.call(function(n){if("mousemove"===n.type)try{if(!e||e.pageX==n.pageX&&e.pageY==n.pageY)return}finally{e={pageX:n.pageX,pageY:n.pageY}}_()},d)}())}function R(){setInterval(X,1.2*y)}function N(){setInterval(A,f/30)}function A(){if(E&&S==p&&+new Date-b>E)l()}function P(){return[i.get("ИдентификаторПользователя"),i.get("ИдентификаторКлиента")].join("-")}function q(){Y(),new n({endpoint:{address:"/activity/service/?srv=1",contract:"Местоположение"}}).call("АктивностьНаСайте",{"ЧасовойПояс":-(new Date).getTimezoneOffset()}).addCallback(M)}function M(){var e=O();e.lastSync=+new Date,e.syncRequired=false,e.countCapturedEvents=0,e.syncInProgress=0,L(e),I=false}function Y(){var e=O();e.syncInProgress=+new Date,L(e)}function _(){m.setItem("lastActivity",+new Date),D(),k(),X()}function k(){var e=O();e.countCapturedEvents+=1,e.syncRequired=e.countCapturedEvents>=v,L(e)}function L(e){if($.cookie(u,[e.lastSync,e.syncRequired,e.uid,e.countCapturedEvents,e.syncInProgress].join(a)),sessionStorage)try{sessionStorage.setItem(u,e.countCapturedEvents)}catch(e){}}function O(){var e=($.cookie(u)||"").split(a),n=+e[0],t=+new Date,i=NaN,o=+e[4]||0,c;if(sessionStorage)try{i=+sessionStorage.getItem(u)}catch(e){}if(isNaN(i))i=+e[3]||0;if(c={uid:e[2],countCapturedEvents:i,syncRequired:i>=v,canSync:(I||t-n>y)&&t-o>.5*y,lastSync:n,syncInProgress:o},!T(c))c.uid=P(),c.syncRequired=false,c.canSync=true,c.lastSync=0,c.countCapturedEvents=0,c.syncInProgress=0;return c}function T(e){return e.uid===P()}function X(){var e=O();if(S==g||e.syncRequired&&e.canSync)q()}if(e.channel("errors").subscribe("onRPCError",function(e,n){n.processed="Местоположение.АктивностьНаСайте"===n.methodName}),i.get("real_enter")&&!i.get("guest"))w(),R(),N()}),{setMonitoringMode:function(e){if(e==p||e==g)S=e},setIdleTimeout:function(e){if(void 0===e)e=l;E=e},channel:h,MODE_PERMANENTLY:g,MODE_ONLY_IF_ACTIVE:p}});
//# sourceMappingURL=ActivityMonitor.module.js.map