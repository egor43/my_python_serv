define("Transport/RecordSetToXMLSerializer",["Deprecated/helpers/additional-helpers","Core/core-instance","Core/IoC"],function(e,t,i){var r;function a(e){if("string"==typeof e)e=e.replace(/[^\x09\x0A\x0D\x20-\uD7FF\uE000-\uFFFD\u10000-\u10FFFF]*/g,"");return e}return r={_complexFields:{"Связь":true,"Иерархия":true,"Перечисляемое":true,"Флаги":true,"Массив":true,"Запись":true,"Выборка":true},_wordsToTranslate:{"Дата":"Date","Время":"Time","Строка":"String","Текст":"Text","Логическое":"Boolean","Деньги":"Money","Двоичное":"Binary","Файл-rpc":"RPCFile","Временной интервал":"TimeInterval","Идентификатор":"ID","JSON-объект":"JSON-object"},_colNameToTag:{"Число целое":"Integer","Число вещественное":"Double","Дата и время":"DateTime"},_branchTypes:{true:"Node",false:"Leaf",null:"HiddenNode"},serialize:function(e,i,r,a){var l=this._createXMLDocument(),n=t.instanceOfModule(e,"Deprecated/Record")?[e]:e;return this._serializeObject(n,l,l),this._serializeColumns(i,n,l,r,a),l},_serializeColumns:function(e,i,r,a,l){var n="",o,d;if(e&&e instanceof Array&&e.length>0){r.documentElement.appendChild(o=r.createElement("Columns"));for(var c=0,s=e.length;c<s;c++)o.appendChild(d=r.createElement("Column")),d.setAttribute("Name",e[c].title),d.setAttribute("Field",e[c].field)}if(t.instanceOfModule(i,"Deprecated/RecordSet"))n=i.getHierarchyField();if(i instanceof Array&&t.instanceOfModule(i[0],"Deprecated/Record")&&null!==i[0].getRecordSet()){var p=i[0].getRecordSet();if(p)n=p.getHierarchyField()}if(""!==n)r.documentElement.setAttribute("HierarchyField",n),r.documentElement.setAttribute("HierarchyName",void 0===a?"":a),r.documentElement.setAttribute("Root",l?l+"":"")},_serializeObject:function(e,i,r){var l,n,o=[],d,c;if(t.instanceOfModule(e,"Deprecated/RecordSet")){i.appendChild(n=r.createElement("RecordSet")),e.rewind();while(false!==(l=e.next()))this._serializeObject(l,n,r)}else if(e instanceof Array){i.appendChild(n=r.createElement("RecordSet"));for(var s=e.length,p=0;p<s;p++)this._serializeObject(e[p],n,r)}else if(t.instanceOfModule(e,"Deprecated/Record")){i.appendChild(d=r.createElement("Record"));var u=e.getKey();if(null===u)u="null";d.setAttribute("RecordKey",a(u+"")),o=e.getColumns(),c=null===e.getRecordSet()?o[0]:o[e.getRecordSet().getPkColumnIndex()],d.setAttribute("KeyField",c);for(var f=0,m=o.length;f<m;f++)this._serializeField(o[f],e,d,r)}},_serializeField:function(e,r,l,n){var o,d,c,s,p=/[а-я]+/gi;o=r.getColumnDefinition(e),l.appendChild(d=n.createElement("Field")),d.setAttribute("Name",o.title);var u=null===r.get(o.title)?"":r.get(o.title),f="object"==typeof o.type?o.type.n:o.type;if(!this._complexFields[f]&&!o.s&&!this._complexFields[o.s]){if(c=this._colNameToTag[o.type]?this._colNameToTag[o.type]:o.type,c=this._wordsToTranslate[c]?this._wordsToTranslate[c]:c,p.test(c))i.resolve("ILogger").error("XSLT",rk("Внимание! Кирилический тэг без замены:")+" "+c);if(s=n.createElement(c),u instanceof Date){if("Дата и время"==o.type)u=u.toSQL()+"T"+u.toTimeString().replace(" GMT","").replace(/\s[\w\W]*/,"");if("Дата"==o.type)u=u.toSQL();if("Время"==o.type)u=u.toTimeString().replace(" GMT","").replace(/\s[\w\W]*/,"")}u=a(u+""),s.appendChild(n.createTextNode(u)),d.appendChild(s)}else if("Связь"==f)(s=n.createElement("Link")).setAttribute("Table","object"==typeof o.type?o.type.t:o.table),s.appendChild(n.createTextNode(u)),d.appendChild(s);else if("Иерархия"==f||o.s&&"Иерархия"==o.s){d.appendChild(s=n.createElement("Hierarchy"));var m,h;if(s.appendChild(m=n.createElement("Parent")),s.appendChild(h=n.createElement("NodeType")),"object"==typeof o.type)s.setAttribute("HierarchyName",o.type.f+""),m.appendChild(n.createTextNode(u[1]+"")),h.appendChild(n.createTextNode(this._branchTypes[u[0]+""]));else if("Идентификатор"==f){if(s.setAttribute("HierarchyName",o.titleColumn+""),m.appendChild(n.createTextNode(u+"")),r.hasColumn(o.title+"@"))u=this._branchTypes[r.get(o.title+"@")+""],h.appendChild(n.createTextNode(u))}else l.removeChild(d)}else if("Перечисляемое"==f){d.appendChild(s=n.createElement("Enumerable"));var y;u=u.toObject();for(var C in u.availableValues)if(u.availableValues.hasOwnProperty(C)){s.appendChild(y=n.createElement("Variant")),y.setAttribute("Value",C);var T=u.availableValues[C];if(null===T)T="";if(y.setAttribute("Title",T),C==u.currentValue)y.setAttribute("Checked","true")}}else if("Флаги"==f){d.appendChild(s=n.createElement("Flags"));var b;if(u){u=u.toObject();for(var g in u)if(u.hasOwnProperty(g))s.appendChild(b=n.createElement("Flag")),b.setAttribute("Title",g),b.setAttribute("Condition",u[g]+"")}}else if("Массив"==f){d.appendChild(s=n.createElement("Array")),s.setAttribute("DataType","object"==typeof o.type?o.type.t:o.arrayType);for(var v,D=0,E=u.length;D<E;D++)s.appendChild(v=n.createElement("Value")),v.appendChild(n.createTextNode(a(u[D]+"")))}else if(t.instanceOfModule(u,"Deprecated/RecordSet")||t.instanceOfModule(u,"Deprecated/Record"))this._serializeObject(u,d,n)},_createXMLDocument:function(){var t;if(document.implementation&&document.implementation.createDocument)t=document.implementation.createDocument("","",null);if(e.axo)t=e.axo("Microsoft.XmlDom");return t}},r});
//# sourceMappingURL=RecordSetToXMLSerializer.js.map