define("Lib/Control/FileLoader/FileLoader",["Core/EventBus","Core/CommandDispatcher","Core/constants","Core/Deferred","Lib/Control/FileLoaderAbstract/FileLoaderAbstract","tmpl!Lib/Control/FileLoader/FileLoader","json!Lib/Control/FileLoader/resources/MimeTypes","Core/IoC","Deprecated/helpers/collection-helpers","Core/detection","css!Lib/Control/FileLoader/FileLoader","i18n!Lib/Control/FileLoader/FileLoader"],function(e,n,t,o,i,s,r,l){"use strict";l.resolve("ILogger").log("Lib/Control/FileLoader/FileLoader",'Module is deprecated and will be removed, use "Lib/File/Attach/SbisAttach"');var a={};function u(e,n){var t=n.DialogGuid,o=n.Result;if(a[t])a[t]._postPlugin(o),delete a[t]}var p=i.extend({_dotTplFn:s,$protected:{_fakeButton:void 0,_inputControl:null,_options:{extensions:[],multiple:false,dropElement:null},_pluginOpen:false},$constructor:function(){n.declareCommand(this,"load",this.selectFile);var t=this;if(this._fakeButton=$(this._container).find(".FileLoader-input_file").change(function(){t._changeInput($(this)[0].files)}).bind("click",function(e){e.stopPropagation()}),this._options.extensions.length){if("string"==typeof this._options.extensions)this._options.extensions=this._options.extensions.split(",");this._fakeButton.attr("accept",this._createExtensionMimeTypes())}this._preparedDropElement(),e.channel("SbisPluginEvent").subscribe("openFileDialogResult",u,this),this._publish("onChangeError")},_preparedDropElement:function(){var e=this._options.dropElement,n=this,t;if(!e)return;if(e instanceof jQuery)t=e;else if("string"===typeof e||e instanceof HTMLElement)t=$(e);else return;if(t&&t.length>0)t=t[0],this._options.dropElement=t,t.ondragenter=function(e){return e.preventDefault(),true},t.ondragover=function(e){return false},t.ondrop=function(e){var t,i;if(t=e&&e.dataTransfer,!t)return;return e.stopPropagation(),e.preventDefault(),i=t.files,o.callbackWrapper(n._notify("onDrop",t,i),function(e){if(false!==e&&i&&i.length)n._changeInput(i)})}},_changeInput:function(e){var n=this,t,o,i={};for(o=0;o<e.length;o++)if(t=e.item&&e.item(o)||e[o],n._options.extensions.length&&!n._verifyFileExtension(t))n._notify("onChange",new Error(rk("Выбранный файл неверного типа")),t);else if(false!==n._notify("onChange",t.name,t))i[t.name]=t;if(n._curval=Object.keys(i).join(","),!Object.isEmpty(i))n._postInput(i);else{var s=e.length?rk("Выбранные файлы неверного типа"):rk("Не выбраны файлы для загрузки.");n._notify("onChangeError",new Error(s)),n._log(s,"FileLoader")}},_createExtensionMimeTypes:function(){var e=[];return this._options.extensions.forEach(function(n){if("audio"==n||"video"==n||"image"==n)e.push(n+"/*");else if(n in r)e.push(r[n])}),e.join(",")},_verifyFileExtension:function(e){var n=e.name.match(/^\S[\S\s]*\.([\S]+)$/),t=e.type||"",o,i,s;if(n=n?n[1].toLowerCase():"",-1!=this._options.extensions.indexOf(n))return true;else if(t)for(i in r)if(r.hasOwnProperty(i)&&r[i]===t&&-1!=this._options.extensions.indexOf(i))return true;for(i=0,s=this._options.extensions.length;i<s;i++)if(o=this._options.extensions[i],("audio"==o||"video"==o||"image"==o)&&-1!=r[o].indexOf(n))return true;return false},_postInput:function(e){this._xhrPost(e)},_runFileChooserPlugin:function(){var e=this;this._getPlugins("Dialogs","1.0.0.0").addCallbacks(function(n){if(!e._isDestroyed)e._notify("onAppletReady",e._randomId,n),n.call("openFileDialog",{extensions:e._options.extensions,multiple:e._options.multiple}).addCallbacks(function(n){a[n]=e},function(n){e._logError(n,"FileLoader")})},function(n){e._notify("onAppletReady",e._randomId,null,n)})},_postPlugin:function(e){this._post(e)},selectFile:function(e,n){var o;if(o=e||window.event||this.getLinkedContext().getValueSelf("Event"),!o&&t.browser.firefox)o=new MouseEvent("click",{bubbles:true,cancelable:true,view:window});if(-1!=navigator.appVersion.indexOf("Win")&&(!(o&&o.which)&&(t.browser.chrome||t.browser.firefox)||n))this._runFileChooserPlugin();else this._fakeButton.parent()[0].reset(),this._fakeButton.click()},destroy:function(){if(this._options.dropElement=$(),this._fakeButton)this._fakeButton.empty().remove(),this._fakeButton=null;e.channel("SbisPluginEvent").unsubscribe("openFileDialogResult",u,this),p.superclass.destroy.apply(this,arguments)},setExtensions:function(e){if(e instanceof Array)this._options.extensions=e},setDropElement:function(e){if(!e)return;this._options.dropElement.ondragenter=null,this._options.dropElement.ondragover=null,this._options.dropElement.ondrop=null,this._options.dropElement=e,this._preparedDropElement()},getExtensions:function(){return this._options.extensions},getDropElement:function(){return this._options.dropElement}});return p});
//# sourceMappingURL=FileLoader.js.map