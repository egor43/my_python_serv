define("Lib/Control/FileLoaderAbstract/FileLoaderAbstract",["Core/core-merge","Deprecated/ReaderSBIS","Deprecated/Record","Core/helpers/random-helpers","Core/Indicator","Core/IoC","Core/ParallelDeferred","Core/Deferred","Core/UserInfo","Core/constants","Lib/Control/Control","Transport/RPCJSON","Core/moduleStubs","Deprecated/helpers/collection-helpers","Deprecated/Controls/LoadingIndicator/LoadingIndicator","i18n!Lib/Control/FileLoaderAbstract/FileLoaderAbstract"],function(e,t,r,o,n,i,a,s,l,c,d,u,p){"use strict";var f={filesIsNotSelected:rk("Не выбраны файлы для загрузки."),loading:rk("Загрузка..."),getFileNameDeprecated:rk("Функция getFileName помечена как deprecated и будет удалена с 3.8. Используйте событие onChange")},h=function(e){return new a({steps:e,stopOnFirstError:false}).done().getResult()};return d.Control.extend({$protected:{_options:{filterParams:[],paramsMapping:{},queryFilter:{},method:"",otherUrl:"",showIndicator:true,loadTimeout:60},_eventBusChannelPlugins:null,_plugin:{},_randomId:"",_targetUrl:"",_loading:false},$constructor:function(){this._publish("onLoadStarted","onLoaded","onAppletReady"),this._targetUrl=this._getTargetUrl(),this._randomId=o.randomId()},_getTargetUrl:function(){var e=this._options.otherUrl?this._options.otherUrl:c.defaultServiceUrl,t=[window.location.protocol,window.location.hostname].join("//");if(window.location.port&&"http:"==window.location.protocol)t+=":"+window.location.port;return e=/^https?:/.test(e)?e:t+e,e},_log:function(e,t){i.resolve("ILogger").log(t||"FileLoaderAbstract",e)},_logError:function(e,t){i.resolve("ILogger").error(t||"FileLoaderAbstract",e.message||e)},_notFormatedVal:function(){return this._curval},_showIndicator:function(){n.setMessage(f.loading)},_hideIndicator:function(){n.hide()},_getRequestParameters:function(){var e={fileName:"",targetURL:this._targetUrl,method:this._options.method,XSBISSessionID:l.getCurrent(),requestParams:{},fileParams:{}},o=this._prepareParams();for(var n in o)if(o.hasOwnProperty(n)){var i=o[n];if(i instanceof r)i=i.toObject(true);var a=t.serializeParameter(n,i).d;if("Ид"==n||"ИмяФайла"==n||"Размер"==n)e.fileParams[n]=a;else e.requestParams[n]=a}return e},_prepareParams:function(){for(var t=e({},this._options.queryFilter),r=this._options.filterParams,o=0,n=r.length;o<n;o++)if(!(r[o]in t))t[r[o]]=this.getLinkedContext().getValue(r[o]in this._options.paramsMapping?this._options.paramsMapping[r[o]]:r[o]);return t},_parseResponse:function(e){var t;if(e instanceof Error){if(e.message.indexOf("System.Net.WebException")>-1){e.message=e.message.replace("System.Net.WebException: ","").replace(/\n[\s\S]*/g,"").replace(/\n/g,"").replace(/\r/g,"");try{e.code=e.message.match(/\(?(\d+)\)?/)[1]}catch(t){e.code=""}}t={error:{code:e.code,message:e.message}}}else if("[object Object]"==Object.prototype.toString.call(e)&&(e.result||e.error)){if(e.error&&e.error.message){var r;try{if(r=JSON.parse(e.error.message),r&&r.error)r.error.code=e.error.code,e.error=r.error}catch(e){}}t=e}else try{t=JSON.parse(e)}catch(e){}if(!t)t={error:{}};return t},_postFinished:function(e){var t=this;if(this._loading){if("[object Object]"==Object.prototype.toString.call(e)){for(var r in e)if(e.hasOwnProperty(r))e[r]=t._parseResponse(e[r]);if(1==Object.keys(e).length)e=e[Object.keys(e)[0]]}else e=t._parseResponse(e);if(this._notify("onLoaded",e,true),this._options.showIndicator)this._hideIndicator();this._loading=false}},_processingError:function(e){var t=this;return p.require(["Transport/XHRTransport","Transport/HTTPError"]).addCallback(function(r){var o,n,i,a,s;if(n=r[0],i=r[1],s=e.data&&e.data.error_code||e.code||500,a=e.message||n.ERRORS_TEXT[s]||"",o=new i(a,s,t._targetUrl,void 0,e.details),o.type=e.type||"error",!n.isOfflineError(o))return o;var l=i.offlineModeError(a,t._targetUrl);return l.type=e.type||"error",l.processed=!!n.notifyOfflineError(t._options.method.split(".")),l})},_addCallbacksAfterUpload:function(e){var t=this;e.addBoth(function(e){return t._parseResponse(e)}),e.addBoth(function(e){var r=e instanceof Error?e:e.error;if(!r)return e;return t._processingError(r).addBoth(function(t){if(e instanceof Error)return t;return e.error=t,e})})},xhrSend:function(e){return this._xhrPost(e)},_xhrPost:function(e){var t=this;this._upload(function(){var r={};for(var o in e)if(e.hasOwnProperty(o)){var n=e[o],i;i=t._xhrSendOneFile(n,n.name),t._addCallbacksAfterUpload(i),r[n.name]=i}return t._parallelLoad(r)})},_xhrSendOneFile:function(t,r){var o,n=this,i=n._getRequestParameters(),a=new FormData,s={"Файл":{"Данные":{href:"file1"}}};if(e(s["Файл"],i["fileParams"]),e(s,i["requestParams"]),r)a.append("file1",t,r);else a.append("file1",t);return a.append("Запрос",u.jsonRpcPreparePacket(this._options.method,s).reqBody),o=p.require("Transport/XHRTransport"),o.addCallback(function(e){return new e[0]({method:"POST",url:n._targetUrl,processData:false,contentType:false,dataType:false}).execute(a)}),o},_upload:function(e){s.callbackWrapper(this._notify("onLoadStarted"),function(t){if(false!==t)e(t);return t})},_getFileLoaderPlugin:function(){return this._getPlugins("FileLoader","0.0.0.5")},_getFileSystemPlugin:function(){return this._getPlugins("FileSystem","0.0.0.5")},_getPlugins:function(e,t,r){var o=this;if(o._plugin[e]&&o._plugin[e].getState()===o._plugin[e].readyState.OPEN)return(new s).callback(o._plugin[e]);var n=new s;return require(["js!SBIS3.Plugin.Source.LocalService"],function(i){var a=new i({endpoint:{address:e+"-"+t,contract:e},options:r||{mode:"silent"}});a.isReady().addCallbacks(function(){if(o._plugin[e]=a,o._options.loadTimeout>60)o._plugin[e].setQueryTimeout(1e3*o._options.loadTimeout);n.callback(a)},function(t){o._logError(t,e),o._plugin[e]=null,n.errback(t)})}),n},_pluginSend:function(e){return this._getFileLoaderPlugin().addCallback(function(t){return t.call("uploadFile",{requestParams:e})})},_pluginSendOneFile:function(e,t){var r=this,o=this._getRequestParameters();return p.require(["browser!js!SBIS3.Plugin/Source/Helper/UserDataManager"]).addCallback(function(n){var i=n[0];if(o.fileName=e.path,o.newFileName=e.name,o.AccountID=i.getAccountId(),t)o.removeAfterUpload=true;return r._pluginSend(o)})},pluginSend:function(e){return this._post(e)},_post:function(e,t){if(!e||"undefined"==e)return;var r=this;this._getFileSystemPlugin().addCallback(function(o){var n,i,a;return a={},n=e instanceof Array?e:e.split("|"),i=[],n.forEach(function(e){i.push(r._getFileInfoDeferred(e,o,a))}),h(i).addBoth(function(){if(r._curval=Object.keys(a).join(","),Object.isEmpty(a))return r._log(f.filesIsNotSelected,"FileLoaderAbstract"),false;r._upload(function(){if(r._isDestroyed)return;var e={};for(var o in a)if(a.hasOwnProperty(o)){var n=a[o],i;i=r._pluginSendOneFile(n,t),r._addCallbacksAfterUpload(i),e[n.name]=i}r._parallelLoad(e)})})})},_getFileInfoDeferred:function(e,t,r){var o=this;return t.call("getFileInfo",{path:e}).addCallback(function(e){if(e=JSON.parse(e),e.lastModifiedDate=Date.fromSQL(e.lastModifiedDate),false!==o._notify("onChange",e.name,e))r[e.name]=e})},_parallelLoad:function(e){var t=this;if(t._options.showIndicator)t._showIndicator();return t._loading=true,h(e).addBoth(function(e){if(t._options.showIndicator)t._hideIndicator();if(t._loading=false,1==Object.keys(e).length)e=e[Object.keys(e)[0]];return t._notify("onLoaded",e,true),e})},setUploadParams:function(e){this._options.queryFilter={},this._options.paramsMapping={},this._options.filterParams=[];for(var t in e)if(e.hasOwnProperty(t)){var r=e[t];if(this._options.filterParams.push(t),r&&"object"==typeof r&&"fieldName"in r)this._options.paramsMapping[t]=r.fieldName;else this._options.queryFilter[t]=r}},setTargetMethod:function(e){this._options.method=e},getFileName:function(){return i.resolve("ILogger").log("FileLoaderAbstract",f.getFileNameDeprecated),this._notFormatedVal()},isLoading:function(){return this._loading},setShowIndicator:function(e){this._options.showIndicator=!!e},setFilterParams:function(e){if(e instanceof Array)this._options.filterParams=e},setParamsMapping:function(e){if("object"===typeof e)this._options.paramsMapping=e},setQueryFilter:function(e){if("object"===typeof e)this._options.queryFilter=e},setMethod:function(e){if("string"===typeof e)this._options.method=e},setOtherUrl:function(e){if("string"===typeof e)this._options.otherUrl=e,this._targetUrl=this._getTargetUrl()},setLoadTimeout:function(e){if(e>60)this._options.loadTimeout=e},getShowIndicator:function(){return this._options.showIndicator},getFilterParams:function(){return this._options.filterParams},getParamsMapping:function(){return this._options.paramsMapping},getQueryFilter:function(){return this._options.queryFilter},getMethod:function(){return this._options.method},getOtherUrl:function(){return this._options.otherUrl},getLoadTimeout:function(){return this._options.loadTimeout}})});
//# sourceMappingURL=FileLoaderAbstract.js.map