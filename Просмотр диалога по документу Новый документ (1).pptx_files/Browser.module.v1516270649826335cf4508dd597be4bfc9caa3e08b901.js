(function() {
   var availableDict = {"en-US":true},
      langMatch = String(typeof document === 'undefined' ? '' : document.cookie).match(/lang=([A-z-]+)/),
      langName = langMatch ? langMatch[1] : 'ru-RU',
      langModule = 'text!Zametki/lang/' + langName + '/' + langName + '.json';
   if (langName in availableDict) {
      define('Zametki_localization', ['Core/i18n', langModule], function(i18n, data) {
         if (data){
            i18n.setDict(JSON.parse(data), langModule, langName);
         }
      });
   } else {
      define('Zametki_localization', function() {});
   }
})();

define("html!SBIS3.Notes.PanelNotesHider",function(){var e=function(e){var r=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(r){for(;e.test(r);)r=r.replace(e,"&#123;&#123;$1&#125;&#125;");return r}}(),n=function(e){return e.join?e.join(""):e.toString()},t=function(e){return void 0===e?"":e&&"object"==typeof e?n(e):""+e},o="undefined"!=typeof process,i=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,'<div class="ws-panelNotes-hider" title="');return e.showNotes?i+=r(t(rk("Скрыть заметки"))):i+=r(t(rk("Показать заметки"))),i+='"> <span class="ws-panelNotes-hider__count"></span> </div>',(i=r(i))+(o&&-1!==i.indexOf("{{")?String.fromCharCode(8203,8203):"")};return e.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.PanelNotesHider"}},e});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.PanelNotesHider", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-panelNotes-hider{display:none;height:40px;width:20px;line-height:46px;margin:0;padding:0;text-align:center;cursor:pointer;box-sizing:border-box;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAoCAYAAAD+MdrbAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAANtJREFUeNpifP/+wn8GKgIWEMH7o5sqhn3mKGVgYqAyGDVw1MBRA0cNHDVw1MBRA0cNHDVw6Bv4k9WJ4R8jP9mG/GdkZ/jJYg1mMwKbxAkMDP9agGZLs/69wsD25xgD0/+PRBv0i9mE4TeLMcN/BuZfjP+/T2f8/x/SxP7w4SLRBiMbBFT/h/H/57n/GIUqBAT0P8ANhAFCBv9m1gEHEcggpn/vlv5lEi8AGQSTxzAQl8HM/x4z/AKG0z9GPqAFb9f+YxROQTaIoIHYDAa6dCcw8jKABj3ApR4gwAAyxmqst/SWkwAAAABJRU5ErkJggg==) bottom right no-repeat;z-index:1000}.ws-panelNotes-hider__count{width:20px;color:#000;font-family:TensorFont,sans-serif;margin:0;padding:0;font-size:14px;text-align:center;line-height:26px;background:0 0;display:inline-block}.ws-panelNotes-hider.ws-panelNotes-hider_big .ws-note-hider__count{width:28px}.ws-panelNotes-hider.ws-hider_fletching{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAoCAYAAAD+MdrbAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAARVJREFUeNpifP/+wn8GKgIWEMH7o5sqhn3mKGVgYqAyGDVw1MBRA0cNHDVw1MBRA0cNHDVwUBr4j5Gf+AYnPvCHWZXhF7Mxw18mWQbmf48Z2P8cBdMku/A3sw7DV/Z0hu+sAQz/Gfl2AoUS/zJJP/3GFsHwnS0Qp4tRXPifkZ3hDxPQRSzWQDbnH8b/3/YChTP4BO0eQJUs+PDhYsIfJqWWP+wq0qx/rzCw/TnGwPT/I9wMRlCjnefnJKC3TBh+sxiDHP2H6d+7pX+ZxAsEBPQ/4PIByGBgyLYA1cMN/sqeBjGQkeEnw38G5l+M/79P/8/I24DPIHwGgwWABn748O7wBCAt8P//fwZyMVB/wvv3554ABBgACWKX/MCWsg0AAAAASUVORK5CYII=) bottom right no-repeat}.ws-panelNotes-hider.ws-panelNotes-hider_big{width:28px!important;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAoCAYAAADt5povAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAUVJREFUeNrs171KxEAQB/CZ3SQnHGqwEEQEi7vuQEEfwNpKObX2HdRHsLrOWi2tLHwDH8E7tREtrCwETfw4lGx2x0lO4QyiB2KwmCmyG1jmx/y3WoyiNkGJ5WWf4ddWKdjT0BYoKLkEFFBAAQUUUEABBRRQQAEF/L/gS9A0Rjf+DEl1nY3lfI/85F4HsKsAehHBGM9e+J67As9e/gpxahwSPZdjBBVQFJ0QBLtI1Hvix3En5GWJj27w4A2ExPr2TPv2HJS7HQzBUQZqYPQ870cAqXvDQ+w5DPfDcOY6n/AD7C/Gp9/xTcYnkZ5T3556OU4Pn84SViBVdciuxKqpLMBEUfeQ8RYj7WLvL8ECPstLFvsaxz6h6C7xbSdQ9MhQrS+y+2OHYzuMHH3X70ewgC/0cLfCk1ezyPh/m7B6wFA8SI83AQYAcDx94mR3JIwAAAAASUVORK5CYII=) bottom right no-repeat}.ws-panelNotes-hider.ws-panelNotes-hider_big.ws-hider_fletching{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAoCAYAAADt5povAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAATFJREFUeNrs2L1KBDEQAOCZJAs2eougIDYiVwpa2djpA3iN1lf4CPoU2x1X+BgHPoBvIOtPpXaWgrtyyrlnknFmsRAOxeNksZhAEkiG/ZJMmiwWRU7QYHHSzL9ljWDDuRMw0HBRUEEFFVRQQQUVVFBBBRVU8F+CbprgiC14txvguUZcAEOPIQnXNgk3gFT9DSiIt+0airgMCFWBNOrz1EXEpW7ldve5gov34MIdCD41OIHQaIgwPuOprJVu519CB2V5mXLf8Wb9yJv2TpXsBRdu613b+DDxbZSfCvLG/w7h8SxNN/PfHBfja4Lzko/5eqwivfgkXDnBDT3Xb/walOPg1XGsHxt6PWfklJHBLJeD8S3uugDhEMCuSL45BVbA0tAT52OxNyvyA9753PnBhwADACRYhLDZk4SlAAAAAElFTkSuQmCC) bottom right no-repeat}"));head.appendChild(style);});}
define('js!SBIS3.Notes.PanelNotesHider',['SBIS3.CONTROLS/CompoundControl','Core/EventBus','Core/detection','Core/helpers/getSessionStorageValue','Core/helpers/setSessionStorageValue','html!SBIS3.Notes.PanelNotesHider','css!SBIS3.Notes.PanelNotesHider','Zametki_localization'],function(e,t,n,s,a,i){'use strict';var o=e.extend({_dotTplFn:i,$protected:{_options:{panelData:{panelType:'',panelTitle:'',panelId:'',canEdit:true,hasNotes:false}},_count:-1,_lightMode:true,_alreadyGotCount:false,_showNotes:false,_eventNamespace:'.panelNotesHider',_containerId:''},$constructor:function(){this._publish('onNotesCountChanged');},init:function(){o.superclass.init.call(this);var e=this,s=t.channel('NoteCommands');if(this.setVisible(false),this._dom={hider:this.getContainer(),count:this.getContainer().find('.ws-panelNotes-hider__count')},this._options.panelData.panelId)this.prepareSendEvent();if(this.subscribeTo(s,'ResendHiderLoadedEvent',function(){e.sendEventWhenHiderLoaded();}),this.subscribeTo(s,'setPanelHiderCount',function(t,n,s){if(e._containerId==n)e._lightMode=false,e._options.panelData.hasNotes=!!s,e.setCount(s);}),this.subscribeTo(s,'setPanelHiderState',function(t,n,s){if(e._containerId==n)e.setState(s);}),this.subscribeTo(s,'setPanelHiderFakeState',function(t,n){if(e._containerId==n)e.fakeToggleState();}),this.subscribeTo(s,'restorePanelHiderState',function(t,n){if(e._containerId==n)e.restoreState();}),this._dom.hider.on('mouseenter'+this._eventNamespace,function(){if(!n.isMobilePlatform)$(this).addClass('ws-panelNotes-hider_expanded');return false;}).on('mouseleave'+this._eventNamespace,function(){return $(this).removeClass('ws-panelNotes-hider_expanded'),false;}).on('touchstart'+this._eventNamespace,function(){return e.toggleState(),false;}).on('click'+this._eventNamespace,function(){return e.toggleState(),false;}),this._dom.hider.add(this._dom.hider.children()).attr('unselectable','on').on('selectstart',false),this._options.hasNotes)this._dom.hider.addClass('hasNotes');},prepareSendEvent:function(){var e=this;require(['Lib/FloatAreaManager/FloatAreaManager'],function(n){if(e._containerId=n._getTopFloatArea().id,e.sendEventWhenHiderLoaded(),e.subscribeTo(t.channel('NoteCommands'),'ResendHiderLoadedEvent',function(){e.sendEventWhenHiderLoaded();}),e.isOpenDoc(location.pathname))e.subscribeOnceTo(t.channel('NotesEvents'),'onNoteAdded',function(t,n){if(n.pinnedToPanel&&n.panelData&&n.panelData.panelId==e._options.panelData.panelId&&!e._options.panelData.hasNotes)e._forceSendEventMode=e._options.panelData.hasNotes=true,e.sendEventWhenHiderLoaded();});});},sendEventWhenHiderLoaded:function(e){var n=!!+s('show-panel-notes');if(this._lightMode=this._lightMode&&!n&&this.isOpenDoc(location.pathname),this._options.panelData.hasNotes&&this._lightMode)if(this._dom.hider.css('display','inline-block'),this.setVisible(true),!this._alreadyGotCount)this.getNotesCount();t.channel('NotesEvents').notify('onPanelNotesHiderLoaded',{type:this._options.panelData.panelType,title:this._options.panelData.panelTitle,id:this._options.panelData.panelId,canEdit:this._options.panelData.canEdit,containerId:this._containerId,hasNotes:this._options.panelData.hasNotes},this._lightMode,e);},getNotesCount:function(){var e=this;require(['WS.Data/Source/SbisService'],function(t){new t({endpoint:{contract:'Note',address:'/notes/service/'}}).call('GetCountPanelNotes',{PanelObject:e._options.panelData.panelType,PanelId:e._options.panelData.panelId}).addCallback(function(t){var n=t.getRawData();e.setCount(n),e._alreadyGotCount=true;}).addErrback(function(e){});});},setPanelData:function(e){if(this._options.panelData.panelId!==e.panelId||this._options.panelData.panelType!==e.panelType||this._options.panelData.panelTitle!==e.panelTitle||this._options.panelData.canEdit!==e.canEdit||this._options.panelData.hasNotes!==e.hasNotes)this._options.panelData=e,this.prepareSendEvent();},toggleState:function(e){if(!e&&this._fake)return;if(this._showNotes=!this._showNotes,this._dom.hider.attr('title',this._showNotes?rk('Скрыть заметки'):rk('Показать заметки')),this._dom.hider.toggleClass('ws-hider_fletching',this._showNotes),!e)if(this._lightMode)a('show-panel-notes',1),this._lightMode=false,this.sendEventWhenHiderLoaded(true);else t.channel('NotesEvents').notify('onPanelNotesHiderToggle',this._showNotes,{panelType:this._options.panelData.panelType,panelTitle:this._options.panelData.panelTitle,panelId:this._options.panelData.panelId,canEdit:this._options.panelData.canEdit,containerId:this._containerId});},fakeToggleState:function(){if(this._fake=true,this._showNotes)this._dom.hider.attr('title',rk('Показать заметки')),this._dom.hider.toggleClass('ws-hider_fletching',false);},restoreState:function(){this._fake=false;var e=!!+s('show-panel-notes');this._showNotes=e,this._dom.hider.attr('title',e?rk('Скрыть заметки'):rk('Показать заметки')),this._dom.hider.toggleClass('ws-hider_fletching',e);},setState:function(e){if(this._showNotes!==e)this.toggleState(true);},setCount:function(e){if(this._dom.count.text(e>99?'99+':e),e)this._dom.hider.css('display','inline-block');if(this.setVisible(e>0),this._dom.hider.toggleClass('hasNotes',e>0),this._dom.hider.toggleClass('ws-panelNotes-hider_big',e>=100),this._count>=0&&this._count!==e)this._notify('onNotesCountChanged',e);this._count=e;},destroy:function(){o.superclass.destroy.call(this),this._dom.hider.off(this._eventNamespace),this._dom=null;},doesUrlMatch:function(e,t){return new RegExp('^/(?:debug/)?'+t,'ig').test(e);},isOpenDoc:function(e){return!$('#accordionBg').length&&!$('[data-component="SBIS3.Navigation.Navigation"]').length||this.doesUrlMatch(e,'opendoc\\.html$');}});return o;});
define("html!SBIS3.Notes.NoteActions",function(){var o=function(o){var n=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,"&#123;&#123;$1&#125;&#125;");return n}}(),t=function(o){return o.join?o.join(""):o.toString()},e=function(o){return void 0===o?"":o&&"object"==typeof o?t(o):""+o},i="undefined"!=typeof process,r=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,'<div class="ws-note__actions"> ');return o.showActions&&(r+=' <component data-component="SBIS3.Notes.TagButton" name="TagButton" class="controls-IconButton__round-border"> </component> ',o.showPin&&(r+=' <component data-component="SBIS3.Notes.Pin" name="Pin" class="controls-IconButton__round-border"> <option name="allowPinToAnyPage">'+n(e(o.allowPinToAnyPage))+"</option> </component> "),r+=' <component data-component="SBIS3.CONTROLS/Button/IconButton" name="ShowNote" class="controls-IconButton__round-border"> <option name="icon">sprite:icon-16 icon-Show icon-primary</option> <option name="tooltip">'+n(e(rk("Показать заметку")))+'</option> <option name="visible">'+n(e(o.isHidden))+'</option> </component> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="HideNote" class="controls-IconButton__round-border"> <option name="icon">sprite:icon-16 icon-Hide icon-primary</option> <option name="tooltip">'+n(e(rk("Скрыть заметку")))+"</option> ",o.isHidden?r+=' <option name="visible">false</option> ':r+=' <option name="visible">'+n(e(o.showHideIcon))+"</option> ",r+=' </component> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="Remove" class="controls-IconButton__round-border"> <option name="icon">sprite:icon-16 icon-Erase icon-error</option> <option name="tooltip">'+n(e(rk("Удалить заметку")))+"</option> </component> "),r+=" </div>",(r=n(r))+(i&&-1!==r.indexOf("{{")?String.fromCharCode(8203,8203):"")};return o.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.NoteActions"}},o});
define('js!SBIS3.BL.Note',['WS.Data/Source/SbisService','WS.Data/Query/Query','WS.Data/Entity/Record','Core/helpers/random-helpers','Core/helpers/getSessionStorageValue','Core/IoC','Core/base64','Core/Deferred','Zametki_localization'],function(e,t,n,r,o,a,i,l){'use strict';var d,u,s,c=false;function f(e){return e instanceof Array?e:[e];}function g(e){return $('<div>').html(e).text().replace(/\n/g,' ');}function N(){if(!u)u=new e({endpoint:'Note'});for(var t=[],n=0,r=arguments.length;n<r;n++)t[n]=arguments[n];return u.call.apply(u,t);}function p(n){if(!s)s=new e({endpoint:{address:'/notes/service/',contract:'Note'},binding:{query:'GetPinnedNotesList'}});return s.query(new t().where(n));}function I(){if(!d)d=new e({endpoint:{address:'/notes/service/',contract:'Note'}});for(var t=[],n=0,r=arguments.length;n<r;n++)t[n]=arguments[n];return d.call.apply(d,t);}function C(){if(c)return l.success();for(var e=[],t=0,n=arguments.length;t<n;t++)e[t]=arguments[t];return I.apply(null,e);}function P(e){if(e=e?'string'==typeof e?e:e.getRawData():null,!e)c=true,e=r.createGUID();return e;}return{getPersonPinnedNotes:function e(t,r,o){var a=new n({adapter:'adapter.sbis',format:[{name:'PageUrl',type:'string'},{name:'showHidden',type:'boolean'}]});if(!o)a.set('PageUrl',location.href),a.set('showHidden',r?null:false);if(t)a.addField({name:'PanelObject',type:'string'}),a.set('PanelObject',t.type),a.addField({name:'PanelTitle',type:'string'}),a.set('PanelTitle',t.title),a.addField({name:'PanelId',type:'string'}),a.set('PanelId',''+t.id);return p(a).addCallback(function(e){return e?e.getAll():null;});},createNotification:function e(t,n,r,o,a,i,l){return C('CreateNotification',{NoteId:t,NotificationDate:n?n.toSQL(true):null,NotificationText:r,NotificationType:o,RetryCount:a,CronData:i,ExpirationDate:l});},deleteNotifications:function e(t){return C('DeleteNotifications',{NoteId:t});},createNote:function e(t){var n=t.pageUrl&&!t.pageTitle?rk('Страница без заголовка'):t.pageTitle;return C('CreateNote',{Content:t.text,Text:g(t.text),Order:t.order,Pinned:t.pin,PageUrl:t.pin?t.pageUrl:null,PageTitle:t.pin?n:null,Color:t.color,Settings:JSON.stringify(t.getSettings())}).addCallback(function(e){if(e=e?e.getRawData():null,null==e||''===e)c=true;return P(e);});},removeImages:function t(n){new e({endpoint:{contract:'FileSD',address:'/disk/api/v1/service/'}}).call('DeleteAttachments',{Ids:n});},updateNote:function e(t,n,r){return C('UpdateNote',{Id:t.baseId,Content:!r||r.indexOf('Content')>=0?t.text:null,Text:!r||r.indexOf('Text')>=0?g(t.text):null,Settings:!r||r.indexOf('Settings')>=0?JSON.stringify(t.getSettings()):null,Order:!r||r.indexOf('Order')>=0?t.order:null,Color:!r||r.indexOf('Color')>=0?t.color:null,UpdateModifyDate:!r||r.indexOf('Content')>=0?!!n:null}).addCallback(function(e){if(c)return e=t.text,e;return e.getRawData();});},rearrangeNotes:function e(t){return C('RearrangeNotes',{Id:t});},hideNote:function e(t){return C('SetHidden',{NoteId:t,IsHidden:true});},hideNotesList:function e(t){return C('SetHiddenList',{NoteId:t,IsHidden:true});},showNote:function e(t){return C('SetHidden',{NoteId:t,IsHidden:false});},showNotesList:function e(t){return C('SetHiddenList',{NoteId:t,IsHidden:false});},moveNote:function e(t,n,r){return C('MoveNote',{NextNoteId:t,NoteId:n,OnFront:r});},deleteNotes:function e(t){return C('DeleteNotes',{Id:f(t)}).addCallback(function(e){return e?e.getRawData():null;});},lockNote:function e(t){return C('LockNote',{NoteId:t});},unlockNote:function e(t){return C('UnlockNote',{NoteId:t});},getAvailableNotificationTypes:function e(){return N('GetAvailableNotificationTypes',{}).addCallbacks(function(e){return e=e.getRow(),[e.get('smsErr'),e.get('emailErr'),e.get('pluginErr')];},function(e){return a.resolve('ILogger').error(rk('Сервис заметок не позволяет создавать оповещения'),e),[e.message,e.message,e.message];});},getPersonNotes:function e(t){return t=t||{},I('GetPersonNotes',{Page:t.page||0,CountPerPage:t.pageSize||o('ws-page-size')||20,DESC:t.orderDESC||false,Tags:t.tags||[],PagesId:t.urls||[],SearchQuery:t.searchQuery||'',Color:null==t.color?null:+t.color,StartDate:t.startDate||null,EndDate:t.endDate||null});},addFile:function e(t,n){return C('AddFile',{NoteId:t,FileId:n});},deleteFile:function e(t,n){return C('DeleteFile',{NoteId:t,FileId:n});},addIndependentTag:function e(t,n){return C('AddTag',{TagName:t,Color:n}).addCallback(P);},addTag:function e(t,n,r){return C('AddTag',{NoteId:t,TagName:n,Color:r}).addCallback(P);},deleteTag:function e(t,n){var r={TagName:t};if(n)r.NoteId=n;return C('DeleteTag',r);},updateTag:function e(t,n,r){return C('UpdateTag',{Name:t,NewName:n,Color:r}).addCallback(function(e){return c?'':e?e.getRawData():'';});},getLastChangedInfo:function e(t){return C('GetLastChangedInfo',{NoteId:t});},pinNote:function e(t,n,r){return C('PinNote',{NoteId:t,PageUrl:n||null,PageTitle:r||null});},pinNoteByUrlId:function e(t,n){return C('PinNote',{NoteId:t,UrlId:n});},pinToPanel:function e(t,n,r,o){return C('PinToPanel',{NoteId:t,PanelObject:n||null,PanelTitle:r||null,PanelId:''+o||null}).addCallback(function(e){return c?'':e?e.getRawData():'';});},unpinNote:function e(t){return C('UnpinNote',{NoteId:t});},postRequestCall:function e(t,n){var r=new XMLHttpRequest();r.open('POST','https://'+window.location.host+'/notes/service/',false),r.setRequestHeader('X-CalledMethod',t),r.setRequestHeader('X-OriginalMethodName',i.encode(t)),r.setRequestHeader('X-Requested-With','XMLHttpRequest'),r.send(JSON.stringify({jsonrpc:'2.0',protocol:4,method:t,params:n,id:1}));},isDemo:function e(){return c;}};});
define('js!SBIS3.Notes.Utils.Date',['Core/helpers/String/format','Core/constants','Zametki_localization'],function(t,e){'use strict';return{prettyDate:function(t){if(!(t instanceof Date)||isNaN(+t))return'';var a=t.getDate(),r=t.getHours(),n=t.getMinutes(),s=(r>9?'':'0')+r+':'+(n>9?'':'0')+n,i=new Date(t),$=new Date(),f='';i.setHours(0,0,0,0),$.setHours(0,0,0,0);var o=i-$;if(0===o)f=rk('Сегодня');else if(86400000===o)f=rk('Завтра');else if(-86400000===o)f=rk('Вчера');else f=a+' '+e.Date.monthsSmall[t.getMonth()];return f+', '+s;},nearestPrettyDate:function(t,e){if(!(t instanceof Date)||isNaN(+t))return'';if(!e)return this.prettyDate(t);else{var a=this.getRepeatType(e);return this.prettyDate(this.getNearestDate(t,a));}},getRepeatType:function(t){var e=t.split(' '),a=e[0].split('-'),r=0;if(e.length>2&&'*'!==e[2])r=2;else if(t.indexOf('*')<0)r=0;else{if('*'===a[0])r=5;if('*'===a[1])r=3;if('*'===a[2])r=1;if(a[1].indexOf(',')>0)r=4;}return r;},getCronString:function(e,a){var r=[],n={date:e};if(4===a){var s=e.getMonth()%3+1;n.monthString=s+','+(s+3)+','+(s+6)+','+(s+9);}r[0]='$date$t$%Y-%m-%d$ $date$t$%H:%M:00$',r[1]='*-*-* $date$t$%H:%M:00$ *',r[2]='*-*-* $date$t$%H:%M:00$',r[3]='$date$t$*-*-%d$ $date$t$%H:%M:00$',r[4]='*-$monthString$s$-$date$t$%d$ $date$t$%H:%M:00$',r[5]='$date$t$*-%m-%d$ $date$t$%H:%M:00$';var i=r[a],$=t(n,i);if(2===a){var f=e.getDay()-1;if(f<0)f=6;$=$+' '+f;}return $;},getNearestDate:function(t,e){var a=0,r=new Date();if(e){if(1===e&&t<r)t.setDate(r.getDate()),t.setMonth(r.getMonth()),t.setFullYear(r.getFullYear());while(t<r&&a<100)switch(a++,e){case 1:t.setDate(t.getDate()+1);break;case 2:t.setDate(t.getDate()+7);break;case 3:t.setMonth(t.getMonth()+1);break;case 4:t.setMonth(t.getMonth()+3);break;case 5:t.setFullYear(t.getFullYear()+1);}}return t;}};});
define('js!SBIS3.Notes.Utils.Info',['Zametki_localization'],function(){'use strict';return{showMessageDialog:function(o){require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(i){i.showMessageDialog(o);});},showNotification:function(o){require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(i){i.showNotification({caption:o,status:'success'});});}};});
define('js!SBIS3.Notes.Note',['Core/core-functions','Core/core-merge','Core/helpers/String/format','Core/helpers/random-helpers','Core/core-instance','SBIS3.CONTROLS/Utils/LinkWrapUtils','js!SBIS3.BL.Note','WS.Data/Collection/RecordSet','WS.Data/Entity/Model','Core/Deferred','Core/ParallelDeferred','Core/IoC','js!SBIS3.Notes.PanelData','js!SBIS3.Notes.Utils.Date','js!SBIS3.Notes.Utils.Info','js!SBIS3.Notes.AccordionWrapper','WS.Data/Chain','Zametki_localization'],function(t,e,i,a,n,s,r,o,l,h,d,u,c,p,f,g,T){'use strict';function I(t,e,i){this.id=t,this.name=e||'',this.size=i||0;}function _(t,i){var s;if(t=t||{},n.instanceOfModule(t,'WS.Data/Entity/Model'))s=this._fromRecord(t,i);else s=e({},t);var r=e(i?{tags:[],settingsFiles:[],files:b()}:{id:a.createGUID(),tags:[],settingsFiles:[],files:b()},this.defaults);if(e(s,r,{preferSource:true,noOverrideByNull:true}),s.calendar)s.calendar=new Date(s.calendar);if(e(this,s),this.calendar&&!this.title)this._updateTitleFromCalendar();if(this._getBaseId=this.baseId?h.success(this.baseId):new h(),this.creationDate)this.prettyCreationDate=p.prettyDate(this.creationDate);if(this.modified)this.prettyModified=p.prettyDate(this.modified);if(this.baseId)this.snapshot();if(null==this.top&&null==this.bottom)this.top=0;else if(null!=this.top&&null!=this.bottom)this.bottom=null;if(null==this.left&&null==this.right)this.left=0;else if(null!=this.left&&null!=this.right)this.right=null;}_.NOTE_BODY_PADDING=13,_.MIN_NOTE_WIDTH=220+2*_.NOTE_BODY_PADDING,_.MIN_NOTE_HEIGHT=64+2*_.NOTE_BODY_PADDING,_.DEFAULT_NOTE_WIDTH=230+2*_.NOTE_BODY_PADDING,_.DEFAULT_NOTE_HEIGHT=75+2*_.NOTE_BODY_PADDING,_.prototype.defaults={baseId:'',width:_.DEFAULT_NOTE_WIDTH,height:_.DEFAULT_NOTE_HEIGHT,order:1,pin:false,color:0,calendar:null,notificationMethod:0,cron:null,period:null,text:'',title:'',pageUrl:null,pageTitle:null,creationDate:null,pinnedToPanel:false,isHidden:false,prettyCreationDate:'',node:false};function m(t){var e=[];if(t)t.each(function(t){var i={id:t.get('Id'),name:t.get('Name'),color:t.get('Color')};e.push(i);});return e;}_.prototype._fromRecord=function t(e,i){var a=c.getTop(),s;if(n.instanceOfModule(e,'WS.Data/Entity/Model'))e=T(e).toObject();else e=e.toObject();try{s=JSON.parse(e.Settings)||{};}catch(t){s={};}if(true===s)s={};if(i)s.id=e.id;if(s.baseId=e.Id?e.Id:e.baseId,s.text=e.Content,s.order=e.Order,s.pin=e.Pinned,s.pinnedToPanel=e.PinnedToPanel||false,s.panelId=a?a.id:0,s.panelData={},s.isAuthor=e.IsAuthor||false,s.canEdit=a?a.canEdit:false,s.creationDate=e.CreationDate,s.modified=e.ModifyDate,s.settingsFiles=s.files?s.files.slice():[],s.files=b(e.Files,Boolean(!s.pinnedToPanel||s.isAuthor)),!s.pinnedToPanel||s.isAuthor)s.calendar=e.Notification,s.notificationMethod=e.TypeNotification,s.cron=e.CronData;return s.isHidden=e.IsHidden,s.color=e.Color||0,s.pageUrl=e.PageName&&'null'!=e.PageName?e.PageName:null,s.pageTitle=e.PageTitle&&'null'!=e.PageTitle?e.PageTitle:null,s.tags=i?e.tags:m(e.Tags),s;};function b(t,e){var t=t?t.split(','):[];return new o({idProperty:'attachId',rawData:t.map(function(t){return{attachId:t,fileName:'',title:'',Size:0,redactionId:'',versionForm:'',typeDoc:'',subTypeDoc:'',subVersionForm:'',hash:'',canEdit:false!==e};})});}function N(t){return t.getRawData().map(function(t){return new I(t.attachId,t.fileName,_.prettyFileSize(t.Size));});}_.prototype._updateTitleFromCalendar=function t(){this.title=this.calendar?p.nearestPrettyDate(this.calendar,this.cron):'';},_.prototype.getSettings=function t(){var e={width:this.width,height:this.height,files:N(this.files)};if(null!=this.contentImages)e.contentImages=this.contentImages;if(null!=this.top)e.top=this.top;if(null!=this.left)e.left=this.left;if(null!=this.bottom)e.bottom=this.bottom;if(null!=this.right)e.right=this.right;return e;};function y(t){var e=$('<div>').html(t),i=e.find('a.LinkDecorator__linkWrap');if(i&&i.length)e.each(function(t,e){i[t].innerText=i[t].href;});return e.text().replace(/\n/g,' ').substr(0,128);}_.prototype.setCalendar=function t(e,i,a,n,s){var o=this;return this.create(),this._updateLastUpdateTime(),this._getBaseId.addCallback(function(t){var l=y(o.text);if(!t||'object'==typeof t)t=o.baseId;if(e)return r.createNotification(t,e,l,i,a,n,s).addCallbacks(function(){return o.calendar=e,o.notificationMethod=i,o.cron=n,o._updateTitleFromCalendar(),t;},function(){return f.showMessageDialog({message:rk('Сервис оповещений недоступен'),status:'error'}),t;});else return r.deleteNotifications([t]).addCallbacks(function(){return o.calendar=null,o.notificationMethod=null,o.cron='',o._updateTitleFromCalendar(),t;},function(){return f.showMessageDialog({message:rk('Сервис оповещений недоступен'),status:'error'}),t;});});},_.prototype.save=function t(e){return this.update(e)||this.create();},_.prototype.update=function t(e){var i=this;if(this.baseId){var a=this.hasChanged(true);if(a)this.prettyModified=p.prettyDate(this.modified=new Date());return this.snapshot(),this._updateLastUpdateTime(),r.updateNote(this,a,e).addCallbacks(function(t){if(!e)i._snapshot.text=i.text=t;if(setTimeout(function(){i._updateNotification();},5000),i.oldContentImages){var a=[];for(var n in i.oldContentImages)if(i.oldContentImages.hasOwnProperty(n)&&!i.contentImages.hasOwnProperty(n))a.push(n);if(a.length)r.removeImages(a);}},function(t){if(u.resolve('ILogger').error('Ошибка при обновлении заметки',t),e&&e.length);else f.showMessageDialog({message:rk('Ошибка при обновлении заметки'),details:t.message||t.details,status:'error'});});}else if(this._creatingProcess)return this._creatingProcess.addCallback(function(){return i.update(e);});else return h.fail();},_.prototype.create=function t(){var e=this;if(!this.baseId&&!this._creatingProcess)return this.snapshot(),this._updateLastUpdateTime(),this._creatingProcess=r.createNote(this).addCallbacks(function(t){if(e.baseId=t,e._creatingProcess=null,e._getBaseId.callback(t),e.tags.forEach(function(t){if(t.needSave)r.addTag(e.baseId,t.name,t.color);}),e.pinnedToPanel&&(!$('#accordionBg').length&&!$('[data-component="SBIS3.Navigation.Navigation"]').length||e.panelId||e.panelData.panelId))if(e.panelId)e.pinToPanel(c.getDataFromStr(e.panelId));else if(e.panelData&&e.panelData.panelId)e.pinToPanel({type:e.panelData.panelType,id:e.panelData.panelId,title:e.panelData.panelTitle});else e.pinToPanel(c.getTop());},function(t){e._creatingProcess=null,u.resolve('ILogger').error('Ошибка при создании заметки',t),f.showMessageDialog({message:rk('Ошибка при создании заметки'),details:t.message||t.details,status:'error'});}),this._creatingProcess;return null;},_.prototype.wasSaved=function t(){return!!(this.baseId||this._creatingProcess);},_.prototype.remove=function t(){var e=this;if(this._updateLastUpdateTime(),this.baseId)return r.deleteNotes(this.baseId);else return this._getBaseId.addCallback(function(){return r.deleteNotes(e.baseId);});},_.prototype.lockNote=function t(){if(this.baseId)return r.lockNote(this.baseId);else return this._getBaseId.addCallback(function(){return r.lockNote(this.baseId);});},_.prototype.unlockNote=function t(){if(this.baseId)return r.unlockNote(this.baseId);else return this._getBaseId.addCallback(function(){return r.unlockNote(this.baseId);});},_.getFileRecord=function(t){var e=t.get('Version').at(0),i=e.get('FormalizedFile'),a=null,n=null,s=null,r=null;if(i)a=i.get('FEDVersion'),n=i.get('FEDSubversion'),s=i.get('FEDType'),r=i.get('FEDSubtype');return new l({idProperty:'attachId',rawData:{attachId:t.getId(),fileName:t.get('FileName'),title:t.get('Name'),Size:t.get('Size'),redactionId:e.get('Id'),versionForm:a,subVersionForm:n,typeDoc:s,subTypeDoc:r,hash:e.get('hash'),canEdit:true,encrypted:e.get('EncryptionType')}});},_.prototype.addFile=function t(e){var i=this,a=new h(),n=e.getId();if(this.hasFile(n))return h.success();var s=this.files;return this.files.add(_.getFileRecord(e)),this.files=s,this._updateLastUpdateTime(),this._getBaseId.addCallback(function(){return r.addFile(i.baseId,n).addCallbacks(function(){a.callback();},function(t){a.errback(t);}),i.baseId;}),a;},_.prototype.removeFile=function t(e){var i=this,a=new h();if(this.removeFileWithoutUpdate(e))return this._updateLastUpdateTime(),this._getBaseId.addCallback(function(){r.deleteFile(i.baseId,e).addCallbacks(function(){if(i&&(i.hasContent()||i.files.getCount()||i.tags.length))i.update().addCallbacks(function(){a.callback();},function(){a.callback();});},function(t){a.errback(t);});}),a;return h.fail();},_.prototype.removeFileWithoutUpdate=function t(e){var i=this.files.getIndexByValue(this.files.getIdProperty(),e);if(i>=0){var a=this.files;return this.files.removeAt(i),this.files=a,true;}return false;},_.prototype.hasFile=function t(e){return this.files.getIndexByValue(this.files.getIdProperty(),e)>=0;},_.prototype._getFileIds=function(){var t=[];return this.files.each(function(e){t.push(e.getId());}),t;},_.prototype.addTag=function t(e,i,a){var n=this,s=new h();if(e=e&&e.trim(),this.hasTag(e))s.callback(this.getTag(e).id);else if(this._updateLastUpdateTime(),this._getBaseId.addCallback(function(t){if(!t)t=n.baseId;if(a)r.addIndependentTag(e,i).addCallbacks(function(t){s.callback(t);},function(t){s.errback(t);});else r.addTag(t,e,i).addCallbacks(function(t){n.tags.push({id:t,name:e,color:i}),s.callback(t);},function(t){s.errback(t);});return t;}),!this.baseId)this.create();return s;},_.prototype.addTags=function t(e){var i=this,a=new d();return e.forEach(function(t){a.push(i.addTag(t.name,t.color,t.independent));}),a.done().getResult().addCallback(function(t){var e=[];return Object.keys(t).forEach(function(i){e.push(t[i]);}),e;});},_.prototype.getTag=function t(e){if(e=e&&e.trim(),e){var i=this.tags.filter(function(t){return t.name===e;});return i.length?i[0]:null;}return null;},_.prototype.hasTag=function t(e){return!!this.getTag(e);},_.prototype.removeTag=function t(e,i,a){var n=this,s=true,o=new h();if(e=e&&e.trim(),a)this.tags=this.tags.filter(function(t){return t.name!==e;}),o.callback();else{if(i)s=this.hasTag(e);else s=this.removeTagWithoutSave(e);if(s)this._updateLastUpdateTime(),this._getBaseId.addCallback(function(t){if(!t)t=n.baseId;r.deleteTag(e,t).addCallbacks(function(){return o.callback(t),t;},function(t){o.errback(t);});});else o.callback();}return o;},_.prototype.removeTags=function t(e){var i=this,a=new d();return e.forEach(function(t){a.push(i.removeTag(t));}),a.done().getResult();},_.prototype.removeTagWithoutSave=function t(e){e=e&&e.trim();var i=this.tags.filter(function(t){return t.name!==e;});if(JSON.stringify(i)!==JSON.stringify(this.tags))return this.tags=i,true;return false;},_.prototype.snapshot=function e(){this._snapshot={text:this.text,color:this.color,pin:this.pin,order:this.order,files:this._getFileIds(),width:this.width,height:this.height,left:this.left,top:this.top,bottom:this.bottom,right:this.right,calendar:this.calendar,tags:t.clone(this.tags)};},_.prototype.rollback=function t(){if(this._snapshot)this.text=this._snapshot.text,this.color=this._snapshot.color;},_.prototype._compareFiles=function(){var t=this._getFileIds(),e=t.length,i,a,n;if(!this._snapshot||this._snapshot.files.length!==e)return false;for(n=0;n<e;n++)if(i=t[n],a=this._snapshot.files[n],i!==a)return false;return true;},_.prototype._compareTags=function(){var t=this.tags.length,e,i,a;if(!this._snapshot||this._snapshot.tags.length!==t)return false;for(a=0;a<t;a++)if(e=this.tags[a],i=this._snapshot.tags[a],e.name!==i.name||e.color!==i.color)return false;return true;},_.prototype.hasChanged=function t(e,i){if(!this._snapshot)return false;var a=!v(this.text,this.undecoratedContent||this._snapshot.text)||this.color!==this._snapshot.color||!this._compareFiles()||!this._compareTags();if(e)return a;return a||(i?false:this.order!==this._snapshot.order)||this.width!==this._snapshot.width||this.height!==this._snapshot.height||this.left!==this._snapshot.left||this.top!==this._snapshot.top||this.bottom!==this._snapshot.bottom||this.right!==this._snapshot.right||this.calendar!==this._snapshot.calendar;};function D(t){var e=$(t),a='<img src="$src$s$" alt="$alt$s$" data-original-height="$height$s$" data-original-width="$width$s$ style="$style$s$" />',n={src:e.attr('src'),alt:e.attr('alt'),width:e.css('width'),height:e.css('width'),style:e.attr('style')};return i(n,a);}function P(t){return t.replace(/<img[^>]+>/gi,D).replace(/<br>/gi,'<br />').replace(/<br\/>/gi,'<br />').replace(' rel="noopener noreferrer"','');}function v(t,e){return P(t)===P(e);}function C(t){return t&&t.replace(/^\s+|\s+$/gm,'');}function k(t){var e=document.createElement('div');if(e.innerHTML=t,e.getElementsByTagName('img').length||e.getElementsByTagName('iframe').length)return false;return!C(null==e.innerText?e.textContent:e.innerText);}_.prototype.hasContent=function t(){return!k(this.text)||this.files.getCount()>0;},_.prototype.getPosition=function t(e,i){return{top:null==this.top?i-this.bottom-this.height:this.top,left:null==this.left?e-this.right-this.width:this.left};},_.prototype.setPosition=function t(e,i,a,n){var s=a-i-this.width,r=n-e-this.height,o=i<s,l=e<r;this.top=l?e:null,this.bottom=l?null:r,this.left=o?i:null,this.right=o?null:s;},_.prettyFileSize=function t(e){if(!e)return'0 '+rk('байт');var i=[rk('байт'),rk('КБ'),rk('МБ'),rk('ГБ'),rk('ТБ')],a=1024,n=Math.floor(Math.log(e)/Math.log(a)),s=n<2?0:2===n?1:2;return(e/Math.pow(a,n)).toFixed(s).replace(/\.0+$/,'')+' '+i[n];};function E(){var t=g.getAccordion();return(t?t.getPathToActiveItem():[]).join(' / ')||document.title.replace(/\/СБИС$/i,'')||rk('Главная');}return _.prototype.setPinnedToCurrentPage=function t(){this.pin=true,this.pageUrl=location.href,this.pageTitle=E();},_.prototype.pinToCurrentPage=function t(){var e=this;return this.setPinnedToCurrentPage(),this.create(),this._updateLastUpdateTime(),this._getBaseId.addCallback(function(){return r.pinNote(e.baseId,e.pageUrl,e.pageTitle);});},_.prototype.pinToMainPage=function t(){var e=this;return this.pin=true,this.pageUrl=location.protocol+'//'+location.hostname+'/',this.pageTitle='СБИС',this.create(),this._updateLastUpdateTime(),this._getBaseId.addCallback(function(){return r.pinNote(e.baseId,e.pageUrl,e.pageTitle);});},_.prototype.pinToPanel=function t(e){var i=this;return this.setPinnedToCurrentPage(),this.create(),this._updateLastUpdateTime(),this._getBaseId.addCallback(function(){return r.pinToPanel(i.baseId,e.type,e.title,e.id);});},_.prototype.pinToAllPages=function t(){var e=this;return this.pin=true,this.pageUrl=this.pageTitle=null,this.create(),this._updateLastUpdateTime(),this._getBaseId.addCallback(function(){return r.pinNote(e.baseId);});},_.prototype.unpin=function t(){var e=this;return this.pin=false,this.create(),this._updateLastUpdateTime(),this._getBaseId.addCallback(function(){return r.unpinNote(e.baseId);});},_.prototype.presetPin=function t(e){if(e==_.NOTE_PIN_PAGE)this.pin=true,this.pageUrl=location.href,this.pageTitle=E();else if(e==_.NOTE_PIN_ALL_PAGES)this.pin=true,this.pageUrl=this.pageTitle=null;else this.pin=false;},_.prototype.canBeUpdatedOnServerMessage=function t(){return!_.lastUpdateTime||_.lastUpdateTime+5000<new Date().getTime();},_.prototype._updateLastUpdateTime=function t(){_.lastUpdateTime=new Date().getTime();},_.prototype.updateNotificationOnNextSave=function t(){this._needToUpdateNotification=true;},_.prototype._updateNotification=function t(){var e=this.calendar,i,a=this;if(e&&e-new Date()>0&&this._needToUpdateNotification)i=y(this.text),r.createNotification(this.baseId,e,i,this.notificationMethod,null,this.cron,null).addCallback(function(){a._needToUpdateNotification=false;});},_.prototype.getDisplayText=function t(){return s.wrapURLs(this.text);},_.isDemo=function t(){return r.isDemo();},_.NOTE_PIN_UNPINNED=0,_.NOTE_PIN_ALL_PAGES=1,_.NOTE_PIN_PAGE=2,_.NOTE_PIN_PANEL=3,_.prototype.getPin=function t(){return this.pinnedToPanel?_.NOTE_PIN_PANEL:this.pin?this.pageUrl?_.NOTE_PIN_PAGE:_.NOTE_PIN_ALL_PAGES:_.NOTE_PIN_UNPINNED;},_;});
define('js!SBIS3.Notes.TagButton',['Core/EventBus','Core/core-instance','Core/detection','SBIS3.CONTROLS/Button/IconButton','Zametki_localization'],function(t,e,o,n){'use strict';var i=n.extend({_form:null,$protected:{_options:{icon:'sprite:icon-16 icon-Unfavourite icon-primary',tooltip:rk('Добавить тег'),fromDialog:false,note:null}},init:function(){i.superclass.init.call(this),this.subscribeTo(this,'onActivated',this._onActivated.bind(this));},destroy:function(){i.superclass.destroy.call(this),this._form=null;},_onActivated:function(n,i){var s=this._options.note,a=(s.tags||[]).map(function(t){return t.id;}),r=this.getContainer(),l=this,d=-8,c=-8;t.channel('NotesEvents').notify('onTagFormActivated',s);var f=this.getLinkedContext();if(f.setValue('tags',a),f.setValue('noteId',s.id),f.setValue('baseId',s.baseId),o.isMobilePlatform){var u=this.getContainer().closest('.ws-note__body');if(u.length){var g=u.find('.ws-note__actions').position();if(g)r=u,d=g.top,c=g.left;}}require(['SBIS3.CONTROLS/FloatArea','js!SBIS3.Notes.Tags'],function(o){new o({visible:true,parent:l,opener:l,template:'<component data-component="SBIS3.Notes.Tags">'+'<option name="tags" bind="tags"></option>'+'<option name="noteId" bind="noteId"></option>'+'</component>',element:$('<div class="ws-note__tag-form"></div>'),target:r,animationLength:0,autoCloseOnHide:true,activableByClick:false,corner:'tl',locationStrategy:'bodyBounds',closeButton:true,verticalAlign:{side:'top',offset:d},horizontalAlign:{side:'left',offset:c},handlers:{onReady:function(){l._form=this,l._tagsWasChanged=false,t.channel('NotesEvents').notify('onTagFormOpened',s);var o=this.getChildControls(),n=this.getChildControlByName('recentTags'),i=o.filter(function(t){return e.instanceOfModule(t,'SBIS3.Notes.Tags');})[0];l.subscribeTo(n,'onTagUpdated',l._onTagUpdated.bind(l)),l.subscribeTo(i,'onTagAdded',l._onTagAdded.bind(l)),l.subscribeTo(i,'onTagRemoved',l._onTagRemoved.bind(l)),l.subscribeTo(i,'onTagCompletelyRemoved',l._onTagCompletelyRemoved.bind(l)),l.subscribeTo(i,'onTagListClose',function(e,o){this._tagsWasChanged=!!o,this._form.close(),setTimeout(function(){t.channel('NoteCommands').notify('RedrawTags',s);},2000);}.bind(l)),l.subscribeTo(i,'recalcPosition',function(){this._form.recalcPosition(true);}.bind(l));},onClose:function(){l._form=null,t.channel('NotesEvents').notify('onTagFormClosed',s,l._tagsWasChanged),this.destroy();}},closeByExternalClick:true,closeByExternalOver:false}).show();});},_onTagUpdated:function(e,o,n,i){var s=this._options.note,a=s.tags.filter(function(t){return t.name===o;});if(a.length)(a=a[0]).name=n,a.color=i;t.channel('NotesEvents').notify('onTagUpdated',s.id,o,n,i);},_onTagRemoved:function(e,o){var n=this._options.note;if(!(o instanceof Array))o=[o];e.setResult(n.removeTags(o).addCallback(function(){t.channel('NotesEvents').notify('onTagRemoved',n.id,o);}));},_onTagCompletelyRemoved:function(e,o){this._options.note.removeTag(o,!this._options.fromDialog,true).addCallback(function(){t.channel('NotesEvents').notify('onTagRemoved',null,o);});},_onTagAdded:function(e,o){var n=this._options.note;if(!(o instanceof Array))o=[o];e.setResult(n.addTags(o).addCallback(function(e){if(e&&e.length)t.channel('NotesEvents').notify('onTagAdded',n.id,o);return e;}));},closeForm:function(){this._form&&this._form.close();}});return i;});
define('js!SBIS3.Notes.Pin',['Core/helpers/String/escapeHtml','Core/helpers/setSessionStorageValue','Core/EventBus','SBIS3.CONTROLS/Menu/MenuIcon','js!SBIS3.Notes.Note','js!SBIS3.Notes.PanelData','i18n!SBIS3.Notes.Pin','Zametki_localization'],function(i,t,e,s,n,o){'use strict';var a={};a[n.NOTE_PIN_ALL_PAGES]='sprite:icon-16 icon-primary icon-Pin2',a[n.NOTE_PIN_PAGE]='sprite:icon-16 icon-primary icon-Pin',a[n.NOTE_PIN_UNPINNED]='sprite:icon-16 icon-primary icon-Pin2',a[n.NOTE_PIN_PANEL]='sprite:icon-16 icon-primary icon-Pin';var r=s.extend({$protected:{_options:{status:n.NOTE_PIN_UNPINNED,pageTitle:'',allowPinToAnyPage:true,activableByClick:false,icon:'sprite:icon-16 icon-Pin icon-primary',pickerClassName:'ws-note__pin-menu controls-Menu__breakWord',idProperty:'id'}},_modifyOptions:function(i){var t=r.superclass._modifyOptions.apply(this,arguments);return t.caption=rk('Прикрепить заметку'),t.tooltip=rk('Прикрепить заметку'),t.items=[{id:n.NOTE_PIN_ALL_PAGES,activableByClick:false,title:rk('Ко всем страницам'),icon:'sprite:icon-16 icon-primary'},{id:n.NOTE_PIN_PAGE,activableByClick:false,title:rk('К этой странице'),icon:'sprite:icon-16 icon-primary'},{id:n.NOTE_PIN_UNPINNED,activableByClick:false,title:rk('Убрать в реестр'),icon:'sprite:icon-16 icon-primary'},{id:n.NOTE_PIN_PANEL,activableByClick:false,title:rk('К открытой панели'),icon:'sprite:icon-16 icon-primary'}],t;},$constructor:function(){this.subscribeTo(this,'onMenuItemActivate',function(i,e){if(e!==this._options.status){if(this._options.pageTitle)this.setPageTitle('');if(e!==n.NOTE_PIN_UNPINNED&&e!==n.NOTE_PIN_PANEL)t('note-pin-status',e);this.setStatus(e);}});},init:function(){if(r.superclass.init.call(this),this._isOpenDoc=!$('#accordionBg').length&&!$('[data-component="SBIS3.Navigation.Navigation"]').length,this._options.status==n.NOTE_PIN_PANEL&&!o.getTop())this.setVisible(false);else this.setPageTitle(this._options.pageTitle),this.subscribeTo(this,'onPickerOpen',this._onShowPinMenu),this.subscribeTo(this,'onPickerClose',this._onHidePinMenu),this.getContainer().on('mousedown focus',false),this.setIcon(a[this._options.status]);},_onShowPinMenu:function(){this.setStatus(this._options.status);var i=this.getItemsInstances();for(var t in i)if(i.hasOwnProperty(t))i[t].setProperty('activableByClick',false),i[t].getContainer().on('mousedown focus',false);e.channel('NotesEvents').notify('onPinMenuOpened');},_onHidePinMenu:function(){e.channel('NotesEvents').notify('onPinMenuClosed');},setStatus:function(i){if(this._markCurrentItem(i),this.setIcon(a[i]),this._options.status!==i)this._options.status=i,this._notifyOnPropertyChanged('status');},setPageTitle:function(t){this._options.pageTitle=t;var e=rk('К этой странице'),s=this._getItemById(n.NOTE_PIN_PAGE);if(!this._options.allowPinToAnyPage)if(!t||'HomePage'===t)e=rk('К главной странице');else e=rk('К странице')+' "'+i(t)+'"';if(s.title!==e)s.title=e,this.setItems(this._options.items);},_markCurrentItem:function(t){for(var e=this._options.items,s,a=o.getTop(),r=this._picker&&this.getItemsInstances(),c=0;c<e.length;c++){if(s=e[c],s.visible=s.id!=t,s.id===n.NOTE_PIN_PANEL)if(a)s.title=rk('К панели')+' "'+i(a.title)+'"';else s.visible=false;else if(s.id===n.NOTE_PIN_PAGE&&a&&this._isOpenDoc)s.visible=false;if(r)r[s.id].toggle(s.visible),r[s.id].setCaption(s.title);}if(!r)this.setItems(this._options.items);},_getItemById:function(i){var t=this._options.items.filter(function(t){return t.id===i;});return t.length?t[0]:null;}});return r;});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.NoteActions", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-note__actions{display:none;position:absolute;bottom:0;right:0;font-size:0;padding:2px 4px 4px 2px;height:auto;background:inherit;border-radius:14px 0 0 0;z-index:301}.ws-note.controls-ListView__hoveredItem .ws-note__actions{display:block}.ws-note.controls-ListView__hoveredItem.ws-note_blocked .ws-note__actions,.ws-note.controls-ListView__hoveredItem.ws-note_dragged .ws-note__actions{display:none}.ws-note__actions .controls-IconButton{margin-right:4px}.ws-note__actions .controls-IconButton:last-child{margin-right:0}"));head.appendChild(style);});}
define('js!SBIS3.Notes.NoteActions',['Core/EventBus','SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.NoteActions','SBIS3.CONTROLS/Utils/InformationPopupManager','Core/UserInfo','js!SBIS3.Notes.Note','SBIS3.CONTROLS/Button/IconButton','js!SBIS3.Notes.TagButton','js!SBIS3.Notes.Pin','css!SBIS3.Notes.NoteActions','Zametki_localization'],function(t,o,i,e,n,s){'use strict';var h=o.extend({_dotTplFn:i,$protected:{_options:{allowPinToAnyPage:true,showPin:true,showShare:false,isAuthor:false,staticMode:false,isHidden:false,note:null,noteRecord:null}},_modifyOptions:function(t){if(t.showHideIcon=!t.showShare,t.showActions=!t.showShare||t.isAuthor,t.staticMode)t.showHideIcon=t.isHidden=false;return t.showPin='__сбис__биллинг'!==n.get('ЛогинКлиента')&&t.showPin,t;},init:function(){if(h.superclass.init.call(this),!this._options.showActions)return;var o=this._options.note;if(this._options.noteRecord&&!o)o=this._options.note=new s(this._options.staticMode?this._options.noteRecord:this._options.noteRecord.getRawData(),this._options.staticMode);if(this.getChildControlByName('TagButton')._options.note=o,this.subscribeTo(this.getChildControlByName('Remove'),'onActivated',this._onRemoveButtonActivated.bind(this)),this.subscribeTo(this.getChildControlByName('ShowNote'),'onActivated',this._onShowButtonActivated.bind(this)),this.subscribeTo(this.getChildControlByName('HideNote'),'onActivated',this._onHideButtonActivated.bind(this)),o&&this._options.showPin&&this.hasChildControlByName('Pin')){var i=this.getChildControlByName('Pin');i.setStatus(o.getPin()),this.subscribeTo(i,'onPropertyChanged',function(e,n){if('status'===n)t.channel('NoteCommands').notify('Pin',o,i.getProperty('status'));}),this.subscribeTo(i,'onActivated',function(){this.getChildControlByName('TagButton').closeForm();}.bind(this)),this.subscribeTo(this.getChildControlByName('TagButton'),'onActivated',function(){i.hidePicker();});}},_onHideButtonActivated:function(){this._options.noteRecord.set(this._options.staticMode?'IsHidden':'isHidden',true),t.channel('NoteCommands').notify('SetNoteVisible',this._options.noteRecord,false);},_onShowButtonActivated:function(){this._options.noteRecord.set(this._options.staticMode?'IsHidden':'isHidden',false),t.channel('NoteCommands').notify('SetNoteVisible',this._options.noteRecord,true);},_onRemoveButtonActivated:function(){var o=this._options.note;e.showConfirmDialog({message:rk('Удалить заметку?')},function(){t.channel('NoteCommands').notify('Remove',o);});}});return h;});
define("html!SBIS3.Notes.UploadButton",function(){var o=function(o){var n=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,"&#123;&#123;$1&#125;&#125;");return n}}(),t=function(o){return o.join?o.join(""):o.toString()},e=function(o){return void 0===o?"":o&&"object"==typeof o?t(o):""+o},i="undefined"!=typeof process,a=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,'<div style="display: inline-block;"> <component data-component="SBIS3.DOCVIEW.AttachTo" name="attachToBtn"> <option name="content"> <component data-component="SBIS3.CONTROLS/Menu/MenuIcon"> <option name="icon">sprite:icon-16 icon-primary icon-Attach</option> <option name="className">controls-IconButton__round-border</option> <option name="pickerClassName">docview-attachTo</option> <option name="tooltip">'+n(e(rk("Прикрепить@@Загрузить файл")))+'</option> <option name="caption">'+n(e(rk("Прикрепить@@Загрузить файл")))+'</option> <option name="enable">true</option> <option name="allowChangeEnable">true</option> </component> </option> <option name="hasLink">false</option> <option name="hasScan">false</option> <option name="useStorageMode">true</option> <option name="caption">'+n(e(rk("Прикрепить@@Загрузить файл")))+'</option> <option name="destinationDir">notes</option> <option name="allowDragNDrop">false</option> <options name="mainOptions"> <option name="isDisk">true</option> <option name="objectName">FileSD</option> <option name="serviceUrl">/disk/api/v1/</option> </options> </component> </div>');return(a=n(a))+(i&&-1!==a.indexOf("{{")?String.fromCharCode(8203,8203):"")};return o.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.UploadButton"}},o});
define('js!SBIS3.Notes.UploadButton',['WS.Data/Source/SbisService','WS.Data/Entity/Record','Core/UserInfo','SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.UploadButton','js!SBIS3.DOCVIEW.AttachTo','Zametki_localization'],function(e,t,o,n,a){'use strict';var i=n.extend({_dotTplFn:a,$protected:{},$constructor:function(){this._publish('onFileUpload');},init:function(){i.superclass.init.call(this);var n=this;this.getContainer().on('mousedown focus',false);var a=this.getChildControlByName('attachToBtn');if(o.get('ИдентификаторПользователя')===o.get('ИдентификаторКлиента'))return a.setEnabled(false),void a.setTooltip(rk('Загрузка файлов недоступна из-за ограничений учётной записи'));this.subscribeTo(a,'onSaveFiles',function(o,a){var i=new t({adapter:'adapter.sbis',format:[{name:'ReadVersions',type:'integer'}]});i.set('ReadVersions',1),a.forEach(function(t){if(t.size)new e({endpoint:{address:'/disk/api/v1/service/',contract:'FileSD'}}).call('Read',{Id:t.storageResponse.fileId,ExtraParams:i}).addCallback(function(e){n._notify('onFileUpload',e.getRow());});else require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(e){e.showNotification({caption:rk('Размер следующего файла нулевой')+': '+t.name,status:'error'});});});}),a._onFinish=function(o,a,i,s){var r=s?s.originalResult:null,d=new t({adapter:'adapter.sbis',format:[{name:'ReadVersions',type:'integer'}]});if(d.set('ReadVersions',1),'object'==typeof o)o=o.result;new e({endpoint:{address:'/disk/api/v1/service/',contract:'FileSD'}}).call('Read',{Id:r?r.id:o,ExtraParams:d}).addCallback(function(e){n._notify('onFileUpload',e.getRow());});};}});return i;});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.MenuColor", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-note-tag-color__menu-icon{width:24px;height:24px}"));head.appendChild(style);});}
define('js!SBIS3.Notes.MenuColor',['SBIS3.CONTROLS/Menu/MenuIcon','css!SBIS3.Notes.MenuColor','Zametki_localization'],function(o){'use strict';var t=o.extend({$protected:{_options:{className:'ws-note-tag-color__menu-icon',icon:'sprite:icon-16 icon-primary ws-note-tag-color ws-note-tag-color_color-0',color:0,colors:['#fff','#f00','#FEC63F','#72BE44','#587AB0']}},$constructor:function(){this._publish('onSelectColor');},init:function(){t.superclass.init.call(this),this.subscribeTo(this,'onActivated',this._onColorMenuActivate.bind(this));},destroy:function(){t.superclass.destroy.call(this);},getColor:function(){return this._options.color;},setColor:function(o){this._options.color=o,this.setIcon('sprite:icon-16 icon-primary ws-note-tag-color ws-note-tag-color_color-'+o);},_onColorMenuActivate:function(o){var t=this;require(['SBIS3.CONTROLS/StylesPanelNew'],function(e){if(!t._stylePanel)t._stylePanel=new e({parent:o.getTarget(),target:o.getTarget().getContainer(),corner:'tl',element:$('<div></div>'),name:'StylesPanelNew',activableByClick:false,paletteRenderStyle:true,columnsCount:1,autoCloseOnHide:true,verticalAlign:{side:'top',offset:-12},horizontalAlign:{side:'left',offset:-8},colors:t._options.colors.map(function(o){return{color:o};}),style:{color:t._options.colors[t._options.color]},handlers:{changeFormat:function(o,e){var n=t._options.colors.indexOf(this.getJSONStyle().color);if(n<0)n=0;t._options.color=n,t.setIcon('sprite:icon-16 icon-primary ws-note-tag-color ws-note-tag-color_color-'+n),t._notify('onColorSelected',n);},onClose:function(){},onDestroy:function(){}}});else t._stylePanel.setStylesFromObject({color:t._options.colors[t._options.color]});t._stylePanel.show();});}});return t;});
define("html!SBIS3.Notes.NoteEditor",function(){var o=function(o){var n=function(){var o={"&":"&#38;","<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","/":"&#47;"},n=/&(?!#?\w+;)|<|>|"|'|\//g;return function(t){return t?t.toString().replace(n,function(n){return o[n]||n}):t}}(),t=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,"&#123;&#123;$1&#125;&#125;");return n}}(),i=function(o){return o.join?o.join(""):o.toString()},e=function(o){return void 0===o?"":o&&"object"==typeof o?i(o):""+o},a="undefined"!=typeof process,p=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,'<div class="ws-noteDialog"> <div class="ws-window-titlebar-custom"> <div class="ws-note-dialog__panel ws-note-dialog__panel_short"> <component data-component="SBIS3.CONTROLS/RichEditor/Components/RoundToolbar" name="roundToolbar"> <option name="isWindowToolbar">true</option> <options name="items" type="array"> <options> <option name="name">smile</option> <option name="visible">false</option> </options> <options> <option name="name">history</option> <option name="order">101</option> <option name="visible">false</option> </options> <options> <option name="id">check</option> <option name="name">Check</option> <option name="componentType">SBIS3.CONTROLS/Button/IconButton</option> <option name="icon">sprite:icon-16 icon-Check3 icon-primary</option> <option name="className">controls-IconButton__round-border</option> <option name="activableByClick">false</option> <option name="tooltip">'+t(e(rk("Вставить отметку")))+'</option> <option name="basic">true</option> <option name="order">1</option> </options> <options> <option name="name">list</option> <option name="visible">true</option> <option name="basic">false</option> <option name="order">2</option> <options name="handlers"> <option name="onMenuItemActivate" type="function"> js!SBIS3.Notes.NoteEditor:prototype._onUnorderedListClick </option> </options> </options> <options> <option name="name">styles</option> <option name="basic">false</option> <option name="order">3</option> </options> <options> <option name="name">image</option> <option name="basic">true</option> <option name="order">4</option> </options> <options> <option name="name">link</option> <option name="basic">false</option> <option name="order">5</option> </options> <options> <option name="id">upload</option> <option name="name">UploadButton</option> <option name="componentType">SBIS3.Notes.UploadButton</option> <option name="isPluginAvailable" type="boolean">'+t(e(o.isPluginAvailable))+'</option> <option name="basic">true</option> <option name="order">6</option> </options> ');return o.showActions&&(p+=' <options> <option name="id">tagButton</option> <option name="name">TagButton</option> <option name="componentType">SBIS3.Notes.TagButton</option> <option name="className">controls-IconButton__round-border ws-note-dialog__panel-button_optional </option> <option name="tabindex">-1</option> <option name="fromDialog">true</option> <option name="activableByClick">false</option> <option name="basic">false</option> <option name="order">7</option> </options> '),p+=" ",o.showNotification&&(p+=' <options> <option name="id">notification</option> <option name="name">Notification</option> <option name="componentType">SBIS3.CONTROLS/Button/IconButton</option> <option name="className">controls-IconButton__round-border ws-note-dialog__panel-button_optional </option> <option name="tooltip">'+t(e(rk("Сервис уведомлений недоступен")))+'</option> <option name="icon">sprite:icon-16 icon-Bell icon-primary</option> <option name="tabindex">-1</option> <option name="enabled">false</option> <option name="activableByClick">false</option> <option name="basic">false</option> <option name="order">9</option> </options> '),p+=' <options> <option name="id">colorize</option> <option name="name">Colorize</option> <option name="componentType">SBIS3.CONTROLS/Button/IconButton</option> <option name="basic">true</option> <option name="icon">sprite:icon-16 icon-Colorize icon-primary</option> <option name="className">controls-IconButton__round-border</option> <option name="tooltip">'+t(e(rk("Задать цвет заметки")))+'</option> <option name="tabindex">-1</option> <option name="activableByClick">false</option> <option name="order">10</option> </options> ',o.showPin&&(p+=' <options> <option name="id">pin</option> <option name="name">Pin</option> <option name="componentType">SBIS3.Notes.Pin</option> <option name="className">controls-IconButton__round-border ws-note-dialog__panel-button_optional </option> <option name="status">'+t(e(o.note.getPin()))+'</option> <option name="pageTitle">'+t(e(o.note.pageTitle||""))+'</option> <option name="allowPinToAnyPage" type="boolean">'+t(e(o.allowPinToAnyPage))+'</option> <option name="activableByClick">false</option> <option name="basic">true</option> <option name="order">11</option> </options> '),p+=" ",o.showActions&&(p+=' <options> <option name="id">remove</option> <option name="name">Remove</option> <option name="componentType">SBIS3.CONTROLS/Button/IconButton</option> <option name="icon">sprite:icon-16 icon-Erase icon-error</option> <option name="className">controls-IconButton__round-border</option> <option name="tooltip">'+t(e(rk("Удалить заметку")))+'</option> <option name="enabled">true</option> <option name="basic">true</option> <option name="order">12</option> </options> '),p+=' <options> <option name="name">toggle</option> <option name="order">100</option> </options> </options> </component> <component data-component="SBIS3.CONTROLS/Button"> <option name="name">okButton</option> <option name="className">ws-note-dialog__ok-button</option> <option name="primary">true</option> <option name="caption">ОК</option> <options name="handlers"> <option name="onActivated" type="function"> js!SBIS3.Notes.NoteEditor:prototype._onSaveButtonActivated </option> </options> <option name="tabindex">-1</option> <option name="activableByClick">false</option> </component> </div> </div> <component data-component="SBIS3.CONTROLS/ScrollContainer" class="scrollContainerEditor" name="scrollContainerEditor" style="min-width:'+t(e(o.minWidth))+"px; min-height:"+t(e(o.minHeight))+"px; max-height:"+t(e(o.maxEditorHeight))+"px;"+t(e(o.fixedHeight))+'"> <option name="content"> <component data-component="SBIS3.CONTROLS/RichEditor/Components/RichTextArea" class="ws-noteDialog-text" name="noteContent" style="min-height:'+t(e(o.minHeight))+'px;"> <option name="autoHeight" value="true"></option> <option name="templates" value="false"></option> <option name="focusOnActivatedOnMobiles">false</option> <option name="maximalHeight">0</option> <option name="minimalHeight">0</option> <option name="className">ws-note__content</option> <option name="toolbarVisible" value="true"></option> <option name="tabindex">1</option> <option name="placeholder">'+t(e(rk("Введите текст заметки")))+'</option> <option name="saveHistory">false</option> <option name="validateClass" type="function"> js!SBIS3.Notes.NoteEditor:prototype._validateClass </option> </component> </option> </component> <component data-component="SBIS3.CONTROLS/ScrollContainer" class="scrollContainerFooter"> <option name="content"> <div class="ws-note-dialog__footer"> <component data-component="SBIS3.Notes.NoteFiles" name="Files"> <option name="allowDelete">true</option> </component> <component data-component="SBIS3.Notes.NoteTags" name="Tags" class="ws-note-tags"> <option name="allowDelete" value="true" type="boolean"></option> </component> <div class="ws-note-dialog__statusbar ws-no-select"> <span class="ws-note-dialog__statusbar-text',o.note.title||(p+=" ws-hidden"),p+='">'+t(e(n(o.note.title)))+'</span> <span class="ws-note-calendar__remove icon-16 icon-Close action-hover ',o.note.title||(p+=" ws-hidden"),p+='" title="'+t(e(rk("Удалить оповещение из заметки")))+'"></span> <span class="ws-note-dialog__date">',0==o.isNewNote&&(p+=t(e(o.note.prettyModified||o.note.prettyCreationDate))),p+='</span> </div> </div> </option> </component> <div class="ws-note-shadow"> <div class="ws-note-shadow__left"></div> <div class="ws-note-shadow__right"></div> </div> </div>',(p=t(p))+(a&&-1!==p.indexOf("{{")?String.fromCharCode(8203,8203):"")};return o.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.NoteEditor"}},o});
define("html!SBIS3.Notes.NoteFiles",function(){var e=function(e){var r=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(r){for(;e.test(r);)r=r.replace(e,"&#123;&#123;$1&#125;&#125;");return r}}(),t="undefined"!=typeof process,n=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,'<div class="ws-note-files"> <div class="ws-note-files__previews"> ');if(e.note&&e.note.files){n+=" ";var o=e.note.files.toArray();if(o)for(var i=-1,s=o.length-1;i<s;)o[i+=1],n+=' <div class="ws-note-files__mock"></div> ';n+=" "}return n+=" </div> </div>",(n=r(n))+(t&&-1!==n.indexOf("{{")?String.fromCharCode(8203,8203):"")};return e.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.NoteFiles"}},e});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.NoteFiles", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-note-files{padding:8px 4px 30px 4px;height:auto;z-index:0}.ws-note-files__mock{width:70px;height:70px;padding:4px;display:inline-block;vertical-align:top;margin:0}"));head.appendChild(style);});}
define('js!SBIS3.Notes.NoteFiles',['Core/core-instance','Core/detection','SBIS3.CONTROLS/CompoundControl','js!SBIS3.Notes.Note','html!SBIS3.Notes.NoteFiles','Core/Deferred','Core/UserInfo','Core/EventBus','Core/Context','WS.Data/Entity/Record','WS.Data/Collection/RecordSet','WS.Data/Source/SbisService','css!SBIS3.Notes.NoteFiles','Zametki_localization'],function(e,t,i,o,s,n,r,a,l,c,f,d){'use strict';var h,u;function p(){if(!u)u=new n(),require(['js!SBIS3.DOCVIEW.List','js!SBIS3.DOCVIEW.linkActivated'],function(e){h=e,u.callback();});return u;}var g=i.extend({_dotTplFn:s,$protected:{_options:{staticMode:false,note:null,noteRecord:null,allowDelete:true,allowEditAttachments:'__сбис__биллинг'!==r.get('ЛогинКлиента')}},createFilesRecordSet:function(e){return new f({idProperty:'attachId',rawData:e.map(function(e){return{attachId:e.attachId,fileName:e.fileName,title:e.title,Size:e.Size,redactionId:e.redactionId,versionForm:e.versionForm,typeDoc:e.typeDoc,subTypeDoc:e.subTypeDoc,subVersionForm:e.subVersionForm,hash:e.hash,canEdit:e.canEdit};})});},$constructor:function(){if(this._publish('onDrawItems','onFilesDraw'),this._options.noteRecord){var t=this._options.noteRecord;if(!this._options.staticMode)if(t=this._options.noteRecord.getRawData(),!e.instanceOfModule(t.files,'WS.Data/Collection/RecordSet'))t.files=this.createFilesRecordSet(t.files);this._options.note=new o(t,this._options.staticMode);}this._updateVisibility();},init:function(){if(g.superclass.init.call(this),this._options.note){for(var e=this._options.note.files.getCount()+1,t=new Array(e),i=0;i<e;i++)t[i]='';this.getContainer().find('.ws-note-files__previews').html(t.join('<div class="ws-note-files__mock"></div>'));}},_updateVisibility:function(){this.toggle(this._hasFiles());},reload:function(){if(this._updateVisibility(),this.hasChildControlByName('previews'))this.getChildControlByName('previews').reload();else if(h)this._renderFiles();else if(this._hasFiles()){var e=this;p().addCallback(function(){e._renderFiles();});}},_hasFiles:function(){return!!(this._options.note&&this._options.note.files&&this._options.note.files.getCount());},_renderFiles:function(){if(!this._hasFiles())return;var i=this,o=l.createContext(this,null,this.getLinkedContext()),s=this.getContainer().find('.ws-note-files__previews'),n=s.height();if(s.css('min-height',n),this._options.noteRecord&&!this._options.noteRecord.get('files'))this._options.noteRecord.set('files',this._options.note.files);if(this._options.noteRecord&&!e.instanceOfModule(this._options.noteRecord.get('files'),'WS.Data/Collection/RecordSet'))return;if(o.setValue('files',this._options.noteRecord?this._options.noteRecord.get('files'):this._options.note.files),!this.hasChildControlByName('previews')){var c=new h({name:'previews',element:s,parent:this,opener:this,context:o,listOptions:{visibilityMode:{defaultMode:'bigPreview'},previewWidth:70,previewHeight:70,infiniteScroll:false,calcMargin:false,hasHierarchy:false,itemsDragNDrop:false,multiselect:false,hideBreadCrumbs:true},mainOptions:{objectName:'FileSD',serviceUrl:'/disk/api/v1/',useOnlyCtx:true,ctxLinkList:'files',commands:{deleteDoc:this._options.allowDelete,directLink:false,addPage:false,edit:this._options.allowEditAttachments,editInApp:this._options.allowEditAttachments,encrypt:false,fullScreen:false,print:!t.isMobilePlatform,saveToPdf:false,upload:true,zoomMinus:true,zoomPlus:true,crop:false,rotateLeft:false,rotateRight:false,rename:false,saveChanges:true,signs:false,signDocument:'__сбис__биллинг'===r.get('ЛогинКлиента')?false:true,redactions:false,closeFullScreen:true,closeAttach:false,linkActivated:false,rights:false,sendMessage:false,directLinkDisk:false,toCommonDocs:false,toMyDocs:false,copyToDisk:false,restore:false,findInMyDocs:false,findInCommonDocs:false,deletePermanentlyDoc:false,move:false,responsible:false,toSbisDisk:false,links:true,imageEdit:true}}});if(this.subscribeTo(c,'onDrawItems',function(){i._notify('onFilesDraw'),this.getContainer().css('min-height','auto');}),this._options.allowDelete)this.subscribeTo(c,'onFinishCommand',this._onFinishDelete.bind(this));if(t.isMobilePlatform)c.getTreeView()._checkClickByTap=false,i.subscribeTo(c,'onClick',function(e,t){if(i._options.noteId)a.channel('NotesEvents').notify('onNoteOpen',t,i._options.noteId);});this.registerChildControl(c);}},_onFinishDelete:function(e,t,i){if('deleteDoc'===t){var o=i.records[0].getId();if(this._options.noteRecord)this._options.note.files=this._options.noteRecord.get('files');if(this._options.note.removeFile(o),this._options.noteRecord){var s=this._options.noteRecord.get('files'),n=s.getRecordById(o),r=n?s.getIndex(n):-1;if(r>=0){var l=s;s.removeAt(r),s=l;}}this._updateVisibility(),this._notify('onReload'),a.channel('NotesEvents').notify('onFileRemoved',this._options.note);}}});function _(t){var i=t.getNotes(t._isStatic);if(!i)return{};if(e.instanceOfModule(i,'WS.Data/Collection/RecordSet')){var s=[];return i.each(function(e){var t=new o(e);if(t.files)t.files.forEach(function(i){s[i.getId()]={file:i,note:t,noteModel:e};});}),s;}else return i.reduce(function(e,t){if(t.files)if(t.files.each)t.files.each(function(i){e[i.getId()]={file:i,note:t};});else t.files.forEach(function(i){e[i.attachId]={file:i,note:t};});return e;},{});}function m(e){var t=new c({adapter:'adapter.sbis',format:[{name:'ReadVersions',type:'integer'}]});return t.set('ReadVersions',3),new d({endpoint:{address:'/disk/api/v1/service/',contract:'FileSD'}}).call('ReadFiles',{Ids:e,ExtraParams:t}).addCallback(function(e){return e.getAll();});}function v(e,t){t.each(function(t){var i=t.getId(),o=e[i];if(t.get('ErrorMsg')||t.get('Deleted'))return void o.note.removeFile(i);var s=o.file,n=t.get('Version').at(0),r=n.get('FormalizedFile'),a={fileName:t.get('FileName'),title:t.get('Name')||t.get('FileName'),Size:t.get('Size'),redactionId:n.get('Id'),encrypted:n.get('EncryptionType'),canEdit:t.get('canEdit'),hash:n.get('hash')};if(r)a.versionForm=r.get('FEDVersion'),a.subVersionForm=r.get('FEDSubversion'),a.typeDoc=r.get('FEDType'),a.subTypeDoc=r.get('FEDSubtype');var l=o.note.files;if(s.set(a),o.note.files=l,o.noteModel){var c=o.noteModel.get('files').getRecordById(s.get('attachId'));if(c)c.set(a);}var f=o.note.settingsFiles.filter(function(e){return e.id==i;});if(f&&f.length&&f[0].name!==a.title&&f[0].name!==a.fileName)o.note.update();});}var D;function C(t){var i=D=new Date().getTime(),o=_(t),s=Object.keys(o);function n(){return i!==D;}if(0===s.length)return;p(),m(s).addCallback(function(i){if(n())return;v(o,i),p().addCallback(function(){if(n())return;(t.getChildControls()||[]).forEach(function(t){if(e.instanceOfModule(t,'SBIS3.Notes.NoteFiles'))t._renderFiles();});});});}return g.loadFilePreviews=C,g;});
define('js!SBIS3.Notes.NoteTags',['Core/helpers/String/escapeHtml','SBIS3.CONTROLS/CompoundControl','SBIS3.CONTROLS/Utils/InformationPopupManager','Zametki_localization'],function(t,e,i){'use strict';function o(t){var e=$(t).closest('.ws-note__tag');return e.closest('.ws-note-tags').find('.ws-note__tag').index(e);}var s=8,n=21,a=e.extend({$protected:{_options:{note:null,allowDelete:false},_compiledTemplate:null},$constructor:function(){this._publish('onActionCompleted');},_updateVisibility:function(){this.toggle(this._hasTags());},_hasTags:function(){return this._options.note.tags.length>0;},init:function(){a.superclass.init.call(this);var t=this.getContainer();if(this._options.allowDelete)t.on('click.note-tags','.ws-note-tags__remove',this._onRemoveClick.bind(this));},destroy:function(){a.superclass.destroy.call(this),this.getContainer().off('.note-tags');},reload:function(){var t=this._getTemplate()(this._options.note.tags||[]),e=this.getContainer();if(e.html(t),this._updateVisibility(),!this._options.allowDelete)this._resizeTags(e);},_getTemplate:function(){if(!this._compiledTemplate)this._compiledTemplate=doT.compile('{{? it.length}}'+'{{~it :tag}}'+'<span class="ws-note__tag ws-note__tag_color-{{=tag.color}}">'+'{{!tag.name}}'+(this._options.allowDelete?'<span class="ws-note-tags__remove icon-16 icon-Close action-hover" title="'+rk('Удалить тег из заметки')+'"></span>':'')+'</span>'+'{{~}}'+'{{?}}');return this._compiledTemplate;},_onRemoveClick:function(e){var s=o(e.target),n=this._options.note,a=n.tags[s],l=a&&a.name,r=this;if(e.stopPropagation(),l)i.showConfirmDialog({message:rk('Удалить тег','часть фразы')+' "'+t(l)+'" '+rk('из заметки?'),parent:this,opener:this},function(){n.removeTag(l),r.reload(),r._notify('onActionCompleted');},function(){r._notify('onActionCompleted');});},_resizeTags:function(t){var e=t.find('.ws-note-tags__ellipsis'),i={},o=[],a;if(!t.find('.ws-note__tag').length)return void e.addClass('ws-hidden');if(e.addClass('ws-hidden'),t.find('.ws-note__tag').each(function(){if($(this).removeAttr('style'),a=$(this).position().top,-1===o.indexOf(a))if(o.push(a),o.length>2)return;if(!i.hasOwnProperty(a))i[a]=[];i[a].push($(this));}),o.length>2){var l=i[o[1]].length,r=i[o[1]][l-1],h=t.find('.ws-note-tags-html').width(),d=r.position().left-s+r.outerWidth(true);if(1===l&&h-d<n){var p=r.width()-n;return r.width(p),r.after(e),void e.removeClass('ws-hidden');}if(h-d<n)r.before(e);else r.after(e);e.removeClass('ws-hidden');}else e.addClass('ws-hidden');}});return a;});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.NoteEditor", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-noteDialog{overflow:visible;box-sizing:border-box;padding-bottom:32px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.ws-noteDialog-container{overflow:visible!important;border:none;-webkit-box-shadow:0 0 5px 0 rgba(70,70,70,.65);-moz-box-shadow:0 0 5px 0 rgba(70,70,70,.65);box-shadow:0 0 5px 0 rgba(70,70,70,.65)}.ws-noteDialog-container .ws-float-close-right{background:0 0}.ws-noteDialog-container .ws-window-content{overflow:visible!important}.ws-noteDialog .controls-RichEditor__editorFrame.ws-basic-style.mce-content-body{-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text;overflow-x:hidden;overflow-y:hidden}.ws-noteDialog-text .ws-basic-style ol{padding-left:27px}.ws-noteDialog-text .ws-basic-style ol,.ws-noteDialog-text .ws-basic-style ul{padding:0 8px 0 27px}.ws-noteDialog-container .ws-window-content,.ws-noteDialog-container .ws-window-titlebar{background-color:transparent}.ws-note-dialog__panel{padding:6px 0 0 6px}.controls-ScrollContainer.scrollContainerFooter{position:absolute;bottom:0;left:0;right:0}.ws-note-dialog__statusbar{height:24px;cursor:default;padding:8px 8px 0 8px;color:#999;font-size:0;display:flex}.ws-note-dialog__statusbar-text:before{content:\"\\e69b\";font-family:cbuc-icons;font-size:16px;margin-right:4px;vertical-align:text-top}.ws-note-dialog__date{float:right;font-size:12px;position:absolute;right:10px}.ws-noteDialog span[data-mce-type=bookmark]{display:inline;width:0;height:0;font-size:0}.ws-note__disable_selection{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.ws-note-dialog__ok-button{position:absolute!important;top:8px;right:44px;width:58px}.ws-note-overlay_unselectable{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.ws-noteDialog-container_transparent{opacity:0}.ws-noteDialog .ws-note-tags{display:block;height:auto;margin-top:8px}.ws-noteDialog-container .ws-note-shadow{width:100%;bottom:-6px}.ws-noteDialog .ws-note-files{overflow:hidden;padding:11px 12px 28px;border-top:1px dashed rgba(0,0,0,.1);-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;min-height:118px;box-sizing:border-box}.ws-noteDialog .ws-note-calendar__remove{cursor:pointer;display:inline-block;margin-right:auto;vertical-align:bottom;padding-block-start:1px}.ws-note-dialog__statusbar-text{font-size:12px}.ws-note-dialog__panel .icon-Picture,.ws-note-dialog__panel .icon-Picture:before{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.ws-noteDialog .controls-RichEditor{background:0 0;margin-left:4px}.ws-noteDialog-text.controls-RichEditor .controls-RichEditor__editorFrame{border:0}.ws-note-files__previews .controls-ListView:not(.controls-ListView__dataLoaded){min-height:78px}.ws-is-firefox .ws-note-dialog__footer .ws-note-files.ws-hidden~.ws-note-dialog__statusbar .ws-note-dialog__date,.ws-is-firefox .ws-note-dialog__footer .ws-note-tags.ws-hidden~.ws-note-dialog__statusbar .ws-note-dialog__date{margin-right:17px}.ws-is-firefox .ws-note-dialog__footer .ws-note-files:not(.ws-hidden)~.ws-note-dialog__statusbar .ws-note-dialog__date,.ws-is-firefox .ws-note-dialog__footer .ws-note-tags:not(.ws-hidden)~.ws-note-dialog__statusbar .ws-note-dialog__date{margin-right:0!important}body.ws-body-no-scroll.ws-note-openedDialog{overflow:hidden}.ws-noteDialog-container .ws-window-titlebar-action.maximize{display:none}.ws-is-ie .ws-note__content.ws-noteDialog-text .controls-RichEditor__editorFrame>p{margin-bottom:0;padding-bottom:6px}.ws-noteDialog .ws-noteDialog-text .ws-note__checkable img{pointer-events:auto}"));head.appendChild(style);});}
define('js!SBIS3.Notes.NoteEditor',['Core/helpers/fast-control-helpers','Core/helpers/Array/findIndex','Core/helpers/Function/debounce','Core/EventBus','Core/constants','SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.NoteEditor','js!SBIS3.BL.Note','Lib/ServerEvent/Bus','Core/UserInfo','Core/Sanitize','js!SBIS3.DOCVIEW.AttachTo','js!SBIS3.Notes.NoteFiles','js!SBIS3.Notes.NoteTags','js!SBIS3.Notes.UploadButton','js!SBIS3.Notes.TagButton','optional!js!SBIS3.Notes.Pin','SBIS3.CONTROLS/RichEditor/Components/RichTextArea','SBIS3.CONTROLS/RichEditor/Components/RoundToolbar','SBIS3.CONTROLS/Button','SBIS3.CONTROLS/Button/IconButton','SBIS3.CONTROLS/Menu/MenuIcon','SBIS3.CONTROLS/ScrollContainer','css!SBIS3.Notes.NoteEditor','i18n!SBIS3.Notes.NoteEditor','Zametki_localization'],function(t,e,o,i,n,s,a,r,l,c,d){'use strict';var h=17,_=40,u=['rgb(255, 253, 157)','rgb(223, 252, 173)','rgb(255, 213, 185)','rgb(236, 214, 236)','rgb(201, 238, 255)'];function f(t){t.getContainer().find('.ws-note__checkable').each(function(t,e){var o=$(e);if(0===o.height())o.append('<br data-mce-bogus="1">');});}function m(t){return t=t||'',d(t.replace(/min-height:\s*\d+(\.\d+)?px;/gi,'data-$&'));}function g(t,e){t.getSelectedBlocks().forEach(e);}function C(t){var e=true;return g(t,function(t){if(e)e='UL'===t.tagName||'OL'===t.tagName||'LI'===t.tagName;}),e;}function b(t){var e=true;return g(t,function(t){if('UL'!==t.tagName&&'OL'!==t.tagName&&!$(t).hasClass('ws-note__checkable'))return e=false;}),e;}function w(t){var e=null,o=null;if(g(t,function(t){if(!e)if('OL'===t.tagName||'UL'===t.tagName)e=t.tagName;else if(!o&&t.parentNode&&('OL'===t.parentNode.tagName||'UL'===t.parentNode.tagName))o=t.parentNode.tagName;}),!e)if(t.parentNode)return w(t.parentNode);else return o;else return e;}function p(t){g(t,function(t){var e=$(t),o=e.html();if('<br data-mce-bogus="1">'===o||' '===o||''===o||'&nbsp;'===o)e.remove();}),t.select();}function v(t){var e=t.getRng(),o=t.getStart()===t.getEnd(),i=e.startContainer===e.endContainer;if($(e.startContainer).hasClass('mce-content-body'))return o;else return o||i;}function N(t){var e=$(t);if(e.hasClass('ws-note__checkable')||e.hasClass('ws-note__checkable_checked')||e.hasClass('ws-note__checkable_unchecked'))return $(t).removeClass('ws-note__checkable ws-note__checkable_checked ws-note__checkable_unchecked'),true;else return false;}function y(){var t=390,e=600,o=70,i=n.$win.height();if(n.browser.isMobilePlatform)return i<n.$win.width()?t:e;else return i-o;}var k=s.extend({_dotTplFn:a,$protected:{_options:{note:null,noteRecord:null,isNewNote:false,noteElement:null,isPluginAvailable:false,allowPinToAnyPage:false,resizeSymmetrically:false,maxEditorHeight:y(),minWidth:494,minHeight:n.browser.isMobilePlatform?150:200,fixedHeight:n.browser.isMobilePlatform?'height: 200px':'',isLocked:false},_eventNamespace:'.note-editor',_dom:null,_controls:null,_notificationForm:null,_isPanelCollapsed:true,_bookMark:null,_domChanged:0,_lastHeight:0},$constructor:function(){this._publish('onTagChanged');},_modifyOptions:function(t){return t.showActions=!t.note.pinnedToPanel||t.note.isAuthor,t.showNotification=t.showActions,t.showPin='__сбис__биллинг'!==c.get('ЛогинКлиента')&&t.showActions,t;},init:function(){k.superclass.init.call(this);var t=this,e=this.getContainer(),s=this._options.note,a=this.getChildControlByName('okButton'),r=this.getChildControlByName('noteContent'),l=this.getChildControlByName('roundToolbar'),c=this.getChildControlByName('scrollContainerEditor');this._dom={mainDlg:$('div[templatename="js!SBIS3.Notes.NoteEditor"]'),window:e.closest('.ws-window'),titlebar:e.find('.ws-window-titlebar-custom'),footer:e.find('.ws-note-dialog__footer'),footerText:e.find('.ws-note-dialog__statusbar-text'),footerFiles:e.find('.ws-note-dialog__footer .ws-note-files'),footerTags:e.find('.ws-note-dialog__footer .ws-note-tags'),calendarRemove:e.find('.ws-note-calendar__remove'),editorFrame:r.getContainer().find('.controls-RichEditor__editorFrame'),scroll:e.find('.controls-ScrollContainer.scrollContainerEditor'),scrollFooter:e.find('.controls-ScrollContainer.scrollContainerFooter'),scrollContent:e.find('.controls-ScrollContainer.scrollContainerEditor .controls-ScrollContainer__content')};var d=l.getItemInstance('list'),_=l.getItemInstance('styles'),u=_?l.getStylesPanel(_):null,m=l.getChildControlByName('UploadButton'),g=l.getChildControlByName('Check'),C=l.getChildControlByName('Colorize');if(this.subscribeTo(d,'onActivated',function(){if(!t._controls.list)t._controls.list=this._picker;t._closeFloatAreas('UnorderedList');}),this._dom.calendarRemove.on('click',this._onRemoveCalendar.bind(this)),this._controls={content:r,toolbar:l,styles:u,upload:m,check:g,colorize:C,ok:a},l.setLinkedEditor(r),this.subscribeTo(this._controls.upload,'onMenuActivated',this._onUploadActivated.bind(this)),this.subscribeTo(this._controls.check,'onActivated',this._onCheckClick.bind(this)),this.subscribeTo(this._controls.colorize,'onActivated',this._onColorMenuActivate.bind(this)),this.subscribeTo(this,'onBeforeShow',this._onBeforeShow),this.subscribeTo(this,'onAfterShow',this._onAfterShow),this.subscribeTo(this,'onReady',this._onReady.bind(this)),this.subscribeTo(this,'onResize',n.browser.isMobilePlatform?t._onEditorResize:o(t._onEditorResize,100)),this._options.showPin)this._controls.pin=l.getChildControlByName('Pin'),this.subscribeTo(this._controls.pin,'onPropertyChanged',this._onPinPropertyChanged.bind(this)),this.subscribeTo(this._controls.pin,'onActivated',this._onPinActivated.bind(this));if(this._options.showNotification)this._controls.notification=l.getChildControlByName('Notification'),this.subscribeTo(this._controls.notification,'onActivated',this._onNotificationActivated.bind(this));if(this._options.showActions)this._controls.remove=l.getChildControlByName('Remove'),this.subscribeTo(this._controls.remove,'onActivated',this._onRemoveButtonActivated.bind(this));var b=this._controls.files=this.getChildControlByName('Files');b._options.note=s,b._options.noteRecord=this._options.noteRecord,b.reload(),this.subscribeTo(b,'onReload',function(){t._domChanged=new Date().getTime(),t._adjustEditorBottomPadding();}),this.subscribeTo(b,'onFilesDraw',function(){t._domChanged=new Date().getTime(),t._adjustEditorBottomPadding();});var w=this._controls.tags=this.getChildControlByName('Tags');w._options.note=s,w.reload(),this.subscribeTo(w,'onActionCompleted',function(){t._adjustEditorBottomPadding(),t._focusOnEditor();}),f(r),this.subscribeTo(r,'onTextChange',this._onTextChange.bind(this)),this.subscribeTo(r,'onDestroy',function(){this.getContainer().off(t._eventNamespace);}),this._dom.window.addClass('ws-noteDialog-container'),this.changeColor(s.color),this.subscribeTo(this.getChildControlByName('UploadButton'),'onFileUpload',this._onFileUpload.bind(this));var p=n.browser.isMobilePlatform?'touchstart'+this._eventNamespace+' touchend'+this._eventNamespace:'mousedown'+this._eventNamespace+' mouseup'+this._eventNamespace;r.getContainer().on('touchstart'+this._eventNamespace+' touchend'+this._eventNamespace,function(){t._closeFloatAreas();}),r.getContainer().on('DOMNodeInserted'+this._eventNamespace,function(e){if(t._domChanged=new Date().getTime(),e.target&&'LI'==e.target.nodeName&&$(e.target).hasClass('ws-note__checkable_checked')&&'<br data-mce-bogus="1">'==e.target.innerHTML)$(e.target).removeClass('ws-note__checkable_checked').addClass('ws-note__checkable_unchecked');}),r.getContainer().on('DOMNodeRemoved'+this._eventNamespace,function(e){t._domChanged=new Date().getTime();}),r.getContainer().on(p,'.ws-note__checkable',function(e){var o,i,n,s,a=$(e.target);if('touchend'===e.type||'touchstart'===e.type){if(o=e.originalEvent.touches[0],o)i=a.offset(),n=o.pageX-i.left,s=o.pageY-i.top;}else n=e.offsetX,s=e.offsetY;if(e.target===e.currentTarget&&n<=h){if(e.preventDefault(),'mouseup'===e.type||'touchend'===e.type||'touchstart'===e.type)a.toggleClass('ws-note__checkable_checked').toggleClass('ws-note__checkable_unchecked'),tinyMCE.activeEditor.selection.moveToBookmark(t._bookMark);else t._bookMark=tinyMCE.activeEditor.selection.getBookmark(2,true);t._triggerInputChange(),tinyMCE.activeEditor.selection.moveToBookmark(t._bookMark);}}),this.disableSelection('.ws-window-titlebar-custom, .ws-window-titlebar-custom *,.ws-window-overlay,.ws-note-date-html,.ws-note-dialog-shadow,.ws-note-dialog__footer'),n.$win.on('beforeunload'+this._eventNamespace,this._onBeforeUnload.bind(this)),n.$win.on('unload'+this._eventNamespace,this._onUnload.bind(this)),this._checkNotificationServiceAvailability();var v=i.channel('NotesEvents'),N=function(){w.reload(),t._adjustEditorBottomPadding(),t._notifyOnSizeChanged();};if(this.subscribeTo(v,'onUnorderedListClick',this.onUnorderedListClick.bind(this)),this.subscribeTo(v,'onTagAdded',N),this.subscribeTo(v,'onTagUpdated',N),this.subscribeTo(v,'onTagRemoved',N),this.subscribeTo(v,'onTagFormActivated',function(){t._closeFloatAreas('TagButton');}),this.subscribeTo(v,'onTagFormClosed',function(){setTimeout(function(){t._focusOnEditor();},100);}),this.hasChildControlByName('TagButton'))this.getChildControlByName('TagButton')._options.note=s;this._dom.window.on('touchstart'+this._eventNamespace,function(){t._closeFloatAreas();}),this._dom.titlebar.on('focus',false),this._dom.footer.on('mousedown focus',false),this._dom.footerText.on('mousedown focus',false),this._dom.titlebar.on('mousedown'+this._eventNamespace+' touchstart'+this._eventNamespace,function(){t._isBeingDragged=true;}),this._dom.titlebar.on('mouseup'+this._eventNamespace+' touchend'+this._eventNamespace,function(){t._isBeingDragged=false;});},_onEditorResize:function(){if(this._colorPanelIsOpened||this._isBeingDragged||!this._dom)return;if(this._doNotResize)return void this._adjustEditorBottomPadding();if(this._handleResize){if(!this._wasManualResizing){this._dom.scroll.css('height','');var t=this._lastHeight!==this._dom.window.height(),e=new Date().getTime()-this._domChanged<400;if(t&&!e)this._wasManualResizing=true,this._dom.scrollContent.find('.ws-noteDialog-text').css('min-height','');}this._adjustEditorBottomPadding();}else{if(n.browser.isMobilePlatform)this._dom.scrollContent.css({height:'100%'}),this._doNotResize=true;else this._dom.scroll.css({height:'auto'});i.channel('NotesEvents').notify('onEditorResize',{width:this._dom.window.width(),height:'auto'});}},_onUploadActivated:function(){this._closeFloatAreas('UploadButton');},_onPinActivated:function(){this._closeFloatAreas('Pin');},_onPinPropertyChanged:function(t,e){if('status'===e)i.channel('NoteCommands').notify('Pin',this._options.note,this._controls.pin.getProperty('status'));},_initEditorData:function(){var t=this;if(this._controls.content.setText(m(this._options.note.text)),!this._dom.editorFrame.length)this._dom.editorFrame=this._controls.content.getContainer().find('.controls-RichEditor__editorFrame');setTimeout(function(){this._tinymce=this._controls.content.getTinyEditor(),this._options.note.undecoratedContent=this._tinymce.getContent(),this._tinymce.on('keydown',function(e){if(e.keyCode===n.key.backspace||e.keyCode===n.key.del){var o=t._tinymce.selection.getRng().startContainer;if(null!=o&&'LI'===o.tagName&&(''===o.innerHTML||'<br>'===o.innerHTML||'<br data-mce-bogus="1">'===o.innerHTML)){var i=o.nextElementSibling;if(i){if($(i).hasClass('ws-note__checkable_unchecked'))$(o).addClass('ws-note__checkable_unchecked').removeClass('ws-note__checkable_checked');if($(i).hasClass('ws-note__checkable_checked'))$(o).addClass('ws-note__checkable_checked').removeClass('ws-note__checkable_unchecked');}}}},true);}.bind(this),200);},destroy:function(){if(k.superclass.destroy.call(this),n.$win.off(this._eventNamespace),$('.ws-window-overlay').off('mouseover'),$('.ws-note-overlay_unselectable').siblings().off('selectstart'),this._controls.content.getContainer().off(this._eventNamespace),this._options.note=null,this._dom.titlebar.off(this._eventNamespace),this._dom.window.off(this._eventNamespace),this._uploader)this._uploader.destroy(),this._uploader=null;this._options=this._tinymce=this._dom=this._controls=null,this.getContainer().off(this._eventNamespace),this.enableSelection('.ws-window-titlebar-custom, .ws-window-titlebar-custom *,.ws-window-overlay,.ws-note-date-html,.ws-note-dialog-shadow,.ws-note-dialog__footer');},_onRemoveCalendar:function(){this.updateNotification(null);},_onReady:function(){var t=this;this._dom.editorFrame.attr({autocorrect:'off',autocapitalize:'off',autocomplete:'off'}),this._focusOnEditor(),this.getChildControls().forEach(function(e){t.subscribeTo(e,'onActivated',function(){t.disableSelection('.controls-Menu,.controls-Menu *');});});},_onBeforeShow:function(){if(this._dom.window.addClass('ws-noteDialog-container_transparent'),this._options.noteElement)this._options.noteElement.removeClass('ws-note_blocked');var t=this.getContainer();this._dom.window.append(t.find('.ws-note-shadow'));},_onAfterShow:function(){var t=this;$('body').addClass('ws-note-openedDialog'),$('.ws-window-overlay').addClass('ws-note-overlay_unselectable').on('mouseover',function(t){t.stopPropagation();}),$('.ws-note-overlay_unselectable').siblings(':not(.engine-ClipboardNative-copy)').addClass('ws-note__disable_selection').find().attr('unselectable','on').on('selectstart',false),this._initEditorData(),this._adjustEditorBottomPadding(),i.channel('NotesEvents').notify('onEditorResize',{width:this._dom.window.width(),height:'auto'});var e=this._options.noteElement;if(e)e.addClass('ws-note_animated').css('z-index',999),e.css({transition:'all 0.5s',opacity:0});if(this.getChildControlByName('noteContent').setActive(true),n.browser.isMobilePlatform)this._controls.ok.setActive(true);setTimeout(function(){if(t._handleResize=true,n.browser.isMobilePlatform)t._dom.scroll.css('height',t._dom.scroll.height()),t._wasManualResizing=true;},1000),t._dom.window.css({transition:'opacity 0.6s',opacity:1});},_onBeforeUnload:function(t){var e=rk('Вы не закончили редактирование заметки, все несохранённые данные будут потеряны.');if(t=t||window.event,t)t.returnValue=e;return e;},_onUnload:function(){if(this._options.note.baseId)if(!this._options.note.hasContent())r.postRequestCall('Note.DeleteNotes',{Id:[this._options.note.baseId]});else if(this._options.isLocked)r.postRequestCall('Note.UnlockNote',{NoteId:this._options.note.baseId});else r.postRequestCall('Note.UpdateNote',{Id:this._options.note.baseId,Content:this._options.note.text,Settings:null,Order:null,Text:$('<div>').html(this._options.note.text).text().replace(/\n/g,' '),Color:this._options.note.color,UpdateModifyDate:true});},_checkNotificationServiceAvailability:function(){var t=this;if(null==k._notificationAvailabilityErrors)r.getAvailableNotificationTypes().addCallback(function(e){if(k._notificationAvailabilityErrors=e,t._setNotificationButtonAvailability(e))i.channel('NotesEvents').notify('onNotificationServiceAvailable');});else this._setNotificationButtonAvailability(k._notificationAvailabilityErrors);},_setNotificationButtonAvailability:function(t){if(this.hasChildControlByName('Notification')){var o=this.getChildControlByName('Notification'),i=e(t,function(t){return!t;})>=0;return o.setEnabled(i),o.setTooltip(i?rk('Добавить напоминание'):t[0]),i;}else return false;},_adjustEditorBottomPadding:function(){if(!this._dom)return;var t=70,e=32,o=8,i=this._dom.footer.height(),s=this._dom.footerFiles.height();if(i>e&&s<=0)i+=o;if(this._wasManualResizing&&i>(this._dom.window.height()-_)/2)i=(this._dom.window.height()-_)/2;else if(this._handleResize&&this._dom.window.height()-_-i<t&&this._options.note.text.length)i=this._dom.window.height()-_-t;var a=this._dom.window.height()-_-i,r=n.$win.height()-_-i,l=this.getContainer().css('padding-bottom');if(this.getContainer().css('padding-bottom',i),this._dom.scrollFooter.css({minHeight:'',height:i}),this._dom.scroll.css({maxHeight:r}),this._dom.scroll.attr('style').indexOf('auto')<0||this._dom.editorFrame[0]&&this._dom.editorFrame[0].style&&this._dom.editorFrame[0].style.height)if(this._dom.scroll.css('min-height',''),this._wasManualResizing)this._dom.scroll.css('height',a);if(parseInt(l)!==i||this._lastHeight!==this._dom.window.height())this._notifyOnSizeChanged();this._lastHeight=this._dom.window.height();},_onColorMenuActivate:function(t){var e=this;this._colorPanelIsOpened=true,this._closeFloatAreas('Colorize'),require(['SBIS3.CONTROLS/StylesPanelNew'],function(o){if(!e._stylePanel)e._stylePanel=new o({parent:t.getTarget(),target:t.getTarget().getContainer(),corner:'tl',element:$('<div></div>'),name:'StylesPanelNew',activableByClick:false,paletteRenderStyle:true,columnsCount:1,autoCloseOnHide:true,verticalAlign:{side:'top',offset:-6},horizontalAlign:{side:'left',offset:-6},colors:u.map(function(t){return{color:t};}),style:{color:u[e._options.note.color]},handlers:{changeFormat:function(t,o){var i=u.indexOf(this.getJSONStyle().color);if(i<0)i=0;e.changeColor(i),e._focusOnEditor();},onClose:function(){if(this.isVisible())setTimeout(function(){e._colorPanelIsOpened=false;},200);},onDestroy:function(){setTimeout(function(){e._focusOnEditor();},100);}}});else e._stylePanel.setStylesFromObject({color:u[e._options.note.color]});e._stylePanel.show();});},_onFileUpload:function(t,e){var o=this;this._focusOnEditor(),this._options.note.create(),this._options.note.addFile(e).addCallbacks(function(){o._controls.files.reload(),o._adjustEditorBottomPadding();},function(t){require(['WS.Data/Source/SbisService','SBIS3.CONTROLS/Utils/InformationPopupManager'],function(o,i){new o({endpoint:{contract:'FileSD',address:'/disk/api/v1/service/'}}).call('DeleteExt',{Ids:[e.id]}).addErrback(function(){}),i.showMessageDialog({message:rk('Не удалось загрузить файл'),details:t.message||t.details,status:'error'});});});},_triggerInputChange:function(){this._controls.content._setText(this._controls.content._getTinyEditorValue());},_focusOnEditor:function(){if(this._tinymce&&!n.browser.isMobileIOS)this._tinymce.focus();},_execEditorCommand:function(t){if(this._tinymce)this._focusOnEditor(),this._tinymce.execCommand(t);},_triggerEditorButton:function(t,e){e.originalEvent.ClickEventIsReady=false,this._controls.content.getToolbarItem(t).getContainer().trigger(e);},_onCheckClick:function(){var t=this._controls.toolbar.getLinkedEditor().getTinyEditor(),e=t.selection,o,i=b(e),n=v(e),s,a=null;if(this._closeFloatAreas(),n)a=e.getRng();else p(e);if(s=C(e),!s||i)this._execEditorCommand('InsertUnorderedList');else if(s){var r=w(e);this._execEditorCommand('UL'===r?'InsertUnorderedList':'InsertOrderedList'),this._execEditorCommand('InsertUnorderedList');}if(o=$(e.getSelectedBlocks().filter(function(t){return'UL'!==t.tagName&&'OL'!==t.tagName;})),i)N(o);else if(C(e))if(this._tinymce.undoManager.data.pop(),o.addClass('ws-note__checkable ws-note__checkable_unchecked'),a&&s&&n)this._setRng(t,e,a);this._triggerInputChange(),this._togglePlaceholder();},_togglePlaceholder:function(t){var e=$('.ws-noteDialog .controls-RichEditor__Placeholder');if(t)e.removeClass('ws-hidden');else if($(this._tinymce.getBody()).html().indexOf('ul')>0)e.addClass('ws-hidden');else e.removeClass('ws-hidden');},_setRng:function(t,e,o){e.setRng(o),e.select(),t.focus();},_hasContent:function(){return!!this._tinymce.getContent()||!!this._dom.editorFrame.find('ul, .ws-note__checkable').length;},onUnorderedListClick:function(t,e){var o=this._controls.toolbar.getLinkedEditor().getTinyEditor(),i=o.selection,n=$(i.getSelectedBlocks()),s=b(i),a=v(i),r=null,l=N(n);if(this._closeFloatAreas(),a){if(s)r=i.getRng();}else p(i);var c=false;if('UL'==w(i)&&'InsertOrderedList'==e)c=l=true;if(C(i)&&(s||c)){if(l)this._execEditorCommand('InsertUnorderedList'),this._execEditorCommand(e);}else this._execEditorCommand(e);if(r&&s&&a)this._setRng(o,i,r);this._togglePlaceholder();},_onUnorderedListClick:function(t,e){i.channel('NotesEvents').notify('onUnorderedListClick',e);},_onNotificationActivated:function(){var e=this;this._closeFloatAreas('Notification'),t.showFloatArea({parent:this._controls.notification,opener:this._controls.notification,template:'js!SBIS3.Notes.Notification',target:this._controls.notification.getContainer(),offset:{y:-4},autoCloseOnHide:true,activableByClick:false,componentOptions:{cron:this._options.note.cron||null,method:this._options.note.notificationMethod||null,time:this._options.note.calendar||null,activableByClick:false,availabilityErrors:k._notificationAvailabilityErrors},handlers:{onAfterClose:function(t,o){if(e._notifcationForm=null,false===o)e.updateNotification(null);else if(null!=o)e.updateNotification(o.time,o.method,null,o.cron,null);}}}).addCallback(function(t){e._notificationForm=t;});},_changeNote:function(t,e){var o=this._options.note;if(o[t]!==e)o[t]=e,o.create();},_onTextChange:function(t,e){this._togglePlaceholder(true),this._changeNote('text',e);},changeColor:function(t){var e=this._options.note;this._dom.window.removeClass('ws-note_color-'+e.color).addClass('ws-note_color-'+(e.color=t));},updateNotification:function(t,e,o,i,n){var s=this._options.note,a=this;s.setCalendar(t,e,o,i,n).addCallback(function(){if(a._dom&&a._dom.footerText&&a._dom.calendarRemove)a._dom.footerText.text(s.title||'').toggleClass('ws-hidden',!s.title),a._dom.calendarRemove.toggleClass('ws-hidden',!s.title);});},getContent:function t(){return(this._tinymce?this._tinymce.getContent():'').replace(/data-(min-height:\s*\d+(\.\d+)?px;)/gi,'$1');},_onSaveButtonActivated:function(){this.sendCommand('close','save');},_onCloseButtonActivated:function(){this.sendCommand('close');},disableSelection:function(t){$(t).attr('unselectable','on').on('selectstart',false);},enableSelection:function(t){$(t).removeAttr('unselectable').off('selectstart'),$('.ws-window-overlay').removeClass('ws-note-overlay_unselectable'),$('.ws-note__disable_selection').removeClass('ws-note__disable_selection').find('[unselectable]').removeAttr('unselectable').off('selectstart');},_onRemoveButtonActivated:function(){var t=this;if(this._closeFloatAreas(),this.getProperty('note').hasContent())require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(e){e.showConfirmDialog({message:rk('Удалить заметку?')},function(){t.close('remove');});});else t.close('remove');},_closeFloatAreas:function(t){if('TagButton'!==t&&this.hasChildControlByName('TagButton')){var e=this.getChildControlByName('TagButton');if(e)e.closeForm();}if('Notification'!==t&&this._notificationForm)this._notificationForm.close();if('FontStyle'!==t)this._controls.styles.hide();if('UnorderedList'!==t&&this._controls.list)this._controls.list.hide();},close:function(t){this._closeFloatAreas(),this.unsubscribeFrom(l.serverChannel('notes.userchanged'),'NoteChanged'),this.unsubscribeFrom(l.serverChannel('notes.userchanged'),'NoteDeleted'),this.sendCommand('close',t);},prepareTextForSaving:function(t){var e=0,o=this._dom.editorFrame.find('img');return t=t.replace(/^(\n?<p>&nbsp;<\/p>)*/im,'').replace(/<li class="ws-note__checkable ws-note__checkable_(un)?checked"><\/li>/gi,'').replace(/display:\s?none/gi,'').replace(/<img[^>]+>/gi,function t(i){var n=o.eq(e++),s=n.width(),a=n.height();return i=$(i).css({width:s,height:a}).attr({'data-original-width':s,'data-original-height':a})[0].outerHTML,i;}),t.replace(/^(\n|\r\n)*/m,'');},_onResize:function(t){var e=150,o=this._dom.footer[0].scrollHeight,i=t-_-o;if(this._dom.scroll.css({height:Math.max(i,e),minHeight:'',maxHeight:Math.max(i,e)}),i<e)o-=e-i,this._dom.scrollFooter.height(o);else this._dom.scrollFooter.height('');this.getContainer().css('padding-bottom',o);},_validateClass:function(t){if('ws-note__checkable'===t||'ws-note__checkable_checked'===t||'ws-note__checkable_unchecked'===t)return true;return false;}});return k;});
define("tmpl!SBIS3.Notes.ExtendedHider/ExtendedHiderContent",["Core/tmpl/js/tclosure"],function(){var e=Array.prototype.slice.call(arguments),t=e[0],i={},r=function e(r,a,s,n,o){function c(){}var l=0,d=void 0!==t&&t?t:arguments[arguments.length-1];void 0===d&&(eval("var thelpers = null;"),d=global.requirejs("View/Runner/tclosure"));var p={};o&&o.isSetts&&(p=o.fullContext||{});var g="string"==typeof s?s:"",f=void 0===i?void 0:i,u={id:[],def:void 0},m=d.configResolver.calcParent(this,"undefined"==typeof currentPropertyName?void 0:currentPropertyName,r),v=this&&this.includedTemplates?this.includedTemplates:{},h=d.getMarkupGenerator(n);try{var T=h.joinElements([h.createTag("span",{class:"ws-note__item ws-note_color-"+d.wrapUndef(d.utils.escape(d.getter(r,["item","color"])))},[h.createTag("span",{class:"ws-note__item-text"},[h.createTag("div",{class:"ws-note__content"},[h.createTag("div",{class:"ws-basic-style"},[h.createText(""+d.wrapUndef(d.Sanitize.apply(void 0,[d.getDecorators().sanitize.apply(void 0,[d.getter(r,["item","text"])])])))],{},u,this)],{},u,this),d.getDecorators().isArray.apply(void 0,[d.getter(r,["item","files"])])?[d.getter(r,["item","files","length"])>0?[h.createTag("span",{class:"ws-note__item-footer"},[h.createTag("span",{class:"icon-16 icon-Attach icon-disabled"},[],{},u,this),h.createTag("span",{class:"ws-note__item-files"},[function(){for(var e=void 0,t=0;t<d.iterators.length&&!e;t++)d.iterators[t].is(d.utils.escape(d.getter(r,["item","files","length"])))&&(e=d.iterators[t].iterator);var i=[];return function(){var t=d.createScope(r);if(r=t,e){var a=s,o=0;e(d.utils.escape(d.getter(r,["item","files","length"])),function(e,t){d.presetScope(e,r,t,{value:"file"}),s&&void 0!==n&&n&&(s=a+"-for_"+o,o++);var c=[h.createTag("span",{},[h.createText(""+d.wrapUndef(d.utils.escape(d.getter(r,["item","files",d.getter(r,["i"]),"title"]))))],{},u,this),d.getter(r,["i"])<d.getter(r,["item","files","length"])-1?[h.createText(""+global.rk(","))]:h.createText("")];void 0===c[0]&&void 0!==n&&n||(i=i.concat(c))}.bind(r))}else i=""}.call(r),i}()],{},u,this)],{},u,this)]:h.createText("")]:[0!=d.getter(r,["item","files","getCount"]).apply(d.getter(r,["item","files"]),[])?[h.createTag("span",{class:"ws-note__item-footer"},[h.createTag("span",{class:"icon-16 icon-Attach icon-disabled"},[],{},u,this),h.createTag("span",{class:"ws-note__item-files"},[function(){for(var e=void 0,t=0;t<d.iterators.length&&!e;t++)d.iterators[t].is(d.utils.escape(d.getter(r,["item","files","getCount"]).apply(d.getter(r,["item","files"]),[])))&&(e=d.iterators[t].iterator);var i=[];return function(){var t=d.createScope(r);if(r=t,e){var a=s,o=0;e(d.utils.escape(d.getter(r,["item","files","getCount"]).apply(d.getter(r,["item","files"]),[])),function(e,t){d.presetScope(e,r,t,{value:"i"}),s&&void 0!==n&&n&&(s=a+"-for_"+o,o++);var c=[h.createTag("span",{},[h.createText(""+d.wrapUndef(d.utils.escape(d.getter(d.getter(r,["item","files","at"]).apply(d.getter(r,["item","files"]),[d.getter(r,["i"])]),["title"]))))],{},u,this),d.getter(r,["i"])<d.getter(r,["item","files","getCount"]).apply(d.getter(r,["item","files"]),[])-1?[h.createText(""+global.rk(","))]:h.createText("")];void 0===c[0]&&void 0!==n&&n||(i=i.concat(c))}.bind(r))}else i=""}.call(r),i}()],{},u,this)],{},u,this)]:h.createText("")]],{},u,this),h.createTag("span",{class:"ws-note__item-date"},[h.createText(""+d.wrapUndef(d.utils.escape(d.getter(r,["item","prettyModified"])||d.getter(r,["item","prettyCreationDate"]))))],{},u,this),h.createTag("span",{class:"ws-note__item-icon"},[1==d.getter(r,["item","isHidden"])?[h.createTag("div",{class:"icon-24 icon-PinNull icon-primary"},[],{},u,this)]:h.createText("")],{},u,this)],a,u,this)],g,u);u.def&&(T=h.chain(T,u,a),u=void 0)}catch(e){d.templateError("resources/Zametki/Hider/ExtendedHiderContent.tmpl",e,r)}return T||""};return r.includedFunctions={},r.stable=!0,r.toJSON=function(){return{$serialized$:"func",module:"tmpl!SBIS3.Notes.ExtendedHider/ExtendedHiderContent"}},r});
define("tmpl!SBIS3.Notes.ExtendedHider",["Core/tmpl/js/tclosure","js!SBIS3.CONTROLS/Button/IconButton","js!SBIS3.CONTROLS/Button","js!SBIS3.CONTROLS/Link","js!SBIS3.CONTROLS/ScrollContainer","js!SBIS3.CONTROLS/ListView","tmpl!SBIS3.Notes.ExtendedHider/ExtendedHiderContent"],function(){var e=Array.prototype.slice.call(arguments),t=e[0],o={};o["js!SBIS3.CONTROLS/Button/IconButton"]=e[1],o["js!SBIS3.CONTROLS/Button"]=e[2],o["js!SBIS3.CONTROLS/Link"]=e[3],o["js!SBIS3.CONTROLS/ScrollContainer"]=e[4],o["js!SBIS3.CONTROLS/ListView"]=e[5],o["tmpl!SBIS3.Notes.ExtendedHider/ExtendedHiderContent"]=e[6];var r=function e(r,n,i,a,s){function l(){}var c=0,d=void 0!==t&&t?t:arguments[arguments.length-1];void 0===d&&(eval("var thelpers = null;"),d=global.requirejs("View/Runner/tclosure"));var u={};s&&s.isSetts&&(u=s.fullContext||{});var m="string"==typeof i?i:"",p=void 0===o?void 0:o,S={id:[],def:void 0},v=d.configResolver.calcParent(this,"undefined"==typeof currentPropertyName?void 0:currentPropertyName,r),N=this&&this.includedTemplates?this.includedTemplates:{},C=d.getMarkupGenerator(a);try{var f=C.joinElements([C.createTag("div",{},[C.createTag("div",{class:"ws-note__extHider_header"},[C.createTag("div",{class:"ws-note__extHider_title"},[C.createText(""+global.rk("Заметки"))],{},S,this),C.createControl("wsControl","ws:SBIS3.CONTROLS/Button/IconButton",{name:"addNote",icon:"icon-16 icon-primary icon-AddButtonNew",className:"ws-note__add-note controls-IconButton__round-border-24",tooltip:global.rk("Создать заметку")},{name:"addNote",sbisname:"addNote"},{data:r,ctx:this,pName:"undefined"!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v},i,p,N,d.config,u),C.createControl("wsControl","ws:SBIS3.CONTROLS/Button/IconButton",{name:"close",className:"ws-note__close controls-PopupMixin__closeButton",tooltip:global.rk("Закрыть"),activableByClick:!1},{name:"close",sbisname:"close"},{data:r,ctx:this,pName:"undefined"!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v},i,p,N,d.config,u),C.createControl("wsControl","ws:SBIS3.CONTROLS/Button",{name:"showNotes",className:"ws-note__show-notes",caption:global.rk("Показать все"),tooltip:global.rk("Показать все"),activableByClick:!1},{name:"showNotes",sbisname:"showNotes"},{data:r,ctx:this,pName:"undefined"!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v},i,p,N,d.config,u),C.createControl("wsControl","ws:SBIS3.CONTROLS/Link",{name:"hideNotes",className:"ws-note__hide-notes",caption:global.rk("Скрыть все"),tooltip:global.rk("Скрыть все"),activableByClick:!1},{name:"hideNotes",sbisname:"hideNotes"},{data:r,ctx:this,pName:"undefined"!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v},i,p,N,d.config,u)],{},S,this),C.createControl("wsControl","ws:SBIS3.CONTROLS/ScrollContainer",{content:d.createDataArray([(new function(){var e=Object.create(r),t=function e(t,o,r,n,i){if(void 0===r)var r=arguments[2];var a=0,s="content";if(void 0===d&&(eval("var thelpers = null;"),d=global.requirejs("View/Runner/tclosure")),i&&i.isSetts)var l=i.fullContext||{};t=d.isolateScope(Object.create(this),t,s);var c="string"==typeof r?r:"",u={id:[],def:void 0},m=this&&this.includedTemplates?this.includedTemplates:{},S=d.getMarkupGenerator(n);try{var N=S.joinElements([S.createControl("wsControl","ws:SBIS3.CONTROLS/ListView",{itemContentTpl:d.createDataArray([(new function(){var e=Object.create(t),o=function e(t,o,r,n,i){if(void 0===r)var r=arguments[2];var a=0,s="itemContentTpl";if(void 0===d&&(eval("var thelpers = null;"),d=global.requirejs("View/Runner/tclosure")),i&&i.isSetts)var l=i.fullContext||{};t=d.isolateScope(Object.create(this),t,s);var c="string"==typeof r?r:"",u={id:[],def:void 0},m=this&&this.includedTemplates?this.includedTemplates:{},S=d.getMarkupGenerator(n);try{var N=S.joinElements([S.createControl("template","tmpl!SBIS3.Notes.ExtendedHider/ExtendedHiderContent",{item:d.getter(t,["itemContentTpl","item"])},{},{data:t,ctx:this,pName:void 0!==s?s:void 0,viewController:v},n?r+"part_"+a+++"_":r,p,m,d.config,l)],c,u);u.def&&(N=S.chain(N,u,o),u=void 0)}catch(e){d.templateError("resources/Zametki/Hider/Extended.tmpl",e,t)}return N||""};this.func=d.makeFunctionSerializable(o,e)}).func]),name:"hiderNotesList",className:"ws-note__hider-notes",idProperty:"id",multiselect:!1,itemsDragNDrop:!1,esc:!1},d.plainMerge(o,{name:"hiderNotesList",sbisname:"hiderNotesList"}),{data:t,ctx:this,pName:void 0!==s?s:void 0,viewController:v,internal:{__dirtyCheckingVars_0:d.getter(t,["itemContentTpl","item"])}},r,p,m,d.config,l)],c,u);u.def&&(N=S.chain(N,u,o),u=void 0)}catch(e){d.templateError("resources/Zametki/Hider/Extended.tmpl",e,t)}return N||""};this.func=d.makeFunctionSerializable(t,e)}).func]),esc:!1},{},{data:r,ctx:this,pName:"undefined"!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v,internal:{__dirtyCheckingVars_0:d.getter(r,["itemContentTpl","item"])}},i,p,N,d.config,u)],n,S,this)],m,S);S.def&&(f=C.chain(f,S,n),S=void 0)}catch(e){d.templateError("resources/Zametki/Hider/Extended.tmpl",e,r)}return f||""};return r.includedFunctions={},r.stable=!0,r.toJSON=function(){return{$serialized$:"func",module:"tmpl!SBIS3.Notes.ExtendedHider"}},r});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.ExtendedHider", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-note__extHider-form{background-color:#fffbe4;-webkit-box-shadow:0 0 10px 0 rgba(0,0,0,.75);-moz-box-shadow:0 0 10px 0 rgba(0,0,0,.75);box-shadow:0 0 10px 0 rgba(0,0,0,.75);height:auto}.ws-note__extHider-form>div{width:400px;height:auto;max-height:500px;min-height:44px}.ws-note__extHider_header{height:44px}.ws-note__extHider_title{color:#000;font-size:18px;font-weight:700;display:inline-block;margin:9px 10px 0 12px}.ws-note__add-note{margin-top:-4px}.ws-note__extHider-form .ws-note__hide-notes{float:right;margin-top:10px;margin-right:12px}.ws-note__extHider-form .ws-note__close{float:right;margin-top:0;margin-right:0;font-size:23px;font-family:cbuc-icons}.ws-note__show-notes{float:right;margin-top:10px;margin-right:10px}.ws-note__item{border-top:1px solid #eaeaea;min-height:48px;box-sizing:border-box;padding:8px 12px 0 12px;cursor:pointer;display:flex;align-items:flex-start}.ws-note__item-text{width:292px;padding-bottom:8px;word-wrap:break-word}.ws-note__item-text .ws-basic-style li,.ws-note__item-text .ws-basic-style>p{margin-bottom:0}.ws-note__item-text .ws-basic-style .ws-note__checkable,.ws-note__item-text .ws-basic-style li,.ws-note__item-text .ws-basic-style p{word-wrap:break-word;line-height:140%}.ws-note__item-date{padding-top:0;width:90px;text-align:right;font-size:12px;color:#999}.ws-note__item-footer{display:block;font-size:13px;text-overflow:ellipsis;white-space:nowrap;font-size:13px;color:#999;overflow:hidden}.ws-note__item-files{padding-left:2px;color:#999}.ws-note__item-files>span:hover{text-decoration:underline}.ws-note__extHider-form .controls-ScrollContainer{height:100%;max-height:450px}.ws-note__item-icon{position:absolute;bottom:3px;right:10px;height:24px;overflow:hidden}.ws-note__extHider-form .controls-ItemsToolbar{height:24px;overflow:hidden}.ws-note__extHider-form .controls-ItemsToolbar{background:0 0!important}.ws-note__extHider-form .controls-ScrollContainer.controls-ScrollContainer__bottom-gradient:after{display:block}.ws-note__hider-notes.controls-ListView__dataNotLoaded:not(.ws-sticky-header__table-header-copy){min-height:60px}.ws-note__item-text .ws-note__content{max-height:200px;overflow:hidden}.ws-note__extHider-form .ws-note_color-0{background:#fffbe4}.ws-note__extHider-form .ws-note_color-0:hover{background:#fff7c2}.ws-note__extHider-form .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(255,251,228,0) 0,rgba(255,251,228,.1) 15%,rgba(255,251,228,.5) 30%,rgba(255,251,228,.99) 70%,rgba(255,251,228,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(255,251,228,0)),color-stop(15%,rgba(255,251,228,.1)),color-stop(30%,rgba(255,251,228,.5)),color-stop(70%,rgba(255,251,228,.99)),color-stop(100%,rgba(255,251,228,1)));background:-webkit-linear-gradient(top,rgba(255,251,228,0) 0,rgba(255,251,228,.1) 15%,rgba(255,251,228,.5) 30%,rgba(255,251,228,.99) 70%,rgba(255,251,228,1) 100%);background:-o-linear-gradient(top,rgba(255,251,228,0) 0,rgba(255,251,228,.1) 15%,rgba(255,251,228,.5) 30%,rgba(255,251,228,.99) 70%,rgba(255,251,228,1) 100%);background:-ms-linear-gradient(top,rgba(255,251,228,0) 0,rgba(255,251,228,.1) 15%,rgba(255,251,228,.5) 30%,rgba(255,251,228,.99) 70%,rgba(255,251,228,1) 100%);background:linear-gradient(to bottom,rgba(255,251,228,0) 0,rgba(255,251,228,.1) 15%,rgba(255,251,228,.5) 30%,rgba(255,251,228,.99) 70%,rgba(255,251,228,1) 100%);top:178px;height:31px;position:absolute;content:'';width:100%;display:block}.ws-note__extHider-form .ws-note__item:hover .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(255,247,194,0) 0,rgba(255,247,194,.1) 15%,rgba(255,247,194,.5) 30%,rgba(255,247,194,.99) 70%,rgba(255,247,194,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(255,247,194,0)),color-stop(15%,rgba(255,247,194,.1)),color-stop(30%,rgba(255,247,194,.5)),color-stop(70%,rgba(255,247,194,.99)),color-stop(100%,rgba(255,247,194,1)));background:-webkit-linear-gradient(top,rgba(255,247,194,0) 0,rgba(255,247,194,.1) 15%,rgba(255,247,194,.5) 30%,rgba(255,247,194,.99) 70%,rgba(255,247,194,1) 100%);background:-o-linear-gradient(top,rgba(255,247,194,0) 0,rgba(255,247,194,.1) 15%,rgba(255,247,194,.5) 30%,rgba(255,247,194,.99) 70%,rgba(255,247,194,1) 100%);background:-ms-linear-gradient(top,rgba(255,247,194,0) 0,rgba(255,247,194,.1) 15%,rgba(255,247,194,.5) 30%,rgba(255,247,194,.99) 70%,rgba(255,247,194,1) 100%);background:linear-gradient(to bottom,rgba(255,247,194,0) 0,rgba(255,247,194,.1) 15%,rgba(255,247,194,.5) 30%,rgba(255,247,194,.99) 70%,rgba(255,247,194,1) 100%);top:178px;height:31px;position:absolute;content:'';width:100%;display:block}.ws-note__extHider-form .ws-note_color-1{background:#e8fdc4}.ws-note__extHider-form .ws-note_color-1:hover{background:#defcab}.ws-note__extHider-form .ws-note_color-1 .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(232,253,196,0) 0,rgba(232,253,196,.1) 15%,rgba(232,253,196,.5) 30%,rgba(232,253,196,.99) 70%,rgba(232,253,196,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(232,253,196,0)),color-stop(15%,rgba(232,253,196,.05)),color-stop(50%,rgba(232,253,196,.5)),color-stop(80%,rgba(232,253,196,.99)),color-stop(100%,rgba(232,253,196,1)));background:-webkit-linear-gradient(top,rgba(232,253,196,0) 0,rgba(232,253,196,.1) 15%,rgba(232,253,196,.5) 30%,rgba(232,253,196,.99) 70%,rgba(232,253,196,1) 100%);background:-o-linear-gradient(top,rgba(232,253,196,0) 0,rgba(232,253,196,.1) 15%,rgba(232,253,196,.5) 30%,rgba(232,253,196,.99) 70%,rgba(232,253,196,1) 100%);background:-ms-linear-gradient(top,rgba(232,253,196,0) 0,rgba(232,253,196,.1) 15%,rgba(232,253,196,.5) 30%,rgba(232,253,196,.99) 70%,rgba(232,253,196,1) 100%);background:linear-gradient(to bottom,rgba(232,253,196,0) 0,rgba(232,253,196,.1) 15%,rgba(232,253,196,.5) 30%,rgba(232,253,196,.99) 70%,rgba(232,253,196,1) 100%)}.ws-note__extHider-form .ws-note_color-1.ws-note__item:hover .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(222,252,171,0) 0,rgba(222,252,171,.1) 15%,rgba(222,252,171,.5) 30%,rgba(222,252,171,.99) 70%,rgba(222,252,171,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(222,252,171,0)),color-stop(15%,rgba(222,252,171,.05)),color-stop(50%,rgba(222,252,171,.5)),color-stop(80%,rgba(222,252,171,.99)),color-stop(100%,rgba(222,252,171,1)));background:-webkit-linear-gradient(top,rgba(222,252,171,0) 0,rgba(222,252,171,.1) 15%,rgba(222,252,171,.5) 30%,rgba(222,252,171,.99) 70%,rgba(222,252,171,1) 100%);background:-o-linear-gradient(top,rgba(222,252,171,0) 0,rgba(222,252,171,.1) 15%,rgba(222,252,171,.5) 30%,rgba(222,252,171,.99) 70%,rgba(222,252,171,1) 100%);background:-ms-linear-gradient(top,rgba(222,252,171,0) 0,rgba(222,252,171,.1) 15%,rgba(222,252,171,.5) 30%,rgba(222,252,171,.99) 70%,rgba(222,252,171,1) 100%);background:linear-gradient(to bottom,rgba(222,252,171,0) 0,rgba(222,252,171,.1) 15%,rgba(222,252,171,.5) 30%,rgba(222,252,171,.99) 70%,rgba(222,252,171,1) 100%)}.ws-note__extHider-form .ws-note_color-2{background:#ffe0cc}.ws-note__extHider-form .ws-note_color-2:hover{background:#ffd7bb}.ws-note__extHider-form .ws-note_color-2 .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(255,224,204,0) 0,rgba(255,224,204,.1) 15%,rgba(255,224,204,.5) 30%,rgba(255,224,204,.99) 70%,rgba(255,224,204,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(255,224,204,0)),color-stop(15%,rgba(255,224,204,.05)),color-stop(50%,rgba(255,224,204,.5)),color-stop(80%,rgba(255,224,204,.99)),color-stop(100%,rgba(255,224,204,1)));background:-webkit-linear-gradient(top,rgba(255,224,204,0) 0,rgba(255,224,204,.1) 15%,rgba(255,224,204,.5) 30%,rgba(255,224,204,.99) 70%,rgba(255,224,204,1) 100%);background:-o-linear-gradient(top,rgba(255,224,204,0) 0,rgba(255,224,204,.1) 15%,rgba(255,224,204,.5) 30%,rgba(255,224,204,.99) 70%,rgba(255,224,204,1) 100%);background:-ms-linear-gradient(top,rgba(255,224,204,0) 0,rgba(255,224,204,.1) 15%,rgba(255,224,204,.5) 30%,rgba(255,224,204,.99) 70%,rgba(255,224,204,1) 100%);background:linear-gradient(to bottom,rgba(255,224,204,0) 0,rgba(255,224,204,.1) 15%,rgba(255,224,204,.5) 30%,rgba(255,224,204,.99) 70%,rgba(255,224,204,1) 100%)}.ws-note__extHider-form .ws-note_color-2.ws-note__item:hover .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(255,215,187,0) 0,rgba(255,215,187,.1) 15%,rgba(255,215,187,.5) 30%,rgba(255,215,187,.99) 70%,rgba(255,215,187,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(255,215,187,0)),color-stop(15%,rgba(255,215,187,.05)),color-stop(50%,rgba(255,215,187,.5)),color-stop(80%,rgba(255,215,187,.99)),color-stop(100%,rgba(255,215,187,1)));background:-webkit-linear-gradient(top,rgba(255,215,187,0) 0,rgba(255,215,187,.1) 15%,rgba(255,215,187,.5) 30%,rgba(255,215,187,.99) 70%,rgba(255,215,187,1) 100%);background:-o-linear-gradient(top,rgba(255,215,187,0) 0,rgba(255,215,187,.1) 15%,rgba(255,215,187,.5) 30%,rgba(255,215,187,.99) 70%,rgba(255,215,187,1) 100%);background:-ms-linear-gradient(top,rgba(255,215,187,0) 0,rgba(255,215,187,.1) 15%,rgba(255,215,187,.5) 30%,rgba(255,215,187,.99) 70%,rgba(255,215,187,1) 100%);background:linear-gradient(to bottom,rgba(255,215,187,0) 0,rgba(255,215,187,.1) 15%,rgba(255,215,187,.5) 30%,rgba(255,215,187,.99) 70%,rgba(255,215,187,1) 100%)}.ws-note__extHider-form .ws-note_color-3{background:#f1e0f1}.ws-note__extHider-form .ws-note_color-3:hover{background:#ebd3eb}.ws-note__extHider-form .ws-note_color-3 .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(241,224,241,0) 0,rgba(241,224,241,.1) 15%,rgba(241,224,241,.5) 30%,rgba(241,224,241,.99) 70%,rgba(241,224,241,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(241,224,241,0)),color-stop(15%,rgba(241,224,241,.99)),color-stop(50%,rgba(241,224,241,.5)),color-stop(80%,rgba(241,224,241,.99)),color-stop(100%,rgba(241,224,241,1)));background:-webkit-linear-gradient(top,rgba(241,224,241,0) 0,rgba(241,224,241,.1) 15%,rgba(241,224,241,.5) 30%,rgba(241,224,241,.99) 70%,rgba(241,224,241,1) 100%);background:-o-linear-gradient(top,rgba(241,224,241,0) 0,rgba(241,224,241,.1) 15%,rgba(241,224,241,.5) 30%,rgba(241,224,241,.99) 70%,rgba(241,224,241,1) 100%);background:-ms-linear-gradient(top,rgba(241,224,241,0) 0,rgba(241,224,241,.1) 15%,rgba(241,224,241,.5) 30%,rgba(241,224,241,.99) 70%,rgba(241,224,241,1) 100%);background:linear-gradient(to bottom,rgba(241,224,241,0) 0,rgba(241,224,241,.1) 15%,rgba(241,224,241,.5) 30%,rgba(241,224,241,.99) 70%,rgba(241,224,241,1) 100%)}.ws-note__extHider-form .ws-note_color-3.ws-note__item:hover .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(235,211,235,0) 0,rgba(235,211,235,.1) 15%,rgba(235,211,235,.5) 30%,rgba(235,211,235,.99) 70%,rgba(235,211,235,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(235,211,235,0)),color-stop(15%,rgba(235,211,235,.99)),color-stop(50%,rgba(235,211,235,.5)),color-stop(80%,rgba(235,211,235,.99)),color-stop(100%,rgba(235,211,235,1)));background:-webkit-linear-gradient(top,rgba(235,211,235,0) 0,rgba(235,211,235,.1) 15%,rgba(235,211,235,.5) 30%,rgba(235,211,235,.99) 70%,rgba(235,211,235,1) 100%);background:-o-linear-gradient(top,rgba(235,211,235,0) 0,rgba(235,211,235,.1) 15%,rgba(235,211,235,.5) 30%,rgba(235,211,235,.99) 70%,rgba(235,211,235,1) 100%);background:-ms-linear-gradient(top,rgba(235,211,235,0) 0,rgba(235,211,235,.1) 15%,rgba(235,211,235,.5) 30%,rgba(235,211,235,.99) 70%,rgba(235,211,235,1) 100%);background:linear-gradient(to bottom,rgba(235,211,235,0) 0,rgba(235,211,235,.1) 15%,rgba(235,211,235,.5) 30%,rgba(235,211,235,.99) 70%,rgba(235,211,235,1) 100%)}.ws-note__extHider-form .ws-note_color-4{background:#d9f2ff}.ws-note__extHider-form .ws-note_color-4:hover{background:#c1eaff}.ws-note__extHider-form .ws-note_color-4 .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(217,242,255,0) 0,rgba(217,242,255,.1) 15%,rgba(217,242,255,.5) 30%,rgba(217,242,255,.99) 70%,rgba(217,242,255,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(217,242,255,0)),color-stop(15%,rgba(217,242,255,.05)),color-stop(50%,rgba(217,242,255,.5)),color-stop(80%,rgba(217,242,255,.99)),color-stop(100%,rgba(217,242,255,1)));background:-webkit-linear-gradient(top,rgba(217,242,255,0) 0,rgba(217,242,255,.1) 15%,rgba(217,242,255,.5) 30%,rgba(217,242,255,.99) 70%,rgba(217,242,255,1) 100%);background:-o-linear-gradient(top,rgba(217,242,255,0) 0,rgba(217,242,255,.1) 15%,rgba(217,242,255,.5) 30%,rgba(217,242,255,.99) 70%,rgba(217,242,255,1) 100%);background:-ms-linear-gradient(top,rgba(217,242,255,0) 0,rgba(217,242,255,.1) 15%,rgba(217,242,255,.5) 30%,rgba(217,242,255,.99) 70%,rgba(217,242,255,1) 100%);background:linear-gradient(to bottom,rgba(217,242,255,0) 0,rgba(217,242,255,.1) 15%,rgba(217,242,255,.5) 30%,rgba(217,242,255,.99) 70%,rgba(217,242,255,1) 100%)}.ws-note__extHider-form .ws-note_color-4.ws-note__item:hover .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(193,234,255,0) 0,rgba(193,234,255,.1) 15%,rgba(193,234,255,.5) 30%,rgba(193,234,255,.99) 70%,rgba(193,234,255,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(193,234,255,0)),color-stop(15%,rgba(193,234,255,.05)),color-stop(50%,rgba(193,234,255,.5)),color-stop(80%,rgba(193,234,255,.99)),color-stop(100%,rgba(193,234,255,1)));background:-webkit-linear-gradient(top,rgba(193,234,255,0) 0,rgba(193,234,255,.1) 15%,rgba(193,234,255,.5) 30%,rgba(193,234,255,.99) 70%,rgba(193,234,255,1) 100%);background:-o-linear-gradient(top,rgba(193,234,255,0) 0,rgba(193,234,255,.1) 15%,rgba(193,234,255,.5) 30%,rgba(193,234,255,.99) 70%,rgba(193,234,255,1) 100%);background:-ms-linear-gradient(top,rgba(193,234,255,0) 0,rgba(193,234,255,.1) 15%,rgba(193,234,255,.5) 30%,rgba(193,234,255,.99) 70%,rgba(193,234,255,1) 100%);background:linear-gradient(to bottom,rgba(193,234,255,0) 0,rgba(193,234,255,.1) 15%,rgba(193,234,255,.5) 30%,rgba(193,234,255,.99) 70%,rgba(193,234,255,1) 100%)}.ws-note__extHider-form .ws-note__content .ws-basic-style img:not(.LinkDecorator__image){max-width:100%!important;height:auto!important}"));head.appendChild(style);});}
define('js!SBIS3.Notes.ExtendedHider',['SBIS3.CONTROLS/CompoundControl','Core/EventBus','Core/constants','tmpl!SBIS3.Notes.ExtendedHider','js!SBIS3.Notes.MenuColor','css!SBIS3.Notes.ExtendedHider','Zametki_localization'],function(t,e,o,n){'use strict';var i=t.extend({_dotTplFn:n,init:function(){i.superclass.init.call(this);var t=this,n=Math.round(0.7*o.$win.height()),s=this.getChildControlByName('addNote'),r=this.getChildControlByName('hideNotes'),c=this.getChildControlByName('showNotes'),a=this.getChildControlByName('hiderNotesList'),d=this.getChildControlByName('close');if(n>500)this.getContainer().css('max-height',n),this.getContainer().find('.controls-ScrollContainer').css('max-height',n-50);a.setItemsActions([{name:'delete',icon:'sprite:icon-16 icon-Erase icon-error',caption:rk('Удалить'),isMainAction:true,onActivated:function(t,o,n){require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(o){o.showConfirmDialog({message:rk('Удалить заметку?')},function(){e.channel('NoteCommands').notify('Remove',n.getRawData()),a.getContainer().find('.controls-ItemsToolbar').css('display','none'),$(t).hide('slow','swing',function(){a._setVisible=true;});});});}},{name:'show',icon:'sprite:icon-24 icon-PinNull icon-primary',caption:rk('Показать'),isMainAction:true,onActivated:function(e,o,n){t._showNote(n,true);}},{visible:false,name:'hide',icon:'sprite:icon-24 icon-PinOff icon-primary',caption:rk('Скрыть'),isMainAction:true,onActivated:function(e,o,n){t._showNote(n,false);}}]),this._controls={add:s,hide:r,show:c,notes:a},this.subscribeTo(a,'onItemClick',function(t,o,n,i){if(i.href||$(i).hasClass('LinkDecorator__image'))return;e.channel('NoteCommands').notify('Open',null,n),e.channel('NoteCommands').notify('CloseExtendedHider');}),this.subscribeTo(a,'onChangeHoveredItem',function(e,o){if(t._controls.notes._setVisible)a.getContainer().find('.controls-ItemsToolbar').css('display','block'),t._controls.notes._setVisible=false;var n=this.getItemsActions().getItemsInstances();if(o&&o.record)if(o.record.get('isHidden'))n['hide'].hide(),n['show'].show();else n['hide'].show(),n['show'].hide();}),this.subscribeTo(s,'onActivated',function(){e.channel('ChannelUserAccount').notify('onAddNote'),e.channel('NoteCommands').notify('CloseExtendedHider');}),this.subscribeTo(c,'onActivated',function(){t._showNotes(true),e.channel('NoteCommands').notify('CloseExtendedHider');}),this.subscribeTo(r,'onActivated',function(){t._showNotes(false),e.channel('NoteCommands').notify('CloseExtendedHider');}),this.subscribeTo(d,'onActivated',function(){e.channel('NoteCommands').notify('CloseExtendedHider');}),this.subscribeTo(e.channel('NoteCommands'),'setNotesList',function(e,o){t._setNotesList(o);}),e.channel('NotesEvents').notify('onExtendedHiderOpened').addCallback(function(e){if(e)t._setNotesList(e);}),this.subscribeTo(this._controls.notes,'onDrawItems',function(){t._addNoteBlur();});},_setNotesList:function(t){var n=this,i=o.$win.height();t.sort(function(t,e){return(t.top||(t.bottom?i-t.bottom-t.height:0))>(e.top||(e.bottom?i-e.bottom-e.height:0))?1:-1;}),this._controls.notes.setItems(t),this._controls.notes.setItemsFilterMethod(function(t){return false==t.get('pinnedToPanel');}),setTimeout(function(){n._addNoteBlur();},0),setTimeout(function(){e.channel('NotesEvents').notify('onExtendedHiderComplete');},100);},_addNoteBlur:function(){this.getContainer().find('.ws-note__content').each(function(){$(this).toggleClass('ws-note__blur',this.scrollHeight-this.clientHeight>0);});},_showNote:function(t,n){var i=this;if(t)if(t.set('isHidden',!n),e.channel('NoteCommands').notify('SetNoteVisible',t,n),!o.browser.isMobilePlatform)setTimeout(function(){i._controls.notes._showItemsToolbar(i._controls.notes.getHoveredItem());},50);},_showNotes:function(t){var o=[],n=[];if(this._controls.notes.getItems().each(function(e){if(e.get('isHidden')==t&&!e.get('pinnedToPanel'))e.set('isHidden',!t),o.push(e.get('id')),n.push(e.get('baseId'));}),o.length)e.channel('NoteCommands').notify('SetNotesListVisible',o,n,t);}});return i;});
define("tmpl!SBIS3.Notes.Hider",["Core/tmpl/js/tclosure"],function(){var e=Array.prototype.slice.call(arguments),t=e[0],r={},i=function e(i,n,o,l,s){function a(){}var d=0,c=void 0!==t&&t?t:arguments[arguments.length-1];void 0===c&&(eval("var thelpers = null;"),c=global.requirejs("View/Runner/tclosure"));var u={};s&&s.isSetts&&(u=s.fullContext||{});var p="string"==typeof o?o:"",v=void 0===r?void 0:r,f={id:[],def:void 0},h=c.configResolver.calcParent(this,"undefined"==typeof currentPropertyName?void 0:currentPropertyName,i),m=this&&this.includedTemplates?this.includedTemplates:{},g=c.getMarkupGenerator(l);try{var y=g.joinElements([g.createTag("div",{class:"ws-note-hider ws-hidden",title:""+global.rk("Заметки")},[g.createTag("span",{class:"ws-note-hider__count"},[],{},f,this)],n,f,this)],p,f);f.def&&(y=g.chain(y,f,n),f=void 0)}catch(e){c.templateError("resources/Zametki/Hider/Page.tmpl",e,i)}return y||""};return i.includedFunctions={},i.stable=!0,i.toJSON=function(){return{$serialized$:"func",module:"tmpl!SBIS3.Notes.Hider"}},i});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.Hider", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-note-hider{height:34px;width:20px;line-height:32px;position:relative;float:left;margin-left:12px;margin-top:0;top:-4px!important;text-align:center;cursor:pointer;box-sizing:border-box;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;z-index:1000;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAoCAYAAAD+MdrbAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAANtJREFUeNpifP/+wn8GKgIWEMH7o5sqhn3mKGVgYqAyGDVw1MBRA0cNHDVw1MBRA0cNHDVw6Bv4k9WJ4R8jP9mG/GdkZ/jJYg1mMwKbxAkMDP9agGZLs/69wsD25xgD0/+PRBv0i9mE4TeLMcN/BuZfjP+/T2f8/x/SxP7w4SLRBiMbBFT/h/H/57n/GIUqBAT0P8ANhAFCBv9m1gEHEcggpn/vlv5lEi8AGQSTxzAQl8HM/x4z/AKG0z9GPqAFb9f+YxROQTaIoIHYDAa6dCcw8jKABj3ApR4gwAAyxmqst/SWkwAAAABJRU5ErkJggg==) bottom right no-repeat}.ws-note-hider.ws-note-hider_big{width:28px!important;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAoCAYAAADt5povAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAUVJREFUeNrs171KxEAQB/CZ3SQnHGqwEEQEi7vuQEEfwNpKObX2HdRHsLrOWi2tLHwDH8E7tREtrCwETfw4lGx2x0lO4QyiB2KwmCmyG1jmx/y3WoyiNkGJ5WWf4ddWKdjT0BYoKLkEFFBAAQUUUEABBRRQQAEF/L/gS9A0Rjf+DEl1nY3lfI/85F4HsKsAehHBGM9e+J67As9e/gpxahwSPZdjBBVQFJ0QBLtI1Hvix3En5GWJj27w4A2ExPr2TPv2HJS7HQzBUQZqYPQ870cAqXvDQ+w5DPfDcOY6n/AD7C/Gp9/xTcYnkZ5T3556OU4Pn84SViBVdciuxKqpLMBEUfeQ8RYj7WLvL8ECPstLFvsaxz6h6C7xbSdQ9MhQrS+y+2OHYzuMHH3X70ewgC/0cLfCk1ezyPh/m7B6wFA8SI83AQYAcDx94mR3JIwAAAAASUVORK5CYII=) bottom right no-repeat}.ws-note-hider.ws-note-hider_big.ws-hider_fletching{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAoCAYAAADt5povAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAATFJREFUeNrs2L1KBDEQAOCZJAs2eougIDYiVwpa2djpA3iN1lf4CPoU2x1X+BgHPoBvIOtPpXaWgrtyyrlnknFmsRAOxeNksZhAEkiG/ZJMmiwWRU7QYHHSzL9ljWDDuRMw0HBRUEEFFVRQQQUVVFBBBRVU8F+CbprgiC14txvguUZcAEOPIQnXNgk3gFT9DSiIt+0airgMCFWBNOrz1EXEpW7ldve5gov34MIdCD41OIHQaIgwPuOprJVu519CB2V5mXLf8Wb9yJv2TpXsBRdu613b+DDxbZSfCvLG/w7h8SxNN/PfHBfja4Lzko/5eqwivfgkXDnBDT3Xb/walOPg1XGsHxt6PWfklJHBLJeD8S3uugDhEMCuSL45BVbA0tAT52OxNyvyA9753PnBhwADACRYhLDZk4SlAAAAAElFTkSuQmCC) bottom right no-repeat}.ws-note-hider.ws-note-hider_big .ws-note-hider__count{width:28px}.informers-informerPanel .ws-note-hider{float:right}.ws-note-panel-hider{height:24px;width:24px;line-height:24px;position:relative;float:left;margin-left:0;margin-top:0;top:0;text-align:center;cursor:pointer;box-sizing:border-box;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;z-index:1000}.ws-note-hider__count{width:20px;color:#000;font-family:TensorFont,sans-serif;font-size:14px}.ws-note-panel-hider .ws-note-hider__count{position:absolute;line-height:26px;left:0}.ws-notes-hider-container .ws-note-hider{margin-left:0;top:0!important}.billing-page .ws-note-hider{height:30px;line-height:28px;margin-left:12px}.billing-page #informerPanel .ws-note-hider{top:-2px!important}.ws-note-hider.ws-hider_fletching{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAoCAYAAAD+MdrbAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAARVJREFUeNpifP/+wn8GKgIWEMH7o5sqhn3mKGVgYqAyGDVw1MBRA0cNHDVw1MBRA0cNHDVwUBr4j5Gf+AYnPvCHWZXhF7Mxw18mWQbmf48Z2P8cBdMku/A3sw7DV/Z0hu+sAQz/Gfl2AoUS/zJJP/3GFsHwnS0Qp4tRXPifkZ3hDxPQRSzWQDbnH8b/3/YChTP4BO0eQJUs+PDhYsIfJqWWP+wq0qx/rzCw/TnGwPT/I9wMRlCjnefnJKC3TBh+sxiDHP2H6d+7pX+ZxAsEBPQ/4PIByGBgyLYA1cMN/sqeBjGQkeEnw38G5l+M/79P/8/I24DPIHwGgwWABn748O7wBCAt8P//fwZyMVB/wvv3554ABBgACWKX/MCWsg0AAAAASUVORK5CYII=) bottom right no-repeat}.ws-note-hider__count,.ws-note-hider_expanded .ws-note-hider__toggle{display:inline-block;background:0 0}"));head.appendChild(style);});}
define('js!SBIS3.Notes.Hider',['Core/EventBus','Core/detection','SBIS3.CONTROLS/CompoundControl','tmpl!SBIS3.Notes.Hider','js!SBIS3.Notes.PanelData','css!SBIS3.Notes.Hider','SBIS3.CONTROLS/Link','Zametki_localization'],function(e,t,i,n,s){'use strict';var o=i.extend({_dotTplFn:n,$protected:{_options:{onPanel:false,activableByClick:false},_eventNamespace:'.noteshider',_alreadyProcessed:false,_wasOpened:false},init:function(){if(o.superclass.init.call(this),this.setVisible(false),this._dom={hider:this.getContainer(),count:this.getContainer().find('.ws-note-hider__count'),informerPanel:$('.informers-informerPanel')},!this._dom.informerPanel.length)this._dom.informerPanel=$('#informerPanel');if(this._count=0,this._onPanel=false,this._options.onPanel&&s)if(s.getTop()){var t=s.getTop().containerId?'#'+s.getTop().containerId:'.edo-Dialog-head__first-line',i=$(t).closest('.ws-sticky-header__wrapper'),n=$(i).find('.ws-notes-hider-container');if(n.length)this._dom.informerPanel=n,this._onPanel=true,this._panelId=s.getTop().containerId;this.hiderProcess(15);}var r=this;if(!this._onPanel)require(['Core/UserInfo'],function(e){if('__сбис__биллинг'===e.get('ЛогинКлиента'))r.hiderProcess(15);});this.subscribeTo(e.channel('navigation'),'accordeonVisibilityStateChange',this._onAccordeonStateChange.bind(this)),this.subscribeTo(e.channel('navigation'),'onAccTransform',this._onAccordeonStateChange.bind(this)),this.subscribeTo(e.channel('NoteCommands'),'setHiderCount',function(e,t){this.setCount(t);}.bind(this)),this.subscribeTo(e.channel('NoteCommands'),'setHiderVisible',function(e,t){this.setVisible(t);}.bind(this)),this.subscribeTo(e.channel('NoteCommands'),'CloseExtendedHider',function(){if(this._extendedHider)this._extendedHider.close();}.bind(this)),this.subscribeTo(e.channel('NotesEvents'),'onExtendedHiderComplete',function(){if(this._extendedHider&&this._toggleLocalIndicator)this._toggleLocalIndicator(this._extendedHider.getContainer(),false);}.bind(this)),this.subscribeTo(e.channel('NoteCommands'),'setHiderFletching',function(e,t){this.setHiderFletching(t);}.bind(this));},hiderProcess:function(e){if(!this._dom.informerPanel.length)if(this._dom.informerPanel=$('.informers-informerPanel'),!this._dom.informerPanel.length)this._dom.informerPanel=$('#informerPanel');var i=this;if(!this._onPanel&&!this._dom.informerPanel.length&&e>0)return e--,void setTimeout(function(){i.hiderProcess(e);},500);this.setVisible(this._count>0),this._dom.hider.on('mouseenter'+this._eventNamespace,function(){if(!t.isMobilePlatform)$(this).addClass('ws-note-hider_expanded');return false;}).on('mouseleave'+this._eventNamespace,function(){return $(this).removeClass('ws-note-hider_expanded'),false;}).on('touchstart'+this._eventNamespace,function(){return i.openExtendedHider(),false;}).on('click'+this._eventNamespace,function(){return i.openExtendedHider(),false;}).on('mousedown'+this._eventNamespace,false),this._dom.hider.add(this._dom.hider.children()).attr('unselectable','on').on('selectstart',false),this._alreadyProcessed=true,this.positionHider();},destroy:function(){o.superclass.destroy.call(this),this._dom.hider.off(this._eventNamespace),this._dom=this._extendedHider=null;},_onWindowResize:function(){this.positionHider();},setCount:function(e){if(this._count=e,this._dom.count.text(this._count>99?'99+':this._count),this._dom.hider.toggleClass('ws-note-hider_big',this._count>=100),this._alreadyProcessed)this.toggle(e>0);},setZIndex:function(e){this._dom.hider.css('z-index',e);},setHiderFletching:function(e){this._options.showNotes=e,this._dom.hider.attr('title',e?rk('Скрыть заметки'):rk('Показать заметки')),this._dom.hider.toggleClass('ws-hider_fletching',e);},openExtendedHider:function(){var e=this;if(this._extendedHider&&this._extendedHider.isVisible())return void this._extendedHider.close();require(['SBIS3.CONTROLS/FloatArea','Core/helpers/Hcontrol/toggleLocalIndicator','js!SBIS3.Notes.ExtendedHider'],function(t,i){e._toggleLocalIndicator=i,new t({visible:true,parent:e,opener:e,template:'<component data-component="SBIS3.Notes.ExtendedHider"></component>',element:$('<div class="ws-note__extHider-form"></div>'),target:e.getContainer(),animation:'slide',animationLength:700,direction:'bottom',autoCloseOnHide:true,activableByClick:false,closeByExternalClick:false,closeByExternalOver:false,corner:'tl',locationStrategy:'bodyBounds',closeButton:false,_canScroll:true,verticalAlign:{side:'top',offset:0},horizontalAlign:{side:'left',offset:24},handlers:{onReady:function(){if(e._extendedHider=this,!e._wasOpened)e._wasOpened=true,e._toggleLocalIndicator(this.getContainer(),true);}}}).show();});},setColor:function(e){var t='ws-note-hider_color-',i=t+[0,1,2,3,4].join(' '+t);this._dom.hider.removeClass(i).addClass(t+e);},hideHider:function(){if(this._dom.informerPanel)this._dom.informerPanel.removeClass('hasNotes'),this.setVisible(false);},positionHider:function(){if(this._dom.informerPanel.length){if(this.getContainer().removeAttr('style'),this.getContainer().css('margin-top: 8px'),this._dom.informerPanel.append(this._dom.hider),this._onPanel)this._dom.informerPanel.addClass('hasNotes');}else this.getContainer().attr('style','top: 0!important'),this.getContainer().css('margin-left',$('body').hasClass('compact-menu')?60:210);},_onAccordeonStateChange:function(){this.positionHider();}});return o;});
define('js!SBIS3.Notes.TouchDragNDropMixin',['Zametki_localization'],function(){'use strict';return{preparePageXY:function(t){if('touchstart'===t.type||'touchmove'===t.type)t.pageX=t.originalEvent.touches[0].pageX,t.pageY=t.originalEvent.touches[0].pageY;},after:{_setItemsDragNDrop:function(t){this._getItemsContainer()[t?'on':'off']('touchstart','.js-controls-ListView__item',this._getDragInitHandler());}}};});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.NoteListView", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-note_color-0,.ws-window.ws-note_color-0{background:#fffd9d}.ws-note__body .controls-ScrollContainer.controls-ScrollContainer__bottom-gradient:after{background:-moz-linear-gradient(top,rgba(255,253,157,0) 0,rgba(255,253,157,.1) 15%,rgba(255,253,157,.5) 30%,rgba(255,253,157,.99) 70%,rgba(255,253,157,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(255,253,157,0)),color-stop(15%,rgba(255,253,157,.1)),color-stop(30%,rgba(255,253,157,.5)),color-stop(70%,rgba(255,253,157,.99)),color-stop(100%,rgba(255,253,157,1)));background:-webkit-linear-gradient(top,rgba(255,253,157,0) 0,rgba(255,253,157,.1) 15%,rgba(255,253,157,.5) 30%,rgba(255,253,157,.99) 70%,rgba(255,253,157,1) 100%);background:-o-linear-gradient(top,rgba(255,253,157,0) 0,rgba(255,253,157,.1) 15%,rgba(255,253,157,.5) 30%,rgba(255,253,157,.99) 70%,rgba(255,253,157,1) 100%);background:-ms-linear-gradient(top,rgba(255,253,157,0) 0,rgba(255,253,157,.1) 15%,rgba(255,253,157,.5) 30%,rgba(255,253,157,.99) 70%,rgba(255,253,157,1) 100%);background:linear-gradient(to bottom,rgba(255,253,157,0) 0,rgba(255,253,157,.1) 15%,rgba(255,253,157,.5) 30%,rgba(255,253,157,.99) 70%,rgba(255,253,157,1) 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#00fffd9e', endColorstr='#fffd9e', GradientType=0);height:31px;position:absolute;content:'';width:100%;display:block}.ws-note__body .controls-ScrollContainer.controls-ScrollContainer__bottom-gradient:after,.ws-note__body .controls-ScrollContainer.controls-ScrollContainer__top-gradient:before{z-index:10000}.ws-note-date-html{text-align:right;float:right;margin-right:8px;margin-top:6px;font-size:11px;color:#999}.ws-note_color-1,.ws-window.ws-note_color-1{background:#dffcad}.ws-note__body.ws-note_color-1 .controls-ScrollContainer.controls-ScrollContainer__bottom-gradient:after{background:-moz-linear-gradient(top,rgba(223,252,173,0) 0,rgba(223,252,173,.1) 15%,rgba(223,252,173,.5) 30%,rgba(223,252,173,.99) 70%,rgba(223,252,173,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(223,252,173,0)),color-stop(15%,rgba(223,252,173,.05)),color-stop(50%,rgba(223,252,173,.5)),color-stop(80%,rgba(223,252,173,.99)),color-stop(100%,rgba(223,252,173,1)));background:-webkit-linear-gradient(top,rgba(223,252,173,0) 0,rgba(223,252,173,.1) 15%,rgba(223,252,173,.5) 30%,rgba(223,252,173,.99) 70%,rgba(223,252,173,1) 100%);background:-o-linear-gradient(top,rgba(223,252,173,0) 0,rgba(223,252,173,.1) 15%,rgba(223,252,173,.5) 30%,rgba(223,252,173,.99) 70%,rgba(223,252,173,1) 100%);background:-ms-linear-gradient(top,rgba(223,252,173,0) 0,rgba(223,252,173,.1) 15%,rgba(223,252,173,.5) 30%,rgba(223,252,173,.99) 70%,rgba(223,252,173,1) 100%);background:linear-gradient(to bottom,rgba(223,252,173,0) 0,rgba(223,252,173,.1) 15%,rgba(223,252,173,.5) 30%,rgba(223,252,173,.99) 70%,rgba(223,252,173,1) 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#00dffcac', endColorstr='#dffcac', GradientType=0)}.ws-note_color-4,.ws-window.ws-note_color-4{background:#c9eeff}.ws-note__body.ws-note_color-4 .controls-ScrollContainer.controls-ScrollContainer__bottom-gradient:after{background:-moz-linear-gradient(top,rgba(201,238,255,0) 0,rgba(201,238,255,.1) 15%,rgba(201,238,255,.5) 30%,rgba(201,238,255,.99) 70%,rgba(201,238,255,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(201,238,255,0)),color-stop(15%,rgba(201,238,255,.05)),color-stop(50%,rgba(201,238,255,.5)),color-stop(80%,rgba(201,238,255,.99)),color-stop(100%,rgba(201,238,255,1)));background:-webkit-linear-gradient(top,rgba(201,238,255,0) 0,rgba(201,238,255,.1) 15%,rgba(201,238,255,.5) 30%,rgba(201,238,255,.99) 70%,rgba(201,238,255,1) 100%);background:-o-linear-gradient(top,rgba(201,238,255,0) 0,rgba(201,238,255,.1) 15%,rgba(201,238,255,.5) 30%,rgba(201,238,255,.99) 70%,rgba(201,238,255,1) 100%);background:-ms-linear-gradient(top,rgba(201,238,255,0) 0,rgba(201,238,255,.1) 15%,rgba(201,238,255,.5) 30%,rgba(201,238,255,.99) 70%,rgba(201,238,255,1) 100%);background:linear-gradient(to bottom,rgba(201,238,255,0) 0,rgba(201,238,255,.1) 15%,rgba(201,238,255,.5) 30%,rgba(201,238,255,.99) 70%,rgba(201,238,255,1) 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#00b4e8fe', endColorstr='#b4e8fe', GradientType=0)}.ws-note_color-2,.ws-window.ws-note_color-2{background:#ffd5b9}.ws-note__body.ws-note_color-2 .controls-ScrollContainer.controls-ScrollContainer__bottom-gradient:after{background:-moz-linear-gradient(top,rgba(255,213,185,0) 0,rgba(255,213,185,.1) 15%,rgba(255,213,185,.5) 30%,rgba(255,213,185,.99) 70%,rgba(255,213,185,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(255,213,185,0)),color-stop(15%,rgba(255,213,185,.05)),color-stop(50%,rgba(255,213,185,.5)),color-stop(80%,rgba(255,213,185,.99)),color-stop(100%,rgba(255,213,185,1)));background:-webkit-linear-gradient(top,rgba(255,213,185,0) 0,rgba(255,213,185,.1) 15%,rgba(255,213,185,.5) 30%,rgba(255,213,185,.99) 70%,rgba(255,213,185,1) 100%);background:-o-linear-gradient(top,rgba(255,213,185,0) 0,rgba(255,213,185,.1) 15%,rgba(255,213,185,.5) 30%,rgba(255,213,185,.99) 70%,rgba(255,213,185,1) 100%);background:-ms-linear-gradient(top,rgba(255,213,185,0) 0,rgba(255,213,185,.1) 15%,rgba(255,213,185,.5) 30%,rgba(255,213,185,.99) 70%,rgba(255,213,185,1) 100%);background:linear-gradient(to bottom,rgba(255,213,185,0) 0,rgba(255,213,185,.1) 15%,rgba(255,213,185,.5) 30%,rgba(255,213,185,.99) 70%,rgba(255,213,185,1) 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#00ffcba9', endColorstr='#ffcba9', GradientType=0)}.ws-note_color-3,.ws-window.ws-note_color-3{background:#ecd6ec}.ws-note__body.ws-note_color-3 .controls-ScrollContainer.controls-ScrollContainer__bottom-gradient:after{background:-moz-linear-gradient(top,rgba(236,214,236,0) 0,rgba(236,214,236,.1) 15%,rgba(236,214,236,.5) 30%,rgba(236,214,236,.99) 70%,rgba(236,214,236,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(236,214,236,0)),color-stop(15%,rgba(236,214,236,.99)),color-stop(50%,rgba(236,214,236,.5)),color-stop(80%,rgba(236,214,236,.99)),color-stop(100%,rgba(236,214,236,1)));background:-webkit-linear-gradient(top,rgba(236,214,236,0) 0,rgba(236,214,236,.1) 15%,rgba(236,214,236,.5) 30%,rgba(236,214,236,.99) 70%,rgba(236,214,236,1) 100%);background:-o-linear-gradient(top,rgba(236,214,236,0) 0,rgba(236,214,236,.1) 15%,rgba(236,214,236,.5) 30%,rgba(236,214,236,.99) 70%,rgba(236,214,236,1) 100%);background:-ms-linear-gradient(top,rgba(236,214,236,0) 0,rgba(236,214,236,.1) 15%,rgba(236,214,236,.5) 30%,rgba(236,214,236,.99) 70%,rgba(236,214,236,1) 100%);background:linear-gradient(to bottom,rgba(236,214,236,0) 0,rgba(236,214,236,.1) 15%,rgba(236,214,236,.5) 30%,rgba(236,214,236,.99) 70%,rgba(236,214,236,1) 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#00f8f8f8', endColorstr='#f8f8f8', GradientType=0)}.controls-ListView .ws-note.controls-ListView__item.controls-ListView__hoveredItem{background-color:transparent}.ws-note__footer{-moz-user-select:none;-o-user-select:none;-khtml-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none;position:absolute;bottom:1px;background:inherit;width:100%;font-size:0;margin-bottom:-1px;min-height:6px;z-index:210;padding-bottom:8px}.ws-note__has-files .ws-note__footer{background:rgba(255,255,255,.45)}.ws-note__indicator{position:absolute;top:0;bottom:0;left:0;right:0;background:url(/ws/lib/Control/AreaAbstract/resources/images/ajax-loader-indicator.v1516270649826335cf4508dd597be4bfc9caa3e08b901.gif) no-repeat scroll center #fff;opacity:.4;display:none;z-index:250}.ws-note_blocked .ws-note__indicator{display:block}.ws-note__body .ws-note__content .ws-basic-style img.LinkDecorator__image{height:48px;padding:0!important;margin:0!important}.ws-note__body .ws-note__content .ws-basic-style .LinkDecorator__linkWrap{position:absolute}.ws-note__body .ws-note__content .ws-basic-style .LinkDecorator__linkWrap.LinkDecorator__disableBlur:after{display:none}.ws-note__body .ws-note__content .ws-basic-style .LinkDecorator__wrap{margin-top:2px;width:540px;max-width:100%;position:relative}.ws-note_color-0 .ws-note__actions{-webkit-box-shadow:1px 1px 8px 4px #fffd9d;-moz-box-shadow:3px 3px 5px 4px #fffd9d;box-shadow:1px 1px 8px 4px #fffd9d}.ws-note_color-1 .ws-note__actions{-webkit-box-shadow:1px 1px 8px 4px #dffcad;-moz-box-shadow:3px 3px 5px 4px #dffcad;box-shadow:1px 1px 8px 4px #dffcad}.ws-note_color-2 .ws-note__actions{-webkit-box-shadow:1px 1px 8px 4px #ffd5b9;-moz-box-shadow:3px 3px 5px 4px #ffd5b9;box-shadow:1px 1px 8px 4px #ffd5b9}.ws-note_color-3 .ws-note__actions{-webkit-box-shadow:1px 1px 8px 4px #ecd6ec;-moz-box-shadow:3px 3px 5px 4px #ecd6ec;box-shadow:1px 1px 8px 4px #ecd6ec}.ws-note_color-4 .ws-note__actions{-webkit-box-shadow:1px 1px 8px 4px #c9eeff;-moz-box-shadow:3px 3px 5px 4px #c9eeff;box-shadow:1px 1px 8px 4px #c9eeff}"));head.appendChild(style);});}
define('js!SBIS3.Notes.NoteListView',['Core/core-instance','Core/helpers/Array/findIndex','Core/EventBus','Core/detection','SBIS3.CONTROLS/ListView','js!SBIS3.Notes.Note','js!SBIS3.Notes.NoteFiles','js!SBIS3.Notes.NoteTags','js!SBIS3.Notes.TouchDragNDropMixin','js!SBIS3.ENGINE.LinkValidator','js!SBIS3.Notes.NoteActions','css!SBIS3.Notes.NoteListView','Zametki_localization'],function(e,t,n,s,i,o,r,a,c,l){'use strict';function h(){throw new Error('Method not implemented');}function u(e){var t=$(e).closest('.ws-note');if(t.length){var n=new Date(t.data('lastDrag')||0);return new Date()-n<150;}return false;}var d=i.extend([c],{$protected:{_options:{idProperty:'id',displayProperty:'text',nodeProperty:'node',multiselect:false,itemSelect:true,itemsActions:[]},_lightMode:false,_eventNamespace:'.note-list-view'},$constructor:function(){this._publish('onItemDoubleClick');},init:function(){d.superclass.init.call(this),this._isStatic=e.instanceOfModule(this,'SBIS3.Notes.StaticNoteListView');var t=this;this._initDataSource(),this.getContainer().on('mouseup'+this._eventNamespace+' touchend'+this._eventNamespace,'.ws-note__body',this._onMouseUp.bind(this)).on('touchstart'+this._eventNamespace,this._onTouchStart.bind(this)).on('click'+this._eventNamespace,'a',this._onLinkClick.bind(this)).on((s.isMobilePlatform?'touchstart':'click')+this._eventNamespace,'.ws-note__checkable',this._onCheckableClick.bind(this)),this.subscribeTo(this,'onDrawItems',function(){if(!this._disableRedraw)r.loadFilePreviews(this);}),this.subscribeTo(this,'onDrawItems',this._onDrawItems);var i=n.channel('NotesEvents');this.subscribeTo(i,'onTagFormOpened',function(){t._isTagFormOpened=true;}),this.subscribeTo(i,'onTagFormClosed',function(){t._isTagFormOpened=false;}),this.subscribeTo(i,'onPinMenuOpened',function(){t._isPinMenuOpened=true;}),this.subscribeTo(i,'onPinMenuClosed',function(){t._isPinMenuOpened=false;}),this.subscribeTo(i,'onNoteOpen',this._onMouseUp.bind(this));},destroy:function(){d.superclass.destroy.call(this),this.getContainer().off(this._eventNamespace);},_initDataSource:h,_onDrawItems:h,_setRedrawCommand:function(e){this._options.autoRedraw=e;},_onLinkClick:function(e){if(u(e.target))e.preventDefault();},isCheckboxArea:function(e){var t,n,s=0,i=0;if('touchstart'===e.type||'touchend'===e.type){if(t=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0],n=$(e.target).offset(),t)s=t.pageX-n.left,i=t.pageY-n.top;}else s=e.offsetX,i=e.offsetY;return s<=17;},_onCheckableClick:function(e){var t=$(e.target);if(e.target===e.currentTarget&&this.isCheckboxArea(e)){t.toggleClass('ws-note__checkable_checked').toggleClass('ws-note__checkable_unchecked');var n=this,s=t.closest('.ws-note'),i=s.find('.ws-note__checkable').index(t),o=s.data('id'),r=this.findNoteById(o),a=$('<div></div>').append(r.text);a.find('.ws-note__checkable:eq('+i+')').toggleClass('ws-note__checkable_checked').toggleClass('ws-note__checkable_unchecked'),r.text=a.html(),r.save().addCallback(function(){if(n._isStatic){var e=n.getItems(),t=e.getRecordById(o);e.setEventRaising(false),t.set('Content',r.text),e.setEventRaising(true);}});}},_manualLinkOpenForMobiles:function(e){if(s.isMobilePlatform&&!this._isStatic)if(l.linkClickHandler(e),false===e.originalEvent.defaultPrevented)window.open(e.target.href);},_openLinkTarget:function(e){var t=e?e.target?$(e.target):null:null;if(t&&t.closest('a').length){var n=e.target.href;if(!n&&'IMG'===e.target.nodeName)n=e.target.parentElement.href,window.open(n);else this._manualLinkOpenForMobiles(e);}else if(t.closest('.dv-bigpreview-item').length)t.click();},_onMouseUp:function(e,t,s){var i=5;if(s&&'onNoteOpen'===e.name)e=t;if('touchend'===e.type)n.channel('DragAndDropChannel').notify('onMouseup',e);var o=e?e.target?$(e.target):null:null;if(this._isDragDropStarted||o&&o.hasClass('controls-Scrollbar__thumb'))return void(this._isDragDropStarted=false);if('touchend'===e.type){var r=e.originalEvent.changedTouches[0].pageX,a=e.originalEvent.changedTouches[0].pageY;if(this._scrollStarted){if(this._currentTouchedX&&this._currentTouchedY&&(Math.abs(r-this._currentTouchedX)>i||Math.abs(a-this._currentTouchedY)>i));else this._openLinkTarget(e);return void(this._scrollStarted=false);}if(this._currentPressedX&&this._currentPressedY&&(Math.abs(r-this._currentPressedX)>i||Math.abs(a-this._currentPressedY)>i))return void(this._currentPressedX=this._currentPressedY=null);else this._openLinkTarget(e);}if(!o||e.which>1||o.hasClass('controls-Button__icon')||o.hasClass('controls-Button__wrapper')||o.hasClass('controls-IconButton')||o.closest('a').length||o.closest('.dv-bigpreview-item').length||o.closest('.ws-note__checkable').length&&this.isCheckboxArea(e)||this._dragData&&this._dragData.noteId)return;var c;if(o)c=o.closest('.ws-note').data('id');if(c)this.setSelectedKey(c),this._closeSubforms(),this._notify('onItemDoubleClick',this.findNoteById(c),this.getSelectedItem());},_mouseMoveHandler:function(e){if(!this._isTagFormOpened&&!this._isPinMenuOpened)d.superclass._mouseMoveHandler.call(this,e);},_manualChangeHoveredItem:function(e){var t=this._findItemByElement(e);if(t.length)this._changeHoveredItem(t);},_onTouchStart:function(e){this._mouseMoveHandler(e),this._manualChangeHoveredItem($(e.target));var t=!!$(e.target).closest('.controls-DragNDropMixin__notDraggable').length;if(this._scrollStarted=t,t)this._currentTouchedX=e.originalEvent.changedTouches[0].pageX,this._currentTouchedY=e.originalEvent.changedTouches[0].pageY;},_closeSubforms:function(){(this.getChildControls()||[]).forEach(function(t){if(e.instanceOfModule(t,'SBIS3.Notes.TagButton'))t.closeForm();});},getNoteElement:function(e){return this.getContainer().find('.ws-note[data-id="'+e+'"]');},getNotes:function(e){if(e)return this.getItems();var t=this.getItems(),n=[];if(t)if(this._isStatic)t.each(function(e){n.push(new o(e,true));});else if(n=t.getRawData(),n)n.sort(function e(t,n){return t.order-n.order;});return n||[];},getNoteCount:function(){return this.getNotes().length;},removeNote:function(e){var t=this.getNotes().splice(e,1),n=this.getDataSource(),s=this.getItems(),i=s.getRecordById(t[0].id);if(s.remove(i),!this._isStatic&&s.getCount()<n._$data.length)n.destroy(t[0].id);return t[0];},findNoteById:function(e){var t=this.getNotes().filter(function(t){return t.id===e;});return t&&t.length?t[0]:null;},findNoteByBaseId:function(e){var t=this.getNotes().filter(function(t){return t.baseId===e;});return t&&t.length?t[0]:null;},findNoteIndexById:function(e){return t(this.getNotes(),function(t){return t.id===e;});},removeNoteById:function(e){var t=this.findNoteIndexById(e);return t>=0?this.removeNote(t):null;},sync:function(e){var t=this.getItems().getRecordById(e.id);if(t)t.set('pinnedToPanel',e.pinnedToPanel),t.set('isAuthor',e.isAuthor),t.set('panelId',e.panelId),t.set('panelObject',e.panelObject),t.set('containerId',e.containerId);},cropNote:function(e){var t=this._isStatic?0:12,n=40,i=e.find('.ws-note__body'),o=i.find('.ws-note__scroll'),r=o.find('.ws-note__content'),c=r.find('.ws-basic-style'),l=e.find('.ws-note__footer'),h=e.width()-n;if(a.prototype._resizeTags(e),i.css('padding-bottom',l.height()),s.isMobilePlatform){var u=r[0].scrollHeight+t>o.height();o.toggleClass('controls-DragNDropMixin__notDraggable',u);}var d=c.find('.LinkDecorator__image');if(d.length)d.each(function(){$(this.parentElement).toggleClass('LinkDecorator__disableBlur',$(this).width()<h);});},cropNotes:function(){var e=this;this._getNoteElements().each(function(t,n){e.cropNote($(n));});},_getNoteElements:function(){return this.getContainer().find('.ws-note');},_mouseLeaveHandler:function(e){if((!e||0===$(e.relatedTarget).closest('.ws-note__pin-menu').length&&0===$(e.relatedTarget).closest('.ws-note__tag-form').length)&&!this._isTagFormOpened)d.superclass._mouseLeaveHandler.call(this,e);},addImageLoadCallback:function(e,t){e.each(function(){$(this).one('load',t);});}});return d;});
define("html!SBIS3.Notes.DynamicNoteListView/DynamicNote",function(){var e=function(e){var t=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(t){for(;e.test(t);)t=t.replace(e,"&#123;&#123;$1&#125;&#125;");return t}}(),n=function(e){return e.join?e.join(""):e.toString()},r=function(e){return void 0===e?"":e&&"object"==typeof e?n(e):""+e},i="undefined"!=typeof process,o=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,""),a=e.item.getRawData();return e.className="ws-note ws-note_dynamic ws-hidden",a.isHidden&&(e.className+=" ws-note_hidden"),e.attributes=a.viewModel.attributes,o+=" "+t(r(e.defaultItemTpl(e,e.attributes))),(o=t(o))+(i&&-1!==o.indexOf("{{")?String.fromCharCode(8203,8203):"")};return e.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.DynamicNoteListView/DynamicNote"}},e});
define("html!SBIS3.Notes.DynamicNoteListView/DynamicNoteContent",function(){var e=function(e){var n=function(){var e={"&":"&#38;","<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","/":"&#47;"},n=/&(?!#?\w+;)|<|>|"|'|\//g;return function(o){return o?o.toString().replace(n,function(n){return e[n]||n}):o}}(),o=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;e.test(n);)n=n.replace(e,"&#123;&#123;$1&#125;&#125;");return n}}(),t=function(e){return e.join?e.join(""):e.toString()},s=function(e){return void 0===e?"":e&&"object"==typeof e?t(e):""+e},r="undefined"!=typeof process,i=("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),a=function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,c="",d=e.item.getRawData(),_=d.viewModel.text,l=d.tags,v=l.length;if(c+=' <div class="ws-note__border" unselectable="on"> <div class="ws-note__corner ws-note__corner_top-left"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__corner ws-note__corner_top"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__corner ws-note__corner_top-right"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__corner ws-note__corner_right"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__corner ws-note__corner_bottom-right"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__corner ws-note__corner_bottom"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__corner ws-note__corner_bottom-left"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__corner ws-note__corner_left"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__body ws-note_color-'+o(s(d.color))+" ",!d.pinnedToPanel||d.isAuthor||d.canEdit||(c+="ws-note_move"),c+='" unselectable="on"> ',d.pinnedToPanel&&(c+=' <div class="ws-note-header-image__panel"> <span class="ws-note-header-image ws-note-header-image_shared icon-16 icon-Groups icon-disabled"></span> </div> '),c+=' <component data-component="SBIS3.CONTROLS/ScrollContainer" class="ws-note__scroll" name="scrollContainerNote_'+o(s(d.id))+'"> <option name="content"> <div class="ws-note__content"> <div class="ws-basic-style">'+o(s(e.Sanitize(_)))+'</div> <component data-component="SBIS3.Notes.NoteFiles" name="NoteFiles_'+o(s(d.id))+'"> <option name="noteRecord" type="ref" value="'+o(s(function(e,n){var o=i.randomId();return e[o]=n,o}(a,e.item)))+'"></option> </component> </div> </option> </component> <div class="ws-note__footer"> <div class="ws-note-tags-html ',d.title&&(c+="ws-note__has-calendar"),c+='"> ',v){c+=" ";var w=l;if(w)for(var p,m=-1,u=w.length-1;m<u;)c+=' <span class="ws-note__tag ws-note__tag_color-'+o(s((p=w[m+=1]).color))+'">'+o(s(n(p.name)))+"</span> ";c+=' <span class="ws-note-tags__ellipsis ws-hidden">'+o(s(rk("...")))+"</span> "}return c+=" </div> ",d.title&&(c+=' <span class="ws-note-header-image icon-16 icon-Bell"></span> <span class="ws-note-calendar-html">'+o(s(n(d.title)))+"</span> "),c+=' </div> <component data-component="SBIS3.Notes.NoteActions"> <option name="noteId">'+o(s(d.id))+'</option> <option name="showShare">'+o(s(d.pinnedToPanel))+'</option> <option name="isAuthor">'+o(s(d.isAuthor))+'</option> <option name="isHidden">'+o(s(d.isHidden))+'</option> <option name="noteRecord" type="ref" value="'+o(s(function(e,n){var o=i.randomId();return e[o]=n,o}(a,e.item)))+'"></option> </component> <div class="ws-note__indicator"></div> </div> <div class="ws-note-tmp"></div> </div> <div class="ws-note-shadow"> <div class="ws-note-shadow__left"></div> <div class="ws-note-shadow__right"></div> </div>',(c=o(c))+(r&&-1!==c.indexOf("{{")?String.fromCharCode(8203,8203):"")};return e.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.DynamicNoteListView/DynamicNoteContent"}},e});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.DynamicNoteListView", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-note__corner{position:absolute;display:none}.ws-note__corner-marker{width:9px;height:9px;border-radius:5px;position:absolute;background:#bbb}.ws-note__corner_top-left{top:0;left:0}.ws-note__corner_top{top:0;left:50%}.ws-note__corner_top-right{top:0;right:0}.ws-note__corner_right{top:50%;right:0}.ws-note__corner_bottom-right{bottom:0;right:0}.ws-note__corner_bottom{bottom:0;left:50%}.ws-note__corner_bottom-left{bottom:0;left:0}.ws-note__corner_left{top:50%;left:0}.ws-note__corner_bottom .ws-note__corner-marker,.ws-note__corner_left .ws-note__corner-marker,.ws-note__corner_right .ws-note__corner-marker,.ws-note__corner_top .ws-note__corner-marker{width:5px;height:5px;border-radius:3px}.ws-note__corner_top .ws-note__corner-marker{top:-3px;left:-3px}.ws-note__corner_bottom .ws-note__corner-marker{bottom:-3px;left:-3px}.ws-note__corner_right .ws-note__corner-marker{top:-3px;right:-3px}.ws-note__corner_left .ws-note__corner-marker{top:-3px;left:-3px}.ws-note__corner_top-right .ws-note__corner-marker{top:-5px;right:-5px}.ws-note__corner_top-left .ws-note__corner-marker{top:-5px;left:-5px}.ws-note__corner_bottom-right .ws-note__corner-marker{bottom:-5px;right:-5px}.ws-note__corner_bottom-left .ws-note__corner-marker{bottom:-5px;left:-5px}.ws-note__corner:before{content:'';display:block;width:45px;height:45px;margin:-18px}.ws-note__corner_current:before{content:'';width:80px;height:80px;position:absolute;top:-40px;left:-40px}.ws-note__corner_bottom-left,.ws-note__corner_top-right{cursor:ne-resize}.ws-note__corner_bottom-right,.ws-note__corner_top-left{cursor:nw-resize}.ws-note__corner_bottom,.ws-note__corner_top{cursor:n-resize}.ws-note__corner_left,.ws-note__corner_right{cursor:e-resize}.ws-note_dynamic{width:256px;min-width:246px;height:80px;min-height:80px;padding:0;margin:0;overflow:visible!important;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}.ws-note-list_dynamic .controls-ListView__item.ws-note_dynamic{position:fixed;box-sizing:border-box}.ws-note__border{position:absolute;left:6px;top:6px;right:6px;bottom:6px;box-sizing:border-box;overflow:visible;margin:1px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}.controls-ListView__hoveredItem .ws-note__border{border:1px dashed #bbb;left:5px;top:5px;right:5px;bottom:5px}.controls-ListView__hoveredItem .ws-note__corner{display:block}.ws-note_blocked.controls-ListView__hoveredItem .ws-note__border{border:0;left:6px;top:6px;right:6px;bottom:6px}.ws-note_blocked.controls-ListView__hoveredItem .ws-note__corner{display:none}.ws-note_dynamic .ws-note__body{position:absolute;left:6px;top:6px;right:6px;bottom:6px;box-sizing:border-box;display:block;overflow:hidden;cursor:pointer;-moz-user-select:none;-o-user-select:none;-khtml-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none}.ws-note_dynamic .ws-note__body .ws-note__content .ws-basic-style img:not(.LinkDecorator__image){max-width:100%!important;height:auto!important}.ws-note_dynamic .ws-note-shadow{left:12px;right:12px;bottom:7px}body.dragdropBody{-moz-user-select:none;-khtml-user-select:none;-webkit-user-select:none;user-select:none}.ws-note_dynamic .ws-note-tags-html{max-height:48px}.ws-note__body.ws-note_move{cursor:move}.ws-note-header-image_shared{right:6px;bottom:10px;position:absolute}.ws-note-header-image__panel{position:absolute;right:0;top:0;padding-top:4px;width:30px;height:30px;background:inherit;border-radius:0 0 0 14px;z-index:300}.ws-note_color-0 .ws-note-header-image__panel{-webkit-box-shadow:1px 1px 8px 4px #fffd9d;-moz-box-shadow:3px 3px 5px 4px #fffd9d;box-shadow:1px 1px 8px 4px #fffd9d}.ws-note_color-1 .ws-note-header-image__panel{-webkit-box-shadow:1px 1px 8px 4px #dffcad;-moz-box-shadow:3px 3px 5px 4px #dffcad;box-shadow:1px 1px 8px 4px #dffcad}.ws-note_color-2 .ws-note-header-image__panel{-webkit-box-shadow:1px 1px 8px 4px #ffd5b9;-moz-box-shadow:3px 3px 5px 4px #ffd5b9;box-shadow:1px 1px 8px 4px #ffd5b9}.ws-note_color-3 .ws-note-header-image__panel{-webkit-box-shadow:1px 1px 8px 4px #ecd6ec;-moz-box-shadow:3px 3px 5px 4px #ecd6ec;box-shadow:1px 1px 8px 4px #ecd6ec}.ws-note_color-4 .ws-note-header-image__panel{-webkit-box-shadow:1px 1px 8px 4px #c9eeff;-moz-box-shadow:3px 3px 5px 4px #c9eeff;box-shadow:1px 1px 8px 4px #c9eeff}.ws-note_hidden{display:none}.ws-note__infobox-author-title{display:block;min-width:75px;font-size:15px;height:41px;margin-right:5px}.ws-note__infobox-author{display:block;overflow:hidden;height:20px}.ws-infobox-content .ws-note__infobox-content .ws-note__infobox-author>a{overflow:hidden;display:inline-block;text-overflow:ellipsis;text-decoration:none;max-width:400px;font-size:15px}.ws-info-box .ws-note__infobox-content .ws-note__infobox-author>a:hover{text-decoration:underline}.ws-note__infobox-date{height:18px;line-height:22px;display:block;color:#999;font-size:12px}.ws-note__infobox-col-1{display:inline-block;min-width:75px;float:left}.ws-note__infobox-col-2{display:inline-block}.ws-note__infobox-row-1,.ws-note__infobox-row-2{height:41px}.ws-note__infobox-content{overflow:hidden}"));head.appendChild(style);});}
define('js!SBIS3.Notes.DynamicNoteListView',['Core/EventBus','Core/Deferred','Core/constants','SBIS3.CONTROLS/Utils/LinkWrapUtils','js!SBIS3.Notes.NoteListView','html!SBIS3.Notes.DynamicNoteListView/DynamicNote','html!SBIS3.Notes.DynamicNoteListView/DynamicNoteContent','js!SBIS3.Notes.Note','js!SBIS3.BL.Note','js!SBIS3.Notes.PanelData','SBIS3.CONTROLS/ScrollContainer','css!SBIS3.Notes.DynamicNoteListView','Zametki_localization'],function(e,t,i,s,n,o,a,r,h,l){'use strict';var d=-r.NOTE_BODY_PADDING+1;function f(e,t,i){return e<t?t:e>i?i:e;}function c(){return window.pageXOffset||document.documentElement.scrollLeft;}function g(){return window.pageYOffset||document.documentElement.scrollTop;}function u(){return i.$win.width();}function _(){return Math.min(i.$doc.height(),i.$win.height());}function p(){return parseInt(i.$body.css('margin-right'),10)||0;}function m(e){return!!e.find(function(e){return!e.complete||0===e.naturalWidth;});}var w=n.extend({$protected:{_options:{className:'ws-note-list_dynamic',itemTpl:o,itemContentTpl:a},_dragData:null,_isMobile:false,_eventNamespace:'.dynamicNotesListView',_windowWidth:0,_windowHeight:0,_tagsWasChanged:false,_isBeingDragged:false,_hasPostponedReload:false},$constructor:function(){this.subscribeTo(this,'onDataLoad',this._onDataLoad);var t=e.channel('NotesEvents');this.subscribeTo(t,'onTagAdded',this._onTagAdded.bind(this)),this.subscribeTo(t,'onTagUpdated',this._onTagUpdated.bind(this)),this.subscribeTo(t,'onTagRemoved',this._onTagRemoved.bind(this));var s=e.channel('NoteCommands');this.subscribeTo(s,'SetNoteVisible',this._setNoteVisible.bind(this)),this.subscribeTo(s,'SetNotesListVisible',this._setNotesListVisible.bind(this)),this.subscribeTo(s,'RedrawTags',function(e,t){var i=this.getItems().getRecordById(t.id);if(i)i.set('tags',t.tags);}.bind(this)),this.getContainer().on('mouseenter'+this._eventNamespace,'.ws-note-header-image__panel',this._showAuthorInfo.bind(this)),i.$win.on('resize'+this._eventNamespace,this._onWindowResize.bind(this).debounce(250));},destroy:function(){w.superclass.destroy.call(this),this._infobox=null,this.getContainer().off(this._eventNamespace),i.$win.off(this._eventNamespace);},_showAuthorInfo:function(e){var t=$(e.target).closest('.ws-note');if(t.length){var i=this,s=$(t[0]).data('id'),n=s?this.findNoteById(s):null;if(n&&n.baseId)require(['Lib/Control/Infobox/Infobox','tmpl!SBIS3.Notes.DynamicNoteListView/AuthorInfo'],function(t,s){h.getLastChangedInfo(n.baseId).addCallback(function(n){var o={title:rk('Общая заметка'),control:$(e.target).find('.ws-note-header-image').length?$(e.target).find('.ws-note-header-image'):e.target,message:s(n.getRow()),position:'br',autoHide:true,hideDelay:5000};i._infobox=t,i.subscribeOnceTo(i._infobox,'onShow',function(){var e=12,t=80,i=this.getContainer(),s=i.find('.ws-infobox-content');if(s.length)if(s.css('min-width',Math.ceil(s.find('.ws-note__infobox-col-1').width()+s.find('.ws-note__infobox-col-2').width())),i.width()<s.width()+e)s.find('.ws-note__infobox-author > a').width(Math.ceil(i.width()-t-e));}),i._infobox.show(o),i._infoboxOpened=new Date().getTime();});});}},_setNoteElementVisible:function(e,t){var i=this.getNoteElement(e);if(i)if(i.toggleClass('ws-note_hidden',!t),i.find('[name="ShowNote"]').toggleClass('ws-hidden',t),i.find('[name="HideNote"]').toggleClass('ws-hidden',!t),t&&this.hasChildControlByName('scrollContainerNote_'+e))this.getChildControlByName('scrollContainerNote_'+e)._resizeInner();},_setNotesListVisible:function(t,i,s,n){var o=this;h[n?'showNotesList':'hideNotesList'](s),i.forEach(function(e){o._setNoteElementVisible(e,n);}),e.channel('NoteCommands').notify('setHiderFletching',n);},_setNoteVisible:function(t,i,s){if(i&&i.get('baseId'))h[s?'showNote':'hideNote'](i.get('baseId')),this._setNoteElementVisible(i.get('id'),s);if(s)e.channel('NoteCommands').notify('setHiderFletching',true);else{var n=false;if(this.getItems().each(function(e){if(!e.get('isHidden')&&!e.get('pinnedToPanel'))n=true;}),!n)e.channel('NoteCommands').notify('setHiderFletching',false);}},_getNotePositionOnPanel:function(e){if(e.pinnedToPanel){var t=l.getTop();if(t&&t.containerId){var i=e.width,s=$('#'+t.containerId),n=s.offset(),o=parseInt(n.left,10);return{minLeft:o,maxLeft:o+parseInt(s.css('width'),10)-i};}}else return null;},_getWindowWidth:function(){if(!this._windowWidth)this._windowWidth=u();return this._windowWidth;},_getWindowHeight:function(){if(!this._windowHeight)this._windowHeight=_();return this._windowHeight;},_onWindowResize:function(){this._windowWidth=u(),this._windowHeight=_(),this.drawNotes();},_createAvatar:function(){this._avatar=$();},_updateViewModel:function(e){var t=this._getWindowHeight(),i=this._getWindowWidth(),n=d,o=d,a=t-d-e.height,r=i-d-e.width,h=e.getPosition(i,t),l=this._getNotePositionOnPanel(e);if(l)o=l.minLeft,r=l.maxLeft;var c=s.wrapURLs(e.text),g=h.left,u=f(h.top,n,a);if(null!=e.right)g-=parseInt(document.body.style.marginRight||0,10);g=f(g,o,r),e.viewModel={text:c,order:e.order,top:u,left:g,attributes:{style:'top: '+u+'px; left: '+g+'px; width: '+e.width+'px; height: '+e.height+'px; z-index: '+e.order+';',unselectable:'on'}};},_onTagAdded:function(){this._tagsWasChanged=true;},_onTagRemoved:function(e,t,i){var s=this;if(t)this._tagsWasChanged=true;else this.getItems().each(function(e){if(e.getRawData().removeTagWithoutSave(i))s._tagsWasChanged=true;});},_onTagUpdated:function(e,t,i,s,n){var o=this;this.getItems().each(function(e){var a=false;if(e.getId()===t)a=true;else{var r=e.getRawData().getTag(i);if(r)r.name=s,r.color=n,a=true;}if(a)o._tagsWasChanged=true;});},_onDataLoad:function(e,t){var i=this,s=-1;if(t)t.each(function(e){var t=e.getRawData();while(s===t.order)t.order++;s=t.order,i._updateViewModel(t);});},_onDrawItems:function(){},_initDataSource:function(){this.setPageSize(1000);},_onMouseUp:function(e){if(i.browser.isMobilePlatform)if(e&&e.target&&($(e.target).hasClass('ws-note-header-image')||$(e.target).hasClass('ws-note-header-image__panel')))return e.preventDefault(),void this._showAuthorInfo(e);if(this._infoboxOpened<new Date().getTime()+5000&&this._infobox)this._infobox.hide(0);w.superclass._onMouseUp.call(this,e);var t=$(e.target).closest('.ws-note').data('id');if(t)this.reorderNotes(t);},_releaseDragndropLock:function(){if(this._isBeingDragged=false,this._hasPostponedReload)this._hasPostponedReload=false,this.reload();},_getCorner:function(e){var t=e.attr('class').replace(/ws-note__corner /,'');return{isTop:t.indexOf('top')>=0,isBottom:t.indexOf('bottom')>=0,isLeft:t.indexOf('left')>=0,isRight:t.indexOf('right')>=0};},_onDragHandler:function(e,t){var s=e.getSource(),n;if(s&&s.getCount()>0)n=s.at(0).getDomElement();if('mousemove'===t.type&&i.browser.isMobilePlatform)return;if(this._isBeingDragged=true,!n)return;if(this.preparePageXY(t),this._dragData)if(this._dragData.isResize)this._resizeNote(t.pageX,t.pageY);else this._moveNote(t.pageX,t.pageY,n);t.preventDefault(),t.stopPropagation();},_makeDragEntityList:function(){var e=w.superclass._makeDragEntityList.apply(this,arguments);return e.setAction(function(){return false;}),e;},_beginDragHandler:function(t,s){if(w.superclass._beginDragHandler.apply(this,arguments),s&&s.target&&$(s.target).hasClass('controls-Scrollbar__thumb'))return;if(this._currentPressedElement=s.target,'touchstart'===s.type)this._currentPressedX=s.originalEvent.touches[0].pageX,this._currentPressedY=s.originalEvent.touches[0].pageY;if(this._closeSubforms(),e.channel('NoteCommands').notify('CloseExtendedHider'),this._infoboxOpened<new Date().getTime()+5000&&this._infobox)this._infobox.hide(0);var n=t.getSource().at(0),o=n.getDomElement(),a=$(s.target),r=a.hasClass('ws-note__corner')?a:a.hasClass('ws-note__corner-marker')?a.parent():null,h=!!r,d;if(!i.browser.isMobilePlatform)o.addClass('has-focus').find('.ws-note-tmp').attr('contenteditable','true').focus();else this._manualChangeHoveredItem($(o));var f=n.getModel().getId(),u=this.findNoteById(f);u.top=o.position().top,u.left=o.position().left;var _=(d=this._dragData={noteId:f,note:u,noteElement:o,scrollTop:g(),scrollLeft:c(),screenWidth:i.$win.width(),screenHeight:i.$win.height(),isResize:h,cornerElement:r}).note.getPosition(d.screenWidth,d.screenHeight);if(_.left-=p(),d.actualWidth=d.initialWidth=o.width(),d.actualHeight=d.initialHeight=o.height(),d.actualTop=d.initialTop=_.top,d.actualLeft=d.initialLeft=_.left,u.pinnedToPanel){var m=l.getTop();if(m&&m.containerId){var N=$('#'+m.containerId),v=N.offset();d.panelMinLeft=parseInt(v.left),d.panelMaxLeft=d.panelMinLeft+N.width()-d.actualWidth;}}if(o.addClass('ws-note_dragged'),this.preparePageXY(s),this._moveBeginX=s.pageX,this._moveBeginY=s.pageY,h)r.addClass('ws-note__corner_current'),d.corner=this._getCorner(r);else d.shiftX=this._moveBeginX-_.left,d.shiftY=this._moveBeginY-_.top;},_resizeNote:function(e,t){var i=this._dragData,s=i.corner,n=e-this._moveBeginX,o=t-this._moveBeginY,a=i.initialTop+(s.isTop?o:0),h=i.initialLeft+(s.isLeft?n:0),l=i.initialWidth+(s.isLeft?-n:n),f=i.initialHeight+(s.isTop?-o:o),c=r.MIN_NOTE_HEIGHT+(i.noteElement.find('.ws-note-tags-html').height()?40:0),g=i.panelMinLeft||d,u=i.panelMaxLeft||i.screenWidth-d-i.initialWidth,_=d,p=i.screenHeight-d-i.actualHeight;if(!s.isLeft&&h+n<u&&n>0||!s.isLeft&&l>=r.MIN_NOTE_WIDTH&&n<0||s.isLeft&&n<0&&h>=g||s.isLeft&&l>=r.MIN_NOTE_WIDTH&&n>0)if(s.isLeft||s.isRight)i.actualWidth=l,i.actualLeft=h;if(s.isTop&&o>0&&f>=r.MIN_NOTE_HEIGHT||s.isTop&&a>=_&&o<0||!s.isTop&&o>0&&a<p||!s.isTop&&f<i.actualHeight&&f>=c){if(s.isTop||s.isBottom)i.actualHeight=f,i.actualTop=a;}else if(!s.isTop&&a>=p)i.actualHeight=i.screenHeight-i.actualTop-d;this._currentPressedX=this._currentPressedY=null,i.noteElement.css({width:i.actualWidth,left:i.actualLeft,height:i.actualHeight,top:i.actualTop});},_moveNote:function(e,t,i){var s=this._dragData,n=e-s.shiftX,o=t-s.shiftY,a=s.panelMinLeft||d,r=s.panelMaxLeft||s.screenWidth-d-s.actualWidth-p(),h=d,l=s.screenHeight-d-s.actualHeight;i.css({top:s.actualTop=f(o,h,l),left:s.actualLeft=f(n,a,r)});},_endDragHandler:function(e,t,s){var n=true,o=this._dragData;if(o&&o.note){var a=o.note,r=o.noteElement;if(r.removeClass('ws-note_dragged'),o.isResize){if(o.cornerElement.removeClass('ws-note__corner_current'),this.cropNote(r),a.width!==o.actualWidth||a.height!==o.actualHeight)a.width=o.actualWidth,a.height=o.actualHeight;else n=false;if(this._notifyOnSizeChanged(),a.id)this.reorderNotes(a.id);}a.setPosition(o.actualTop,o.actualLeft,o.screenWidth,o.screenHeight);var h=p();if(null!=a.right)a.right-=h;if(!o.isResize||o.isResize&&n)a.save(['Settings']);if(this._dragData=null,r.data('lastDrag',new Date()),!i.browser.isMobilePlatform)r.find('.ws-note-tmp').attr('contenteditable','false');}this._releaseDragndropLock();},_findDragDropContainer:function(e,t){var i=$(t).parents();if(i.filter('.ws-note__tag-form').length||i.filter('.ws-note__pin-menu').length)return null;return t;},removeNoteById:function(e){this._disableRedraw=true;var t=w.superclass.removeNoteById.call(this,e);if(t)this.getNoteElement(e).remove();return this._disableRedraw=false,t;},reorderNotes:function(e){var t=this.getNotes(),i=t.length,s=false,n,o;if(i>1){if(n=this.findNoteIndexById(e),n<i-1)t.push(t.splice(n,1)[0]);for(var a=0;a<i;a++)if(o=t[a],o.order!==a+1)o.order=a+1,this.getNoteElement(o.id).css('z-index',o.order),s=true;if(s)this._notify('onReorder');}},_mouseLeaveHandler:function(e){if((!e||!this._dragData)&&!this._isTagFormOpened&&!this._isPinMenuOpened)w.superclass._mouseLeaveHandler.call(this,e);},_mouseMoveHandler:function(e){if(this._dragData){if(!this._dragData.noteElement.hasClass('controls-ListView__hoveredItem'))this._manualChangeHoveredItem($(e.target));}else w.superclass._mouseMoveHandler.call(this,e);},drawNotes:function(){var e=this;this.getNotes().forEach(function(t){e._updateViewModel(t),e.getNoteElement(t.id).css({top:t.viewModel.top,left:t.viewModel.left});});},cropNotes:function(){var e=this.getNotes();if(e)e.forEach(function(e){var t=this.getNoteElement(e.id),i=t.find('.ws-note__content img'),s=this;if(i.length)s.cropNote(t),this.addImageLoadCallback(i,function(){if(!m(i))i.off('load');s.cropNote(t);});else this.cropNote(t);},this);},reload:function(){if(this._isBeingDragged)return this._hasPostponedReload=true,t.success();else return this.drawNotes(),w.superclass.reload.call(this);},_setVisibility:function(e){if(!e)this._closeSubforms();w.superclass._setVisibility.call(this,e);},setItems:function(e){e.forEach(function(e){this._updateViewModel(e);},this),w.superclass.setItems.apply(this,arguments);},redraw:function(){if(!this._disableRedraw)w.superclass.redraw.apply(this,arguments);}});return w;});
define('js!SBIS3.Notes.NoteModel',['WS.Data/Collection/RecordSet','WS.Data/Entity/Model','js!SBIS3.Notes.Utils.Date','Core/helpers/random-helpers','Zametki_localization'],function(t,e,i,r){'use strict';function n(e,i){var e=e?e.split(','):[];return new t({idProperty:'attachId',rawData:e.map(function(t){return{attachId:t,fileName:'',title:'',Size:0,redactionId:'',versionForm:'',typeDoc:'',subTypeDoc:'',subVersionForm:'',hash:'',canEdit:false!==i};})});}return e.extend({_$adapter:'adapter.sbis',_$properties:{id:{def:function(){return r.createGUID();}},baseId:{def:function(){return this.get('Id');}},title:{get:function(){var t=this.get('Notification'),e=this.get('CronData');if(!(t instanceof Date)||isNaN(+t))return'';if(!e)return i.prettyDate(t);else{var r=i.getRepeatType(e);return i.prettyDate(i.getNearestDate(t,r));}}},files:{def:function(){return this._files=n(this.get('Files'),Boolean(!this.get('PinnedToPanel')||this.get('IsAuthor'))),this._files;},get:function(){return this._files;},set:function(t){this._files=t;}},tags:{get:function(){var t=[];return this.get('Tags').each(function(e){var i={id:e.get('Id'),name:e.get('Name'),color:e.get('Color')};t.push(i);}),t;}}},_$idProperty:'Id'});});
define("html!SBIS3.Notes.StaticNoteListView/StaticNote",function(){var t=function(t){var e=function(){var t=/\{\{([\s\S]+?)\}\}/g;return function(e){for(;t.test(e);)e=e.replace(t,"&#123;&#123;$1&#125;&#125;");return e}}(),n=function(t){return t.join?t.join(""):t.toString()},r=function(t){return void 0===t?"":t&&"object"==typeof t?n(t):""+t},o="undefined"!=typeof process,i=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,"");return t.className="ws-note ws-note_static",t.attributes={unselectable:"on"},i+=" "+e(r(t.defaultItemTpl(t))),(i=e(i))+(o&&-1!==i.indexOf("{{")?String.fromCharCode(8203,8203):"")};return t.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.StaticNoteListView/StaticNote"}},t});
define("html!SBIS3.Notes.StaticNoteListView/StaticNoteContent",function(){var t=function(t){var e=function(){var t={"&":"&#38;","<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","/":"&#47;"},e=/&(?!#?\w+;)|<|>|"|'|\//g;return function(o){return o?o.toString().replace(e,function(e){return t[e]||e}):o}}(),o=function(){var t=/\{\{([\s\S]+?)\}\}/g;return function(e){for(;t.test(e);)e=e.replace(t,"&#123;&#123;$1&#125;&#125;");return e}}(),n=function(t){return t.join?t.join(""):t.toString()},i=function(t){return void 0===t?"":t&&"object"==typeof t?n(t):""+t},s="undefined"!=typeof process,a=("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),r=function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,c='<div class="ws-note__body ws-note_color-'+o(i(t.item.get("Color")))+'" unselectable="on"> <component data-component="SBIS3.CONTROLS/ScrollContainer" class="ws-note__scroll"> <option name="content"> <div class="ws-note__content"> <div class="ws-basic-style">'+o(i(t.Sanitize(t.item.get("Content"))))+'</div> <component data-component="SBIS3.Notes.NoteFiles" name="NoteFiles_'+o(i(t.item.get("id")))+'"> <option name="staticMode">true</option> <option name="noteRecord" type="ref" value="'+o(i(function(t,e){var o=a.randomId();return t[o]=e,o}(r,t.item)))+'"></option> </component> </div> </option> </component> <div class="ws-note__footer" unselectable="on"> <div class="ws-note-tags-html"> ';if(t.item.get("tags").length){c+=" ";var l=t.item.get("tags");if(l)for(var d,p=-1,m=l.length-1;p<m;)c+=' <span class="ws-note__tag ws-note__tag_color-'+o(i((d=l[p+=1]).color))+'">'+o(i(e(d.name)))+"</span> ";c+=' <span class="ws-note-tags__ellipsis ws-hidden">'+o(i(rk("...")))+"</span> "}return c+=' </div> <span class="ws-note-header-image',t.item.get("title")&&(c+=" icon-16 icon-Bell "),c+='"></span> <span class="ws-note-calendar-html">'+o(i(t.item.get("title")))+'</span> </div> <component data-component="SBIS3.Notes.NoteActions"> <option name="showPin">true</option> <option name="allowPinToAnyPage">false</option> <option name="isHidden" value="'+o(i(t.item.get("IsHidden")))+'"></option> <option name="showShare" value="'+o(i(t.item.get("PinnedToPanel")))+'"></option> <option name="isAuthor" value="'+o(i(t.item.get("IsAuthor")))+'"></option> <option name="staticMode">true</option> <option name="noteRecord" type="ref" value="'+o(i(function(t,e){var o=a.randomId();return t[o]=e,o}(r,t.item)))+'"></option> </component> <div class="ws-note-shadow"> <div class="ws-note-shadow__left"></div> <div class="ws-note-shadow__right"></div> </div> <div class="ws-note__indicator"></div> </div> <div class="ws-note-tmp"></div>',(c=o(c))+(s&&-1!==c.indexOf("{{")?String.fromCharCode(8203,8203):"")};return t.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.StaticNoteListView/StaticNoteContent"}},t});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.StaticNoteListView", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-note-list_loaded .ws-note{-webkit-transition:top .5s,left .5s;-moz-transition:top .5s,left .5s;-o-transition:top .5s,left .5s;transition:top .5s,left .5s}.ws-note-list_static{padding-left:8px}.ws-note_static{width:240px;padding:0;margin:0}.controls-ListView__item.ws-note.ws-note_static{position:absolute!important}.ws-note_static .ws-note__body{margin:8px;position:relative;cursor:pointer;overflow:hidden}.ws-note_static.controls-ListView__hoveredItem .ws-note__body{box-shadow:1px 0 8px 1px #aaa;transition:box-shadow .5s;-webkit-transition:box-shadow .5s;-moz-transition:box-shadow .5s;-o-transition:box-shadow .5s}.ws-note_static .ws-note__content{position:relative;word-wrap:break-word;min-height:20px}.ws-note_static .ws-note__body .ws-note__scroll{max-height:440px}.ws-note_static .ws-note-tags-html{position:relative;bottom:initial;max-height:48px}.ws-note_static .ws-note:after{content:'';position:relative;zoom:0;font-size:0;display:block;width:0;height:0}.ws-note_static .ws-note-shadow{width:100%;bottom:-6px}.ws-note_static .ws-note__content div p{max-width:100%;margin:0}.ws-note_static .ws-note__content .ws-basic-style img{font-size:0;vertical-align:bottom;margin-bottom:5px}@media \\0screen{.ws-note-left-list,.ws-note-list_static{margin-top:32px!important}}.ws-is-mobile-platform .ws-notes-holder_static{overflow:scroll!important}.ws-note_static .ws-note__footer{padding-bottom:5px}.ws-note_static .ws-note__footer .ws-note-tags__ellipsis,.ws-note_static .ws-note__footer .ws-note__tag{margin-top:4px;margin-bottom:4px}"));head.appendChild(style);});}
define('js!SBIS3.Notes.StaticNoteListView',['Core/core-instance','Core/EventBus','Core/constants','js!SBIS3.Notes.NoteListView','js!SBIS3.Notes.NoteModel','js!SBIS3.BL.Note','WS.Data/Source/SbisService','js!SBIS3.Notes.Utils.Info','html!SBIS3.Notes.StaticNoteListView/StaticNote','html!SBIS3.Notes.StaticNoteListView/StaticNoteContent','js!SBIS3.Notes.NoteTags','SBIS3.CONTROLS/ScrollContainer','css!SBIS3.Notes.StaticNoteListView','Zametki_localization'],function(e,t,i,o,s,a,n,r,d,l){'use strict';var c=245,g=336,h=['DIV','LI','P'];function u(e){for(var t=1/0,i,o=-1,s=0,a=e.length;s<a;s++)if(i=e[s],i<t)t=i,o=s;return o;}function f(e){while(null!=e){if(h.indexOf(e.tagName)>=0)break;e=e.parentElement;}return e;}var m=o.extend({$protected:{_options:{className:'ws-note-list_static',itemTpl:d,itemContentTpl:l,itemsDragNDrop:false,emptyHTML:rk('Заметок нет.')}},_modifyOptions:function(e){var t=m.superclass._modifyOptions.apply(this,arguments);return t.emptyHTML=rk('Заметок нет.'),t;},$constructor:function(){var e=t.channel('NoteCommands');this.subscribeTo(e,'SetNoteVisible',this._setNoteVisible.bind(this));},reload:function(){return this.getContainer().removeClass('ws-note-list_loaded'),m.superclass.reload.apply(this,arguments);},_initDataSource:function(){this.setPageSize(25),this.setDataSource(new n({endpoint:{address:'/notes/service/',contract:'Note'},model:s,binding:{query:'GetPersonNotesList'},idProperty:'Id'}),true);},_onDrawItems:function(){this.show(),this.toColView(),this.getContainer().addClass('ws-note-list_loaded');},_setNoteVisible:function(e,t,i){if(t&&t.get('baseId'))a[i?'showNote':'hideNote'](t.get('baseId'));},_endDragHandler:function(o,s){var n=o&&o.getTargetsDomElement();if(n&&!o.getTargetsControl()){var d=n.data('id'),l=o.getSource(),c=l?l.at(0):null,g=c?c.getModel().get('baseId'):null;if(d&&g)a.pinNoteByUrlId(g,d).addCallback(function(){t.channel('NotesEvents').notify('onNoteChanged',c.getModel());}).addErrback(function(e){r.showMessageDialog({message:e.message,status:'error'});});}if(!i.browser.isMobilePlatform&&!s)return;i.$body.removeClass('dragdropNote');var h=o.getSource();if(h&&h.getCount()>0){var u=o.getTarget();if(u){var f=h.at(0),m=o.getOwner(),N;if(e.instanceOfModule(m,'SBIS3.Notes.TagListView')){var S=f.getModel().getId();if(N=u.getModel().getId(),S&&N&&'00000000-0000-0000-0000-000000000000'!==S)t.channel('NoteCommands').notify('AddTag',N,S);}else if(e.instanceOfModule(m,'SBIS3.Notes.NoteListView')){N=f.getModel().getId();var p=u.getModel().getId();if(N&&p)t.channel('NoteCommands').notify('MoveNote',N,p);}}}},_onDragHandler:function(e,t){if(t.originalEvent.preventDefault(),m.superclass._onDragHandler.apply(this,arguments),'touchmove'===t.type){var i=t.originalEvent.changedTouches[0],o=document.elementFromPoint(i.clientX,i.clientY),s=$(o).closest('.ws-note-used-tag');if(s.length){var a=s.data('id');if($('.ws-note-used-tag').removeClass('controls-ListView__hoveredItem'),'00000000-0000-0000-0000-000000000000'!==a)$('.ws-note-used-tag[data-id='+a+']').addClass('controls-ListView__hoveredItem');}}else this._isDragDropStarted=true;},_beginDragHandler:function(e,t){if(m.superclass._beginDragHandler.apply(this,arguments),this._currentPressedElement=t.target,'touchmove'===t.type||'touchstart'===t.type)this._currentPressedX=t.touches[0].pageX,this._currentPressedY=t.touches[0].pageY;i.$body.addClass('dragdropNote').removeClass('dragdropTag');},toColView:function(){var e=8,t=this.getNoteCount();if(0===t)return;for(var o=this.getContainer(),s=o.width()-(i.browser.isMobilePlatform?45:0),a=s/c^0,n=Math.min(g,s/Math.min(t,a)^0),r=this,d=new Array(a),l=0;l<a;l++)d[l]=0;this._getNoteElements().each(function(t,i){var o=u(d),s=$(i),a=n*o,l=d[o];s.css({width:n,left:a,top:l}),r.cropNote(s);var c=s.find('.ws-basic-style')[0];$(c).find('img').each(function(t,i){var o=$(i),s=o.data('original-width'),a=o.data('original-height'),n=s?s:i.clientWidth,r=a?a:i.clientHeight,d=f(i.parentNode),l=$(d).width()-2*e;if(n>l)r=r*l/n,n=l;if(n&&!o.hasClass('LinkDecorator__image'))if(o.css({width:n,height:r}),void 0===s&&void 0===a)o.attr({'data-original-width':i.clientWidth,'data-original-height':i.clientHeight});}),d[o]+=s.height();});var h=Math.max.apply(Math,d);o.height(h),o.css('min-height','');}});return m;});
define('js!SBIS3.Notes.MasterPage',['js!SBIS3.Engine.OnlineBaseInner2','Core/Deferred','Zametki_localization'],function(e,n){'use strict';return e.extend({workspace:function(){return n.success(this.createComponent('SBIS3.Notes.Page',{}));}});});
define('js!SBIS3.Notes.Page.PageInfo',['WS.Data/Entity/Model','Zametki_localization'],function(t){'use strict';return t.extend({$protected:{_options:{properties:{Title:{get:function(t){return t||'';}},PageTitle:{get:function(){var t=this.get('Title').split(' / ');return t[t.length-1];}},Breadcrumbs:{get:function(){var t=this.get('Title').split(' / ');return t.length-=1,t.join('\\');}}}}}});});
define("html!SBIS3.Notes.Notification",function(){var o=function(o){var n=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,"&#123;&#123;$1&#125;&#125;");return n}}(),t=function(o){return o.join?o.join(""):o.toString()},i=function(o){return void 0===o?"":o&&"object"==typeof o?t(o):""+o},e="undefined"!=typeof process,p=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,""),a=(new Date).getHours()>=20;return p+=' <div class="ws-note-notification-form" ondrop="return false;"> <div class="ws-window-titlebar-custom"> <component data-component="SBIS3.CONTROLS/Menu/MenuLink" name="methodMenu" class="controls-Menu__hide-menu-header"> <option name="caption">Напомнить по СМС</option> <option name="idProperty">id</option> <option name="icon">sprite:icon-16 icon-PhoneCell icon-primary</option> <option name="pickerClassName">ws-note-notification-form__menu ws-no-select</option> <option name="tabindex">0</option> <option name="activableByClick">false</option> <options name="items" type="array"> <options> <option name="id" type="number">0</option> <option name="title">'+n(i(rk("Напомнить по СМС")))+'</option> </options> <options> <option name="id" type="number">2</option> <option name="title">'+n(i(rk("Напомнить через СБИС")))+'</option> </options> <options> <option name="id" type="number">1</option> <option name="title">'+n(i(rk("Напомнить по e-mail")))+'</option> </options> <options> <option name="id" type="number">3</option> <option name="title">'+n(i(rk("Не напоминать")))+'</option> </options> </options> </component> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="save" class="controls-IconButton__round-border ws-note-notification-form__save"> <option name="icon">sprite:icon-16 icon-Yes icon-done</option> </component> </div> <component data-component="SBIS3.CONTROLS/Menu" name="timeMenu" class="controls-Menu__hide-menu-header ws-note-notification-form__menu ws-note-notification-form__menuTime"> <option name="idProperty">id</option> <option name="tabindex">0</option> <option name="activableByClick">false</option> <options name="items" type="array"> <options> <option name="icon">sprite:icon-16 icon-Bell icon-primary</option> <option name="id">today</option> <option name="title">',p+=n(a?i(rk("Через 2 часа")):i(rk("Позже сегодня"))),p+='</option> <option name="days" type="number">0</option> <option name="hours" type="number">20</option> <option name="minutes" type="number">00</option> </options> <options> <option name="id">tomorrow</option> <option name="title">'+n(i(rk("Завтра")))+'</option> <option name="days" type="number">1</option> <option name="hours" type="number">9</option> <option name="minutes" type="number">00</option> </options> <options> <option name="id">nextweek</option> <option name="title">'+n(i(rk("Через неделю в тот же день")))+'</option> <option name="days" type="number">7</option> <option name="hours" type="number">9</option> <option name="minutes" type="number">00</option> </options> </options> </component> <div class=\'ws-note-notification-form__custom-item\'>'+n(i(rk("Указать день и время")))+':</div> <div class="ws-note-notification-form__custom-date"> <span>'+n(i(rk("День")))+'</span> <component data-component="SBIS3.CONTROLS/Date/Picker" name="date" class="ws-note-notification-form__date"> <option name="mask">DD.MM.YY</option> <option name="tabindex">14</option> </component> <span>'+n(i(rk("Время")))+'</span> <component data-component="SBIS3.CONTROLS/Date/Picker" name="time" class="ws-note-notification-form__time"> <option name="mask">HH:II</option> <option name="tabindex">14</option> </component> </div> <div class="ws-note-notification-form__repeat-wrapper"> <component data-component="SBIS3.CONTROLS/Menu/MenuLink" name="repeatMenu" class="controls-Menu__hide-menu-header"> <option name="caption">'+n(i(rk("Не повторять")))+'</option> <option name="idProperty">id</option> <option name="pickerClassName">ws-note-notification-form__repeat ws-no-select</option> <option name="tabindex">0</option> <option name="activableByClick">false</option> <options name="items" type="array"> <options> <option name="id" type="number">0</option> <option name="title">'+n(i(rk("Не повторять")))+'</option> </options> <options> <option name="id" type="number">1</option> <option name="title">'+n(i(rk("Каждый день")))+'</option> </options> <options> <option name="id" type="number">2</option> <option name="title">'+n(i(rk("Каждую неделю")))+'</option> </options> <options> <option name="id" type="number">3</option> <option name="title">'+n(i(rk("Каждый месяц")))+'</option> </options> <options> <option name="id" type="number">4</option> <option name="title">'+n(i(rk("Каждый квартал")))+'</option> </options> <options> <option name="id" type="number">5</option> <option name="title">'+n(i(rk("Каждый год")))+'</option> </options> </options> </component> </div> <div class="ws-note-notification-form__footer">'+n(i(o.footerText))+"</div> </div>",(p=n(p))+(e&&-1!==p.indexOf("{{")?String.fromCharCode(8203,8203):"")};return o.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.Notification"}},o});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.Notification", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-note-notification-form{width:265px;padding:0}.ws-note-notification-form .ws-window-titlebar{font-weight:400;padding:8px 42px 0 8px;box-sizing:border-box}.ws-note-notification-form__save{position:absolute;right:43px}.ws-note-notification-form__hours{float:right;padding-right:2px;padding-top:8px}.ws-note-notification-form__time{vertical-align:middle;-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text}.controls-MenuItem.ws-note-notification-form__method_disabled{height:auto;cursor:default;flex-direction:column}.ws-note-notification-form__menu .controls-MenuItem{padding-left:8px}.ws-note-notification-form__menu .controls-MenuItem .controls-MenuItem__content{display:inline-block}.ws-note-notification-form__error{font-size:11px;max-width:350px;line-height:1.5;align-self:flex-start}.ws-note-notification-form__menuTime .controls-MenuItem .controls-MenuItem__text{display:inline-block;float:left;font-size:14px}.ws-note-notification-form__menuTime .controls-MenuItem__icon-wrapper{position:relative;width:22px}.ws-note-notification-form__menuTime .controls-MenuItem__icon{position:absolute;top:9px}.ws-note-notification-form__menuTime .controls-MenuItem__content.controls-MenuItem__cell{width:235px}.ws-note-notification-form__custom-item{height:30px;margin-top:7px;margin-left:31px}.ws-note-notification-form__menu .control-MenuItem__child-expand.controls-MenuItem__cell{width:0;padding-right:0}.ws-note-notification-form__custom-date{margin-left:31px;height:34px}.ws-note-notification-form__custom-date>span{color:#999}.ws-note-notification-form__date{margin-right:15px;-webkit-user-select:text}.ws-note-notification-form__time{margin-right:2px;margin-top:-4px}.ws-note-notification-form__time.controls-DatePicker .controls-DatePicker__dateBox{margin-right:2px}.ws-note-notification-form .controls-Menu.controls-Menu__hide-menu-header{margin-left:0;margin-top:-4px}.ws-note-notification-form__repeat-wrapper{padding:0 10px 10px 30px}.ws-note-notification-form__footer{padding:10px 10px 10px 10px;border-top:1px solid #e4e4e4}.ws-note-notification-form__footer .footerText{display:inline-block;float:left;margin-left:8px}.ws-note-notification-form__footer .icon-Refresh{margin-top:1px;float:left}.ws-note-notification-form__footer .clr{clear:both}"));head.appendChild(style);});}
define('js!SBIS3.Notes.Notification',['Core/core-functions','Core/helpers/String/format','Core/constants','html!SBIS3.Notes.Notification','SBIS3.CONTROLS/CompoundControl','js!SBIS3.Notes.Utils.Date','css!SBIS3.Notes.Notification','SBIS3.CONTROLS/Menu/MenuLink','SBIS3.CONTROLS/Menu','SBIS3.CONTROLS/Button/IconButton','SBIS3.CONTROLS/Date/Picker','Zametki_localization'],function(t,e,i,s,o,n){'use strict';var a=['PhoneCell','Mail','EmptyMessage','Decline'];function r(t){var e=null;if(t&&t.has('hours'))(e=new Date()).setDate(e.getDate()+t.get('days')),e.setHours(t.get('hours'),t.get('minutes'),0,0);return e;}function l(t){return t=parseInt(t,10),t>=10?t:'0'+t;}var d=o.extend({_dotTplFn:s,$protected:{_options:{cron:'',method:null,repeat:null,time:null,activableByClick:false,availabilityErrors:[],startDate:null,endDate:null,ending:0,period:0,times:1,every:1},_dom:null,_controls:null,_initialMethod:null,_initialRepeat:null,_initialTime:null,_selectedMethod:null,_selectedRepeat:null,_selectedTime:null,_needValidate:false},_modifyOptions:function(t){var e=d.superclass._modifyOptions.apply(this,arguments);return e.footerText=rk('Напоминание не установлено'),e;},init:function(){d.superclass.init.call(this);function t(t,s){if(s.which===i.key.enter)s.preventDefault(),e.onSave();}var e=this;this._initialMethod=this._selectedMethod=this._options.method,this._initialTime=this._selectedTime=this._options.time,this._initialRepeat=this._selectedRepeat=this._options.repeat,this._initialCron=this._cron=this._options.cron,this._dom={custom:this.getContainer().find('.ws-note-notification-form__custom-item'),date:this.getContainer().find('.ws-note-notification-form__custom-date'),repeat:this.getContainer().find('.ws-note-notification-form__repeat-wrapper'),footer:this.getContainer().find('.ws-note-notification-form__footer')},this._controls={methodMenu:this.getChildControlByName('methodMenu'),timeMenu:this.getChildControlByName('timeMenu'),date:this.getChildControlByName('date'),time:this.getChildControlByName('time'),save:this.getChildControlByName('save'),repeatMenu:this.getChildControlByName('repeatMenu')},this._updateMethodMenu(null==this._initialMethod?this._getFirstAvailableMethod():this._initialMethod);var s=e._controls.timeMenu.getItems(),o=e._controls.timeMenu.getItemsInstances(),n=new Date();if(s.each(function(t){if(o[t.getId()].setProperty('activableByClick',false),o[t.getId()].getContainer().on('mousedown focus',false),t.has('hours')){if(n.getHours()>=20&&20==t.get('hours')){if(n.getHours()>=22)t.set('days',1);var e=new Date(n.setHours(n.getHours()+2));t.set('hours',e.getHours()),t.set('minutes',e.getMinutes());}o[t.getId()].getContainer().find('.controls-MenuItem__content').append($('<span class="ws-note-notification-form__hours">'+l(t.get('hours'))+':'+l(t.get('minutes'))+'</span>'));}}),this._initialCron)this._initRepeatMenu(this._initialCron);this._initTimeMenu(this._initialTime),this._controls.repeatMenu.setProperty('pickerConfig',{handlers:{onShow:this._disableRepeatMenuSelection.bind(this)}}),this._controls.methodMenu.setProperty('pickerConfig',{handlers:{onShow:this._decorateMethodMenu.bind(this)}}),this.subscribeTo(this._controls.save,'onActivated',this.onSave.bind(this)),this.subscribeTo(this._controls.repeatMenu,'onMenuItemActivate',this._onRepeatSelected.bind(this)),this.subscribeTo(this._controls.timeMenu,'onMenuItemActivate',this._onTimeSelected.bind(this)),this.subscribeTo(this._controls.timeMenu,'onActivated',this._disableTimeMenuSelection.bind(this)),this.subscribeTo(this._controls.methodMenu,'onMenuItemActivate',this._onMethodSelected.bind(this)),this.subscribeTo(this._controls.date,'onDateChange',function(){e.showFooterText(),this.setActive(true);}),this.subscribeTo(this._controls.time,'onDateChange',function(){e.showFooterText(),this.setActive(true);}),this.subscribeTo(this,'onKeyPressed',t),this.subscribeTo(this._controls.date,'onKeyPressed',t),this.subscribeTo(this._controls.time,'onKeyPressed',t),this.subscribeTo(this._controls.time,'onClick',function(){e._needValidate=true;var t=e.getContainer().parent();t.add(t.find('*')).removeAttr('unselectable').off('selectstart');}),this.subscribeTo(this._controls.date,'onClick',function(){e._needValidate=true;var t=e.getContainer().parent();t.add(t.find('*')).removeAttr('unselectable').off('selectstart');});var a=[{validator:this._validateEmptyDate.bind(this),errorMessage:rk('Необходимо указать дату напоминания')},{validator:this._validatePastDate.bind(this),errorMessage:rk('Дата напоминания не может быть в прошлом')}];this.subscribeTo(this._controls.date,'onAfterShow',function(){this.setValidators(a);});var r=[{validator:this._validateEmptyTime.bind(this),errorMessage:rk('Необходимо указать время напоминания')},{validator:this._validatePastTime.bind(this),errorMessage:rk('Время напоминания не может быть в прошлом')},{validator:this._validateTimeDifference.bind(this),errorMessage:rk('Оповещение необходимо регистрировать не позднее, чем за 5 минут до начала события')}];this.subscribeTo(this._controls.time,'onAfterShow',function(){this.setValidators(r);}),setTimeout(function(){e._controls.date.setActive(true);},500);},destroy:function(){d.superclass.destroy.call(this),this._controls=this._dom=null;},showFooterText:function(){if(this._controls.date&&this._controls.time&&this._controls.date.getDate()&&this._controls.time.getDate()){var t=this._controls.date.getDate(),i=this._controls.time.getDate(),s=this._options.footerText,o=rk('Напоминание $date$t$%d.%m.%y$ в $date$t$%H:%M$'),a={date:new Date(t.getFullYear(),t.getMonth(),t.getDate(),i.getHours(),i.getMinutes(),0,0)};if(this._options.startDate=new Date(a.date),a.date=n.getNearestDate(new Date(this._options.startDate),this._selectedRepeat),this._options.footerText=s=e(a,o),this._selectedRepeat)s='<div class="icon-16 icon-Refresh icon-primary"></div>'+'<div class="footerText">'+s+'</div><div class="clr"></div>';this._dom.footer.html(s);}},_onRepeatSelected:function(t,e){this._updateRepeatMenu(e);},_openRepeatPanel:function(){var t=this,e=this.getLinkedContext();e.setValue('ending',this._options.ending),e.setValue('every',this._options.every),e.setValue('period',this._options.period),e.setValue('times',this._options.times),e.setValue('date',this._options.endDate?this._options.endDate:this._options.startDate),e.setValue('startDate',this._options.startDate),require(['SBIS3.CONTROLS/FloatArea','js!SBIS3.Notes.NotificationRepeat'],function(e){new e({visible:true,parent:t,opener:t,template:'<component data-component="SBIS3.Notes.NotificationRepeat">'+'<option name="ending" bind="ending"></option>'+'<option name="every" bind="every"></option>'+'<option name="period" bind="period"></option>'+'<option name="times" bind="times"></option>'+'<option name="date" bind="date"></option>'+'<option name="startDate" bind="startDate"></option>'+'</component>',element:$('<div class="ws-note__repeat-form"></div>'),target:t.getContainer(),animationLength:0,autoCloseOnHide:true,activableByClick:false,corner:'tl',closeButton:true,verticalAlign:{side:'top',offset:50},horizontalAlign:{side:'left',offset:50},handlers:{onClose:function(){var e=this.getLinkedContext();t._options.period=e.getValue('period'),t._options.every=e.getValue('every'),t._options.ending=e.getValue('ending'),t._options.times=e.getValue('times'),t._options.endDate=e.getValue('date'),t.showFooterText(),this.destroy();}},closeByExternalClick:true,closeByExternalOver:false}).show();});},_getFirstAvailableMethod:function(){var t=this._controls.methodMenu.getItems(),e;if(!t)return null;for(var i=0;i<t.getCount();i++)if(e=t.at(i).getId(),!this._options.availabilityErrors[e])return this._selectedMethod=e,e;return null;},_validateEmptyDate:function(){if(this._needValidate)return null!=this._controls.date.getDate();else return true;},_validateEmptyTime:function(){if(this._needValidate)return null!=this._controls.time.getDate();else return true;},_validatePastDate:function(){var t=this._controls.date.getDate();if(this._needValidate&&t)return new Date().setHours(0,0,0,0)<=t;else return true;},_validatePastTime:function(){var t=this._controls.date.getDate(),e=this._controls.time.getDate();if(this._needValidate&&t&&e){var i=new Date(t.getFullYear(),t.getMonth(),t.getDate(),e.getHours(),e.getMinutes(),0,0);return new Date()<i;}else return true;},_validateTimeDifference:function(){var t=this._controls.date.getDate(),e=this._controls.time.getDate();if(this._needValidate&&t&&e){var i=new Date(t.getFullYear(),t.getMonth(),t.getDate(),e.getHours(),e.getMinutes(),0,0)-new Date();return i<=0||i>300000;}else return true;},_decorateMethodMenu:function(){for(var t=this._options.availabilityErrors,e=this._controls.methodMenu.getPicker()&&this._controls.methodMenu.getItemsInstances(),i,s,o=0;o<t.length;o++)if(s=t[o],s)if(i=e[o],i.setEnabled(false),!i.getContainer().hasClass('ws-note-notification-form__method_disabled'))i.getContainer().addClass('ws-note-notification-form__method_disabled').append('<div class="ws-note-notification-form__error">'+s+'</div>');this._disableMenuSelection(this._controls.methodMenu);},_disableMenuSelection:function(t){if(t.getPicker)t.getPicker();t.getItemsInstances();var e=t.getContainer();e.add(e.find('*')).attr('unselectable','on').on('selectstart',false);},_disableTimeMenuSelection:function(){this._disableMenuSelection(this._controls.timeMenu);},_disableRepeatMenuSelection:function(){this._disableMenuSelection(this._controls.repeatMenu);},_updateRepeatMenu:function(t){var e=this._controls.repeatMenu,i=e.getItems().getRecordById(t);if(e.setCaption(i.get('title')),i){if(this._selectedRepeat=t,6==t)this._openRepeatPanel();this.showFooterText();}this._controls.date.setActive(true);},_updateMethodMenu:function(t){var e=this._controls.methodMenu,i=e.getItems().getRecordById(t);if(this._doNotNotify=3==t,i)e.setCaption(i.get('title')),e.setIcon('sprite:icon-16 icon-primary icon-'+a[t]),this._selectedMethod=t;if(this._doNotNotify)this._controls.timeMenu.getContainer().addClass('ws-hidden'),this._dom.date.addClass('ws-hidden'),this._dom.custom.addClass('ws-hidden'),this._dom.repeat.addClass('ws-hidden'),this._dom.footer.addClass('ws-hidden');else this._controls.timeMenu.getContainer().removeClass('ws-hidden'),this._dom.date.removeClass('ws-hidden'),this._dom.custom.removeClass('ws-hidden'),this._dom.repeat.removeClass('ws-hidden'),this._dom.footer.removeClass('ws-hidden'),this.showFooterText();this._controls.date.setActive(true);},_hasChangedValue:function(){return this._selectedMethod!==this._initialMethod||+this._selectedTime!==+this._initialTime||this._cron!==+this._initialCron||this._selectedRepeat!==+this._selectedRepeat;},onSave:function(){if(this._needValidate=true,!this._doNotNotify){if(!this._controls.date.validate()||!this._controls.time.validate())return;var t=this._controls.date.getDate(),e=this._controls.time.getDate(),i=new Date(t.getFullYear(),t.getMonth(),t.getDate(),e.getHours(),e.getMinutes(),0,0);this._selectedTime=i,this._cron=n.getCronString(i,this._selectedRepeat);}this.save();},_onMethodSelected:function(t,e){this._updateMethodMenu(e);},_onTimeSelected:function(t,e){var i=this._controls.timeMenu.getItems().getRecordById(e);if(this._needValidate=true,!this._doNotNotify)this._selectedTime=r(i),this._controls.date.setDate(new Date(this._selectedTime.getTime())),this._controls.time.setDate(new Date(this._selectedTime.getTime()));if(!this._controls.date.validate()||!this._controls.time.validate())return;this.save();},_initTimeMenu:function(t){var e=3;if(t instanceof Date)this._controls.timeMenu.getItems().each(function(i){if(+r(i)===+t)e=i.getId();}),this._controls.date.setDate(new Date(t.getTime())),this._controls.time.setDate(new Date(t.getTime()));else if(null==t){var i=new Date();if(i.getHours()>=20){var s=new Date(i.setHours(i.getHours()+2));i.setDate(s.getDate()),i.setHours(s.getHours(),s.getMinutes(),0,0);}else i.setHours(20,0,0,0);this._controls.date.setDate(new Date(i.getTime())),this._controls.time.setDate(new Date(i.getTime())),this._selectedTime=i;}this.showFooterText();},_initRepeatMenu:function(t){if(t){var e=n.getRepeatType(t);this._initialRepeat=this._selectedRepeat=e;var i=this._controls.repeatMenu.getItems().getRecordById(this._selectedRepeat);this._controls.repeatMenu.setCaption(i.get('title'));}else this._initialRepeat=this._selectedRepeat=0;},save:function(){if(this._doNotNotify)this.sendCommand('close',false);else{var e=this._options.availabilityErrors[this._selectedMethod];if(e)return void t.alert(e,'error');if(this._hasChangedValue()&&3!==this._selectedMethod)this.sendCommand('close',{method:this._selectedMethod,time:this._selectedTime,cron:this._cron,repeat:this._selectedRepeat});else this.sendCommand('close');}}});return d;});
define("html!SBIS3.Notes.NotificationRepeat",function(){var o=function(o){var n=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,"&#123;&#123;$1&#125;&#125;");return n}}(),t=function(o){return o.join?o.join(""):o.toString()},i=function(o){return void 0===o?"":o&&"object"==typeof o?t(o):""+o},e="undefined"!=typeof process,p=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,'<div> <div class="ws-window-titlebar-custom"> <span class="ws-window-title" title="'+n(i(rk("Вставить/редактировать ссылку")))+'">'+n(i(rk("Повтор")))+'</span><component data-component="SBIS3.CONTROLS/Button" name="saveRepeat" class="controls-Button controls-Button__primary ws-note__saveRepeat"> <option name="caption">'+n(i(rk("Сохранить")))+'</option> <option name="tooltip">'+n(i(rk("Сохранить период")))+'</option> <option name="activableByClick">false</option> </component> </div> <div class="clr"></div> <div class="ws-note-notification-form__internal-wrapper"> <span class="ws-note-notification-form__caption">'+n(i(rk("Каждый")))+'</span> <component data-component="SBIS3.CONTROLS/NumberTextBox" name="every" class="controls-Button controls-Button__primary"> <option name="tabindex">1</option> <option name="onlyInteger">true</option> <option name="onlyPositive">true</option> <option name="maxLength">2</option> <option name="text">1</option> </component> <component data-component="SBIS3.CONTROLS/Menu/MenuLink" name="periodMenu" class="controls-Menu__hide-menu-header"> <option name="caption">'+n(i(rk("дн.")))+'</option> <option name="idProperty">id</option> <option name="pickerClassName">ws-note-notification-form__period ws-no-select</option> <option name="tabindex">2</option> <option name="activableByClick">false</option> <options name="items" type="array"> <options> <option name="id" type="number">0</option> <option name="title">'+n(i(rk("дн.")))+'</option> </options> <options> <option name="id" type="number">1</option> <option name="title">'+n(i(rk("нед.")))+'</option> </options> <options> <option name="id" type="number">2</option> <option name="title">'+n(i(rk("мес.")))+'</option> </options> <options> <option name="id" type="number">3</option> <option name="title">'+n(i(rk("г.")))+'</option> </options> </options> </component> <div class="clr"></div> <span class="ws-note-notification-form__caption">'+n(i(rk("Окончание")))+'</span> <component data-component="SBIS3.CONTROLS/Radio/Group" name="ending" class="ws-note-notification-form__ending"> <option name="displayProperty">title</option> <options name="items" type="array"> <options> <option name="id" type="number">0</option> <option name="title">'+n(i(rk("Никогда")))+'</option> </options> <options> <option name="id" type="number">1</option> <option name="title">'+n(i(rk("После")))+'</option> </options> <options> <option name="id" type="number">2</option> <option name="title">'+n(i(rk("До")))+'</option> </options> </options> <option name="idProperty">id</option> <option name="tabindex">3</option> </component> <div class="ws-note-notification-form__times"> <component data-component="SBIS3.CONTROLS/NumberTextBox" name="times" class="controls-Button controls-Button__primary"> <option name="tabindex">4</option> <option name="onlyInteger">true</option> <option name="onlyPositive">true</option> <option name="maxLength">2</option> <option name="text">1</option> </component> <span class="ws-note-notification-form__caption">'+n(i(rk("повт.")))+'</span> <component data-component="SBIS3.CONTROLS/Date/Picker" name="date" class="ws-note-notification-form__date"> <option name="mask">DD.MM.YY</option> <option name="tabindex">4</option> </component> </div> </div> <div class="ws-note-notification-form__footer">'+n(i(o.footerText))+"</div> </div>");return(p=n(p))+(e&&-1!==p.indexOf("{{")?String.fromCharCode(8203,8203):"")};return o.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.NotificationRepeat"}},o});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.NotificationRepeat", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-note__repeat-form{width:360px;min-height:200px;height:auto;border-radius:5px;-webkit-border-radius:5px;-moz-border-radius:5px;-o-border-radius:5px;border-color:#e4e4e4;border-width:2px;border-style:solid}.ws-note__saveRepeat{right:44px;top:12px;position:absolute}.ws-note-notification-form__internal-wrapper{display:block;width:100%;padding:10px 20px 20px 20px}.ws-note__repeat-form .clr{clear:both}.ws-note-notification-form__internal-wrapper span.ws-note-notification-form__caption{width:100px;display:block;float:left;height:26px;margin-top:2px}.ws-note-notification-form__internal-wrapper .controls-NumberTextBox{display:block;float:left;width:30px;margin-right:12px}.ws-note-notification-form__period{min-width:30px}.ws-note-notification-form__ending{display:block;float:left;width:100px;margin-left:-6px}.ws-note-notification-form__times{margin-top:24px}.ws-note-notification-form__internal-wrapper .controls-RadioButton.controls-ListView__item{height:26px}"));head.appendChild(style);});}
define('js!SBIS3.Notes.NotificationRepeat',['Core/constants','SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.NotificationRepeat','SBIS3.CONTROLS/NumberTextBox','SBIS3.CONTROLS/Radio/Group','SBIS3.CONTROLS/Button','SBIS3.CONTROLS/Date/Picker','SBIS3.CONTROLS/Menu/MenuLink','css!SBIS3.Notes.NotificationRepeat','Zametki_localization'],function(t,e,i){'use strict';var s=e.extend({_dotTplFn:i,$protected:{_options:{ending:0,period:0,every:0,times:0,date:new Date(),startDate:new Date()},_dom:null,_controls:null,_initialEvery:null,_initialPeriod:null,_initialEnding:null,_initialDate:null,_initialTimes:null,_initialStartDate:null,_selectedEvery:null,_selectedPeriod:null,_selectedEnding:null,_selectedDate:null,_selectedTimes:null},_modifyOptions:function(t){var e=s.superclass._modifyOptions.apply(this,arguments);return e.footerText=rk('Напоминание не установлено'),e;},$constructor:function(){this._publish('onNotificationRepeatChanged');},init:function(){s.superclass.init.call(this);var t=this;this._dom={footer:this.getContainer().find('.ws-note-notification-form__footer')},this._controls={every:this.getChildControlByName('every'),times:this.getChildControlByName('times'),date:this.getChildControlByName('date'),save:this.getChildControlByName('saveRepeat'),ending:this.getChildControlByName('ending'),periodMenu:this.getChildControlByName('periodMenu')};var e=this.getLinkedContext();if(this._options.every=e.getValue('every'),this._options.period=e.getValue('period'),this._options.ending=e.getValue('ending'),this._options.date=e.getValue('date'),this._options.startDate=e.getValue('startDate'),this._options.times=e.getValue('times'),this._initialEvery=this._selectedEvery=this._options.every,this._initialPeriod=this._selectedPeriod=this._options.period,this._initialEnding=this._selectedEnding=this._options.ending,this._initialDate=this._selectedDate=this._options.date,this._initialStartDate=this._options.startDate,this._initialTimes=this._selectedTimes=this._options.times,this.subscribeTo(this._controls.date,'onKeyPressed',t.onKeyPressed),this.subscribeTo(this,'onKeyPressed',t.onKeyPressed),this._initialPeriod){var i=this._controls.periodMenu.getItems().getRecordById(this._initialPeriod);this._controls.periodMenu.setCaption(i.get('title'));}if(this._initialEnding)this._controls.ending.setSelectedKey(this._initialEnding);if(this._initialDate)this._controls.date.setDate(this._initialDate);if(this._initialTimes)this._controls.times.setText(this._initialTimes);if(this._initialEvery)this._controls.every.setText(this._initialEvery);this._controls.periodMenu.subscribe('onSelectedItemChange',function(e,i){t._selectedPeriod=i,t.showFooterText();}),this._controls.ending.subscribe('onSelectedItemChange',function(e,i){t._selectedEnding=i,t.showFooterText();}),this.subscribeTo(this._controls.date,'onDateChange',function(){t._selectedDate=t._controls.date.getDate(),t.showFooterText(),this.setActive(true);}),this.subscribeTo(this._controls.every,'onTextChange',function(){t._selectedEvery=t._controls.every.getValue(),t.showFooterText(),this.setActive(true);}),this.subscribeTo(this._controls.times,'onTextChange',function(){t._selectedTimes=t._controls.times.getValue(),t.showFooterText(),this.setActive(true);});var n=[{validator:this._validatePastDate.bind(this),errorMessage:rk('Дата напоминания не может быть в прошлом')}];this.subscribeTo(this._controls.date,'onAfterShow',function(){this.setValidators(n);}),this.subscribeTo(this._controls.save,'onActivated',this.onSave.bind(this)),this.subscribeTo(this._controls.periodMenu,'onMenuItemActivate',this._onPeriodSelected.bind(this)),this.subscribeTo(this._controls.ending,'onMenuItemActivate',this._onEndingSelected.bind(this)),t.showFooterText();},onSave:function(){var t=this.getLinkedContext();t.setValue('period',this._selectedPeriod),t.setValue('every',this._selectedEvery),t.setValue('ending',this._selectedEnding),t.setValue('date',this._selectedDate),t.setValue('times',this._selectedTimes),this.sendCommand('close');},onKeyPressed:function(e,i){if(i.which===t.key.enter)self.onSave();},_onPeriodSelected:function(t,e){this._updatePeriodMenu(e);},_onEndingSelected:function(t,e){this._updateEnding(e);},_updatePeriodMenu:function(t){var e=this._controls.periodMenu,i=e.getItems().getRecordById(t);if(e.setCaption(i.get('title')),i)this._selectedPeriod=t,this.showFooterText();},_validatePastDate:function(){var t=this._controls.date.getDate();if(t)return new Date().setHours(0,0,0,0)<=t;else return true;},_updateEnding:function(t){var e=this._controls.ending,i=e.getItems().getRecordById(t);if(e.setCaption(i.get('title')),i)this._selectedEnding=t,this.showFooterText();},showFooterText:function(){},destroy:function(){s.superclass.destroy.call(this),this._controls=this._dom=null;}});return s;});
define("html!SBIS3.Notes.Page",function(){var o=function(o){var t=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(t){for(;o.test(t);)t=t.replace(o,"&#123;&#123;$1&#125;&#125;");return t}}(),n=function(o){return o.join?o.join(""):o.toString()},e=function(o){return void 0===o?"":o&&"object"==typeof o?n(o):""+o},a="undefined"!=typeof process,i=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,'<div class="ws-note-page"> <component data-component="SBIS3.CONTROLS/Tab/Buttons" name="tabs"> <option name="idProperty">id</option> <option name="displayProperty">title</option> <option name="selectedKey">tags</option> <options name="items" type="Array"> <options> <option name="id">pages</option> <option name="title">'+t(e(rk("По месту размещения")))+'</option> </options> <options> <option name="id">tags</option> <option name="title">'+t(e(rk("По тегам")))+'</option> </options> </options> <option name="tabSpaceTemplate"> <component data-component="SBIS3.CONTROLS/Button" name="addNote"> <option name="className">controls-Button__compactMode ws-note-page__add-button</option> <option name="caption">+ '+t(e(rk("Заметка")))+'</option> <option name="primary" type="boolean" value="true"></option> <option name="tooltip">'+t(e(rk("Создать заметку")))+'</option> <option name="icon">sprite:icon-24 icon-AddButtonNew icon-hover</option> </component><component data-component="SBIS3.CONTROLS/Button" name="addTag"> <option name="className">ws-note-page__add-tag</option> <option name="caption">+ '+t(e(rk("Тег")))+'</option> <option name="tooltip">'+t(e(rk("Создать тег")))+'</option> <option name="visible">false</option> </component> </option> </component> <div class="ws-note-page__filters"> <table style="width: 100%"> <tr> <td style="padding-left: 8px;" class="ws-note__search-form-table"> <component data-component="SBIS3.CONTROLS/SearchForm" name="search" class="ws-note-search"> <option name="placeholder">'+t(e(rk("Найти по тексту заметки")))+'</option> <option name="maxLength">30</option> <option name="startCharacter">3</option> </component> </td> <td style="width: 260px;" class="ws-note__search-form-table"> <component data-component="Deprecated/Controls/FilterButton/FilterButton" name="filter"> <option name="template" value="js!SBIS3.Notes.NotesFilter"></option> <option name="maxWidth" value="200"></option> <option name="mode" value="hover"></option> <option name="browserId" value="browserId111"></option> <option name="tooltip">'+t(e(rk("Установить фильтры отображения")))+'</option> </component> </td> </tr> </table> </div> <component data-component="SBIS3.CONTROLS/ScrollContainer" class="scrollContainerList"> <option name="content"> <component data-component="SBIS3.Notes.AddTag" name="addTagDialog"> <option name="visible">false</option> </component> <component data-component="SBIS3.Notes.TagListView" name="tags" class="ws-note-left-list controls-ListView__orangeMarker"> <option name="visible">false</option> <option name="filterName">Tag</option> <option name="filterPropertyName">Name</option> </component> <component data-component="SBIS3.CONTROLS/ListView" name="pages" class="ws-note-left-list ws-note-left-pages controls-ListView__orangeMarker"> <option name="idProperty">ID</option> <option name="itemTpl">html!SBIS3.Notes.Page/templates/Page</option> <option name="itemContentTpl">html!SBIS3.Notes.Page/templates/PageContent</option> <options name="itemsActions" type="array"></options> <option name="itemsDragNDrop">false</option> <option name="visible" type="boolean" value="false"></option> <option name="emptyHTML"></option> <option name="filterName">Url</option> <option name="filterPropertyName">ID</option> </component> </option> </component> <component data-component="SBIS3.CONTROLS/ScrollContainer" class="scrollContainerNotes"> <option name="content"> <component data-component="SBIS3.Notes.StaticNotesView" name="notes"> <option name="visible">false</option> </component> </option> </component> <div class="ws-clear"></div> </div>');return(i=t(i))+(a&&-1!==i.indexOf("{{")?String.fromCharCode(8203,8203):"")};return o.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.Page"}},o});
define("html!SBIS3.Notes.AddTag",function(){var o=function(o){var n=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,"&#123;&#123;$1&#125;&#125;");return n}}(),t=function(o){return o.join?o.join(""):o.toString()},e=function(o){return void 0===o?"":o&&"object"==typeof o?t(o):""+o},i="undefined"!=typeof process,a=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,'<div class="ws-note__tag-addTagForm ws-hidden"> <component data-component="SBIS3.CONTROLS/SearchForm" name="tagName"> <option name="placeholder">'+n(e(rk("введите тег")))+'</option> <option name="trim">true</option> <option name="selectOnClick">true</option> <option name="maxLength">64</option> </component> <div class="ws-note__tag-addTagForm-buttons"> <component data-component="SBIS3.Notes.MenuColor" name="tagColor"> <option name="tooltip">'+n(e(rk("Задать цвет тега")))+'</option> <option name="tabindex">3</option> <option name="idProperty" type="string">id</option> <option name="activableByClick">false</option> </component> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="save" class="controls-IconButton__round-border-24"> <option name="icon">sprite:icon-16 icon-Yes icon-done</option> <option name="tooltip">'+n(e(rk("Сохранить изменения")))+'</option> <option name="tabindex">4</option> </component> </div> <component data-component="SBIS3.CONTROLS/ListView" name="recentTags" class="ws-note__recent-tags"> <option name="idProperty">Id</option> <option name="itemsDragNDrop">false</option> <option name="pageSize">10</option> <option name="itemContentTpl">tmpl!SBIS3.Notes.Tags/Tag</option> <option name="visible">false</option> <options name="itemsActions" type="array"></options> </component> </div>');return(a=n(a))+(i&&-1!==a.indexOf("{{")?String.fromCharCode(8203,8203):"")};return o.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.AddTag"}},o});
define("tmpl!SBIS3.Notes.Tags/Tag",["Core/tmpl/js/tclosure"],function(){var e=Array.prototype.slice.call(arguments),t=e[0],r={},a=function e(a,i,o,s,n){function l(){}var c=0,u=void 0!==t&&t?t:arguments[arguments.length-1];void 0===u&&(eval("var thelpers = null;"),u=global.requirejs("View/Runner/tclosure"));var d={};n&&n.isSetts&&(d=n.fullContext||{});var p="string"==typeof o?o:"",g=void 0===r?void 0:r,m={id:[],def:void 0},f=u.configResolver.calcParent(this,"undefined"==typeof currentPropertyName?void 0:currentPropertyName,a),v=this&&this.includedTemplates?this.includedTemplates:{},h=u.getMarkupGenerator(s);try{var T=h.joinElements([h.createTag("span",{class:"controls-ListView__itemCheckBox js-controls-ListView__itemCheckBox"},[],i,m,this),h.createTag("span",{class:"ws-note__tag ws-note__tag_color-"+u.wrapUndef(u.utils.escape(u.getter(a,["item","Color"])))},[h.createText(""+u.wrapUndef(u.utils.escape(u.getter(a,["item","Name"]))))],i,m,this)],p,m);m.def&&(T=h.chain(T,m,i),m=void 0)}catch(e){u.templateError("resources/Zametki/Tag/Tag.tmpl",e,a)}return T||""};return a.includedFunctions={},a.stable=!0,a.toJSON=function(){return{$serialized$:"func",module:"tmpl!SBIS3.Notes.Tags/Tag"}},a});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.AddTag", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-note__tag-addTagForm{width:250px;box-sizing:border-box;margin-left:0;background:#f3f3f3;padding:10px 8px 0 18px;position:relative;min-height:43px}.ws-note__tag-addTagForm .ws-note__recent-tags .controls-ListView__hoveredItem{background:0 0}.ws-note__tag-addTagForm .controls-SearchForm{border-radius:0;-moz-border-radius:0;-webkit-border-radius:0;width:160px}.ws-note__tag-addTagForm .ws-note__tag-addTagForm-buttons{float:right}.ws-note__tag-addTagForm .controls-SearchForm.controls-TextBox,.ws-note__tag-addTagForm .controls-SearchForm.controls-TextBox.ws-has-focus,.ws-note__tag-addTagForm .controls-SearchForm.controls-TextBox:hover{background:#fff}.ws-note__tag-addTagForm .ws-note__recent-tags{margin-top:8px;max-width:270px;background:0 0}.ws-note__tag-addTagForm .ws-note__recent-tags span.ws-note__tag{cursor:pointer}.ws-note__tag-addTagForm .controls-SearchForm .controls-TextBox__afterFieldWrapper{display:none}.ws-note__tag-addTagForm .controls-SearchForm.controls-TextBox .controls-TextBox__fieldWrapper{margin:0 4px 0 -8px}"));head.appendChild(style);});}
define('js!SBIS3.Notes.AddTag',['Core/helpers/String/escapeHtml','Core/EventBus','SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.AddTag','WS.Data/Source/SbisService','js!SBIS3.BL.Note','js!SBIS3.Notes.Utils.Info','SBIS3.CONTROLS/TextBox','SBIS3.CONTROLS/CheckBox','js!SBIS3.Notes.MenuColor','SBIS3.CONTROLS/Button/IconButton','SBIS3.CONTROLS/ListView','SBIS3.CONTROLS/SearchForm','tmpl!SBIS3.Notes.Tags/Tag','css!SBIS3.Notes.AddTag','Zametki_localization'],function(t,o,s,e,i,n,a){'use strict';var r=s.extend({_dotTplFn:e,$protected:{_controls:null,_tagValue:'',_tagColor:0,_newColor:0},$constructor:function(){this._publish('onCloseDialog');},init:function(){r.superclass.init.call(this),this._cacheControls(),this._controls.recentTags.setDataSource(new i({endpoint:{address:'/notes/service/',contract:'Note'},idProperty:'Name',binding:{query:'GetRecentTags'}}),true),this.subscribeTo(this,'onAfterVisibilityChange',function(t,o){if(o)this._controls.tagName.getContainer().find('input')[0].focus();}.bind(this)),this.subscribeTo(this,'onFocusOut',function(){if(''===this._controls.tagName.getText())this._controls.tagName.clearMark();this.setVisible(false);}.bind(this)),this.subscribeTo(this._controls.recentTags,'onDataLoad',function(t,o){if(o.getCount())this.show();}),this.subscribeTo(this._controls.tagName,'onSearchStart',this._onSearch.bind(this)),this.subscribeTo(this._controls.tagName,'onSearch',this._onSearch.bind(this)),this.subscribeTo(this._controls.tagName,'onReset',this._onSearch.bind(this)),this.subscribeTo(this._controls.tagColor,'onColorSelected',this._onColorize.bind(this)),this.subscribeTo(this._controls.recentTags,'onItemClick',this._onTagClick.bind(this)),this.subscribeTo(this._controls.save,'onActivated',this._onSave.bind(this));},destroy:function(){this._controls=null,r.superclass.destroy.call(this);},_cacheControls:function(){this._controls=(this.getChildControls()||[]).reduce(function(t,o){var s=o.getName();if(s)t[s]=o;return t;},{});},_onSearch:function(){var t=this._controls.recentTags,o=this._controls.tagName.getText();if(t.hide(),o){var s=t.getFilter()||{};if(s.SearchQuery!=o)s.SearchQuery=o,t.setFilter(s);}},_onColorize:function(t,o){this._newColor=+o,this._controls.tagName.setActive(true);},_addTag:function(s,e){var i=this,r=this._controls.tagName;n.addIndependentTag(s,e).addCallbacks(function(t){if(n.isDemo())a.showMessageDialog({message:rk('В демо-режиме нельзя добавлять теги в реестр'),status:'error'}),i._closeDialog();else o.channel('NotesEvents').notify('onTagAdded',null,[]),i._closeDialog('add');},function(o){r.markControl(t(o.message),true);});},_editTag:function(s,e){var i=this,a=i._controls.tagName;n.updateTag(s,s,e).addCallbacks(function s(e){if(''===e)o.channel('NotesEvents').notify('onTagUpdated',null,null),i._closeDialog('update');else a.markControl(t(e),true);},function o(s){a.markControl(t(s.details),true);});},_onSave:function(){var t=this._controls.tagName,o=t.getText();if(o&&o.length)o=o.trim();if(o)if(this._tagValue!==o)if(o.length<3)t.markControl(rk('Длина тега должна быть не менее 3-х символов'),true);else this._addTag(o,this._newColor);else if(this._tagColor!==this._newColor)this._editTag(o,this._newColor);else this._closeDialog('cancel');else t.markControl(rk('Необходимо ввести тег'),true);},_onTagClick:function(t,o,s,e){if($(e).hasClass('ws-note__tag'))this._tagValue=s.get('Name'),this._tagColor=this._newColor=s.get('Color'),this._controls.tagName.setText(this._tagValue),this._controls.tagName.setActive(true),this._controls.tagColor.setIcon('sprite:icon-16 icon-primary ws-note-tag-color ws-note-tag-color_color-'+this._tagColor);},_closeDialog:function(t){this._notify('onCloseDialog',t),this.setVisible(false),this._tagValue='',this._newColor=this._tagColor=0,this._controls.tagName.setText(''),this._controls.tagName.clearMark(),this._controls.tagColor.setIcon('sprite:icon-16 icon-primary ws-note-tag-color ws-note-tag-color_color-0'),this._controls.recentTags.hide();}});return r;});
define("html!SBIS3.Notes.TagListView/templates/Tag",function(){var e=function(e){var t=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(t){for(;e.test(t);)t=t.replace(e,"&#123;&#123;$1&#125;&#125;");return t}}(),r=function(e){return e.join?e.join(""):e.toString()},n=function(e){return void 0===e?"":e&&"object"==typeof e?r(e):""+e},o="undefined"!=typeof process,i=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,"");return e.className="ws-note-used-tag ws-clickable",i+=" "+t(n(e.defaultItemTpl(e))),(i=t(i))+(o&&-1!==i.indexOf("{{")?String.fromCharCode(8203,8203):"")};return e.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.TagListView/templates/Tag"}},e});
define("html!SBIS3.Notes.TagListView/templates/TagContent",function(){var t=function(t){var n=function(){var t={"&":"&#38;","<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","/":"&#47;"},n=/&(?!#?\w+;)|<|>|"|'|\//g;return function(o){return o?o.toString().replace(n,function(n){return t[n]||n}):o}}(),o=function(){var t=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;t.test(n);)n=n.replace(t,"&#123;&#123;$1&#125;&#125;");return n}}(),e=function(t){return t.join?t.join(""):t.toString()},i=function(t){return void 0===t?"":t&&"object"==typeof t?e(t):""+t},r="undefined"!=typeof process,a=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,"");return t.item.get("Name")?a+=' <span class="ws-note__tag ws-note__tag_color-'+o(i(t.item.get("Color")))+'">'+o(i(n(t.item.get("Name"))))+'</span> <div class="ws-note-tag__actions"> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="edit'+o(i(n(t.item.get("Id"))))+'"> <option name="icon">sprite:icon-24 icon-Edit icon-primary</option> <option name="tooltip">'+o(i(rk("Редактировать тег")))+'</option> <options name="handlers"> <option name="onActivated" type="function"> js!SBIS3.Notes.TagListView:prototype._onEdit </option> </options> </component> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="delete'+o(i(n(t.item.get("Id"))))+'" class="controls-Button__deleteTag"> <option name="icon">sprite:icon-24 icon-Erase icon-error</option> <option name="tooltip">'+o(i(rk("Удалить тег")))+'</option> <options name="handlers"> <option name="onActivated" type="function"> js!SBIS3.Notes.TagListView:prototype._onRemove </option> </options> </component> </div> ':a+=" <span>"+o(i(rk("Без тегов")))+"</span> ",a+=' <span class="ws-note-tag__count">'+o(i(t.item.get("Count")))+"</span>",(a=o(a))+(r&&-1!==a.indexOf("{{")?String.fromCharCode(8203,8203):"")};return t.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.TagListView/templates/TagContent"}},t});
define('js!SBIS3.Notes.TagListView',['Core/core-functions','Core/core-instance','Core/helpers/String/escapeHtml','Core/constants','SBIS3.CONTROLS/ListView','WS.Data/Source/SbisService','html!SBIS3.Notes.TagListView/templates/Tag','html!SBIS3.Notes.TagListView/templates/TagContent','js!SBIS3.BL.Note','js!SBIS3.Notes.TouchDragNDropMixin','Core/EventBus','SBIS3.CONTROLS/Utils/InformationPopupManager','SBIS3.CONTROLS/Button/IconButton','js!SBIS3.Notes.MenuColor','Zametki_localization'],function(t,e,o,i,n,a,s,r,d,l,g,c){'use strict';var _=n.extend([l],{$protected:{_options:{itemTpl:s,itemContentTpl:r,idProperty:'Id',itemsActions:[],editingTemplate:'<component data-component="SBIS3.CONTROLS/TextBox" name="tagName" class="ws-note-tagList__edit">'+'<option name="text" bind="Name"></option>'+'<option name="tabindex">1</option>'+'<option name="maxLength">64</option>'+'</component>'+'<component data-component="SBIS3.Notes.MenuColor" name="tagColor">'+'<option name="color" bind="Color"></option>'+'</component>',editMode:'toolbar',emptyHTML:''},_doNotRefreshNotes:false,_lastHoveredItemId:0,_tagNameField:null,_tagColor:0},init:function(){_.superclass.init.call(this);var t=this;this.setDataSource(new a({endpoint:{address:'/notes/service/',contract:'Note'},binding:{query:'GetUsedTags'},idProperty:'Id'}),true),this.subscribeTo(this,'onAfterBeginEdit',this.onAfterBeginEdit.bind(this)),this.subscribeTo(this,'onEndEdit',this._onEndEdit.bind(this));var e=g.channel('NotesEvents');this.subscribeTo(e,'onTagFormOpened',function(){t._isTagFormOpened=true;}),this.subscribeTo(e,'onTagFormClosed',function(){t._isTagFormOpened=false;});var o=g.channel('TagsEvents');if(this.subscribeTo(o,'onRemoveTagInList',this.onRemoveTag.bind(this)),this.subscribeTo(o,'onUpdateTagInList',this.onUpdateTag.bind(this)),this.subscribeTo(this,'onAfterEndEdit',function(t,e){this._isEdited=false;}),i.browser.isMobilePlatform)this.subscribeTo(this,'onDrawItems',function(t,e){this.getContainer().on('touchstart touchend','.ws-note-tag__actions .controls-Button__deleteTag, .ws-note-tag__actions .controls-Button__deleteTag *',function(t){t.stopPropagation();});});},_onServerMessage:function(){if(!this._isTagFormOpened)this.reload();},_setItemsDragNDrop:function(t){this._options.itemsDragNDrop=t,this._getItemsContainer()[t?'on':'off']('mousedown touchstart','.js-controls-ListView__item .ws-note__tag',this._getDragInitHandler());},onAfterBeginEdit:function(t,e){if(!this._tagNameField)this._tagNameField=this._editInPlace.getChildControlByName('tagName'),this._tagNameField.getContainer().on('keyup','.controls-TextBox__field',this._onKeyUp.bind(this)),this._tagColor=this._editInPlace.getChildControlByName('tagColor'),this._tagColor.setColor(e.get('Color'));},_mouseLeaveHandler:function(){if(!i.browser.isMobilePlatform)_.superclass._mouseLeaveHandler.apply(this,arguments);},_swipeHandler:function(t){var e=$(t.target);if(!e.hasClass('ws-note__tag'))if(t.swipestart.coords[0]-t.swipestop.coords[0]>10)this._changeHoveredItem(e);},_onKeyUp:function(t){if(t.keyCode===i.key.enter)t.preventDefault(),t.stopPropagation();},_onEndEdit:function(t,e,i){var n=this,a=n.getContainer();if(i){var s=this._tagNameField.getText(),r=this._tagColor.getColor(),l=this.getItems().getRecordById(this.getSelectedKey());if(s&&s.length)s=s.trim();if(s.length<3){if(t)n.reload().addCallback(function(){n._tagNameField.getContainer().off('keyup','.controls-TextBox__field',n._onKeyUp),n._tagColor=n._tagNameField=null,n.reactivateEdit(l,s,r),n._tagNameField=n._editInPlace.getChildControlByName('tagName'),n._tagColor=n._editInPlace.getChildControlByName('tagColor'),n._tagNameField.setText(s),n._tagColor.setColor(r),n._tagNameField.getContainer().on('keyup','.controls-TextBox__field',n._onKeyUp.bind(this)),n._tagNameField.markControl(rk('Длина тега должна быть не менее 3-х символов'),true);});}else g.channel('NotesEvents').notify('onBeforeTagUpdate'),d.updateTag(l.get('Name'),s,r).addCallbacks(function t(e){if(''===e)n._tagNameField.getContainer().off('keyup','.controls-TextBox__field',n._onKeyUp),n._tagNameField=null,n._notify('onTagUpdated',l.get('Name'),s,r),a.find('.ws-note-tag__actions').removeClass('ws-hidden'),a.find('.ws-note-used-tag[data-id="'+l.get('Id')+'"] > .ws-note__tag').css('visibility','visible'),n.reload();else n.reactivateEdit(l),n._tagNameField.setText(s),n._tagColor.setColor(r),n._tagNameField.markControl(o(e),true);},function t(e){n.reactivateEdit(l,s),n._tagColor.setColor(r),n._tagNameField.markControl(o(e.details),true);});}else a.find('.ws-note-tag__actions').removeClass('ws-hidden'),a.find('.ws-note-used-tag > .ws-note__tag').css('visibility','visible');if(t)t.setResult('NotSave');},reactivateEdit:function(t){var e=this.getContainer(),o=t.get('Id');this.setSelectedKeys([o]),this.sendCommand('beginEdit',t),e.find('.ws-note-tag__actions').addClass('ws-hidden'),e.find('.ws-note-used-tag[data-id="'+o+'"] > .ws-note__tag').css('visibility','hidden');},_beginDragHandler:function(t,e){if(!$(e.target).hasClass('ws-note__tag'))return false;var o=$(e.target).closest('.ws-note-used-tag');if(o.length&&'00000000-0000-0000-0000-000000000000'===o.data('id'))return false;_.superclass._beginDragHandler.apply(this,arguments),i.$body.addClass('dragdropTag').removeClass('dragdropNote');},_onDragHandler:function(t,e){if(e.originalEvent.preventDefault(),_.superclass._onDragHandler.apply(this,arguments),'touchmove'===e.type){var o=e.originalEvent.changedTouches[0],i=document.elementFromPoint(o.clientX,o.clientY),n=$(i).closest('.ws-note_static');if(n.length){var a=n.data('id');$('.ws-note_static').removeClass('controls-ListView__hoveredItem'),$('.ws-note_static[data-id='+a+']').addClass('controls-ListView__hoveredItem');}}},onUpdateTag:function(t,e){var o=this.getHoveredItem().record||this.getItems().at(this.getSelectedIndex());if(o&&!this._isEdited){var i=o.get('Id'),n=this.getContainer();this._lastHoveredItemId=i,this._isEdited=true,e.sendCommand('beginEdit',o),n.find('.ws-note-tag__actions').addClass('ws-hidden'),n.find('.ws-note-used-tag[data-id="'+i+'"] > .ws-note__tag').css('visibility','hidden');}},_onEdit:function(){g.channel('TagsEvents').notify('onUpdateTagInList',this);},onRemoveTag:function(){var e=this,i=this.getHoveredItem().record.get('Name');c.showConfirmDialog({message:rk('Удалить тег')+' "'+o(i)+'" '+rk('из всех заметок?'),parent:e,opener:e},function(){d.deleteTag(i).addCallbacks(function(){e.reload(),g.channel('NotesEvents').notify('onTagRemoved',null,i);},function(e){t.alert(e.details,'error');});});},_onRemove:function(){g.channel('TagsEvents').notify('onRemoveTagInList');},_endDragHandler:function(t){var o=new Date().getTime();if(this._lastDropTime&&o-this._lastDropTime<500)return;this._lastDropTime=o,i.$body.removeClass('dragdropTag');var n=t.getSource();if(n&&n.getCount()>0){var a=t.getTarget();if(a)if(e.instanceOfModule(t.getOwner(),'SBIS3.Notes.StaticNoteListView')){var s=n.at(0).getModel().getId(),r=a.getModel().getId();if(r&&s)g.channel('NoteCommands').notify('AddTag',s,r);}}}});return _;});
define("html!SBIS3.Notes.TagEditor",function(){var o=function(o){var n=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,"&#123;&#123;$1&#125;&#125;");return n}}(),t=function(o){return o.join?o.join(""):o.toString()},e=function(o){return void 0===o?"":o&&"object"==typeof o?t(o):""+o},i="undefined"!=typeof process,a=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,'<div class="ws-note__tag-editor ws-hidden"> <component data-component="SBIS3.CONTROLS/CheckBox" name="addTag"> <option name="tabindex">2</option> </component> <component data-component="SBIS3.CONTROLS/TextBox" name="tagName"> <option name="text">'+n(e(o.tagValue))+'</option> <option name="tabindex">1</option> <option name="maxLength">64</option> </component> <div class="ws-note__tag-editor-buttons"> <component data-component="SBIS3.Notes.MenuColor" name="colorize"> <options> <option name="tooltip">'+n(e(rk("Задать цвет тега")))+'</option> <option name="activableByClick">false</option> <option name="tabindex">3</option> </options> </component> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="save" class="controls-IconButton__round-border-24"> <option name="icon">sprite:icon-16 icon-Yes icon-done</option> <option name="tooltip">'+n(e(rk("Сохранить изменения")))+'</option> <option name="tabindex">4</option> </component> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="cancel" class="controls-PopupMixin__closeButton ws-note__tag-editor-close"> <option name="tooltip">'+n(e(rk("Отмена")))+'</option> <option name="tabindex">5</option> </component> </div> </div>');return(a=n(a))+(i&&-1!==a.indexOf("{{")?String.fromCharCode(8203,8203):"")};return o.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.TagEditor"}},o});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.TagEditor", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-note__tag-editor{width:399px;box-sizing:border-box;margin-left:0;background:#f3f3f3;padding:4px 8px 8px 8px;position:relative}.ws-note__tag-editor>.controls-TextBox{width:358px;float:right}.ws-note__tag-editor-buttons{clear:both;text-align:right;padding-top:8px}.ws-note__tag-editor-buttons .controls-IconButton__round-border{width:28px;height:28px;line-height:26px!important}.ws-note__tag-editor .ws-note__tag-editor-buttons .controls-IconButton.ws-note__tag-editor-close{position:relative!important;margin-right:-9px;top:0!important}.ws-note__tag-editor-buttons span.controls-IconButton{margin-left:4px}.ws-note__recent-tags .controls-editInPlace .controls-editInPlace__editor{padding:0}.controls-editInPlace__editor .ws-note__tag-editor span.controls-CheckBox{margin-top:3px}"));head.appendChild(style);});}
define('js!SBIS3.Notes.TagEditor',['Core/helpers/String/escapeHtml','Core/EventBus','SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.TagEditor','js!SBIS3.BL.Note','SBIS3.CONTROLS/TextBox','js!SBIS3.Notes.MenuColor','SBIS3.CONTROLS/CheckBox','SBIS3.CONTROLS/Button/IconButton','css!SBIS3.Notes.TagEditor','Zametki_localization'],function(t,o,e,s,n){'use strict';var i=e.extend({_dotTplFn:s,$protected:{_options:{tagId:0,tagValue:rk('название тега'),tagColor:0,newTagColor:null,tagChecked:false,activatedByParent:false}},$constructor:function(){},_modifyOptions:function(t){var o=i.superclass._modifyOptions.apply(this,arguments);return o.tagValue=rk('название тега'),o;},init:function(){i.superclass.init.call(this),this._controls={},this._controls.addTag=this.getChildControlByName('addTag'),this._controls.tagName=this.getChildControlByName('tagName'),this._controls.tagColor=this.getChildControlByName('colorize'),this._controls.save=this.getChildControlByName('save'),this._controls.cancel=this.getChildControlByName('cancel'),this._controls.tagName.getContainer().on('keyup',this._onKeyUp.bind(this)),this.subscribeTo(this._controls.tagColor,'onColorSelected',this._onColorize.bind(this)),this.subscribeTo(this._controls.save,'onActivated',this._onSave.bind(this)),this.subscribeTo(this._controls.cancel,'onActivated',this._onCancel.bind(this)),this.subscribeTo(o.channel('TagsEvents'),'onBeginEditTag',this.prepareValues.bind(this)),this.subscribeTo(this,'onActivate',this._onActivate.bind(this));},_onActivate:function(){if(this._options.activatedByParent){var t=this._controls.recentTags.getSelectedKeys();this._controls.tagName.setText(this._options.tagValue),this._controls.tagColor.setIcon('sprite:icon-16 icon-primary ws-note-tag-color ws-note-tag-color_color-'+this._options.tagColor),this._options.tagChecked=t.indexOf(this._options.tagId)>=0,this._controls.addTag.setChecked(this._options.tagChecked),this._options.activatedByParent=false;}},prepareValues:function(t,o){this._controls.recentTags=o,this._options.activatedByParent=true,this._onActivate();},_onKeyUp:function(t){if(13===t.keyCode)t.preventDefault(),t.stopPropagation(),this._onSave();},_onColorize:function(t,o){this._options.newTagColor=+o;},_onSave:function(){var o=this,e=this._options.tagId,s=this._controls.tagName,i=this._options.tagValue,a=s.getText(),r=this._options.tagColor,c=this._options.newTagColor,l=this._controls.addTag.isChecked(),h=[].concat(this._controls.recentTags.getSelectedKeys());if(i!==a||null!==c&&c!==r){if(a&&a.length)a=a.trim(),s.setText(a);if(a.length<3)return void s.markControl(rk('Длина тега должна быть не менее 3-х символов'),true);n.updateTag(i,a,null!==c?c:r).addCallbacks(function n(d){if(''===d){if(o._options.tagChecked!==l){if(l)h=h.concat(e);else h.splice(h.indexOf(e),1);o._controls.recentTags.setSelectedKeys(h);}o._controls.recentTags._notify('onTagUpdated',i,a,null!==c?c:r),o._controls.recentTags.reload();}else s.markControl(t(d),true);},function o(e){s.markControl(t(e.details),true);});}else{if(this._options.tagChecked!==l){if(l)h=h.concat(e);else h.splice(h.indexOf(e),1);this._controls.recentTags.setSelectedKeys(h);}this._controls.recentTags.sendCommand('cancelEdit');}},_onCancel:function(){this._controls.recentTags.sendCommand('cancelEdit');},destroy:function(){this._controls.tagName.getContainer().off('keydown',this._onKeyDown),i.superclass.destroy.call(this);}});return i;});
define("html!SBIS3.Notes.Page/templates/Page",function(){var e=function(e){var t=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(t){for(;e.test(t);)t=t.replace(e,"&#123;&#123;$1&#125;&#125;");return t}}(),r=function(e){return e.join?e.join(""):e.toString()},n=function(e){return void 0===e?"":e&&"object"==typeof e?r(e):""+e},o="undefined"!=typeof process,a=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,"");return e.className="ws-note-used-tag ws-clickable",a+=" "+t(n(e.defaultItemTpl(e))),(a=t(a))+(o&&-1!==a.indexOf("{{")?String.fromCharCode(8203,8203):"")};return e.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.Page/templates/Page"}},e});
define("html!SBIS3.Notes.Page/templates/PageContent",function(){var e=function(e){var t=function(){var e={"&":"&#38;","<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","/":"&#47;"},t=/&(?!#?\w+;)|<|>|"|'|\//g;return function(n){return n?n.toString().replace(t,function(t){return e[t]||t}):n}}(),n=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(t){for(;e.test(t);)t=t.replace(e,"&#123;&#123;$1&#125;&#125;");return t}}(),r=function(e){return e.join?e.join(""):e.toString()},o=function(e){return void 0===e?"":e&&"object"==typeof e?r(e):""+e},i="undefined"!=typeof process,a=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,n(o(t(e.item.get("PageTitle"))))+' <div class="ws-note-page__breadcrumbs">'+n(o(t(e.item.get("Breadcrumbs"))))+'</div> <span class="ws-note-tag__count">'+n(o(e.item.get("CountNotes")))+"</span>");return(a=n(a))+(i&&-1!==a.indexOf("{{")?String.fromCharCode(8203,8203):"")};return e.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.Page/templates/PageContent"}},e});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.NotesView", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-notes-container,.ws-notes-holder{position:absolute;top:0;left:0;overflow:visible!important}.ws-note .ws-note__content{overflow:hidden;padding:6px 8px}.ws-note .ws-note__scroll{height:100%}.ws-note__content .ws-basic-style img{cursor:pointer}.ws-note__body{box-shadow:1px 0 4px 0 #ccc}.ws-note__body .ws-basic-style .ws-note__checkable,.ws-note__body .ws-basic-style li,.ws-note__body .ws-basic-style p{word-wrap:break-word;line-height:140%}.ws-note__checkable a{pointer-events:auto}.ws-note__body .ws-basic-style .ws-note__checkable{margin:0 0 0 -25px;padding:0 0 0 25px}.ws-is-mobile-chrome-ios .ws-note__checkable_unchecked:before,.ws-is-mobile-platform .ws-note__checkable_unchecked:before,.ws-is-mobile-safari .ws-note__checkable_unchecked:before{background-position:0 1px}.ws-is-mobile-chrome-ios .ws-note__checkable_checked:before,.ws-is-mobile-platform .ws-note__checkable_checked:before,.ws-is-mobile-safari .ws-note__checkable_checked:before{background-position:0 -15px}.ws-note__body .ws-basic-style>ol,.ws-note__body .ws-basic-style>ul{margin-top:0;margin-bottom:0}.ws-note__body .ws-basic-style .content-wrap li,.ws-note__body .ws-basic-style .content-wrap>p,.ws-note__body .ws-basic-style li,.ws-note__body .ws-basic-style>p{margin-bottom:0}.ws-note-header-image{vertical-align:top;padding:0;margin:6px 2px 0 8px;color:#999!important}.ws-note-calendar-html{color:#999;display:inline-block;padding:5px 0 0 0;font-size:12px;margin:0}.ws-note-tmp{font-size:0;width:1px;height:1px;float:left;display:inline;margin:0;padding:0}.ws-note__checkable{list-style-type:none;line-height:16px;margin-left:-25px;padding-left:25px;pointer-events:none}.ws-note__body .ws-note__checkable{min-height:16px}.ws-note__checkable:after{content:'.';font-size:1px;color:transparent;display:inline;float:right;line-height:0}.ws-is-ie10 .ws-note__checkable:after{float:none}.ws-note__checkable:before{margin-left:-25px;cursor:pointer}.ws-note__checkable_checked:before,.ws-note__checkable_unchecked:before{display:inline-block;margin-right:9px;cursor:pointer;content:'.';color:transparent;background:url(/resources/SBIS3.CONTROLS/themes/online/img/CheckBox.v1516270649826335cf4508dd597be4bfc9caa3e08b901.png) 0 0 no-repeat;width:16px;height:16px;vertical-align:text-top;pointer-events:auto}.ws-note__checkable_checked:before{background-position:0 -16px}li.ws-note__checkable_checked{text-decoration:line-through;color:#999}.ws-note-tags-html{position:relative;overflow:hidden;padding:0 8px;font-size:0;width:100%;box-sizing:border-box}.ws-note__tag{font-size:11px;display:inline-block;padding:0 4px;-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px;border-width:1px;border-style:solid;white-space:nowrap;word-spacing:normal;vertical-align:top;line-height:16px;max-width:95%;margin:2px 4px 3px 4px;text-overflow:ellipsis;overflow:hidden}.ws-note__has-calendar .ws-note__tag{margin-bottom:0;margin-top:4px}.ws-note-tag-color_color-0,.ws-note__tag_color-0{background:#fff}.ws-note__tag_color-0{border-color:#c8c8c8;color:#000}.ws-note-tag-color_color-1,.ws-note__tag_color-1{background:red}.ws-note__tag_color-1{border-color:red;color:#fff}.ws-note-tag-color_color-2,.ws-note__tag_color-2{background:#fec63f}.ws-note__tag_color-2{border-color:#fec63f;color:#000}.ws-note-tag-color_color-3,.ws-note__tag_color-3{background:#72be44}.ws-note__tag_color-3{border-color:#72be44;color:#fff}.ws-note-tag-color_color-4,.ws-note__tag_color-4{background:#587ab0}.ws-note__tag_color-4{border-color:#587ab0;color:#fff}.ws-note-tags{padding:0 8px}.ws-note-tags .ws-note__tag{margin:4px;cursor:pointer}.ws-note-tags__remove{vertical-align:top;cursor:pointer;margin-left:4px}.ws-note-tags__ellipsis{border:1px solid #ccc;padding:0 4px;background:#fff;font-size:11px;display:inline-block;border-radius:3px;white-space:nowrap;word-spacing:normal;vertical-align:top;line-height:16px;margin:4px 0 4px 4px}.ws-note-tag-color,.ws-note__tag-editor-buttons .controls-Button__icon.ws-note-tag-color_color-0,.ws-note__tag-editor-buttons .controls-Button__icon.ws-note-tag-color_color-1,.ws-note__tag-editor-buttons .controls-Button__icon.ws-note-tag-color_color-2,.ws-note__tag-editor-buttons .controls-Button__icon.ws-note-tag-color_color-3,.ws-note__tag-editor-buttons .controls-Button__icon.ws-note-tag-color_color-4,.ws-note__tag-editor-buttons .controls-Button__icon.ws-note-tag-color_color-5{border-radius:4px;height:16px;width:16px;border:1px solid #eaeaea}.controls-MenuItem__content .ws-note-tag-color,.ws-note-tag-color:hover,.ws-note-tag-color_selected,.ws-note-tag-color_selected:hover{border:1px solid #eaeaea}.ws-note-tags__ellipsis~span{opacity:0}.ws-note-tags__ellipsis.ws-hidden~span{opacity:1}.ws-note-shadow__left,.ws-note-shadow__right{width:49%;height:6px;border:0}.ws-note-shadow{position:absolute;height:6px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAHCAYAAAD5wDa1AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAEdJREFUeNpi5ObmNmFgYPgPxRDwH4T+I/gMyDIg8j9ECWmAkRFoGSO6Yf//4zYHJMOIyymEbPtPji4yARMDHcGoZVQBAAEGABJ1Fm/2x67bAAAAAElFTkSuQmCC) bottom center repeat-x}.ws-note-shadow__left{float:left;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAAHCAYAAADAi0WrAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAbxJREFUeNqsVgGSwyAIlBl7r+n/H9de3SNRT0QxapMp0Sii3WVJPAD3fD4fzrkftoewH9F6+cxrjra+OA6qR6hpSNfj3hk31uD4jf1zvz8m94v9mTOMYoo+1BhEV/TPfyEXQLjrNVDxoLbMN7Fx+VeaGcFPM+/d1kVOx4L50O5K5PpHrSYw2m7lQlofAaMTCRCd0AYeCyl6uDTbH51WWuAz4P8MY3MphlNgIEKERifOFYE4IwPIwNDvYrqSH3pvWK6VE+lMRwf4j2G/xnghEV3yUMBvSJGJNAR8CTNTDfddNJjz9+j/UqU1tUBI5ejDqDLgiAQRG07y2HC070SmtEJmrcCaLAN5amrnVopzHFpLAot/DPZCp9Ji57R2jvkv9Y9C6llbs7q0Gt9VS9wijyH75HWRUK51zUfBtgLQZsbFa+XyrYMbRLMupL7DzFnOStM6zyRAVtgnPR9KfRWlRmIZ4lci+I1IsFRsEC3TSt2cpI3COpWw2ATtPv5N/5jnC29X6nzqXbxGMAjulV9IpCG1JEzn4Ksqy7F898rxdN3DvE7W1FfhQ9+zf2OYUQzMJnP8zDODZbh7Hn8CDADiQa+zYOkpnQAAAABJRU5ErkJggg==) bottom left no-repeat}.ws-note-shadow__right{float:right;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAH8AAAAHCAYAAAAhzJK/AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAfVJREFUeNq0VwF2wyAI9Sfp3utpdv9j7Dpr1z81qGgwsVmWVwIaRISPWtzv90/XfxB+AIMI+3sSIK/SF4euzdwPVG2odmogT5baSauRoVzSjSSKT5Usdiu9WoZTE2ztGGNsO+Pf92TtjwpURzc+D9/3HbinwJ/CH4pHWvzry+0+jD+HfS1JfN3DDSASn5xOrkFclyhA4CQrzn3RBhkiM0V9ckKU17bMkclrTgjyqt9S1henW3/cQATsqvjjgzb4uMqyc8uIEnMF7C6U51BzPpRUiCsxyXOCoK4bSCzToMlpIAmnE5AUmr1NT5hXOdKi5JY02CwQdWvM0iDaquIuHnF18nEIjo7OdSAtc1ElGlYgFAqYSyerHsMRvQTAUEIDoAwYP9/sexeJcaJb086gEbDMDRhTsmGDZLuad8ptrPJDuXQzLDVufLbG1Ok6sTOohNf2DVtWuk7MaexsPI4ZrFlasKSdYkHZUW4KJJ5Dg2b2dmeoHWZzNOHqyh+Il6VDMwQcPEZhj+n5koGw7+zRkflvZ3XxPgHnRy5ePRcEIPHImcpxQ08QgET+Ue0odC8/8iX2E/F08vuJrP4UDIWyssHji8TmXNE7IJRPOF5BTAmxCwBrndVRMxyv00Ci4i+/uz2r+151GY0XYX0PWQ7sRpsJFL8CDAAmcXrzr//3aAAAAABJRU5ErkJggg==) bottom right no-repeat}.ws-note-used-tag .controls-MenuItem .controls-MenuItem__icon,.ws-note__tag-color-menu .controls-MenuItem .controls-MenuItem__icon{box-sizing:border-box;top:3px!important;left:-9px!important;width:24px;height:24px}.ws-note-used-tag .controls-MenuItem .controls-MenuItem__icon-wrapper,.ws-note__tag-color-menu .controls-MenuItem .controls-MenuItem__icon-wrapper{padding-left:2px}.ws-note-used-tag .controls-MenuItem .control-MenuItem__child-expand,.ws-note__tag-color-menu .controls-MenuItem .control-MenuItem__child-expand{padding-right:0}.ws-note__tag-color-menu{width:32px;margin-left:-2px!important}.ws-note__tag-color-menu.controls-MenuIcon__Menu.controls-Menu__hide-menu-header .controls-MenuItem{height:30px;line-height:30px}.ws-note__tag-color-menu.controls-Menu__hide-menu-header{padding:0}.ws-note__body .ws-note-files{border-top:1px dashed rgba(0,0,0,.1)}.ws-note__pin-menu{max-width:280px}"));head.appendChild(style);});}
define('js!SBIS3.Notes.NotesView',['Core/core-functions','Core/core-merge','Core/Indicator','Core/IoC','Core/EventBus','Core/constants','Core/Context','SBIS3.CONTROLS/CompoundControl','js!SBIS3.Notes.Note','Lib/ServerEvent/Bus','js!SBIS3.Notes.Utils.Info','css!SBIS3.Notes.NotesView','css!SBIS3.CORE.RichContentStyles','Zametki_localization'],function(e,t,o,i,n,s,a,r,l,c,d){'use strict';function h(){throw new Error('Method not implemented');}var f=r.extend({$protected:{_options:{activableByClick:false,errorOnLoading:false,errorOnLoadingMessage:null},_lastWidth:0,_lastHeight:0,_controls:null,_activeNoteId:null,_activeNote:null,_needRedrawNotes:true,_isActiveNoteNew:false,_isActiveNoteLocked:false,_isPluginAvailable:false,_isNotificationServiceAvailable:false,_doNotOpenDialog:false,_doNotSaveDialog:false,_openDialogTime:null,_isTagFormOpened:false,_isPinMenuOpened:false,_shouldNotifyAboutDemoMode:true,_eventNamespace:'.notesView'},init:function(){f.superclass.init.call(this);var e=this,t=this.getChildControlByName('notes');this._checkPluginAvailability(),this._controls={notes:t},t.getContainer().on('transitionend'+this._eventNamespace,'.ws-note_animated',function(){$(this).hide();}),this.subscribeTo(t,'onItemDoubleClick',function(t,o,i){if(o.pinnedToPanel&&!o.isAuthor&&!o.canEdit);else e.openNoteDialog({note:o,origRecord:i,noteRecord:i.clone()});}),this.subscribeTo(t,'onChangeHoveredItem',this._onChangeHoveredItem.bind(this));var o=n.channel('NoteCommands');this.subscribeTo(o,'Open',function(t,o,i){if(o||i&&i.get('baseId')){var n=o?e.getNote(o):e.getNoteByBaseId(i.get('baseId'));if(n)e.openNoteDialog({note:n,origRecord:i,noteRecord:i.clone()});}}),this.subscribeTo(o,'Edit',function(t,o){if(o.pinnedToPanel&&!o.isAuthor&&!o.canEdit);else e.openNoteDialog({note:o});}),this.subscribeTo(o,'Remove',function(t,o){e.removeNote(o);}),this.subscribeTo(o,'ViewFile',function(e,t){require(['js!SBIS3.EDO.CD.DiskOperations'],function(e){e.openDocument(t);});}),this.subscribeTo(o,'Pin',this._onPin.bind(this)),this.subscribeTo(c.serverChannel('notes.note'),'onMessage',this._onServerMessage.bind(this)),this.subscribeTo(c.serverChannel('tags.tag'),'onMessage',this._onServerMessage.bind(this));var i=n.channel('NotesEvents');this.subscribeTo(i,'onPanelOpened',function(){e._initSharedNotesChannel();}),this.subscribeTo(i,'onPanelResize',function(){e._controls.notes._onWindowResize();}),this.subscribeTo(i,'onPanelClosed',function(){c.serverChannel('notes.sharednotes').unbind('onMessage');}),this.subscribeTo(i,'onTagFormOpened',function(){e._isTagFormOpened=true;}),this.subscribeTo(i,'onTagFormClosed',function(){e._isTagFormOpened=false;}),this.subscribeTo(i,'onPinMenuOpened',function(){e._isPinMenuOpened=true;}),this.subscribeTo(i,'onPinMenuClosed',function(){e._isPinMenuOpened=false;}),this.subscribeOnceTo(i,'onNotificationServiceAvailable',function(){e._isNotificationServiceAvailable=true;}),this.subscribeOnceTo(i,'onBeforeTagUpdate',function(){e._lastUpdateTime=new Date().getTime();}),this.subscribeOnceTo(i,'onBeforeTagRemove',function(){e._lastUpdateTime=new Date().getTime();}),this.subscribeTo(i,'onEditorResize',function(t,o){if(e._editorDialog)e._editorDialog.setSize(o);});},canBeUpdatedOnServerMessage:function e(){return!this._lastUpdateTime||this._lastUpdateTime+5000<new Date().getTime();},destroy:function(){f.superclass.destroy.call(this),s.$win.off(this._eventNamespace),this._controls.notes.getContainer().off(this._eventNamespace),this._controls=null;},getNote:function(e){return this._controls.notes.findNoteById(e)||null;},getNoteByBaseId:function(e){return this._controls.notes.findNoteByBaseId(e)||null;},getNoteIndex:function(e){return this._controls.notes.findNoteIndexById(e)||0;},_initSharedNotesChannel:function(){var e=this,t=c.serverChannel('notes.sharednotes',{isChanneled:true});t.once('onReady',function(){t.subscribe('onMessage',e._onServerMessageShared.bind(e));});},_checkPluginAvailability:function(){var e=this;if(!s.browser.isMobilePlatform&&!s.browser.isMacOSDesktop)require(['js!SBIS3.Plugin.Source.LocalService'],function(t){new t({endpoint:{address:'FileSystem-1.0.1.0',contract:'FileSystem'},options:{mode:'silent'}}).isReady().addBoth(function(t){if(e._isPluginAvailable=!(t instanceof Error),e._controls.notes._options.items&&e._controls.notes._options.items.length)n.channel('NotesEvents').notify('onPluginAvailabilityChanged',e._isPluginAvailable);else setTimeout(function(){n.channel('NotesEvents').notify('onPluginAvailabilityChanged',e._isPluginAvailable);},1000);});});},_getWindowWidth:function e(){return s.$win.width();},_getWindowHeight:function e(){return Math.min(s.$doc.height(),s.$win.height());},_onServerMessageShared:function(e,t){if(t){var o=t.at(0);if(o){var i=o.get('EventType'),n='';if(o.has('Payload'))n=o.get('Payload');if(this._doNotOpenDialog&&'Unlock'===i){if(new Date()-this._openDialogTime>1000*60)this._doNotSaveDialog=true,d.showMessageDialog({message:n,status:'default'});}else if('Edit'===i)this._onServerMessage(e,t);}}},_onServerMessage:function(e,t){if(t){var o=t.at(0);if(o){var i=o.get('EventType'),n=o.get('NoteId'),s=this._controls.notes.findNoteByBaseId(n);if(!this._doNotOpenDialog&&!this._isTagFormOpened&&!this._isPinMenuOpened)if('Create'===i){if(!s)this._loadAndCheckVisibleNotes(false);}else if(s&&s.canBeUpdatedOnServerMessage()||('UpdateTag'===i||'DeleteTag'===i)&&this.canBeUpdatedOnServerMessage())this._loadAndCheckVisibleNotes('UpdateTag'===i||'DeleteTag'===i);}}},loadData:h,createNote:function(){return new l({creationDate:new Date()});},_loadAndCheckVisibleNotes:function(e){var t=this;this.loadData().addCallback(function(){if(!e){var o=false;t._controls.notes.getItems().each(function(e){if(!e.get('isHidden')&&!e.get('pinnedToPanel'))o=true;}),n.channel('NoteCommands').notify('setHiderFletching',o);}});},openNoteDialogCall:function(e){var o=this,i=this._isActiveNoteNew=!e.note,s=i?null:this._controls.notes.getNoteElement(e.note.id);if(s)s.addClass('ws-note_blocked');if(n.channel('NoteCommands').notify('CloseExtendedHider'),i){if(e.note=this.createNote(),e.tag)e.note.tags=[e.tag];if(e.text)e.note.text=e.text;if(!$('#accordionBg').length&&!$('[data-component="SBIS3.Navigation.Navigation"]').length||e.panelId||e.panelData&&e.panelData.panelId)e.note.pinnedToPanel=true,e.note.isAuthor=true,e.note.panelId=e.panelId||null,e.note.panelData=e.panelData||{};}else if(this.hasChildControlByName('NoteFiles_'+e.note.id)){var r=this.getChildControlByName('NoteFiles_'+e.note.id);if(r.hasChildControlByName('previews')){var l=r.getChildControlByName('previews').getTreeView().getItems();if(l.getCount())e.noteRecord.set('files',l),e.note.files=l;}}e.note.snapshot(),this._origRecord=e.origRecord,this._activeNoteId=e.note.id,this._activeNote=e.note;var c=a.createContext(this,null,this.getLinkedContext());c.setValue('record',e.note);var d=t({name:'NoteDialog',className:'ws-note-dialog',template:'js!SBIS3.Notes.NoteEditor',width:f.NOTE_EDITOR_WIDTH,height:200,opener:e.opener||this,parent:this,componentOptions:{name:'NoteEditor',context:c,note:e.note,noteRecord:e.noteRecord,isLocked:this._isActiveNoteLocked,isNewNote:i,noteElement:s,minWidth:f.NOTE_EDITOR_WIDTH,isPluginAvailable:this._isPluginAvailable},handlers:{onBeforeClose:this._onBeforeEditorClose.bind(this),onAfterClose:this._onAfterEditorClose.bind(this)}},this.getEditorConfig());require(['Lib/Control/Dialog/Dialog'],function(e){o._editorDialog=new e(d);});},openNoteDialog:function(e){var t=this;if(e=e||{},this._options.errorOnLoading)return void d.showMessageDialog({message:this._options.errorOnLoadingMessage,status:'error'});if(this._doNotOpenDialog)return;if(this._needRedrawNotes=true,this._doNotOpenDialog=true,this._doNotSaveDialog=false,this._openDialogTime=new Date(),e.note&&e.note.pinnedToPanel)e.note.lockNote().addCallbacks(function(o){if(o=o.getRawData(),o)o=String(o).split('\n'),d.showMessageDialog({message:o[0],details:o[1]}),t._doNotOpenDialog=false,t._openDialogTime=null;else t._isActiveNoteLocked=true,t.openNoteDialogCall(e);},function(o){i.resolve('ILogger').error(rk('Не удалось заблокировать заметку'),o),t.openNoteDialogCall(e);});else this.openNoteDialogCall(e);},_onBeforeEditorClose:function(e,t){var i='remove'===t,n='save'===t,s='force'===t||this._doNotSaveDialog,a=this._editorDialog,r=this._activeNote,l=this;if(r)r.oldContentImages=r.contentImages,r.contentImages=a.getChildControlByName('NoteEditor')._controls.content.getImages();function c(){l._justClose=true,a.close();}function h(e){if(new Blob([e]).size>10240)return d.showMessageDialog({message:rk('Заметка имеет слишком большой размер'),status:'error'}),true;return false;}if(this._justClose)return void o.hide();if(!i){if(l._activeNote)if(a.hasChildControlByName('Files')){var f=a.getChildControlByName('Files');if(f.hasChildControlByName('previews')){var u=f.getChildControlByName('previews').getTreeView().getItems();if(u&&u.getCount()&&l._origRecord)l._origRecord.set('files',u);r.files=u;}}var g=this.getChildControlByName('NoteEditor'),_=g.getContent();if(r._snapshot.text!==_||l._isActiveNoteNew)if(r.text=g.prepareTextForSaving(_),l._isNotificationServiceAvailable)r.updateNotificationOnNextSave();var N=!r.hasContent();if(i=N&&(n||!r.wasSaved()||''===r._snapshot.text),!i&&!s)if(r.hasChanged(false,true)||l._isActiveNoteNew)if(e.setResult(false),(n||!r.hasChanged(true,true))&&!(!n&&l._isActiveNoteNew&&!N)){if(h(r.text))return;o.setMessage(rk('Сохранение заметки')),r.save().addCallbacks(c,function(e){o.hide();});}else require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(e){var t={message:rk('Сохранить изменения?'),details:rk('Чтобы продолжить редактирование, нажмите "Отмена".'),hasCancelButton:true};e.showConfirmDialog(t,function e(){if(!N){if(h(r.text))return;o.setMessage(rk('Сохранение заметки')),r.save().addCallbacks(c,function(e){o.hide();});}else l.removeNote(r,l._isActiveNoteNew),l._activeNote=null,c();},function e(){if(r.rollback(),''===r.text&&!(r.files&&r.files.getCount())||l._isActiveNoteNew)l.removeNote(r,l._isActiveNoteNew),l._activeNote=null;else l._needRedrawNotes=false;c();},function e(){});});else if(!l._isActiveNoteNew)this._needRedrawNotes=false,r.text=r._snapshot.text;}if(i)this.removeNote(r,l._isActiveNoteNew),this._origRecord=this._activeNote=null;},_onAfterEditorClose:function(){var t=this,o=n.channel('NotesEvents');if(!this._activeNote&&this._isActiveNoteLocked)this._isActiveNoteLocked=false;if(this._isActiveNoteLocked){var s=this._activeNote;s.unlockNote().addCallbacks(function(e){s.text=s._snapshot.text,t._controls.notes.reload();},function(e){i.resolve('ILogger').error(rk('Не удалось разблокировать заметку'),e);});}if(this._activeNote)if(this._isActiveNoteNew){if(l.isDemo())e.alert(rk('В демо-режиме заметки не сохраняются'),rk('После обновления страницы они пропадут'));o.notify('onNoteAdded',this._activeNote);}else{var a=this._controls.notes.getNoteElement(this._activeNote.id);if(!this._needRedrawNotes&&a){if(!a.hasClass('ws-note_hidden'))a.css({opacity:1,display:'block'}),a.removeClass('ws-note_animated'),setTimeout(function(){a.css('transition','none');},500);}else o.notify('onNoteChanged',this._activeNote);}else o.notify('onNoteRemoved',this._activeNoteId);this._origRecord=this._activeNote=this._editorDialog=null,this._doNotOpenDialog=t._doNotSaveDialog=this._justClose=false,this._openDialogTime=null,this._isActiveNoteNew=false,this._isActiveNoteLocked=false,$('body').removeClass('ws-note-openedDialog');},_onChangeHoveredItem:function(e,t){if(t.key)this._activeNoteId=t.key;},removeNote:h,_onPin:h});return f.NOTE_EDITOR_WIDTH=494,f.NOTE_EDITOR_HEIGHT=350,f;});
define("html!SBIS3.Notes.StaticNotesView",function(){var e=function(e){var t=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(t){for(;e.test(t);)t=t.replace(e,"&#123;&#123;$1&#125;&#125;");return t}}(),n="undefined"!=typeof process,o=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,'<div class="ws-notes-holder ws-notes-holder_static"> <component data-component="SBIS3.Notes.StaticNoteListView" name="notes" class="ws-notes-container"></component> <div class="ws-notes-pagination-bottom ws-hidden"></div> </div>');return(o=t(o))+(n&&-1!==o.indexOf("{{")?String.fromCharCode(8203,8203):"")};return e.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.StaticNotesView"}},e});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.StaticNotesView", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-notes-holder.ws-notes-holder_static,.ws-notes-holder.ws-notes-holder_static .ws-notes-container{position:relative}.ws-notes-pagination-bottom{margin-bottom:12px;margin-right:12px}.scrollContainerNotes .controls-ListView__scrollPager.controls-Paging{display:none!important}"));head.appendChild(style);});}
define('js!SBIS3.Notes.StaticNotesView',['Core/helpers/getSessionStorageValue','Core/helpers/setSessionStorageValue','js!SBIS3.Notes.Utils.Info','Core/EventBus','Core/constants','Core/helpers/Function/debounce','js!SBIS3.Notes.NotesView','html!SBIS3.Notes.StaticNotesView','js!SBIS3.BL.Note','js!SBIS3.Notes.Note','SBIS3.CONTROLS/Pager','SBIS3.CONTROLS/ScrollContainer','js!SBIS3.Notes.StaticNoteListView','css!SBIS3.Notes.StaticNotesView','Zametki_localization'],function(e,t,s,i,o,a,n,r,l,g,h){'use strict';function c(e){if(e instanceof Array)return[].concat(e);if(null!=e)return[f(e)];return[];}function u(e){if(e){var t=new Date(e);if(!isNaN(+t))return t;}return null;}function f(e){return e&&e.replace(/^\s+|\s+$/gm,'');}var _=n.extend({_dotTplFn:r,$protected:{_options:{filters:{page:0,pageSize:20,orderDESC:true,startDate:null,endDate:null,tags:[],searchQuery:''}},_dom:null,_filters:{},_totalNotesCount:0,_needToNotifyPageUpdate:false,_tagsWasChanged:false},_modifyOptions:function(t){if('undefined'!==typeof window)t.filters.pageSize=e('ws-page-size')||20;return t;},init:function(){_.superclass.init.call(this),this._dom={paging:null},this.setFilters(this._options.filters),this._initPaging(),this.subscribeTo(this,'onResize',a(this._onResize.bind(this),250)),this.subscribeTo(i.channel('NoteCommands'),'MoveNote',this._moveNote.bind(this));var e=i.channel('NotesEvents'),t=this,s=function e(){t._tagsWasChanged=true;};this.subscribeTo(e,'onTagAdded',s),this.subscribeTo(e,'onTagUpdated',s),this.subscribeTo(e,'onTagRemoved',s),this.subscribeTo(e,'onTagFormClosed',function(e,s){if(t._tagsWasChanged)if(t._tagsWasChanged=false,!t._doNotOpenDialog)i.channel('NotesEvents').notify('onNoteChanged',s);}),this.subscribeTo(e,'onFileRemoved',function(e,s){if(!$('body').hasClass('ws-note-openedDialog')&&s&&!s.hasContent()&&!s.files.getCount()&&!s.tags.length)t.removeNote(s),t._activeNote=null;t._controls.notes.toColView(true);});},destroy:function(){_.superclass.destroy.call(this),o.$win.off(this._eventNamespace),this._controls.notes.setItemsDragNDrop(false),this._controls=this._dom=null;},_moveNote:function(e,t,i){if(t==i)return;var o=this.getNoteIndex(t),a=this.getNoteIndex(i);if(o>=0&&a>=0){var n=this,r=this.getNote(t),g=this.getNote(i),h=o>a;l.moveNote(g.baseId,r.baseId,h).addCallbacks(function(e){n.loadData();},function e(t){s.showMessageDialog({message:t.message,status:'error'});}),n._currentNoteId=t;}},_onAfterEditorClose:function(){var e=i.channel('NotesEvents');if(this._activeNote)if(g.isDemo())s.showMessageDialog({message:rk('В демо-режиме нельзя добавлять заметки в реестр'),status:'error'});else if(this._isActiveNoteNew)e.notify('onNoteAdded',this._activeNote);else{var t=this._controls.notes.getNoteElement(this._activeNote.id);if(!this._needRedrawNotes&&t)t.css({opacity:1,display:'block'}),t.removeClass('ws-note_animated');else e.notify('onNoteChanged',this._activeNote);}this._activeNote=this._editorDialog=null,this._doNotOpenDialog=this._justClose=false,this._isActiveNoteNew=false,$('body').removeClass('ws-note-openedDialog');},_onResize:function(){if(this._controls.notes){var e=this.getContainer().width(),t=this.getContainer().height(),s=o.$win.height();if(e!==this._lastWidth||t!==this._lastHeight||s!==this._lastScreenHeight)this._lastWidth=e,this._lastHeight=t,this._lastScreenHeight=s,this._controls.notes.toColView(true);}},setPageSize:function(e){if(this._activeNoteId=null,this.getFilter('pageSize')!==e)if(this.setFilter('pageSize',e),this.getFilter('page')>0)this.setFilter('page',1),this._controls.pagination.getPaging().setPage(1);else this.loadData(true);},_initPaging:function(){var e=this,t=this._controls.pagination=new h({pageSize:this.getFilter('pageSize')||20,opener:this,showPaging:true,ignoreLocalPageSize:false,name:'Pagination',element:this.getContainer().find('.ws-notes-pagination-bottom'),pagingOptions:{recordsCount:this._totalNotesCount,currentPage:1,recordsPerPage:this.getFilter('pageSize')||20,pagesLeftRight:3,onlyLeftSide:false,rightArrow:true}});t.getChildControlByName('controls-Pager_comboBox')._options.flipVertical=true,this._dom.paging=t.getContainer(),this.subscribeTo(t,'onPageChange',function(t,s){if(e.getFilter('page')!==s-1)e.setFilter('page',s-1),e.loadData(true);});},updatePagination:function(){var e,t,s,i;if(0===this._totalNotesCount)this._dom.paging.addClass('ws-hidden');else{if(e=this._controls.pagination,t=this._controls.pagination.getPaging(),s=this.getFilter('pageSize'),this._forceClearPageNumber)i=1,this._forceClearPageNumber=false;else i=t.getPage();if(e.getChildControlByName('controls-Pager_comboBox').setPageSize(s),this.setFilter('page',i-1),i>Math.ceil(this._totalNotesCount/s))i--;if(0===this._totalNotesCount&&i>1)t.setPage(1);if(t.setPage(i),t._options.recordsCount=this._totalNotesCount,t.update(i,this._totalNotesCount,true),1===i)e.updateAmount(Math.min(this._totalNotesCount,s),true,0);else if(i===Math.ceil(this._totalNotesCount/s))e.updateAmount(this._totalNotesCount-(i-1)*s,true,0);else e.updateAmount(s,true,0);this._dom.paging.removeClass('ws-hidden');}},forceClearPageNumber:function(){this._forceClearPageNumber=true;},loadData:function(e){var t=this._controls.notes,i=this;if(this._forceClearPageNumber)this._filters.page=0;var o={mixedMode:true,Tags:this._filters.tags||[],PagesId:this._filters.urls||[],SearchQuery:this._filters.searchQuery||'',Color:null==this._filters.color?null:+this._filters.color,StartDate:this._filters.startDate||null,EndDate:this._filters.endDate||null};return t.setFilter(o,true),t.setPage(this._filters.page,true),t.setPageSize(this._filters.pageSize,true),i.show(),t.reload().addCallback(function(t){if(i._totalNotesCount=t.getMetaData().total,i._options.errorOnLoading=false,e){var s=i._controls.pagination,o=s.getPaging().getPage(),a=i.getFilter('pageSize'),n=a;if(1===o){if(i._totalNotesCount<a)n=i._totalNotesCount;}else if(o*a>i._totalNotesCount)n=i._totalNotesCount-(o-1)*a;s.updateAmount(n,true,0);}else i.updatePagination();}).addErrback(function(e){if(e.canceled)return;s.showMessageDialog({message:rk('Не удалось загрузить заметки'),status:'error'}),i._options.errorOnLoading=true,i._options.errorOnLoadingMessage=e.message;});},getEditorConfig:function(){return{};},removeNote:function(e){this._controls.notes._disableRedraw=true,this._controls.notes.removeNoteById(e.id);var t=this;this._controls.notes._disableRedraw=false,e.remove().addCallback(function(){var s=t.getFilter('page');if(s>Math.ceil(--t._totalNotesCount/t.getFilter('pageSize'))&&s>0)t.setFilter('page',s-1);i.channel('NotesEvents').notify('onNoteRemoved',e.id);});},setFilters:function e(t){t=t||this._options.filters||{};for(var s in t)if(t.hasOwnProperty(s))this.setFilter(s,t[s]);return this;},setFilter:function s(i,o){var a;switch(i){case'page':case'Page':if(o){if(!isNaN(a=parseInt(o,10)))this._filters.page=a;}else this._filters.page=0;break;case'max':case'maxCount':case'countPerPage':case'pageSize':if(o){if(!isNaN(a=parseInt(o,10)))if(a>=0)this._filters.pageSize=a,t('ws-page-size',this._filters.pageSize);}else this._filters.pageSize=this._options.max||this._options.maxCount||this._options.countPerPage||this._options.pageSize||e('ws-page-size')||20,t('ws-page-size',this._filters.pageSize);break;case'sort':case'order':case'orderDESC':if('asc'===o||'ASC'===o)this._filters.orderDESC=false;else if('desc'===o||'DESC'===o)this._filters.orderDESC=true;else this._filters.orderDESC=!!o;break;case'startDate':case'StartDate':this._filters.startDate=u(o);break;case'endDate':case'EndDate':this._filters.endDate=u(o);break;case'tag':case'tags':case'Tag':this._filters.tags=c(o);break;case'Url':this._filters.urls=c(o);break;case'searchString':case'searchText':case'searchQuery':case'SearchQuery':this._filters.searchQuery=o;break;case'color':case'Color':this._filters.color=null==o?null:+o;}return this;},getFilter:function t(s){var i=this._filters[s];if('pageSize'===s&&!i)i=e('ws-page-size');return i;},resetPaging:function(){var e=this._controls.pagination.getPaging();if(e.getPage()>1)e.setPage(1),this.setFilter('page',0);},_onPin:function(e,t,s){if(s===t.getPin())return;if(s===g.NOTE_PIN_ALL_PAGES)t.pinToAllPages();else if(s===g.NOTE_PIN_PAGE)t.pinToMainPage();else if(s===g.NOTE_PIN_UNPINNED)t.unpin();}});return _;});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.Page", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-note-page{min-height:600px;margin-top:5px}.ws-note-left-list{width:250px;padding:0!important}.ws-note-add{position:absolute;top:22px;left:750px}.ws-note-left-list .ws-note-used-tag{display:block;padding:12px 10px 12px 18px;color:#000;border-right:#eee 1px solid;font-size:15px;cursor:pointer}.ws-note-left-list .controls-ListView__item__selected{color:#000;padding-top:11px;padding-bottom:10px;border-top:1px solid #eee;border-bottom:1px solid #eee;border-right-color:#fff}.ws-note-left-list .controls-ListView__item__selected .ws-note-tag__count{top:11px}.ws-note-left-list .ws-note__tag{font-size:15px;max-width:195px;overflow:hidden;text-overflow:ellipsis;cursor:pointer}.ws-note-left-list .controls-ListView__EmptyData,.ws-notes-holder_small{border-top:1px solid #eee}.ws-note-sort-down,.ws-note-sort-up{float:right}.ws-clear{clear:both}.ws-search-options{width:80%;margin:0 auto}.ws-notes-pagination-bottom,.ws-notes-pagination-top{text-align:center}.ws-notes-pagination-bottom{z-index:10;position:relative}.ws-note-page__filters{height:40px}.ws-note-tag__count{position:absolute;right:4px;top:12px;color:#05b;cursor:pointer}.ws-note-used-tag>span{cursor:pointer}.ws-note-page__breadcrumbs{font-size:12px;color:#999}.ws-note-search{vertical-align:middle}body.dragdropBody,body.dragdropBody *{cursor:no-drop!important}body.dragdropBody .ws-note-used-tag.controls-ListView__hoveredItem,body.dragdropBody .ws-note-used-tag.controls-ListView__hoveredItem>span,body.dragdropBody .ws-note-used-tag.controls-ListView__item__selected,body.dragdropBody .ws-note-used-tag.controls-ListView__item__selected>span,body.dragdropBody .ws-note_static.controls-ListView__hoveredItem,body.dragdropBody .ws-note_static.controls-ListView__hoveredItem *,body.dragdropBody .ws-note_static.controls-ListView__item__selected{cursor:pointer!important}body.dragdropBody .ws-note-left-pages .ws-note-used-tag.controls-ListView__hoveredItem,body.dragdropBody .ws-note-left-pages .ws-note-used-tag.controls-ListView__hoveredItem>span,body.dragdropBody .ws-note-left-pages .ws-note-used-tag.controls-ListView__item__selected,body.dragdropBody .ws-note-left-pages .ws-note-used-tag.controls-ListView__item__selected>span{cursor:no-drop!important}body.dragdropBody .controls-DragNDrop__insertAfter,body.dragdropBody .controls-DragNDrop__insertBefore{border-top:none!important;border-bottom:none!important}.ws-note-page_empty-left-side .ws-notes-holder_small{margin-left:0;border-top:0}.ws-note-page_empty-left-side .ws-note-left-list{width:0}.ws-note-used-tag.controls-ListView__item .ws-note-tag__actions{position:absolute;top:10px;right:24px;display:none;padding-left:22px;background:-moz-linear-gradient(left,rgba(240,245,251,0) 0,rgba(240,245,251,1) 15%,rgba(240,245,251,1) 100%);background:-webkit-linear-gradient(left,rgba(240,245,251,0) 0,rgba(240,245,251,1) 15%,rgba(240,245,251,1) 100%);background:linear-gradient(to right,rgba(240,245,251,0) 0,rgba(240,245,251,1) 15%,rgba(240,245,251,1) 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#00f0f5fb', endColorstr='#a6f0f5fb', GradientType=1)}.ws-note-used-tag.controls-ListView__item__selected .ws-note-tag__actions{top:9px}.ws-note-used-tag .ws-note-tag__actions.opened,.ws-note-used-tag.controls-ListView__hoveredItem .ws-note-tag__actions{display:block}.ws-note-page__add-button{margin-left:8px}.ws-note-page__add-tag{margin-left:12px}.ws-note-left-list.controls-ListView .controls-ItemsToolbar__editActions{margin-bottom:8px;height:24px;background:#f3f3f3;width:33px;margin-right:1px}.ws-note-left-list.controls-ListView .controls-ItemsToolbar .controls-ItemsToolbar__container{border:0;background:#f3f3f3}.ws-note-left-list .controls-editInPlace__editor .ws-note-tagList__edit{margin:2px 8px 0 16px;width:168px;background:#fff;padding:0}.ws-note-left-list .controls-editInPlace__editor .ws-note-tag-color__menu-icon{margin-top:-3px}.ws-note-left-list .controls-ListView .controls-ItemsToolbar{background:#f3f3f3}.ws-note__recent-tags.controls-ListView .controls-ItemsToolbar{box-shadow:none}.ws-note-used-tag .ws-note-tag__actions .controls-Menu__hide-menu-header{margin-right:2px}.ws-note-page .controls-TabButtons__leftContainer,.ws-note-page .ws-note-left-list .controls-ItemsToolbar__editActions .controls-Button__closeButton{display:none!important}.ws-note-page .controls-TabButtons__tabSpace-template-inner{font-size:0}.ws-note-page .controls-ListView .controls-ItemsToolbar{background-color:inherit!important;box-shadow:none!important}.controls-ListView__customHoveredItem{background:#f0f5fb}.ws-note-page .controls-TabButtons .controls-TabButtons__tabSpace-template .controls-TabButtons__tabSpace-template-inner{position:absolute;top:3px}.ws-note-page__filters .ws-note__search-form-table{vertical-align:top;padding-top:8px}.ws-note-page .controls-ListView .controls-ItemsToolbar__editActions>i{margin:2px 4px}.ws-note-left-list .controls-editInPlace__editor{width:250px;height:41px;margin-top:5px;box-sizing:border-box}.ws-note-page__filters .ws-filter-button-direction-left.ws-filter-button{margin-top:-8px}.ws-note-tag__count{right:12px}.ws-note-page .controls-TabButtons__tabSpace-template{position:relative}.scrollContainerList,.scrollContainerNotes{height:100%}.scrollContainerList{float:left;width:250px}.scrollContainerNotes{margin-left:250px}.compact-menu .ws-note-page .controls-TabButtons__tabSpace-template-inner:before{content:'Заметки';font:700 20px/32px TensorFont,sans-serif;color:#d94700;padding:0 4px 0 8px;line-height:23px;float:left}.compact-menu .ws-note-page__add-tag{vertical-align:top}.ws-note-page .ws-note-page__add-button .controls-Button__text{margin-left:0!important}"));head.appendChild(style);});}
define('js!SBIS3.Notes.Page',['js!SBIS3.Notes.Utils.Info','Core/EventBus','Core/constants','SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.Page','WS.Data/Source/SbisService','js!SBIS3.Notes.Page.PageInfo','Lib/ServerEvent/Bus','js!SBIS3.Notes.AddTag','SBIS3.CONTROLS/Button/IconButton','SBIS3.CONTROLS/ListView','js!SBIS3.Notes.TagListView','js!SBIS3.Notes.TagEditor','html!SBIS3.Notes.Page/templates/Page','html!SBIS3.Notes.Page/templates/PageContent','js!SBIS3.Notes.StaticNotesView','SBIS3.CONTROLS/Tab/Buttons','SBIS3.CONTROLS/SearchForm','Deprecated/Controls/FilterButton/FilterButton','SBIS3.CONTROLS/Button','SBIS3.CONTROLS/ScrollContainer','css!SBIS3.Notes.Page','i18n!SBIS3.Notes.Page','Zametki_localization'],function(t,e,s,i,o,r,n,a){'use strict';var l=i.extend({_dotTplFn:o,$protected:{_filter:{},_options:{errorOnLoading:false,errorOnLoadingMessage:null},_controls:null,_eventNamespace:'.notespage'},init:function(){l.superclass.init.call(this);var t=this,i=this.getChildControlByName('notes'),o=this.getChildControlByName('search'),h=this.getChildControlByName('tags'),d=this.getChildControlByName('pages'),c=this.getChildControlByName('tabs'),g=this.getChildControlByName('addTagDialog');this._controls={notes:i,leftList:null,search:o,addTagDialog:g},i._controls.notes.setItemsDragNDrop(true),this._doNotRefreshNotes=false,d.setDataSource(new r({endpoint:{address:'/notes/service/',contract:'Note'},binding:{query:'GetUserUrls'},idProperty:'ID',model:n}),true);var f=this._onLeftListDataLoad.bind(this),_=this._onLeftListDataLoadError.bind(this),u=this._onLeftListItemClick.bind(this),C=this._onLeftListDrawItems.bind(this),S=this._onLeftListSelectedItemChange.bind(this);this.subscribeTo(h,'onDataLoad',f),this.subscribeTo(h,'onDataLoadError',_),this.subscribeTo(h,'onItemClick',u),this.subscribeOnceTo(h,'onDrawItems',C),this.subscribeTo(h,'onSelectedItemChange',S),this.subscribeTo(d,'onDataLoad',f),this.subscribeTo(d,'onDataLoadError',_),this.subscribeTo(d,'onItemClick',u),this.subscribeOnceTo(d,'onDrawItems',C),this.subscribeTo(d,'onSelectedItemChange',S),this.subscribeTo(i,'onResize',this._setMaxHeight),this.subscribeTo(this.getChildControlByName('addNote'),'onActivated',function(){i.openNoteDialog({tag:t.getActiveTag()});}),this.subscribeTo(this.getChildControlByName('addTag'),'onActivated',function(){t.openTagDialog();}),this.subscribeTo(g,'onCloseDialog',this._onAfterEditorClose.bind(this));var b=this._onSearch.bind(this);this.subscribeTo(o,'onReset',b),this.subscribeTo(o,'onSearch',b),this.subscribeTo(o,'onSearchStart',b),this.subscribeTo(o,'onTextChange',function(t,e){if(!e)b();}),this.subscribeTo(c,'onSelectedItemChange',this._onTabChange.bind(this)),this.subscribeTo(this.getChildControlByName('filter'),'onChange',this._onFilterChange.bind(this));var T=e.channel('NotesEvents');this.subscribeTo(T,'onNoteAdded',this._onNoteAdded.bind(this)),this.subscribeTo(T,'onNoteChanged',this._onNoteChanged.bind(this));var N=e.channel('NoteCommands');this.subscribeTo(N,'AddTag',this._addTagToNote.bind(this)),this.subscribeTo(N,'Create',function(e,s){s=s||{},i.openNoteDialog({tag:t.getActiveTag(),text:s.text});}),this.subscribeTo(e.channel('navigation'),'onNavigate',function(e,s,o){if('AddNote'===o)i.openNoteDialog({tag:t.getActiveTag()});}),this.subscribeOnceTo(T,'onBeforeTagUpdate',function(){t._lastUpdateTime=new Date().getTime();}),this.subscribeOnceTo(T,'onBeforeTagRemove',function(){t._lastUpdateTime=new Date().getTime();}),this.subscribeTo(a.serverChannel('notes.note'),'onMessage',this._onServerMessage.bind(this)),this.subscribeTo(a.serverChannel('tags.tag'),'onMessage',this._onServerMessage.bind(this)),this._onTabChange(null,'tags'),this._setMaxHeight(),s.$win.on('resize'+this._eventNamespace+' orientationchange'+this._eventNamespace,this._setMaxHeight);},canBeUpdatedOnServerMessage:function t(){return!this._lastUpdateTime||this._lastUpdateTime+5000<new Date().getTime();},_setMaxHeight:function(){var t=$('body').height()-110;$('.scrollContainerList').css('height',t),$('.scrollContainerNotes').css('height',t);},_onServerMessage:function(t,e){if(e){var s=e.at(0);if(s){var i=s.get('EventType').trim();if('tags'===this._getCurrentTabId()&&('AddTag'===i||'UpdateTag'===i||'DeleteTag'===i||'Create'===i||'Delete'===i)&&this.canBeUpdatedOnServerMessage())this._controls.leftList._onServerMessage(t,e);else if('pages'===this._getCurrentTabId()&&('Create'===i||'Delete'===i||'Pin'===i||'Unpin'===i))this.getChildControlByName('pages').reload();}}},getActiveTag:function(){var t=null;if('tags'===this._getCurrentTabId()){var e=this._controls.leftList.getSelectedKey();if(e&&'00000000-0000-0000-0000-000000000000'!==e){var s=this._controls.leftList.getItems().getRecordById(e);t={id:e,name:s.get('Name'),color:s.get('Color'),needSave:true};}}return t;},openTagDialog:function(){if(this._options.errorOnLoading)t.showMessageDialog({message:rk('Невозможно создать новый тег.'),details:this._options.errorOnLoadingMessage,status:'error'});else this._controls.addTagDialog.setVisible(true);},_onAfterEditorClose:function(t,e){if(e)if('tags'===this._getCurrentTabId())this._controls.leftList.reload();else if('update'===e)this._controls.notes.loadData();},destroy:function(){l.superclass.destroy.call(this),this._controls=null;},_getCurrentTabId:function(){return this.getChildControlByName('tabs').getSelectedKey();},_onNoteAdded:function(t,e){var s=this._controls.notes,i=this._getCurrentTabId();if('onNoteAdded'===t._eventName)s.forceClearPageNumber();if('tags'===i)this._resetFilter(false,true,e),this._updateTagFilter(e);else if('pages'===i)s.hide(),this._controls.leftList.setSelectedKey(null),this._resetFilter(true,true,e),this._updateListFilter();else this._resetFilter(true,true,e),s.loadData();},_onNoteChanged:function(t,e){var s=this._controls.notes,i=this._getCurrentTabId();if('tags'===i)if(!this._preventNotesReload)this._updateTagFilter(e);else s._controls.notes.redraw(),s._controls.notes.toColView(false),this._controls.leftList.reload();else if('pages'===i)this._updateListFilter();else s.loadData();},_updateTagFilter:function(t){var e=this._filter.Tag;if(t.tags&&t.tags.length){if(!(e&&t.hasTag(e))){var s=t.tags[0];this._controls.leftList.setSelectedKey(s.id),this._filter.Tag=s.name;}}else if(e)this._controls.leftList.setSelectedKey(null),this._filter.Tag='';if(e!==this._filter.Tag)this._controls.notes.forceClearPageNumber(),this._updateListFilter();else{var i=this._controls.notes;i._controls.notes.redraw(),i._controls.notes.toColView(false),this._controls.leftList.reload();}},_onFilterChange:function(t,e){var s={StartDate:null,EndDate:null,Color:null,Tag:this._filter.Tag};if(e.Period&&'all'!==e.Period)if(s.StartDate=new Date(),s.EndDate=new Date(),'week'===e.Period)s.StartDate.setDate(s.EndDate.getDate()-7);else if('month'===e.Period)s.StartDate.setMonth(s.EndDate.getMonth()-1);else if('3months'===e.Period)s.StartDate.setMonth(s.EndDate.getMonth()-3);if(null!=e.Color&&'all'!==e.Color)s.Color=+e.Color.substring(1);var i=this._controls.search.getText()||null;if(i)s.SearchQuery=i;else s.SearchQuery=null;if(this._filter=s,this._controls.notes.forceClearPageNumber(),this._controls.leftList){var o=this._controls.leftList.getFilter();if(+(o.StartDate||null)!==+(s.StartDate||null)||+(o.EndDate||null)!==+(s.EndDate||null)||o.Color!=s.Color)o.StartDate=s.StartDate||null,o.EndDate=s.EndDate||null,o.Color=void 0===s.Color?null:s.Color,this._controls.leftList.setFilter(o);}else this._controls.notes.setFilters(s).loadData();},_prepareDate:function(t){return t.setHours(0),t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0),t;},_resetFilter:function(t,e,s){if(this._filter.SearchQuery=null,!e)this._filter.StartDate=this._filter.EndDate=this._filter.Color=null;else{if(this._prepareDate(new Date(this._filter.EndDate))<this._prepareDate(new Date()))this._filter.StartDate=this._filter.EndDate=null;if(s.color!==this._filter.Color)this._filter.Color=null;}if(t)this._filter.Tag=this._filter.Url=null;if(this._controls.notes.setFilter('page',0),''!==this._controls.search.getText())this._controls.search.resetSearch();var i={},o=this.getChildControlByName('filter'),r=o._filter.Period,n=this._filter.Color;if(this._filter.EndDate)i.Period=r;if(null!==this._filter.Color)i.Color=n;o.setFilter(i);},_updateListFilter:function(){if(this._controls.leftList){var t=this._controls.leftList.getFilter();t.SearchQuery=this._filter.SearchQuery||null,t.StartDate=this._filter.StartDate||null,t.EndDate=this._filter.EndDate||null,t.Color=void 0===this._filter.Color?null:this._filter.Color,this._controls.leftList.setFilter(t);}else this._controls.notes.setFilters(this._filter).loadData();},_onTabChange:function(t,e){var s='tags'===e,i='pages'===e,o=s||i,r=this._controls.notes,n=this.getChildControlByName('tags'),a=this.getChildControlByName('pages'),l=this._controls.leftList=s?n:i?a:null,h=this._filter;if(this.getChildControlByName('addTag').toggle(s),n.toggle(s),a.toggle(i),r.getContainer().toggleClass('ws-notes-holder_small',o),r._options.orderDESC=true,r._controls.notes.setItemsDragNDrop(true),r.setFilters({Tag:h.Tag=null,Url:h.Url=null,page:0}),r.resetPaging(),o){r.hide();var d=l.getFilter();d.SearchQuery=h.SearchQuery||null,d.StartDate=h.StartDate||null,d.EndDate=h.EndDate||null,d.Color=void 0===h.Color?null:h.Color,this._controls.leftList.setSelectedKey(null),l.setFilter(d);}else r.loadData();},_onLeftListSelectedItemChange:function(t,e){if(s.browser.isMobilePlatform){var i=this._controls.leftList;if(i._manualSelected)i._manualSelected=false;else if(!i._isEdited){var o=i.getItems().getRecordById(e);this._onLeftListItemClick(t,e,o);}}},_onLeftListItemClick:function(t,e,i){var o=this,r=t._target,n=r.getProperty('filterName'),a=i.get(r.getProperty('filterPropertyName'));if(s.browser.isMobilePlatform){if(this._controls.leftList._isEdited)return;this._controls.leftList._clearHoveredItem();}if(this._filter[n]!==a){var l={page:0},h=this._controls.notes;this._filter[n]=a,l[n]=[a];var d=$('.ws-note-list_static.ws-notes-container'),c=d.height();d.css('height','auto').css('min-height',c),h.setFilters(l).loadData().addCallback(function(){if(h.resetPaging(),(window.pageYOffset||document.documentElement.scrollTop)>10)window.scrollTo(0,0);});}},_onLeftListDrawItems:function(t){if(this._selectedKey)this._controls.leftList.setSelectedKey(this._selectedKey),this._selectedKey=null;},_onLeftListDataLoadError:function(t,e){this._options.errorOnLoading=this._controls.notes._options.errorOnLoading=true,this._options.errorOnLoadingMessage=this._controls.notes._options.errorOnLoadingMessage=e.message;},_onLeftListDataLoad:function(t,e){var s=t._target;if(this._controls.leftList!==s)return;if(this._controls.leftList._doNotRefreshNotes)this._preventNotesReload=true,this._controls.leftList._doNotRefreshNotes=false;if(this._doNotRefreshNotes)this._preventNotesReload=true,this._doNotRefreshNotes=false;var i=this._controls.notes,o=s.getSelectedKey(),r=o&&e.getRecordById(o);if(e.getCount()&&!r){if(this._preventNotesReload)if(this._currentNoteId){this._preventNotesReload=false;var n=this._controls.notes.getNote(this._currentNoteId);return void this._updateTagFilter(n);}if(r=e.at(0),o=r.getId(),s.getItems())this._controls.leftList._manualSelected=true,this._controls.leftList.setSelectedKey(o),this._selectedKey=null;else this._selectedKey=o;}if(this.getContainer().toggleClass('ws-note-page_empty-left-side',!e.getCount()),this._filter[s.getProperty('filterName')]=r?r.get(s.getProperty('filterPropertyName')):null,!this._preventNotesReload)i.setFilters(this._filter).loadData().addCallback(function(){i.show();});else this._preventNotesReload=false;},_addTagToNote:function(t,s,i){var o=this._controls.notes.getNote(s),r=this;if(r._currentNoteId=s,o){var n=this._controls.leftList.getItems().getRecordById(i);if(n)o.addTag(n.get('Name'),n.get('Color')).addCallback(function(t){if(t)r._preventNotesReload=true,e.channel('NotesEvents').notify('onNoteChanged',o);});}},_onSearch:function(){var t=this._controls.search.getText()||null,e=this._controls.leftList,s=this._controls.notes;if(this._filter.SearchQuery==t||!this._filter.SearchQuery&&!t)return;if(this._filter.SearchQuery=t,e){var i=e.getFilter();i.SearchQuery=this._filter.SearchQuery,s.hide(),s._controls.pagination.getPaging().setPage(1),e.setFilter(i);}else s.setFilters({searchQuery:this._filter.SearchQuery,page:0}),s._controls.pagination.getPaging().setPage(1),s.loadData();}});return l;});
define("html!SBIS3.Notes.NotesFilter",function(){var o=function(o){var n=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,"&#123;&#123;$1&#125;&#125;");return n}}(),t=function(o){return o.join?o.join(""):o.toString()},e=function(o){return void 0===o?"":o&&"object"==typeof o?t(o):""+o},i="undefined"!=typeof process,p=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,'<div class="ws-notesFilter"> <div class="ws-notesFilter-row"> <span class="ws-notesFilter-title">'+n(e(rk("Отбираются")))+'</span> <component data-component="Deprecated/Controls/FieldDropdown/FieldDropdown" class="ws-notesFilter-input" name="Period"> <options name="data" type="array"> <options> <option name="key">all</option> <option name="value">'+n(e(rk("За всё время")))+'</option> </options> <options> <option name="key">today</option> <option name="value">'+n(e(rk("За сегодня")))+'</option> </options> <options> <option name="key">week</option> <option name="value">'+n(e(rk("За неделю")))+'</option> </options> <options> <option name="key">month</option> <option name="value">'+n(e(rk("За месяц")))+'</option> </options> <options> <option name="key">3months</option> <option name="value">'+n(e(rk("За три месяца")))+'</option> </options> </options> <option name="tooltip">'+n(e(rk("Выберите период")))+'</option> </component> </div> <div class="ws-notesFilter-row"> <span class="ws-notesFilter-title">'+n(e(rk("Цвет заметки")))+'</span> <component data-component="Deprecated/Controls/FieldDropdown/FieldDropdown" class="ws-notesFilter-input" name="Color"> <options name="data" type="array"> <options> <option name="key" type="string">all</option> <option name="value">'+n(e(rk("все цвета")))+'</option> </options> <options> <option name="key" type="string">c0</option> <option name="value">'+n(e(rk("Жёлтый")))+'</option> </options> <options> <option name="key" type="string">c1</option> <option name="value">'+n(e(rk("Зелёный")))+'</option> </options> <options> <option name="key" type="string">c2</option> <option name="value">'+n(e(rk("Красный")))+'</option> </options> <options> <option name="key" type="string">c3</option> <option name="value">'+n(e(rk("Фиолетовый")))+'</option> </options> <options> <option name="key" type="string">c4</option> <option name="value">'+n(e(rk("Синий")))+'</option> </options> </options> <option name="emptyValue">'+n(e(rk("Выберите цвет заметки")))+'</option> <option name="tooltip">'+n(e(rk("Выберите цвет заметки")))+'</option> </component> </div> <div class="ws-notesFilter-row ');return p+="ws-hidden",p+='"> <span class="ws-notesFilter-title">'+n(e(rk("Содержат теги")))+'</span> <component data-component="Deprecated/Controls/FieldLink/FieldLink" name="Tags" class="ws-notesFilter-input"> <option name="multiSelect">true</option> <options name="suggestSettings"> <option name="autoShow">true</option> <option name="selectOnLoad">true</option> <option name="rowsCount">10</option> <options name="dataSource"> <options name="readerParams"> <option name="nameApplication">Основной сервис</option> <option name="nameService">Основной сервис</option> <option name="queryName" value="GetUserTags"></option> <option name="createMethodName" value=""></option> <option name="format" value=""></option> <option name="updateMethodName" value=""></option> <option name="readMethodName" value=""></option> <option name="destroyMethodName" value=""></option> <option name="linkedObject">Note</option> </options> </options> <options name="filter" type="array"> <option value="Tag.Name"></option> </options> <options name="processField" type="array"> <option>Tag.Name</option> </options> <options name="display"> <options name="columns" type="array"> <options> <option name="title">Tag.Name</option> <option name="field">Tag.Name</option> <option name="width">400</option> <option name="fixedSize">true</option> <option name="extendedTooltip">false</option> </options> </options> <option name="cutLongRows">true</option> </options> <option name="browserHeight">300</option> <option name="browserWidth">180</option> <option name="formatMethod">GetUserTags</option> <option name="readMethod">GetUserTags</option> <option name="tooltipInside">true</option> <option name="inputTooltip">'+n(e(rk("Выберите необходимые теги")))+'</option> </options> <option name="linkName">Tag.Name</option> <option name="linkedDisplayField">Tag.Name</option> <option name="selectRecordsMode">newFloatArea</option> <options name="dictionaries" type="array"></options> </component> </div> </div>',(p=n(p))+(i&&-1!==p.indexOf("{{")?String.fromCharCode(8203,8203):"")};return o.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.NotesFilter"}},o});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.NotesFilter", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-notesFilter-row{width:100%;height:28px}.ws-notesFilter-title{width:100px;display:inline-block;vertical-align:top;padding-top:3px}.ws-notesFilter-input{width:180px;display:inline-block}"));head.appendChild(style);});}
define('js!SBIS3.Notes.NotesFilter',['SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.NotesFilter','css!SBIS3.Notes.NotesFilter','Deprecated/Controls/FieldLink/FieldLink','Deprecated/Controls/FieldDropdown/FieldDropdown','SBIS3.CONTROLS/ComboBox','Zametki_localization'],function(e,t){'use strict';var o=e.extend({_dotTplFn:t,$protected:{_options:{}},init:function(){o.superclass.init.call(this);}});return o;});
define("tmpl!SBIS3.Notes.Tags",["Core/tmpl/js/tclosure","js!SBIS3.CONTROLS/SearchForm","js!SBIS3.CONTROLS/Button","js!SBIS3.CONTROLS/ListView","js!SBIS3.Notes.TagEditor"],function(){var e=Array.prototype.slice.call(arguments),t=e[0],r={};r["js!SBIS3.CONTROLS/SearchForm"]=e[1],r["js!SBIS3.CONTROLS/Button"]=e[2],r["js!SBIS3.CONTROLS/ListView"]=e[3],r["js!SBIS3.Notes.TagEditor"]=e[4];var o=function e(o,a,i,n,s){function l(){}var c=0,d=void 0!==t&&t?t:arguments[arguments.length-1];void 0===d&&(eval("var thelpers = null;"),d=global.requirejs("View/Runner/tclosure"));var m={};s&&s.isSetts&&(m=s.fullContext||{});var p="string"==typeof i?i:"",g=void 0===r?void 0:r,u={id:[],def:void 0},v=d.configResolver.calcParent(this,"undefined"==typeof currentPropertyName?void 0:currentPropertyName,o),S=this&&this.includedTemplates?this.includedTemplates:{},N=d.getMarkupGenerator(n);try{var f=N.joinElements([N.createTag("div",{},[N.createTag("div",{class:"ws-window-titlebar-custom"},[N.createControl("wsControl","ws:SBIS3.CONTROLS/SearchForm",{name:"searchTag",placeholder:global.rk("найти..."),trim:!0,selectOnClick:!0,maxLength:64,activableByClick:!1},{name:"searchTag",sbisname:"searchTag"},{data:o,ctx:this,pName:"undefined"!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v},i,g,S,d.config,m),N.createControl("wsControl","ws:SBIS3.CONTROLS/Button",{name:"saveTags",className:"controls-Button__primary ws-note__saveTags",caption:"OK",tooltip:global.rk("Сохранить выбранные теги"),activableByClick:!1},{name:"saveTags",sbisname:"saveTags"},{data:o,ctx:this,pName:"undefined"!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v},i,g,S,d.config,m)],{},u,this),N.createControl("wsControl","ws:SBIS3.CONTROLS/ListView",{editingTemplate:d.createDataArray([(new function(){var e=Object.create(o),t=function e(t,r,o,a,i){if(void 0===o)var o=arguments[2];var n=0,s="editingTemplate";if(void 0===d&&(eval("var thelpers = null;"),d=global.requirejs("View/Runner/tclosure")),i&&i.isSetts)var l=i.fullContext||{};t=d.isolateScope(Object.create(this),t,s);var c="string"==typeof o?o:"",m={id:[],def:void 0},p=this&&this.includedTemplates?this.includedTemplates:{},u=d.getMarkupGenerator(a);try{var S=u.joinElements([u.createControl("wsControl","ws:SBIS3.Notes.TagEditor",{bindings:[{fieldName:"Id",propName:"tagId",propPath:[],fullPropName:"tagId",propPathStr:"",oneWay:!0,direction:"fromContext",bindNonExistent:!1},{fieldName:"Name",propName:"tagValue",propPath:[],fullPropName:"tagValue",propPathStr:"",oneWay:!0,direction:"fromContext",bindNonExistent:!1},{fieldName:"Color",propName:"tagColor",propPath:[],fullPropName:"tagColor",propPathStr:"",oneWay:!0,direction:"fromContext",bindNonExistent:!1}],tagId:void 0,tagValue:void 0,tagColor:void 0},d.plainMerge(r,{}),{data:t,ctx:this,pName:void 0!==s?s:void 0,viewController:v},o,g,p,d.config,l)],c,m);m.def&&(S=u.chain(S,m,r),m=void 0)}catch(e){d.templateError("resources/Zametki/Tag/Form.tmpl",e,t)}return S||""};this.func=d.makeFunctionSerializable(t,e)}).func]),itemsActions:[{name:"edit",icon:"sprite:icon-16 icon-Edit icon-primary",tooltip:global.rk("Изменить тег во всех заметках"),onActivated:d.getter(o,["_onEdit"]),isMainAction:!0},{name:"remove",icon:"sprite:icon-16 icon-Erase icon-error",tooltip:global.rk("Удалить тег из всех заметок"),onActivated:d.getter(o,["_onRemove"]),isMainAction:!0}],name:"recentTags",className:"controls-ListView__showCheckBoxes ws-note__recent-tags",idProperty:"Id",multiselect:!0,itemsDragNDrop:!1,pageSize:10,itemContentTpl:"tmpl!SBIS3.Notes.Tags/Tag",esc:!1},{name:"recentTags",sbisname:"recentTags"},{data:o,ctx:this,pName:"undefined"!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v,internal:{__dirtyCheckingVars_1:d.getter(o,["_onEdit"]),__dirtyCheckingVars_4:d.getter(o,["_onRemove"])}},i,g,S,d.config,m)],a,u,this)],p,u);u.def&&(f=N.chain(f,u,a),u=void 0)}catch(e){d.templateError("resources/Zametki/Tag/Form.tmpl",e,o)}return f||""};return o.includedFunctions={},o.stable=!0,o.toJSON=function(){return{$serialized$:"func",module:"tmpl!SBIS3.Notes.Tags"}},o});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.Tags", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-note__tag-form{width:400px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;border-radius:5px;-webkit-border-radius:5px;-moz-border-radius:5px;-o-border-radius:5px;border-color:#e4e4e4;border-width:2px 2px 2px 2px;border-style:solid}.ws-note__tag-form .ws-window-titlebar-custom{padding:8px;height:42px;box-sizing:border-box;font-weight:400}.ws-note__tag-editor .controls-PopupMixin__closeButton{width:35px;height:26px;cursor:pointer;font-size:23px;font-family:cbuc-icons}.ws-note__tag-form .controls-SearchForm{width:298px;margin-right:8px}.ws-note__tag-form .controls-SearchForm.controls-TextBox.ws-has-focus .controls-TextBox__fieldWrapper .controls-TextBox__field{color:#000}.ws-note__saveTags{position:absolute!important;right:42px}.ws-note__tag-form .ws-note__tag{margin:7px 0 0 36px;font-size:14px;display:inline-block;max-width:245px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:default}.ws-note__new-tag,.ws-note__recent-tags .controls-ListView__item{height:32px}.ws-note__recent-tags.controls-ListView .controls-ItemsToolbar{box-shadow:none!important;bottom:0}.controls-ListView.controls-ListView__touchMode:not(.controls-ListView__bottomStyle) .controls-ItemActions .controls-ItemActions__itemsContainer .controls-ItemActions__item.controls-IconButton:before{top:0;margin-top:0}.ws-note__recent-tags.controls-ListView.controls-ListView__touchMode:not(.controls-ListView__bottomStyle) .controls-ItemActions__activeItem{background:#e7eff8!important}.touchInterface .ws-note__recent-tags.controls-ListView .controls-ItemActions .controls-ItemActions__itemsContainer .controls-ItemActions__item,.touchInterface .ws-note__recent-tags.controls-ListView .controls-ItemsToolbar .controls-ItemsToolbar__container,.ws-is-mobile-platform .ws-note__recent-tags.controls-ListView .controls-ItemActions .controls-ItemActions__itemsContainer .controls-ItemActions__item,.ws-is-mobile-platform .ws-note__recent-tags.controls-ListView .controls-ItemsToolbar .controls-ItemsToolbar__container{outline:0;outline-offset:0;border:0}.ws-note__recent-tags.controls-ListView .controls-ListView__itemCheckBox{top:4px;left:6px}.ws-note__new-tag .ws-note__tag{font-weight:700}.ws-note__tag-form .ws-note__recent-tags span.ws-note__tag{cursor:pointer}.ws-note__recent-tags.controls-ListView .controls-ItemActions__activeItem{background:#e7eff8}.ws-is-mobile-platform .ws-note__recent-tags.controls-ListView .controls-ItemActions .controls-ItemActions__itemsContainer .controls-ItemActions__item{padding:0 6px}.ws-note__recent-tags.controls-ListView .controls-ItemActions .controls-ItemActions__itemsContainer .controls-ItemActions__item{padding:0;border:0}.ws-note__recent-tags.controls-ListView .controls-ItemsToolbar .controls-ItemsToolbar__container{border:0}.ws-note__recent-tags.controls-ListView .controls-ItemActions .controls-ItemActions__itemsContainer .controls-ItemActions__item.controls-IconButton:before{margin-top:0;top:0}.ws-note__recent-tags.ws-note__recent-tags .controls-editInPlace__editing .controls-ListView__itemCheckBox:before{z-index:0}.ws-is-mobile-platform .ws-note__recent-tags.controls-ListView .controls-ItemActions .controls-ItemActions__itemsContainer .controls-ItemActions__item.controls-IconButton:before{top:4px}.ws-note__recent-tags .controls-ItemActions__icon{margin-top:4px}"));head.appendChild(style);});}
define('js!SBIS3.Notes.Tags',['Core/core-functions','Core/helpers/String/escapeHtml','Core/ParallelDeferred','Core/constants','Core/EventBus','SBIS3.CONTROLS/CompoundControl','tmpl!SBIS3.Notes.Tags','WS.Data/Source/SbisService','js!SBIS3.BL.Note','WS.Data/Entity/Model','SBIS3.CONTROLS/Utils/InformationPopupManager','SBIS3.CONTROLS/SearchForm','SBIS3.CONTROLS/ListView','SBIS3.CONTROLS/CheckBox','SBIS3.CONTROLS/TextBox','SBIS3.CONTROLS/Menu/MenuIcon','SBIS3.CONTROLS/Button/IconButton','SBIS3.CONTROLS/Button','js!SBIS3.Notes.TagEditor','css!SBIS3.Notes.Tags','i18n!SBIS3.Notes.Tags','tmpl!SBIS3.Notes.Tags/Tag','Zametki_localization'],function(t,e,o,n,s,i,a,r,c,l,d){'use strict';var h='00000000-0000-0000-0000-000000000000',g=i.extend({_dotTplFn:a,$protected:{_options:{tags:[],noteId:null,baseId:null},_controls:null,_dom:null,_currentTag:null,_doNotHandleTagChecked:false,_closeOnFocusOut:true,_activeElement:null,_eventNamespace:'.notetags',_handleTagClick:true,_cachedTags:{}},_modifyOptions:function(){var t=g.superclass._modifyOptions.apply(this,arguments);return t._onEdit=this._onEdit,t._onRemove=this._onRemove,t;},$constructor:function(){this._publish('onTagAdded','onTagUpdated','onTagRemoved','onTagCompletelyRemoved');},init:function(){g.superclass.init.call(this),this._cacheControls(),this._cacheDom();var t=this.getLinkedContext();this._options.tags=t.getValue('tags'),this._options.noteId=t.getValue('noteId'),this._options.baseId=t.getValue('baseId');var e=this._controls.recentTags;e.setDataSource(new r({endpoint:{address:'/notes/service/',contract:'Note'},idProperty:'Name',binding:{query:'GetRecentTags'}}),true),e.setFilter({NoteId:this._options.baseId||''});var o=this._options.tags.slice(0);e.setSelectedKeys(o),this.subscribeTo(e,'onDataLoad',this._onTagsLoad.bind(this)),this.subscribeTo(e,'onSelectedItemsChange',this._onSelectedItemsChanged.bind(this)),this.subscribeTo(e,'onDrawItems',this._onDrawItems.bind(this)),this.subscribeTo(e,'onChangeHoveredItem',this._onTagHover.bind(this)),this.subscribeTo(e,'onItemClick',this._onTagClick.bind(this)),this.subscribeTo(e,'onAfterEndEdit',this._onAfterEndEdit.bind(this)),this.subscribeTo(e,'onAfterBeginEdit',function(){this._notify('recalcPosition');}.bind(this)),this.subscribeTo(e,'onAfterBeginEdit',function(){s.channel('TagsEvents').notify('onBeginEditTag',this);});var i=this._controls.searchTag;this.subscribeTo(i,'onSearchStart',this._onSearch.bind(this)),this.subscribeTo(i,'onSearch',this._onSearch.bind(this)),this.subscribeTo(i,'onReset',this._onSearch.bind(this)),this.subscribeTo(this._controls.saveTags,'onActivated',this._onSaveAndClose.bind(this)),this.subscribeTo(s.channel('TagsEvents'),'onEditTag',this.onEdit.bind(this)),this.subscribeTo(s.channel('TagsEvents'),'onRemoveTag',this.onRemove.bind(this));var a=this,c=this.getContainer().closest('.ws-float-area');this.subscribeOnceTo(this,'onAfterShow',function(){setTimeout(function(){c.find('div.sbisname-window-title-close').off(a._eventNamespace).one('touchstart'+a._eventNamespace,function(t){t.preventDefault();});},100);}),this._dom.editor.on('click'+this._eventNamespace,'.ws-note-tag-color:not(.ws-note-tag-color_selected)',this._onColorize.bind(this)),c.on('focusout'+this._eventNamespace,function(t){var e=t.relatedTarget||a._activeElement;if(a._closeOnFocusOut&&!a.isDestroyed()&&e&&0===c.has(e).length&&0===$(e).closest('.ws-note__tag-color-menu').length)a._notify('onTagListClose');}),n.$body.on('touchstart'+this._eventNamespace+' mousedown'+this._eventNamespace,function(t){if(a._activeElement=t.target,$(a._activeElement).closest('.ws-noteDialog-container').length)a._notify('onTagListClose');});},destroy:function(){g.superclass.destroy.call(this),this.getContainer().closest('.ws-float-area').off(this._eventNamespace),n.$body.off(this._eventNamespace),this._dom.editor.off(this._eventNamespace),this._controls=null,this._dom=null,this._currentTag=null,this._activeElement=null,this._cachedTags=null;},_cacheControls:function(){this._controls=(this.getChildControls()||[]).reduce(function(t,e){var o=e.getName();if(o)t[o]=e;return t;},{});},_cacheDom:function(){var t=this.getContainer();this._dom={editor:t.find('.ws-note__tag-editor')};},_toggleTag:function(t,e,o,n){if(t)this._addTag(e,o,n);else this._notify('onTagRemoved',e);},_onDrawItems:function(){var t=this.getContainer();t.find('*').attr('unselectable','on').on('selectstart'+this._eventNamespace,false);var e=this._controls.searchTag.getContainer().find('.controls-TextBox__field');if(!e.is(':focus'))this._controls.searchTag.setActive(),e.focus();$(e).add(e.parentsUntil(t)).add(this._dom.editor).add(this._dom.editor.find('*')).removeAttr('unselectable').off('selectstart'+this._eventNamespace),this._notify('recalcPosition');},_addTag:function(e,o,n,s){var i=this,a=i._notify('onTagAdded',{name:e,color:o,independent:s});if(c.isDemo())return void i._onTagClick(null,h,e);this._disableList(),a.addCallbacks(function(t){var e=t&&t[0];if(n){var o=i._controls.recentTags,a=o.getItems(),r=a.getRecordById(h),c=new l({adapter:a.getAdapter(),format:a.getFormat(),idProperty:'Id'});c.set({Id:e,Name:r.get('Name'),Color:r.get('Color')}),a.add(c),i._doNotHandleTagChecked=true,o.addItemsSelection([e]),a.remove(r),i._doNotHandleTagChecked=true,o.removeItemsSelection([h]),o.redraw();}if(i._enableList(),s)i._controls.searchTag.setText(''),i._onSearch();},function(e){e=e.getRawData(),t.alert(rk('Ошибка при добавлении тега'),e.message,'error'),i._doNotHandleTagChecked=true,i._controls.recentTags.removeItemsSelection([h]),i._enableList();});},_onSearch:function(){var t=this._controls.recentTags,e=t.getFilter()||{NoteId:this._options.baseId||''},o=this._controls.searchTag.getText();if(e.SearchQuery!=o){if(o&&o.length>2)e.SearchQuery=o;else e={NoteId:this._options.baseId||''};t.setFilter(e);}},_onTagsLoad:function(t,e){var o=this._cachedTags;e.each(function(t){o[t.getId()]=t;});var n=(this._controls.recentTags.getFilter()||{}).SearchQuery;if(n&&n.length)n=n.trim();if(n&&n.length>2){var s=n.toLowerCase(),i=null;if(e.each(function(t){if(t.get('Name').toLowerCase()===s)i=t;}),!i){var a=new l({adapter:e.getAdapter(),format:e.getFormat(),idProperty:'Id'});a.set({Id:h,Name:n,Color:0}),e.add(a);}}},_onTagHover:function(t,e){if(e&&e.container){var o=this._controls.recentTags.getItemsActions().getItemsInstances(),n=!e.key||e.key==h;o.edit.toggle(!n),o.remove.toggle(!n);}},_onEdit:function(t,e,o){s.channel('TagsEvents').notify('onEditTag',e,o);},onEdit:function(t,e,o){var n=this,s=o.get('Name'),i=o.get('Color');this._currentTag={id:o.getId(),name:s,color:i,newColor:i};var a=this._controls.recentTags.getHoveredItem().record;if(!a)a=this._controls.recentTags.getItems().getRecordById(e);this._controls.recentTags.sendCommand('beginEdit',a),this._controls.recentTags.getContainer().find('.controls-ItemActions__itemsContainer').addClass('ws-hidden');},_onAfterEndEdit:function(){var t=this;setTimeout(function(){if(t._controls&&t._controls.recentTags){var e=t._controls.recentTags.getHoveredItem();if(e&&e.record)t._controls.recentTags._showItemsToolbar(e);t._controls.recentTags.getContainer().find('.controls-ItemActions__itemsContainer').removeClass('ws-hidden');}},150);},_disableList:function(){this._controls.recentTags._toggleIndicator(true);},_enableList:function(){this._controls.recentTags._toggleIndicator(false);},_onRemove:function(t,e,o){s.channel('TagsEvents').notify('onRemoveTag',e,o);},onRemove:function(o,n,s){var i=this,a=s.get('Name');this._closeOnFocusOut=false,d.showConfirmDialog({message:rk('Удалить тег','часть фразы')+' "'+e(a)+'" '+rk('из всех заметок?'),opener:this,parent:this},function(){i._disableList(),c.deleteTag(a).addCallbacks(function(){i._controls.recentTags.removeItemsSelection([n]),i._controls.recentTags.reload(),i._notify('onTagCompletelyRemoved',a);},function(e){i._enableList(),t.alert(e.details,'error');}),i._closeOnFocusOut=true;},function(){i._closeOnFocusOut=true;});},_onSelectedItemsChanged:function(t,e,o){if(o.added&&o.added.length&&o.added[0]==h){var n=this._controls.recentTags.getItems().getRecordById(h);this._addTag(n.get('Name'),0,true,true);}},_onSaveAndClose:function(t,e){function n(t,e){return(t||[]).filter(function(t){return e.indexOf(t)<0;});}var s=this,i=this._controls.recentTags.getSelectedKeys(),a=new o();if(i.length){var r=n(i=i.filter(function(t){return!!s._cachedTags[t];}),this._options.tags).map(function(t){var e=s._cachedTags[t];return{name:e.get('Name'),color:e.get('Color')};});a.push(this._notify('onTagAdded',r));}if(this._options.tags.length){var c=n(this._options.tags,i).map(function(t){return s._cachedTags[t].get('Name');});a.push(this._notify('onTagRemoved',c));}s._notify('onTagListClose',a.getStepsCount()),a.done().getResult().addCallback(function(){s._closeOnFocusOut=false;});},_onTagClick:function(t,e,o,n){var s=this;if(!t||$(n).hasClass('ws-note__tag')&&this._handleTagClick)this._handleTagClick=false,this._notify('onTagAdded',[{name:t?o.get('Name'):o,color:t?o.get('Color'):0}]).addCallback(function(){s._notify('onTagListClose');});},_onColorize:function(t,e){this._currentTag.newColor=+e,this._setRecentTagColor(this._currentTag.id,e),this._controls.tagName.setActive(true);},_closeEditor:function(){this._dom.editor.addClass('ws-hidden'),this._currentTag=null,this.setActive(true);},_setRecentTagColor:function(t,e){var o='ws-note__tag_color-',n=o+[0,1,2,3,4].join(' '+o);this._controls.recentTags.getContainer().find('.controls-ListView__item[data-id="'+t+'"]').find('.ws-note__tag').removeClass(n).addClass(o+(e||0));}});return g;});
define("html!SBIS3.Notes.DynamicNotesView",function(){var e=function(e){var n=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;e.test(n);)n=n.replace(e,"&#123;&#123;$1&#125;&#125;");return n}}(),o="undefined"!=typeof process,t=(("undefined"!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs("Core/helpers/random-helpers"),function(){return this||(0,eval)("this")}().wsDotVarStorage.storage,'<div class="ws-notes-holder ws-notes-holder_dynamic"> <component data-component="SBIS3.Notes.DynamicNoteListView" name="notes" class="ws-notes-container"></component> </div> ');return(t=n(t))+(o&&-1!==t.indexOf("{{")?String.fromCharCode(8203,8203):"")};return e.toJSON=function(){return{$serialized$:"func",module:"html!SBIS3.Notes.DynamicNotesView"}},e});
if(typeof window !== "undefined" && window.atob){define("css!SBIS3.Notes.DynamicNotesView", function() {var style = document.createElement("style"),head = document.head || document.getElementsByTagName("head")[0];style.type = "text/css";style.appendChild(document.createTextNode(".ws-notes-holder_dynamic{position:fixed;z-index:1010}.ws-narrow-page .ws-notes-holder_dynamic{z-index:1010}.ws-note_dragged,.ws-note_dragged .ws-note__content img,.ws-note_dragged div,.ws-note_dragged textarea{cursor:move!important;z-index:9999!important;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}.ws-note_dragged .ws-note__content div.LinkDecorator__wrap,.ws-note_dragged .ws-note__content div.LinkDecorator__wrap img.LinkDecorator__image{z-index:0!important}.ws-notes-holder.ws-notes-holder_dynamic{width:0}.ws-note-notification__header{width:343px;height:24px}.ws-note-notification__header .controls-Button{float:right}.ws-note-notification__body{width:380px}.ws-note-notification__header>span.ws-note-notification__text{font-size:15px;margin-left:32px;top:8px;position:absolute}.ws-note-notification__header>.icon-Successful{position:absolute;top:1px;left:7px}.ws-note-notification__body{background:#f4f4f4;padding:8px}.ws-note-notification__body>a{font-size:14px}"));head.appendChild(style);});}
(function(){var availableDict={'en-US':true},langMatch=String(typeof document==='undefined'?'':document.cookie).match(/lang=([A-z-]+)/),langName=langMatch?langMatch[1]:'ru-RU',langModule='text!Zametki/lang/'+langName+'/'+langName+'.json';if(langName in availableDict){define('Zametki_localization',['Core/i18n',langModule,'Zametki_localization'],function(i18n,data){if(data){i18n.setDict(JSON.parse(data),langModule,langName);}});}else{define('Zametki_localization',['Zametki_localization'],function(){});}}());define('html!SBIS3.Notes.PanelNotesHider',['Zametki_localization'],function(){var e=function(e){var r=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(r){for(;e.test(r);)r=r.replace(e,'&#123;&#123;$1&#125;&#125;');return r;};}(),n=function(e){return e.join?e.join(''):e.toString();},t=function(e){return void 0===e?'':e&&'object'==typeof e?n(e):''+e;},o='undefined'!=typeof process,i=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'<div class="ws-panelNotes-hider" title="');return e.showNotes?i+=r(t(rk('Скрыть заметки'))):i+=r(t(rk('Показать заметки'))),i+='"> <span class="ws-panelNotes-hider__count"></span> </div>',(i=r(i))+(o&&-1!==i.indexOf('{{')?String.fromCharCode(8203,8203):'');};return e.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.PanelNotesHider'};},e;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.PanelNotesHider',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-panelNotes-hider{display:none;height:40px;width:20px;line-height:46px;margin:0;padding:0;text-align:center;cursor:pointer;box-sizing:border-box;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAoCAYAAAD+MdrbAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAANtJREFUeNpifP/+wn8GKgIWEMH7o5sqhn3mKGVgYqAyGDVw1MBRA0cNHDVw1MBRA0cNHDVw6Bv4k9WJ4R8jP9mG/GdkZ/jJYg1mMwKbxAkMDP9agGZLs/69wsD25xgD0/+PRBv0i9mE4TeLMcN/BuZfjP+/T2f8/x/SxP7w4SLRBiMbBFT/h/H/57n/GIUqBAT0P8ANhAFCBv9m1gEHEcggpn/vlv5lEi8AGQSTxzAQl8HM/x4z/AKG0z9GPqAFb9f+YxROQTaIoIHYDAa6dCcw8jKABj3ApR4gwAAyxmqst/SWkwAAAABJRU5ErkJggg==) bottom right no-repeat;z-index:1000}.ws-panelNotes-hider__count{width:20px;color:#000;font-family:TensorFont,sans-serif;margin:0;padding:0;font-size:14px;text-align:center;line-height:26px;background:0 0;display:inline-block}.ws-panelNotes-hider.ws-panelNotes-hider_big .ws-note-hider__count{width:28px}.ws-panelNotes-hider.ws-hider_fletching{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAoCAYAAAD+MdrbAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAARVJREFUeNpifP/+wn8GKgIWEMH7o5sqhn3mKGVgYqAyGDVw1MBRA0cNHDVw1MBRA0cNHDVwUBr4j5Gf+AYnPvCHWZXhF7Mxw18mWQbmf48Z2P8cBdMku/A3sw7DV/Z0hu+sAQz/Gfl2AoUS/zJJP/3GFsHwnS0Qp4tRXPifkZ3hDxPQRSzWQDbnH8b/3/YChTP4BO0eQJUs+PDhYsIfJqWWP+wq0qx/rzCw/TnGwPT/I9wMRlCjnefnJKC3TBh+sxiDHP2H6d+7pX+ZxAsEBPQ/4PIByGBgyLYA1cMN/sqeBjGQkeEnw38G5l+M/79P/8/I24DPIHwGgwWABn748O7wBCAt8P//fwZyMVB/wvv3554ABBgACWKX/MCWsg0AAAAASUVORK5CYII=) bottom right no-repeat}.ws-panelNotes-hider.ws-panelNotes-hider_big{width:28px!important;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAoCAYAAADt5povAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAUVJREFUeNrs171KxEAQB/CZ3SQnHGqwEEQEi7vuQEEfwNpKObX2HdRHsLrOWi2tLHwDH8E7tREtrCwETfw4lGx2x0lO4QyiB2KwmCmyG1jmx/y3WoyiNkGJ5WWf4ddWKdjT0BYoKLkEFFBAAQUUUEABBRRQQAEF/L/gS9A0Rjf+DEl1nY3lfI/85F4HsKsAehHBGM9e+J67As9e/gpxahwSPZdjBBVQFJ0QBLtI1Hvix3En5GWJj27w4A2ExPr2TPv2HJS7HQzBUQZqYPQ870cAqXvDQ+w5DPfDcOY6n/AD7C/Gp9/xTcYnkZ5T3556OU4Pn84SViBVdciuxKqpLMBEUfeQ8RYj7WLvL8ECPstLFvsaxz6h6C7xbSdQ9MhQrS+y+2OHYzuMHH3X70ewgC/0cLfCk1ezyPh/m7B6wFA8SI83AQYAcDx94mR3JIwAAAAASUVORK5CYII=) bottom right no-repeat}.ws-panelNotes-hider.ws-panelNotes-hider_big.ws-hider_fletching{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAoCAYAAADt5povAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAATFJREFUeNrs2L1KBDEQAOCZJAs2eougIDYiVwpa2djpA3iN1lf4CPoU2x1X+BgHPoBvIOtPpXaWgrtyyrlnknFmsRAOxeNksZhAEkiG/ZJMmiwWRU7QYHHSzL9ljWDDuRMw0HBRUEEFFVRQQQUVVFBBBRVU8F+CbprgiC14txvguUZcAEOPIQnXNgk3gFT9DSiIt+0airgMCFWBNOrz1EXEpW7ldve5gov34MIdCD41OIHQaIgwPuOprJVu519CB2V5mXLf8Wb9yJv2TpXsBRdu613b+DDxbZSfCvLG/w7h8SxNN/PfHBfja4Lzko/5eqwivfgkXDnBDT3Xb/walOPg1XGsHxt6PWfklJHBLJeD8S3uugDhEMCuSL45BVbA0tAT52OxNyvyA9753PnBhwADACRYhLDZk4SlAAAAAElFTkSuQmCC) bottom right no-repeat}'));head.appendChild(style);});}define('js!SBIS3.Notes.PanelNotesHider',['SBIS3.CONTROLS/CompoundControl','Core/EventBus','Core/detection','Core/helpers/getSessionStorageValue','Core/helpers/setSessionStorageValue','html!SBIS3.Notes.PanelNotesHider','css!SBIS3.Notes.PanelNotesHider','Zametki_localization','Zametki_localization'],function(e,t,n,s,a,i){'use strict';var o=e.extend({_dotTplFn:i,$protected:{_options:{panelData:{panelType:'',panelTitle:'',panelId:'',canEdit:true,hasNotes:false}},_count:-1,_lightMode:true,_alreadyGotCount:false,_showNotes:false,_eventNamespace:'.panelNotesHider',_containerId:''},$constructor:function(){this._publish('onNotesCountChanged');},init:function(){o.superclass.init.call(this);var e=this,s=t.channel('NoteCommands');if(this.setVisible(false),this._dom={hider:this.getContainer(),count:this.getContainer().find('.ws-panelNotes-hider__count')},this._options.panelData.panelId)this.prepareSendEvent();if(this.subscribeTo(s,'ResendHiderLoadedEvent',function(){e.sendEventWhenHiderLoaded();}),this.subscribeTo(s,'setPanelHiderCount',function(t,n,s){if(e._containerId==n)e._lightMode=false,e._options.panelData.hasNotes=!!s,e.setCount(s);}),this.subscribeTo(s,'setPanelHiderState',function(t,n,s){if(e._containerId==n)e.setState(s);}),this.subscribeTo(s,'setPanelHiderFakeState',function(t,n){if(e._containerId==n)e.fakeToggleState();}),this.subscribeTo(s,'restorePanelHiderState',function(t,n){if(e._containerId==n)e.restoreState();}),this._dom.hider.on('mouseenter'+this._eventNamespace,function(){if(!n.isMobilePlatform)$(this).addClass('ws-panelNotes-hider_expanded');return false;}).on('mouseleave'+this._eventNamespace,function(){return $(this).removeClass('ws-panelNotes-hider_expanded'),false;}).on('touchstart'+this._eventNamespace,function(){return e.toggleState(),false;}).on('click'+this._eventNamespace,function(){return e.toggleState(),false;}),this._dom.hider.add(this._dom.hider.children()).attr('unselectable','on').on('selectstart',false),this._options.hasNotes)this._dom.hider.addClass('hasNotes');},prepareSendEvent:function(){var e=this;require(['Lib/FloatAreaManager/FloatAreaManager'],function(n){if(e._containerId=n._getTopFloatArea().id,e.sendEventWhenHiderLoaded(),e.subscribeTo(t.channel('NoteCommands'),'ResendHiderLoadedEvent',function(){e.sendEventWhenHiderLoaded();}),e.isOpenDoc(location.pathname))e.subscribeOnceTo(t.channel('NotesEvents'),'onNoteAdded',function(t,n){if(n.pinnedToPanel&&n.panelData&&n.panelData.panelId==e._options.panelData.panelId&&!e._options.panelData.hasNotes)e._forceSendEventMode=e._options.panelData.hasNotes=true,e.sendEventWhenHiderLoaded();});});},sendEventWhenHiderLoaded:function(e){var n=!!+s('show-panel-notes');if(this._lightMode=this._lightMode&&!n&&this.isOpenDoc(location.pathname),this._options.panelData.hasNotes&&this._lightMode)if(this._dom.hider.css('display','inline-block'),this.setVisible(true),!this._alreadyGotCount)this.getNotesCount();t.channel('NotesEvents').notify('onPanelNotesHiderLoaded',{type:this._options.panelData.panelType,title:this._options.panelData.panelTitle,id:this._options.panelData.panelId,canEdit:this._options.panelData.canEdit,containerId:this._containerId,hasNotes:this._options.panelData.hasNotes},this._lightMode,e);},getNotesCount:function(){var e=this;require(['WS.Data/Source/SbisService'],function(t){new t({endpoint:{contract:'Note',address:'/notes/service/'}}).call('GetCountPanelNotes',{PanelObject:e._options.panelData.panelType,PanelId:e._options.panelData.panelId}).addCallback(function(t){var n=t.getRawData();e.setCount(n),e._alreadyGotCount=true;}).addErrback(function(e){});});},setPanelData:function(e){if(this._options.panelData.panelId!==e.panelId||this._options.panelData.panelType!==e.panelType||this._options.panelData.panelTitle!==e.panelTitle||this._options.panelData.canEdit!==e.canEdit||this._options.panelData.hasNotes!==e.hasNotes)this._options.panelData=e,this.prepareSendEvent();},toggleState:function(e){if(!e&&this._fake)return;if(this._showNotes=!this._showNotes,this._dom.hider.attr('title',this._showNotes?rk('Скрыть заметки'):rk('Показать заметки')),this._dom.hider.toggleClass('ws-hider_fletching',this._showNotes),!e)if(this._lightMode)a('show-panel-notes',1),this._lightMode=false,this.sendEventWhenHiderLoaded(true);else t.channel('NotesEvents').notify('onPanelNotesHiderToggle',this._showNotes,{panelType:this._options.panelData.panelType,panelTitle:this._options.panelData.panelTitle,panelId:this._options.panelData.panelId,canEdit:this._options.panelData.canEdit,containerId:this._containerId});},fakeToggleState:function(){if(this._fake=true,this._showNotes)this._dom.hider.attr('title',rk('Показать заметки')),this._dom.hider.toggleClass('ws-hider_fletching',false);},restoreState:function(){this._fake=false;var e=!!+s('show-panel-notes');this._showNotes=e,this._dom.hider.attr('title',e?rk('Скрыть заметки'):rk('Показать заметки')),this._dom.hider.toggleClass('ws-hider_fletching',e);},setState:function(e){if(this._showNotes!==e)this.toggleState(true);},setCount:function(e){if(this._dom.count.text(e>99?'99+':e),e)this._dom.hider.css('display','inline-block');if(this.setVisible(e>0),this._dom.hider.toggleClass('hasNotes',e>0),this._dom.hider.toggleClass('ws-panelNotes-hider_big',e>=100),this._count>=0&&this._count!==e)this._notify('onNotesCountChanged',e);this._count=e;},destroy:function(){o.superclass.destroy.call(this),this._dom.hider.off(this._eventNamespace),this._dom=null;},doesUrlMatch:function(e,t){return new RegExp('^/(?:debug/)?'+t,'ig').test(e);},isOpenDoc:function(e){return!$('#accordionBg').length&&!$('[data-component="SBIS3.Navigation.Navigation"]').length||this.doesUrlMatch(e,'opendoc\\.html$');}});return o;});define('html!SBIS3.Notes.NoteActions',['Zametki_localization'],function(){var o=function(o){var n=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,'&#123;&#123;$1&#125;&#125;');return n;};}(),t=function(o){return o.join?o.join(''):o.toString();},e=function(o){return void 0===o?'':o&&'object'==typeof o?t(o):''+o;},i='undefined'!=typeof process,r=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'<div class="ws-note__actions"> ');return o.showActions&&(r+=' <component data-component="SBIS3.Notes.TagButton" name="TagButton" class="controls-IconButton__round-border"> </component> ',o.showPin&&(r+=' <component data-component="SBIS3.Notes.Pin" name="Pin" class="controls-IconButton__round-border"> <option name="allowPinToAnyPage">'+n(e(o.allowPinToAnyPage))+'</option> </component> '),r+=' <component data-component="SBIS3.CONTROLS/Button/IconButton" name="ShowNote" class="controls-IconButton__round-border"> <option name="icon">sprite:icon-16 icon-Show icon-primary</option> <option name="tooltip">'+n(e(rk('Показать заметку')))+'</option> <option name="visible">'+n(e(o.isHidden))+'</option> </component> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="HideNote" class="controls-IconButton__round-border"> <option name="icon">sprite:icon-16 icon-Hide icon-primary</option> <option name="tooltip">'+n(e(rk('Скрыть заметку')))+'</option> ',o.isHidden?r+=' <option name="visible">false</option> ':r+=' <option name="visible">'+n(e(o.showHideIcon))+'</option> ',r+=' </component> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="Remove" class="controls-IconButton__round-border"> <option name="icon">sprite:icon-16 icon-Erase icon-error</option> <option name="tooltip">'+n(e(rk('Удалить заметку')))+'</option> </component> '),r+=' </div>',(r=n(r))+(i&&-1!==r.indexOf('{{')?String.fromCharCode(8203,8203):'');};return o.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.NoteActions'};},o;});define('js!SBIS3.BL.Note',['WS.Data/Source/SbisService','WS.Data/Query/Query','WS.Data/Entity/Record','Core/helpers/random-helpers','Core/helpers/getSessionStorageValue','Core/IoC','Core/base64','Core/Deferred','Zametki_localization','Zametki_localization'],function(e,t,n,r,o,a,i,l){'use strict';var d,u,s,c=false;function f(e){return e instanceof Array?e:[e];}function g(e){return $('<div>').html(e).text().replace(/\n/g,' ');}function N(){if(!u)u=new e({endpoint:'Note'});for(var t=[],n=0,r=arguments.length;n<r;n++)t[n]=arguments[n];return u.call.apply(u,t);}function p(n){if(!s)s=new e({endpoint:{address:'/notes/service/',contract:'Note'},binding:{query:'GetPinnedNotesList'}});return s.query(new t().where(n));}function I(){if(!d)d=new e({endpoint:{address:'/notes/service/',contract:'Note'}});for(var t=[],n=0,r=arguments.length;n<r;n++)t[n]=arguments[n];return d.call.apply(d,t);}function C(){if(c)return l.success();for(var e=[],t=0,n=arguments.length;t<n;t++)e[t]=arguments[t];return I.apply(null,e);}function P(e){if(e=e?'string'==typeof e?e:e.getRawData():null,!e)c=true,e=r.createGUID();return e;}return{getPersonPinnedNotes:function e(t,r,o){var a=new n({adapter:'adapter.sbis',format:[{name:'PageUrl',type:'string'},{name:'showHidden',type:'boolean'}]});if(!o)a.set('PageUrl',location.href),a.set('showHidden',r?null:false);if(t)a.addField({name:'PanelObject',type:'string'}),a.set('PanelObject',t.type),a.addField({name:'PanelTitle',type:'string'}),a.set('PanelTitle',t.title),a.addField({name:'PanelId',type:'string'}),a.set('PanelId',''+t.id);return p(a).addCallback(function(e){return e?e.getAll():null;});},createNotification:function e(t,n,r,o,a,i,l){return C('CreateNotification',{NoteId:t,NotificationDate:n?n.toSQL(true):null,NotificationText:r,NotificationType:o,RetryCount:a,CronData:i,ExpirationDate:l});},deleteNotifications:function e(t){return C('DeleteNotifications',{NoteId:t});},createNote:function e(t){var n=t.pageUrl&&!t.pageTitle?rk('Страница без заголовка'):t.pageTitle;return C('CreateNote',{Content:t.text,Text:g(t.text),Order:t.order,Pinned:t.pin,PageUrl:t.pin?t.pageUrl:null,PageTitle:t.pin?n:null,Color:t.color,Settings:JSON.stringify(t.getSettings())}).addCallback(function(e){if(e=e?e.getRawData():null,null==e||''===e)c=true;return P(e);});},removeImages:function t(n){new e({endpoint:{contract:'FileSD',address:'/disk/api/v1/service/'}}).call('DeleteAttachments',{Ids:n});},updateNote:function e(t,n,r){return C('UpdateNote',{Id:t.baseId,Content:!r||r.indexOf('Content')>=0?t.text:null,Text:!r||r.indexOf('Text')>=0?g(t.text):null,Settings:!r||r.indexOf('Settings')>=0?JSON.stringify(t.getSettings()):null,Order:!r||r.indexOf('Order')>=0?t.order:null,Color:!r||r.indexOf('Color')>=0?t.color:null,UpdateModifyDate:!r||r.indexOf('Content')>=0?!!n:null}).addCallback(function(e){if(c)return e=t.text,e;return e.getRawData();});},rearrangeNotes:function e(t){return C('RearrangeNotes',{Id:t});},hideNote:function e(t){return C('SetHidden',{NoteId:t,IsHidden:true});},hideNotesList:function e(t){return C('SetHiddenList',{NoteId:t,IsHidden:true});},showNote:function e(t){return C('SetHidden',{NoteId:t,IsHidden:false});},showNotesList:function e(t){return C('SetHiddenList',{NoteId:t,IsHidden:false});},moveNote:function e(t,n,r){return C('MoveNote',{NextNoteId:t,NoteId:n,OnFront:r});},deleteNotes:function e(t){return C('DeleteNotes',{Id:f(t)}).addCallback(function(e){return e?e.getRawData():null;});},lockNote:function e(t){return C('LockNote',{NoteId:t});},unlockNote:function e(t){return C('UnlockNote',{NoteId:t});},getAvailableNotificationTypes:function e(){return N('GetAvailableNotificationTypes',{}).addCallbacks(function(e){return e=e.getRow(),[e.get('smsErr'),e.get('emailErr'),e.get('pluginErr')];},function(e){return a.resolve('ILogger').error(rk('Сервис заметок не позволяет создавать оповещения'),e),[e.message,e.message,e.message];});},getPersonNotes:function e(t){return t=t||{},I('GetPersonNotes',{Page:t.page||0,CountPerPage:t.pageSize||o('ws-page-size')||20,DESC:t.orderDESC||false,Tags:t.tags||[],PagesId:t.urls||[],SearchQuery:t.searchQuery||'',Color:null==t.color?null:+t.color,StartDate:t.startDate||null,EndDate:t.endDate||null});},addFile:function e(t,n){return C('AddFile',{NoteId:t,FileId:n});},deleteFile:function e(t,n){return C('DeleteFile',{NoteId:t,FileId:n});},addIndependentTag:function e(t,n){return C('AddTag',{TagName:t,Color:n}).addCallback(P);},addTag:function e(t,n,r){return C('AddTag',{NoteId:t,TagName:n,Color:r}).addCallback(P);},deleteTag:function e(t,n){var r={TagName:t};if(n)r.NoteId=n;return C('DeleteTag',r);},updateTag:function e(t,n,r){return C('UpdateTag',{Name:t,NewName:n,Color:r}).addCallback(function(e){return c?'':e?e.getRawData():'';});},getLastChangedInfo:function e(t){return C('GetLastChangedInfo',{NoteId:t});},pinNote:function e(t,n,r){return C('PinNote',{NoteId:t,PageUrl:n||null,PageTitle:r||null});},pinNoteByUrlId:function e(t,n){return C('PinNote',{NoteId:t,UrlId:n});},pinToPanel:function e(t,n,r,o){return C('PinToPanel',{NoteId:t,PanelObject:n||null,PanelTitle:r||null,PanelId:''+o||null}).addCallback(function(e){return c?'':e?e.getRawData():'';});},unpinNote:function e(t){return C('UnpinNote',{NoteId:t});},postRequestCall:function e(t,n){var r=new XMLHttpRequest();r.open('POST','https://'+window.location.host+'/notes/service/',false),r.setRequestHeader('X-CalledMethod',t),r.setRequestHeader('X-OriginalMethodName',i.encode(t)),r.setRequestHeader('X-Requested-With','XMLHttpRequest'),r.send(JSON.stringify({jsonrpc:'2.0',protocol:4,method:t,params:n,id:1}));},isDemo:function e(){return c;}};});define('js!SBIS3.Notes.Utils.Date',['Core/helpers/String/format','Core/constants','Zametki_localization','Zametki_localization'],function(t,e){'use strict';return{prettyDate:function(t){if(!(t instanceof Date)||isNaN(+t))return'';var a=t.getDate(),r=t.getHours(),n=t.getMinutes(),s=(r>9?'':'0')+r+':'+(n>9?'':'0')+n,i=new Date(t),$=new Date(),f='';i.setHours(0,0,0,0),$.setHours(0,0,0,0);var o=i-$;if(0===o)f=rk('Сегодня');else if(86400000===o)f=rk('Завтра');else if(-86400000===o)f=rk('Вчера');else f=a+' '+e.Date.monthsSmall[t.getMonth()];return f+', '+s;},nearestPrettyDate:function(t,e){if(!(t instanceof Date)||isNaN(+t))return'';if(!e)return this.prettyDate(t);else{var a=this.getRepeatType(e);return this.prettyDate(this.getNearestDate(t,a));}},getRepeatType:function(t){var e=t.split(' '),a=e[0].split('-'),r=0;if(e.length>2&&'*'!==e[2])r=2;else if(t.indexOf('*')<0)r=0;else{if('*'===a[0])r=5;if('*'===a[1])r=3;if('*'===a[2])r=1;if(a[1].indexOf(',')>0)r=4;}return r;},getCronString:function(e,a){var r=[],n={date:e};if(4===a){var s=e.getMonth()%3+1;n.monthString=s+','+(s+3)+','+(s+6)+','+(s+9);}r[0]='$date$t$%Y-%m-%d$ $date$t$%H:%M:00$',r[1]='*-*-* $date$t$%H:%M:00$ *',r[2]='*-*-* $date$t$%H:%M:00$',r[3]='$date$t$*-*-%d$ $date$t$%H:%M:00$',r[4]='*-$monthString$s$-$date$t$%d$ $date$t$%H:%M:00$',r[5]='$date$t$*-%m-%d$ $date$t$%H:%M:00$';var i=r[a],$=t(n,i);if(2===a){var f=e.getDay()-1;if(f<0)f=6;$=$+' '+f;}return $;},getNearestDate:function(t,e){var a=0,r=new Date();if(e){if(1===e&&t<r)t.setDate(r.getDate()),t.setMonth(r.getMonth()),t.setFullYear(r.getFullYear());while(t<r&&a<100)switch(a++,e){case 1:t.setDate(t.getDate()+1);break;case 2:t.setDate(t.getDate()+7);break;case 3:t.setMonth(t.getMonth()+1);break;case 4:t.setMonth(t.getMonth()+3);break;case 5:t.setFullYear(t.getFullYear()+1);}}return t;}};});define('js!SBIS3.Notes.Utils.Info',['Zametki_localization','Zametki_localization'],function(){'use strict';return{showMessageDialog:function(o){require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(i){i.showMessageDialog(o);});},showNotification:function(o){require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(i){i.showNotification({caption:o,status:'success'});});}};});define('js!SBIS3.Notes.Note',['Core/core-functions','Core/core-merge','Core/helpers/String/format','Core/helpers/random-helpers','Core/core-instance','SBIS3.CONTROLS/Utils/LinkWrapUtils','js!SBIS3.BL.Note','WS.Data/Collection/RecordSet','WS.Data/Entity/Model','Core/Deferred','Core/ParallelDeferred','Core/IoC','js!SBIS3.Notes.PanelData','js!SBIS3.Notes.Utils.Date','js!SBIS3.Notes.Utils.Info','js!SBIS3.Notes.AccordionWrapper','WS.Data/Chain','Zametki_localization','Zametki_localization'],function(t,e,i,a,n,s,r,o,l,h,d,u,c,p,f,g,T){'use strict';function I(t,e,i){this.id=t,this.name=e||'',this.size=i||0;}function _(t,i){var s;if(t=t||{},n.instanceOfModule(t,'WS.Data/Entity/Model'))s=this._fromRecord(t,i);else s=e({},t);var r=e(i?{tags:[],settingsFiles:[],files:b()}:{id:a.createGUID(),tags:[],settingsFiles:[],files:b()},this.defaults);if(e(s,r,{preferSource:true,noOverrideByNull:true}),s.calendar)s.calendar=new Date(s.calendar);if(e(this,s),this.calendar&&!this.title)this._updateTitleFromCalendar();if(this._getBaseId=this.baseId?h.success(this.baseId):new h(),this.creationDate)this.prettyCreationDate=p.prettyDate(this.creationDate);if(this.modified)this.prettyModified=p.prettyDate(this.modified);if(this.baseId)this.snapshot();if(null==this.top&&null==this.bottom)this.top=0;else if(null!=this.top&&null!=this.bottom)this.bottom=null;if(null==this.left&&null==this.right)this.left=0;else if(null!=this.left&&null!=this.right)this.right=null;}_.NOTE_BODY_PADDING=13,_.MIN_NOTE_WIDTH=220+2*_.NOTE_BODY_PADDING,_.MIN_NOTE_HEIGHT=64+2*_.NOTE_BODY_PADDING,_.DEFAULT_NOTE_WIDTH=230+2*_.NOTE_BODY_PADDING,_.DEFAULT_NOTE_HEIGHT=75+2*_.NOTE_BODY_PADDING,_.prototype.defaults={baseId:'',width:_.DEFAULT_NOTE_WIDTH,height:_.DEFAULT_NOTE_HEIGHT,order:1,pin:false,color:0,calendar:null,notificationMethod:0,cron:null,period:null,text:'',title:'',pageUrl:null,pageTitle:null,creationDate:null,pinnedToPanel:false,isHidden:false,prettyCreationDate:'',node:false};function m(t){var e=[];if(t)t.each(function(t){var i={id:t.get('Id'),name:t.get('Name'),color:t.get('Color')};e.push(i);});return e;}_.prototype._fromRecord=function t(e,i){var a=c.getTop(),s;if(n.instanceOfModule(e,'WS.Data/Entity/Model'))e=T(e).toObject();else e=e.toObject();try{s=JSON.parse(e.Settings)||{};}catch(t){s={};}if(true===s)s={};if(i)s.id=e.id;if(s.baseId=e.Id?e.Id:e.baseId,s.text=e.Content,s.order=e.Order,s.pin=e.Pinned,s.pinnedToPanel=e.PinnedToPanel||false,s.panelId=a?a.id:0,s.panelData={},s.isAuthor=e.IsAuthor||false,s.canEdit=a?a.canEdit:false,s.creationDate=e.CreationDate,s.modified=e.ModifyDate,s.settingsFiles=s.files?s.files.slice():[],s.files=b(e.Files,Boolean(!s.pinnedToPanel||s.isAuthor)),!s.pinnedToPanel||s.isAuthor)s.calendar=e.Notification,s.notificationMethod=e.TypeNotification,s.cron=e.CronData;return s.isHidden=e.IsHidden,s.color=e.Color||0,s.pageUrl=e.PageName&&'null'!=e.PageName?e.PageName:null,s.pageTitle=e.PageTitle&&'null'!=e.PageTitle?e.PageTitle:null,s.tags=i?e.tags:m(e.Tags),s;};function b(t,e){var t=t?t.split(','):[];return new o({idProperty:'attachId',rawData:t.map(function(t){return{attachId:t,fileName:'',title:'',Size:0,redactionId:'',versionForm:'',typeDoc:'',subTypeDoc:'',subVersionForm:'',hash:'',canEdit:false!==e};})});}function N(t){return t.getRawData().map(function(t){return new I(t.attachId,t.fileName,_.prettyFileSize(t.Size));});}_.prototype._updateTitleFromCalendar=function t(){this.title=this.calendar?p.nearestPrettyDate(this.calendar,this.cron):'';},_.prototype.getSettings=function t(){var e={width:this.width,height:this.height,files:N(this.files)};if(null!=this.contentImages)e.contentImages=this.contentImages;if(null!=this.top)e.top=this.top;if(null!=this.left)e.left=this.left;if(null!=this.bottom)e.bottom=this.bottom;if(null!=this.right)e.right=this.right;return e;};function y(t){var e=$('<div>').html(t),i=e.find('a.LinkDecorator__linkWrap');if(i&&i.length)e.each(function(t,e){i[t].innerText=i[t].href;});return e.text().replace(/\n/g,' ').substr(0,128);}_.prototype.setCalendar=function t(e,i,a,n,s){var o=this;return this.create(),this._updateLastUpdateTime(),this._getBaseId.addCallback(function(t){var l=y(o.text);if(!t||'object'==typeof t)t=o.baseId;if(e)return r.createNotification(t,e,l,i,a,n,s).addCallbacks(function(){return o.calendar=e,o.notificationMethod=i,o.cron=n,o._updateTitleFromCalendar(),t;},function(){return f.showMessageDialog({message:rk('Сервис оповещений недоступен'),status:'error'}),t;});else return r.deleteNotifications([t]).addCallbacks(function(){return o.calendar=null,o.notificationMethod=null,o.cron='',o._updateTitleFromCalendar(),t;},function(){return f.showMessageDialog({message:rk('Сервис оповещений недоступен'),status:'error'}),t;});});},_.prototype.save=function t(e){return this.update(e)||this.create();},_.prototype.update=function t(e){var i=this;if(this.baseId){var a=this.hasChanged(true);if(a)this.prettyModified=p.prettyDate(this.modified=new Date());return this.snapshot(),this._updateLastUpdateTime(),r.updateNote(this,a,e).addCallbacks(function(t){if(!e)i._snapshot.text=i.text=t;if(setTimeout(function(){i._updateNotification();},5000),i.oldContentImages){var a=[];for(var n in i.oldContentImages)if(i.oldContentImages.hasOwnProperty(n)&&!i.contentImages.hasOwnProperty(n))a.push(n);if(a.length)r.removeImages(a);}},function(t){if(u.resolve('ILogger').error('Ошибка при обновлении заметки',t),e&&e.length);else f.showMessageDialog({message:rk('Ошибка при обновлении заметки'),details:t.message||t.details,status:'error'});});}else if(this._creatingProcess)return this._creatingProcess.addCallback(function(){return i.update(e);});else return h.fail();},_.prototype.create=function t(){var e=this;if(!this.baseId&&!this._creatingProcess)return this.snapshot(),this._updateLastUpdateTime(),this._creatingProcess=r.createNote(this).addCallbacks(function(t){if(e.baseId=t,e._creatingProcess=null,e._getBaseId.callback(t),e.tags.forEach(function(t){if(t.needSave)r.addTag(e.baseId,t.name,t.color);}),e.pinnedToPanel&&(!$('#accordionBg').length&&!$('[data-component="SBIS3.Navigation.Navigation"]').length||e.panelId||e.panelData.panelId))if(e.panelId)e.pinToPanel(c.getDataFromStr(e.panelId));else if(e.panelData&&e.panelData.panelId)e.pinToPanel({type:e.panelData.panelType,id:e.panelData.panelId,title:e.panelData.panelTitle});else e.pinToPanel(c.getTop());},function(t){e._creatingProcess=null,u.resolve('ILogger').error('Ошибка при создании заметки',t),f.showMessageDialog({message:rk('Ошибка при создании заметки'),details:t.message||t.details,status:'error'});}),this._creatingProcess;return null;},_.prototype.wasSaved=function t(){return!!(this.baseId||this._creatingProcess);},_.prototype.remove=function t(){var e=this;if(this._updateLastUpdateTime(),this.baseId)return r.deleteNotes(this.baseId);else return this._getBaseId.addCallback(function(){return r.deleteNotes(e.baseId);});},_.prototype.lockNote=function t(){if(this.baseId)return r.lockNote(this.baseId);else return this._getBaseId.addCallback(function(){return r.lockNote(this.baseId);});},_.prototype.unlockNote=function t(){if(this.baseId)return r.unlockNote(this.baseId);else return this._getBaseId.addCallback(function(){return r.unlockNote(this.baseId);});},_.getFileRecord=function(t){var e=t.get('Version').at(0),i=e.get('FormalizedFile'),a=null,n=null,s=null,r=null;if(i)a=i.get('FEDVersion'),n=i.get('FEDSubversion'),s=i.get('FEDType'),r=i.get('FEDSubtype');return new l({idProperty:'attachId',rawData:{attachId:t.getId(),fileName:t.get('FileName'),title:t.get('Name'),Size:t.get('Size'),redactionId:e.get('Id'),versionForm:a,subVersionForm:n,typeDoc:s,subTypeDoc:r,hash:e.get('hash'),canEdit:true,encrypted:e.get('EncryptionType')}});},_.prototype.addFile=function t(e){var i=this,a=new h(),n=e.getId();if(this.hasFile(n))return h.success();var s=this.files;return this.files.add(_.getFileRecord(e)),this.files=s,this._updateLastUpdateTime(),this._getBaseId.addCallback(function(){return r.addFile(i.baseId,n).addCallbacks(function(){a.callback();},function(t){a.errback(t);}),i.baseId;}),a;},_.prototype.removeFile=function t(e){var i=this,a=new h();if(this.removeFileWithoutUpdate(e))return this._updateLastUpdateTime(),this._getBaseId.addCallback(function(){r.deleteFile(i.baseId,e).addCallbacks(function(){if(i&&(i.hasContent()||i.files.getCount()||i.tags.length))i.update().addCallbacks(function(){a.callback();},function(){a.callback();});},function(t){a.errback(t);});}),a;return h.fail();},_.prototype.removeFileWithoutUpdate=function t(e){var i=this.files.getIndexByValue(this.files.getIdProperty(),e);if(i>=0){var a=this.files;return this.files.removeAt(i),this.files=a,true;}return false;},_.prototype.hasFile=function t(e){return this.files.getIndexByValue(this.files.getIdProperty(),e)>=0;},_.prototype._getFileIds=function(){var t=[];return this.files.each(function(e){t.push(e.getId());}),t;},_.prototype.addTag=function t(e,i,a){var n=this,s=new h();if(e=e&&e.trim(),this.hasTag(e))s.callback(this.getTag(e).id);else if(this._updateLastUpdateTime(),this._getBaseId.addCallback(function(t){if(!t)t=n.baseId;if(a)r.addIndependentTag(e,i).addCallbacks(function(t){s.callback(t);},function(t){s.errback(t);});else r.addTag(t,e,i).addCallbacks(function(t){n.tags.push({id:t,name:e,color:i}),s.callback(t);},function(t){s.errback(t);});return t;}),!this.baseId)this.create();return s;},_.prototype.addTags=function t(e){var i=this,a=new d();return e.forEach(function(t){a.push(i.addTag(t.name,t.color,t.independent));}),a.done().getResult().addCallback(function(t){var e=[];return Object.keys(t).forEach(function(i){e.push(t[i]);}),e;});},_.prototype.getTag=function t(e){if(e=e&&e.trim(),e){var i=this.tags.filter(function(t){return t.name===e;});return i.length?i[0]:null;}return null;},_.prototype.hasTag=function t(e){return!!this.getTag(e);},_.prototype.removeTag=function t(e,i,a){var n=this,s=true,o=new h();if(e=e&&e.trim(),a)this.tags=this.tags.filter(function(t){return t.name!==e;}),o.callback();else{if(i)s=this.hasTag(e);else s=this.removeTagWithoutSave(e);if(s)this._updateLastUpdateTime(),this._getBaseId.addCallback(function(t){if(!t)t=n.baseId;r.deleteTag(e,t).addCallbacks(function(){return o.callback(t),t;},function(t){o.errback(t);});});else o.callback();}return o;},_.prototype.removeTags=function t(e){var i=this,a=new d();return e.forEach(function(t){a.push(i.removeTag(t));}),a.done().getResult();},_.prototype.removeTagWithoutSave=function t(e){e=e&&e.trim();var i=this.tags.filter(function(t){return t.name!==e;});if(JSON.stringify(i)!==JSON.stringify(this.tags))return this.tags=i,true;return false;},_.prototype.snapshot=function e(){this._snapshot={text:this.text,color:this.color,pin:this.pin,order:this.order,files:this._getFileIds(),width:this.width,height:this.height,left:this.left,top:this.top,bottom:this.bottom,right:this.right,calendar:this.calendar,tags:t.clone(this.tags)};},_.prototype.rollback=function t(){if(this._snapshot)this.text=this._snapshot.text,this.color=this._snapshot.color;},_.prototype._compareFiles=function(){var t=this._getFileIds(),e=t.length,i,a,n;if(!this._snapshot||this._snapshot.files.length!==e)return false;for(n=0;n<e;n++)if(i=t[n],a=this._snapshot.files[n],i!==a)return false;return true;},_.prototype._compareTags=function(){var t=this.tags.length,e,i,a;if(!this._snapshot||this._snapshot.tags.length!==t)return false;for(a=0;a<t;a++)if(e=this.tags[a],i=this._snapshot.tags[a],e.name!==i.name||e.color!==i.color)return false;return true;},_.prototype.hasChanged=function t(e,i){if(!this._snapshot)return false;var a=!v(this.text,this.undecoratedContent||this._snapshot.text)||this.color!==this._snapshot.color||!this._compareFiles()||!this._compareTags();if(e)return a;return a||(i?false:this.order!==this._snapshot.order)||this.width!==this._snapshot.width||this.height!==this._snapshot.height||this.left!==this._snapshot.left||this.top!==this._snapshot.top||this.bottom!==this._snapshot.bottom||this.right!==this._snapshot.right||this.calendar!==this._snapshot.calendar;};function D(t){var e=$(t),a='<img src="$src$s$" alt="$alt$s$" data-original-height="$height$s$" data-original-width="$width$s$ style="$style$s$" />',n={src:e.attr('src'),alt:e.attr('alt'),width:e.css('width'),height:e.css('width'),style:e.attr('style')};return i(n,a);}function P(t){return t.replace(/<img[^>]+>/gi,D).replace(/<br>/gi,'<br />').replace(/<br\/>/gi,'<br />').replace(' rel="noopener noreferrer"','');}function v(t,e){return P(t)===P(e);}function C(t){return t&&t.replace(/^\s+|\s+$/gm,'');}function k(t){var e=document.createElement('div');if(e.innerHTML=t,e.getElementsByTagName('img').length||e.getElementsByTagName('iframe').length)return false;return!C(null==e.innerText?e.textContent:e.innerText);}_.prototype.hasContent=function t(){return!k(this.text)||this.files.getCount()>0;},_.prototype.getPosition=function t(e,i){return{top:null==this.top?i-this.bottom-this.height:this.top,left:null==this.left?e-this.right-this.width:this.left};},_.prototype.setPosition=function t(e,i,a,n){var s=a-i-this.width,r=n-e-this.height,o=i<s,l=e<r;this.top=l?e:null,this.bottom=l?null:r,this.left=o?i:null,this.right=o?null:s;},_.prettyFileSize=function t(e){if(!e)return'0 '+rk('байт');var i=[rk('байт'),rk('КБ'),rk('МБ'),rk('ГБ'),rk('ТБ')],a=1024,n=Math.floor(Math.log(e)/Math.log(a)),s=n<2?0:2===n?1:2;return(e/Math.pow(a,n)).toFixed(s).replace(/\.0+$/,'')+' '+i[n];};function E(){var t=g.getAccordion();return(t?t.getPathToActiveItem():[]).join(' / ')||document.title.replace(/\/СБИС$/i,'')||rk('Главная');}return _.prototype.setPinnedToCurrentPage=function t(){this.pin=true,this.pageUrl=location.href,this.pageTitle=E();},_.prototype.pinToCurrentPage=function t(){var e=this;return this.setPinnedToCurrentPage(),this.create(),this._updateLastUpdateTime(),this._getBaseId.addCallback(function(){return r.pinNote(e.baseId,e.pageUrl,e.pageTitle);});},_.prototype.pinToMainPage=function t(){var e=this;return this.pin=true,this.pageUrl=location.protocol+'//'+location.hostname+'/',this.pageTitle='СБИС',this.create(),this._updateLastUpdateTime(),this._getBaseId.addCallback(function(){return r.pinNote(e.baseId,e.pageUrl,e.pageTitle);});},_.prototype.pinToPanel=function t(e){var i=this;return this.setPinnedToCurrentPage(),this.create(),this._updateLastUpdateTime(),this._getBaseId.addCallback(function(){return r.pinToPanel(i.baseId,e.type,e.title,e.id);});},_.prototype.pinToAllPages=function t(){var e=this;return this.pin=true,this.pageUrl=this.pageTitle=null,this.create(),this._updateLastUpdateTime(),this._getBaseId.addCallback(function(){return r.pinNote(e.baseId);});},_.prototype.unpin=function t(){var e=this;return this.pin=false,this.create(),this._updateLastUpdateTime(),this._getBaseId.addCallback(function(){return r.unpinNote(e.baseId);});},_.prototype.presetPin=function t(e){if(e==_.NOTE_PIN_PAGE)this.pin=true,this.pageUrl=location.href,this.pageTitle=E();else if(e==_.NOTE_PIN_ALL_PAGES)this.pin=true,this.pageUrl=this.pageTitle=null;else this.pin=false;},_.prototype.canBeUpdatedOnServerMessage=function t(){return!_.lastUpdateTime||_.lastUpdateTime+5000<new Date().getTime();},_.prototype._updateLastUpdateTime=function t(){_.lastUpdateTime=new Date().getTime();},_.prototype.updateNotificationOnNextSave=function t(){this._needToUpdateNotification=true;},_.prototype._updateNotification=function t(){var e=this.calendar,i,a=this;if(e&&e-new Date()>0&&this._needToUpdateNotification)i=y(this.text),r.createNotification(this.baseId,e,i,this.notificationMethod,null,this.cron,null).addCallback(function(){a._needToUpdateNotification=false;});},_.prototype.getDisplayText=function t(){return s.wrapURLs(this.text);},_.isDemo=function t(){return r.isDemo();},_.NOTE_PIN_UNPINNED=0,_.NOTE_PIN_ALL_PAGES=1,_.NOTE_PIN_PAGE=2,_.NOTE_PIN_PANEL=3,_.prototype.getPin=function t(){return this.pinnedToPanel?_.NOTE_PIN_PANEL:this.pin?this.pageUrl?_.NOTE_PIN_PAGE:_.NOTE_PIN_ALL_PAGES:_.NOTE_PIN_UNPINNED;},_;});define('js!SBIS3.Notes.TagButton',['Core/EventBus','Core/core-instance','Core/detection','SBIS3.CONTROLS/Button/IconButton','Zametki_localization','Zametki_localization'],function(t,e,o,n){'use strict';var i=n.extend({_form:null,$protected:{_options:{icon:'sprite:icon-16 icon-Unfavourite icon-primary',tooltip:rk('Добавить тег'),fromDialog:false,note:null}},init:function(){i.superclass.init.call(this),this.subscribeTo(this,'onActivated',this._onActivated.bind(this));},destroy:function(){i.superclass.destroy.call(this),this._form=null;},_onActivated:function(n,i){var s=this._options.note,a=(s.tags||[]).map(function(t){return t.id;}),r=this.getContainer(),l=this,d=-8,c=-8;t.channel('NotesEvents').notify('onTagFormActivated',s);var f=this.getLinkedContext();if(f.setValue('tags',a),f.setValue('noteId',s.id),f.setValue('baseId',s.baseId),o.isMobilePlatform){var u=this.getContainer().closest('.ws-note__body');if(u.length){var g=u.find('.ws-note__actions').position();if(g)r=u,d=g.top,c=g.left;}}require(['SBIS3.CONTROLS/FloatArea','js!SBIS3.Notes.Tags'],function(o){new o({visible:true,parent:l,opener:l,template:'<component data-component="SBIS3.Notes.Tags">'+'<option name="tags" bind="tags"></option>'+'<option name="noteId" bind="noteId"></option>'+'</component>',element:$('<div class="ws-note__tag-form"></div>'),target:r,animationLength:0,autoCloseOnHide:true,activableByClick:false,corner:'tl',locationStrategy:'bodyBounds',closeButton:true,verticalAlign:{side:'top',offset:d},horizontalAlign:{side:'left',offset:c},handlers:{onReady:function(){l._form=this,l._tagsWasChanged=false,t.channel('NotesEvents').notify('onTagFormOpened',s);var o=this.getChildControls(),n=this.getChildControlByName('recentTags'),i=o.filter(function(t){return e.instanceOfModule(t,'SBIS3.Notes.Tags');})[0];l.subscribeTo(n,'onTagUpdated',l._onTagUpdated.bind(l)),l.subscribeTo(i,'onTagAdded',l._onTagAdded.bind(l)),l.subscribeTo(i,'onTagRemoved',l._onTagRemoved.bind(l)),l.subscribeTo(i,'onTagCompletelyRemoved',l._onTagCompletelyRemoved.bind(l)),l.subscribeTo(i,'onTagListClose',function(e,o){this._tagsWasChanged=!!o,this._form.close(),setTimeout(function(){t.channel('NoteCommands').notify('RedrawTags',s);},2000);}.bind(l)),l.subscribeTo(i,'recalcPosition',function(){this._form.recalcPosition(true);}.bind(l));},onClose:function(){l._form=null,t.channel('NotesEvents').notify('onTagFormClosed',s,l._tagsWasChanged),this.destroy();}},closeByExternalClick:true,closeByExternalOver:false}).show();});},_onTagUpdated:function(e,o,n,i){var s=this._options.note,a=s.tags.filter(function(t){return t.name===o;});if(a.length)(a=a[0]).name=n,a.color=i;t.channel('NotesEvents').notify('onTagUpdated',s.id,o,n,i);},_onTagRemoved:function(e,o){var n=this._options.note;if(!(o instanceof Array))o=[o];e.setResult(n.removeTags(o).addCallback(function(){t.channel('NotesEvents').notify('onTagRemoved',n.id,o);}));},_onTagCompletelyRemoved:function(e,o){this._options.note.removeTag(o,!this._options.fromDialog,true).addCallback(function(){t.channel('NotesEvents').notify('onTagRemoved',null,o);});},_onTagAdded:function(e,o){var n=this._options.note;if(!(o instanceof Array))o=[o];e.setResult(n.addTags(o).addCallback(function(e){if(e&&e.length)t.channel('NotesEvents').notify('onTagAdded',n.id,o);return e;}));},closeForm:function(){this._form&&this._form.close();}});return i;});define('js!SBIS3.Notes.Pin',['Core/helpers/String/escapeHtml','Core/helpers/setSessionStorageValue','Core/EventBus','SBIS3.CONTROLS/Menu/MenuIcon','js!SBIS3.Notes.Note','js!SBIS3.Notes.PanelData','i18n!SBIS3.Notes.Pin','Zametki_localization','Zametki_localization'],function(i,t,e,s,n,o){'use strict';var a={};a[n.NOTE_PIN_ALL_PAGES]='sprite:icon-16 icon-primary icon-Pin2',a[n.NOTE_PIN_PAGE]='sprite:icon-16 icon-primary icon-Pin',a[n.NOTE_PIN_UNPINNED]='sprite:icon-16 icon-primary icon-Pin2',a[n.NOTE_PIN_PANEL]='sprite:icon-16 icon-primary icon-Pin';var r=s.extend({$protected:{_options:{status:n.NOTE_PIN_UNPINNED,pageTitle:'',allowPinToAnyPage:true,activableByClick:false,icon:'sprite:icon-16 icon-Pin icon-primary',pickerClassName:'ws-note__pin-menu controls-Menu__breakWord',idProperty:'id'}},_modifyOptions:function(i){var t=r.superclass._modifyOptions.apply(this,arguments);return t.caption=rk('Прикрепить заметку'),t.tooltip=rk('Прикрепить заметку'),t.items=[{id:n.NOTE_PIN_ALL_PAGES,activableByClick:false,title:rk('Ко всем страницам'),icon:'sprite:icon-16 icon-primary'},{id:n.NOTE_PIN_PAGE,activableByClick:false,title:rk('К этой странице'),icon:'sprite:icon-16 icon-primary'},{id:n.NOTE_PIN_UNPINNED,activableByClick:false,title:rk('Убрать в реестр'),icon:'sprite:icon-16 icon-primary'},{id:n.NOTE_PIN_PANEL,activableByClick:false,title:rk('К открытой панели'),icon:'sprite:icon-16 icon-primary'}],t;},$constructor:function(){this.subscribeTo(this,'onMenuItemActivate',function(i,e){if(e!==this._options.status){if(this._options.pageTitle)this.setPageTitle('');if(e!==n.NOTE_PIN_UNPINNED&&e!==n.NOTE_PIN_PANEL)t('note-pin-status',e);this.setStatus(e);}});},init:function(){if(r.superclass.init.call(this),this._isOpenDoc=!$('#accordionBg').length&&!$('[data-component="SBIS3.Navigation.Navigation"]').length,this._options.status==n.NOTE_PIN_PANEL&&!o.getTop())this.setVisible(false);else this.setPageTitle(this._options.pageTitle),this.subscribeTo(this,'onPickerOpen',this._onShowPinMenu),this.subscribeTo(this,'onPickerClose',this._onHidePinMenu),this.getContainer().on('mousedown focus',false),this.setIcon(a[this._options.status]);},_onShowPinMenu:function(){this.setStatus(this._options.status);var i=this.getItemsInstances();for(var t in i)if(i.hasOwnProperty(t))i[t].setProperty('activableByClick',false),i[t].getContainer().on('mousedown focus',false);e.channel('NotesEvents').notify('onPinMenuOpened');},_onHidePinMenu:function(){e.channel('NotesEvents').notify('onPinMenuClosed');},setStatus:function(i){if(this._markCurrentItem(i),this.setIcon(a[i]),this._options.status!==i)this._options.status=i,this._notifyOnPropertyChanged('status');},setPageTitle:function(t){this._options.pageTitle=t;var e=rk('К этой странице'),s=this._getItemById(n.NOTE_PIN_PAGE);if(!this._options.allowPinToAnyPage)if(!t||'HomePage'===t)e=rk('К главной странице');else e=rk('К странице')+' "'+i(t)+'"';if(s.title!==e)s.title=e,this.setItems(this._options.items);},_markCurrentItem:function(t){for(var e=this._options.items,s,a=o.getTop(),r=this._picker&&this.getItemsInstances(),c=0;c<e.length;c++){if(s=e[c],s.visible=s.id!=t,s.id===n.NOTE_PIN_PANEL)if(a)s.title=rk('К панели')+' "'+i(a.title)+'"';else s.visible=false;else if(s.id===n.NOTE_PIN_PAGE&&a&&this._isOpenDoc)s.visible=false;if(r)r[s.id].toggle(s.visible),r[s.id].setCaption(s.title);}if(!r)this.setItems(this._options.items);},_getItemById:function(i){var t=this._options.items.filter(function(t){return t.id===i;});return t.length?t[0]:null;}});return r;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.NoteActions',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-note__actions{display:none;position:absolute;bottom:0;right:0;font-size:0;padding:2px 4px 4px 2px;height:auto;background:inherit;border-radius:14px 0 0 0;z-index:301}.ws-note.controls-ListView__hoveredItem .ws-note__actions{display:block}.ws-note.controls-ListView__hoveredItem.ws-note_blocked .ws-note__actions,.ws-note.controls-ListView__hoveredItem.ws-note_dragged .ws-note__actions{display:none}.ws-note__actions .controls-IconButton{margin-right:4px}.ws-note__actions .controls-IconButton:last-child{margin-right:0}'));head.appendChild(style);});}define('js!SBIS3.Notes.NoteActions',['Core/EventBus','SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.NoteActions','SBIS3.CONTROLS/Utils/InformationPopupManager','Core/UserInfo','js!SBIS3.Notes.Note','SBIS3.CONTROLS/Button/IconButton','js!SBIS3.Notes.TagButton','js!SBIS3.Notes.Pin','css!SBIS3.Notes.NoteActions','Zametki_localization','Zametki_localization'],function(t,o,i,e,n,s){'use strict';var h=o.extend({_dotTplFn:i,$protected:{_options:{allowPinToAnyPage:true,showPin:true,showShare:false,isAuthor:false,staticMode:false,isHidden:false,note:null,noteRecord:null}},_modifyOptions:function(t){if(t.showHideIcon=!t.showShare,t.showActions=!t.showShare||t.isAuthor,t.staticMode)t.showHideIcon=t.isHidden=false;return t.showPin='__сбис__биллинг'!==n.get('ЛогинКлиента')&&t.showPin,t;},init:function(){if(h.superclass.init.call(this),!this._options.showActions)return;var o=this._options.note;if(this._options.noteRecord&&!o)o=this._options.note=new s(this._options.staticMode?this._options.noteRecord:this._options.noteRecord.getRawData(),this._options.staticMode);if(this.getChildControlByName('TagButton')._options.note=o,this.subscribeTo(this.getChildControlByName('Remove'),'onActivated',this._onRemoveButtonActivated.bind(this)),this.subscribeTo(this.getChildControlByName('ShowNote'),'onActivated',this._onShowButtonActivated.bind(this)),this.subscribeTo(this.getChildControlByName('HideNote'),'onActivated',this._onHideButtonActivated.bind(this)),o&&this._options.showPin&&this.hasChildControlByName('Pin')){var i=this.getChildControlByName('Pin');i.setStatus(o.getPin()),this.subscribeTo(i,'onPropertyChanged',function(e,n){if('status'===n)t.channel('NoteCommands').notify('Pin',o,i.getProperty('status'));}),this.subscribeTo(i,'onActivated',function(){this.getChildControlByName('TagButton').closeForm();}.bind(this)),this.subscribeTo(this.getChildControlByName('TagButton'),'onActivated',function(){i.hidePicker();});}},_onHideButtonActivated:function(){this._options.noteRecord.set(this._options.staticMode?'IsHidden':'isHidden',true),t.channel('NoteCommands').notify('SetNoteVisible',this._options.noteRecord,false);},_onShowButtonActivated:function(){this._options.noteRecord.set(this._options.staticMode?'IsHidden':'isHidden',false),t.channel('NoteCommands').notify('SetNoteVisible',this._options.noteRecord,true);},_onRemoveButtonActivated:function(){var o=this._options.note;e.showConfirmDialog({message:rk('Удалить заметку?')},function(){t.channel('NoteCommands').notify('Remove',o);});}});return h;});define('html!SBIS3.Notes.UploadButton',['Zametki_localization'],function(){var o=function(o){var n=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,'&#123;&#123;$1&#125;&#125;');return n;};}(),t=function(o){return o.join?o.join(''):o.toString();},e=function(o){return void 0===o?'':o&&'object'==typeof o?t(o):''+o;},i='undefined'!=typeof process,a=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'<div style="display: inline-block;"> <component data-component="SBIS3.DOCVIEW.AttachTo" name="attachToBtn"> <option name="content"> <component data-component="SBIS3.CONTROLS/Menu/MenuIcon"> <option name="icon">sprite:icon-16 icon-primary icon-Attach</option> <option name="className">controls-IconButton__round-border</option> <option name="pickerClassName">docview-attachTo</option> <option name="tooltip">'+n(e(rk('Прикрепить@@Загрузить файл')))+'</option> <option name="caption">'+n(e(rk('Прикрепить@@Загрузить файл')))+'</option> <option name="enable">true</option> <option name="allowChangeEnable">true</option> </component> </option> <option name="hasLink">false</option> <option name="hasScan">false</option> <option name="useStorageMode">true</option> <option name="caption">'+n(e(rk('Прикрепить@@Загрузить файл')))+'</option> <option name="destinationDir">notes</option> <option name="allowDragNDrop">false</option> <options name="mainOptions"> <option name="isDisk">true</option> <option name="objectName">FileSD</option> <option name="serviceUrl">/disk/api/v1/</option> </options> </component> </div>');return(a=n(a))+(i&&-1!==a.indexOf('{{')?String.fromCharCode(8203,8203):'');};return o.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.UploadButton'};},o;});define('js!SBIS3.Notes.UploadButton',['WS.Data/Source/SbisService','WS.Data/Entity/Record','Core/UserInfo','SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.UploadButton','js!SBIS3.DOCVIEW.AttachTo','Zametki_localization','Zametki_localization'],function(e,t,o,n,a){'use strict';var i=n.extend({_dotTplFn:a,$protected:{},$constructor:function(){this._publish('onFileUpload');},init:function(){i.superclass.init.call(this);var n=this;this.getContainer().on('mousedown focus',false);var a=this.getChildControlByName('attachToBtn');if(o.get('ИдентификаторПользователя')===o.get('ИдентификаторКлиента'))return a.setEnabled(false),void a.setTooltip(rk('Загрузка файлов недоступна из-за ограничений учётной записи'));this.subscribeTo(a,'onSaveFiles',function(o,a){var i=new t({adapter:'adapter.sbis',format:[{name:'ReadVersions',type:'integer'}]});i.set('ReadVersions',1),a.forEach(function(t){if(t.size)new e({endpoint:{address:'/disk/api/v1/service/',contract:'FileSD'}}).call('Read',{Id:t.storageResponse.fileId,ExtraParams:i}).addCallback(function(e){n._notify('onFileUpload',e.getRow());});else require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(e){e.showNotification({caption:rk('Размер следующего файла нулевой')+': '+t.name,status:'error'});});});}),a._onFinish=function(o,a,i,s){var r=s?s.originalResult:null,d=new t({adapter:'adapter.sbis',format:[{name:'ReadVersions',type:'integer'}]});if(d.set('ReadVersions',1),'object'==typeof o)o=o.result;new e({endpoint:{address:'/disk/api/v1/service/',contract:'FileSD'}}).call('Read',{Id:r?r.id:o,ExtraParams:d}).addCallback(function(e){n._notify('onFileUpload',e.getRow());});};}});return i;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.MenuColor',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-note-tag-color__menu-icon{width:24px;height:24px}'));head.appendChild(style);});}define('js!SBIS3.Notes.MenuColor',['SBIS3.CONTROLS/Menu/MenuIcon','css!SBIS3.Notes.MenuColor','Zametki_localization','Zametki_localization'],function(o){'use strict';var t=o.extend({$protected:{_options:{className:'ws-note-tag-color__menu-icon',icon:'sprite:icon-16 icon-primary ws-note-tag-color ws-note-tag-color_color-0',color:0,colors:['#fff','#f00','#FEC63F','#72BE44','#587AB0']}},$constructor:function(){this._publish('onSelectColor');},init:function(){t.superclass.init.call(this),this.subscribeTo(this,'onActivated',this._onColorMenuActivate.bind(this));},destroy:function(){t.superclass.destroy.call(this);},getColor:function(){return this._options.color;},setColor:function(o){this._options.color=o,this.setIcon('sprite:icon-16 icon-primary ws-note-tag-color ws-note-tag-color_color-'+o);},_onColorMenuActivate:function(o){var t=this;require(['SBIS3.CONTROLS/StylesPanelNew'],function(e){if(!t._stylePanel)t._stylePanel=new e({parent:o.getTarget(),target:o.getTarget().getContainer(),corner:'tl',element:$('<div></div>'),name:'StylesPanelNew',activableByClick:false,paletteRenderStyle:true,columnsCount:1,autoCloseOnHide:true,verticalAlign:{side:'top',offset:-12},horizontalAlign:{side:'left',offset:-8},colors:t._options.colors.map(function(o){return{color:o};}),style:{color:t._options.colors[t._options.color]},handlers:{changeFormat:function(o,e){var n=t._options.colors.indexOf(this.getJSONStyle().color);if(n<0)n=0;t._options.color=n,t.setIcon('sprite:icon-16 icon-primary ws-note-tag-color ws-note-tag-color_color-'+n),t._notify('onColorSelected',n);},onClose:function(){},onDestroy:function(){}}});else t._stylePanel.setStylesFromObject({color:t._options.colors[t._options.color]});t._stylePanel.show();});}});return t;});define('html!SBIS3.Notes.NoteEditor',['Zametki_localization'],function(){var o=function(o){var n=function(){var o={'&':'&#38;','<':'&#60;','>':'&#62;','"':'&#34;','\'':'&#39;','/':'&#47;'},n=/&(?!#?\w+;)|<|>|"|'|\//g;return function(t){return t?t.toString().replace(n,function(n){return o[n]||n;}):t;};}(),t=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,'&#123;&#123;$1&#125;&#125;');return n;};}(),i=function(o){return o.join?o.join(''):o.toString();},e=function(o){return void 0===o?'':o&&'object'==typeof o?i(o):''+o;},a='undefined'!=typeof process,p=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'<div class="ws-noteDialog"> <div class="ws-window-titlebar-custom"> <div class="ws-note-dialog__panel ws-note-dialog__panel_short"> <component data-component="SBIS3.CONTROLS/RichEditor/Components/RoundToolbar" name="roundToolbar"> <option name="isWindowToolbar">true</option> <options name="items" type="array"> <options> <option name="name">smile</option> <option name="visible">false</option> </options> <options> <option name="name">history</option> <option name="order">101</option> <option name="visible">false</option> </options> <options> <option name="id">check</option> <option name="name">Check</option> <option name="componentType">SBIS3.CONTROLS/Button/IconButton</option> <option name="icon">sprite:icon-16 icon-Check3 icon-primary</option> <option name="className">controls-IconButton__round-border</option> <option name="activableByClick">false</option> <option name="tooltip">'+t(e(rk('Вставить отметку')))+'</option> <option name="basic">true</option> <option name="order">1</option> </options> <options> <option name="name">list</option> <option name="visible">true</option> <option name="basic">false</option> <option name="order">2</option> <options name="handlers"> <option name="onMenuItemActivate" type="function"> js!SBIS3.Notes.NoteEditor:prototype._onUnorderedListClick </option> </options> </options> <options> <option name="name">styles</option> <option name="basic">false</option> <option name="order">3</option> </options> <options> <option name="name">image</option> <option name="basic">true</option> <option name="order">4</option> </options> <options> <option name="name">link</option> <option name="basic">false</option> <option name="order">5</option> </options> <options> <option name="id">upload</option> <option name="name">UploadButton</option> <option name="componentType">SBIS3.Notes.UploadButton</option> <option name="isPluginAvailable" type="boolean">'+t(e(o.isPluginAvailable))+'</option> <option name="basic">true</option> <option name="order">6</option> </options> ');return o.showActions&&(p+=' <options> <option name="id">tagButton</option> <option name="name">TagButton</option> <option name="componentType">SBIS3.Notes.TagButton</option> <option name="className">controls-IconButton__round-border ws-note-dialog__panel-button_optional </option> <option name="tabindex">-1</option> <option name="fromDialog">true</option> <option name="activableByClick">false</option> <option name="basic">false</option> <option name="order">7</option> </options> '),p+=' ',o.showNotification&&(p+=' <options> <option name="id">notification</option> <option name="name">Notification</option> <option name="componentType">SBIS3.CONTROLS/Button/IconButton</option> <option name="className">controls-IconButton__round-border ws-note-dialog__panel-button_optional </option> <option name="tooltip">'+t(e(rk('Сервис уведомлений недоступен')))+'</option> <option name="icon">sprite:icon-16 icon-Bell icon-primary</option> <option name="tabindex">-1</option> <option name="enabled">false</option> <option name="activableByClick">false</option> <option name="basic">false</option> <option name="order">9</option> </options> '),p+=' <options> <option name="id">colorize</option> <option name="name">Colorize</option> <option name="componentType">SBIS3.CONTROLS/Button/IconButton</option> <option name="basic">true</option> <option name="icon">sprite:icon-16 icon-Colorize icon-primary</option> <option name="className">controls-IconButton__round-border</option> <option name="tooltip">'+t(e(rk('Задать цвет заметки')))+'</option> <option name="tabindex">-1</option> <option name="activableByClick">false</option> <option name="order">10</option> </options> ',o.showPin&&(p+=' <options> <option name="id">pin</option> <option name="name">Pin</option> <option name="componentType">SBIS3.Notes.Pin</option> <option name="className">controls-IconButton__round-border ws-note-dialog__panel-button_optional </option> <option name="status">'+t(e(o.note.getPin()))+'</option> <option name="pageTitle">'+t(e(o.note.pageTitle||''))+'</option> <option name="allowPinToAnyPage" type="boolean">'+t(e(o.allowPinToAnyPage))+'</option> <option name="activableByClick">false</option> <option name="basic">true</option> <option name="order">11</option> </options> '),p+=' ',o.showActions&&(p+=' <options> <option name="id">remove</option> <option name="name">Remove</option> <option name="componentType">SBIS3.CONTROLS/Button/IconButton</option> <option name="icon">sprite:icon-16 icon-Erase icon-error</option> <option name="className">controls-IconButton__round-border</option> <option name="tooltip">'+t(e(rk('Удалить заметку')))+'</option> <option name="enabled">true</option> <option name="basic">true</option> <option name="order">12</option> </options> '),p+=' <options> <option name="name">toggle</option> <option name="order">100</option> </options> </options> </component> <component data-component="SBIS3.CONTROLS/Button"> <option name="name">okButton</option> <option name="className">ws-note-dialog__ok-button</option> <option name="primary">true</option> <option name="caption">ОК</option> <options name="handlers"> <option name="onActivated" type="function"> js!SBIS3.Notes.NoteEditor:prototype._onSaveButtonActivated </option> </options> <option name="tabindex">-1</option> <option name="activableByClick">false</option> </component> </div> </div> <component data-component="SBIS3.CONTROLS/ScrollContainer" class="scrollContainerEditor" name="scrollContainerEditor" style="min-width:'+t(e(o.minWidth))+'px; min-height:'+t(e(o.minHeight))+'px; max-height:'+t(e(o.maxEditorHeight))+'px;'+t(e(o.fixedHeight))+'"> <option name="content"> <component data-component="SBIS3.CONTROLS/RichEditor/Components/RichTextArea" class="ws-noteDialog-text" name="noteContent" style="min-height:'+t(e(o.minHeight))+'px;"> <option name="autoHeight" value="true"></option> <option name="templates" value="false"></option> <option name="focusOnActivatedOnMobiles">false</option> <option name="maximalHeight">0</option> <option name="minimalHeight">0</option> <option name="className">ws-note__content</option> <option name="toolbarVisible" value="true"></option> <option name="tabindex">1</option> <option name="placeholder">'+t(e(rk('Введите текст заметки')))+'</option> <option name="saveHistory">false</option> <option name="validateClass" type="function"> js!SBIS3.Notes.NoteEditor:prototype._validateClass </option> </component> </option> </component> <component data-component="SBIS3.CONTROLS/ScrollContainer" class="scrollContainerFooter"> <option name="content"> <div class="ws-note-dialog__footer"> <component data-component="SBIS3.Notes.NoteFiles" name="Files"> <option name="allowDelete">true</option> </component> <component data-component="SBIS3.Notes.NoteTags" name="Tags" class="ws-note-tags"> <option name="allowDelete" value="true" type="boolean"></option> </component> <div class="ws-note-dialog__statusbar ws-no-select"> <span class="ws-note-dialog__statusbar-text',o.note.title||(p+=' ws-hidden'),p+='">'+t(e(n(o.note.title)))+'</span> <span class="ws-note-calendar__remove icon-16 icon-Close action-hover ',o.note.title||(p+=' ws-hidden'),p+='" title="'+t(e(rk('Удалить оповещение из заметки')))+'"></span> <span class="ws-note-dialog__date">',0==o.isNewNote&&(p+=t(e(o.note.prettyModified||o.note.prettyCreationDate))),p+='</span> </div> </div> </option> </component> <div class="ws-note-shadow"> <div class="ws-note-shadow__left"></div> <div class="ws-note-shadow__right"></div> </div> </div>',(p=t(p))+(a&&-1!==p.indexOf('{{')?String.fromCharCode(8203,8203):'');};return o.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.NoteEditor'};},o;});define('html!SBIS3.Notes.NoteFiles',['Zametki_localization'],function(){var e=function(e){var r=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(r){for(;e.test(r);)r=r.replace(e,'&#123;&#123;$1&#125;&#125;');return r;};}(),t='undefined'!=typeof process,n=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'<div class="ws-note-files"> <div class="ws-note-files__previews"> ');if(e.note&&e.note.files){n+=' ';var o=e.note.files.toArray();if(o)for(var i=-1,s=o.length-1;i<s;)o[i+=1],n+=' <div class="ws-note-files__mock"></div> ';n+=' ';}return n+=' </div> </div>',(n=r(n))+(t&&-1!==n.indexOf('{{')?String.fromCharCode(8203,8203):'');};return e.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.NoteFiles'};},e;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.NoteFiles',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-note-files{padding:8px 4px 30px 4px;height:auto;z-index:0}.ws-note-files__mock{width:70px;height:70px;padding:4px;display:inline-block;vertical-align:top;margin:0}'));head.appendChild(style);});}define('js!SBIS3.Notes.NoteFiles',['Core/core-instance','Core/detection','SBIS3.CONTROLS/CompoundControl','js!SBIS3.Notes.Note','html!SBIS3.Notes.NoteFiles','Core/Deferred','Core/UserInfo','Core/EventBus','Core/Context','WS.Data/Entity/Record','WS.Data/Collection/RecordSet','WS.Data/Source/SbisService','css!SBIS3.Notes.NoteFiles','Zametki_localization','Zametki_localization'],function(e,t,i,o,s,n,r,a,l,c,f,d){'use strict';var h,u;function p(){if(!u)u=new n(),require(['js!SBIS3.DOCVIEW.List','js!SBIS3.DOCVIEW.linkActivated'],function(e){h=e,u.callback();});return u;}var g=i.extend({_dotTplFn:s,$protected:{_options:{staticMode:false,note:null,noteRecord:null,allowDelete:true,allowEditAttachments:'__сбис__биллинг'!==r.get('ЛогинКлиента')}},createFilesRecordSet:function(e){return new f({idProperty:'attachId',rawData:e.map(function(e){return{attachId:e.attachId,fileName:e.fileName,title:e.title,Size:e.Size,redactionId:e.redactionId,versionForm:e.versionForm,typeDoc:e.typeDoc,subTypeDoc:e.subTypeDoc,subVersionForm:e.subVersionForm,hash:e.hash,canEdit:e.canEdit};})});},$constructor:function(){if(this._publish('onDrawItems','onFilesDraw'),this._options.noteRecord){var t=this._options.noteRecord;if(!this._options.staticMode)if(t=this._options.noteRecord.getRawData(),!e.instanceOfModule(t.files,'WS.Data/Collection/RecordSet'))t.files=this.createFilesRecordSet(t.files);this._options.note=new o(t,this._options.staticMode);}this._updateVisibility();},init:function(){if(g.superclass.init.call(this),this._options.note){for(var e=this._options.note.files.getCount()+1,t=new Array(e),i=0;i<e;i++)t[i]='';this.getContainer().find('.ws-note-files__previews').html(t.join('<div class="ws-note-files__mock"></div>'));}},_updateVisibility:function(){this.toggle(this._hasFiles());},reload:function(){if(this._updateVisibility(),this.hasChildControlByName('previews'))this.getChildControlByName('previews').reload();else if(h)this._renderFiles();else if(this._hasFiles()){var e=this;p().addCallback(function(){e._renderFiles();});}},_hasFiles:function(){return!!(this._options.note&&this._options.note.files&&this._options.note.files.getCount());},_renderFiles:function(){if(!this._hasFiles())return;var i=this,o=l.createContext(this,null,this.getLinkedContext()),s=this.getContainer().find('.ws-note-files__previews'),n=s.height();if(s.css('min-height',n),this._options.noteRecord&&!this._options.noteRecord.get('files'))this._options.noteRecord.set('files',this._options.note.files);if(this._options.noteRecord&&!e.instanceOfModule(this._options.noteRecord.get('files'),'WS.Data/Collection/RecordSet'))return;if(o.setValue('files',this._options.noteRecord?this._options.noteRecord.get('files'):this._options.note.files),!this.hasChildControlByName('previews')){var c=new h({name:'previews',element:s,parent:this,opener:this,context:o,listOptions:{visibilityMode:{defaultMode:'bigPreview'},previewWidth:70,previewHeight:70,infiniteScroll:false,calcMargin:false,hasHierarchy:false,itemsDragNDrop:false,multiselect:false,hideBreadCrumbs:true},mainOptions:{objectName:'FileSD',serviceUrl:'/disk/api/v1/',useOnlyCtx:true,ctxLinkList:'files',commands:{deleteDoc:this._options.allowDelete,directLink:false,addPage:false,edit:this._options.allowEditAttachments,editInApp:this._options.allowEditAttachments,encrypt:false,fullScreen:false,print:!t.isMobilePlatform,saveToPdf:false,upload:true,zoomMinus:true,zoomPlus:true,crop:false,rotateLeft:false,rotateRight:false,rename:false,saveChanges:true,signs:false,signDocument:'__сбис__биллинг'===r.get('ЛогинКлиента')?false:true,redactions:false,closeFullScreen:true,closeAttach:false,linkActivated:false,rights:false,sendMessage:false,directLinkDisk:false,toCommonDocs:false,toMyDocs:false,copyToDisk:false,restore:false,findInMyDocs:false,findInCommonDocs:false,deletePermanentlyDoc:false,move:false,responsible:false,toSbisDisk:false,links:true,imageEdit:true}}});if(this.subscribeTo(c,'onDrawItems',function(){i._notify('onFilesDraw'),this.getContainer().css('min-height','auto');}),this._options.allowDelete)this.subscribeTo(c,'onFinishCommand',this._onFinishDelete.bind(this));if(t.isMobilePlatform)c.getTreeView()._checkClickByTap=false,i.subscribeTo(c,'onClick',function(e,t){if(i._options.noteId)a.channel('NotesEvents').notify('onNoteOpen',t,i._options.noteId);});this.registerChildControl(c);}},_onFinishDelete:function(e,t,i){if('deleteDoc'===t){var o=i.records[0].getId();if(this._options.noteRecord)this._options.note.files=this._options.noteRecord.get('files');if(this._options.note.removeFile(o),this._options.noteRecord){var s=this._options.noteRecord.get('files'),n=s.getRecordById(o),r=n?s.getIndex(n):-1;if(r>=0){var l=s;s.removeAt(r),s=l;}}this._updateVisibility(),this._notify('onReload'),a.channel('NotesEvents').notify('onFileRemoved',this._options.note);}}});function _(t){var i=t.getNotes(t._isStatic);if(!i)return{};if(e.instanceOfModule(i,'WS.Data/Collection/RecordSet')){var s=[];return i.each(function(e){var t=new o(e);if(t.files)t.files.forEach(function(i){s[i.getId()]={file:i,note:t,noteModel:e};});}),s;}else return i.reduce(function(e,t){if(t.files)if(t.files.each)t.files.each(function(i){e[i.getId()]={file:i,note:t};});else t.files.forEach(function(i){e[i.attachId]={file:i,note:t};});return e;},{});}function m(e){var t=new c({adapter:'adapter.sbis',format:[{name:'ReadVersions',type:'integer'}]});return t.set('ReadVersions',3),new d({endpoint:{address:'/disk/api/v1/service/',contract:'FileSD'}}).call('ReadFiles',{Ids:e,ExtraParams:t}).addCallback(function(e){return e.getAll();});}function v(e,t){t.each(function(t){var i=t.getId(),o=e[i];if(t.get('ErrorMsg')||t.get('Deleted'))return void o.note.removeFile(i);var s=o.file,n=t.get('Version').at(0),r=n.get('FormalizedFile'),a={fileName:t.get('FileName'),title:t.get('Name')||t.get('FileName'),Size:t.get('Size'),redactionId:n.get('Id'),encrypted:n.get('EncryptionType'),canEdit:t.get('canEdit'),hash:n.get('hash')};if(r)a.versionForm=r.get('FEDVersion'),a.subVersionForm=r.get('FEDSubversion'),a.typeDoc=r.get('FEDType'),a.subTypeDoc=r.get('FEDSubtype');var l=o.note.files;if(s.set(a),o.note.files=l,o.noteModel){var c=o.noteModel.get('files').getRecordById(s.get('attachId'));if(c)c.set(a);}var f=o.note.settingsFiles.filter(function(e){return e.id==i;});if(f&&f.length&&f[0].name!==a.title&&f[0].name!==a.fileName)o.note.update();});}var D;function C(t){var i=D=new Date().getTime(),o=_(t),s=Object.keys(o);function n(){return i!==D;}if(0===s.length)return;p(),m(s).addCallback(function(i){if(n())return;v(o,i),p().addCallback(function(){if(n())return;(t.getChildControls()||[]).forEach(function(t){if(e.instanceOfModule(t,'SBIS3.Notes.NoteFiles'))t._renderFiles();});});});}return g.loadFilePreviews=C,g;});define('js!SBIS3.Notes.NoteTags',['Core/helpers/String/escapeHtml','SBIS3.CONTROLS/CompoundControl','SBIS3.CONTROLS/Utils/InformationPopupManager','Zametki_localization','Zametki_localization'],function(t,e,i){'use strict';function o(t){var e=$(t).closest('.ws-note__tag');return e.closest('.ws-note-tags').find('.ws-note__tag').index(e);}var s=8,n=21,a=e.extend({$protected:{_options:{note:null,allowDelete:false},_compiledTemplate:null},$constructor:function(){this._publish('onActionCompleted');},_updateVisibility:function(){this.toggle(this._hasTags());},_hasTags:function(){return this._options.note.tags.length>0;},init:function(){a.superclass.init.call(this);var t=this.getContainer();if(this._options.allowDelete)t.on('click.note-tags','.ws-note-tags__remove',this._onRemoveClick.bind(this));},destroy:function(){a.superclass.destroy.call(this),this.getContainer().off('.note-tags');},reload:function(){var t=this._getTemplate()(this._options.note.tags||[]),e=this.getContainer();if(e.html(t),this._updateVisibility(),!this._options.allowDelete)this._resizeTags(e);},_getTemplate:function(){if(!this._compiledTemplate)this._compiledTemplate=doT.compile('{{? it.length}}'+'{{~it :tag}}'+'<span class="ws-note__tag ws-note__tag_color-{{=tag.color}}">'+'{{!tag.name}}'+(this._options.allowDelete?'<span class="ws-note-tags__remove icon-16 icon-Close action-hover" title="'+rk('Удалить тег из заметки')+'"></span>':'')+'</span>'+'{{~}}'+'{{?}}');return this._compiledTemplate;},_onRemoveClick:function(e){var s=o(e.target),n=this._options.note,a=n.tags[s],l=a&&a.name,r=this;if(e.stopPropagation(),l)i.showConfirmDialog({message:rk('Удалить тег','часть фразы')+' "'+t(l)+'" '+rk('из заметки?'),parent:this,opener:this},function(){n.removeTag(l),r.reload(),r._notify('onActionCompleted');},function(){r._notify('onActionCompleted');});},_resizeTags:function(t){var e=t.find('.ws-note-tags__ellipsis'),i={},o=[],a;if(!t.find('.ws-note__tag').length)return void e.addClass('ws-hidden');if(e.addClass('ws-hidden'),t.find('.ws-note__tag').each(function(){if($(this).removeAttr('style'),a=$(this).position().top,-1===o.indexOf(a))if(o.push(a),o.length>2)return;if(!i.hasOwnProperty(a))i[a]=[];i[a].push($(this));}),o.length>2){var l=i[o[1]].length,r=i[o[1]][l-1],h=t.find('.ws-note-tags-html').width(),d=r.position().left-s+r.outerWidth(true);if(1===l&&h-d<n){var p=r.width()-n;return r.width(p),r.after(e),void e.removeClass('ws-hidden');}if(h-d<n)r.before(e);else r.after(e);e.removeClass('ws-hidden');}else e.addClass('ws-hidden');}});return a;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.NoteEditor',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-noteDialog{overflow:visible;box-sizing:border-box;padding-bottom:32px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.ws-noteDialog-container{overflow:visible!important;border:none;-webkit-box-shadow:0 0 5px 0 rgba(70,70,70,.65);-moz-box-shadow:0 0 5px 0 rgba(70,70,70,.65);box-shadow:0 0 5px 0 rgba(70,70,70,.65)}.ws-noteDialog-container .ws-float-close-right{background:0 0}.ws-noteDialog-container .ws-window-content{overflow:visible!important}.ws-noteDialog .controls-RichEditor__editorFrame.ws-basic-style.mce-content-body{-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text;overflow-x:hidden;overflow-y:hidden}.ws-noteDialog-text .ws-basic-style ol{padding-left:27px}.ws-noteDialog-text .ws-basic-style ol,.ws-noteDialog-text .ws-basic-style ul{padding:0 8px 0 27px}.ws-noteDialog-container .ws-window-content,.ws-noteDialog-container .ws-window-titlebar{background-color:transparent}.ws-note-dialog__panel{padding:6px 0 0 6px}.controls-ScrollContainer.scrollContainerFooter{position:absolute;bottom:0;left:0;right:0}.ws-note-dialog__statusbar{height:24px;cursor:default;padding:8px 8px 0 8px;color:#999;font-size:0;display:flex}.ws-note-dialog__statusbar-text:before{content:"\\e69b";font-family:cbuc-icons;font-size:16px;margin-right:4px;vertical-align:text-top}.ws-note-dialog__date{float:right;font-size:12px;position:absolute;right:10px}.ws-noteDialog span[data-mce-type=bookmark]{display:inline;width:0;height:0;font-size:0}.ws-note__disable_selection{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.ws-note-dialog__ok-button{position:absolute!important;top:8px;right:44px;width:58px}.ws-note-overlay_unselectable{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.ws-noteDialog-container_transparent{opacity:0}.ws-noteDialog .ws-note-tags{display:block;height:auto;margin-top:8px}.ws-noteDialog-container .ws-note-shadow{width:100%;bottom:-6px}.ws-noteDialog .ws-note-files{overflow:hidden;padding:11px 12px 28px;border-top:1px dashed rgba(0,0,0,.1);-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;min-height:118px;box-sizing:border-box}.ws-noteDialog .ws-note-calendar__remove{cursor:pointer;display:inline-block;margin-right:auto;vertical-align:bottom;padding-block-start:1px}.ws-note-dialog__statusbar-text{font-size:12px}.ws-note-dialog__panel .icon-Picture,.ws-note-dialog__panel .icon-Picture:before{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.ws-noteDialog .controls-RichEditor{background:0 0;margin-left:4px}.ws-noteDialog-text.controls-RichEditor .controls-RichEditor__editorFrame{border:0}.ws-note-files__previews .controls-ListView:not(.controls-ListView__dataLoaded){min-height:78px}.ws-is-firefox .ws-note-dialog__footer .ws-note-files.ws-hidden~.ws-note-dialog__statusbar .ws-note-dialog__date,.ws-is-firefox .ws-note-dialog__footer .ws-note-tags.ws-hidden~.ws-note-dialog__statusbar .ws-note-dialog__date{margin-right:17px}.ws-is-firefox .ws-note-dialog__footer .ws-note-files:not(.ws-hidden)~.ws-note-dialog__statusbar .ws-note-dialog__date,.ws-is-firefox .ws-note-dialog__footer .ws-note-tags:not(.ws-hidden)~.ws-note-dialog__statusbar .ws-note-dialog__date{margin-right:0!important}body.ws-body-no-scroll.ws-note-openedDialog{overflow:hidden}.ws-noteDialog-container .ws-window-titlebar-action.maximize{display:none}.ws-is-ie .ws-note__content.ws-noteDialog-text .controls-RichEditor__editorFrame>p{margin-bottom:0;padding-bottom:6px}.ws-noteDialog .ws-noteDialog-text .ws-note__checkable img{pointer-events:auto}'));head.appendChild(style);});}define('js!SBIS3.Notes.NoteEditor',['Core/helpers/fast-control-helpers','Core/helpers/Array/findIndex','Core/helpers/Function/debounce','Core/EventBus','Core/constants','SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.NoteEditor','js!SBIS3.BL.Note','Lib/ServerEvent/Bus','Core/UserInfo','Core/Sanitize','js!SBIS3.DOCVIEW.AttachTo','js!SBIS3.Notes.NoteFiles','js!SBIS3.Notes.NoteTags','js!SBIS3.Notes.UploadButton','js!SBIS3.Notes.TagButton','optional!js!SBIS3.Notes.Pin','SBIS3.CONTROLS/RichEditor/Components/RichTextArea','SBIS3.CONTROLS/RichEditor/Components/RoundToolbar','SBIS3.CONTROLS/Button','SBIS3.CONTROLS/Button/IconButton','SBIS3.CONTROLS/Menu/MenuIcon','SBIS3.CONTROLS/ScrollContainer','css!SBIS3.Notes.NoteEditor','i18n!SBIS3.Notes.NoteEditor','Zametki_localization','Zametki_localization'],function(t,e,o,i,n,s,a,r,l,c,d){'use strict';var h=17,_=40,u=['rgb(255, 253, 157)','rgb(223, 252, 173)','rgb(255, 213, 185)','rgb(236, 214, 236)','rgb(201, 238, 255)'];function f(t){t.getContainer().find('.ws-note__checkable').each(function(t,e){var o=$(e);if(0===o.height())o.append('<br data-mce-bogus="1">');});}function m(t){return t=t||'',d(t.replace(/min-height:\s*\d+(\.\d+)?px;/gi,'data-$&'));}function g(t,e){t.getSelectedBlocks().forEach(e);}function C(t){var e=true;return g(t,function(t){if(e)e='UL'===t.tagName||'OL'===t.tagName||'LI'===t.tagName;}),e;}function b(t){var e=true;return g(t,function(t){if('UL'!==t.tagName&&'OL'!==t.tagName&&!$(t).hasClass('ws-note__checkable'))return e=false;}),e;}function w(t){var e=null,o=null;if(g(t,function(t){if(!e)if('OL'===t.tagName||'UL'===t.tagName)e=t.tagName;else if(!o&&t.parentNode&&('OL'===t.parentNode.tagName||'UL'===t.parentNode.tagName))o=t.parentNode.tagName;}),!e)if(t.parentNode)return w(t.parentNode);else return o;else return e;}function p(t){g(t,function(t){var e=$(t),o=e.html();if('<br data-mce-bogus="1">'===o||' '===o||''===o||'&nbsp;'===o)e.remove();}),t.select();}function v(t){var e=t.getRng(),o=t.getStart()===t.getEnd(),i=e.startContainer===e.endContainer;if($(e.startContainer).hasClass('mce-content-body'))return o;else return o||i;}function N(t){var e=$(t);if(e.hasClass('ws-note__checkable')||e.hasClass('ws-note__checkable_checked')||e.hasClass('ws-note__checkable_unchecked'))return $(t).removeClass('ws-note__checkable ws-note__checkable_checked ws-note__checkable_unchecked'),true;else return false;}function y(){var t=390,e=600,o=70,i=n.$win.height();if(n.browser.isMobilePlatform)return i<n.$win.width()?t:e;else return i-o;}var k=s.extend({_dotTplFn:a,$protected:{_options:{note:null,noteRecord:null,isNewNote:false,noteElement:null,isPluginAvailable:false,allowPinToAnyPage:false,resizeSymmetrically:false,maxEditorHeight:y(),minWidth:494,minHeight:n.browser.isMobilePlatform?150:200,fixedHeight:n.browser.isMobilePlatform?'height: 200px':'',isLocked:false},_eventNamespace:'.note-editor',_dom:null,_controls:null,_notificationForm:null,_isPanelCollapsed:true,_bookMark:null,_domChanged:0,_lastHeight:0},$constructor:function(){this._publish('onTagChanged');},_modifyOptions:function(t){return t.showActions=!t.note.pinnedToPanel||t.note.isAuthor,t.showNotification=t.showActions,t.showPin='__сбис__биллинг'!==c.get('ЛогинКлиента')&&t.showActions,t;},init:function(){k.superclass.init.call(this);var t=this,e=this.getContainer(),s=this._options.note,a=this.getChildControlByName('okButton'),r=this.getChildControlByName('noteContent'),l=this.getChildControlByName('roundToolbar'),c=this.getChildControlByName('scrollContainerEditor');this._dom={mainDlg:$('div[templatename="js!SBIS3.Notes.NoteEditor"]'),window:e.closest('.ws-window'),titlebar:e.find('.ws-window-titlebar-custom'),footer:e.find('.ws-note-dialog__footer'),footerText:e.find('.ws-note-dialog__statusbar-text'),footerFiles:e.find('.ws-note-dialog__footer .ws-note-files'),footerTags:e.find('.ws-note-dialog__footer .ws-note-tags'),calendarRemove:e.find('.ws-note-calendar__remove'),editorFrame:r.getContainer().find('.controls-RichEditor__editorFrame'),scroll:e.find('.controls-ScrollContainer.scrollContainerEditor'),scrollFooter:e.find('.controls-ScrollContainer.scrollContainerFooter'),scrollContent:e.find('.controls-ScrollContainer.scrollContainerEditor .controls-ScrollContainer__content')};var d=l.getItemInstance('list'),_=l.getItemInstance('styles'),u=_?l.getStylesPanel(_):null,m=l.getChildControlByName('UploadButton'),g=l.getChildControlByName('Check'),C=l.getChildControlByName('Colorize');if(this.subscribeTo(d,'onActivated',function(){if(!t._controls.list)t._controls.list=this._picker;t._closeFloatAreas('UnorderedList');}),this._dom.calendarRemove.on('click',this._onRemoveCalendar.bind(this)),this._controls={content:r,toolbar:l,styles:u,upload:m,check:g,colorize:C,ok:a},l.setLinkedEditor(r),this.subscribeTo(this._controls.upload,'onMenuActivated',this._onUploadActivated.bind(this)),this.subscribeTo(this._controls.check,'onActivated',this._onCheckClick.bind(this)),this.subscribeTo(this._controls.colorize,'onActivated',this._onColorMenuActivate.bind(this)),this.subscribeTo(this,'onBeforeShow',this._onBeforeShow),this.subscribeTo(this,'onAfterShow',this._onAfterShow),this.subscribeTo(this,'onReady',this._onReady.bind(this)),this.subscribeTo(this,'onResize',n.browser.isMobilePlatform?t._onEditorResize:o(t._onEditorResize,100)),this._options.showPin)this._controls.pin=l.getChildControlByName('Pin'),this.subscribeTo(this._controls.pin,'onPropertyChanged',this._onPinPropertyChanged.bind(this)),this.subscribeTo(this._controls.pin,'onActivated',this._onPinActivated.bind(this));if(this._options.showNotification)this._controls.notification=l.getChildControlByName('Notification'),this.subscribeTo(this._controls.notification,'onActivated',this._onNotificationActivated.bind(this));if(this._options.showActions)this._controls.remove=l.getChildControlByName('Remove'),this.subscribeTo(this._controls.remove,'onActivated',this._onRemoveButtonActivated.bind(this));var b=this._controls.files=this.getChildControlByName('Files');b._options.note=s,b._options.noteRecord=this._options.noteRecord,b.reload(),this.subscribeTo(b,'onReload',function(){t._domChanged=new Date().getTime(),t._adjustEditorBottomPadding();}),this.subscribeTo(b,'onFilesDraw',function(){t._domChanged=new Date().getTime(),t._adjustEditorBottomPadding();});var w=this._controls.tags=this.getChildControlByName('Tags');w._options.note=s,w.reload(),this.subscribeTo(w,'onActionCompleted',function(){t._adjustEditorBottomPadding(),t._focusOnEditor();}),f(r),this.subscribeTo(r,'onTextChange',this._onTextChange.bind(this)),this.subscribeTo(r,'onDestroy',function(){this.getContainer().off(t._eventNamespace);}),this._dom.window.addClass('ws-noteDialog-container'),this.changeColor(s.color),this.subscribeTo(this.getChildControlByName('UploadButton'),'onFileUpload',this._onFileUpload.bind(this));var p=n.browser.isMobilePlatform?'touchstart'+this._eventNamespace+' touchend'+this._eventNamespace:'mousedown'+this._eventNamespace+' mouseup'+this._eventNamespace;r.getContainer().on('touchstart'+this._eventNamespace+' touchend'+this._eventNamespace,function(){t._closeFloatAreas();}),r.getContainer().on('DOMNodeInserted'+this._eventNamespace,function(e){if(t._domChanged=new Date().getTime(),e.target&&'LI'==e.target.nodeName&&$(e.target).hasClass('ws-note__checkable_checked')&&'<br data-mce-bogus="1">'==e.target.innerHTML)$(e.target).removeClass('ws-note__checkable_checked').addClass('ws-note__checkable_unchecked');}),r.getContainer().on('DOMNodeRemoved'+this._eventNamespace,function(e){t._domChanged=new Date().getTime();}),r.getContainer().on(p,'.ws-note__checkable',function(e){var o,i,n,s,a=$(e.target);if('touchend'===e.type||'touchstart'===e.type){if(o=e.originalEvent.touches[0],o)i=a.offset(),n=o.pageX-i.left,s=o.pageY-i.top;}else n=e.offsetX,s=e.offsetY;if(e.target===e.currentTarget&&n<=h){if(e.preventDefault(),'mouseup'===e.type||'touchend'===e.type||'touchstart'===e.type)a.toggleClass('ws-note__checkable_checked').toggleClass('ws-note__checkable_unchecked'),tinyMCE.activeEditor.selection.moveToBookmark(t._bookMark);else t._bookMark=tinyMCE.activeEditor.selection.getBookmark(2,true);t._triggerInputChange(),tinyMCE.activeEditor.selection.moveToBookmark(t._bookMark);}}),this.disableSelection('.ws-window-titlebar-custom, .ws-window-titlebar-custom *,.ws-window-overlay,.ws-note-date-html,.ws-note-dialog-shadow,.ws-note-dialog__footer'),n.$win.on('beforeunload'+this._eventNamespace,this._onBeforeUnload.bind(this)),n.$win.on('unload'+this._eventNamespace,this._onUnload.bind(this)),this._checkNotificationServiceAvailability();var v=i.channel('NotesEvents'),N=function(){w.reload(),t._adjustEditorBottomPadding(),t._notifyOnSizeChanged();};if(this.subscribeTo(v,'onUnorderedListClick',this.onUnorderedListClick.bind(this)),this.subscribeTo(v,'onTagAdded',N),this.subscribeTo(v,'onTagUpdated',N),this.subscribeTo(v,'onTagRemoved',N),this.subscribeTo(v,'onTagFormActivated',function(){t._closeFloatAreas('TagButton');}),this.subscribeTo(v,'onTagFormClosed',function(){setTimeout(function(){t._focusOnEditor();},100);}),this.hasChildControlByName('TagButton'))this.getChildControlByName('TagButton')._options.note=s;this._dom.window.on('touchstart'+this._eventNamespace,function(){t._closeFloatAreas();}),this._dom.titlebar.on('focus',false),this._dom.footer.on('mousedown focus',false),this._dom.footerText.on('mousedown focus',false),this._dom.titlebar.on('mousedown'+this._eventNamespace+' touchstart'+this._eventNamespace,function(){t._isBeingDragged=true;}),this._dom.titlebar.on('mouseup'+this._eventNamespace+' touchend'+this._eventNamespace,function(){t._isBeingDragged=false;});},_onEditorResize:function(){if(this._colorPanelIsOpened||this._isBeingDragged||!this._dom)return;if(this._doNotResize)return void this._adjustEditorBottomPadding();if(this._handleResize){if(!this._wasManualResizing){this._dom.scroll.css('height','');var t=this._lastHeight!==this._dom.window.height(),e=new Date().getTime()-this._domChanged<400;if(t&&!e)this._wasManualResizing=true,this._dom.scrollContent.find('.ws-noteDialog-text').css('min-height','');}this._adjustEditorBottomPadding();}else{if(n.browser.isMobilePlatform)this._dom.scrollContent.css({height:'100%'}),this._doNotResize=true;else this._dom.scroll.css({height:'auto'});i.channel('NotesEvents').notify('onEditorResize',{width:this._dom.window.width(),height:'auto'});}},_onUploadActivated:function(){this._closeFloatAreas('UploadButton');},_onPinActivated:function(){this._closeFloatAreas('Pin');},_onPinPropertyChanged:function(t,e){if('status'===e)i.channel('NoteCommands').notify('Pin',this._options.note,this._controls.pin.getProperty('status'));},_initEditorData:function(){var t=this;if(this._controls.content.setText(m(this._options.note.text)),!this._dom.editorFrame.length)this._dom.editorFrame=this._controls.content.getContainer().find('.controls-RichEditor__editorFrame');setTimeout(function(){this._tinymce=this._controls.content.getTinyEditor(),this._options.note.undecoratedContent=this._tinymce.getContent(),this._tinymce.on('keydown',function(e){if(e.keyCode===n.key.backspace||e.keyCode===n.key.del){var o=t._tinymce.selection.getRng().startContainer;if(null!=o&&'LI'===o.tagName&&(''===o.innerHTML||'<br>'===o.innerHTML||'<br data-mce-bogus="1">'===o.innerHTML)){var i=o.nextElementSibling;if(i){if($(i).hasClass('ws-note__checkable_unchecked'))$(o).addClass('ws-note__checkable_unchecked').removeClass('ws-note__checkable_checked');if($(i).hasClass('ws-note__checkable_checked'))$(o).addClass('ws-note__checkable_checked').removeClass('ws-note__checkable_unchecked');}}}},true);}.bind(this),200);},destroy:function(){if(k.superclass.destroy.call(this),n.$win.off(this._eventNamespace),$('.ws-window-overlay').off('mouseover'),$('.ws-note-overlay_unselectable').siblings().off('selectstart'),this._controls.content.getContainer().off(this._eventNamespace),this._options.note=null,this._dom.titlebar.off(this._eventNamespace),this._dom.window.off(this._eventNamespace),this._uploader)this._uploader.destroy(),this._uploader=null;this._options=this._tinymce=this._dom=this._controls=null,this.getContainer().off(this._eventNamespace),this.enableSelection('.ws-window-titlebar-custom, .ws-window-titlebar-custom *,.ws-window-overlay,.ws-note-date-html,.ws-note-dialog-shadow,.ws-note-dialog__footer');},_onRemoveCalendar:function(){this.updateNotification(null);},_onReady:function(){var t=this;this._dom.editorFrame.attr({autocorrect:'off',autocapitalize:'off',autocomplete:'off'}),this._focusOnEditor(),this.getChildControls().forEach(function(e){t.subscribeTo(e,'onActivated',function(){t.disableSelection('.controls-Menu,.controls-Menu *');});});},_onBeforeShow:function(){if(this._dom.window.addClass('ws-noteDialog-container_transparent'),this._options.noteElement)this._options.noteElement.removeClass('ws-note_blocked');var t=this.getContainer();this._dom.window.append(t.find('.ws-note-shadow'));},_onAfterShow:function(){var t=this;$('body').addClass('ws-note-openedDialog'),$('.ws-window-overlay').addClass('ws-note-overlay_unselectable').on('mouseover',function(t){t.stopPropagation();}),$('.ws-note-overlay_unselectable').siblings(':not(.engine-ClipboardNative-copy)').addClass('ws-note__disable_selection').find().attr('unselectable','on').on('selectstart',false),this._initEditorData(),this._adjustEditorBottomPadding(),i.channel('NotesEvents').notify('onEditorResize',{width:this._dom.window.width(),height:'auto'});var e=this._options.noteElement;if(e)e.addClass('ws-note_animated').css('z-index',999),e.css({transition:'all 0.5s',opacity:0});if(this.getChildControlByName('noteContent').setActive(true),n.browser.isMobilePlatform)this._controls.ok.setActive(true);setTimeout(function(){if(t._handleResize=true,n.browser.isMobilePlatform)t._dom.scroll.css('height',t._dom.scroll.height()),t._wasManualResizing=true;},1000),t._dom.window.css({transition:'opacity 0.6s',opacity:1});},_onBeforeUnload:function(t){var e=rk('Вы не закончили редактирование заметки, все несохранённые данные будут потеряны.');if(t=t||window.event,t)t.returnValue=e;return e;},_onUnload:function(){if(this._options.note.baseId)if(!this._options.note.hasContent())r.postRequestCall('Note.DeleteNotes',{Id:[this._options.note.baseId]});else if(this._options.isLocked)r.postRequestCall('Note.UnlockNote',{NoteId:this._options.note.baseId});else r.postRequestCall('Note.UpdateNote',{Id:this._options.note.baseId,Content:this._options.note.text,Settings:null,Order:null,Text:$('<div>').html(this._options.note.text).text().replace(/\n/g,' '),Color:this._options.note.color,UpdateModifyDate:true});},_checkNotificationServiceAvailability:function(){var t=this;if(null==k._notificationAvailabilityErrors)r.getAvailableNotificationTypes().addCallback(function(e){if(k._notificationAvailabilityErrors=e,t._setNotificationButtonAvailability(e))i.channel('NotesEvents').notify('onNotificationServiceAvailable');});else this._setNotificationButtonAvailability(k._notificationAvailabilityErrors);},_setNotificationButtonAvailability:function(t){if(this.hasChildControlByName('Notification')){var o=this.getChildControlByName('Notification'),i=e(t,function(t){return!t;})>=0;return o.setEnabled(i),o.setTooltip(i?rk('Добавить напоминание'):t[0]),i;}else return false;},_adjustEditorBottomPadding:function(){if(!this._dom)return;var t=70,e=32,o=8,i=this._dom.footer.height(),s=this._dom.footerFiles.height();if(i>e&&s<=0)i+=o;if(this._wasManualResizing&&i>(this._dom.window.height()-_)/2)i=(this._dom.window.height()-_)/2;else if(this._handleResize&&this._dom.window.height()-_-i<t&&this._options.note.text.length)i=this._dom.window.height()-_-t;var a=this._dom.window.height()-_-i,r=n.$win.height()-_-i,l=this.getContainer().css('padding-bottom');if(this.getContainer().css('padding-bottom',i),this._dom.scrollFooter.css({minHeight:'',height:i}),this._dom.scroll.css({maxHeight:r}),this._dom.scroll.attr('style').indexOf('auto')<0||this._dom.editorFrame[0]&&this._dom.editorFrame[0].style&&this._dom.editorFrame[0].style.height)if(this._dom.scroll.css('min-height',''),this._wasManualResizing)this._dom.scroll.css('height',a);if(parseInt(l)!==i||this._lastHeight!==this._dom.window.height())this._notifyOnSizeChanged();this._lastHeight=this._dom.window.height();},_onColorMenuActivate:function(t){var e=this;this._colorPanelIsOpened=true,this._closeFloatAreas('Colorize'),require(['SBIS3.CONTROLS/StylesPanelNew'],function(o){if(!e._stylePanel)e._stylePanel=new o({parent:t.getTarget(),target:t.getTarget().getContainer(),corner:'tl',element:$('<div></div>'),name:'StylesPanelNew',activableByClick:false,paletteRenderStyle:true,columnsCount:1,autoCloseOnHide:true,verticalAlign:{side:'top',offset:-6},horizontalAlign:{side:'left',offset:-6},colors:u.map(function(t){return{color:t};}),style:{color:u[e._options.note.color]},handlers:{changeFormat:function(t,o){var i=u.indexOf(this.getJSONStyle().color);if(i<0)i=0;e.changeColor(i),e._focusOnEditor();},onClose:function(){if(this.isVisible())setTimeout(function(){e._colorPanelIsOpened=false;},200);},onDestroy:function(){setTimeout(function(){e._focusOnEditor();},100);}}});else e._stylePanel.setStylesFromObject({color:u[e._options.note.color]});e._stylePanel.show();});},_onFileUpload:function(t,e){var o=this;this._focusOnEditor(),this._options.note.create(),this._options.note.addFile(e).addCallbacks(function(){o._controls.files.reload(),o._adjustEditorBottomPadding();},function(t){require(['WS.Data/Source/SbisService','SBIS3.CONTROLS/Utils/InformationPopupManager'],function(o,i){new o({endpoint:{contract:'FileSD',address:'/disk/api/v1/service/'}}).call('DeleteExt',{Ids:[e.id]}).addErrback(function(){}),i.showMessageDialog({message:rk('Не удалось загрузить файл'),details:t.message||t.details,status:'error'});});});},_triggerInputChange:function(){this._controls.content._setText(this._controls.content._getTinyEditorValue());},_focusOnEditor:function(){if(this._tinymce&&!n.browser.isMobileIOS)this._tinymce.focus();},_execEditorCommand:function(t){if(this._tinymce)this._focusOnEditor(),this._tinymce.execCommand(t);},_triggerEditorButton:function(t,e){e.originalEvent.ClickEventIsReady=false,this._controls.content.getToolbarItem(t).getContainer().trigger(e);},_onCheckClick:function(){var t=this._controls.toolbar.getLinkedEditor().getTinyEditor(),e=t.selection,o,i=b(e),n=v(e),s,a=null;if(this._closeFloatAreas(),n)a=e.getRng();else p(e);if(s=C(e),!s||i)this._execEditorCommand('InsertUnorderedList');else if(s){var r=w(e);this._execEditorCommand('UL'===r?'InsertUnorderedList':'InsertOrderedList'),this._execEditorCommand('InsertUnorderedList');}if(o=$(e.getSelectedBlocks().filter(function(t){return'UL'!==t.tagName&&'OL'!==t.tagName;})),i)N(o);else if(C(e))if(this._tinymce.undoManager.data.pop(),o.addClass('ws-note__checkable ws-note__checkable_unchecked'),a&&s&&n)this._setRng(t,e,a);this._triggerInputChange(),this._togglePlaceholder();},_togglePlaceholder:function(t){var e=$('.ws-noteDialog .controls-RichEditor__Placeholder');if(t)e.removeClass('ws-hidden');else if($(this._tinymce.getBody()).html().indexOf('ul')>0)e.addClass('ws-hidden');else e.removeClass('ws-hidden');},_setRng:function(t,e,o){e.setRng(o),e.select(),t.focus();},_hasContent:function(){return!!this._tinymce.getContent()||!!this._dom.editorFrame.find('ul, .ws-note__checkable').length;},onUnorderedListClick:function(t,e){var o=this._controls.toolbar.getLinkedEditor().getTinyEditor(),i=o.selection,n=$(i.getSelectedBlocks()),s=b(i),a=v(i),r=null,l=N(n);if(this._closeFloatAreas(),a){if(s)r=i.getRng();}else p(i);var c=false;if('UL'==w(i)&&'InsertOrderedList'==e)c=l=true;if(C(i)&&(s||c)){if(l)this._execEditorCommand('InsertUnorderedList'),this._execEditorCommand(e);}else this._execEditorCommand(e);if(r&&s&&a)this._setRng(o,i,r);this._togglePlaceholder();},_onUnorderedListClick:function(t,e){i.channel('NotesEvents').notify('onUnorderedListClick',e);},_onNotificationActivated:function(){var e=this;this._closeFloatAreas('Notification'),t.showFloatArea({parent:this._controls.notification,opener:this._controls.notification,template:'js!SBIS3.Notes.Notification',target:this._controls.notification.getContainer(),offset:{y:-4},autoCloseOnHide:true,activableByClick:false,componentOptions:{cron:this._options.note.cron||null,method:this._options.note.notificationMethod||null,time:this._options.note.calendar||null,activableByClick:false,availabilityErrors:k._notificationAvailabilityErrors},handlers:{onAfterClose:function(t,o){if(e._notifcationForm=null,false===o)e.updateNotification(null);else if(null!=o)e.updateNotification(o.time,o.method,null,o.cron,null);}}}).addCallback(function(t){e._notificationForm=t;});},_changeNote:function(t,e){var o=this._options.note;if(o[t]!==e)o[t]=e,o.create();},_onTextChange:function(t,e){this._togglePlaceholder(true),this._changeNote('text',e);},changeColor:function(t){var e=this._options.note;this._dom.window.removeClass('ws-note_color-'+e.color).addClass('ws-note_color-'+(e.color=t));},updateNotification:function(t,e,o,i,n){var s=this._options.note,a=this;s.setCalendar(t,e,o,i,n).addCallback(function(){if(a._dom&&a._dom.footerText&&a._dom.calendarRemove)a._dom.footerText.text(s.title||'').toggleClass('ws-hidden',!s.title),a._dom.calendarRemove.toggleClass('ws-hidden',!s.title);});},getContent:function t(){return(this._tinymce?this._tinymce.getContent():'').replace(/data-(min-height:\s*\d+(\.\d+)?px;)/gi,'$1');},_onSaveButtonActivated:function(){this.sendCommand('close','save');},_onCloseButtonActivated:function(){this.sendCommand('close');},disableSelection:function(t){$(t).attr('unselectable','on').on('selectstart',false);},enableSelection:function(t){$(t).removeAttr('unselectable').off('selectstart'),$('.ws-window-overlay').removeClass('ws-note-overlay_unselectable'),$('.ws-note__disable_selection').removeClass('ws-note__disable_selection').find('[unselectable]').removeAttr('unselectable').off('selectstart');},_onRemoveButtonActivated:function(){var t=this;if(this._closeFloatAreas(),this.getProperty('note').hasContent())require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(e){e.showConfirmDialog({message:rk('Удалить заметку?')},function(){t.close('remove');});});else t.close('remove');},_closeFloatAreas:function(t){if('TagButton'!==t&&this.hasChildControlByName('TagButton')){var e=this.getChildControlByName('TagButton');if(e)e.closeForm();}if('Notification'!==t&&this._notificationForm)this._notificationForm.close();if('FontStyle'!==t)this._controls.styles.hide();if('UnorderedList'!==t&&this._controls.list)this._controls.list.hide();},close:function(t){this._closeFloatAreas(),this.unsubscribeFrom(l.serverChannel('notes.userchanged'),'NoteChanged'),this.unsubscribeFrom(l.serverChannel('notes.userchanged'),'NoteDeleted'),this.sendCommand('close',t);},prepareTextForSaving:function(t){var e=0,o=this._dom.editorFrame.find('img');return t=t.replace(/^(\n?<p>&nbsp;<\/p>)*/im,'').replace(/<li class="ws-note__checkable ws-note__checkable_(un)?checked"><\/li>/gi,'').replace(/display:\s?none/gi,'').replace(/<img[^>]+>/gi,function t(i){var n=o.eq(e++),s=n.width(),a=n.height();return i=$(i).css({width:s,height:a}).attr({'data-original-width':s,'data-original-height':a})[0].outerHTML,i;}),t.replace(/^(\n|\r\n)*/m,'');},_onResize:function(t){var e=150,o=this._dom.footer[0].scrollHeight,i=t-_-o;if(this._dom.scroll.css({height:Math.max(i,e),minHeight:'',maxHeight:Math.max(i,e)}),i<e)o-=e-i,this._dom.scrollFooter.height(o);else this._dom.scrollFooter.height('');this.getContainer().css('padding-bottom',o);},_validateClass:function(t){if('ws-note__checkable'===t||'ws-note__checkable_checked'===t||'ws-note__checkable_unchecked'===t)return true;return false;}});return k;});define('tmpl!SBIS3.Notes.ExtendedHider/ExtendedHiderContent',['Core/tmpl/js/tclosure','Zametki_localization'],function(){var e=Array.prototype.slice.call(arguments),t=e[0],i={},r=function e(r,a,s,n,o){function c(){}var l=0,d=void 0!==t&&t?t:arguments[arguments.length-1];void 0===d&&(eval('var thelpers = null;'),d=global.requirejs('View/Runner/tclosure'));var p={};o&&o.isSetts&&(p=o.fullContext||{});var g='string'==typeof s?s:'',f=void 0===i?void 0:i,u={id:[],def:void 0},m=d.configResolver.calcParent(this,'undefined'==typeof currentPropertyName?void 0:currentPropertyName,r),v=this&&this.includedTemplates?this.includedTemplates:{},h=d.getMarkupGenerator(n);try{var T=h.joinElements([h.createTag('span',{class:'ws-note__item ws-note_color-'+d.wrapUndef(d.utils.escape(d.getter(r,['item','color'])))},[h.createTag('span',{class:'ws-note__item-text'},[h.createTag('div',{class:'ws-note__content'},[h.createTag('div',{class:'ws-basic-style'},[h.createText(''+d.wrapUndef(d.Sanitize.apply(void 0,[d.getDecorators().sanitize.apply(void 0,[d.getter(r,['item','text'])])])))],{},u,this)],{},u,this),d.getDecorators().isArray.apply(void 0,[d.getter(r,['item','files'])])?[d.getter(r,['item','files','length'])>0?[h.createTag('span',{class:'ws-note__item-footer'},[h.createTag('span',{class:'icon-16 icon-Attach icon-disabled'},[],{},u,this),h.createTag('span',{class:'ws-note__item-files'},[function(){for(var e=void 0,t=0;t<d.iterators.length&&!e;t++)d.iterators[t].is(d.utils.escape(d.getter(r,['item','files','length'])))&&(e=d.iterators[t].iterator);var i=[];return function(){var t=d.createScope(r);if(r=t,e){var a=s,o=0;e(d.utils.escape(d.getter(r,['item','files','length'])),function(e,t){d.presetScope(e,r,t,{value:'file'}),s&&void 0!==n&&n&&(s=a+'-for_'+o,o++);var c=[h.createTag('span',{},[h.createText(''+d.wrapUndef(d.utils.escape(d.getter(r,['item','files',d.getter(r,['i']),'title']))))],{},u,this),d.getter(r,['i'])<d.getter(r,['item','files','length'])-1?[h.createText(''+global.rk(','))]:h.createText('')];void 0===c[0]&&void 0!==n&&n||(i=i.concat(c));}.bind(r));}else i='';}.call(r),i;}()],{},u,this)],{},u,this)]:h.createText('')]:[0!=d.getter(r,['item','files','getCount']).apply(d.getter(r,['item','files']),[])?[h.createTag('span',{class:'ws-note__item-footer'},[h.createTag('span',{class:'icon-16 icon-Attach icon-disabled'},[],{},u,this),h.createTag('span',{class:'ws-note__item-files'},[function(){for(var e=void 0,t=0;t<d.iterators.length&&!e;t++)d.iterators[t].is(d.utils.escape(d.getter(r,['item','files','getCount']).apply(d.getter(r,['item','files']),[])))&&(e=d.iterators[t].iterator);var i=[];return function(){var t=d.createScope(r);if(r=t,e){var a=s,o=0;e(d.utils.escape(d.getter(r,['item','files','getCount']).apply(d.getter(r,['item','files']),[])),function(e,t){d.presetScope(e,r,t,{value:'i'}),s&&void 0!==n&&n&&(s=a+'-for_'+o,o++);var c=[h.createTag('span',{},[h.createText(''+d.wrapUndef(d.utils.escape(d.getter(d.getter(r,['item','files','at']).apply(d.getter(r,['item','files']),[d.getter(r,['i'])]),['title']))))],{},u,this),d.getter(r,['i'])<d.getter(r,['item','files','getCount']).apply(d.getter(r,['item','files']),[])-1?[h.createText(''+global.rk(','))]:h.createText('')];void 0===c[0]&&void 0!==n&&n||(i=i.concat(c));}.bind(r));}else i='';}.call(r),i;}()],{},u,this)],{},u,this)]:h.createText('')]],{},u,this),h.createTag('span',{class:'ws-note__item-date'},[h.createText(''+d.wrapUndef(d.utils.escape(d.getter(r,['item','prettyModified'])||d.getter(r,['item','prettyCreationDate']))))],{},u,this),h.createTag('span',{class:'ws-note__item-icon'},[1==d.getter(r,['item','isHidden'])?[h.createTag('div',{class:'icon-24 icon-PinNull icon-primary'},[],{},u,this)]:h.createText('')],{},u,this)],a,u,this)],g,u);u.def&&(T=h.chain(T,u,a),u=void 0);}catch(e){d.templateError('resources/Zametki/Hider/ExtendedHiderContent.tmpl',e,r);}return T||'';};return r.includedFunctions={},r.stable=!0,r.toJSON=function(){return{$serialized$:'func',module:'tmpl!SBIS3.Notes.ExtendedHider/ExtendedHiderContent'};},r;});define('tmpl!SBIS3.Notes.ExtendedHider',['Core/tmpl/js/tclosure','js!SBIS3.CONTROLS/Button/IconButton','js!SBIS3.CONTROLS/Button','js!SBIS3.CONTROLS/Link','js!SBIS3.CONTROLS/ScrollContainer','js!SBIS3.CONTROLS/ListView','tmpl!SBIS3.Notes.ExtendedHider/ExtendedHiderContent','Zametki_localization'],function(){var e=Array.prototype.slice.call(arguments),t=e[0],o={};o['js!SBIS3.CONTROLS/Button/IconButton']=e[1],o['js!SBIS3.CONTROLS/Button']=e[2],o['js!SBIS3.CONTROLS/Link']=e[3],o['js!SBIS3.CONTROLS/ScrollContainer']=e[4],o['js!SBIS3.CONTROLS/ListView']=e[5],o['tmpl!SBIS3.Notes.ExtendedHider/ExtendedHiderContent']=e[6];var r=function e(r,n,i,a,s){function l(){}var c=0,d=void 0!==t&&t?t:arguments[arguments.length-1];void 0===d&&(eval('var thelpers = null;'),d=global.requirejs('View/Runner/tclosure'));var u={};s&&s.isSetts&&(u=s.fullContext||{});var m='string'==typeof i?i:'',p=void 0===o?void 0:o,S={id:[],def:void 0},v=d.configResolver.calcParent(this,'undefined'==typeof currentPropertyName?void 0:currentPropertyName,r),N=this&&this.includedTemplates?this.includedTemplates:{},C=d.getMarkupGenerator(a);try{var f=C.joinElements([C.createTag('div',{},[C.createTag('div',{class:'ws-note__extHider_header'},[C.createTag('div',{class:'ws-note__extHider_title'},[C.createText(''+global.rk('Заметки'))],{},S,this),C.createControl('wsControl','ws:SBIS3.CONTROLS/Button/IconButton',{name:'addNote',icon:'icon-16 icon-primary icon-AddButtonNew',className:'ws-note__add-note controls-IconButton__round-border-24',tooltip:global.rk('Создать заметку')},{name:'addNote',sbisname:'addNote'},{data:r,ctx:this,pName:'undefined'!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v},i,p,N,d.config,u),C.createControl('wsControl','ws:SBIS3.CONTROLS/Button/IconButton',{name:'close',className:'ws-note__close controls-PopupMixin__closeButton',tooltip:global.rk('Закрыть'),activableByClick:!1},{name:'close',sbisname:'close'},{data:r,ctx:this,pName:'undefined'!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v},i,p,N,d.config,u),C.createControl('wsControl','ws:SBIS3.CONTROLS/Button',{name:'showNotes',className:'ws-note__show-notes',caption:global.rk('Показать все'),tooltip:global.rk('Показать все'),activableByClick:!1},{name:'showNotes',sbisname:'showNotes'},{data:r,ctx:this,pName:'undefined'!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v},i,p,N,d.config,u),C.createControl('wsControl','ws:SBIS3.CONTROLS/Link',{name:'hideNotes',className:'ws-note__hide-notes',caption:global.rk('Скрыть все'),tooltip:global.rk('Скрыть все'),activableByClick:!1},{name:'hideNotes',sbisname:'hideNotes'},{data:r,ctx:this,pName:'undefined'!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v},i,p,N,d.config,u)],{},S,this),C.createControl('wsControl','ws:SBIS3.CONTROLS/ScrollContainer',{content:d.createDataArray([new function(){var e=Object.create(r),t=function e(t,o,r,n,i){if(void 0===r)var r=arguments[2];var a=0,s='content';if(void 0===d&&(eval('var thelpers = null;'),d=global.requirejs('View/Runner/tclosure')),i&&i.isSetts)var l=i.fullContext||{};t=d.isolateScope(Object.create(this),t,s);var c='string'==typeof r?r:'',u={id:[],def:void 0},m=this&&this.includedTemplates?this.includedTemplates:{},S=d.getMarkupGenerator(n);try{var N=S.joinElements([S.createControl('wsControl','ws:SBIS3.CONTROLS/ListView',{itemContentTpl:d.createDataArray([new function(){var e=Object.create(t),o=function e(t,o,r,n,i){if(void 0===r)var r=arguments[2];var a=0,s='itemContentTpl';if(void 0===d&&(eval('var thelpers = null;'),d=global.requirejs('View/Runner/tclosure')),i&&i.isSetts)var l=i.fullContext||{};t=d.isolateScope(Object.create(this),t,s);var c='string'==typeof r?r:'',u={id:[],def:void 0},m=this&&this.includedTemplates?this.includedTemplates:{},S=d.getMarkupGenerator(n);try{var N=S.joinElements([S.createControl('template','tmpl!SBIS3.Notes.ExtendedHider/ExtendedHiderContent',{item:d.getter(t,['itemContentTpl','item'])},{},{data:t,ctx:this,pName:void 0!==s?s:void 0,viewController:v},n?r+'part_'+a++ +'_':r,p,m,d.config,l)],c,u);u.def&&(N=S.chain(N,u,o),u=void 0);}catch(e){d.templateError('resources/Zametki/Hider/Extended.tmpl',e,t);}return N||'';};this.func=d.makeFunctionSerializable(o,e);}().func]),name:'hiderNotesList',className:'ws-note__hider-notes',idProperty:'id',multiselect:!1,itemsDragNDrop:!1,esc:!1},d.plainMerge(o,{name:'hiderNotesList',sbisname:'hiderNotesList'}),{data:t,ctx:this,pName:void 0!==s?s:void 0,viewController:v,internal:{__dirtyCheckingVars_0:d.getter(t,['itemContentTpl','item'])}},r,p,m,d.config,l)],c,u);u.def&&(N=S.chain(N,u,o),u=void 0);}catch(e){d.templateError('resources/Zametki/Hider/Extended.tmpl',e,t);}return N||'';};this.func=d.makeFunctionSerializable(t,e);}().func]),esc:!1},{},{data:r,ctx:this,pName:'undefined'!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v,internal:{__dirtyCheckingVars_0:d.getter(r,['itemContentTpl','item'])}},i,p,N,d.config,u)],n,S,this)],m,S);S.def&&(f=C.chain(f,S,n),S=void 0);}catch(e){d.templateError('resources/Zametki/Hider/Extended.tmpl',e,r);}return f||'';};return r.includedFunctions={},r.stable=!0,r.toJSON=function(){return{$serialized$:'func',module:'tmpl!SBIS3.Notes.ExtendedHider'};},r;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.ExtendedHider',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-note__extHider-form{background-color:#fffbe4;-webkit-box-shadow:0 0 10px 0 rgba(0,0,0,.75);-moz-box-shadow:0 0 10px 0 rgba(0,0,0,.75);box-shadow:0 0 10px 0 rgba(0,0,0,.75);height:auto}.ws-note__extHider-form>div{width:400px;height:auto;max-height:500px;min-height:44px}.ws-note__extHider_header{height:44px}.ws-note__extHider_title{color:#000;font-size:18px;font-weight:700;display:inline-block;margin:9px 10px 0 12px}.ws-note__add-note{margin-top:-4px}.ws-note__extHider-form .ws-note__hide-notes{float:right;margin-top:10px;margin-right:12px}.ws-note__extHider-form .ws-note__close{float:right;margin-top:0;margin-right:0;font-size:23px;font-family:cbuc-icons}.ws-note__show-notes{float:right;margin-top:10px;margin-right:10px}.ws-note__item{border-top:1px solid #eaeaea;min-height:48px;box-sizing:border-box;padding:8px 12px 0 12px;cursor:pointer;display:flex;align-items:flex-start}.ws-note__item-text{width:292px;padding-bottom:8px;word-wrap:break-word}.ws-note__item-text .ws-basic-style li,.ws-note__item-text .ws-basic-style>p{margin-bottom:0}.ws-note__item-text .ws-basic-style .ws-note__checkable,.ws-note__item-text .ws-basic-style li,.ws-note__item-text .ws-basic-style p{word-wrap:break-word;line-height:140%}.ws-note__item-date{padding-top:0;width:90px;text-align:right;font-size:12px;color:#999}.ws-note__item-footer{display:block;font-size:13px;text-overflow:ellipsis;white-space:nowrap;font-size:13px;color:#999;overflow:hidden}.ws-note__item-files{padding-left:2px;color:#999}.ws-note__item-files>span:hover{text-decoration:underline}.ws-note__extHider-form .controls-ScrollContainer{height:100%;max-height:450px}.ws-note__item-icon{position:absolute;bottom:3px;right:10px;height:24px;overflow:hidden}.ws-note__extHider-form .controls-ItemsToolbar{height:24px;overflow:hidden}.ws-note__extHider-form .controls-ItemsToolbar{background:0 0!important}.ws-note__extHider-form .controls-ScrollContainer.controls-ScrollContainer__bottom-gradient:after{display:block}.ws-note__hider-notes.controls-ListView__dataNotLoaded:not(.ws-sticky-header__table-header-copy){min-height:60px}.ws-note__item-text .ws-note__content{max-height:200px;overflow:hidden}.ws-note__extHider-form .ws-note_color-0{background:#fffbe4}.ws-note__extHider-form .ws-note_color-0:hover{background:#fff7c2}.ws-note__extHider-form .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(255,251,228,0) 0,rgba(255,251,228,.1) 15%,rgba(255,251,228,.5) 30%,rgba(255,251,228,.99) 70%,rgba(255,251,228,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(255,251,228,0)),color-stop(15%,rgba(255,251,228,.1)),color-stop(30%,rgba(255,251,228,.5)),color-stop(70%,rgba(255,251,228,.99)),color-stop(100%,rgba(255,251,228,1)));background:-webkit-linear-gradient(top,rgba(255,251,228,0) 0,rgba(255,251,228,.1) 15%,rgba(255,251,228,.5) 30%,rgba(255,251,228,.99) 70%,rgba(255,251,228,1) 100%);background:-o-linear-gradient(top,rgba(255,251,228,0) 0,rgba(255,251,228,.1) 15%,rgba(255,251,228,.5) 30%,rgba(255,251,228,.99) 70%,rgba(255,251,228,1) 100%);background:-ms-linear-gradient(top,rgba(255,251,228,0) 0,rgba(255,251,228,.1) 15%,rgba(255,251,228,.5) 30%,rgba(255,251,228,.99) 70%,rgba(255,251,228,1) 100%);background:linear-gradient(to bottom,rgba(255,251,228,0) 0,rgba(255,251,228,.1) 15%,rgba(255,251,228,.5) 30%,rgba(255,251,228,.99) 70%,rgba(255,251,228,1) 100%);top:178px;height:31px;position:absolute;content:\'\';width:100%;display:block}.ws-note__extHider-form .ws-note__item:hover .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(255,247,194,0) 0,rgba(255,247,194,.1) 15%,rgba(255,247,194,.5) 30%,rgba(255,247,194,.99) 70%,rgba(255,247,194,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(255,247,194,0)),color-stop(15%,rgba(255,247,194,.1)),color-stop(30%,rgba(255,247,194,.5)),color-stop(70%,rgba(255,247,194,.99)),color-stop(100%,rgba(255,247,194,1)));background:-webkit-linear-gradient(top,rgba(255,247,194,0) 0,rgba(255,247,194,.1) 15%,rgba(255,247,194,.5) 30%,rgba(255,247,194,.99) 70%,rgba(255,247,194,1) 100%);background:-o-linear-gradient(top,rgba(255,247,194,0) 0,rgba(255,247,194,.1) 15%,rgba(255,247,194,.5) 30%,rgba(255,247,194,.99) 70%,rgba(255,247,194,1) 100%);background:-ms-linear-gradient(top,rgba(255,247,194,0) 0,rgba(255,247,194,.1) 15%,rgba(255,247,194,.5) 30%,rgba(255,247,194,.99) 70%,rgba(255,247,194,1) 100%);background:linear-gradient(to bottom,rgba(255,247,194,0) 0,rgba(255,247,194,.1) 15%,rgba(255,247,194,.5) 30%,rgba(255,247,194,.99) 70%,rgba(255,247,194,1) 100%);top:178px;height:31px;position:absolute;content:\'\';width:100%;display:block}.ws-note__extHider-form .ws-note_color-1{background:#e8fdc4}.ws-note__extHider-form .ws-note_color-1:hover{background:#defcab}.ws-note__extHider-form .ws-note_color-1 .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(232,253,196,0) 0,rgba(232,253,196,.1) 15%,rgba(232,253,196,.5) 30%,rgba(232,253,196,.99) 70%,rgba(232,253,196,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(232,253,196,0)),color-stop(15%,rgba(232,253,196,.05)),color-stop(50%,rgba(232,253,196,.5)),color-stop(80%,rgba(232,253,196,.99)),color-stop(100%,rgba(232,253,196,1)));background:-webkit-linear-gradient(top,rgba(232,253,196,0) 0,rgba(232,253,196,.1) 15%,rgba(232,253,196,.5) 30%,rgba(232,253,196,.99) 70%,rgba(232,253,196,1) 100%);background:-o-linear-gradient(top,rgba(232,253,196,0) 0,rgba(232,253,196,.1) 15%,rgba(232,253,196,.5) 30%,rgba(232,253,196,.99) 70%,rgba(232,253,196,1) 100%);background:-ms-linear-gradient(top,rgba(232,253,196,0) 0,rgba(232,253,196,.1) 15%,rgba(232,253,196,.5) 30%,rgba(232,253,196,.99) 70%,rgba(232,253,196,1) 100%);background:linear-gradient(to bottom,rgba(232,253,196,0) 0,rgba(232,253,196,.1) 15%,rgba(232,253,196,.5) 30%,rgba(232,253,196,.99) 70%,rgba(232,253,196,1) 100%)}.ws-note__extHider-form .ws-note_color-1.ws-note__item:hover .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(222,252,171,0) 0,rgba(222,252,171,.1) 15%,rgba(222,252,171,.5) 30%,rgba(222,252,171,.99) 70%,rgba(222,252,171,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(222,252,171,0)),color-stop(15%,rgba(222,252,171,.05)),color-stop(50%,rgba(222,252,171,.5)),color-stop(80%,rgba(222,252,171,.99)),color-stop(100%,rgba(222,252,171,1)));background:-webkit-linear-gradient(top,rgba(222,252,171,0) 0,rgba(222,252,171,.1) 15%,rgba(222,252,171,.5) 30%,rgba(222,252,171,.99) 70%,rgba(222,252,171,1) 100%);background:-o-linear-gradient(top,rgba(222,252,171,0) 0,rgba(222,252,171,.1) 15%,rgba(222,252,171,.5) 30%,rgba(222,252,171,.99) 70%,rgba(222,252,171,1) 100%);background:-ms-linear-gradient(top,rgba(222,252,171,0) 0,rgba(222,252,171,.1) 15%,rgba(222,252,171,.5) 30%,rgba(222,252,171,.99) 70%,rgba(222,252,171,1) 100%);background:linear-gradient(to bottom,rgba(222,252,171,0) 0,rgba(222,252,171,.1) 15%,rgba(222,252,171,.5) 30%,rgba(222,252,171,.99) 70%,rgba(222,252,171,1) 100%)}.ws-note__extHider-form .ws-note_color-2{background:#ffe0cc}.ws-note__extHider-form .ws-note_color-2:hover{background:#ffd7bb}.ws-note__extHider-form .ws-note_color-2 .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(255,224,204,0) 0,rgba(255,224,204,.1) 15%,rgba(255,224,204,.5) 30%,rgba(255,224,204,.99) 70%,rgba(255,224,204,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(255,224,204,0)),color-stop(15%,rgba(255,224,204,.05)),color-stop(50%,rgba(255,224,204,.5)),color-stop(80%,rgba(255,224,204,.99)),color-stop(100%,rgba(255,224,204,1)));background:-webkit-linear-gradient(top,rgba(255,224,204,0) 0,rgba(255,224,204,.1) 15%,rgba(255,224,204,.5) 30%,rgba(255,224,204,.99) 70%,rgba(255,224,204,1) 100%);background:-o-linear-gradient(top,rgba(255,224,204,0) 0,rgba(255,224,204,.1) 15%,rgba(255,224,204,.5) 30%,rgba(255,224,204,.99) 70%,rgba(255,224,204,1) 100%);background:-ms-linear-gradient(top,rgba(255,224,204,0) 0,rgba(255,224,204,.1) 15%,rgba(255,224,204,.5) 30%,rgba(255,224,204,.99) 70%,rgba(255,224,204,1) 100%);background:linear-gradient(to bottom,rgba(255,224,204,0) 0,rgba(255,224,204,.1) 15%,rgba(255,224,204,.5) 30%,rgba(255,224,204,.99) 70%,rgba(255,224,204,1) 100%)}.ws-note__extHider-form .ws-note_color-2.ws-note__item:hover .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(255,215,187,0) 0,rgba(255,215,187,.1) 15%,rgba(255,215,187,.5) 30%,rgba(255,215,187,.99) 70%,rgba(255,215,187,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(255,215,187,0)),color-stop(15%,rgba(255,215,187,.05)),color-stop(50%,rgba(255,215,187,.5)),color-stop(80%,rgba(255,215,187,.99)),color-stop(100%,rgba(255,215,187,1)));background:-webkit-linear-gradient(top,rgba(255,215,187,0) 0,rgba(255,215,187,.1) 15%,rgba(255,215,187,.5) 30%,rgba(255,215,187,.99) 70%,rgba(255,215,187,1) 100%);background:-o-linear-gradient(top,rgba(255,215,187,0) 0,rgba(255,215,187,.1) 15%,rgba(255,215,187,.5) 30%,rgba(255,215,187,.99) 70%,rgba(255,215,187,1) 100%);background:-ms-linear-gradient(top,rgba(255,215,187,0) 0,rgba(255,215,187,.1) 15%,rgba(255,215,187,.5) 30%,rgba(255,215,187,.99) 70%,rgba(255,215,187,1) 100%);background:linear-gradient(to bottom,rgba(255,215,187,0) 0,rgba(255,215,187,.1) 15%,rgba(255,215,187,.5) 30%,rgba(255,215,187,.99) 70%,rgba(255,215,187,1) 100%)}.ws-note__extHider-form .ws-note_color-3{background:#f1e0f1}.ws-note__extHider-form .ws-note_color-3:hover{background:#ebd3eb}.ws-note__extHider-form .ws-note_color-3 .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(241,224,241,0) 0,rgba(241,224,241,.1) 15%,rgba(241,224,241,.5) 30%,rgba(241,224,241,.99) 70%,rgba(241,224,241,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(241,224,241,0)),color-stop(15%,rgba(241,224,241,.99)),color-stop(50%,rgba(241,224,241,.5)),color-stop(80%,rgba(241,224,241,.99)),color-stop(100%,rgba(241,224,241,1)));background:-webkit-linear-gradient(top,rgba(241,224,241,0) 0,rgba(241,224,241,.1) 15%,rgba(241,224,241,.5) 30%,rgba(241,224,241,.99) 70%,rgba(241,224,241,1) 100%);background:-o-linear-gradient(top,rgba(241,224,241,0) 0,rgba(241,224,241,.1) 15%,rgba(241,224,241,.5) 30%,rgba(241,224,241,.99) 70%,rgba(241,224,241,1) 100%);background:-ms-linear-gradient(top,rgba(241,224,241,0) 0,rgba(241,224,241,.1) 15%,rgba(241,224,241,.5) 30%,rgba(241,224,241,.99) 70%,rgba(241,224,241,1) 100%);background:linear-gradient(to bottom,rgba(241,224,241,0) 0,rgba(241,224,241,.1) 15%,rgba(241,224,241,.5) 30%,rgba(241,224,241,.99) 70%,rgba(241,224,241,1) 100%)}.ws-note__extHider-form .ws-note_color-3.ws-note__item:hover .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(235,211,235,0) 0,rgba(235,211,235,.1) 15%,rgba(235,211,235,.5) 30%,rgba(235,211,235,.99) 70%,rgba(235,211,235,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(235,211,235,0)),color-stop(15%,rgba(235,211,235,.99)),color-stop(50%,rgba(235,211,235,.5)),color-stop(80%,rgba(235,211,235,.99)),color-stop(100%,rgba(235,211,235,1)));background:-webkit-linear-gradient(top,rgba(235,211,235,0) 0,rgba(235,211,235,.1) 15%,rgba(235,211,235,.5) 30%,rgba(235,211,235,.99) 70%,rgba(235,211,235,1) 100%);background:-o-linear-gradient(top,rgba(235,211,235,0) 0,rgba(235,211,235,.1) 15%,rgba(235,211,235,.5) 30%,rgba(235,211,235,.99) 70%,rgba(235,211,235,1) 100%);background:-ms-linear-gradient(top,rgba(235,211,235,0) 0,rgba(235,211,235,.1) 15%,rgba(235,211,235,.5) 30%,rgba(235,211,235,.99) 70%,rgba(235,211,235,1) 100%);background:linear-gradient(to bottom,rgba(235,211,235,0) 0,rgba(235,211,235,.1) 15%,rgba(235,211,235,.5) 30%,rgba(235,211,235,.99) 70%,rgba(235,211,235,1) 100%)}.ws-note__extHider-form .ws-note_color-4{background:#d9f2ff}.ws-note__extHider-form .ws-note_color-4:hover{background:#c1eaff}.ws-note__extHider-form .ws-note_color-4 .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(217,242,255,0) 0,rgba(217,242,255,.1) 15%,rgba(217,242,255,.5) 30%,rgba(217,242,255,.99) 70%,rgba(217,242,255,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(217,242,255,0)),color-stop(15%,rgba(217,242,255,.05)),color-stop(50%,rgba(217,242,255,.5)),color-stop(80%,rgba(217,242,255,.99)),color-stop(100%,rgba(217,242,255,1)));background:-webkit-linear-gradient(top,rgba(217,242,255,0) 0,rgba(217,242,255,.1) 15%,rgba(217,242,255,.5) 30%,rgba(217,242,255,.99) 70%,rgba(217,242,255,1) 100%);background:-o-linear-gradient(top,rgba(217,242,255,0) 0,rgba(217,242,255,.1) 15%,rgba(217,242,255,.5) 30%,rgba(217,242,255,.99) 70%,rgba(217,242,255,1) 100%);background:-ms-linear-gradient(top,rgba(217,242,255,0) 0,rgba(217,242,255,.1) 15%,rgba(217,242,255,.5) 30%,rgba(217,242,255,.99) 70%,rgba(217,242,255,1) 100%);background:linear-gradient(to bottom,rgba(217,242,255,0) 0,rgba(217,242,255,.1) 15%,rgba(217,242,255,.5) 30%,rgba(217,242,255,.99) 70%,rgba(217,242,255,1) 100%)}.ws-note__extHider-form .ws-note_color-4.ws-note__item:hover .ws-note__content.ws-note__blur:after{background:-moz-linear-gradient(top,rgba(193,234,255,0) 0,rgba(193,234,255,.1) 15%,rgba(193,234,255,.5) 30%,rgba(193,234,255,.99) 70%,rgba(193,234,255,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(193,234,255,0)),color-stop(15%,rgba(193,234,255,.05)),color-stop(50%,rgba(193,234,255,.5)),color-stop(80%,rgba(193,234,255,.99)),color-stop(100%,rgba(193,234,255,1)));background:-webkit-linear-gradient(top,rgba(193,234,255,0) 0,rgba(193,234,255,.1) 15%,rgba(193,234,255,.5) 30%,rgba(193,234,255,.99) 70%,rgba(193,234,255,1) 100%);background:-o-linear-gradient(top,rgba(193,234,255,0) 0,rgba(193,234,255,.1) 15%,rgba(193,234,255,.5) 30%,rgba(193,234,255,.99) 70%,rgba(193,234,255,1) 100%);background:-ms-linear-gradient(top,rgba(193,234,255,0) 0,rgba(193,234,255,.1) 15%,rgba(193,234,255,.5) 30%,rgba(193,234,255,.99) 70%,rgba(193,234,255,1) 100%);background:linear-gradient(to bottom,rgba(193,234,255,0) 0,rgba(193,234,255,.1) 15%,rgba(193,234,255,.5) 30%,rgba(193,234,255,.99) 70%,rgba(193,234,255,1) 100%)}.ws-note__extHider-form .ws-note__content .ws-basic-style img:not(.LinkDecorator__image){max-width:100%!important;height:auto!important}'));head.appendChild(style);});}define('js!SBIS3.Notes.ExtendedHider',['SBIS3.CONTROLS/CompoundControl','Core/EventBus','Core/constants','tmpl!SBIS3.Notes.ExtendedHider','js!SBIS3.Notes.MenuColor','css!SBIS3.Notes.ExtendedHider','Zametki_localization','Zametki_localization'],function(t,e,o,n){'use strict';var i=t.extend({_dotTplFn:n,init:function(){i.superclass.init.call(this);var t=this,n=Math.round(0.7*o.$win.height()),s=this.getChildControlByName('addNote'),r=this.getChildControlByName('hideNotes'),c=this.getChildControlByName('showNotes'),a=this.getChildControlByName('hiderNotesList'),d=this.getChildControlByName('close');if(n>500)this.getContainer().css('max-height',n),this.getContainer().find('.controls-ScrollContainer').css('max-height',n-50);a.setItemsActions([{name:'delete',icon:'sprite:icon-16 icon-Erase icon-error',caption:rk('Удалить'),isMainAction:true,onActivated:function(t,o,n){require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(o){o.showConfirmDialog({message:rk('Удалить заметку?')},function(){e.channel('NoteCommands').notify('Remove',n.getRawData()),a.getContainer().find('.controls-ItemsToolbar').css('display','none'),$(t).hide('slow','swing',function(){a._setVisible=true;});});});}},{name:'show',icon:'sprite:icon-24 icon-PinNull icon-primary',caption:rk('Показать'),isMainAction:true,onActivated:function(e,o,n){t._showNote(n,true);}},{visible:false,name:'hide',icon:'sprite:icon-24 icon-PinOff icon-primary',caption:rk('Скрыть'),isMainAction:true,onActivated:function(e,o,n){t._showNote(n,false);}}]),this._controls={add:s,hide:r,show:c,notes:a},this.subscribeTo(a,'onItemClick',function(t,o,n,i){if(i.href||$(i).hasClass('LinkDecorator__image'))return;e.channel('NoteCommands').notify('Open',null,n),e.channel('NoteCommands').notify('CloseExtendedHider');}),this.subscribeTo(a,'onChangeHoveredItem',function(e,o){if(t._controls.notes._setVisible)a.getContainer().find('.controls-ItemsToolbar').css('display','block'),t._controls.notes._setVisible=false;var n=this.getItemsActions().getItemsInstances();if(o&&o.record)if(o.record.get('isHidden'))n['hide'].hide(),n['show'].show();else n['hide'].show(),n['show'].hide();}),this.subscribeTo(s,'onActivated',function(){e.channel('ChannelUserAccount').notify('onAddNote'),e.channel('NoteCommands').notify('CloseExtendedHider');}),this.subscribeTo(c,'onActivated',function(){t._showNotes(true),e.channel('NoteCommands').notify('CloseExtendedHider');}),this.subscribeTo(r,'onActivated',function(){t._showNotes(false),e.channel('NoteCommands').notify('CloseExtendedHider');}),this.subscribeTo(d,'onActivated',function(){e.channel('NoteCommands').notify('CloseExtendedHider');}),this.subscribeTo(e.channel('NoteCommands'),'setNotesList',function(e,o){t._setNotesList(o);}),e.channel('NotesEvents').notify('onExtendedHiderOpened').addCallback(function(e){if(e)t._setNotesList(e);}),this.subscribeTo(this._controls.notes,'onDrawItems',function(){t._addNoteBlur();});},_setNotesList:function(t){var n=this,i=o.$win.height();t.sort(function(t,e){return(t.top||(t.bottom?i-t.bottom-t.height:0))>(e.top||(e.bottom?i-e.bottom-e.height:0))?1:-1;}),this._controls.notes.setItems(t),this._controls.notes.setItemsFilterMethod(function(t){return false==t.get('pinnedToPanel');}),setTimeout(function(){n._addNoteBlur();},0),setTimeout(function(){e.channel('NotesEvents').notify('onExtendedHiderComplete');},100);},_addNoteBlur:function(){this.getContainer().find('.ws-note__content').each(function(){$(this).toggleClass('ws-note__blur',this.scrollHeight-this.clientHeight>0);});},_showNote:function(t,n){var i=this;if(t)if(t.set('isHidden',!n),e.channel('NoteCommands').notify('SetNoteVisible',t,n),!o.browser.isMobilePlatform)setTimeout(function(){i._controls.notes._showItemsToolbar(i._controls.notes.getHoveredItem());},50);},_showNotes:function(t){var o=[],n=[];if(this._controls.notes.getItems().each(function(e){if(e.get('isHidden')==t&&!e.get('pinnedToPanel'))e.set('isHidden',!t),o.push(e.get('id')),n.push(e.get('baseId'));}),o.length)e.channel('NoteCommands').notify('SetNotesListVisible',o,n,t);}});return i;});define('tmpl!SBIS3.Notes.Hider',['Core/tmpl/js/tclosure','Zametki_localization'],function(){var e=Array.prototype.slice.call(arguments),t=e[0],r={},i=function e(i,n,o,l,s){function a(){}var d=0,c=void 0!==t&&t?t:arguments[arguments.length-1];void 0===c&&(eval('var thelpers = null;'),c=global.requirejs('View/Runner/tclosure'));var u={};s&&s.isSetts&&(u=s.fullContext||{});var p='string'==typeof o?o:'',v=void 0===r?void 0:r,f={id:[],def:void 0},h=c.configResolver.calcParent(this,'undefined'==typeof currentPropertyName?void 0:currentPropertyName,i),m=this&&this.includedTemplates?this.includedTemplates:{},g=c.getMarkupGenerator(l);try{var y=g.joinElements([g.createTag('div',{class:'ws-note-hider ws-hidden',title:''+global.rk('Заметки')},[g.createTag('span',{class:'ws-note-hider__count'},[],{},f,this)],n,f,this)],p,f);f.def&&(y=g.chain(y,f,n),f=void 0);}catch(e){c.templateError('resources/Zametki/Hider/Page.tmpl',e,i);}return y||'';};return i.includedFunctions={},i.stable=!0,i.toJSON=function(){return{$serialized$:'func',module:'tmpl!SBIS3.Notes.Hider'};},i;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.Hider',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-note-hider{height:34px;width:20px;line-height:32px;position:relative;float:left;margin-left:12px;margin-top:0;top:-4px!important;text-align:center;cursor:pointer;box-sizing:border-box;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;z-index:1000;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAoCAYAAAD+MdrbAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAANtJREFUeNpifP/+wn8GKgIWEMH7o5sqhn3mKGVgYqAyGDVw1MBRA0cNHDVw1MBRA0cNHDVw6Bv4k9WJ4R8jP9mG/GdkZ/jJYg1mMwKbxAkMDP9agGZLs/69wsD25xgD0/+PRBv0i9mE4TeLMcN/BuZfjP+/T2f8/x/SxP7w4SLRBiMbBFT/h/H/57n/GIUqBAT0P8ANhAFCBv9m1gEHEcggpn/vlv5lEi8AGQSTxzAQl8HM/x4z/AKG0z9GPqAFb9f+YxROQTaIoIHYDAa6dCcw8jKABj3ApR4gwAAyxmqst/SWkwAAAABJRU5ErkJggg==) bottom right no-repeat}.ws-note-hider.ws-note-hider_big{width:28px!important;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAoCAYAAADt5povAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAUVJREFUeNrs171KxEAQB/CZ3SQnHGqwEEQEi7vuQEEfwNpKObX2HdRHsLrOWi2tLHwDH8E7tREtrCwETfw4lGx2x0lO4QyiB2KwmCmyG1jmx/y3WoyiNkGJ5WWf4ddWKdjT0BYoKLkEFFBAAQUUUEABBRRQQAEF/L/gS9A0Rjf+DEl1nY3lfI/85F4HsKsAehHBGM9e+J67As9e/gpxahwSPZdjBBVQFJ0QBLtI1Hvix3En5GWJj27w4A2ExPr2TPv2HJS7HQzBUQZqYPQ870cAqXvDQ+w5DPfDcOY6n/AD7C/Gp9/xTcYnkZ5T3556OU4Pn84SViBVdciuxKqpLMBEUfeQ8RYj7WLvL8ECPstLFvsaxz6h6C7xbSdQ9MhQrS+y+2OHYzuMHH3X70ewgC/0cLfCk1ezyPh/m7B6wFA8SI83AQYAcDx94mR3JIwAAAAASUVORK5CYII=) bottom right no-repeat}.ws-note-hider.ws-note-hider_big.ws-hider_fletching{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAoCAYAAADt5povAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAATFJREFUeNrs2L1KBDEQAOCZJAs2eougIDYiVwpa2djpA3iN1lf4CPoU2x1X+BgHPoBvIOtPpXaWgrtyyrlnknFmsRAOxeNksZhAEkiG/ZJMmiwWRU7QYHHSzL9ljWDDuRMw0HBRUEEFFVRQQQUVVFBBBRVU8F+CbprgiC14txvguUZcAEOPIQnXNgk3gFT9DSiIt+0airgMCFWBNOrz1EXEpW7ldve5gov34MIdCD41OIHQaIgwPuOprJVu519CB2V5mXLf8Wb9yJv2TpXsBRdu613b+DDxbZSfCvLG/w7h8SxNN/PfHBfja4Lzko/5eqwivfgkXDnBDT3Xb/walOPg1XGsHxt6PWfklJHBLJeD8S3uugDhEMCuSL45BVbA0tAT52OxNyvyA9753PnBhwADACRYhLDZk4SlAAAAAElFTkSuQmCC) bottom right no-repeat}.ws-note-hider.ws-note-hider_big .ws-note-hider__count{width:28px}.informers-informerPanel .ws-note-hider{float:right}.ws-note-panel-hider{height:24px;width:24px;line-height:24px;position:relative;float:left;margin-left:0;margin-top:0;top:0;text-align:center;cursor:pointer;box-sizing:border-box;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;z-index:1000}.ws-note-hider__count{width:20px;color:#000;font-family:TensorFont,sans-serif;font-size:14px}.ws-note-panel-hider .ws-note-hider__count{position:absolute;line-height:26px;left:0}.ws-notes-hider-container .ws-note-hider{margin-left:0;top:0!important}.billing-page .ws-note-hider{height:30px;line-height:28px;margin-left:12px}.billing-page #informerPanel .ws-note-hider{top:-2px!important}.ws-note-hider.ws-hider_fletching{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAoCAYAAAD+MdrbAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAARVJREFUeNpifP/+wn8GKgIWEMH7o5sqhn3mKGVgYqAyGDVw1MBRA0cNHDVw1MBRA0cNHDVwUBr4j5Gf+AYnPvCHWZXhF7Mxw18mWQbmf48Z2P8cBdMku/A3sw7DV/Z0hu+sAQz/Gfl2AoUS/zJJP/3GFsHwnS0Qp4tRXPifkZ3hDxPQRSzWQDbnH8b/3/YChTP4BO0eQJUs+PDhYsIfJqWWP+wq0qx/rzCw/TnGwPT/I9wMRlCjnefnJKC3TBh+sxiDHP2H6d+7pX+ZxAsEBPQ/4PIByGBgyLYA1cMN/sqeBjGQkeEnw38G5l+M/79P/8/I24DPIHwGgwWABn748O7wBCAt8P//fwZyMVB/wvv3554ABBgACWKX/MCWsg0AAAAASUVORK5CYII=) bottom right no-repeat}.ws-note-hider__count,.ws-note-hider_expanded .ws-note-hider__toggle{display:inline-block;background:0 0}'));head.appendChild(style);});}define('js!SBIS3.Notes.Hider',['Core/EventBus','Core/detection','SBIS3.CONTROLS/CompoundControl','tmpl!SBIS3.Notes.Hider','js!SBIS3.Notes.PanelData','css!SBIS3.Notes.Hider','SBIS3.CONTROLS/Link','Zametki_localization','Zametki_localization'],function(e,t,i,n,s){'use strict';var o=i.extend({_dotTplFn:n,$protected:{_options:{onPanel:false,activableByClick:false},_eventNamespace:'.noteshider',_alreadyProcessed:false,_wasOpened:false},init:function(){if(o.superclass.init.call(this),this.setVisible(false),this._dom={hider:this.getContainer(),count:this.getContainer().find('.ws-note-hider__count'),informerPanel:$('.informers-informerPanel')},!this._dom.informerPanel.length)this._dom.informerPanel=$('#informerPanel');if(this._count=0,this._onPanel=false,this._options.onPanel&&s)if(s.getTop()){var t=s.getTop().containerId?'#'+s.getTop().containerId:'.edo-Dialog-head__first-line',i=$(t).closest('.ws-sticky-header__wrapper'),n=$(i).find('.ws-notes-hider-container');if(n.length)this._dom.informerPanel=n,this._onPanel=true,this._panelId=s.getTop().containerId;this.hiderProcess(15);}var r=this;if(!this._onPanel)require(['Core/UserInfo'],function(e){if('__сбис__биллинг'===e.get('ЛогинКлиента'))r.hiderProcess(15);});this.subscribeTo(e.channel('navigation'),'accordeonVisibilityStateChange',this._onAccordeonStateChange.bind(this)),this.subscribeTo(e.channel('navigation'),'onAccTransform',this._onAccordeonStateChange.bind(this)),this.subscribeTo(e.channel('NoteCommands'),'setHiderCount',function(e,t){this.setCount(t);}.bind(this)),this.subscribeTo(e.channel('NoteCommands'),'setHiderVisible',function(e,t){this.setVisible(t);}.bind(this)),this.subscribeTo(e.channel('NoteCommands'),'CloseExtendedHider',function(){if(this._extendedHider)this._extendedHider.close();}.bind(this)),this.subscribeTo(e.channel('NotesEvents'),'onExtendedHiderComplete',function(){if(this._extendedHider&&this._toggleLocalIndicator)this._toggleLocalIndicator(this._extendedHider.getContainer(),false);}.bind(this)),this.subscribeTo(e.channel('NoteCommands'),'setHiderFletching',function(e,t){this.setHiderFletching(t);}.bind(this));},hiderProcess:function(e){if(!this._dom.informerPanel.length)if(this._dom.informerPanel=$('.informers-informerPanel'),!this._dom.informerPanel.length)this._dom.informerPanel=$('#informerPanel');var i=this;if(!this._onPanel&&!this._dom.informerPanel.length&&e>0)return e--,void setTimeout(function(){i.hiderProcess(e);},500);this.setVisible(this._count>0),this._dom.hider.on('mouseenter'+this._eventNamespace,function(){if(!t.isMobilePlatform)$(this).addClass('ws-note-hider_expanded');return false;}).on('mouseleave'+this._eventNamespace,function(){return $(this).removeClass('ws-note-hider_expanded'),false;}).on('touchstart'+this._eventNamespace,function(){return i.openExtendedHider(),false;}).on('click'+this._eventNamespace,function(){return i.openExtendedHider(),false;}).on('mousedown'+this._eventNamespace,false),this._dom.hider.add(this._dom.hider.children()).attr('unselectable','on').on('selectstart',false),this._alreadyProcessed=true,this.positionHider();},destroy:function(){o.superclass.destroy.call(this),this._dom.hider.off(this._eventNamespace),this._dom=this._extendedHider=null;},_onWindowResize:function(){this.positionHider();},setCount:function(e){if(this._count=e,this._dom.count.text(this._count>99?'99+':this._count),this._dom.hider.toggleClass('ws-note-hider_big',this._count>=100),this._alreadyProcessed)this.toggle(e>0);},setZIndex:function(e){this._dom.hider.css('z-index',e);},setHiderFletching:function(e){this._options.showNotes=e,this._dom.hider.attr('title',e?rk('Скрыть заметки'):rk('Показать заметки')),this._dom.hider.toggleClass('ws-hider_fletching',e);},openExtendedHider:function(){var e=this;if(this._extendedHider&&this._extendedHider.isVisible())return void this._extendedHider.close();require(['SBIS3.CONTROLS/FloatArea','Core/helpers/Hcontrol/toggleLocalIndicator','js!SBIS3.Notes.ExtendedHider'],function(t,i){e._toggleLocalIndicator=i,new t({visible:true,parent:e,opener:e,template:'<component data-component="SBIS3.Notes.ExtendedHider"></component>',element:$('<div class="ws-note__extHider-form"></div>'),target:e.getContainer(),animation:'slide',animationLength:700,direction:'bottom',autoCloseOnHide:true,activableByClick:false,closeByExternalClick:false,closeByExternalOver:false,corner:'tl',locationStrategy:'bodyBounds',closeButton:false,_canScroll:true,verticalAlign:{side:'top',offset:0},horizontalAlign:{side:'left',offset:24},handlers:{onReady:function(){if(e._extendedHider=this,!e._wasOpened)e._wasOpened=true,e._toggleLocalIndicator(this.getContainer(),true);}}}).show();});},setColor:function(e){var t='ws-note-hider_color-',i=t+[0,1,2,3,4].join(' '+t);this._dom.hider.removeClass(i).addClass(t+e);},hideHider:function(){if(this._dom.informerPanel)this._dom.informerPanel.removeClass('hasNotes'),this.setVisible(false);},positionHider:function(){if(this._dom.informerPanel.length){if(this.getContainer().removeAttr('style'),this.getContainer().css('margin-top: 8px'),this._dom.informerPanel.append(this._dom.hider),this._onPanel)this._dom.informerPanel.addClass('hasNotes');}else this.getContainer().attr('style','top: 0!important'),this.getContainer().css('margin-left',$('body').hasClass('compact-menu')?60:210);},_onAccordeonStateChange:function(){this.positionHider();}});return o;});define('js!SBIS3.Notes.TouchDragNDropMixin',['Zametki_localization','Zametki_localization'],function(){'use strict';return{preparePageXY:function(t){if('touchstart'===t.type||'touchmove'===t.type)t.pageX=t.originalEvent.touches[0].pageX,t.pageY=t.originalEvent.touches[0].pageY;},after:{_setItemsDragNDrop:function(t){this._getItemsContainer()[t?'on':'off']('touchstart','.js-controls-ListView__item',this._getDragInitHandler());}}};});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.NoteListView',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-note_color-0,.ws-window.ws-note_color-0{background:#fffd9d}.ws-note__body .controls-ScrollContainer.controls-ScrollContainer__bottom-gradient:after{background:-moz-linear-gradient(top,rgba(255,253,157,0) 0,rgba(255,253,157,.1) 15%,rgba(255,253,157,.5) 30%,rgba(255,253,157,.99) 70%,rgba(255,253,157,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(255,253,157,0)),color-stop(15%,rgba(255,253,157,.1)),color-stop(30%,rgba(255,253,157,.5)),color-stop(70%,rgba(255,253,157,.99)),color-stop(100%,rgba(255,253,157,1)));background:-webkit-linear-gradient(top,rgba(255,253,157,0) 0,rgba(255,253,157,.1) 15%,rgba(255,253,157,.5) 30%,rgba(255,253,157,.99) 70%,rgba(255,253,157,1) 100%);background:-o-linear-gradient(top,rgba(255,253,157,0) 0,rgba(255,253,157,.1) 15%,rgba(255,253,157,.5) 30%,rgba(255,253,157,.99) 70%,rgba(255,253,157,1) 100%);background:-ms-linear-gradient(top,rgba(255,253,157,0) 0,rgba(255,253,157,.1) 15%,rgba(255,253,157,.5) 30%,rgba(255,253,157,.99) 70%,rgba(255,253,157,1) 100%);background:linear-gradient(to bottom,rgba(255,253,157,0) 0,rgba(255,253,157,.1) 15%,rgba(255,253,157,.5) 30%,rgba(255,253,157,.99) 70%,rgba(255,253,157,1) 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=\'#00fffd9e\', endColorstr=\'#fffd9e\', GradientType=0);height:31px;position:absolute;content:\'\';width:100%;display:block}.ws-note__body .controls-ScrollContainer.controls-ScrollContainer__bottom-gradient:after,.ws-note__body .controls-ScrollContainer.controls-ScrollContainer__top-gradient:before{z-index:10000}.ws-note-date-html{text-align:right;float:right;margin-right:8px;margin-top:6px;font-size:11px;color:#999}.ws-note_color-1,.ws-window.ws-note_color-1{background:#dffcad}.ws-note__body.ws-note_color-1 .controls-ScrollContainer.controls-ScrollContainer__bottom-gradient:after{background:-moz-linear-gradient(top,rgba(223,252,173,0) 0,rgba(223,252,173,.1) 15%,rgba(223,252,173,.5) 30%,rgba(223,252,173,.99) 70%,rgba(223,252,173,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(223,252,173,0)),color-stop(15%,rgba(223,252,173,.05)),color-stop(50%,rgba(223,252,173,.5)),color-stop(80%,rgba(223,252,173,.99)),color-stop(100%,rgba(223,252,173,1)));background:-webkit-linear-gradient(top,rgba(223,252,173,0) 0,rgba(223,252,173,.1) 15%,rgba(223,252,173,.5) 30%,rgba(223,252,173,.99) 70%,rgba(223,252,173,1) 100%);background:-o-linear-gradient(top,rgba(223,252,173,0) 0,rgba(223,252,173,.1) 15%,rgba(223,252,173,.5) 30%,rgba(223,252,173,.99) 70%,rgba(223,252,173,1) 100%);background:-ms-linear-gradient(top,rgba(223,252,173,0) 0,rgba(223,252,173,.1) 15%,rgba(223,252,173,.5) 30%,rgba(223,252,173,.99) 70%,rgba(223,252,173,1) 100%);background:linear-gradient(to bottom,rgba(223,252,173,0) 0,rgba(223,252,173,.1) 15%,rgba(223,252,173,.5) 30%,rgba(223,252,173,.99) 70%,rgba(223,252,173,1) 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=\'#00dffcac\', endColorstr=\'#dffcac\', GradientType=0)}.ws-note_color-4,.ws-window.ws-note_color-4{background:#c9eeff}.ws-note__body.ws-note_color-4 .controls-ScrollContainer.controls-ScrollContainer__bottom-gradient:after{background:-moz-linear-gradient(top,rgba(201,238,255,0) 0,rgba(201,238,255,.1) 15%,rgba(201,238,255,.5) 30%,rgba(201,238,255,.99) 70%,rgba(201,238,255,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(201,238,255,0)),color-stop(15%,rgba(201,238,255,.05)),color-stop(50%,rgba(201,238,255,.5)),color-stop(80%,rgba(201,238,255,.99)),color-stop(100%,rgba(201,238,255,1)));background:-webkit-linear-gradient(top,rgba(201,238,255,0) 0,rgba(201,238,255,.1) 15%,rgba(201,238,255,.5) 30%,rgba(201,238,255,.99) 70%,rgba(201,238,255,1) 100%);background:-o-linear-gradient(top,rgba(201,238,255,0) 0,rgba(201,238,255,.1) 15%,rgba(201,238,255,.5) 30%,rgba(201,238,255,.99) 70%,rgba(201,238,255,1) 100%);background:-ms-linear-gradient(top,rgba(201,238,255,0) 0,rgba(201,238,255,.1) 15%,rgba(201,238,255,.5) 30%,rgba(201,238,255,.99) 70%,rgba(201,238,255,1) 100%);background:linear-gradient(to bottom,rgba(201,238,255,0) 0,rgba(201,238,255,.1) 15%,rgba(201,238,255,.5) 30%,rgba(201,238,255,.99) 70%,rgba(201,238,255,1) 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=\'#00b4e8fe\', endColorstr=\'#b4e8fe\', GradientType=0)}.ws-note_color-2,.ws-window.ws-note_color-2{background:#ffd5b9}.ws-note__body.ws-note_color-2 .controls-ScrollContainer.controls-ScrollContainer__bottom-gradient:after{background:-moz-linear-gradient(top,rgba(255,213,185,0) 0,rgba(255,213,185,.1) 15%,rgba(255,213,185,.5) 30%,rgba(255,213,185,.99) 70%,rgba(255,213,185,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(255,213,185,0)),color-stop(15%,rgba(255,213,185,.05)),color-stop(50%,rgba(255,213,185,.5)),color-stop(80%,rgba(255,213,185,.99)),color-stop(100%,rgba(255,213,185,1)));background:-webkit-linear-gradient(top,rgba(255,213,185,0) 0,rgba(255,213,185,.1) 15%,rgba(255,213,185,.5) 30%,rgba(255,213,185,.99) 70%,rgba(255,213,185,1) 100%);background:-o-linear-gradient(top,rgba(255,213,185,0) 0,rgba(255,213,185,.1) 15%,rgba(255,213,185,.5) 30%,rgba(255,213,185,.99) 70%,rgba(255,213,185,1) 100%);background:-ms-linear-gradient(top,rgba(255,213,185,0) 0,rgba(255,213,185,.1) 15%,rgba(255,213,185,.5) 30%,rgba(255,213,185,.99) 70%,rgba(255,213,185,1) 100%);background:linear-gradient(to bottom,rgba(255,213,185,0) 0,rgba(255,213,185,.1) 15%,rgba(255,213,185,.5) 30%,rgba(255,213,185,.99) 70%,rgba(255,213,185,1) 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=\'#00ffcba9\', endColorstr=\'#ffcba9\', GradientType=0)}.ws-note_color-3,.ws-window.ws-note_color-3{background:#ecd6ec}.ws-note__body.ws-note_color-3 .controls-ScrollContainer.controls-ScrollContainer__bottom-gradient:after{background:-moz-linear-gradient(top,rgba(236,214,236,0) 0,rgba(236,214,236,.1) 15%,rgba(236,214,236,.5) 30%,rgba(236,214,236,.99) 70%,rgba(236,214,236,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(236,214,236,0)),color-stop(15%,rgba(236,214,236,.99)),color-stop(50%,rgba(236,214,236,.5)),color-stop(80%,rgba(236,214,236,.99)),color-stop(100%,rgba(236,214,236,1)));background:-webkit-linear-gradient(top,rgba(236,214,236,0) 0,rgba(236,214,236,.1) 15%,rgba(236,214,236,.5) 30%,rgba(236,214,236,.99) 70%,rgba(236,214,236,1) 100%);background:-o-linear-gradient(top,rgba(236,214,236,0) 0,rgba(236,214,236,.1) 15%,rgba(236,214,236,.5) 30%,rgba(236,214,236,.99) 70%,rgba(236,214,236,1) 100%);background:-ms-linear-gradient(top,rgba(236,214,236,0) 0,rgba(236,214,236,.1) 15%,rgba(236,214,236,.5) 30%,rgba(236,214,236,.99) 70%,rgba(236,214,236,1) 100%);background:linear-gradient(to bottom,rgba(236,214,236,0) 0,rgba(236,214,236,.1) 15%,rgba(236,214,236,.5) 30%,rgba(236,214,236,.99) 70%,rgba(236,214,236,1) 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=\'#00f8f8f8\', endColorstr=\'#f8f8f8\', GradientType=0)}.controls-ListView .ws-note.controls-ListView__item.controls-ListView__hoveredItem{background-color:transparent}.ws-note__footer{-moz-user-select:none;-o-user-select:none;-khtml-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none;position:absolute;bottom:1px;background:inherit;width:100%;font-size:0;margin-bottom:-1px;min-height:6px;z-index:210;padding-bottom:8px}.ws-note__has-files .ws-note__footer{background:rgba(255,255,255,.45)}.ws-note__indicator{position:absolute;top:0;bottom:0;left:0;right:0;background:url(/ws/lib/Control/AreaAbstract/resources/images/ajax-loader-indicator.v1516270649826335cf4508dd597be4bfc9caa3e08b901.gif) no-repeat scroll center #fff;opacity:.4;display:none;z-index:250}.ws-note_blocked .ws-note__indicator{display:block}.ws-note__body .ws-note__content .ws-basic-style img.LinkDecorator__image{height:48px;padding:0!important;margin:0!important}.ws-note__body .ws-note__content .ws-basic-style .LinkDecorator__linkWrap{position:absolute}.ws-note__body .ws-note__content .ws-basic-style .LinkDecorator__linkWrap.LinkDecorator__disableBlur:after{display:none}.ws-note__body .ws-note__content .ws-basic-style .LinkDecorator__wrap{margin-top:2px;width:540px;max-width:100%;position:relative}.ws-note_color-0 .ws-note__actions{-webkit-box-shadow:1px 1px 8px 4px #fffd9d;-moz-box-shadow:3px 3px 5px 4px #fffd9d;box-shadow:1px 1px 8px 4px #fffd9d}.ws-note_color-1 .ws-note__actions{-webkit-box-shadow:1px 1px 8px 4px #dffcad;-moz-box-shadow:3px 3px 5px 4px #dffcad;box-shadow:1px 1px 8px 4px #dffcad}.ws-note_color-2 .ws-note__actions{-webkit-box-shadow:1px 1px 8px 4px #ffd5b9;-moz-box-shadow:3px 3px 5px 4px #ffd5b9;box-shadow:1px 1px 8px 4px #ffd5b9}.ws-note_color-3 .ws-note__actions{-webkit-box-shadow:1px 1px 8px 4px #ecd6ec;-moz-box-shadow:3px 3px 5px 4px #ecd6ec;box-shadow:1px 1px 8px 4px #ecd6ec}.ws-note_color-4 .ws-note__actions{-webkit-box-shadow:1px 1px 8px 4px #c9eeff;-moz-box-shadow:3px 3px 5px 4px #c9eeff;box-shadow:1px 1px 8px 4px #c9eeff}'));head.appendChild(style);});}define('js!SBIS3.Notes.NoteListView',['Core/core-instance','Core/helpers/Array/findIndex','Core/EventBus','Core/detection','SBIS3.CONTROLS/ListView','js!SBIS3.Notes.Note','js!SBIS3.Notes.NoteFiles','js!SBIS3.Notes.NoteTags','js!SBIS3.Notes.TouchDragNDropMixin','js!SBIS3.ENGINE.LinkValidator','js!SBIS3.Notes.NoteActions','css!SBIS3.Notes.NoteListView','Zametki_localization','Zametki_localization'],function(e,t,n,s,i,o,r,a,c,l){'use strict';function h(){throw new Error('Method not implemented');}function u(e){var t=$(e).closest('.ws-note');if(t.length){var n=new Date(t.data('lastDrag')||0);return new Date()-n<150;}return false;}var d=i.extend([c],{$protected:{_options:{idProperty:'id',displayProperty:'text',nodeProperty:'node',multiselect:false,itemSelect:true,itemsActions:[]},_lightMode:false,_eventNamespace:'.note-list-view'},$constructor:function(){this._publish('onItemDoubleClick');},init:function(){d.superclass.init.call(this),this._isStatic=e.instanceOfModule(this,'SBIS3.Notes.StaticNoteListView');var t=this;this._initDataSource(),this.getContainer().on('mouseup'+this._eventNamespace+' touchend'+this._eventNamespace,'.ws-note__body',this._onMouseUp.bind(this)).on('touchstart'+this._eventNamespace,this._onTouchStart.bind(this)).on('click'+this._eventNamespace,'a',this._onLinkClick.bind(this)).on((s.isMobilePlatform?'touchstart':'click')+this._eventNamespace,'.ws-note__checkable',this._onCheckableClick.bind(this)),this.subscribeTo(this,'onDrawItems',function(){if(!this._disableRedraw)r.loadFilePreviews(this);}),this.subscribeTo(this,'onDrawItems',this._onDrawItems);var i=n.channel('NotesEvents');this.subscribeTo(i,'onTagFormOpened',function(){t._isTagFormOpened=true;}),this.subscribeTo(i,'onTagFormClosed',function(){t._isTagFormOpened=false;}),this.subscribeTo(i,'onPinMenuOpened',function(){t._isPinMenuOpened=true;}),this.subscribeTo(i,'onPinMenuClosed',function(){t._isPinMenuOpened=false;}),this.subscribeTo(i,'onNoteOpen',this._onMouseUp.bind(this));},destroy:function(){d.superclass.destroy.call(this),this.getContainer().off(this._eventNamespace);},_initDataSource:h,_onDrawItems:h,_setRedrawCommand:function(e){this._options.autoRedraw=e;},_onLinkClick:function(e){if(u(e.target))e.preventDefault();},isCheckboxArea:function(e){var t,n,s=0,i=0;if('touchstart'===e.type||'touchend'===e.type){if(t=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0],n=$(e.target).offset(),t)s=t.pageX-n.left,i=t.pageY-n.top;}else s=e.offsetX,i=e.offsetY;return s<=17;},_onCheckableClick:function(e){var t=$(e.target);if(e.target===e.currentTarget&&this.isCheckboxArea(e)){t.toggleClass('ws-note__checkable_checked').toggleClass('ws-note__checkable_unchecked');var n=this,s=t.closest('.ws-note'),i=s.find('.ws-note__checkable').index(t),o=s.data('id'),r=this.findNoteById(o),a=$('<div></div>').append(r.text);a.find('.ws-note__checkable:eq('+i+')').toggleClass('ws-note__checkable_checked').toggleClass('ws-note__checkable_unchecked'),r.text=a.html(),r.save().addCallback(function(){if(n._isStatic){var e=n.getItems(),t=e.getRecordById(o);e.setEventRaising(false),t.set('Content',r.text),e.setEventRaising(true);}});}},_manualLinkOpenForMobiles:function(e){if(s.isMobilePlatform&&!this._isStatic)if(l.linkClickHandler(e),false===e.originalEvent.defaultPrevented)window.open(e.target.href);},_openLinkTarget:function(e){var t=e?e.target?$(e.target):null:null;if(t&&t.closest('a').length){var n=e.target.href;if(!n&&'IMG'===e.target.nodeName)n=e.target.parentElement.href,window.open(n);else this._manualLinkOpenForMobiles(e);}else if(t.closest('.dv-bigpreview-item').length)t.click();},_onMouseUp:function(e,t,s){var i=5;if(s&&'onNoteOpen'===e.name)e=t;if('touchend'===e.type)n.channel('DragAndDropChannel').notify('onMouseup',e);var o=e?e.target?$(e.target):null:null;if(this._isDragDropStarted||o&&o.hasClass('controls-Scrollbar__thumb'))return void(this._isDragDropStarted=false);if('touchend'===e.type){var r=e.originalEvent.changedTouches[0].pageX,a=e.originalEvent.changedTouches[0].pageY;if(this._scrollStarted){if(this._currentTouchedX&&this._currentTouchedY&&(Math.abs(r-this._currentTouchedX)>i||Math.abs(a-this._currentTouchedY)>i));else this._openLinkTarget(e);return void(this._scrollStarted=false);}if(this._currentPressedX&&this._currentPressedY&&(Math.abs(r-this._currentPressedX)>i||Math.abs(a-this._currentPressedY)>i))return void(this._currentPressedX=this._currentPressedY=null);else this._openLinkTarget(e);}if(!o||e.which>1||o.hasClass('controls-Button__icon')||o.hasClass('controls-Button__wrapper')||o.hasClass('controls-IconButton')||o.closest('a').length||o.closest('.dv-bigpreview-item').length||o.closest('.ws-note__checkable').length&&this.isCheckboxArea(e)||this._dragData&&this._dragData.noteId)return;var c;if(o)c=o.closest('.ws-note').data('id');if(c)this.setSelectedKey(c),this._closeSubforms(),this._notify('onItemDoubleClick',this.findNoteById(c),this.getSelectedItem());},_mouseMoveHandler:function(e){if(!this._isTagFormOpened&&!this._isPinMenuOpened)d.superclass._mouseMoveHandler.call(this,e);},_manualChangeHoveredItem:function(e){var t=this._findItemByElement(e);if(t.length)this._changeHoveredItem(t);},_onTouchStart:function(e){this._mouseMoveHandler(e),this._manualChangeHoveredItem($(e.target));var t=!!$(e.target).closest('.controls-DragNDropMixin__notDraggable').length;if(this._scrollStarted=t,t)this._currentTouchedX=e.originalEvent.changedTouches[0].pageX,this._currentTouchedY=e.originalEvent.changedTouches[0].pageY;},_closeSubforms:function(){(this.getChildControls()||[]).forEach(function(t){if(e.instanceOfModule(t,'SBIS3.Notes.TagButton'))t.closeForm();});},getNoteElement:function(e){return this.getContainer().find('.ws-note[data-id="'+e+'"]');},getNotes:function(e){if(e)return this.getItems();var t=this.getItems(),n=[];if(t)if(this._isStatic)t.each(function(e){n.push(new o(e,true));});else if(n=t.getRawData(),n)n.sort(function e(t,n){return t.order-n.order;});return n||[];},getNoteCount:function(){return this.getNotes().length;},removeNote:function(e){var t=this.getNotes().splice(e,1),n=this.getDataSource(),s=this.getItems(),i=s.getRecordById(t[0].id);if(s.remove(i),!this._isStatic&&s.getCount()<n._$data.length)n.destroy(t[0].id);return t[0];},findNoteById:function(e){var t=this.getNotes().filter(function(t){return t.id===e;});return t&&t.length?t[0]:null;},findNoteByBaseId:function(e){var t=this.getNotes().filter(function(t){return t.baseId===e;});return t&&t.length?t[0]:null;},findNoteIndexById:function(e){return t(this.getNotes(),function(t){return t.id===e;});},removeNoteById:function(e){var t=this.findNoteIndexById(e);return t>=0?this.removeNote(t):null;},sync:function(e){var t=this.getItems().getRecordById(e.id);if(t)t.set('pinnedToPanel',e.pinnedToPanel),t.set('isAuthor',e.isAuthor),t.set('panelId',e.panelId),t.set('panelObject',e.panelObject),t.set('containerId',e.containerId);},cropNote:function(e){var t=this._isStatic?0:12,n=40,i=e.find('.ws-note__body'),o=i.find('.ws-note__scroll'),r=o.find('.ws-note__content'),c=r.find('.ws-basic-style'),l=e.find('.ws-note__footer'),h=e.width()-n;if(a.prototype._resizeTags(e),i.css('padding-bottom',l.height()),s.isMobilePlatform){var u=r[0].scrollHeight+t>o.height();o.toggleClass('controls-DragNDropMixin__notDraggable',u);}var d=c.find('.LinkDecorator__image');if(d.length)d.each(function(){$(this.parentElement).toggleClass('LinkDecorator__disableBlur',$(this).width()<h);});},cropNotes:function(){var e=this;this._getNoteElements().each(function(t,n){e.cropNote($(n));});},_getNoteElements:function(){return this.getContainer().find('.ws-note');},_mouseLeaveHandler:function(e){if((!e||0===$(e.relatedTarget).closest('.ws-note__pin-menu').length&&0===$(e.relatedTarget).closest('.ws-note__tag-form').length)&&!this._isTagFormOpened)d.superclass._mouseLeaveHandler.call(this,e);},addImageLoadCallback:function(e,t){e.each(function(){$(this).one('load',t);});}});return d;});define('html!SBIS3.Notes.DynamicNoteListView/DynamicNote',['Zametki_localization'],function(){var e=function(e){var t=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(t){for(;e.test(t);)t=t.replace(e,'&#123;&#123;$1&#125;&#125;');return t;};}(),n=function(e){return e.join?e.join(''):e.toString();},r=function(e){return void 0===e?'':e&&'object'==typeof e?n(e):''+e;},i='undefined'!=typeof process,o=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,''),a=e.item.getRawData();return e.className='ws-note ws-note_dynamic ws-hidden',a.isHidden&&(e.className+=' ws-note_hidden'),e.attributes=a.viewModel.attributes,o+=' '+t(r(e.defaultItemTpl(e,e.attributes))),(o=t(o))+(i&&-1!==o.indexOf('{{')?String.fromCharCode(8203,8203):'');};return e.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.DynamicNoteListView/DynamicNote'};},e;});define('html!SBIS3.Notes.DynamicNoteListView/DynamicNoteContent',['Zametki_localization'],function(){var e=function(e){var n=function(){var e={'&':'&#38;','<':'&#60;','>':'&#62;','"':'&#34;','\'':'&#39;','/':'&#47;'},n=/&(?!#?\w+;)|<|>|"|'|\//g;return function(o){return o?o.toString().replace(n,function(n){return e[n]||n;}):o;};}(),o=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;e.test(n);)n=n.replace(e,'&#123;&#123;$1&#125;&#125;');return n;};}(),t=function(e){return e.join?e.join(''):e.toString();},s=function(e){return void 0===e?'':e&&'object'==typeof e?t(e):''+e;},r='undefined'!=typeof process,i=('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),a=function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,c='',d=e.item.getRawData(),_=d.viewModel.text,l=d.tags,v=l.length;if(c+=' <div class="ws-note__border" unselectable="on"> <div class="ws-note__corner ws-note__corner_top-left"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__corner ws-note__corner_top"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__corner ws-note__corner_top-right"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__corner ws-note__corner_right"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__corner ws-note__corner_bottom-right"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__corner ws-note__corner_bottom"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__corner ws-note__corner_bottom-left"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__corner ws-note__corner_left"> <div class="ws-note__corner-marker"></div> </div> <div class="ws-note__body ws-note_color-'+o(s(d.color))+' ',!d.pinnedToPanel||d.isAuthor||d.canEdit||(c+='ws-note_move'),c+='" unselectable="on"> ',d.pinnedToPanel&&(c+=' <div class="ws-note-header-image__panel"> <span class="ws-note-header-image ws-note-header-image_shared icon-16 icon-Groups icon-disabled"></span> </div> '),c+=' <component data-component="SBIS3.CONTROLS/ScrollContainer" class="ws-note__scroll" name="scrollContainerNote_'+o(s(d.id))+'"> <option name="content"> <div class="ws-note__content"> <div class="ws-basic-style">'+o(s(e.Sanitize(_)))+'</div> <component data-component="SBIS3.Notes.NoteFiles" name="NoteFiles_'+o(s(d.id))+'"> <option name="noteRecord" type="ref" value="'+o(s(function(e,n){var o=i.randomId();return e[o]=n,o;}(a,e.item)))+'"></option> </component> </div> </option> </component> <div class="ws-note__footer"> <div class="ws-note-tags-html ',d.title&&(c+='ws-note__has-calendar'),c+='"> ',v){c+=' ';var w=l;if(w)for(var p,m=-1,u=w.length-1;m<u;)c+=' <span class="ws-note__tag ws-note__tag_color-'+o(s((p=w[m+=1]).color))+'">'+o(s(n(p.name)))+'</span> ';c+=' <span class="ws-note-tags__ellipsis ws-hidden">'+o(s(rk('...')))+'</span> ';}return c+=' </div> ',d.title&&(c+=' <span class="ws-note-header-image icon-16 icon-Bell"></span> <span class="ws-note-calendar-html">'+o(s(n(d.title)))+'</span> '),c+=' </div> <component data-component="SBIS3.Notes.NoteActions"> <option name="noteId">'+o(s(d.id))+'</option> <option name="showShare">'+o(s(d.pinnedToPanel))+'</option> <option name="isAuthor">'+o(s(d.isAuthor))+'</option> <option name="isHidden">'+o(s(d.isHidden))+'</option> <option name="noteRecord" type="ref" value="'+o(s(function(e,n){var o=i.randomId();return e[o]=n,o;}(a,e.item)))+'"></option> </component> <div class="ws-note__indicator"></div> </div> <div class="ws-note-tmp"></div> </div> <div class="ws-note-shadow"> <div class="ws-note-shadow__left"></div> <div class="ws-note-shadow__right"></div> </div>',(c=o(c))+(r&&-1!==c.indexOf('{{')?String.fromCharCode(8203,8203):'');};return e.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.DynamicNoteListView/DynamicNoteContent'};},e;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.DynamicNoteListView',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-note__corner{position:absolute;display:none}.ws-note__corner-marker{width:9px;height:9px;border-radius:5px;position:absolute;background:#bbb}.ws-note__corner_top-left{top:0;left:0}.ws-note__corner_top{top:0;left:50%}.ws-note__corner_top-right{top:0;right:0}.ws-note__corner_right{top:50%;right:0}.ws-note__corner_bottom-right{bottom:0;right:0}.ws-note__corner_bottom{bottom:0;left:50%}.ws-note__corner_bottom-left{bottom:0;left:0}.ws-note__corner_left{top:50%;left:0}.ws-note__corner_bottom .ws-note__corner-marker,.ws-note__corner_left .ws-note__corner-marker,.ws-note__corner_right .ws-note__corner-marker,.ws-note__corner_top .ws-note__corner-marker{width:5px;height:5px;border-radius:3px}.ws-note__corner_top .ws-note__corner-marker{top:-3px;left:-3px}.ws-note__corner_bottom .ws-note__corner-marker{bottom:-3px;left:-3px}.ws-note__corner_right .ws-note__corner-marker{top:-3px;right:-3px}.ws-note__corner_left .ws-note__corner-marker{top:-3px;left:-3px}.ws-note__corner_top-right .ws-note__corner-marker{top:-5px;right:-5px}.ws-note__corner_top-left .ws-note__corner-marker{top:-5px;left:-5px}.ws-note__corner_bottom-right .ws-note__corner-marker{bottom:-5px;right:-5px}.ws-note__corner_bottom-left .ws-note__corner-marker{bottom:-5px;left:-5px}.ws-note__corner:before{content:\'\';display:block;width:45px;height:45px;margin:-18px}.ws-note__corner_current:before{content:\'\';width:80px;height:80px;position:absolute;top:-40px;left:-40px}.ws-note__corner_bottom-left,.ws-note__corner_top-right{cursor:ne-resize}.ws-note__corner_bottom-right,.ws-note__corner_top-left{cursor:nw-resize}.ws-note__corner_bottom,.ws-note__corner_top{cursor:n-resize}.ws-note__corner_left,.ws-note__corner_right{cursor:e-resize}.ws-note_dynamic{width:256px;min-width:246px;height:80px;min-height:80px;padding:0;margin:0;overflow:visible!important;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}.ws-note-list_dynamic .controls-ListView__item.ws-note_dynamic{position:fixed;box-sizing:border-box}.ws-note__border{position:absolute;left:6px;top:6px;right:6px;bottom:6px;box-sizing:border-box;overflow:visible;margin:1px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}.controls-ListView__hoveredItem .ws-note__border{border:1px dashed #bbb;left:5px;top:5px;right:5px;bottom:5px}.controls-ListView__hoveredItem .ws-note__corner{display:block}.ws-note_blocked.controls-ListView__hoveredItem .ws-note__border{border:0;left:6px;top:6px;right:6px;bottom:6px}.ws-note_blocked.controls-ListView__hoveredItem .ws-note__corner{display:none}.ws-note_dynamic .ws-note__body{position:absolute;left:6px;top:6px;right:6px;bottom:6px;box-sizing:border-box;display:block;overflow:hidden;cursor:pointer;-moz-user-select:none;-o-user-select:none;-khtml-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none}.ws-note_dynamic .ws-note__body .ws-note__content .ws-basic-style img:not(.LinkDecorator__image){max-width:100%!important;height:auto!important}.ws-note_dynamic .ws-note-shadow{left:12px;right:12px;bottom:7px}body.dragdropBody{-moz-user-select:none;-khtml-user-select:none;-webkit-user-select:none;user-select:none}.ws-note_dynamic .ws-note-tags-html{max-height:48px}.ws-note__body.ws-note_move{cursor:move}.ws-note-header-image_shared{right:6px;bottom:10px;position:absolute}.ws-note-header-image__panel{position:absolute;right:0;top:0;padding-top:4px;width:30px;height:30px;background:inherit;border-radius:0 0 0 14px;z-index:300}.ws-note_color-0 .ws-note-header-image__panel{-webkit-box-shadow:1px 1px 8px 4px #fffd9d;-moz-box-shadow:3px 3px 5px 4px #fffd9d;box-shadow:1px 1px 8px 4px #fffd9d}.ws-note_color-1 .ws-note-header-image__panel{-webkit-box-shadow:1px 1px 8px 4px #dffcad;-moz-box-shadow:3px 3px 5px 4px #dffcad;box-shadow:1px 1px 8px 4px #dffcad}.ws-note_color-2 .ws-note-header-image__panel{-webkit-box-shadow:1px 1px 8px 4px #ffd5b9;-moz-box-shadow:3px 3px 5px 4px #ffd5b9;box-shadow:1px 1px 8px 4px #ffd5b9}.ws-note_color-3 .ws-note-header-image__panel{-webkit-box-shadow:1px 1px 8px 4px #ecd6ec;-moz-box-shadow:3px 3px 5px 4px #ecd6ec;box-shadow:1px 1px 8px 4px #ecd6ec}.ws-note_color-4 .ws-note-header-image__panel{-webkit-box-shadow:1px 1px 8px 4px #c9eeff;-moz-box-shadow:3px 3px 5px 4px #c9eeff;box-shadow:1px 1px 8px 4px #c9eeff}.ws-note_hidden{display:none}.ws-note__infobox-author-title{display:block;min-width:75px;font-size:15px;height:41px;margin-right:5px}.ws-note__infobox-author{display:block;overflow:hidden;height:20px}.ws-infobox-content .ws-note__infobox-content .ws-note__infobox-author>a{overflow:hidden;display:inline-block;text-overflow:ellipsis;text-decoration:none;max-width:400px;font-size:15px}.ws-info-box .ws-note__infobox-content .ws-note__infobox-author>a:hover{text-decoration:underline}.ws-note__infobox-date{height:18px;line-height:22px;display:block;color:#999;font-size:12px}.ws-note__infobox-col-1{display:inline-block;min-width:75px;float:left}.ws-note__infobox-col-2{display:inline-block}.ws-note__infobox-row-1,.ws-note__infobox-row-2{height:41px}.ws-note__infobox-content{overflow:hidden}'));head.appendChild(style);});}define('js!SBIS3.Notes.DynamicNoteListView',['Core/EventBus','Core/Deferred','Core/constants','SBIS3.CONTROLS/Utils/LinkWrapUtils','js!SBIS3.Notes.NoteListView','html!SBIS3.Notes.DynamicNoteListView/DynamicNote','html!SBIS3.Notes.DynamicNoteListView/DynamicNoteContent','js!SBIS3.Notes.Note','js!SBIS3.BL.Note','js!SBIS3.Notes.PanelData','SBIS3.CONTROLS/ScrollContainer','css!SBIS3.Notes.DynamicNoteListView','Zametki_localization','Zametki_localization'],function(e,t,i,s,n,o,a,r,h,l){'use strict';var d=-r.NOTE_BODY_PADDING+1;function f(e,t,i){return e<t?t:e>i?i:e;}function c(){return window.pageXOffset||document.documentElement.scrollLeft;}function g(){return window.pageYOffset||document.documentElement.scrollTop;}function u(){return i.$win.width();}function _(){return Math.min(i.$doc.height(),i.$win.height());}function p(){return parseInt(i.$body.css('margin-right'),10)||0;}function m(e){return!!e.find(function(e){return!e.complete||0===e.naturalWidth;});}var w=n.extend({$protected:{_options:{className:'ws-note-list_dynamic',itemTpl:o,itemContentTpl:a},_dragData:null,_isMobile:false,_eventNamespace:'.dynamicNotesListView',_windowWidth:0,_windowHeight:0,_tagsWasChanged:false,_isBeingDragged:false,_hasPostponedReload:false},$constructor:function(){this.subscribeTo(this,'onDataLoad',this._onDataLoad);var t=e.channel('NotesEvents');this.subscribeTo(t,'onTagAdded',this._onTagAdded.bind(this)),this.subscribeTo(t,'onTagUpdated',this._onTagUpdated.bind(this)),this.subscribeTo(t,'onTagRemoved',this._onTagRemoved.bind(this));var s=e.channel('NoteCommands');this.subscribeTo(s,'SetNoteVisible',this._setNoteVisible.bind(this)),this.subscribeTo(s,'SetNotesListVisible',this._setNotesListVisible.bind(this)),this.subscribeTo(s,'RedrawTags',function(e,t){var i=this.getItems().getRecordById(t.id);if(i)i.set('tags',t.tags);}.bind(this)),this.getContainer().on('mouseenter'+this._eventNamespace,'.ws-note-header-image__panel',this._showAuthorInfo.bind(this)),i.$win.on('resize'+this._eventNamespace,this._onWindowResize.bind(this).debounce(250));},destroy:function(){w.superclass.destroy.call(this),this._infobox=null,this.getContainer().off(this._eventNamespace),i.$win.off(this._eventNamespace);},_showAuthorInfo:function(e){var t=$(e.target).closest('.ws-note');if(t.length){var i=this,s=$(t[0]).data('id'),n=s?this.findNoteById(s):null;if(n&&n.baseId)require(['Lib/Control/Infobox/Infobox','tmpl!SBIS3.Notes.DynamicNoteListView/AuthorInfo'],function(t,s){h.getLastChangedInfo(n.baseId).addCallback(function(n){var o={title:rk('Общая заметка'),control:$(e.target).find('.ws-note-header-image').length?$(e.target).find('.ws-note-header-image'):e.target,message:s(n.getRow()),position:'br',autoHide:true,hideDelay:5000};i._infobox=t,i.subscribeOnceTo(i._infobox,'onShow',function(){var e=12,t=80,i=this.getContainer(),s=i.find('.ws-infobox-content');if(s.length)if(s.css('min-width',Math.ceil(s.find('.ws-note__infobox-col-1').width()+s.find('.ws-note__infobox-col-2').width())),i.width()<s.width()+e)s.find('.ws-note__infobox-author > a').width(Math.ceil(i.width()-t-e));}),i._infobox.show(o),i._infoboxOpened=new Date().getTime();});});}},_setNoteElementVisible:function(e,t){var i=this.getNoteElement(e);if(i)if(i.toggleClass('ws-note_hidden',!t),i.find('[name="ShowNote"]').toggleClass('ws-hidden',t),i.find('[name="HideNote"]').toggleClass('ws-hidden',!t),t&&this.hasChildControlByName('scrollContainerNote_'+e))this.getChildControlByName('scrollContainerNote_'+e)._resizeInner();},_setNotesListVisible:function(t,i,s,n){var o=this;h[n?'showNotesList':'hideNotesList'](s),i.forEach(function(e){o._setNoteElementVisible(e,n);}),e.channel('NoteCommands').notify('setHiderFletching',n);},_setNoteVisible:function(t,i,s){if(i&&i.get('baseId'))h[s?'showNote':'hideNote'](i.get('baseId')),this._setNoteElementVisible(i.get('id'),s);if(s)e.channel('NoteCommands').notify('setHiderFletching',true);else{var n=false;if(this.getItems().each(function(e){if(!e.get('isHidden')&&!e.get('pinnedToPanel'))n=true;}),!n)e.channel('NoteCommands').notify('setHiderFletching',false);}},_getNotePositionOnPanel:function(e){if(e.pinnedToPanel){var t=l.getTop();if(t&&t.containerId){var i=e.width,s=$('#'+t.containerId),n=s.offset(),o=parseInt(n.left,10);return{minLeft:o,maxLeft:o+parseInt(s.css('width'),10)-i};}}else return null;},_getWindowWidth:function(){if(!this._windowWidth)this._windowWidth=u();return this._windowWidth;},_getWindowHeight:function(){if(!this._windowHeight)this._windowHeight=_();return this._windowHeight;},_onWindowResize:function(){this._windowWidth=u(),this._windowHeight=_(),this.drawNotes();},_createAvatar:function(){this._avatar=$();},_updateViewModel:function(e){var t=this._getWindowHeight(),i=this._getWindowWidth(),n=d,o=d,a=t-d-e.height,r=i-d-e.width,h=e.getPosition(i,t),l=this._getNotePositionOnPanel(e);if(l)o=l.minLeft,r=l.maxLeft;var c=s.wrapURLs(e.text),g=h.left,u=f(h.top,n,a);if(null!=e.right)g-=parseInt(document.body.style.marginRight||0,10);g=f(g,o,r),e.viewModel={text:c,order:e.order,top:u,left:g,attributes:{style:'top: '+u+'px; left: '+g+'px; width: '+e.width+'px; height: '+e.height+'px; z-index: '+e.order+';',unselectable:'on'}};},_onTagAdded:function(){this._tagsWasChanged=true;},_onTagRemoved:function(e,t,i){var s=this;if(t)this._tagsWasChanged=true;else this.getItems().each(function(e){if(e.getRawData().removeTagWithoutSave(i))s._tagsWasChanged=true;});},_onTagUpdated:function(e,t,i,s,n){var o=this;this.getItems().each(function(e){var a=false;if(e.getId()===t)a=true;else{var r=e.getRawData().getTag(i);if(r)r.name=s,r.color=n,a=true;}if(a)o._tagsWasChanged=true;});},_onDataLoad:function(e,t){var i=this,s=-1;if(t)t.each(function(e){var t=e.getRawData();while(s===t.order)t.order++;s=t.order,i._updateViewModel(t);});},_onDrawItems:function(){},_initDataSource:function(){this.setPageSize(1000);},_onMouseUp:function(e){if(i.browser.isMobilePlatform)if(e&&e.target&&($(e.target).hasClass('ws-note-header-image')||$(e.target).hasClass('ws-note-header-image__panel')))return e.preventDefault(),void this._showAuthorInfo(e);if(this._infoboxOpened<new Date().getTime()+5000&&this._infobox)this._infobox.hide(0);w.superclass._onMouseUp.call(this,e);var t=$(e.target).closest('.ws-note').data('id');if(t)this.reorderNotes(t);},_releaseDragndropLock:function(){if(this._isBeingDragged=false,this._hasPostponedReload)this._hasPostponedReload=false,this.reload();},_getCorner:function(e){var t=e.attr('class').replace(/ws-note__corner /,'');return{isTop:t.indexOf('top')>=0,isBottom:t.indexOf('bottom')>=0,isLeft:t.indexOf('left')>=0,isRight:t.indexOf('right')>=0};},_onDragHandler:function(e,t){var s=e.getSource(),n;if(s&&s.getCount()>0)n=s.at(0).getDomElement();if('mousemove'===t.type&&i.browser.isMobilePlatform)return;if(this._isBeingDragged=true,!n)return;if(this.preparePageXY(t),this._dragData)if(this._dragData.isResize)this._resizeNote(t.pageX,t.pageY);else this._moveNote(t.pageX,t.pageY,n);t.preventDefault(),t.stopPropagation();},_makeDragEntityList:function(){var e=w.superclass._makeDragEntityList.apply(this,arguments);return e.setAction(function(){return false;}),e;},_beginDragHandler:function(t,s){if(w.superclass._beginDragHandler.apply(this,arguments),s&&s.target&&$(s.target).hasClass('controls-Scrollbar__thumb'))return;if(this._currentPressedElement=s.target,'touchstart'===s.type)this._currentPressedX=s.originalEvent.touches[0].pageX,this._currentPressedY=s.originalEvent.touches[0].pageY;if(this._closeSubforms(),e.channel('NoteCommands').notify('CloseExtendedHider'),this._infoboxOpened<new Date().getTime()+5000&&this._infobox)this._infobox.hide(0);var n=t.getSource().at(0),o=n.getDomElement(),a=$(s.target),r=a.hasClass('ws-note__corner')?a:a.hasClass('ws-note__corner-marker')?a.parent():null,h=!!r,d;if(!i.browser.isMobilePlatform)o.addClass('has-focus').find('.ws-note-tmp').attr('contenteditable','true').focus();else this._manualChangeHoveredItem($(o));var f=n.getModel().getId(),u=this.findNoteById(f);u.top=o.position().top,u.left=o.position().left;var _=(d=this._dragData={noteId:f,note:u,noteElement:o,scrollTop:g(),scrollLeft:c(),screenWidth:i.$win.width(),screenHeight:i.$win.height(),isResize:h,cornerElement:r}).note.getPosition(d.screenWidth,d.screenHeight);if(_.left-=p(),d.actualWidth=d.initialWidth=o.width(),d.actualHeight=d.initialHeight=o.height(),d.actualTop=d.initialTop=_.top,d.actualLeft=d.initialLeft=_.left,u.pinnedToPanel){var m=l.getTop();if(m&&m.containerId){var N=$('#'+m.containerId),v=N.offset();d.panelMinLeft=parseInt(v.left),d.panelMaxLeft=d.panelMinLeft+N.width()-d.actualWidth;}}if(o.addClass('ws-note_dragged'),this.preparePageXY(s),this._moveBeginX=s.pageX,this._moveBeginY=s.pageY,h)r.addClass('ws-note__corner_current'),d.corner=this._getCorner(r);else d.shiftX=this._moveBeginX-_.left,d.shiftY=this._moveBeginY-_.top;},_resizeNote:function(e,t){var i=this._dragData,s=i.corner,n=e-this._moveBeginX,o=t-this._moveBeginY,a=i.initialTop+(s.isTop?o:0),h=i.initialLeft+(s.isLeft?n:0),l=i.initialWidth+(s.isLeft?-n:n),f=i.initialHeight+(s.isTop?-o:o),c=r.MIN_NOTE_HEIGHT+(i.noteElement.find('.ws-note-tags-html').height()?40:0),g=i.panelMinLeft||d,u=i.panelMaxLeft||i.screenWidth-d-i.initialWidth,_=d,p=i.screenHeight-d-i.actualHeight;if(!s.isLeft&&h+n<u&&n>0||!s.isLeft&&l>=r.MIN_NOTE_WIDTH&&n<0||s.isLeft&&n<0&&h>=g||s.isLeft&&l>=r.MIN_NOTE_WIDTH&&n>0)if(s.isLeft||s.isRight)i.actualWidth=l,i.actualLeft=h;if(s.isTop&&o>0&&f>=r.MIN_NOTE_HEIGHT||s.isTop&&a>=_&&o<0||!s.isTop&&o>0&&a<p||!s.isTop&&f<i.actualHeight&&f>=c){if(s.isTop||s.isBottom)i.actualHeight=f,i.actualTop=a;}else if(!s.isTop&&a>=p)i.actualHeight=i.screenHeight-i.actualTop-d;this._currentPressedX=this._currentPressedY=null,i.noteElement.css({width:i.actualWidth,left:i.actualLeft,height:i.actualHeight,top:i.actualTop});},_moveNote:function(e,t,i){var s=this._dragData,n=e-s.shiftX,o=t-s.shiftY,a=s.panelMinLeft||d,r=s.panelMaxLeft||s.screenWidth-d-s.actualWidth-p(),h=d,l=s.screenHeight-d-s.actualHeight;i.css({top:s.actualTop=f(o,h,l),left:s.actualLeft=f(n,a,r)});},_endDragHandler:function(e,t,s){var n=true,o=this._dragData;if(o&&o.note){var a=o.note,r=o.noteElement;if(r.removeClass('ws-note_dragged'),o.isResize){if(o.cornerElement.removeClass('ws-note__corner_current'),this.cropNote(r),a.width!==o.actualWidth||a.height!==o.actualHeight)a.width=o.actualWidth,a.height=o.actualHeight;else n=false;if(this._notifyOnSizeChanged(),a.id)this.reorderNotes(a.id);}a.setPosition(o.actualTop,o.actualLeft,o.screenWidth,o.screenHeight);var h=p();if(null!=a.right)a.right-=h;if(!o.isResize||o.isResize&&n)a.save(['Settings']);if(this._dragData=null,r.data('lastDrag',new Date()),!i.browser.isMobilePlatform)r.find('.ws-note-tmp').attr('contenteditable','false');}this._releaseDragndropLock();},_findDragDropContainer:function(e,t){var i=$(t).parents();if(i.filter('.ws-note__tag-form').length||i.filter('.ws-note__pin-menu').length)return null;return t;},removeNoteById:function(e){this._disableRedraw=true;var t=w.superclass.removeNoteById.call(this,e);if(t)this.getNoteElement(e).remove();return this._disableRedraw=false,t;},reorderNotes:function(e){var t=this.getNotes(),i=t.length,s=false,n,o;if(i>1){if(n=this.findNoteIndexById(e),n<i-1)t.push(t.splice(n,1)[0]);for(var a=0;a<i;a++)if(o=t[a],o.order!==a+1)o.order=a+1,this.getNoteElement(o.id).css('z-index',o.order),s=true;if(s)this._notify('onReorder');}},_mouseLeaveHandler:function(e){if((!e||!this._dragData)&&!this._isTagFormOpened&&!this._isPinMenuOpened)w.superclass._mouseLeaveHandler.call(this,e);},_mouseMoveHandler:function(e){if(this._dragData){if(!this._dragData.noteElement.hasClass('controls-ListView__hoveredItem'))this._manualChangeHoveredItem($(e.target));}else w.superclass._mouseMoveHandler.call(this,e);},drawNotes:function(){var e=this;this.getNotes().forEach(function(t){e._updateViewModel(t),e.getNoteElement(t.id).css({top:t.viewModel.top,left:t.viewModel.left});});},cropNotes:function(){var e=this.getNotes();if(e)e.forEach(function(e){var t=this.getNoteElement(e.id),i=t.find('.ws-note__content img'),s=this;if(i.length)s.cropNote(t),this.addImageLoadCallback(i,function(){if(!m(i))i.off('load');s.cropNote(t);});else this.cropNote(t);},this);},reload:function(){if(this._isBeingDragged)return this._hasPostponedReload=true,t.success();else return this.drawNotes(),w.superclass.reload.call(this);},_setVisibility:function(e){if(!e)this._closeSubforms();w.superclass._setVisibility.call(this,e);},setItems:function(e){e.forEach(function(e){this._updateViewModel(e);},this),w.superclass.setItems.apply(this,arguments);},redraw:function(){if(!this._disableRedraw)w.superclass.redraw.apply(this,arguments);}});return w;});define('js!SBIS3.Notes.NoteModel',['WS.Data/Collection/RecordSet','WS.Data/Entity/Model','js!SBIS3.Notes.Utils.Date','Core/helpers/random-helpers','Zametki_localization','Zametki_localization'],function(t,e,i,r){'use strict';function n(e,i){var e=e?e.split(','):[];return new t({idProperty:'attachId',rawData:e.map(function(t){return{attachId:t,fileName:'',title:'',Size:0,redactionId:'',versionForm:'',typeDoc:'',subTypeDoc:'',subVersionForm:'',hash:'',canEdit:false!==i};})});}return e.extend({_$adapter:'adapter.sbis',_$properties:{id:{def:function(){return r.createGUID();}},baseId:{def:function(){return this.get('Id');}},title:{get:function(){var t=this.get('Notification'),e=this.get('CronData');if(!(t instanceof Date)||isNaN(+t))return'';if(!e)return i.prettyDate(t);else{var r=i.getRepeatType(e);return i.prettyDate(i.getNearestDate(t,r));}}},files:{def:function(){return this._files=n(this.get('Files'),Boolean(!this.get('PinnedToPanel')||this.get('IsAuthor'))),this._files;},get:function(){return this._files;},set:function(t){this._files=t;}},tags:{get:function(){var t=[];return this.get('Tags').each(function(e){var i={id:e.get('Id'),name:e.get('Name'),color:e.get('Color')};t.push(i);}),t;}}},_$idProperty:'Id'});});define('html!SBIS3.Notes.StaticNoteListView/StaticNote',['Zametki_localization'],function(){var t=function(t){var e=function(){var t=/\{\{([\s\S]+?)\}\}/g;return function(e){for(;t.test(e);)e=e.replace(t,'&#123;&#123;$1&#125;&#125;');return e;};}(),n=function(t){return t.join?t.join(''):t.toString();},r=function(t){return void 0===t?'':t&&'object'==typeof t?n(t):''+t;},o='undefined'!=typeof process,i=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'');return t.className='ws-note ws-note_static',t.attributes={unselectable:'on'},i+=' '+e(r(t.defaultItemTpl(t))),(i=e(i))+(o&&-1!==i.indexOf('{{')?String.fromCharCode(8203,8203):'');};return t.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.StaticNoteListView/StaticNote'};},t;});define('html!SBIS3.Notes.StaticNoteListView/StaticNoteContent',['Zametki_localization'],function(){var t=function(t){var e=function(){var t={'&':'&#38;','<':'&#60;','>':'&#62;','"':'&#34;','\'':'&#39;','/':'&#47;'},e=/&(?!#?\w+;)|<|>|"|'|\//g;return function(o){return o?o.toString().replace(e,function(e){return t[e]||e;}):o;};}(),o=function(){var t=/\{\{([\s\S]+?)\}\}/g;return function(e){for(;t.test(e);)e=e.replace(t,'&#123;&#123;$1&#125;&#125;');return e;};}(),n=function(t){return t.join?t.join(''):t.toString();},i=function(t){return void 0===t?'':t&&'object'==typeof t?n(t):''+t;},s='undefined'!=typeof process,a=('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),r=function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,c='<div class="ws-note__body ws-note_color-'+o(i(t.item.get('Color')))+'" unselectable="on"> <component data-component="SBIS3.CONTROLS/ScrollContainer" class="ws-note__scroll"> <option name="content"> <div class="ws-note__content"> <div class="ws-basic-style">'+o(i(t.Sanitize(t.item.get('Content'))))+'</div> <component data-component="SBIS3.Notes.NoteFiles" name="NoteFiles_'+o(i(t.item.get('id')))+'"> <option name="staticMode">true</option> <option name="noteRecord" type="ref" value="'+o(i(function(t,e){var o=a.randomId();return t[o]=e,o;}(r,t.item)))+'"></option> </component> </div> </option> </component> <div class="ws-note__footer" unselectable="on"> <div class="ws-note-tags-html"> ';if(t.item.get('tags').length){c+=' ';var l=t.item.get('tags');if(l)for(var d,p=-1,m=l.length-1;p<m;)c+=' <span class="ws-note__tag ws-note__tag_color-'+o(i((d=l[p+=1]).color))+'">'+o(i(e(d.name)))+'</span> ';c+=' <span class="ws-note-tags__ellipsis ws-hidden">'+o(i(rk('...')))+'</span> ';}return c+=' </div> <span class="ws-note-header-image',t.item.get('title')&&(c+=' icon-16 icon-Bell '),c+='"></span> <span class="ws-note-calendar-html">'+o(i(t.item.get('title')))+'</span> </div> <component data-component="SBIS3.Notes.NoteActions"> <option name="showPin">true</option> <option name="allowPinToAnyPage">false</option> <option name="isHidden" value="'+o(i(t.item.get('IsHidden')))+'"></option> <option name="showShare" value="'+o(i(t.item.get('PinnedToPanel')))+'"></option> <option name="isAuthor" value="'+o(i(t.item.get('IsAuthor')))+'"></option> <option name="staticMode">true</option> <option name="noteRecord" type="ref" value="'+o(i(function(t,e){var o=a.randomId();return t[o]=e,o;}(r,t.item)))+'"></option> </component> <div class="ws-note-shadow"> <div class="ws-note-shadow__left"></div> <div class="ws-note-shadow__right"></div> </div> <div class="ws-note__indicator"></div> </div> <div class="ws-note-tmp"></div>',(c=o(c))+(s&&-1!==c.indexOf('{{')?String.fromCharCode(8203,8203):'');};return t.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.StaticNoteListView/StaticNoteContent'};},t;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.StaticNoteListView',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-note-list_loaded .ws-note{-webkit-transition:top .5s,left .5s;-moz-transition:top .5s,left .5s;-o-transition:top .5s,left .5s;transition:top .5s,left .5s}.ws-note-list_static{padding-left:8px}.ws-note_static{width:240px;padding:0;margin:0}.controls-ListView__item.ws-note.ws-note_static{position:absolute!important}.ws-note_static .ws-note__body{margin:8px;position:relative;cursor:pointer;overflow:hidden}.ws-note_static.controls-ListView__hoveredItem .ws-note__body{box-shadow:1px 0 8px 1px #aaa;transition:box-shadow .5s;-webkit-transition:box-shadow .5s;-moz-transition:box-shadow .5s;-o-transition:box-shadow .5s}.ws-note_static .ws-note__content{position:relative;word-wrap:break-word;min-height:20px}.ws-note_static .ws-note__body .ws-note__scroll{max-height:440px}.ws-note_static .ws-note-tags-html{position:relative;bottom:initial;max-height:48px}.ws-note_static .ws-note:after{content:\'\';position:relative;zoom:0;font-size:0;display:block;width:0;height:0}.ws-note_static .ws-note-shadow{width:100%;bottom:-6px}.ws-note_static .ws-note__content div p{max-width:100%;margin:0}.ws-note_static .ws-note__content .ws-basic-style img{font-size:0;vertical-align:bottom;margin-bottom:5px}@media \\0screen{.ws-note-left-list,.ws-note-list_static{margin-top:32px!important}}.ws-is-mobile-platform .ws-notes-holder_static{overflow:scroll!important}.ws-note_static .ws-note__footer{padding-bottom:5px}.ws-note_static .ws-note__footer .ws-note-tags__ellipsis,.ws-note_static .ws-note__footer .ws-note__tag{margin-top:4px;margin-bottom:4px}'));head.appendChild(style);});}define('js!SBIS3.Notes.StaticNoteListView',['Core/core-instance','Core/EventBus','Core/constants','js!SBIS3.Notes.NoteListView','js!SBIS3.Notes.NoteModel','js!SBIS3.BL.Note','WS.Data/Source/SbisService','js!SBIS3.Notes.Utils.Info','html!SBIS3.Notes.StaticNoteListView/StaticNote','html!SBIS3.Notes.StaticNoteListView/StaticNoteContent','js!SBIS3.Notes.NoteTags','SBIS3.CONTROLS/ScrollContainer','css!SBIS3.Notes.StaticNoteListView','Zametki_localization','Zametki_localization'],function(e,t,i,o,s,a,n,r,d,l){'use strict';var c=245,g=336,h=['DIV','LI','P'];function u(e){for(var t=1/0,i,o=-1,s=0,a=e.length;s<a;s++)if(i=e[s],i<t)t=i,o=s;return o;}function f(e){while(null!=e){if(h.indexOf(e.tagName)>=0)break;e=e.parentElement;}return e;}var m=o.extend({$protected:{_options:{className:'ws-note-list_static',itemTpl:d,itemContentTpl:l,itemsDragNDrop:false,emptyHTML:rk('Заметок нет.')}},_modifyOptions:function(e){var t=m.superclass._modifyOptions.apply(this,arguments);return t.emptyHTML=rk('Заметок нет.'),t;},$constructor:function(){var e=t.channel('NoteCommands');this.subscribeTo(e,'SetNoteVisible',this._setNoteVisible.bind(this));},reload:function(){return this.getContainer().removeClass('ws-note-list_loaded'),m.superclass.reload.apply(this,arguments);},_initDataSource:function(){this.setPageSize(25),this.setDataSource(new n({endpoint:{address:'/notes/service/',contract:'Note'},model:s,binding:{query:'GetPersonNotesList'},idProperty:'Id'}),true);},_onDrawItems:function(){this.show(),this.toColView(),this.getContainer().addClass('ws-note-list_loaded');},_setNoteVisible:function(e,t,i){if(t&&t.get('baseId'))a[i?'showNote':'hideNote'](t.get('baseId'));},_endDragHandler:function(o,s){var n=o&&o.getTargetsDomElement();if(n&&!o.getTargetsControl()){var d=n.data('id'),l=o.getSource(),c=l?l.at(0):null,g=c?c.getModel().get('baseId'):null;if(d&&g)a.pinNoteByUrlId(g,d).addCallback(function(){t.channel('NotesEvents').notify('onNoteChanged',c.getModel());}).addErrback(function(e){r.showMessageDialog({message:e.message,status:'error'});});}if(!i.browser.isMobilePlatform&&!s)return;i.$body.removeClass('dragdropNote');var h=o.getSource();if(h&&h.getCount()>0){var u=o.getTarget();if(u){var f=h.at(0),m=o.getOwner(),N;if(e.instanceOfModule(m,'SBIS3.Notes.TagListView')){var S=f.getModel().getId();if(N=u.getModel().getId(),S&&N&&'00000000-0000-0000-0000-000000000000'!==S)t.channel('NoteCommands').notify('AddTag',N,S);}else if(e.instanceOfModule(m,'SBIS3.Notes.NoteListView')){N=f.getModel().getId();var p=u.getModel().getId();if(N&&p)t.channel('NoteCommands').notify('MoveNote',N,p);}}}},_onDragHandler:function(e,t){if(t.originalEvent.preventDefault(),m.superclass._onDragHandler.apply(this,arguments),'touchmove'===t.type){var i=t.originalEvent.changedTouches[0],o=document.elementFromPoint(i.clientX,i.clientY),s=$(o).closest('.ws-note-used-tag');if(s.length){var a=s.data('id');if($('.ws-note-used-tag').removeClass('controls-ListView__hoveredItem'),'00000000-0000-0000-0000-000000000000'!==a)$('.ws-note-used-tag[data-id='+a+']').addClass('controls-ListView__hoveredItem');}}else this._isDragDropStarted=true;},_beginDragHandler:function(e,t){if(m.superclass._beginDragHandler.apply(this,arguments),this._currentPressedElement=t.target,'touchmove'===t.type||'touchstart'===t.type)this._currentPressedX=t.touches[0].pageX,this._currentPressedY=t.touches[0].pageY;i.$body.addClass('dragdropNote').removeClass('dragdropTag');},toColView:function(){var e=8,t=this.getNoteCount();if(0===t)return;for(var o=this.getContainer(),s=o.width()-(i.browser.isMobilePlatform?45:0),a=s/c^0,n=Math.min(g,s/Math.min(t,a)^0),r=this,d=new Array(a),l=0;l<a;l++)d[l]=0;this._getNoteElements().each(function(t,i){var o=u(d),s=$(i),a=n*o,l=d[o];s.css({width:n,left:a,top:l}),r.cropNote(s);var c=s.find('.ws-basic-style')[0];$(c).find('img').each(function(t,i){var o=$(i),s=o.data('original-width'),a=o.data('original-height'),n=s?s:i.clientWidth,r=a?a:i.clientHeight,d=f(i.parentNode),l=$(d).width()-2*e;if(n>l)r=r*l/n,n=l;if(n&&!o.hasClass('LinkDecorator__image'))if(o.css({width:n,height:r}),void 0===s&&void 0===a)o.attr({'data-original-width':i.clientWidth,'data-original-height':i.clientHeight});}),d[o]+=s.height();});var h=Math.max.apply(Math,d);o.height(h),o.css('min-height','');}});return m;});define('js!SBIS3.Notes.MasterPage',['js!SBIS3.Engine.OnlineBaseInner2','Core/Deferred','Zametki_localization','Zametki_localization'],function(e,n){'use strict';return e.extend({workspace:function(){return n.success(this.createComponent('SBIS3.Notes.Page',{}));}});});define('js!SBIS3.Notes.Page.PageInfo',['WS.Data/Entity/Model','Zametki_localization','Zametki_localization'],function(t){'use strict';return t.extend({$protected:{_options:{properties:{Title:{get:function(t){return t||'';}},PageTitle:{get:function(){var t=this.get('Title').split(' / ');return t[t.length-1];}},Breadcrumbs:{get:function(){var t=this.get('Title').split(' / ');return t.length-=1,t.join('\\');}}}}}});});define('html!SBIS3.Notes.Notification',['Zametki_localization'],function(){var o=function(o){var n=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,'&#123;&#123;$1&#125;&#125;');return n;};}(),t=function(o){return o.join?o.join(''):o.toString();},i=function(o){return void 0===o?'':o&&'object'==typeof o?t(o):''+o;},e='undefined'!=typeof process,p=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,''),a=new Date().getHours()>=20;return p+=' <div class="ws-note-notification-form" ondrop="return false;"> <div class="ws-window-titlebar-custom"> <component data-component="SBIS3.CONTROLS/Menu/MenuLink" name="methodMenu" class="controls-Menu__hide-menu-header"> <option name="caption">Напомнить по СМС</option> <option name="idProperty">id</option> <option name="icon">sprite:icon-16 icon-PhoneCell icon-primary</option> <option name="pickerClassName">ws-note-notification-form__menu ws-no-select</option> <option name="tabindex">0</option> <option name="activableByClick">false</option> <options name="items" type="array"> <options> <option name="id" type="number">0</option> <option name="title">'+n(i(rk('Напомнить по СМС')))+'</option> </options> <options> <option name="id" type="number">2</option> <option name="title">'+n(i(rk('Напомнить через СБИС')))+'</option> </options> <options> <option name="id" type="number">1</option> <option name="title">'+n(i(rk('Напомнить по e-mail')))+'</option> </options> <options> <option name="id" type="number">3</option> <option name="title">'+n(i(rk('Не напоминать')))+'</option> </options> </options> </component> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="save" class="controls-IconButton__round-border ws-note-notification-form__save"> <option name="icon">sprite:icon-16 icon-Yes icon-done</option> </component> </div> <component data-component="SBIS3.CONTROLS/Menu" name="timeMenu" class="controls-Menu__hide-menu-header ws-note-notification-form__menu ws-note-notification-form__menuTime"> <option name="idProperty">id</option> <option name="tabindex">0</option> <option name="activableByClick">false</option> <options name="items" type="array"> <options> <option name="icon">sprite:icon-16 icon-Bell icon-primary</option> <option name="id">today</option> <option name="title">',p+=n(a?i(rk('Через 2 часа')):i(rk('Позже сегодня'))),p+='</option> <option name="days" type="number">0</option> <option name="hours" type="number">20</option> <option name="minutes" type="number">00</option> </options> <options> <option name="id">tomorrow</option> <option name="title">'+n(i(rk('Завтра')))+'</option> <option name="days" type="number">1</option> <option name="hours" type="number">9</option> <option name="minutes" type="number">00</option> </options> <options> <option name="id">nextweek</option> <option name="title">'+n(i(rk('Через неделю в тот же день')))+'</option> <option name="days" type="number">7</option> <option name="hours" type="number">9</option> <option name="minutes" type="number">00</option> </options> </options> </component> <div class=\'ws-note-notification-form__custom-item\'>'+n(i(rk('Указать день и время')))+':</div> <div class="ws-note-notification-form__custom-date"> <span>'+n(i(rk('День')))+'</span> <component data-component="SBIS3.CONTROLS/Date/Picker" name="date" class="ws-note-notification-form__date"> <option name="mask">DD.MM.YY</option> <option name="tabindex">14</option> </component> <span>'+n(i(rk('Время')))+'</span> <component data-component="SBIS3.CONTROLS/Date/Picker" name="time" class="ws-note-notification-form__time"> <option name="mask">HH:II</option> <option name="tabindex">14</option> </component> </div> <div class="ws-note-notification-form__repeat-wrapper"> <component data-component="SBIS3.CONTROLS/Menu/MenuLink" name="repeatMenu" class="controls-Menu__hide-menu-header"> <option name="caption">'+n(i(rk('Не повторять')))+'</option> <option name="idProperty">id</option> <option name="pickerClassName">ws-note-notification-form__repeat ws-no-select</option> <option name="tabindex">0</option> <option name="activableByClick">false</option> <options name="items" type="array"> <options> <option name="id" type="number">0</option> <option name="title">'+n(i(rk('Не повторять')))+'</option> </options> <options> <option name="id" type="number">1</option> <option name="title">'+n(i(rk('Каждый день')))+'</option> </options> <options> <option name="id" type="number">2</option> <option name="title">'+n(i(rk('Каждую неделю')))+'</option> </options> <options> <option name="id" type="number">3</option> <option name="title">'+n(i(rk('Каждый месяц')))+'</option> </options> <options> <option name="id" type="number">4</option> <option name="title">'+n(i(rk('Каждый квартал')))+'</option> </options> <options> <option name="id" type="number">5</option> <option name="title">'+n(i(rk('Каждый год')))+'</option> </options> </options> </component> </div> <div class="ws-note-notification-form__footer">'+n(i(o.footerText))+'</div> </div>',(p=n(p))+(e&&-1!==p.indexOf('{{')?String.fromCharCode(8203,8203):'');};return o.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.Notification'};},o;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.Notification',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-note-notification-form{width:265px;padding:0}.ws-note-notification-form .ws-window-titlebar{font-weight:400;padding:8px 42px 0 8px;box-sizing:border-box}.ws-note-notification-form__save{position:absolute;right:43px}.ws-note-notification-form__hours{float:right;padding-right:2px;padding-top:8px}.ws-note-notification-form__time{vertical-align:middle;-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text}.controls-MenuItem.ws-note-notification-form__method_disabled{height:auto;cursor:default;flex-direction:column}.ws-note-notification-form__menu .controls-MenuItem{padding-left:8px}.ws-note-notification-form__menu .controls-MenuItem .controls-MenuItem__content{display:inline-block}.ws-note-notification-form__error{font-size:11px;max-width:350px;line-height:1.5;align-self:flex-start}.ws-note-notification-form__menuTime .controls-MenuItem .controls-MenuItem__text{display:inline-block;float:left;font-size:14px}.ws-note-notification-form__menuTime .controls-MenuItem__icon-wrapper{position:relative;width:22px}.ws-note-notification-form__menuTime .controls-MenuItem__icon{position:absolute;top:9px}.ws-note-notification-form__menuTime .controls-MenuItem__content.controls-MenuItem__cell{width:235px}.ws-note-notification-form__custom-item{height:30px;margin-top:7px;margin-left:31px}.ws-note-notification-form__menu .control-MenuItem__child-expand.controls-MenuItem__cell{width:0;padding-right:0}.ws-note-notification-form__custom-date{margin-left:31px;height:34px}.ws-note-notification-form__custom-date>span{color:#999}.ws-note-notification-form__date{margin-right:15px;-webkit-user-select:text}.ws-note-notification-form__time{margin-right:2px;margin-top:-4px}.ws-note-notification-form__time.controls-DatePicker .controls-DatePicker__dateBox{margin-right:2px}.ws-note-notification-form .controls-Menu.controls-Menu__hide-menu-header{margin-left:0;margin-top:-4px}.ws-note-notification-form__repeat-wrapper{padding:0 10px 10px 30px}.ws-note-notification-form__footer{padding:10px 10px 10px 10px;border-top:1px solid #e4e4e4}.ws-note-notification-form__footer .footerText{display:inline-block;float:left;margin-left:8px}.ws-note-notification-form__footer .icon-Refresh{margin-top:1px;float:left}.ws-note-notification-form__footer .clr{clear:both}'));head.appendChild(style);});}define('js!SBIS3.Notes.Notification',['Core/core-functions','Core/helpers/String/format','Core/constants','html!SBIS3.Notes.Notification','SBIS3.CONTROLS/CompoundControl','js!SBIS3.Notes.Utils.Date','css!SBIS3.Notes.Notification','SBIS3.CONTROLS/Menu/MenuLink','SBIS3.CONTROLS/Menu','SBIS3.CONTROLS/Button/IconButton','SBIS3.CONTROLS/Date/Picker','Zametki_localization','Zametki_localization'],function(t,e,i,s,o,n){'use strict';var a=['PhoneCell','Mail','EmptyMessage','Decline'];function r(t){var e=null;if(t&&t.has('hours'))(e=new Date()).setDate(e.getDate()+t.get('days')),e.setHours(t.get('hours'),t.get('minutes'),0,0);return e;}function l(t){return t=parseInt(t,10),t>=10?t:'0'+t;}var d=o.extend({_dotTplFn:s,$protected:{_options:{cron:'',method:null,repeat:null,time:null,activableByClick:false,availabilityErrors:[],startDate:null,endDate:null,ending:0,period:0,times:1,every:1},_dom:null,_controls:null,_initialMethod:null,_initialRepeat:null,_initialTime:null,_selectedMethod:null,_selectedRepeat:null,_selectedTime:null,_needValidate:false},_modifyOptions:function(t){var e=d.superclass._modifyOptions.apply(this,arguments);return e.footerText=rk('Напоминание не установлено'),e;},init:function(){d.superclass.init.call(this);function t(t,s){if(s.which===i.key.enter)s.preventDefault(),e.onSave();}var e=this;this._initialMethod=this._selectedMethod=this._options.method,this._initialTime=this._selectedTime=this._options.time,this._initialRepeat=this._selectedRepeat=this._options.repeat,this._initialCron=this._cron=this._options.cron,this._dom={custom:this.getContainer().find('.ws-note-notification-form__custom-item'),date:this.getContainer().find('.ws-note-notification-form__custom-date'),repeat:this.getContainer().find('.ws-note-notification-form__repeat-wrapper'),footer:this.getContainer().find('.ws-note-notification-form__footer')},this._controls={methodMenu:this.getChildControlByName('methodMenu'),timeMenu:this.getChildControlByName('timeMenu'),date:this.getChildControlByName('date'),time:this.getChildControlByName('time'),save:this.getChildControlByName('save'),repeatMenu:this.getChildControlByName('repeatMenu')},this._updateMethodMenu(null==this._initialMethod?this._getFirstAvailableMethod():this._initialMethod);var s=e._controls.timeMenu.getItems(),o=e._controls.timeMenu.getItemsInstances(),n=new Date();if(s.each(function(t){if(o[t.getId()].setProperty('activableByClick',false),o[t.getId()].getContainer().on('mousedown focus',false),t.has('hours')){if(n.getHours()>=20&&20==t.get('hours')){if(n.getHours()>=22)t.set('days',1);var e=new Date(n.setHours(n.getHours()+2));t.set('hours',e.getHours()),t.set('minutes',e.getMinutes());}o[t.getId()].getContainer().find('.controls-MenuItem__content').append($('<span class="ws-note-notification-form__hours">'+l(t.get('hours'))+':'+l(t.get('minutes'))+'</span>'));}}),this._initialCron)this._initRepeatMenu(this._initialCron);this._initTimeMenu(this._initialTime),this._controls.repeatMenu.setProperty('pickerConfig',{handlers:{onShow:this._disableRepeatMenuSelection.bind(this)}}),this._controls.methodMenu.setProperty('pickerConfig',{handlers:{onShow:this._decorateMethodMenu.bind(this)}}),this.subscribeTo(this._controls.save,'onActivated',this.onSave.bind(this)),this.subscribeTo(this._controls.repeatMenu,'onMenuItemActivate',this._onRepeatSelected.bind(this)),this.subscribeTo(this._controls.timeMenu,'onMenuItemActivate',this._onTimeSelected.bind(this)),this.subscribeTo(this._controls.timeMenu,'onActivated',this._disableTimeMenuSelection.bind(this)),this.subscribeTo(this._controls.methodMenu,'onMenuItemActivate',this._onMethodSelected.bind(this)),this.subscribeTo(this._controls.date,'onDateChange',function(){e.showFooterText(),this.setActive(true);}),this.subscribeTo(this._controls.time,'onDateChange',function(){e.showFooterText(),this.setActive(true);}),this.subscribeTo(this,'onKeyPressed',t),this.subscribeTo(this._controls.date,'onKeyPressed',t),this.subscribeTo(this._controls.time,'onKeyPressed',t),this.subscribeTo(this._controls.time,'onClick',function(){e._needValidate=true;var t=e.getContainer().parent();t.add(t.find('*')).removeAttr('unselectable').off('selectstart');}),this.subscribeTo(this._controls.date,'onClick',function(){e._needValidate=true;var t=e.getContainer().parent();t.add(t.find('*')).removeAttr('unselectable').off('selectstart');});var a=[{validator:this._validateEmptyDate.bind(this),errorMessage:rk('Необходимо указать дату напоминания')},{validator:this._validatePastDate.bind(this),errorMessage:rk('Дата напоминания не может быть в прошлом')}];this.subscribeTo(this._controls.date,'onAfterShow',function(){this.setValidators(a);});var r=[{validator:this._validateEmptyTime.bind(this),errorMessage:rk('Необходимо указать время напоминания')},{validator:this._validatePastTime.bind(this),errorMessage:rk('Время напоминания не может быть в прошлом')},{validator:this._validateTimeDifference.bind(this),errorMessage:rk('Оповещение необходимо регистрировать не позднее, чем за 5 минут до начала события')}];this.subscribeTo(this._controls.time,'onAfterShow',function(){this.setValidators(r);}),setTimeout(function(){e._controls.date.setActive(true);},500);},destroy:function(){d.superclass.destroy.call(this),this._controls=this._dom=null;},showFooterText:function(){if(this._controls.date&&this._controls.time&&this._controls.date.getDate()&&this._controls.time.getDate()){var t=this._controls.date.getDate(),i=this._controls.time.getDate(),s=this._options.footerText,o=rk('Напоминание $date$t$%d.%m.%y$ в $date$t$%H:%M$'),a={date:new Date(t.getFullYear(),t.getMonth(),t.getDate(),i.getHours(),i.getMinutes(),0,0)};if(this._options.startDate=new Date(a.date),a.date=n.getNearestDate(new Date(this._options.startDate),this._selectedRepeat),this._options.footerText=s=e(a,o),this._selectedRepeat)s='<div class="icon-16 icon-Refresh icon-primary"></div>'+'<div class="footerText">'+s+'</div><div class="clr"></div>';this._dom.footer.html(s);}},_onRepeatSelected:function(t,e){this._updateRepeatMenu(e);},_openRepeatPanel:function(){var t=this,e=this.getLinkedContext();e.setValue('ending',this._options.ending),e.setValue('every',this._options.every),e.setValue('period',this._options.period),e.setValue('times',this._options.times),e.setValue('date',this._options.endDate?this._options.endDate:this._options.startDate),e.setValue('startDate',this._options.startDate),require(['SBIS3.CONTROLS/FloatArea','js!SBIS3.Notes.NotificationRepeat'],function(e){new e({visible:true,parent:t,opener:t,template:'<component data-component="SBIS3.Notes.NotificationRepeat">'+'<option name="ending" bind="ending"></option>'+'<option name="every" bind="every"></option>'+'<option name="period" bind="period"></option>'+'<option name="times" bind="times"></option>'+'<option name="date" bind="date"></option>'+'<option name="startDate" bind="startDate"></option>'+'</component>',element:$('<div class="ws-note__repeat-form"></div>'),target:t.getContainer(),animationLength:0,autoCloseOnHide:true,activableByClick:false,corner:'tl',closeButton:true,verticalAlign:{side:'top',offset:50},horizontalAlign:{side:'left',offset:50},handlers:{onClose:function(){var e=this.getLinkedContext();t._options.period=e.getValue('period'),t._options.every=e.getValue('every'),t._options.ending=e.getValue('ending'),t._options.times=e.getValue('times'),t._options.endDate=e.getValue('date'),t.showFooterText(),this.destroy();}},closeByExternalClick:true,closeByExternalOver:false}).show();});},_getFirstAvailableMethod:function(){var t=this._controls.methodMenu.getItems(),e;if(!t)return null;for(var i=0;i<t.getCount();i++)if(e=t.at(i).getId(),!this._options.availabilityErrors[e])return this._selectedMethod=e,e;return null;},_validateEmptyDate:function(){if(this._needValidate)return null!=this._controls.date.getDate();else return true;},_validateEmptyTime:function(){if(this._needValidate)return null!=this._controls.time.getDate();else return true;},_validatePastDate:function(){var t=this._controls.date.getDate();if(this._needValidate&&t)return new Date().setHours(0,0,0,0)<=t;else return true;},_validatePastTime:function(){var t=this._controls.date.getDate(),e=this._controls.time.getDate();if(this._needValidate&&t&&e){var i=new Date(t.getFullYear(),t.getMonth(),t.getDate(),e.getHours(),e.getMinutes(),0,0);return new Date()<i;}else return true;},_validateTimeDifference:function(){var t=this._controls.date.getDate(),e=this._controls.time.getDate();if(this._needValidate&&t&&e){var i=new Date(t.getFullYear(),t.getMonth(),t.getDate(),e.getHours(),e.getMinutes(),0,0)-new Date();return i<=0||i>300000;}else return true;},_decorateMethodMenu:function(){for(var t=this._options.availabilityErrors,e=this._controls.methodMenu.getPicker()&&this._controls.methodMenu.getItemsInstances(),i,s,o=0;o<t.length;o++)if(s=t[o],s)if(i=e[o],i.setEnabled(false),!i.getContainer().hasClass('ws-note-notification-form__method_disabled'))i.getContainer().addClass('ws-note-notification-form__method_disabled').append('<div class="ws-note-notification-form__error">'+s+'</div>');this._disableMenuSelection(this._controls.methodMenu);},_disableMenuSelection:function(t){if(t.getPicker)t.getPicker();t.getItemsInstances();var e=t.getContainer();e.add(e.find('*')).attr('unselectable','on').on('selectstart',false);},_disableTimeMenuSelection:function(){this._disableMenuSelection(this._controls.timeMenu);},_disableRepeatMenuSelection:function(){this._disableMenuSelection(this._controls.repeatMenu);},_updateRepeatMenu:function(t){var e=this._controls.repeatMenu,i=e.getItems().getRecordById(t);if(e.setCaption(i.get('title')),i){if(this._selectedRepeat=t,6==t)this._openRepeatPanel();this.showFooterText();}this._controls.date.setActive(true);},_updateMethodMenu:function(t){var e=this._controls.methodMenu,i=e.getItems().getRecordById(t);if(this._doNotNotify=3==t,i)e.setCaption(i.get('title')),e.setIcon('sprite:icon-16 icon-primary icon-'+a[t]),this._selectedMethod=t;if(this._doNotNotify)this._controls.timeMenu.getContainer().addClass('ws-hidden'),this._dom.date.addClass('ws-hidden'),this._dom.custom.addClass('ws-hidden'),this._dom.repeat.addClass('ws-hidden'),this._dom.footer.addClass('ws-hidden');else this._controls.timeMenu.getContainer().removeClass('ws-hidden'),this._dom.date.removeClass('ws-hidden'),this._dom.custom.removeClass('ws-hidden'),this._dom.repeat.removeClass('ws-hidden'),this._dom.footer.removeClass('ws-hidden'),this.showFooterText();this._controls.date.setActive(true);},_hasChangedValue:function(){return this._selectedMethod!==this._initialMethod||+this._selectedTime!==+this._initialTime||this._cron!==+this._initialCron||this._selectedRepeat!==+this._selectedRepeat;},onSave:function(){if(this._needValidate=true,!this._doNotNotify){if(!this._controls.date.validate()||!this._controls.time.validate())return;var t=this._controls.date.getDate(),e=this._controls.time.getDate(),i=new Date(t.getFullYear(),t.getMonth(),t.getDate(),e.getHours(),e.getMinutes(),0,0);this._selectedTime=i,this._cron=n.getCronString(i,this._selectedRepeat);}this.save();},_onMethodSelected:function(t,e){this._updateMethodMenu(e);},_onTimeSelected:function(t,e){var i=this._controls.timeMenu.getItems().getRecordById(e);if(this._needValidate=true,!this._doNotNotify)this._selectedTime=r(i),this._controls.date.setDate(new Date(this._selectedTime.getTime())),this._controls.time.setDate(new Date(this._selectedTime.getTime()));if(!this._controls.date.validate()||!this._controls.time.validate())return;this.save();},_initTimeMenu:function(t){var e=3;if(t instanceof Date)this._controls.timeMenu.getItems().each(function(i){if(+r(i)===+t)e=i.getId();}),this._controls.date.setDate(new Date(t.getTime())),this._controls.time.setDate(new Date(t.getTime()));else if(null==t){var i=new Date();if(i.getHours()>=20){var s=new Date(i.setHours(i.getHours()+2));i.setDate(s.getDate()),i.setHours(s.getHours(),s.getMinutes(),0,0);}else i.setHours(20,0,0,0);this._controls.date.setDate(new Date(i.getTime())),this._controls.time.setDate(new Date(i.getTime())),this._selectedTime=i;}this.showFooterText();},_initRepeatMenu:function(t){if(t){var e=n.getRepeatType(t);this._initialRepeat=this._selectedRepeat=e;var i=this._controls.repeatMenu.getItems().getRecordById(this._selectedRepeat);this._controls.repeatMenu.setCaption(i.get('title'));}else this._initialRepeat=this._selectedRepeat=0;},save:function(){if(this._doNotNotify)this.sendCommand('close',false);else{var e=this._options.availabilityErrors[this._selectedMethod];if(e)return void t.alert(e,'error');if(this._hasChangedValue()&&3!==this._selectedMethod)this.sendCommand('close',{method:this._selectedMethod,time:this._selectedTime,cron:this._cron,repeat:this._selectedRepeat});else this.sendCommand('close');}}});return d;});define('html!SBIS3.Notes.NotificationRepeat',['Zametki_localization'],function(){var o=function(o){var n=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,'&#123;&#123;$1&#125;&#125;');return n;};}(),t=function(o){return o.join?o.join(''):o.toString();},i=function(o){return void 0===o?'':o&&'object'==typeof o?t(o):''+o;},e='undefined'!=typeof process,p=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'<div> <div class="ws-window-titlebar-custom"> <span class="ws-window-title" title="'+n(i(rk('Вставить/редактировать ссылку')))+'">'+n(i(rk('Повтор')))+'</span><component data-component="SBIS3.CONTROLS/Button" name="saveRepeat" class="controls-Button controls-Button__primary ws-note__saveRepeat"> <option name="caption">'+n(i(rk('Сохранить')))+'</option> <option name="tooltip">'+n(i(rk('Сохранить период')))+'</option> <option name="activableByClick">false</option> </component> </div> <div class="clr"></div> <div class="ws-note-notification-form__internal-wrapper"> <span class="ws-note-notification-form__caption">'+n(i(rk('Каждый')))+'</span> <component data-component="SBIS3.CONTROLS/NumberTextBox" name="every" class="controls-Button controls-Button__primary"> <option name="tabindex">1</option> <option name="onlyInteger">true</option> <option name="onlyPositive">true</option> <option name="maxLength">2</option> <option name="text">1</option> </component> <component data-component="SBIS3.CONTROLS/Menu/MenuLink" name="periodMenu" class="controls-Menu__hide-menu-header"> <option name="caption">'+n(i(rk('дн.')))+'</option> <option name="idProperty">id</option> <option name="pickerClassName">ws-note-notification-form__period ws-no-select</option> <option name="tabindex">2</option> <option name="activableByClick">false</option> <options name="items" type="array"> <options> <option name="id" type="number">0</option> <option name="title">'+n(i(rk('дн.')))+'</option> </options> <options> <option name="id" type="number">1</option> <option name="title">'+n(i(rk('нед.')))+'</option> </options> <options> <option name="id" type="number">2</option> <option name="title">'+n(i(rk('мес.')))+'</option> </options> <options> <option name="id" type="number">3</option> <option name="title">'+n(i(rk('г.')))+'</option> </options> </options> </component> <div class="clr"></div> <span class="ws-note-notification-form__caption">'+n(i(rk('Окончание')))+'</span> <component data-component="SBIS3.CONTROLS/Radio/Group" name="ending" class="ws-note-notification-form__ending"> <option name="displayProperty">title</option> <options name="items" type="array"> <options> <option name="id" type="number">0</option> <option name="title">'+n(i(rk('Никогда')))+'</option> </options> <options> <option name="id" type="number">1</option> <option name="title">'+n(i(rk('После')))+'</option> </options> <options> <option name="id" type="number">2</option> <option name="title">'+n(i(rk('До')))+'</option> </options> </options> <option name="idProperty">id</option> <option name="tabindex">3</option> </component> <div class="ws-note-notification-form__times"> <component data-component="SBIS3.CONTROLS/NumberTextBox" name="times" class="controls-Button controls-Button__primary"> <option name="tabindex">4</option> <option name="onlyInteger">true</option> <option name="onlyPositive">true</option> <option name="maxLength">2</option> <option name="text">1</option> </component> <span class="ws-note-notification-form__caption">'+n(i(rk('повт.')))+'</span> <component data-component="SBIS3.CONTROLS/Date/Picker" name="date" class="ws-note-notification-form__date"> <option name="mask">DD.MM.YY</option> <option name="tabindex">4</option> </component> </div> </div> <div class="ws-note-notification-form__footer">'+n(i(o.footerText))+'</div> </div>');return(p=n(p))+(e&&-1!==p.indexOf('{{')?String.fromCharCode(8203,8203):'');};return o.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.NotificationRepeat'};},o;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.NotificationRepeat',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-note__repeat-form{width:360px;min-height:200px;height:auto;border-radius:5px;-webkit-border-radius:5px;-moz-border-radius:5px;-o-border-radius:5px;border-color:#e4e4e4;border-width:2px;border-style:solid}.ws-note__saveRepeat{right:44px;top:12px;position:absolute}.ws-note-notification-form__internal-wrapper{display:block;width:100%;padding:10px 20px 20px 20px}.ws-note__repeat-form .clr{clear:both}.ws-note-notification-form__internal-wrapper span.ws-note-notification-form__caption{width:100px;display:block;float:left;height:26px;margin-top:2px}.ws-note-notification-form__internal-wrapper .controls-NumberTextBox{display:block;float:left;width:30px;margin-right:12px}.ws-note-notification-form__period{min-width:30px}.ws-note-notification-form__ending{display:block;float:left;width:100px;margin-left:-6px}.ws-note-notification-form__times{margin-top:24px}.ws-note-notification-form__internal-wrapper .controls-RadioButton.controls-ListView__item{height:26px}'));head.appendChild(style);});}define('js!SBIS3.Notes.NotificationRepeat',['Core/constants','SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.NotificationRepeat','SBIS3.CONTROLS/NumberTextBox','SBIS3.CONTROLS/Radio/Group','SBIS3.CONTROLS/Button','SBIS3.CONTROLS/Date/Picker','SBIS3.CONTROLS/Menu/MenuLink','css!SBIS3.Notes.NotificationRepeat','Zametki_localization','Zametki_localization'],function(t,e,i){'use strict';var s=e.extend({_dotTplFn:i,$protected:{_options:{ending:0,period:0,every:0,times:0,date:new Date(),startDate:new Date()},_dom:null,_controls:null,_initialEvery:null,_initialPeriod:null,_initialEnding:null,_initialDate:null,_initialTimes:null,_initialStartDate:null,_selectedEvery:null,_selectedPeriod:null,_selectedEnding:null,_selectedDate:null,_selectedTimes:null},_modifyOptions:function(t){var e=s.superclass._modifyOptions.apply(this,arguments);return e.footerText=rk('Напоминание не установлено'),e;},$constructor:function(){this._publish('onNotificationRepeatChanged');},init:function(){s.superclass.init.call(this);var t=this;this._dom={footer:this.getContainer().find('.ws-note-notification-form__footer')},this._controls={every:this.getChildControlByName('every'),times:this.getChildControlByName('times'),date:this.getChildControlByName('date'),save:this.getChildControlByName('saveRepeat'),ending:this.getChildControlByName('ending'),periodMenu:this.getChildControlByName('periodMenu')};var e=this.getLinkedContext();if(this._options.every=e.getValue('every'),this._options.period=e.getValue('period'),this._options.ending=e.getValue('ending'),this._options.date=e.getValue('date'),this._options.startDate=e.getValue('startDate'),this._options.times=e.getValue('times'),this._initialEvery=this._selectedEvery=this._options.every,this._initialPeriod=this._selectedPeriod=this._options.period,this._initialEnding=this._selectedEnding=this._options.ending,this._initialDate=this._selectedDate=this._options.date,this._initialStartDate=this._options.startDate,this._initialTimes=this._selectedTimes=this._options.times,this.subscribeTo(this._controls.date,'onKeyPressed',t.onKeyPressed),this.subscribeTo(this,'onKeyPressed',t.onKeyPressed),this._initialPeriod){var i=this._controls.periodMenu.getItems().getRecordById(this._initialPeriod);this._controls.periodMenu.setCaption(i.get('title'));}if(this._initialEnding)this._controls.ending.setSelectedKey(this._initialEnding);if(this._initialDate)this._controls.date.setDate(this._initialDate);if(this._initialTimes)this._controls.times.setText(this._initialTimes);if(this._initialEvery)this._controls.every.setText(this._initialEvery);this._controls.periodMenu.subscribe('onSelectedItemChange',function(e,i){t._selectedPeriod=i,t.showFooterText();}),this._controls.ending.subscribe('onSelectedItemChange',function(e,i){t._selectedEnding=i,t.showFooterText();}),this.subscribeTo(this._controls.date,'onDateChange',function(){t._selectedDate=t._controls.date.getDate(),t.showFooterText(),this.setActive(true);}),this.subscribeTo(this._controls.every,'onTextChange',function(){t._selectedEvery=t._controls.every.getValue(),t.showFooterText(),this.setActive(true);}),this.subscribeTo(this._controls.times,'onTextChange',function(){t._selectedTimes=t._controls.times.getValue(),t.showFooterText(),this.setActive(true);});var n=[{validator:this._validatePastDate.bind(this),errorMessage:rk('Дата напоминания не может быть в прошлом')}];this.subscribeTo(this._controls.date,'onAfterShow',function(){this.setValidators(n);}),this.subscribeTo(this._controls.save,'onActivated',this.onSave.bind(this)),this.subscribeTo(this._controls.periodMenu,'onMenuItemActivate',this._onPeriodSelected.bind(this)),this.subscribeTo(this._controls.ending,'onMenuItemActivate',this._onEndingSelected.bind(this)),t.showFooterText();},onSave:function(){var t=this.getLinkedContext();t.setValue('period',this._selectedPeriod),t.setValue('every',this._selectedEvery),t.setValue('ending',this._selectedEnding),t.setValue('date',this._selectedDate),t.setValue('times',this._selectedTimes),this.sendCommand('close');},onKeyPressed:function(e,i){if(i.which===t.key.enter)self.onSave();},_onPeriodSelected:function(t,e){this._updatePeriodMenu(e);},_onEndingSelected:function(t,e){this._updateEnding(e);},_updatePeriodMenu:function(t){var e=this._controls.periodMenu,i=e.getItems().getRecordById(t);if(e.setCaption(i.get('title')),i)this._selectedPeriod=t,this.showFooterText();},_validatePastDate:function(){var t=this._controls.date.getDate();if(t)return new Date().setHours(0,0,0,0)<=t;else return true;},_updateEnding:function(t){var e=this._controls.ending,i=e.getItems().getRecordById(t);if(e.setCaption(i.get('title')),i)this._selectedEnding=t,this.showFooterText();},showFooterText:function(){},destroy:function(){s.superclass.destroy.call(this),this._controls=this._dom=null;}});return s;});define('html!SBIS3.Notes.Page',['Zametki_localization'],function(){var o=function(o){var t=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(t){for(;o.test(t);)t=t.replace(o,'&#123;&#123;$1&#125;&#125;');return t;};}(),n=function(o){return o.join?o.join(''):o.toString();},e=function(o){return void 0===o?'':o&&'object'==typeof o?n(o):''+o;},a='undefined'!=typeof process,i=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'<div class="ws-note-page"> <component data-component="SBIS3.CONTROLS/Tab/Buttons" name="tabs"> <option name="idProperty">id</option> <option name="displayProperty">title</option> <option name="selectedKey">tags</option> <options name="items" type="Array"> <options> <option name="id">pages</option> <option name="title">'+t(e(rk('По месту размещения')))+'</option> </options> <options> <option name="id">tags</option> <option name="title">'+t(e(rk('По тегам')))+'</option> </options> </options> <option name="tabSpaceTemplate"> <component data-component="SBIS3.CONTROLS/Button" name="addNote"> <option name="className">controls-Button__compactMode ws-note-page__add-button</option> <option name="caption">+ '+t(e(rk('Заметка')))+'</option> <option name="primary" type="boolean" value="true"></option> <option name="tooltip">'+t(e(rk('Создать заметку')))+'</option> <option name="icon">sprite:icon-24 icon-AddButtonNew icon-hover</option> </component><component data-component="SBIS3.CONTROLS/Button" name="addTag"> <option name="className">ws-note-page__add-tag</option> <option name="caption">+ '+t(e(rk('Тег')))+'</option> <option name="tooltip">'+t(e(rk('Создать тег')))+'</option> <option name="visible">false</option> </component> </option> </component> <div class="ws-note-page__filters"> <table style="width: 100%"> <tr> <td style="padding-left: 8px;" class="ws-note__search-form-table"> <component data-component="SBIS3.CONTROLS/SearchForm" name="search" class="ws-note-search"> <option name="placeholder">'+t(e(rk('Найти по тексту заметки')))+'</option> <option name="maxLength">30</option> <option name="startCharacter">3</option> </component> </td> <td style="width: 260px;" class="ws-note__search-form-table"> <component data-component="Deprecated/Controls/FilterButton/FilterButton" name="filter"> <option name="template" value="js!SBIS3.Notes.NotesFilter"></option> <option name="maxWidth" value="200"></option> <option name="mode" value="hover"></option> <option name="browserId" value="browserId111"></option> <option name="tooltip">'+t(e(rk('Установить фильтры отображения')))+'</option> </component> </td> </tr> </table> </div> <component data-component="SBIS3.CONTROLS/ScrollContainer" class="scrollContainerList"> <option name="content"> <component data-component="SBIS3.Notes.AddTag" name="addTagDialog"> <option name="visible">false</option> </component> <component data-component="SBIS3.Notes.TagListView" name="tags" class="ws-note-left-list controls-ListView__orangeMarker"> <option name="visible">false</option> <option name="filterName">Tag</option> <option name="filterPropertyName">Name</option> </component> <component data-component="SBIS3.CONTROLS/ListView" name="pages" class="ws-note-left-list ws-note-left-pages controls-ListView__orangeMarker"> <option name="idProperty">ID</option> <option name="itemTpl">html!SBIS3.Notes.Page/templates/Page</option> <option name="itemContentTpl">html!SBIS3.Notes.Page/templates/PageContent</option> <options name="itemsActions" type="array"></options> <option name="itemsDragNDrop">false</option> <option name="visible" type="boolean" value="false"></option> <option name="emptyHTML"></option> <option name="filterName">Url</option> <option name="filterPropertyName">ID</option> </component> </option> </component> <component data-component="SBIS3.CONTROLS/ScrollContainer" class="scrollContainerNotes"> <option name="content"> <component data-component="SBIS3.Notes.StaticNotesView" name="notes"> <option name="visible">false</option> </component> </option> </component> <div class="ws-clear"></div> </div>');return(i=t(i))+(a&&-1!==i.indexOf('{{')?String.fromCharCode(8203,8203):'');};return o.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.Page'};},o;});define('html!SBIS3.Notes.AddTag',['Zametki_localization'],function(){var o=function(o){var n=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,'&#123;&#123;$1&#125;&#125;');return n;};}(),t=function(o){return o.join?o.join(''):o.toString();},e=function(o){return void 0===o?'':o&&'object'==typeof o?t(o):''+o;},i='undefined'!=typeof process,a=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'<div class="ws-note__tag-addTagForm ws-hidden"> <component data-component="SBIS3.CONTROLS/SearchForm" name="tagName"> <option name="placeholder">'+n(e(rk('введите тег')))+'</option> <option name="trim">true</option> <option name="selectOnClick">true</option> <option name="maxLength">64</option> </component> <div class="ws-note__tag-addTagForm-buttons"> <component data-component="SBIS3.Notes.MenuColor" name="tagColor"> <option name="tooltip">'+n(e(rk('Задать цвет тега')))+'</option> <option name="tabindex">3</option> <option name="idProperty" type="string">id</option> <option name="activableByClick">false</option> </component> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="save" class="controls-IconButton__round-border-24"> <option name="icon">sprite:icon-16 icon-Yes icon-done</option> <option name="tooltip">'+n(e(rk('Сохранить изменения')))+'</option> <option name="tabindex">4</option> </component> </div> <component data-component="SBIS3.CONTROLS/ListView" name="recentTags" class="ws-note__recent-tags"> <option name="idProperty">Id</option> <option name="itemsDragNDrop">false</option> <option name="pageSize">10</option> <option name="itemContentTpl">tmpl!SBIS3.Notes.Tags/Tag</option> <option name="visible">false</option> <options name="itemsActions" type="array"></options> </component> </div>');return(a=n(a))+(i&&-1!==a.indexOf('{{')?String.fromCharCode(8203,8203):'');};return o.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.AddTag'};},o;});define('tmpl!SBIS3.Notes.Tags/Tag',['Core/tmpl/js/tclosure','Zametki_localization'],function(){var e=Array.prototype.slice.call(arguments),t=e[0],r={},a=function e(a,i,o,s,n){function l(){}var c=0,u=void 0!==t&&t?t:arguments[arguments.length-1];void 0===u&&(eval('var thelpers = null;'),u=global.requirejs('View/Runner/tclosure'));var d={};n&&n.isSetts&&(d=n.fullContext||{});var p='string'==typeof o?o:'',g=void 0===r?void 0:r,m={id:[],def:void 0},f=u.configResolver.calcParent(this,'undefined'==typeof currentPropertyName?void 0:currentPropertyName,a),v=this&&this.includedTemplates?this.includedTemplates:{},h=u.getMarkupGenerator(s);try{var T=h.joinElements([h.createTag('span',{class:'controls-ListView__itemCheckBox js-controls-ListView__itemCheckBox'},[],i,m,this),h.createTag('span',{class:'ws-note__tag ws-note__tag_color-'+u.wrapUndef(u.utils.escape(u.getter(a,['item','Color'])))},[h.createText(''+u.wrapUndef(u.utils.escape(u.getter(a,['item','Name']))))],i,m,this)],p,m);m.def&&(T=h.chain(T,m,i),m=void 0);}catch(e){u.templateError('resources/Zametki/Tag/Tag.tmpl',e,a);}return T||'';};return a.includedFunctions={},a.stable=!0,a.toJSON=function(){return{$serialized$:'func',module:'tmpl!SBIS3.Notes.Tags/Tag'};},a;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.AddTag',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-note__tag-addTagForm{width:250px;box-sizing:border-box;margin-left:0;background:#f3f3f3;padding:10px 8px 0 18px;position:relative;min-height:43px}.ws-note__tag-addTagForm .ws-note__recent-tags .controls-ListView__hoveredItem{background:0 0}.ws-note__tag-addTagForm .controls-SearchForm{border-radius:0;-moz-border-radius:0;-webkit-border-radius:0;width:160px}.ws-note__tag-addTagForm .ws-note__tag-addTagForm-buttons{float:right}.ws-note__tag-addTagForm .controls-SearchForm.controls-TextBox,.ws-note__tag-addTagForm .controls-SearchForm.controls-TextBox.ws-has-focus,.ws-note__tag-addTagForm .controls-SearchForm.controls-TextBox:hover{background:#fff}.ws-note__tag-addTagForm .ws-note__recent-tags{margin-top:8px;max-width:270px;background:0 0}.ws-note__tag-addTagForm .ws-note__recent-tags span.ws-note__tag{cursor:pointer}.ws-note__tag-addTagForm .controls-SearchForm .controls-TextBox__afterFieldWrapper{display:none}.ws-note__tag-addTagForm .controls-SearchForm.controls-TextBox .controls-TextBox__fieldWrapper{margin:0 4px 0 -8px}'));head.appendChild(style);});}define('js!SBIS3.Notes.AddTag',['Core/helpers/String/escapeHtml','Core/EventBus','SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.AddTag','WS.Data/Source/SbisService','js!SBIS3.BL.Note','js!SBIS3.Notes.Utils.Info','SBIS3.CONTROLS/TextBox','SBIS3.CONTROLS/CheckBox','js!SBIS3.Notes.MenuColor','SBIS3.CONTROLS/Button/IconButton','SBIS3.CONTROLS/ListView','SBIS3.CONTROLS/SearchForm','tmpl!SBIS3.Notes.Tags/Tag','css!SBIS3.Notes.AddTag','Zametki_localization','Zametki_localization'],function(t,o,s,e,i,n,a){'use strict';var r=s.extend({_dotTplFn:e,$protected:{_controls:null,_tagValue:'',_tagColor:0,_newColor:0},$constructor:function(){this._publish('onCloseDialog');},init:function(){r.superclass.init.call(this),this._cacheControls(),this._controls.recentTags.setDataSource(new i({endpoint:{address:'/notes/service/',contract:'Note'},idProperty:'Name',binding:{query:'GetRecentTags'}}),true),this.subscribeTo(this,'onAfterVisibilityChange',function(t,o){if(o)this._controls.tagName.getContainer().find('input')[0].focus();}.bind(this)),this.subscribeTo(this,'onFocusOut',function(){if(''===this._controls.tagName.getText())this._controls.tagName.clearMark();this.setVisible(false);}.bind(this)),this.subscribeTo(this._controls.recentTags,'onDataLoad',function(t,o){if(o.getCount())this.show();}),this.subscribeTo(this._controls.tagName,'onSearchStart',this._onSearch.bind(this)),this.subscribeTo(this._controls.tagName,'onSearch',this._onSearch.bind(this)),this.subscribeTo(this._controls.tagName,'onReset',this._onSearch.bind(this)),this.subscribeTo(this._controls.tagColor,'onColorSelected',this._onColorize.bind(this)),this.subscribeTo(this._controls.recentTags,'onItemClick',this._onTagClick.bind(this)),this.subscribeTo(this._controls.save,'onActivated',this._onSave.bind(this));},destroy:function(){this._controls=null,r.superclass.destroy.call(this);},_cacheControls:function(){this._controls=(this.getChildControls()||[]).reduce(function(t,o){var s=o.getName();if(s)t[s]=o;return t;},{});},_onSearch:function(){var t=this._controls.recentTags,o=this._controls.tagName.getText();if(t.hide(),o){var s=t.getFilter()||{};if(s.SearchQuery!=o)s.SearchQuery=o,t.setFilter(s);}},_onColorize:function(t,o){this._newColor=+o,this._controls.tagName.setActive(true);},_addTag:function(s,e){var i=this,r=this._controls.tagName;n.addIndependentTag(s,e).addCallbacks(function(t){if(n.isDemo())a.showMessageDialog({message:rk('В демо-режиме нельзя добавлять теги в реестр'),status:'error'}),i._closeDialog();else o.channel('NotesEvents').notify('onTagAdded',null,[]),i._closeDialog('add');},function(o){r.markControl(t(o.message),true);});},_editTag:function(s,e){var i=this,a=i._controls.tagName;n.updateTag(s,s,e).addCallbacks(function s(e){if(''===e)o.channel('NotesEvents').notify('onTagUpdated',null,null),i._closeDialog('update');else a.markControl(t(e),true);},function o(s){a.markControl(t(s.details),true);});},_onSave:function(){var t=this._controls.tagName,o=t.getText();if(o&&o.length)o=o.trim();if(o)if(this._tagValue!==o)if(o.length<3)t.markControl(rk('Длина тега должна быть не менее 3-х символов'),true);else this._addTag(o,this._newColor);else if(this._tagColor!==this._newColor)this._editTag(o,this._newColor);else this._closeDialog('cancel');else t.markControl(rk('Необходимо ввести тег'),true);},_onTagClick:function(t,o,s,e){if($(e).hasClass('ws-note__tag'))this._tagValue=s.get('Name'),this._tagColor=this._newColor=s.get('Color'),this._controls.tagName.setText(this._tagValue),this._controls.tagName.setActive(true),this._controls.tagColor.setIcon('sprite:icon-16 icon-primary ws-note-tag-color ws-note-tag-color_color-'+this._tagColor);},_closeDialog:function(t){this._notify('onCloseDialog',t),this.setVisible(false),this._tagValue='',this._newColor=this._tagColor=0,this._controls.tagName.setText(''),this._controls.tagName.clearMark(),this._controls.tagColor.setIcon('sprite:icon-16 icon-primary ws-note-tag-color ws-note-tag-color_color-0'),this._controls.recentTags.hide();}});return r;});define('html!SBIS3.Notes.TagListView/templates/Tag',['Zametki_localization'],function(){var e=function(e){var t=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(t){for(;e.test(t);)t=t.replace(e,'&#123;&#123;$1&#125;&#125;');return t;};}(),r=function(e){return e.join?e.join(''):e.toString();},n=function(e){return void 0===e?'':e&&'object'==typeof e?r(e):''+e;},o='undefined'!=typeof process,i=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'');return e.className='ws-note-used-tag ws-clickable',i+=' '+t(n(e.defaultItemTpl(e))),(i=t(i))+(o&&-1!==i.indexOf('{{')?String.fromCharCode(8203,8203):'');};return e.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.TagListView/templates/Tag'};},e;});define('html!SBIS3.Notes.TagListView/templates/TagContent',['Zametki_localization'],function(){var t=function(t){var n=function(){var t={'&':'&#38;','<':'&#60;','>':'&#62;','"':'&#34;','\'':'&#39;','/':'&#47;'},n=/&(?!#?\w+;)|<|>|"|'|\//g;return function(o){return o?o.toString().replace(n,function(n){return t[n]||n;}):o;};}(),o=function(){var t=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;t.test(n);)n=n.replace(t,'&#123;&#123;$1&#125;&#125;');return n;};}(),e=function(t){return t.join?t.join(''):t.toString();},i=function(t){return void 0===t?'':t&&'object'==typeof t?e(t):''+t;},r='undefined'!=typeof process,a=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'');return t.item.get('Name')?a+=' <span class="ws-note__tag ws-note__tag_color-'+o(i(t.item.get('Color')))+'">'+o(i(n(t.item.get('Name'))))+'</span> <div class="ws-note-tag__actions"> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="edit'+o(i(n(t.item.get('Id'))))+'"> <option name="icon">sprite:icon-24 icon-Edit icon-primary</option> <option name="tooltip">'+o(i(rk('Редактировать тег')))+'</option> <options name="handlers"> <option name="onActivated" type="function"> js!SBIS3.Notes.TagListView:prototype._onEdit </option> </options> </component> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="delete'+o(i(n(t.item.get('Id'))))+'" class="controls-Button__deleteTag"> <option name="icon">sprite:icon-24 icon-Erase icon-error</option> <option name="tooltip">'+o(i(rk('Удалить тег')))+'</option> <options name="handlers"> <option name="onActivated" type="function"> js!SBIS3.Notes.TagListView:prototype._onRemove </option> </options> </component> </div> ':a+=' <span>'+o(i(rk('Без тегов')))+'</span> ',a+=' <span class="ws-note-tag__count">'+o(i(t.item.get('Count')))+'</span>',(a=o(a))+(r&&-1!==a.indexOf('{{')?String.fromCharCode(8203,8203):'');};return t.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.TagListView/templates/TagContent'};},t;});define('js!SBIS3.Notes.TagListView',['Core/core-functions','Core/core-instance','Core/helpers/String/escapeHtml','Core/constants','SBIS3.CONTROLS/ListView','WS.Data/Source/SbisService','html!SBIS3.Notes.TagListView/templates/Tag','html!SBIS3.Notes.TagListView/templates/TagContent','js!SBIS3.BL.Note','js!SBIS3.Notes.TouchDragNDropMixin','Core/EventBus','SBIS3.CONTROLS/Utils/InformationPopupManager','SBIS3.CONTROLS/Button/IconButton','js!SBIS3.Notes.MenuColor','Zametki_localization','Zametki_localization'],function(t,e,o,i,n,a,s,r,d,l,g,c){'use strict';var _=n.extend([l],{$protected:{_options:{itemTpl:s,itemContentTpl:r,idProperty:'Id',itemsActions:[],editingTemplate:'<component data-component="SBIS3.CONTROLS/TextBox" name="tagName" class="ws-note-tagList__edit">'+'<option name="text" bind="Name"></option>'+'<option name="tabindex">1</option>'+'<option name="maxLength">64</option>'+'</component>'+'<component data-component="SBIS3.Notes.MenuColor" name="tagColor">'+'<option name="color" bind="Color"></option>'+'</component>',editMode:'toolbar',emptyHTML:''},_doNotRefreshNotes:false,_lastHoveredItemId:0,_tagNameField:null,_tagColor:0},init:function(){_.superclass.init.call(this);var t=this;this.setDataSource(new a({endpoint:{address:'/notes/service/',contract:'Note'},binding:{query:'GetUsedTags'},idProperty:'Id'}),true),this.subscribeTo(this,'onAfterBeginEdit',this.onAfterBeginEdit.bind(this)),this.subscribeTo(this,'onEndEdit',this._onEndEdit.bind(this));var e=g.channel('NotesEvents');this.subscribeTo(e,'onTagFormOpened',function(){t._isTagFormOpened=true;}),this.subscribeTo(e,'onTagFormClosed',function(){t._isTagFormOpened=false;});var o=g.channel('TagsEvents');if(this.subscribeTo(o,'onRemoveTagInList',this.onRemoveTag.bind(this)),this.subscribeTo(o,'onUpdateTagInList',this.onUpdateTag.bind(this)),this.subscribeTo(this,'onAfterEndEdit',function(t,e){this._isEdited=false;}),i.browser.isMobilePlatform)this.subscribeTo(this,'onDrawItems',function(t,e){this.getContainer().on('touchstart touchend','.ws-note-tag__actions .controls-Button__deleteTag, .ws-note-tag__actions .controls-Button__deleteTag *',function(t){t.stopPropagation();});});},_onServerMessage:function(){if(!this._isTagFormOpened)this.reload();},_setItemsDragNDrop:function(t){this._options.itemsDragNDrop=t,this._getItemsContainer()[t?'on':'off']('mousedown touchstart','.js-controls-ListView__item .ws-note__tag',this._getDragInitHandler());},onAfterBeginEdit:function(t,e){if(!this._tagNameField)this._tagNameField=this._editInPlace.getChildControlByName('tagName'),this._tagNameField.getContainer().on('keyup','.controls-TextBox__field',this._onKeyUp.bind(this)),this._tagColor=this._editInPlace.getChildControlByName('tagColor'),this._tagColor.setColor(e.get('Color'));},_mouseLeaveHandler:function(){if(!i.browser.isMobilePlatform)_.superclass._mouseLeaveHandler.apply(this,arguments);},_swipeHandler:function(t){var e=$(t.target);if(!e.hasClass('ws-note__tag'))if(t.swipestart.coords[0]-t.swipestop.coords[0]>10)this._changeHoveredItem(e);},_onKeyUp:function(t){if(t.keyCode===i.key.enter)t.preventDefault(),t.stopPropagation();},_onEndEdit:function(t,e,i){var n=this,a=n.getContainer();if(i){var s=this._tagNameField.getText(),r=this._tagColor.getColor(),l=this.getItems().getRecordById(this.getSelectedKey());if(s&&s.length)s=s.trim();if(s.length<3){if(t)n.reload().addCallback(function(){n._tagNameField.getContainer().off('keyup','.controls-TextBox__field',n._onKeyUp),n._tagColor=n._tagNameField=null,n.reactivateEdit(l,s,r),n._tagNameField=n._editInPlace.getChildControlByName('tagName'),n._tagColor=n._editInPlace.getChildControlByName('tagColor'),n._tagNameField.setText(s),n._tagColor.setColor(r),n._tagNameField.getContainer().on('keyup','.controls-TextBox__field',n._onKeyUp.bind(this)),n._tagNameField.markControl(rk('Длина тега должна быть не менее 3-х символов'),true);});}else g.channel('NotesEvents').notify('onBeforeTagUpdate'),d.updateTag(l.get('Name'),s,r).addCallbacks(function t(e){if(''===e)n._tagNameField.getContainer().off('keyup','.controls-TextBox__field',n._onKeyUp),n._tagNameField=null,n._notify('onTagUpdated',l.get('Name'),s,r),a.find('.ws-note-tag__actions').removeClass('ws-hidden'),a.find('.ws-note-used-tag[data-id="'+l.get('Id')+'"] > .ws-note__tag').css('visibility','visible'),n.reload();else n.reactivateEdit(l),n._tagNameField.setText(s),n._tagColor.setColor(r),n._tagNameField.markControl(o(e),true);},function t(e){n.reactivateEdit(l,s),n._tagColor.setColor(r),n._tagNameField.markControl(o(e.details),true);});}else a.find('.ws-note-tag__actions').removeClass('ws-hidden'),a.find('.ws-note-used-tag > .ws-note__tag').css('visibility','visible');if(t)t.setResult('NotSave');},reactivateEdit:function(t){var e=this.getContainer(),o=t.get('Id');this.setSelectedKeys([o]),this.sendCommand('beginEdit',t),e.find('.ws-note-tag__actions').addClass('ws-hidden'),e.find('.ws-note-used-tag[data-id="'+o+'"] > .ws-note__tag').css('visibility','hidden');},_beginDragHandler:function(t,e){if(!$(e.target).hasClass('ws-note__tag'))return false;var o=$(e.target).closest('.ws-note-used-tag');if(o.length&&'00000000-0000-0000-0000-000000000000'===o.data('id'))return false;_.superclass._beginDragHandler.apply(this,arguments),i.$body.addClass('dragdropTag').removeClass('dragdropNote');},_onDragHandler:function(t,e){if(e.originalEvent.preventDefault(),_.superclass._onDragHandler.apply(this,arguments),'touchmove'===e.type){var o=e.originalEvent.changedTouches[0],i=document.elementFromPoint(o.clientX,o.clientY),n=$(i).closest('.ws-note_static');if(n.length){var a=n.data('id');$('.ws-note_static').removeClass('controls-ListView__hoveredItem'),$('.ws-note_static[data-id='+a+']').addClass('controls-ListView__hoveredItem');}}},onUpdateTag:function(t,e){var o=this.getHoveredItem().record||this.getItems().at(this.getSelectedIndex());if(o&&!this._isEdited){var i=o.get('Id'),n=this.getContainer();this._lastHoveredItemId=i,this._isEdited=true,e.sendCommand('beginEdit',o),n.find('.ws-note-tag__actions').addClass('ws-hidden'),n.find('.ws-note-used-tag[data-id="'+i+'"] > .ws-note__tag').css('visibility','hidden');}},_onEdit:function(){g.channel('TagsEvents').notify('onUpdateTagInList',this);},onRemoveTag:function(){var e=this,i=this.getHoveredItem().record.get('Name');c.showConfirmDialog({message:rk('Удалить тег')+' "'+o(i)+'" '+rk('из всех заметок?'),parent:e,opener:e},function(){d.deleteTag(i).addCallbacks(function(){e.reload(),g.channel('NotesEvents').notify('onTagRemoved',null,i);},function(e){t.alert(e.details,'error');});});},_onRemove:function(){g.channel('TagsEvents').notify('onRemoveTagInList');},_endDragHandler:function(t){var o=new Date().getTime();if(this._lastDropTime&&o-this._lastDropTime<500)return;this._lastDropTime=o,i.$body.removeClass('dragdropTag');var n=t.getSource();if(n&&n.getCount()>0){var a=t.getTarget();if(a)if(e.instanceOfModule(t.getOwner(),'SBIS3.Notes.StaticNoteListView')){var s=n.at(0).getModel().getId(),r=a.getModel().getId();if(r&&s)g.channel('NoteCommands').notify('AddTag',s,r);}}}});return _;});define('html!SBIS3.Notes.TagEditor',['Zametki_localization'],function(){var o=function(o){var n=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,'&#123;&#123;$1&#125;&#125;');return n;};}(),t=function(o){return o.join?o.join(''):o.toString();},e=function(o){return void 0===o?'':o&&'object'==typeof o?t(o):''+o;},i='undefined'!=typeof process,a=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'<div class="ws-note__tag-editor ws-hidden"> <component data-component="SBIS3.CONTROLS/CheckBox" name="addTag"> <option name="tabindex">2</option> </component> <component data-component="SBIS3.CONTROLS/TextBox" name="tagName"> <option name="text">'+n(e(o.tagValue))+'</option> <option name="tabindex">1</option> <option name="maxLength">64</option> </component> <div class="ws-note__tag-editor-buttons"> <component data-component="SBIS3.Notes.MenuColor" name="colorize"> <options> <option name="tooltip">'+n(e(rk('Задать цвет тега')))+'</option> <option name="activableByClick">false</option> <option name="tabindex">3</option> </options> </component> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="save" class="controls-IconButton__round-border-24"> <option name="icon">sprite:icon-16 icon-Yes icon-done</option> <option name="tooltip">'+n(e(rk('Сохранить изменения')))+'</option> <option name="tabindex">4</option> </component> <component data-component="SBIS3.CONTROLS/Button/IconButton" name="cancel" class="controls-PopupMixin__closeButton ws-note__tag-editor-close"> <option name="tooltip">'+n(e(rk('Отмена')))+'</option> <option name="tabindex">5</option> </component> </div> </div>');return(a=n(a))+(i&&-1!==a.indexOf('{{')?String.fromCharCode(8203,8203):'');};return o.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.TagEditor'};},o;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.TagEditor',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-note__tag-editor{width:399px;box-sizing:border-box;margin-left:0;background:#f3f3f3;padding:4px 8px 8px 8px;position:relative}.ws-note__tag-editor>.controls-TextBox{width:358px;float:right}.ws-note__tag-editor-buttons{clear:both;text-align:right;padding-top:8px}.ws-note__tag-editor-buttons .controls-IconButton__round-border{width:28px;height:28px;line-height:26px!important}.ws-note__tag-editor .ws-note__tag-editor-buttons .controls-IconButton.ws-note__tag-editor-close{position:relative!important;margin-right:-9px;top:0!important}.ws-note__tag-editor-buttons span.controls-IconButton{margin-left:4px}.ws-note__recent-tags .controls-editInPlace .controls-editInPlace__editor{padding:0}.controls-editInPlace__editor .ws-note__tag-editor span.controls-CheckBox{margin-top:3px}'));head.appendChild(style);});}define('js!SBIS3.Notes.TagEditor',['Core/helpers/String/escapeHtml','Core/EventBus','SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.TagEditor','js!SBIS3.BL.Note','SBIS3.CONTROLS/TextBox','js!SBIS3.Notes.MenuColor','SBIS3.CONTROLS/CheckBox','SBIS3.CONTROLS/Button/IconButton','css!SBIS3.Notes.TagEditor','Zametki_localization','Zametki_localization'],function(t,o,e,s,n){'use strict';var i=e.extend({_dotTplFn:s,$protected:{_options:{tagId:0,tagValue:rk('название тега'),tagColor:0,newTagColor:null,tagChecked:false,activatedByParent:false}},$constructor:function(){},_modifyOptions:function(t){var o=i.superclass._modifyOptions.apply(this,arguments);return o.tagValue=rk('название тега'),o;},init:function(){i.superclass.init.call(this),this._controls={},this._controls.addTag=this.getChildControlByName('addTag'),this._controls.tagName=this.getChildControlByName('tagName'),this._controls.tagColor=this.getChildControlByName('colorize'),this._controls.save=this.getChildControlByName('save'),this._controls.cancel=this.getChildControlByName('cancel'),this._controls.tagName.getContainer().on('keyup',this._onKeyUp.bind(this)),this.subscribeTo(this._controls.tagColor,'onColorSelected',this._onColorize.bind(this)),this.subscribeTo(this._controls.save,'onActivated',this._onSave.bind(this)),this.subscribeTo(this._controls.cancel,'onActivated',this._onCancel.bind(this)),this.subscribeTo(o.channel('TagsEvents'),'onBeginEditTag',this.prepareValues.bind(this)),this.subscribeTo(this,'onActivate',this._onActivate.bind(this));},_onActivate:function(){if(this._options.activatedByParent){var t=this._controls.recentTags.getSelectedKeys();this._controls.tagName.setText(this._options.tagValue),this._controls.tagColor.setIcon('sprite:icon-16 icon-primary ws-note-tag-color ws-note-tag-color_color-'+this._options.tagColor),this._options.tagChecked=t.indexOf(this._options.tagId)>=0,this._controls.addTag.setChecked(this._options.tagChecked),this._options.activatedByParent=false;}},prepareValues:function(t,o){this._controls.recentTags=o,this._options.activatedByParent=true,this._onActivate();},_onKeyUp:function(t){if(13===t.keyCode)t.preventDefault(),t.stopPropagation(),this._onSave();},_onColorize:function(t,o){this._options.newTagColor=+o;},_onSave:function(){var o=this,e=this._options.tagId,s=this._controls.tagName,i=this._options.tagValue,a=s.getText(),r=this._options.tagColor,c=this._options.newTagColor,l=this._controls.addTag.isChecked(),h=[].concat(this._controls.recentTags.getSelectedKeys());if(i!==a||null!==c&&c!==r){if(a&&a.length)a=a.trim(),s.setText(a);if(a.length<3)return void s.markControl(rk('Длина тега должна быть не менее 3-х символов'),true);n.updateTag(i,a,null!==c?c:r).addCallbacks(function n(d){if(''===d){if(o._options.tagChecked!==l){if(l)h=h.concat(e);else h.splice(h.indexOf(e),1);o._controls.recentTags.setSelectedKeys(h);}o._controls.recentTags._notify('onTagUpdated',i,a,null!==c?c:r),o._controls.recentTags.reload();}else s.markControl(t(d),true);},function o(e){s.markControl(t(e.details),true);});}else{if(this._options.tagChecked!==l){if(l)h=h.concat(e);else h.splice(h.indexOf(e),1);this._controls.recentTags.setSelectedKeys(h);}this._controls.recentTags.sendCommand('cancelEdit');}},_onCancel:function(){this._controls.recentTags.sendCommand('cancelEdit');},destroy:function(){this._controls.tagName.getContainer().off('keydown',this._onKeyDown),i.superclass.destroy.call(this);}});return i;});define('html!SBIS3.Notes.Page/templates/Page',['Zametki_localization'],function(){var e=function(e){var t=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(t){for(;e.test(t);)t=t.replace(e,'&#123;&#123;$1&#125;&#125;');return t;};}(),r=function(e){return e.join?e.join(''):e.toString();},n=function(e){return void 0===e?'':e&&'object'==typeof e?r(e):''+e;},o='undefined'!=typeof process,a=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'');return e.className='ws-note-used-tag ws-clickable',a+=' '+t(n(e.defaultItemTpl(e))),(a=t(a))+(o&&-1!==a.indexOf('{{')?String.fromCharCode(8203,8203):'');};return e.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.Page/templates/Page'};},e;});define('html!SBIS3.Notes.Page/templates/PageContent',['Zametki_localization'],function(){var e=function(e){var t=function(){var e={'&':'&#38;','<':'&#60;','>':'&#62;','"':'&#34;','\'':'&#39;','/':'&#47;'},t=/&(?!#?\w+;)|<|>|"|'|\//g;return function(n){return n?n.toString().replace(t,function(t){return e[t]||t;}):n;};}(),n=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(t){for(;e.test(t);)t=t.replace(e,'&#123;&#123;$1&#125;&#125;');return t;};}(),r=function(e){return e.join?e.join(''):e.toString();},o=function(e){return void 0===e?'':e&&'object'==typeof e?r(e):''+e;},i='undefined'!=typeof process,a=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,n(o(t(e.item.get('PageTitle'))))+' <div class="ws-note-page__breadcrumbs">'+n(o(t(e.item.get('Breadcrumbs'))))+'</div> <span class="ws-note-tag__count">'+n(o(e.item.get('CountNotes')))+'</span>');return(a=n(a))+(i&&-1!==a.indexOf('{{')?String.fromCharCode(8203,8203):'');};return e.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.Page/templates/PageContent'};},e;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.NotesView',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-notes-container,.ws-notes-holder{position:absolute;top:0;left:0;overflow:visible!important}.ws-note .ws-note__content{overflow:hidden;padding:6px 8px}.ws-note .ws-note__scroll{height:100%}.ws-note__content .ws-basic-style img{cursor:pointer}.ws-note__body{box-shadow:1px 0 4px 0 #ccc}.ws-note__body .ws-basic-style .ws-note__checkable,.ws-note__body .ws-basic-style li,.ws-note__body .ws-basic-style p{word-wrap:break-word;line-height:140%}.ws-note__checkable a{pointer-events:auto}.ws-note__body .ws-basic-style .ws-note__checkable{margin:0 0 0 -25px;padding:0 0 0 25px}.ws-is-mobile-chrome-ios .ws-note__checkable_unchecked:before,.ws-is-mobile-platform .ws-note__checkable_unchecked:before,.ws-is-mobile-safari .ws-note__checkable_unchecked:before{background-position:0 1px}.ws-is-mobile-chrome-ios .ws-note__checkable_checked:before,.ws-is-mobile-platform .ws-note__checkable_checked:before,.ws-is-mobile-safari .ws-note__checkable_checked:before{background-position:0 -15px}.ws-note__body .ws-basic-style>ol,.ws-note__body .ws-basic-style>ul{margin-top:0;margin-bottom:0}.ws-note__body .ws-basic-style .content-wrap li,.ws-note__body .ws-basic-style .content-wrap>p,.ws-note__body .ws-basic-style li,.ws-note__body .ws-basic-style>p{margin-bottom:0}.ws-note-header-image{vertical-align:top;padding:0;margin:6px 2px 0 8px;color:#999!important}.ws-note-calendar-html{color:#999;display:inline-block;padding:5px 0 0 0;font-size:12px;margin:0}.ws-note-tmp{font-size:0;width:1px;height:1px;float:left;display:inline;margin:0;padding:0}.ws-note__checkable{list-style-type:none;line-height:16px;margin-left:-25px;padding-left:25px;pointer-events:none}.ws-note__body .ws-note__checkable{min-height:16px}.ws-note__checkable:after{content:\'.\';font-size:1px;color:transparent;display:inline;float:right;line-height:0}.ws-is-ie10 .ws-note__checkable:after{float:none}.ws-note__checkable:before{margin-left:-25px;cursor:pointer}.ws-note__checkable_checked:before,.ws-note__checkable_unchecked:before{display:inline-block;margin-right:9px;cursor:pointer;content:\'.\';color:transparent;background:url(/resources/SBIS3.CONTROLS/themes/online/img/CheckBox.v1516270649826335cf4508dd597be4bfc9caa3e08b901.png) 0 0 no-repeat;width:16px;height:16px;vertical-align:text-top;pointer-events:auto}.ws-note__checkable_checked:before{background-position:0 -16px}li.ws-note__checkable_checked{text-decoration:line-through;color:#999}.ws-note-tags-html{position:relative;overflow:hidden;padding:0 8px;font-size:0;width:100%;box-sizing:border-box}.ws-note__tag{font-size:11px;display:inline-block;padding:0 4px;-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px;border-width:1px;border-style:solid;white-space:nowrap;word-spacing:normal;vertical-align:top;line-height:16px;max-width:95%;margin:2px 4px 3px 4px;text-overflow:ellipsis;overflow:hidden}.ws-note__has-calendar .ws-note__tag{margin-bottom:0;margin-top:4px}.ws-note-tag-color_color-0,.ws-note__tag_color-0{background:#fff}.ws-note__tag_color-0{border-color:#c8c8c8;color:#000}.ws-note-tag-color_color-1,.ws-note__tag_color-1{background:red}.ws-note__tag_color-1{border-color:red;color:#fff}.ws-note-tag-color_color-2,.ws-note__tag_color-2{background:#fec63f}.ws-note__tag_color-2{border-color:#fec63f;color:#000}.ws-note-tag-color_color-3,.ws-note__tag_color-3{background:#72be44}.ws-note__tag_color-3{border-color:#72be44;color:#fff}.ws-note-tag-color_color-4,.ws-note__tag_color-4{background:#587ab0}.ws-note__tag_color-4{border-color:#587ab0;color:#fff}.ws-note-tags{padding:0 8px}.ws-note-tags .ws-note__tag{margin:4px;cursor:pointer}.ws-note-tags__remove{vertical-align:top;cursor:pointer;margin-left:4px}.ws-note-tags__ellipsis{border:1px solid #ccc;padding:0 4px;background:#fff;font-size:11px;display:inline-block;border-radius:3px;white-space:nowrap;word-spacing:normal;vertical-align:top;line-height:16px;margin:4px 0 4px 4px}.ws-note-tag-color,.ws-note__tag-editor-buttons .controls-Button__icon.ws-note-tag-color_color-0,.ws-note__tag-editor-buttons .controls-Button__icon.ws-note-tag-color_color-1,.ws-note__tag-editor-buttons .controls-Button__icon.ws-note-tag-color_color-2,.ws-note__tag-editor-buttons .controls-Button__icon.ws-note-tag-color_color-3,.ws-note__tag-editor-buttons .controls-Button__icon.ws-note-tag-color_color-4,.ws-note__tag-editor-buttons .controls-Button__icon.ws-note-tag-color_color-5{border-radius:4px;height:16px;width:16px;border:1px solid #eaeaea}.controls-MenuItem__content .ws-note-tag-color,.ws-note-tag-color:hover,.ws-note-tag-color_selected,.ws-note-tag-color_selected:hover{border:1px solid #eaeaea}.ws-note-tags__ellipsis~span{opacity:0}.ws-note-tags__ellipsis.ws-hidden~span{opacity:1}.ws-note-shadow__left,.ws-note-shadow__right{width:49%;height:6px;border:0}.ws-note-shadow{position:absolute;height:6px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAHCAYAAAD5wDa1AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAEdJREFUeNpi5ObmNmFgYPgPxRDwH4T+I/gMyDIg8j9ECWmAkRFoGSO6Yf//4zYHJMOIyymEbPtPji4yARMDHcGoZVQBAAEGABJ1Fm/2x67bAAAAAElFTkSuQmCC) bottom center repeat-x}.ws-note-shadow__left{float:left;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAAHCAYAAADAi0WrAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAbxJREFUeNqsVgGSwyAIlBl7r+n/H9de3SNRT0QxapMp0Sii3WVJPAD3fD4fzrkftoewH9F6+cxrjra+OA6qR6hpSNfj3hk31uD4jf1zvz8m94v9mTOMYoo+1BhEV/TPfyEXQLjrNVDxoLbMN7Fx+VeaGcFPM+/d1kVOx4L50O5K5PpHrSYw2m7lQlofAaMTCRCd0AYeCyl6uDTbH51WWuAz4P8MY3MphlNgIEKERifOFYE4IwPIwNDvYrqSH3pvWK6VE+lMRwf4j2G/xnghEV3yUMBvSJGJNAR8CTNTDfddNJjz9+j/UqU1tUBI5ejDqDLgiAQRG07y2HC070SmtEJmrcCaLAN5amrnVopzHFpLAot/DPZCp9Ji57R2jvkv9Y9C6llbs7q0Gt9VS9wijyH75HWRUK51zUfBtgLQZsbFa+XyrYMbRLMupL7DzFnOStM6zyRAVtgnPR9KfRWlRmIZ4lci+I1IsFRsEC3TSt2cpI3COpWw2ATtPv5N/5jnC29X6nzqXbxGMAjulV9IpCG1JEzn4Ksqy7F898rxdN3DvE7W1FfhQ9+zf2OYUQzMJnP8zDODZbh7Hn8CDADiQa+zYOkpnQAAAABJRU5ErkJggg==) bottom left no-repeat}.ws-note-shadow__right{float:right;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAH8AAAAHCAYAAAAhzJK/AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAfVJREFUeNq0VwF2wyAI9Sfp3utpdv9j7Dpr1z81qGgwsVmWVwIaRISPWtzv90/XfxB+AIMI+3sSIK/SF4euzdwPVG2odmogT5baSauRoVzSjSSKT5Usdiu9WoZTE2ztGGNsO+Pf92TtjwpURzc+D9/3HbinwJ/CH4pHWvzry+0+jD+HfS1JfN3DDSASn5xOrkFclyhA4CQrzn3RBhkiM0V9ckKU17bMkclrTgjyqt9S1henW3/cQATsqvjjgzb4uMqyc8uIEnMF7C6U51BzPpRUiCsxyXOCoK4bSCzToMlpIAmnE5AUmr1NT5hXOdKi5JY02CwQdWvM0iDaquIuHnF18nEIjo7OdSAtc1ElGlYgFAqYSyerHsMRvQTAUEIDoAwYP9/sexeJcaJb086gEbDMDRhTsmGDZLuad8ptrPJDuXQzLDVufLbG1Ok6sTOohNf2DVtWuk7MaexsPI4ZrFlasKSdYkHZUW4KJJ5Dg2b2dmeoHWZzNOHqyh+Il6VDMwQcPEZhj+n5koGw7+zRkflvZ3XxPgHnRy5ePRcEIPHImcpxQ08QgET+Ue0odC8/8iX2E/F08vuJrP4UDIWyssHji8TmXNE7IJRPOF5BTAmxCwBrndVRMxyv00Ci4i+/uz2r+151GY0XYX0PWQ7sRpsJFL8CDAAmcXrzr//3aAAAAABJRU5ErkJggg==) bottom right no-repeat}.ws-note-used-tag .controls-MenuItem .controls-MenuItem__icon,.ws-note__tag-color-menu .controls-MenuItem .controls-MenuItem__icon{box-sizing:border-box;top:3px!important;left:-9px!important;width:24px;height:24px}.ws-note-used-tag .controls-MenuItem .controls-MenuItem__icon-wrapper,.ws-note__tag-color-menu .controls-MenuItem .controls-MenuItem__icon-wrapper{padding-left:2px}.ws-note-used-tag .controls-MenuItem .control-MenuItem__child-expand,.ws-note__tag-color-menu .controls-MenuItem .control-MenuItem__child-expand{padding-right:0}.ws-note__tag-color-menu{width:32px;margin-left:-2px!important}.ws-note__tag-color-menu.controls-MenuIcon__Menu.controls-Menu__hide-menu-header .controls-MenuItem{height:30px;line-height:30px}.ws-note__tag-color-menu.controls-Menu__hide-menu-header{padding:0}.ws-note__body .ws-note-files{border-top:1px dashed rgba(0,0,0,.1)}.ws-note__pin-menu{max-width:280px}'));head.appendChild(style);});}define('js!SBIS3.Notes.NotesView',['Core/core-functions','Core/core-merge','Core/Indicator','Core/IoC','Core/EventBus','Core/constants','Core/Context','SBIS3.CONTROLS/CompoundControl','js!SBIS3.Notes.Note','Lib/ServerEvent/Bus','js!SBIS3.Notes.Utils.Info','css!SBIS3.Notes.NotesView','css!SBIS3.CORE.RichContentStyles','Zametki_localization','Zametki_localization'],function(e,t,o,i,n,s,a,r,l,c,d){'use strict';function h(){throw new Error('Method not implemented');}var f=r.extend({$protected:{_options:{activableByClick:false,errorOnLoading:false,errorOnLoadingMessage:null},_lastWidth:0,_lastHeight:0,_controls:null,_activeNoteId:null,_activeNote:null,_needRedrawNotes:true,_isActiveNoteNew:false,_isActiveNoteLocked:false,_isPluginAvailable:false,_isNotificationServiceAvailable:false,_doNotOpenDialog:false,_doNotSaveDialog:false,_openDialogTime:null,_isTagFormOpened:false,_isPinMenuOpened:false,_shouldNotifyAboutDemoMode:true,_eventNamespace:'.notesView'},init:function(){f.superclass.init.call(this);var e=this,t=this.getChildControlByName('notes');this._checkPluginAvailability(),this._controls={notes:t},t.getContainer().on('transitionend'+this._eventNamespace,'.ws-note_animated',function(){$(this).hide();}),this.subscribeTo(t,'onItemDoubleClick',function(t,o,i){if(o.pinnedToPanel&&!o.isAuthor&&!o.canEdit);else e.openNoteDialog({note:o,origRecord:i,noteRecord:i.clone()});}),this.subscribeTo(t,'onChangeHoveredItem',this._onChangeHoveredItem.bind(this));var o=n.channel('NoteCommands');this.subscribeTo(o,'Open',function(t,o,i){if(o||i&&i.get('baseId')){var n=o?e.getNote(o):e.getNoteByBaseId(i.get('baseId'));if(n)e.openNoteDialog({note:n,origRecord:i,noteRecord:i.clone()});}}),this.subscribeTo(o,'Edit',function(t,o){if(o.pinnedToPanel&&!o.isAuthor&&!o.canEdit);else e.openNoteDialog({note:o});}),this.subscribeTo(o,'Remove',function(t,o){e.removeNote(o);}),this.subscribeTo(o,'ViewFile',function(e,t){require(['js!SBIS3.EDO.CD.DiskOperations'],function(e){e.openDocument(t);});}),this.subscribeTo(o,'Pin',this._onPin.bind(this)),this.subscribeTo(c.serverChannel('notes.note'),'onMessage',this._onServerMessage.bind(this)),this.subscribeTo(c.serverChannel('tags.tag'),'onMessage',this._onServerMessage.bind(this));var i=n.channel('NotesEvents');this.subscribeTo(i,'onPanelOpened',function(){e._initSharedNotesChannel();}),this.subscribeTo(i,'onPanelResize',function(){e._controls.notes._onWindowResize();}),this.subscribeTo(i,'onPanelClosed',function(){c.serverChannel('notes.sharednotes').unbind('onMessage');}),this.subscribeTo(i,'onTagFormOpened',function(){e._isTagFormOpened=true;}),this.subscribeTo(i,'onTagFormClosed',function(){e._isTagFormOpened=false;}),this.subscribeTo(i,'onPinMenuOpened',function(){e._isPinMenuOpened=true;}),this.subscribeTo(i,'onPinMenuClosed',function(){e._isPinMenuOpened=false;}),this.subscribeOnceTo(i,'onNotificationServiceAvailable',function(){e._isNotificationServiceAvailable=true;}),this.subscribeOnceTo(i,'onBeforeTagUpdate',function(){e._lastUpdateTime=new Date().getTime();}),this.subscribeOnceTo(i,'onBeforeTagRemove',function(){e._lastUpdateTime=new Date().getTime();}),this.subscribeTo(i,'onEditorResize',function(t,o){if(e._editorDialog)e._editorDialog.setSize(o);});},canBeUpdatedOnServerMessage:function e(){return!this._lastUpdateTime||this._lastUpdateTime+5000<new Date().getTime();},destroy:function(){f.superclass.destroy.call(this),s.$win.off(this._eventNamespace),this._controls.notes.getContainer().off(this._eventNamespace),this._controls=null;},getNote:function(e){return this._controls.notes.findNoteById(e)||null;},getNoteByBaseId:function(e){return this._controls.notes.findNoteByBaseId(e)||null;},getNoteIndex:function(e){return this._controls.notes.findNoteIndexById(e)||0;},_initSharedNotesChannel:function(){var e=this,t=c.serverChannel('notes.sharednotes',{isChanneled:true});t.once('onReady',function(){t.subscribe('onMessage',e._onServerMessageShared.bind(e));});},_checkPluginAvailability:function(){var e=this;if(!s.browser.isMobilePlatform&&!s.browser.isMacOSDesktop)require(['js!SBIS3.Plugin.Source.LocalService'],function(t){new t({endpoint:{address:'FileSystem-1.0.1.0',contract:'FileSystem'},options:{mode:'silent'}}).isReady().addBoth(function(t){if(e._isPluginAvailable=!(t instanceof Error),e._controls.notes._options.items&&e._controls.notes._options.items.length)n.channel('NotesEvents').notify('onPluginAvailabilityChanged',e._isPluginAvailable);else setTimeout(function(){n.channel('NotesEvents').notify('onPluginAvailabilityChanged',e._isPluginAvailable);},1000);});});},_getWindowWidth:function e(){return s.$win.width();},_getWindowHeight:function e(){return Math.min(s.$doc.height(),s.$win.height());},_onServerMessageShared:function(e,t){if(t){var o=t.at(0);if(o){var i=o.get('EventType'),n='';if(o.has('Payload'))n=o.get('Payload');if(this._doNotOpenDialog&&'Unlock'===i){if(new Date()-this._openDialogTime>1000*60)this._doNotSaveDialog=true,d.showMessageDialog({message:n,status:'default'});}else if('Edit'===i)this._onServerMessage(e,t);}}},_onServerMessage:function(e,t){if(t){var o=t.at(0);if(o){var i=o.get('EventType'),n=o.get('NoteId'),s=this._controls.notes.findNoteByBaseId(n);if(!this._doNotOpenDialog&&!this._isTagFormOpened&&!this._isPinMenuOpened)if('Create'===i){if(!s)this._loadAndCheckVisibleNotes(false);}else if(s&&s.canBeUpdatedOnServerMessage()||('UpdateTag'===i||'DeleteTag'===i)&&this.canBeUpdatedOnServerMessage())this._loadAndCheckVisibleNotes('UpdateTag'===i||'DeleteTag'===i);}}},loadData:h,createNote:function(){return new l({creationDate:new Date()});},_loadAndCheckVisibleNotes:function(e){var t=this;this.loadData().addCallback(function(){if(!e){var o=false;t._controls.notes.getItems().each(function(e){if(!e.get('isHidden')&&!e.get('pinnedToPanel'))o=true;}),n.channel('NoteCommands').notify('setHiderFletching',o);}});},openNoteDialogCall:function(e){var o=this,i=this._isActiveNoteNew=!e.note,s=i?null:this._controls.notes.getNoteElement(e.note.id);if(s)s.addClass('ws-note_blocked');if(n.channel('NoteCommands').notify('CloseExtendedHider'),i){if(e.note=this.createNote(),e.tag)e.note.tags=[e.tag];if(e.text)e.note.text=e.text;if(!$('#accordionBg').length&&!$('[data-component="SBIS3.Navigation.Navigation"]').length||e.panelId||e.panelData&&e.panelData.panelId)e.note.pinnedToPanel=true,e.note.isAuthor=true,e.note.panelId=e.panelId||null,e.note.panelData=e.panelData||{};}else if(this.hasChildControlByName('NoteFiles_'+e.note.id)){var r=this.getChildControlByName('NoteFiles_'+e.note.id);if(r.hasChildControlByName('previews')){var l=r.getChildControlByName('previews').getTreeView().getItems();if(l.getCount())e.noteRecord.set('files',l),e.note.files=l;}}e.note.snapshot(),this._origRecord=e.origRecord,this._activeNoteId=e.note.id,this._activeNote=e.note;var c=a.createContext(this,null,this.getLinkedContext());c.setValue('record',e.note);var d=t({name:'NoteDialog',className:'ws-note-dialog',template:'js!SBIS3.Notes.NoteEditor',width:f.NOTE_EDITOR_WIDTH,height:200,opener:e.opener||this,parent:this,componentOptions:{name:'NoteEditor',context:c,note:e.note,noteRecord:e.noteRecord,isLocked:this._isActiveNoteLocked,isNewNote:i,noteElement:s,minWidth:f.NOTE_EDITOR_WIDTH,isPluginAvailable:this._isPluginAvailable},handlers:{onBeforeClose:this._onBeforeEditorClose.bind(this),onAfterClose:this._onAfterEditorClose.bind(this)}},this.getEditorConfig());require(['Lib/Control/Dialog/Dialog'],function(e){o._editorDialog=new e(d);});},openNoteDialog:function(e){var t=this;if(e=e||{},this._options.errorOnLoading)return void d.showMessageDialog({message:this._options.errorOnLoadingMessage,status:'error'});if(this._doNotOpenDialog)return;if(this._needRedrawNotes=true,this._doNotOpenDialog=true,this._doNotSaveDialog=false,this._openDialogTime=new Date(),e.note&&e.note.pinnedToPanel)e.note.lockNote().addCallbacks(function(o){if(o=o.getRawData(),o)o=String(o).split('\n'),d.showMessageDialog({message:o[0],details:o[1]}),t._doNotOpenDialog=false,t._openDialogTime=null;else t._isActiveNoteLocked=true,t.openNoteDialogCall(e);},function(o){i.resolve('ILogger').error(rk('Не удалось заблокировать заметку'),o),t.openNoteDialogCall(e);});else this.openNoteDialogCall(e);},_onBeforeEditorClose:function(e,t){var i='remove'===t,n='save'===t,s='force'===t||this._doNotSaveDialog,a=this._editorDialog,r=this._activeNote,l=this;if(r)r.oldContentImages=r.contentImages,r.contentImages=a.getChildControlByName('NoteEditor')._controls.content.getImages();function c(){l._justClose=true,a.close();}function h(e){if(new Blob([e]).size>10240)return d.showMessageDialog({message:rk('Заметка имеет слишком большой размер'),status:'error'}),true;return false;}if(this._justClose)return void o.hide();if(!i){if(l._activeNote)if(a.hasChildControlByName('Files')){var f=a.getChildControlByName('Files');if(f.hasChildControlByName('previews')){var u=f.getChildControlByName('previews').getTreeView().getItems();if(u&&u.getCount()&&l._origRecord)l._origRecord.set('files',u);r.files=u;}}var g=this.getChildControlByName('NoteEditor'),_=g.getContent();if(r._snapshot.text!==_||l._isActiveNoteNew)if(r.text=g.prepareTextForSaving(_),l._isNotificationServiceAvailable)r.updateNotificationOnNextSave();var N=!r.hasContent();if(i=N&&(n||!r.wasSaved()||''===r._snapshot.text),!i&&!s)if(r.hasChanged(false,true)||l._isActiveNoteNew)if(e.setResult(false),(n||!r.hasChanged(true,true))&&!(!n&&l._isActiveNoteNew&&!N)){if(h(r.text))return;o.setMessage(rk('Сохранение заметки')),r.save().addCallbacks(c,function(e){o.hide();});}else require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(e){var t={message:rk('Сохранить изменения?'),details:rk('Чтобы продолжить редактирование, нажмите "Отмена".'),hasCancelButton:true};e.showConfirmDialog(t,function e(){if(!N){if(h(r.text))return;o.setMessage(rk('Сохранение заметки')),r.save().addCallbacks(c,function(e){o.hide();});}else l.removeNote(r,l._isActiveNoteNew),l._activeNote=null,c();},function e(){if(r.rollback(),''===r.text&&!(r.files&&r.files.getCount())||l._isActiveNoteNew)l.removeNote(r,l._isActiveNoteNew),l._activeNote=null;else l._needRedrawNotes=false;c();},function e(){});});else if(!l._isActiveNoteNew)this._needRedrawNotes=false,r.text=r._snapshot.text;}if(i)this.removeNote(r,l._isActiveNoteNew),this._origRecord=this._activeNote=null;},_onAfterEditorClose:function(){var t=this,o=n.channel('NotesEvents');if(!this._activeNote&&this._isActiveNoteLocked)this._isActiveNoteLocked=false;if(this._isActiveNoteLocked){var s=this._activeNote;s.unlockNote().addCallbacks(function(e){s.text=s._snapshot.text,t._controls.notes.reload();},function(e){i.resolve('ILogger').error(rk('Не удалось разблокировать заметку'),e);});}if(this._activeNote)if(this._isActiveNoteNew){if(l.isDemo())e.alert(rk('В демо-режиме заметки не сохраняются'),rk('После обновления страницы они пропадут'));o.notify('onNoteAdded',this._activeNote);}else{var a=this._controls.notes.getNoteElement(this._activeNote.id);if(!this._needRedrawNotes&&a){if(!a.hasClass('ws-note_hidden'))a.css({opacity:1,display:'block'}),a.removeClass('ws-note_animated'),setTimeout(function(){a.css('transition','none');},500);}else o.notify('onNoteChanged',this._activeNote);}else o.notify('onNoteRemoved',this._activeNoteId);this._origRecord=this._activeNote=this._editorDialog=null,this._doNotOpenDialog=t._doNotSaveDialog=this._justClose=false,this._openDialogTime=null,this._isActiveNoteNew=false,this._isActiveNoteLocked=false,$('body').removeClass('ws-note-openedDialog');},_onChangeHoveredItem:function(e,t){if(t.key)this._activeNoteId=t.key;},removeNote:h,_onPin:h});return f.NOTE_EDITOR_WIDTH=494,f.NOTE_EDITOR_HEIGHT=350,f;});define('html!SBIS3.Notes.StaticNotesView',['Zametki_localization'],function(){var e=function(e){var t=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(t){for(;e.test(t);)t=t.replace(e,'&#123;&#123;$1&#125;&#125;');return t;};}(),n='undefined'!=typeof process,o=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'<div class="ws-notes-holder ws-notes-holder_static"> <component data-component="SBIS3.Notes.StaticNoteListView" name="notes" class="ws-notes-container"></component> <div class="ws-notes-pagination-bottom ws-hidden"></div> </div>');return(o=t(o))+(n&&-1!==o.indexOf('{{')?String.fromCharCode(8203,8203):'');};return e.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.StaticNotesView'};},e;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.StaticNotesView',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-notes-holder.ws-notes-holder_static,.ws-notes-holder.ws-notes-holder_static .ws-notes-container{position:relative}.ws-notes-pagination-bottom{margin-bottom:12px;margin-right:12px}.scrollContainerNotes .controls-ListView__scrollPager.controls-Paging{display:none!important}'));head.appendChild(style);});}define('js!SBIS3.Notes.StaticNotesView',['Core/helpers/getSessionStorageValue','Core/helpers/setSessionStorageValue','js!SBIS3.Notes.Utils.Info','Core/EventBus','Core/constants','Core/helpers/Function/debounce','js!SBIS3.Notes.NotesView','html!SBIS3.Notes.StaticNotesView','js!SBIS3.BL.Note','js!SBIS3.Notes.Note','SBIS3.CONTROLS/Pager','SBIS3.CONTROLS/ScrollContainer','js!SBIS3.Notes.StaticNoteListView','css!SBIS3.Notes.StaticNotesView','Zametki_localization','Zametki_localization'],function(e,t,s,i,o,a,n,r,l,g,h){'use strict';function c(e){if(e instanceof Array)return[].concat(e);if(null!=e)return[f(e)];return[];}function u(e){if(e){var t=new Date(e);if(!isNaN(+t))return t;}return null;}function f(e){return e&&e.replace(/^\s+|\s+$/gm,'');}var _=n.extend({_dotTplFn:r,$protected:{_options:{filters:{page:0,pageSize:20,orderDESC:true,startDate:null,endDate:null,tags:[],searchQuery:''}},_dom:null,_filters:{},_totalNotesCount:0,_needToNotifyPageUpdate:false,_tagsWasChanged:false},_modifyOptions:function(t){if('undefined'!==typeof window)t.filters.pageSize=e('ws-page-size')||20;return t;},init:function(){_.superclass.init.call(this),this._dom={paging:null},this.setFilters(this._options.filters),this._initPaging(),this.subscribeTo(this,'onResize',a(this._onResize.bind(this),250)),this.subscribeTo(i.channel('NoteCommands'),'MoveNote',this._moveNote.bind(this));var e=i.channel('NotesEvents'),t=this,s=function e(){t._tagsWasChanged=true;};this.subscribeTo(e,'onTagAdded',s),this.subscribeTo(e,'onTagUpdated',s),this.subscribeTo(e,'onTagRemoved',s),this.subscribeTo(e,'onTagFormClosed',function(e,s){if(t._tagsWasChanged)if(t._tagsWasChanged=false,!t._doNotOpenDialog)i.channel('NotesEvents').notify('onNoteChanged',s);}),this.subscribeTo(e,'onFileRemoved',function(e,s){if(!$('body').hasClass('ws-note-openedDialog')&&s&&!s.hasContent()&&!s.files.getCount()&&!s.tags.length)t.removeNote(s),t._activeNote=null;t._controls.notes.toColView(true);});},destroy:function(){_.superclass.destroy.call(this),o.$win.off(this._eventNamespace),this._controls.notes.setItemsDragNDrop(false),this._controls=this._dom=null;},_moveNote:function(e,t,i){if(t==i)return;var o=this.getNoteIndex(t),a=this.getNoteIndex(i);if(o>=0&&a>=0){var n=this,r=this.getNote(t),g=this.getNote(i),h=o>a;l.moveNote(g.baseId,r.baseId,h).addCallbacks(function(e){n.loadData();},function e(t){s.showMessageDialog({message:t.message,status:'error'});}),n._currentNoteId=t;}},_onAfterEditorClose:function(){var e=i.channel('NotesEvents');if(this._activeNote)if(g.isDemo())s.showMessageDialog({message:rk('В демо-режиме нельзя добавлять заметки в реестр'),status:'error'});else if(this._isActiveNoteNew)e.notify('onNoteAdded',this._activeNote);else{var t=this._controls.notes.getNoteElement(this._activeNote.id);if(!this._needRedrawNotes&&t)t.css({opacity:1,display:'block'}),t.removeClass('ws-note_animated');else e.notify('onNoteChanged',this._activeNote);}this._activeNote=this._editorDialog=null,this._doNotOpenDialog=this._justClose=false,this._isActiveNoteNew=false,$('body').removeClass('ws-note-openedDialog');},_onResize:function(){if(this._controls.notes){var e=this.getContainer().width(),t=this.getContainer().height(),s=o.$win.height();if(e!==this._lastWidth||t!==this._lastHeight||s!==this._lastScreenHeight)this._lastWidth=e,this._lastHeight=t,this._lastScreenHeight=s,this._controls.notes.toColView(true);}},setPageSize:function(e){if(this._activeNoteId=null,this.getFilter('pageSize')!==e)if(this.setFilter('pageSize',e),this.getFilter('page')>0)this.setFilter('page',1),this._controls.pagination.getPaging().setPage(1);else this.loadData(true);},_initPaging:function(){var e=this,t=this._controls.pagination=new h({pageSize:this.getFilter('pageSize')||20,opener:this,showPaging:true,ignoreLocalPageSize:false,name:'Pagination',element:this.getContainer().find('.ws-notes-pagination-bottom'),pagingOptions:{recordsCount:this._totalNotesCount,currentPage:1,recordsPerPage:this.getFilter('pageSize')||20,pagesLeftRight:3,onlyLeftSide:false,rightArrow:true}});t.getChildControlByName('controls-Pager_comboBox')._options.flipVertical=true,this._dom.paging=t.getContainer(),this.subscribeTo(t,'onPageChange',function(t,s){if(e.getFilter('page')!==s-1)e.setFilter('page',s-1),e.loadData(true);});},updatePagination:function(){var e,t,s,i;if(0===this._totalNotesCount)this._dom.paging.addClass('ws-hidden');else{if(e=this._controls.pagination,t=this._controls.pagination.getPaging(),s=this.getFilter('pageSize'),this._forceClearPageNumber)i=1,this._forceClearPageNumber=false;else i=t.getPage();if(e.getChildControlByName('controls-Pager_comboBox').setPageSize(s),this.setFilter('page',i-1),i>Math.ceil(this._totalNotesCount/s))i--;if(0===this._totalNotesCount&&i>1)t.setPage(1);if(t.setPage(i),t._options.recordsCount=this._totalNotesCount,t.update(i,this._totalNotesCount,true),1===i)e.updateAmount(Math.min(this._totalNotesCount,s),true,0);else if(i===Math.ceil(this._totalNotesCount/s))e.updateAmount(this._totalNotesCount-(i-1)*s,true,0);else e.updateAmount(s,true,0);this._dom.paging.removeClass('ws-hidden');}},forceClearPageNumber:function(){this._forceClearPageNumber=true;},loadData:function(e){var t=this._controls.notes,i=this;if(this._forceClearPageNumber)this._filters.page=0;var o={mixedMode:true,Tags:this._filters.tags||[],PagesId:this._filters.urls||[],SearchQuery:this._filters.searchQuery||'',Color:null==this._filters.color?null:+this._filters.color,StartDate:this._filters.startDate||null,EndDate:this._filters.endDate||null};return t.setFilter(o,true),t.setPage(this._filters.page,true),t.setPageSize(this._filters.pageSize,true),i.show(),t.reload().addCallback(function(t){if(i._totalNotesCount=t.getMetaData().total,i._options.errorOnLoading=false,e){var s=i._controls.pagination,o=s.getPaging().getPage(),a=i.getFilter('pageSize'),n=a;if(1===o){if(i._totalNotesCount<a)n=i._totalNotesCount;}else if(o*a>i._totalNotesCount)n=i._totalNotesCount-(o-1)*a;s.updateAmount(n,true,0);}else i.updatePagination();}).addErrback(function(e){if(e.canceled)return;s.showMessageDialog({message:rk('Не удалось загрузить заметки'),status:'error'}),i._options.errorOnLoading=true,i._options.errorOnLoadingMessage=e.message;});},getEditorConfig:function(){return{};},removeNote:function(e){this._controls.notes._disableRedraw=true,this._controls.notes.removeNoteById(e.id);var t=this;this._controls.notes._disableRedraw=false,e.remove().addCallback(function(){var s=t.getFilter('page');if(s>Math.ceil(--t._totalNotesCount/t.getFilter('pageSize'))&&s>0)t.setFilter('page',s-1);i.channel('NotesEvents').notify('onNoteRemoved',e.id);});},setFilters:function e(t){t=t||this._options.filters||{};for(var s in t)if(t.hasOwnProperty(s))this.setFilter(s,t[s]);return this;},setFilter:function s(i,o){var a;switch(i){case'page':case'Page':if(o){if(!isNaN(a=parseInt(o,10)))this._filters.page=a;}else this._filters.page=0;break;case'max':case'maxCount':case'countPerPage':case'pageSize':if(o){if(!isNaN(a=parseInt(o,10)))if(a>=0)this._filters.pageSize=a,t('ws-page-size',this._filters.pageSize);}else this._filters.pageSize=this._options.max||this._options.maxCount||this._options.countPerPage||this._options.pageSize||e('ws-page-size')||20,t('ws-page-size',this._filters.pageSize);break;case'sort':case'order':case'orderDESC':if('asc'===o||'ASC'===o)this._filters.orderDESC=false;else if('desc'===o||'DESC'===o)this._filters.orderDESC=true;else this._filters.orderDESC=!!o;break;case'startDate':case'StartDate':this._filters.startDate=u(o);break;case'endDate':case'EndDate':this._filters.endDate=u(o);break;case'tag':case'tags':case'Tag':this._filters.tags=c(o);break;case'Url':this._filters.urls=c(o);break;case'searchString':case'searchText':case'searchQuery':case'SearchQuery':this._filters.searchQuery=o;break;case'color':case'Color':this._filters.color=null==o?null:+o;}return this;},getFilter:function t(s){var i=this._filters[s];if('pageSize'===s&&!i)i=e('ws-page-size');return i;},resetPaging:function(){var e=this._controls.pagination.getPaging();if(e.getPage()>1)e.setPage(1),this.setFilter('page',0);},_onPin:function(e,t,s){if(s===t.getPin())return;if(s===g.NOTE_PIN_ALL_PAGES)t.pinToAllPages();else if(s===g.NOTE_PIN_PAGE)t.pinToMainPage();else if(s===g.NOTE_PIN_UNPINNED)t.unpin();}});return _;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.Page',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-note-page{min-height:600px;margin-top:5px}.ws-note-left-list{width:250px;padding:0!important}.ws-note-add{position:absolute;top:22px;left:750px}.ws-note-left-list .ws-note-used-tag{display:block;padding:12px 10px 12px 18px;color:#000;border-right:#eee 1px solid;font-size:15px;cursor:pointer}.ws-note-left-list .controls-ListView__item__selected{color:#000;padding-top:11px;padding-bottom:10px;border-top:1px solid #eee;border-bottom:1px solid #eee;border-right-color:#fff}.ws-note-left-list .controls-ListView__item__selected .ws-note-tag__count{top:11px}.ws-note-left-list .ws-note__tag{font-size:15px;max-width:195px;overflow:hidden;text-overflow:ellipsis;cursor:pointer}.ws-note-left-list .controls-ListView__EmptyData,.ws-notes-holder_small{border-top:1px solid #eee}.ws-note-sort-down,.ws-note-sort-up{float:right}.ws-clear{clear:both}.ws-search-options{width:80%;margin:0 auto}.ws-notes-pagination-bottom,.ws-notes-pagination-top{text-align:center}.ws-notes-pagination-bottom{z-index:10;position:relative}.ws-note-page__filters{height:40px}.ws-note-tag__count{position:absolute;right:4px;top:12px;color:#05b;cursor:pointer}.ws-note-used-tag>span{cursor:pointer}.ws-note-page__breadcrumbs{font-size:12px;color:#999}.ws-note-search{vertical-align:middle}body.dragdropBody,body.dragdropBody *{cursor:no-drop!important}body.dragdropBody .ws-note-used-tag.controls-ListView__hoveredItem,body.dragdropBody .ws-note-used-tag.controls-ListView__hoveredItem>span,body.dragdropBody .ws-note-used-tag.controls-ListView__item__selected,body.dragdropBody .ws-note-used-tag.controls-ListView__item__selected>span,body.dragdropBody .ws-note_static.controls-ListView__hoveredItem,body.dragdropBody .ws-note_static.controls-ListView__hoveredItem *,body.dragdropBody .ws-note_static.controls-ListView__item__selected{cursor:pointer!important}body.dragdropBody .ws-note-left-pages .ws-note-used-tag.controls-ListView__hoveredItem,body.dragdropBody .ws-note-left-pages .ws-note-used-tag.controls-ListView__hoveredItem>span,body.dragdropBody .ws-note-left-pages .ws-note-used-tag.controls-ListView__item__selected,body.dragdropBody .ws-note-left-pages .ws-note-used-tag.controls-ListView__item__selected>span{cursor:no-drop!important}body.dragdropBody .controls-DragNDrop__insertAfter,body.dragdropBody .controls-DragNDrop__insertBefore{border-top:none!important;border-bottom:none!important}.ws-note-page_empty-left-side .ws-notes-holder_small{margin-left:0;border-top:0}.ws-note-page_empty-left-side .ws-note-left-list{width:0}.ws-note-used-tag.controls-ListView__item .ws-note-tag__actions{position:absolute;top:10px;right:24px;display:none;padding-left:22px;background:-moz-linear-gradient(left,rgba(240,245,251,0) 0,rgba(240,245,251,1) 15%,rgba(240,245,251,1) 100%);background:-webkit-linear-gradient(left,rgba(240,245,251,0) 0,rgba(240,245,251,1) 15%,rgba(240,245,251,1) 100%);background:linear-gradient(to right,rgba(240,245,251,0) 0,rgba(240,245,251,1) 15%,rgba(240,245,251,1) 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=\'#00f0f5fb\', endColorstr=\'#a6f0f5fb\', GradientType=1)}.ws-note-used-tag.controls-ListView__item__selected .ws-note-tag__actions{top:9px}.ws-note-used-tag .ws-note-tag__actions.opened,.ws-note-used-tag.controls-ListView__hoveredItem .ws-note-tag__actions{display:block}.ws-note-page__add-button{margin-left:8px}.ws-note-page__add-tag{margin-left:12px}.ws-note-left-list.controls-ListView .controls-ItemsToolbar__editActions{margin-bottom:8px;height:24px;background:#f3f3f3;width:33px;margin-right:1px}.ws-note-left-list.controls-ListView .controls-ItemsToolbar .controls-ItemsToolbar__container{border:0;background:#f3f3f3}.ws-note-left-list .controls-editInPlace__editor .ws-note-tagList__edit{margin:2px 8px 0 16px;width:168px;background:#fff;padding:0}.ws-note-left-list .controls-editInPlace__editor .ws-note-tag-color__menu-icon{margin-top:-3px}.ws-note-left-list .controls-ListView .controls-ItemsToolbar{background:#f3f3f3}.ws-note__recent-tags.controls-ListView .controls-ItemsToolbar{box-shadow:none}.ws-note-used-tag .ws-note-tag__actions .controls-Menu__hide-menu-header{margin-right:2px}.ws-note-page .controls-TabButtons__leftContainer,.ws-note-page .ws-note-left-list .controls-ItemsToolbar__editActions .controls-Button__closeButton{display:none!important}.ws-note-page .controls-TabButtons__tabSpace-template-inner{font-size:0}.ws-note-page .controls-ListView .controls-ItemsToolbar{background-color:inherit!important;box-shadow:none!important}.controls-ListView__customHoveredItem{background:#f0f5fb}.ws-note-page .controls-TabButtons .controls-TabButtons__tabSpace-template .controls-TabButtons__tabSpace-template-inner{position:absolute;top:3px}.ws-note-page__filters .ws-note__search-form-table{vertical-align:top;padding-top:8px}.ws-note-page .controls-ListView .controls-ItemsToolbar__editActions>i{margin:2px 4px}.ws-note-left-list .controls-editInPlace__editor{width:250px;height:41px;margin-top:5px;box-sizing:border-box}.ws-note-page__filters .ws-filter-button-direction-left.ws-filter-button{margin-top:-8px}.ws-note-tag__count{right:12px}.ws-note-page .controls-TabButtons__tabSpace-template{position:relative}.scrollContainerList,.scrollContainerNotes{height:100%}.scrollContainerList{float:left;width:250px}.scrollContainerNotes{margin-left:250px}.compact-menu .ws-note-page .controls-TabButtons__tabSpace-template-inner:before{content:\'Заметки\';font:700 20px/32px TensorFont,sans-serif;color:#d94700;padding:0 4px 0 8px;line-height:23px;float:left}.compact-menu .ws-note-page__add-tag{vertical-align:top}.ws-note-page .ws-note-page__add-button .controls-Button__text{margin-left:0!important}'));head.appendChild(style);});}define('js!SBIS3.Notes.Page',['js!SBIS3.Notes.Utils.Info','Core/EventBus','Core/constants','SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.Page','WS.Data/Source/SbisService','js!SBIS3.Notes.Page.PageInfo','Lib/ServerEvent/Bus','js!SBIS3.Notes.AddTag','SBIS3.CONTROLS/Button/IconButton','SBIS3.CONTROLS/ListView','js!SBIS3.Notes.TagListView','js!SBIS3.Notes.TagEditor','html!SBIS3.Notes.Page/templates/Page','html!SBIS3.Notes.Page/templates/PageContent','js!SBIS3.Notes.StaticNotesView','SBIS3.CONTROLS/Tab/Buttons','SBIS3.CONTROLS/SearchForm','Deprecated/Controls/FilterButton/FilterButton','SBIS3.CONTROLS/Button','SBIS3.CONTROLS/ScrollContainer','css!SBIS3.Notes.Page','i18n!SBIS3.Notes.Page','Zametki_localization','Zametki_localization'],function(t,e,s,i,o,r,n,a){'use strict';var l=i.extend({_dotTplFn:o,$protected:{_filter:{},_options:{errorOnLoading:false,errorOnLoadingMessage:null},_controls:null,_eventNamespace:'.notespage'},init:function(){l.superclass.init.call(this);var t=this,i=this.getChildControlByName('notes'),o=this.getChildControlByName('search'),h=this.getChildControlByName('tags'),d=this.getChildControlByName('pages'),c=this.getChildControlByName('tabs'),g=this.getChildControlByName('addTagDialog');this._controls={notes:i,leftList:null,search:o,addTagDialog:g},i._controls.notes.setItemsDragNDrop(true),this._doNotRefreshNotes=false,d.setDataSource(new r({endpoint:{address:'/notes/service/',contract:'Note'},binding:{query:'GetUserUrls'},idProperty:'ID',model:n}),true);var f=this._onLeftListDataLoad.bind(this),_=this._onLeftListDataLoadError.bind(this),u=this._onLeftListItemClick.bind(this),C=this._onLeftListDrawItems.bind(this),S=this._onLeftListSelectedItemChange.bind(this);this.subscribeTo(h,'onDataLoad',f),this.subscribeTo(h,'onDataLoadError',_),this.subscribeTo(h,'onItemClick',u),this.subscribeOnceTo(h,'onDrawItems',C),this.subscribeTo(h,'onSelectedItemChange',S),this.subscribeTo(d,'onDataLoad',f),this.subscribeTo(d,'onDataLoadError',_),this.subscribeTo(d,'onItemClick',u),this.subscribeOnceTo(d,'onDrawItems',C),this.subscribeTo(d,'onSelectedItemChange',S),this.subscribeTo(i,'onResize',this._setMaxHeight),this.subscribeTo(this.getChildControlByName('addNote'),'onActivated',function(){i.openNoteDialog({tag:t.getActiveTag()});}),this.subscribeTo(this.getChildControlByName('addTag'),'onActivated',function(){t.openTagDialog();}),this.subscribeTo(g,'onCloseDialog',this._onAfterEditorClose.bind(this));var b=this._onSearch.bind(this);this.subscribeTo(o,'onReset',b),this.subscribeTo(o,'onSearch',b),this.subscribeTo(o,'onSearchStart',b),this.subscribeTo(o,'onTextChange',function(t,e){if(!e)b();}),this.subscribeTo(c,'onSelectedItemChange',this._onTabChange.bind(this)),this.subscribeTo(this.getChildControlByName('filter'),'onChange',this._onFilterChange.bind(this));var T=e.channel('NotesEvents');this.subscribeTo(T,'onNoteAdded',this._onNoteAdded.bind(this)),this.subscribeTo(T,'onNoteChanged',this._onNoteChanged.bind(this));var N=e.channel('NoteCommands');this.subscribeTo(N,'AddTag',this._addTagToNote.bind(this)),this.subscribeTo(N,'Create',function(e,s){s=s||{},i.openNoteDialog({tag:t.getActiveTag(),text:s.text});}),this.subscribeTo(e.channel('navigation'),'onNavigate',function(e,s,o){if('AddNote'===o)i.openNoteDialog({tag:t.getActiveTag()});}),this.subscribeOnceTo(T,'onBeforeTagUpdate',function(){t._lastUpdateTime=new Date().getTime();}),this.subscribeOnceTo(T,'onBeforeTagRemove',function(){t._lastUpdateTime=new Date().getTime();}),this.subscribeTo(a.serverChannel('notes.note'),'onMessage',this._onServerMessage.bind(this)),this.subscribeTo(a.serverChannel('tags.tag'),'onMessage',this._onServerMessage.bind(this)),this._onTabChange(null,'tags'),this._setMaxHeight(),s.$win.on('resize'+this._eventNamespace+' orientationchange'+this._eventNamespace,this._setMaxHeight);},canBeUpdatedOnServerMessage:function t(){return!this._lastUpdateTime||this._lastUpdateTime+5000<new Date().getTime();},_setMaxHeight:function(){var t=$('body').height()-110;$('.scrollContainerList').css('height',t),$('.scrollContainerNotes').css('height',t);},_onServerMessage:function(t,e){if(e){var s=e.at(0);if(s){var i=s.get('EventType').trim();if('tags'===this._getCurrentTabId()&&('AddTag'===i||'UpdateTag'===i||'DeleteTag'===i||'Create'===i||'Delete'===i)&&this.canBeUpdatedOnServerMessage())this._controls.leftList._onServerMessage(t,e);else if('pages'===this._getCurrentTabId()&&('Create'===i||'Delete'===i||'Pin'===i||'Unpin'===i))this.getChildControlByName('pages').reload();}}},getActiveTag:function(){var t=null;if('tags'===this._getCurrentTabId()){var e=this._controls.leftList.getSelectedKey();if(e&&'00000000-0000-0000-0000-000000000000'!==e){var s=this._controls.leftList.getItems().getRecordById(e);t={id:e,name:s.get('Name'),color:s.get('Color'),needSave:true};}}return t;},openTagDialog:function(){if(this._options.errorOnLoading)t.showMessageDialog({message:rk('Невозможно создать новый тег.'),details:this._options.errorOnLoadingMessage,status:'error'});else this._controls.addTagDialog.setVisible(true);},_onAfterEditorClose:function(t,e){if(e)if('tags'===this._getCurrentTabId())this._controls.leftList.reload();else if('update'===e)this._controls.notes.loadData();},destroy:function(){l.superclass.destroy.call(this),this._controls=null;},_getCurrentTabId:function(){return this.getChildControlByName('tabs').getSelectedKey();},_onNoteAdded:function(t,e){var s=this._controls.notes,i=this._getCurrentTabId();if('onNoteAdded'===t._eventName)s.forceClearPageNumber();if('tags'===i)this._resetFilter(false,true,e),this._updateTagFilter(e);else if('pages'===i)s.hide(),this._controls.leftList.setSelectedKey(null),this._resetFilter(true,true,e),this._updateListFilter();else this._resetFilter(true,true,e),s.loadData();},_onNoteChanged:function(t,e){var s=this._controls.notes,i=this._getCurrentTabId();if('tags'===i)if(!this._preventNotesReload)this._updateTagFilter(e);else s._controls.notes.redraw(),s._controls.notes.toColView(false),this._controls.leftList.reload();else if('pages'===i)this._updateListFilter();else s.loadData();},_updateTagFilter:function(t){var e=this._filter.Tag;if(t.tags&&t.tags.length){if(!(e&&t.hasTag(e))){var s=t.tags[0];this._controls.leftList.setSelectedKey(s.id),this._filter.Tag=s.name;}}else if(e)this._controls.leftList.setSelectedKey(null),this._filter.Tag='';if(e!==this._filter.Tag)this._controls.notes.forceClearPageNumber(),this._updateListFilter();else{var i=this._controls.notes;i._controls.notes.redraw(),i._controls.notes.toColView(false),this._controls.leftList.reload();}},_onFilterChange:function(t,e){var s={StartDate:null,EndDate:null,Color:null,Tag:this._filter.Tag};if(e.Period&&'all'!==e.Period)if(s.StartDate=new Date(),s.EndDate=new Date(),'week'===e.Period)s.StartDate.setDate(s.EndDate.getDate()-7);else if('month'===e.Period)s.StartDate.setMonth(s.EndDate.getMonth()-1);else if('3months'===e.Period)s.StartDate.setMonth(s.EndDate.getMonth()-3);if(null!=e.Color&&'all'!==e.Color)s.Color=+e.Color.substring(1);var i=this._controls.search.getText()||null;if(i)s.SearchQuery=i;else s.SearchQuery=null;if(this._filter=s,this._controls.notes.forceClearPageNumber(),this._controls.leftList){var o=this._controls.leftList.getFilter();if(+(o.StartDate||null)!==+(s.StartDate||null)||+(o.EndDate||null)!==+(s.EndDate||null)||o.Color!=s.Color)o.StartDate=s.StartDate||null,o.EndDate=s.EndDate||null,o.Color=void 0===s.Color?null:s.Color,this._controls.leftList.setFilter(o);}else this._controls.notes.setFilters(s).loadData();},_prepareDate:function(t){return t.setHours(0),t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0),t;},_resetFilter:function(t,e,s){if(this._filter.SearchQuery=null,!e)this._filter.StartDate=this._filter.EndDate=this._filter.Color=null;else{if(this._prepareDate(new Date(this._filter.EndDate))<this._prepareDate(new Date()))this._filter.StartDate=this._filter.EndDate=null;if(s.color!==this._filter.Color)this._filter.Color=null;}if(t)this._filter.Tag=this._filter.Url=null;if(this._controls.notes.setFilter('page',0),''!==this._controls.search.getText())this._controls.search.resetSearch();var i={},o=this.getChildControlByName('filter'),r=o._filter.Period,n=this._filter.Color;if(this._filter.EndDate)i.Period=r;if(null!==this._filter.Color)i.Color=n;o.setFilter(i);},_updateListFilter:function(){if(this._controls.leftList){var t=this._controls.leftList.getFilter();t.SearchQuery=this._filter.SearchQuery||null,t.StartDate=this._filter.StartDate||null,t.EndDate=this._filter.EndDate||null,t.Color=void 0===this._filter.Color?null:this._filter.Color,this._controls.leftList.setFilter(t);}else this._controls.notes.setFilters(this._filter).loadData();},_onTabChange:function(t,e){var s='tags'===e,i='pages'===e,o=s||i,r=this._controls.notes,n=this.getChildControlByName('tags'),a=this.getChildControlByName('pages'),l=this._controls.leftList=s?n:i?a:null,h=this._filter;if(this.getChildControlByName('addTag').toggle(s),n.toggle(s),a.toggle(i),r.getContainer().toggleClass('ws-notes-holder_small',o),r._options.orderDESC=true,r._controls.notes.setItemsDragNDrop(true),r.setFilters({Tag:h.Tag=null,Url:h.Url=null,page:0}),r.resetPaging(),o){r.hide();var d=l.getFilter();d.SearchQuery=h.SearchQuery||null,d.StartDate=h.StartDate||null,d.EndDate=h.EndDate||null,d.Color=void 0===h.Color?null:h.Color,this._controls.leftList.setSelectedKey(null),l.setFilter(d);}else r.loadData();},_onLeftListSelectedItemChange:function(t,e){if(s.browser.isMobilePlatform){var i=this._controls.leftList;if(i._manualSelected)i._manualSelected=false;else if(!i._isEdited){var o=i.getItems().getRecordById(e);this._onLeftListItemClick(t,e,o);}}},_onLeftListItemClick:function(t,e,i){var o=this,r=t._target,n=r.getProperty('filterName'),a=i.get(r.getProperty('filterPropertyName'));if(s.browser.isMobilePlatform){if(this._controls.leftList._isEdited)return;this._controls.leftList._clearHoveredItem();}if(this._filter[n]!==a){var l={page:0},h=this._controls.notes;this._filter[n]=a,l[n]=[a];var d=$('.ws-note-list_static.ws-notes-container'),c=d.height();d.css('height','auto').css('min-height',c),h.setFilters(l).loadData().addCallback(function(){if(h.resetPaging(),(window.pageYOffset||document.documentElement.scrollTop)>10)window.scrollTo(0,0);});}},_onLeftListDrawItems:function(t){if(this._selectedKey)this._controls.leftList.setSelectedKey(this._selectedKey),this._selectedKey=null;},_onLeftListDataLoadError:function(t,e){this._options.errorOnLoading=this._controls.notes._options.errorOnLoading=true,this._options.errorOnLoadingMessage=this._controls.notes._options.errorOnLoadingMessage=e.message;},_onLeftListDataLoad:function(t,e){var s=t._target;if(this._controls.leftList!==s)return;if(this._controls.leftList._doNotRefreshNotes)this._preventNotesReload=true,this._controls.leftList._doNotRefreshNotes=false;if(this._doNotRefreshNotes)this._preventNotesReload=true,this._doNotRefreshNotes=false;var i=this._controls.notes,o=s.getSelectedKey(),r=o&&e.getRecordById(o);if(e.getCount()&&!r){if(this._preventNotesReload)if(this._currentNoteId){this._preventNotesReload=false;var n=this._controls.notes.getNote(this._currentNoteId);return void this._updateTagFilter(n);}if(r=e.at(0),o=r.getId(),s.getItems())this._controls.leftList._manualSelected=true,this._controls.leftList.setSelectedKey(o),this._selectedKey=null;else this._selectedKey=o;}if(this.getContainer().toggleClass('ws-note-page_empty-left-side',!e.getCount()),this._filter[s.getProperty('filterName')]=r?r.get(s.getProperty('filterPropertyName')):null,!this._preventNotesReload)i.setFilters(this._filter).loadData().addCallback(function(){i.show();});else this._preventNotesReload=false;},_addTagToNote:function(t,s,i){var o=this._controls.notes.getNote(s),r=this;if(r._currentNoteId=s,o){var n=this._controls.leftList.getItems().getRecordById(i);if(n)o.addTag(n.get('Name'),n.get('Color')).addCallback(function(t){if(t)r._preventNotesReload=true,e.channel('NotesEvents').notify('onNoteChanged',o);});}},_onSearch:function(){var t=this._controls.search.getText()||null,e=this._controls.leftList,s=this._controls.notes;if(this._filter.SearchQuery==t||!this._filter.SearchQuery&&!t)return;if(this._filter.SearchQuery=t,e){var i=e.getFilter();i.SearchQuery=this._filter.SearchQuery,s.hide(),s._controls.pagination.getPaging().setPage(1),e.setFilter(i);}else s.setFilters({searchQuery:this._filter.SearchQuery,page:0}),s._controls.pagination.getPaging().setPage(1),s.loadData();}});return l;});define('html!SBIS3.Notes.NotesFilter',['Zametki_localization'],function(){var o=function(o){var n=function(){var o=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;o.test(n);)n=n.replace(o,'&#123;&#123;$1&#125;&#125;');return n;};}(),t=function(o){return o.join?o.join(''):o.toString();},e=function(o){return void 0===o?'':o&&'object'==typeof o?t(o):''+o;},i='undefined'!=typeof process,p=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'<div class="ws-notesFilter"> <div class="ws-notesFilter-row"> <span class="ws-notesFilter-title">'+n(e(rk('Отбираются')))+'</span> <component data-component="Deprecated/Controls/FieldDropdown/FieldDropdown" class="ws-notesFilter-input" name="Period"> <options name="data" type="array"> <options> <option name="key">all</option> <option name="value">'+n(e(rk('За всё время')))+'</option> </options> <options> <option name="key">today</option> <option name="value">'+n(e(rk('За сегодня')))+'</option> </options> <options> <option name="key">week</option> <option name="value">'+n(e(rk('За неделю')))+'</option> </options> <options> <option name="key">month</option> <option name="value">'+n(e(rk('За месяц')))+'</option> </options> <options> <option name="key">3months</option> <option name="value">'+n(e(rk('За три месяца')))+'</option> </options> </options> <option name="tooltip">'+n(e(rk('Выберите период')))+'</option> </component> </div> <div class="ws-notesFilter-row"> <span class="ws-notesFilter-title">'+n(e(rk('Цвет заметки')))+'</span> <component data-component="Deprecated/Controls/FieldDropdown/FieldDropdown" class="ws-notesFilter-input" name="Color"> <options name="data" type="array"> <options> <option name="key" type="string">all</option> <option name="value">'+n(e(rk('все цвета')))+'</option> </options> <options> <option name="key" type="string">c0</option> <option name="value">'+n(e(rk('Жёлтый')))+'</option> </options> <options> <option name="key" type="string">c1</option> <option name="value">'+n(e(rk('Зелёный')))+'</option> </options> <options> <option name="key" type="string">c2</option> <option name="value">'+n(e(rk('Красный')))+'</option> </options> <options> <option name="key" type="string">c3</option> <option name="value">'+n(e(rk('Фиолетовый')))+'</option> </options> <options> <option name="key" type="string">c4</option> <option name="value">'+n(e(rk('Синий')))+'</option> </options> </options> <option name="emptyValue">'+n(e(rk('Выберите цвет заметки')))+'</option> <option name="tooltip">'+n(e(rk('Выберите цвет заметки')))+'</option> </component> </div> <div class="ws-notesFilter-row ');return p+='ws-hidden',p+='"> <span class="ws-notesFilter-title">'+n(e(rk('Содержат теги')))+'</span> <component data-component="Deprecated/Controls/FieldLink/FieldLink" name="Tags" class="ws-notesFilter-input"> <option name="multiSelect">true</option> <options name="suggestSettings"> <option name="autoShow">true</option> <option name="selectOnLoad">true</option> <option name="rowsCount">10</option> <options name="dataSource"> <options name="readerParams"> <option name="nameApplication">Основной сервис</option> <option name="nameService">Основной сервис</option> <option name="queryName" value="GetUserTags"></option> <option name="createMethodName" value=""></option> <option name="format" value=""></option> <option name="updateMethodName" value=""></option> <option name="readMethodName" value=""></option> <option name="destroyMethodName" value=""></option> <option name="linkedObject">Note</option> </options> </options> <options name="filter" type="array"> <option value="Tag.Name"></option> </options> <options name="processField" type="array"> <option>Tag.Name</option> </options> <options name="display"> <options name="columns" type="array"> <options> <option name="title">Tag.Name</option> <option name="field">Tag.Name</option> <option name="width">400</option> <option name="fixedSize">true</option> <option name="extendedTooltip">false</option> </options> </options> <option name="cutLongRows">true</option> </options> <option name="browserHeight">300</option> <option name="browserWidth">180</option> <option name="formatMethod">GetUserTags</option> <option name="readMethod">GetUserTags</option> <option name="tooltipInside">true</option> <option name="inputTooltip">'+n(e(rk('Выберите необходимые теги')))+'</option> </options> <option name="linkName">Tag.Name</option> <option name="linkedDisplayField">Tag.Name</option> <option name="selectRecordsMode">newFloatArea</option> <options name="dictionaries" type="array"></options> </component> </div> </div>',(p=n(p))+(i&&-1!==p.indexOf('{{')?String.fromCharCode(8203,8203):'');};return o.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.NotesFilter'};},o;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.NotesFilter',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-notesFilter-row{width:100%;height:28px}.ws-notesFilter-title{width:100px;display:inline-block;vertical-align:top;padding-top:3px}.ws-notesFilter-input{width:180px;display:inline-block}'));head.appendChild(style);});}define('js!SBIS3.Notes.NotesFilter',['SBIS3.CONTROLS/CompoundControl','html!SBIS3.Notes.NotesFilter','css!SBIS3.Notes.NotesFilter','Deprecated/Controls/FieldLink/FieldLink','Deprecated/Controls/FieldDropdown/FieldDropdown','SBIS3.CONTROLS/ComboBox','Zametki_localization','Zametki_localization'],function(e,t){'use strict';var o=e.extend({_dotTplFn:t,$protected:{_options:{}},init:function(){o.superclass.init.call(this);}});return o;});define('tmpl!SBIS3.Notes.Tags',['Core/tmpl/js/tclosure','js!SBIS3.CONTROLS/SearchForm','js!SBIS3.CONTROLS/Button','js!SBIS3.CONTROLS/ListView','js!SBIS3.Notes.TagEditor','Zametki_localization'],function(){var e=Array.prototype.slice.call(arguments),t=e[0],r={};r['js!SBIS3.CONTROLS/SearchForm']=e[1],r['js!SBIS3.CONTROLS/Button']=e[2],r['js!SBIS3.CONTROLS/ListView']=e[3],r['js!SBIS3.Notes.TagEditor']=e[4];var o=function e(o,a,i,n,s){function l(){}var c=0,d=void 0!==t&&t?t:arguments[arguments.length-1];void 0===d&&(eval('var thelpers = null;'),d=global.requirejs('View/Runner/tclosure'));var m={};s&&s.isSetts&&(m=s.fullContext||{});var p='string'==typeof i?i:'',g=void 0===r?void 0:r,u={id:[],def:void 0},v=d.configResolver.calcParent(this,'undefined'==typeof currentPropertyName?void 0:currentPropertyName,o),S=this&&this.includedTemplates?this.includedTemplates:{},N=d.getMarkupGenerator(n);try{var f=N.joinElements([N.createTag('div',{},[N.createTag('div',{class:'ws-window-titlebar-custom'},[N.createControl('wsControl','ws:SBIS3.CONTROLS/SearchForm',{name:'searchTag',placeholder:global.rk('найти...'),trim:!0,selectOnClick:!0,maxLength:64,activableByClick:!1},{name:'searchTag',sbisname:'searchTag'},{data:o,ctx:this,pName:'undefined'!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v},i,g,S,d.config,m),N.createControl('wsControl','ws:SBIS3.CONTROLS/Button',{name:'saveTags',className:'controls-Button__primary ws-note__saveTags',caption:'OK',tooltip:global.rk('Сохранить выбранные теги'),activableByClick:!1},{name:'saveTags',sbisname:'saveTags'},{data:o,ctx:this,pName:'undefined'!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v},i,g,S,d.config,m)],{},u,this),N.createControl('wsControl','ws:SBIS3.CONTROLS/ListView',{editingTemplate:d.createDataArray([new function(){var e=Object.create(o),t=function e(t,r,o,a,i){if(void 0===o)var o=arguments[2];var n=0,s='editingTemplate';if(void 0===d&&(eval('var thelpers = null;'),d=global.requirejs('View/Runner/tclosure')),i&&i.isSetts)var l=i.fullContext||{};t=d.isolateScope(Object.create(this),t,s);var c='string'==typeof o?o:'',m={id:[],def:void 0},p=this&&this.includedTemplates?this.includedTemplates:{},u=d.getMarkupGenerator(a);try{var S=u.joinElements([u.createControl('wsControl','ws:SBIS3.Notes.TagEditor',{bindings:[{fieldName:'Id',propName:'tagId',propPath:[],fullPropName:'tagId',propPathStr:'',oneWay:!0,direction:'fromContext',bindNonExistent:!1},{fieldName:'Name',propName:'tagValue',propPath:[],fullPropName:'tagValue',propPathStr:'',oneWay:!0,direction:'fromContext',bindNonExistent:!1},{fieldName:'Color',propName:'tagColor',propPath:[],fullPropName:'tagColor',propPathStr:'',oneWay:!0,direction:'fromContext',bindNonExistent:!1}],tagId:void 0,tagValue:void 0,tagColor:void 0},d.plainMerge(r,{}),{data:t,ctx:this,pName:void 0!==s?s:void 0,viewController:v},o,g,p,d.config,l)],c,m);m.def&&(S=u.chain(S,m,r),m=void 0);}catch(e){d.templateError('resources/Zametki/Tag/Form.tmpl',e,t);}return S||'';};this.func=d.makeFunctionSerializable(t,e);}().func]),itemsActions:[{name:'edit',icon:'sprite:icon-16 icon-Edit icon-primary',tooltip:global.rk('Изменить тег во всех заметках'),onActivated:d.getter(o,['_onEdit']),isMainAction:!0},{name:'remove',icon:'sprite:icon-16 icon-Erase icon-error',tooltip:global.rk('Удалить тег из всех заметок'),onActivated:d.getter(o,['_onRemove']),isMainAction:!0}],name:'recentTags',className:'controls-ListView__showCheckBoxes ws-note__recent-tags',idProperty:'Id',multiselect:!0,itemsDragNDrop:!1,pageSize:10,itemContentTpl:'tmpl!SBIS3.Notes.Tags/Tag',esc:!1},{name:'recentTags',sbisname:'recentTags'},{data:o,ctx:this,pName:'undefined'!=typeof currentPropertyName?currentPropertyName:void 0,viewController:v,internal:{__dirtyCheckingVars_1:d.getter(o,['_onEdit']),__dirtyCheckingVars_4:d.getter(o,['_onRemove'])}},i,g,S,d.config,m)],a,u,this)],p,u);u.def&&(f=N.chain(f,u,a),u=void 0);}catch(e){d.templateError('resources/Zametki/Tag/Form.tmpl',e,o);}return f||'';};return o.includedFunctions={},o.stable=!0,o.toJSON=function(){return{$serialized$:'func',module:'tmpl!SBIS3.Notes.Tags'};},o;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.Tags',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-note__tag-form{width:400px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;border-radius:5px;-webkit-border-radius:5px;-moz-border-radius:5px;-o-border-radius:5px;border-color:#e4e4e4;border-width:2px 2px 2px 2px;border-style:solid}.ws-note__tag-form .ws-window-titlebar-custom{padding:8px;height:42px;box-sizing:border-box;font-weight:400}.ws-note__tag-editor .controls-PopupMixin__closeButton{width:35px;height:26px;cursor:pointer;font-size:23px;font-family:cbuc-icons}.ws-note__tag-form .controls-SearchForm{width:298px;margin-right:8px}.ws-note__tag-form .controls-SearchForm.controls-TextBox.ws-has-focus .controls-TextBox__fieldWrapper .controls-TextBox__field{color:#000}.ws-note__saveTags{position:absolute!important;right:42px}.ws-note__tag-form .ws-note__tag{margin:7px 0 0 36px;font-size:14px;display:inline-block;max-width:245px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:default}.ws-note__new-tag,.ws-note__recent-tags .controls-ListView__item{height:32px}.ws-note__recent-tags.controls-ListView .controls-ItemsToolbar{box-shadow:none!important;bottom:0}.controls-ListView.controls-ListView__touchMode:not(.controls-ListView__bottomStyle) .controls-ItemActions .controls-ItemActions__itemsContainer .controls-ItemActions__item.controls-IconButton:before{top:0;margin-top:0}.ws-note__recent-tags.controls-ListView.controls-ListView__touchMode:not(.controls-ListView__bottomStyle) .controls-ItemActions__activeItem{background:#e7eff8!important}.touchInterface .ws-note__recent-tags.controls-ListView .controls-ItemActions .controls-ItemActions__itemsContainer .controls-ItemActions__item,.touchInterface .ws-note__recent-tags.controls-ListView .controls-ItemsToolbar .controls-ItemsToolbar__container,.ws-is-mobile-platform .ws-note__recent-tags.controls-ListView .controls-ItemActions .controls-ItemActions__itemsContainer .controls-ItemActions__item,.ws-is-mobile-platform .ws-note__recent-tags.controls-ListView .controls-ItemsToolbar .controls-ItemsToolbar__container{outline:0;outline-offset:0;border:0}.ws-note__recent-tags.controls-ListView .controls-ListView__itemCheckBox{top:4px;left:6px}.ws-note__new-tag .ws-note__tag{font-weight:700}.ws-note__tag-form .ws-note__recent-tags span.ws-note__tag{cursor:pointer}.ws-note__recent-tags.controls-ListView .controls-ItemActions__activeItem{background:#e7eff8}.ws-is-mobile-platform .ws-note__recent-tags.controls-ListView .controls-ItemActions .controls-ItemActions__itemsContainer .controls-ItemActions__item{padding:0 6px}.ws-note__recent-tags.controls-ListView .controls-ItemActions .controls-ItemActions__itemsContainer .controls-ItemActions__item{padding:0;border:0}.ws-note__recent-tags.controls-ListView .controls-ItemsToolbar .controls-ItemsToolbar__container{border:0}.ws-note__recent-tags.controls-ListView .controls-ItemActions .controls-ItemActions__itemsContainer .controls-ItemActions__item.controls-IconButton:before{margin-top:0;top:0}.ws-note__recent-tags.ws-note__recent-tags .controls-editInPlace__editing .controls-ListView__itemCheckBox:before{z-index:0}.ws-is-mobile-platform .ws-note__recent-tags.controls-ListView .controls-ItemActions .controls-ItemActions__itemsContainer .controls-ItemActions__item.controls-IconButton:before{top:4px}.ws-note__recent-tags .controls-ItemActions__icon{margin-top:4px}'));head.appendChild(style);});}define('js!SBIS3.Notes.Tags',['Core/core-functions','Core/helpers/String/escapeHtml','Core/ParallelDeferred','Core/constants','Core/EventBus','SBIS3.CONTROLS/CompoundControl','tmpl!SBIS3.Notes.Tags','WS.Data/Source/SbisService','js!SBIS3.BL.Note','WS.Data/Entity/Model','SBIS3.CONTROLS/Utils/InformationPopupManager','SBIS3.CONTROLS/SearchForm','SBIS3.CONTROLS/ListView','SBIS3.CONTROLS/CheckBox','SBIS3.CONTROLS/TextBox','SBIS3.CONTROLS/Menu/MenuIcon','SBIS3.CONTROLS/Button/IconButton','SBIS3.CONTROLS/Button','js!SBIS3.Notes.TagEditor','css!SBIS3.Notes.Tags','i18n!SBIS3.Notes.Tags','tmpl!SBIS3.Notes.Tags/Tag','Zametki_localization','Zametki_localization'],function(t,e,o,n,s,i,a,r,c,l,d){'use strict';var h='00000000-0000-0000-0000-000000000000',g=i.extend({_dotTplFn:a,$protected:{_options:{tags:[],noteId:null,baseId:null},_controls:null,_dom:null,_currentTag:null,_doNotHandleTagChecked:false,_closeOnFocusOut:true,_activeElement:null,_eventNamespace:'.notetags',_handleTagClick:true,_cachedTags:{}},_modifyOptions:function(){var t=g.superclass._modifyOptions.apply(this,arguments);return t._onEdit=this._onEdit,t._onRemove=this._onRemove,t;},$constructor:function(){this._publish('onTagAdded','onTagUpdated','onTagRemoved','onTagCompletelyRemoved');},init:function(){g.superclass.init.call(this),this._cacheControls(),this._cacheDom();var t=this.getLinkedContext();this._options.tags=t.getValue('tags'),this._options.noteId=t.getValue('noteId'),this._options.baseId=t.getValue('baseId');var e=this._controls.recentTags;e.setDataSource(new r({endpoint:{address:'/notes/service/',contract:'Note'},idProperty:'Name',binding:{query:'GetRecentTags'}}),true),e.setFilter({NoteId:this._options.baseId||''});var o=this._options.tags.slice(0);e.setSelectedKeys(o),this.subscribeTo(e,'onDataLoad',this._onTagsLoad.bind(this)),this.subscribeTo(e,'onSelectedItemsChange',this._onSelectedItemsChanged.bind(this)),this.subscribeTo(e,'onDrawItems',this._onDrawItems.bind(this)),this.subscribeTo(e,'onChangeHoveredItem',this._onTagHover.bind(this)),this.subscribeTo(e,'onItemClick',this._onTagClick.bind(this)),this.subscribeTo(e,'onAfterEndEdit',this._onAfterEndEdit.bind(this)),this.subscribeTo(e,'onAfterBeginEdit',function(){this._notify('recalcPosition');}.bind(this)),this.subscribeTo(e,'onAfterBeginEdit',function(){s.channel('TagsEvents').notify('onBeginEditTag',this);});var i=this._controls.searchTag;this.subscribeTo(i,'onSearchStart',this._onSearch.bind(this)),this.subscribeTo(i,'onSearch',this._onSearch.bind(this)),this.subscribeTo(i,'onReset',this._onSearch.bind(this)),this.subscribeTo(this._controls.saveTags,'onActivated',this._onSaveAndClose.bind(this)),this.subscribeTo(s.channel('TagsEvents'),'onEditTag',this.onEdit.bind(this)),this.subscribeTo(s.channel('TagsEvents'),'onRemoveTag',this.onRemove.bind(this));var a=this,c=this.getContainer().closest('.ws-float-area');this.subscribeOnceTo(this,'onAfterShow',function(){setTimeout(function(){c.find('div.sbisname-window-title-close').off(a._eventNamespace).one('touchstart'+a._eventNamespace,function(t){t.preventDefault();});},100);}),this._dom.editor.on('click'+this._eventNamespace,'.ws-note-tag-color:not(.ws-note-tag-color_selected)',this._onColorize.bind(this)),c.on('focusout'+this._eventNamespace,function(t){var e=t.relatedTarget||a._activeElement;if(a._closeOnFocusOut&&!a.isDestroyed()&&e&&0===c.has(e).length&&0===$(e).closest('.ws-note__tag-color-menu').length)a._notify('onTagListClose');}),n.$body.on('touchstart'+this._eventNamespace+' mousedown'+this._eventNamespace,function(t){if(a._activeElement=t.target,$(a._activeElement).closest('.ws-noteDialog-container').length)a._notify('onTagListClose');});},destroy:function(){g.superclass.destroy.call(this),this.getContainer().closest('.ws-float-area').off(this._eventNamespace),n.$body.off(this._eventNamespace),this._dom.editor.off(this._eventNamespace),this._controls=null,this._dom=null,this._currentTag=null,this._activeElement=null,this._cachedTags=null;},_cacheControls:function(){this._controls=(this.getChildControls()||[]).reduce(function(t,e){var o=e.getName();if(o)t[o]=e;return t;},{});},_cacheDom:function(){var t=this.getContainer();this._dom={editor:t.find('.ws-note__tag-editor')};},_toggleTag:function(t,e,o,n){if(t)this._addTag(e,o,n);else this._notify('onTagRemoved',e);},_onDrawItems:function(){var t=this.getContainer();t.find('*').attr('unselectable','on').on('selectstart'+this._eventNamespace,false);var e=this._controls.searchTag.getContainer().find('.controls-TextBox__field');if(!e.is(':focus'))this._controls.searchTag.setActive(),e.focus();$(e).add(e.parentsUntil(t)).add(this._dom.editor).add(this._dom.editor.find('*')).removeAttr('unselectable').off('selectstart'+this._eventNamespace),this._notify('recalcPosition');},_addTag:function(e,o,n,s){var i=this,a=i._notify('onTagAdded',{name:e,color:o,independent:s});if(c.isDemo())return void i._onTagClick(null,h,e);this._disableList(),a.addCallbacks(function(t){var e=t&&t[0];if(n){var o=i._controls.recentTags,a=o.getItems(),r=a.getRecordById(h),c=new l({adapter:a.getAdapter(),format:a.getFormat(),idProperty:'Id'});c.set({Id:e,Name:r.get('Name'),Color:r.get('Color')}),a.add(c),i._doNotHandleTagChecked=true,o.addItemsSelection([e]),a.remove(r),i._doNotHandleTagChecked=true,o.removeItemsSelection([h]),o.redraw();}if(i._enableList(),s)i._controls.searchTag.setText(''),i._onSearch();},function(e){e=e.getRawData(),t.alert(rk('Ошибка при добавлении тега'),e.message,'error'),i._doNotHandleTagChecked=true,i._controls.recentTags.removeItemsSelection([h]),i._enableList();});},_onSearch:function(){var t=this._controls.recentTags,e=t.getFilter()||{NoteId:this._options.baseId||''},o=this._controls.searchTag.getText();if(e.SearchQuery!=o){if(o&&o.length>2)e.SearchQuery=o;else e={NoteId:this._options.baseId||''};t.setFilter(e);}},_onTagsLoad:function(t,e){var o=this._cachedTags;e.each(function(t){o[t.getId()]=t;});var n=(this._controls.recentTags.getFilter()||{}).SearchQuery;if(n&&n.length)n=n.trim();if(n&&n.length>2){var s=n.toLowerCase(),i=null;if(e.each(function(t){if(t.get('Name').toLowerCase()===s)i=t;}),!i){var a=new l({adapter:e.getAdapter(),format:e.getFormat(),idProperty:'Id'});a.set({Id:h,Name:n,Color:0}),e.add(a);}}},_onTagHover:function(t,e){if(e&&e.container){var o=this._controls.recentTags.getItemsActions().getItemsInstances(),n=!e.key||e.key==h;o.edit.toggle(!n),o.remove.toggle(!n);}},_onEdit:function(t,e,o){s.channel('TagsEvents').notify('onEditTag',e,o);},onEdit:function(t,e,o){var n=this,s=o.get('Name'),i=o.get('Color');this._currentTag={id:o.getId(),name:s,color:i,newColor:i};var a=this._controls.recentTags.getHoveredItem().record;if(!a)a=this._controls.recentTags.getItems().getRecordById(e);this._controls.recentTags.sendCommand('beginEdit',a),this._controls.recentTags.getContainer().find('.controls-ItemActions__itemsContainer').addClass('ws-hidden');},_onAfterEndEdit:function(){var t=this;setTimeout(function(){if(t._controls&&t._controls.recentTags){var e=t._controls.recentTags.getHoveredItem();if(e&&e.record)t._controls.recentTags._showItemsToolbar(e);t._controls.recentTags.getContainer().find('.controls-ItemActions__itemsContainer').removeClass('ws-hidden');}},150);},_disableList:function(){this._controls.recentTags._toggleIndicator(true);},_enableList:function(){this._controls.recentTags._toggleIndicator(false);},_onRemove:function(t,e,o){s.channel('TagsEvents').notify('onRemoveTag',e,o);},onRemove:function(o,n,s){var i=this,a=s.get('Name');this._closeOnFocusOut=false,d.showConfirmDialog({message:rk('Удалить тег','часть фразы')+' "'+e(a)+'" '+rk('из всех заметок?'),opener:this,parent:this},function(){i._disableList(),c.deleteTag(a).addCallbacks(function(){i._controls.recentTags.removeItemsSelection([n]),i._controls.recentTags.reload(),i._notify('onTagCompletelyRemoved',a);},function(e){i._enableList(),t.alert(e.details,'error');}),i._closeOnFocusOut=true;},function(){i._closeOnFocusOut=true;});},_onSelectedItemsChanged:function(t,e,o){if(o.added&&o.added.length&&o.added[0]==h){var n=this._controls.recentTags.getItems().getRecordById(h);this._addTag(n.get('Name'),0,true,true);}},_onSaveAndClose:function(t,e){function n(t,e){return(t||[]).filter(function(t){return e.indexOf(t)<0;});}var s=this,i=this._controls.recentTags.getSelectedKeys(),a=new o();if(i.length){var r=n(i=i.filter(function(t){return!!s._cachedTags[t];}),this._options.tags).map(function(t){var e=s._cachedTags[t];return{name:e.get('Name'),color:e.get('Color')};});a.push(this._notify('onTagAdded',r));}if(this._options.tags.length){var c=n(this._options.tags,i).map(function(t){return s._cachedTags[t].get('Name');});a.push(this._notify('onTagRemoved',c));}s._notify('onTagListClose',a.getStepsCount()),a.done().getResult().addCallback(function(){s._closeOnFocusOut=false;});},_onTagClick:function(t,e,o,n){var s=this;if(!t||$(n).hasClass('ws-note__tag')&&this._handleTagClick)this._handleTagClick=false,this._notify('onTagAdded',[{name:t?o.get('Name'):o,color:t?o.get('Color'):0}]).addCallback(function(){s._notify('onTagListClose');});},_onColorize:function(t,e){this._currentTag.newColor=+e,this._setRecentTagColor(this._currentTag.id,e),this._controls.tagName.setActive(true);},_closeEditor:function(){this._dom.editor.addClass('ws-hidden'),this._currentTag=null,this.setActive(true);},_setRecentTagColor:function(t,e){var o='ws-note__tag_color-',n=o+[0,1,2,3,4].join(' '+o);this._controls.recentTags.getContainer().find('.controls-ListView__item[data-id="'+t+'"]').find('.ws-note__tag').removeClass(n).addClass(o+(e||0));}});return g;});define('html!SBIS3.Notes.DynamicNotesView',['Zametki_localization'],function(){var e=function(e){var n=function(){var e=/\{\{([\s\S]+?)\}\}/g;return function(n){for(;e.test(n);)n=n.replace(e,'&#123;&#123;$1&#125;&#125;');return n;};}(),o='undefined'!=typeof process,t=(('undefined'!=typeof _randomHelpers?_randomHelpers:void 0)||global.requirejs('Core/helpers/random-helpers'),function(){return this||(0,eval)('this');}().wsDotVarStorage.storage,'<div class="ws-notes-holder ws-notes-holder_dynamic"> <component data-component="SBIS3.Notes.DynamicNoteListView" name="notes" class="ws-notes-container"></component> </div> ');return(t=n(t))+(o&&-1!==t.indexOf('{{')?String.fromCharCode(8203,8203):'');};return e.toJSON=function(){return{$serialized$:'func',module:'html!SBIS3.Notes.DynamicNotesView'};},e;});if(typeof window!=='undefined'&&window.atob){define('css!SBIS3.Notes.DynamicNotesView',['Zametki_localization'],function(){var style=document.createElement('style'),head=document.head||document.getElementsByTagName('head')[0];style.type='text/css';style.appendChild(document.createTextNode('.ws-notes-holder_dynamic{position:fixed;z-index:1010}.ws-narrow-page .ws-notes-holder_dynamic{z-index:1010}.ws-note_dragged,.ws-note_dragged .ws-note__content img,.ws-note_dragged div,.ws-note_dragged textarea{cursor:move!important;z-index:9999!important;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}.ws-note_dragged .ws-note__content div.LinkDecorator__wrap,.ws-note_dragged .ws-note__content div.LinkDecorator__wrap img.LinkDecorator__image{z-index:0!important}.ws-notes-holder.ws-notes-holder_dynamic{width:0}.ws-note-notification__header{width:343px;height:24px}.ws-note-notification__header .controls-Button{float:right}.ws-note-notification__body{width:380px}.ws-note-notification__header>span.ws-note-notification__text{font-size:15px;margin-left:32px;top:8px;position:absolute}.ws-note-notification__header>.icon-Successful{position:absolute;top:1px;left:7px}.ws-note-notification__body{background:#f4f4f4;padding:8px}.ws-note-notification__body>a{font-size:14px}'));head.appendChild(style);});}define('js!SBIS3.Notes.DynamicNotesView',['Core/core-instance','Core/helpers/getSessionStorageValue','Core/helpers/setSessionStorageValue','Core/WindowManager','Core/UserInfo','Core/EventBus','Core/Deferred','Core/detection','js!SBIS3.Notes.NotesView','html!SBIS3.Notes.DynamicNotesView','js!SBIS3.BL.Note','js!SBIS3.Notes.Note','js!SBIS3.Notes.PanelData','js!SBIS3.Notes.Utils.Info','WS.Data/Chain','js!SBIS3.Notes.DynamicNoteListView','SBIS3.CONTROLS/Button','SBIS3.CONTROLS/ScrollContainer','css!SBIS3.Notes.DynamicNotesView','Zametki_localization','Zametki_localization'],function(e,t,n,o,i,s,a,l,r,d,c,u,h,f,_){'use strict';function g(){return window.pageXOffset||document.documentElement.scrollLeft;}function N(){return window.pageYOffset||document.documentElement.scrollTop;}var p=r.extend({_dotTplFn:d,$protected:{_options:{notes:null,count:0,showHidden:false,isOpenDoc:false,showPanelNotes:false},_count:0,_lastWidth:0,_lastHeight:0,_notesOnPanel:0,_notifications:[],_isFullyLoaded:false,_eventNamespace:'.dynamicNotesView'},_modifyOptions:function(e){if('undefined'!==typeof window)e.showPanelNotes=Boolean(+t('show-panel-notes'));return e;},$constructor:function(){this._publish('onReallyReady');},destroy:function(){p.superclass.destroy.call(this),$('.controls-Browser.edo-Browser').off(this._eventNamespace);},init:function(){p.superclass.init.call(this);var t=this,n=this._controls.notes;if(this._count=this._options.count,this._count)this._updateHiderCounter(this._count);this.subscribeTo(n,'onReorder',function(){var e=n.getNotes().map(function(e){return e.baseId;});c.rearrangeNotes(e);}),this.subscribeTo(n,'onDrawItems',function(){t._showNotes(this);}),this.getContainer().on('mousedown touchstart','.ws-note__content img, .ws-note__content a',false),$('.controls-Browser.edo-Browser').on('DOMNodeInserted'+t._eventNamespace,function(e){if('DIV'===e.target.nodeName&&e.target.classList.contains('controls-Paging'))setTimeout(function(){var n=parseInt($(e.target).css('z-index'));if(parseInt(t.getContainer().css('z-index'))<n)t.getContainer().css('z-index',n);},0);}),this.subscribeTo(o,'zIndexChanged',function(e,n){var i=o.getActiveWindow().getContainer(),s=i.attr('templatename');if(!i.hasClass('ws-note__tag-form')&&'js!SBIS3.Notes.Tags'!==s&&'TagButton'!==i.attr('name'))if(l.isMobilePlatform)t._controls.notes._clearHoveredItem();}),this.subscribeTo(s.globalChannel(),'FloatAreaZIndexChanged',function(n,i){var s=o.getActiveWindow();if(!e.instanceOfModule(s,'SBIS3.Notes.NoteEditor')&&!t._doNotOpenDialog&&!$('div[templatename="js!SBIS3.DOCVIEW.FullScreenViewer"]').length&&!$('.pt-editor-window div[templatename="js!SBIS3.PT.PTEditor"]').length)t.getContainer().css('z-index',i);if(t._notifications.length){for(var a=0;a<t._notifications.length;a++)t._notifications[a].close();t._notifications=[];}}),this.loadData().addCallback(function(){t._showNotes(n);var i=o.getMaxZIndex(),s=o.getActiveWindow();if(!e.instanceOfModule(s,'SBIS3.CONTROLS/ScrollContainer')&&!e.instanceOfModule(s,'SBIS3.DOCVIEW.View')&&s.isModal&&!s.isModal())t.getContainer().css('z-index',i+1);else{if(t._zIndex=i-1,o.getActiveWindow().getContainer().closest('.edo-Dialog').length)t._zIndex++;t.getContainer().css('z-index',t._zIndex),t.subscribeTo(o.getActiveWindow(),'onDestroy',function(){o.releaseZIndex(t._zIndex),t._zIndex=o.acquireZIndex(),o.setVisible(t._zIndex),t.getContainer().css('z-index',t._zIndex+1);});}});var i=s.channel('NotesEvents');this.subscribeTo(i,'onNoteAdded',this._onNoteAdded.bind(this)),this.subscribeTo(i,'onNoteChanged',this._onNoteChanged.bind(this)),this.subscribeTo(i,'onPanelNotesHiderToggle',this._onToggleHider.bind(this)),this.subscribeTo(i,'onExtendedHiderOpened',function(e){var t=this,n=new a();if(t._options.showHidden=true,t._count!==t._controls.notes.getNoteCount())t.loadData(null,true).addCallback(function(){n.callback(t._controls.notes.getNotes());}).addErrback(function(e){n.error(e);});else n.callback(t._controls.notes.getNotes());e.setResult(n);}.bind(this)),this.subscribeTo(i,'onHiderToggle',this._onToggleHider.bind(this)),this.subscribeTo(i,'onFileRemoved',function(e,n){if(!$('body').hasClass('ws-note-openedDialog')&&n&&!n.hasContent()&&!n.files.getCount()&&!n.tags.length)t.removeNote(n),t._activeNote=null;}),this.subscribeTo(i,'onTagFormClosed',function(e,o,i){if(n._tagsWasChanged=i||n._tagsWasChanged,n._tagsWasChanged)if(n._tagsWasChanged=false,!t._doNotOpenDialog)setTimeout(function(){n.reload();},200);});var r=s.channel('NoteCommands');this.subscribeTo(r,'HideNotes',function(){t._controls.notes.setVisible(false);}),this.subscribeTo(r,'ShowNotes',function(){t._controls.notes.setVisible(true);}),this.subscribeTo(r,'Reload',function(e,o){if(!o||o.hasNotes)t.loadData(o).addCallback(function(){t._showNotes(n);});}),this.subscribeTo(r,'RemovePanelNotes',function(e,n){t._removePinnedToPanelNotes(n);}),this.subscribeTo(r,'Create',function(e,n){t.openNoteDialog(n);});},_removePinnedToPanelNotes:function(e){var t=this._controls.notes,n=this;t.getNotes().forEach(function(o){if(o.pinnedToPanel&&(o.panelId&&(o.panelId==e||o.panelId.toString().indexOf('-#-')>0&&o.panelId.toString().split('-#-')[0]==e)||o.panelData.panelId&&o.panelData.panelId==e))t.removeNoteById(o.id),n._count--;});},_showNotes:function(e){if(e.getNotes().length||h.getTop()&&this._options.showPanelNotes){var t=this;e.getNotes().forEach(function(n){if(!n.pinnedToPanel&&!t._options.isOpenDoc||t._options.showPanelNotes&&n.pinnedToPanel)e.getNoteElement(n.id).removeClass('ws-hidden');}),e.cropNotes();}},_onNoteAdded:function(e,t){var n=this._controls.notes.getNotes(),i=this;if(!n.length)o.releaseZIndex(i._zIndex),i._zIndex=o.acquireZIndex(),o.setVisible(i._zIndex),i.getContainer().css('z-index',i._zIndex+1);var a=t.pinnedToPanel&&!h.getTop(),l=t.pinnedToPanel&&!i._count;if(t.pin&&!a&&(!l||i._needReloadWhenClosed||this._options.isOpenDoc))if(i._needReloadWhenClosed=false,i._count++,n.push(t),n.forEach(function(e){i._controls.notes._updateViewModel(e);}),this._controls.notes.setItems(n),this._showNotes(this._controls.notes),this._updateHiderCounter(i._count),!t.pinnedToPanel)s.channel('NoteCommands').notify('setHiderFletching',true);},_onNoteChanged:function(e,t){if(t.pin)this._updateHiderCounter(),this._controls.notes.reload();else{if(!t.pinnedToPanel||this._needRemoveWhenClosed)this._count--,this._needRemoveWhenClosed=false;this._controls.notes.removeNoteById(t.id),this._updateHiderCounter(this._count);}},_afterPanelUnpin:function(e,t,n){if(e.pinnedToPanel=false,e.panelId=null,e.panelData={},e.panelObject=null,e.containerId=null,e.isAuthor=false,t===u.NOTE_PIN_UNPINNED)e.movedToReestr=true;if(this._controls.notes.sync(e),!this._doNotOpenDialog)this._controls.notes.reload();if(n)this._notesOnPanel--;else if(t!==u.NOTE_PIN_UNPINNED)this._updateHiderCounter(null);if(t!==u.NOTE_PIN_UNPINNED)f.showNotification(rk('Заметка откреплена от панели'));},_setNoteVisibilityAndCheckHiderStatus:function(e){e.isHidden=false,s.channel('NoteCommands').notify('setHiderFletching',!this._controls.notes.getNotes().every(function(e){return e.isHidden||e.pinnedToPanel;}));},_onPin:function(e,t,n){if(n===a)return;var o=this,i=h.getTop(),s=this._controls.notes,a=t.getPin(),l=n!==u.NOTE_PIN_PANEL&&t.pinnedToPanel,r=!this.getNote(t.id);if(n===u.NOTE_PIN_PANEL)t.pinToPanel(i).addCallbacks(function(){if(t.pinnedToPanel=true,t.isAuthor=true,t.panelId=i.id,t.panelObject=i.type,t.containerId=i.containerId,s.sync(t),o._setNoteVisibilityAndCheckHiderStatus(t),!o._doNotOpenDialog)s.reload();if(r){if(o._notesOnPanel++,o._doNotOpenDialog)o._needReloadWhenClosed=true;}else o._updateHiderCounter(null);f.showNotification(rk('Заметка прикреплена к панели'));},function(e){s.reload(),f.showMessageDialog({message:rk('Не удалось прикрепить заметку к панели'),details:e.message||e.details});});else if(n===u.NOTE_PIN_ALL_PAGES)t.pinToAllPages().addCallback(function(){if(l)o._afterPanelUnpin(t,n,r);o._setNoteVisibilityAndCheckHiderStatus(t);}).addErrback(function(e){f.showMessageDialog({message:rk('Не удалось прикрепить заметку ко всем страницам'),details:e.message||e.details}),s.reload();});else if(n===u.NOTE_PIN_PAGE)t.pinToCurrentPage().addCallback(function(){if(l)o._afterPanelUnpin(t,n,r);o._setNoteVisibilityAndCheckHiderStatus(t);}).addErrback(function(e){f.showMessageDialog({message:rk('Не удалось прикрепить заметку к странице'),details:e.message||e.details}),s.reload();});else if(n===u.NOTE_PIN_UNPINNED)t.unpin().addCallback(function(){if(o._doNotOpenDialog)return void(o._needRemoveWhenClosed=true);s.removeNoteById(t.id),o._count--,o._updateHiderCounter(o._count),o._setNoteVisibilityAndCheckHiderStatus(t),s.reload().addCallback(function(){o._showNotificationPopup(t,a,i);});}).addErrback(function(e){f.showMessageDialog({message:rk('Не удалось перенести заметку в реестр'),details:e.message||e.details});});},_reloadAfterCancel:function(e){if(s.channel('NoteCommands').notify('setHiderFletching',true),u.isDemo()){var t=this._controls.notes.getItems().getRawData();t.push(e),this._controls.notes.setItems(t);}else this.loadData(false);},_onCancelUnpin:function(e,t,n,o){var i=this;if(e.movedToReestr=false,t===u.NOTE_PIN_PANEL)e.pinToPanel(n).addCallbacks(function(){i._notesOnPanel++,i._reloadAfterCancel(e);},function(e){f.showMessageDialog({message:rk('Прикрепление заметки к панели не удалось'),details:e.message||e.details});});else e[t===u.NOTE_PIN_PAGE?'pinToCurrentPage':'pinToAllPages']().addCallbacks(function(){i._reloadAfterCancel(e);},function(e){f.showMessageDialog({message:rk('Восстановление заметки не удалось'),details:e.message||e.details});});o.close();},_showNotificationPopup:function(e,t,n){var o=this;require(['SBIS3.CONTROLS/Utils/InformationPopupManager'],function(i){var s=function(){return'<div class="ws-note-notification__header">'+'<div class="icon-32 icon-Successful icon-done"></div>'+'<span class="ws-note-notification__text">'+rk('Заметка перенесена')+'</span>'+'<component data-component="SBIS3.CONTROLS/Button">'+'<option name="name">cancelButton</option>'+'<option name="caption">'+rk('Отменить')+'</option>'+'</component>'+'</div>';},a=function(){return'<div class="ws-note-notification__body"><a href="/notes.html">'+rk('Перейти в реестр')+'</a></div>';},l=i.showNotification({headerTemplate:s,bodyTemplate:a,opener:o},true);o._notifications.push(l),o.subscribeTo(l.getChildControlByName('cancelButton'),'onActivated',o._onCancelUnpin.bind(o,e,t,n,l)),l.getContainer().on('click','.ws-note-notification__body > a',function(){l.close();}),setTimeout(function(){l.close();},5000);});},loadData:function(e,t){var n=this._controls.notes,o=this,i;if(this._options.errorOnLoading)return a.fail();if(this._options.notes&&(!this._options.showHidden||this._options.notes.getCount()==this._count))i=a.success(this._options.notes),this._options.notes=null;else{this.show();var s=e&&h.getCount()<=1;if(s)i=c.getPersonPinnedNotes(e,this._options.showHidden,true);else i=c.getPersonPinnedNotes(h.getTop(),this._options.showHidden);}return i.addCallback(function(e){var t=s?n.getNotes():[];if(s&&t.length)t=t.filter(function(e){return!e.pinnedToPanel;});if(e){if(o._count=s?o._count+e.getMetaData().total:e.getMetaData().total,e.getCount()){var i=h?h.getTop():null,a=i?i.id:0;e.each(function(e){if(!e.get('PinnedToPanel')||e.get('PanelId')==a)t.push(new u(e));else o._count--;});}}else o._count=s?o._count:0;if(t.forEach(function(e){n._updateViewModel(e);}),n.setItems(t),o._updateHiderCounter(o._count),!o._isFullyLoaded)o._isFullyLoaded=true,o._notify('onReallyReady');});},createNote:function(){var e=p.superclass.createNote.call(this);if('__сбис__биллинг'===i.get('ЛогинКлиента'))e.pinToAllPages();else{var n=+t('note-pin-status');if(n)e.presetPin(n);else e.presetPin(u.NOTE_PIN_ALL_PAGES);}var o=this.getNewNotePosition();return e.setPosition(o.top,o.left,this._getWindowWidth(),this._getWindowHeight()),e.order=this.getNewNoteOrder(),e;},_getEditorPosition:function(e){var t,n,o=this._getWindowWidth(),i=this._getWindowHeight(),s=30;if(!e.baseId)t=50,n=o-r.NOTE_EDITOR_WIDTH-24;else{var a=e.getPosition(o,i);t=a.top-(r.NOTE_EDITOR_HEIGHT-e.height)/2,n=a.left-(r.NOTE_EDITOR_WIDTH-e.width)/2;var l=i-t-r.NOTE_EDITOR_HEIGHT,d=o-n-r.NOTE_EDITOR_WIDTH;if(l<=0)t+=l-s;if(d<=0)n+=d-s;if(t<s)t=s;if(n<s)n=s;}return{top:t,left:n,fullTop:t+N(),fullLeft:n+g()};},getEditorConfig:function(){return{componentOptions:{allowPinToAnyPage:true}};},removeNote:function(e,t){var n=this,o=e.pinnedToPanel;e.remove().addCallbacks(function(o){if(o)f.showMessageDialog({message:rk('Не удалось удалить заметку'),details:o,status:'default'});else if(n._controls.notes.removeNoteById(e.id),n._showNotes(n._controls.notes),!t)if(n._count--,n._updateHiderCounter(),n._controls.notes.getNotes().every(function(e){return e.isHidden||e.pinnedToPanel;}))s.channel('NoteCommands').notify('setHiderFletching',false);},function(e){f.showMessageDialog({message:rk('Не удалось удалить заметку'),details:e.message||e.details,status:'error'});});},_updateHiderCounter:function(e){e=e||this._count;var t=0,n=0,o=h.getTop()||null;if(e>0)if(this._options.notes){var i,a=[];if(i=this._options.notes,i.each(function(e){var n=_(e).toObject();if(n.PinnedToPanel)t++;else a.push(n);}),a.length){var l=a[0].ModifyDate;a.forEach(function(e){if(l<e.ModifyDate)l=e.ModifyDate;});}}if(!t&&o){var r=this._controls.notes?this._controls.notes.getNotes():null;if(r)r.forEach(function(e){if(e.pinnedToPanel)t++;if(e.movedToReestr)n++;});}if(o)if(t)if(o.external)s.channel('NoteCommands').notify('setPanelHiderCount',o.containerId,t),s.channel('NoteCommands').notify('setPanelHiderState',o.containerId,this._options.showPanelNotes);else this._createHider(o,t);else if(o.hider)o.hider.hideHider();else s.channel('NoteCommands').notify('setPanelHiderCount',o.containerId,0);if(this._options.isOpenDoc&&e)s.channel('NoteCommands').notify('setHiderVisible',false);else s.channel('NoteCommands').notify('setHiderCount',e-t-n);this._notesOnPanel=t;},_createHider:function(e,t){if(!e.hider){var n=document.createElement('div');document.body.appendChild(n);var o=new Hider({name:'PanelHider',element:n,onPanel:true,showNotes:this._options.showPanelNotes});h.setTopHider(o),this.subscribeTo(o,'Toggle',this._onToggleHider.bind(this));}e.hider.setCount(t);},_onToggleHider:function(e,t,o){var i=this,s=e._target&&!!e._target._onPanel||!!o;if(this._controls.notes._lightMode)this._controls.notes._lightMode=false,this._controls.notes.reload();if(this._controls.notes.getItems().each(function(e){if(e.getRawData().pinnedToPanel==s)i._controls.notes.getNoteElement(e.getRawData().id)[t?'removeClass':'addClass']('ws-hidden');}),s)n('show-panel-notes',+t),this._options.showPanelNotes=t;},getNewNotePosition:function(){var e=-16,t=50,n=20,o=0,i=this._getWindowWidth(),s=this._getWindowHeight(),a=this._controls.notes.getNotes(),l=a.length,r=n,d=o,c;function h(e,t){var n=10,o,r,d,c;for(o=0;o<l;o++)if(r=a[o],d=null==r.top?s-r.bottom-r.height:r.top,c=null==r.right?i-r.left-r.width:r.right,d>e-n&&d<e+n&&c>t-n&&c<t+n)return d+r.height;return null;}while(c=h(r,d))if(r=c+e,r+u.DEFAULT_NOTE_HEIGHT>s)r=n,d+=t;return{top:r,left:Math.max(i-d-u.DEFAULT_NOTE_WIDTH,0)};},getNewNoteOrder:function(){var e=0,t=this._controls.notes.getNotes();if(t&&t.length){var n=t.map(function(e){return e.order;});e=1+Math.max.apply(Math,n);}return e;}});return p;});