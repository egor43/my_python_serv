define("Deprecated/xslt",["Core/constants","Core/detection","Core/core-extend","Core/IoC","Core/helpers/string-helpers","Core/helpers/additional-helpers"],function(e,t,r,n,o,s){var i=s.axo,l={TRANSFORM_TO_TEXT:1,TRANSFORM_TO_DOC:2,TRANSFORM_TO_FRAGMENT:4,LOAD_URL:8,LOAD_TEXT:16},a=r.extend({},{$protected:{_xmlDoc:"",_xslDoc:"",_loadedFiles:[],_options:{xml:"",xsl:""},_nsResolver:null},$constructor:function(){if(n.resolve("ILogger").info("Deprecated","В 3.7.4.230 синхронная работа с xslt будет прекращена. Используйте Core/xslt-async"),this._xmlDoc=new c({name:this._options.xml}).getDocument(),this._xslDoc=new c({name:this._options.xsl}).getDocument(),t.webkit)this._nsResolver=function(e){switch(e){case"xsl":return"http://www.w3.org/1999/XSL/Transform";default:return null}},this._chromeWorkaround()},_loadDoc:function(e){if(-1==this._loadedFiles.indexOf(e)){var t=new c({name:e}).getDocument();return this._loadedFiles.push(e),t}else return n.resolve("ILogger").log("XSLTransfor","Potential cyclic dependency on file "+e),null},_chromeWorkaround:function(){while(this._xslDoc.getElementsByTagName("import").length>0)this._preparseImports(this._xslDoc),this._preparseImportAppliance(this._xslDoc);while(this._xslDoc.getElementsByTagName("include").length>0)this._preparseIncludes(this._xslDoc);this._preparseDocumentFunction(this._xmlDoc,this._xslDoc)},_xslIEWorkaround:function(e){if(e.selectNodes("//xsl:import").length)e=this._xslIEImports(e,"//xsl:import"),e=this._preparseImportApplianceIE(e);if(e.selectNodes("//xsl:include").length)e=this._xslIEIncludes(e,"//xsl:include");return e},_preparseImportApplianceIE:function(e){var t=e.selectNodes("//xsl:apply-imports");if(t.length>0){var r=t[0],n=r.parentNode,o=e.createElement("xsl:apply-templates");o.setAttribute("select","."),o.setAttribute("mode","imports"),n.replaceChild(o,r)}return e},_moveChildrenIE:function e(t,r){if(r.childNodes.length>0)for(var n=0;n<t.length;n++)r.insertBefore(t[n],r.childNodes[0]);else for(var n=0;n<t.length;n++)r.appendChild(t[n]);return r},_checkTemplates:function e(t,r){if(t.getAttribute("match"))for(var n=0;n<r.length;n++)if(t.getAttribute("match"))if(r[n].getAttribute("match")===t.getAttribute("match"))this._moveChildrenIE(t.childNodes,r[n]),t.setAttribute("mode","imports")},_xslIEImports:function e(t,r){do{var n=t.selectNodes(r),o=t.selectNodes("//xsl:template"),s=t.documentElement,i;if(n.length>0)for(var l=0;l<n.length;l++){var a=n[l].getAttribute("href"),c=this._xslIEWorkaround(new u({name:a}).getDocument()).documentElement.childNodes,m=0;while(c.length>0){if(i=c.nextNode(),"xsl:template"===i.nodeName)this._checkTemplates(i,o);s.insertBefore(i,n[l])}s.removeChild(n[l])}}while(n.length);return t},_xslIEIncludes:function e(t,r){do{var n=t.selectNodes(r),o=t.documentElement,s;if(n.length>0)for(var i=0;i<n.length;i++){var l=n[i].getAttribute("href"),a=this._xslIEIncludes(new u({name:l}).getDocument()).documentElement.childNodes;while(a.length>0)s=a.nextNode(),o.insertBefore(s,n[i]);o.removeChild(n[i])}}while(n.length);return t},_convertAbsolutePath:function(e,t){if("/"!==e.charAt(0)){if(""===t)t=window.location.protocol+"//"+window.location.hostname;else if(t.lastIndexOf("/")>t.indexOf("//")+1)t=t.substring(0,t.lastIndexOf("/"));while(/^\.\.\//.test(e)){if(t.lastIndexOf("/")>t.indexOf("//")+1)t=t.substring(0,t.lastIndexOf("/"));e=e.substring(3)}e=(e=t+"/"+e).replace("./","")}return e},_preparseIncludes:function(e){var t=e.getElementsByTagName("include");while(t.length>0){var r=t[0],n=this._convertAbsolutePath(r.getAttribute("href"),e.URL),o=this._loadDoc(n),s=r.parentNode;if(o)for(var i=o.documentElement.childNodes,l=0,a=i.length;l<a;l++)s.insertBefore(e.importNode(i[l],true),r);s.removeChild(r)}},_preparseImportAppliance:function(e){var t=e.getElementsByTagName("apply-imports");while(t.length>0){var r=t[0],n=r.parentNode,o=e.createElement("xsl:apply-templates");o.setAttribute("select","."),o.setAttribute("mode","imports"),n.replaceChild(o,r)}},_preparseImports:function(e){var t=e.getElementsByTagName("import");while(t.length>0){var r=t[0],o=this._convertAbsolutePath(r.getAttribute("href"),e.URL),s=this._loadDoc(o),i=r.parentNode;if(s)for(var l=s.documentElement.childNodes,a=0,c=l.length;a<c;a++){var u=l[a];if("xsl:template"==u.nodeName){if(u.hasAttribute("name")){var m=u.getAttribute("name"),d=e.evaluate("count(//xsl:template[@name='"+m+"'])",e,this._nsResolver,XPathResult.NUMBER_TYPE,null);if(d&&d.numberValue>0){n.resolve("ILogger").log("xslt","Ignored duplicate named template: "+m);continue}}if(u.hasAttribute("match")){var h=u.getAttribute("match"),f=e.evaluate("count(//xsl:template[@match='"+h+"'])",e,this._nsResolver,XPathResult.NUMBER_TYPE,null);if(f&&f.numberValue>0)u.setAttribute("mode","imports")}}i.insertBefore(e.importNode(u,true),r)}i.removeChild(r)}},_preparseDocumentFunction:function(e,t){var r=t.evaluate("//*[contains(@select, 'document(')]",t,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null),n,o=[];while(null!==(n=r.iterateNext())){var s=n.getAttribute("select"),i=s.match(/document\('([^\)]+)'\)/);if(i&&i.length>0){var l=this._convertAbsolutePath(i[1],t.URL),a=this._loadDoc(l);if(a){var c="x"+l.replace(/\//g,"-")+"-document",u=e.createElement(c);this._getForeignDocContainer(e).appendChild(u),u.appendChild(e.importNode(a.documentElement,true)),s="//ws-foreign-documents-namespace/"+c+s.substring(l.length+12),o.push([n,s])}}}if(o.length>0){var m=t.createElement("xsl:template");m.setAttribute("match","ws-foreign-documents-namespace"),t.documentElement.appendChild(m);for(var d=0,h=o.length;d<h;d++)o[d][0].setAttribute("select",o[d][1])}},_getForeignDocContainer:function(e){var t=e.getElementsByTagName("ws-foreign-documents-namespace")[0];if(!t)t=e.createElement("ws-foreign-documents-namespace"),e.documentElement.appendChild(t);return t},_insertForeignDoc:function(e,t){var r=new c({name:t}),n="xxx",o=this._getForeignDocContainer(e),s=e.createElement(n);s.appendChild(s.importNode(r.getDocument(),true)),o.appendChild(s)},_ieAddParams:function(e,t){if(!t)return e;for(var r in t)try{var n=t[r];if("boolean"===typeof n||isNaN(parseInt(n,10))&&("string"!==typeof n||"'"!==n.charAt(0)))n="'"+n+"'";var o=e.selectSingleNode('//xsl:param[@name="'+r+'"]');if(o)o.setAttribute("select",n)}catch(e){throw new Error("Problems with setting parameter "+r+" in the xsl transform")}return e},transformToText:function(e){if(window.XMLSerializer&&(!t.isIE||t.isIE12))return(new XMLSerializer).serializeToString(this.includeCss(this.transformToDocument(e)));else if(i)return this._xslDoc=this._xslIEWorkaround(this._xslDoc),this._xmlDoc.transformNode(this.includeCss(this._ieAddParams(this._xslDoc,e),true));throw new Error("Transform to text is not supported in your environment")},includeCss:function(e,t){var r=$(e).find("head"),n=r.find("link"),o=[];if(n.length)(n=n.toArray()).forEach(function(e){var t=$(e);o.push(t.attr("href")),t.remove()}),o.forEach(function(n){var o=new XMLHttpRequest;if(o.open("GET",n,false),o.send(""),t){var s=e.createElement("style");s.text=o.responseText,r.append($(s))}else r.append($("<style>"+o.responseText+"</style>"))});return e},transformToDocument:function(e){if(window.XSLTProcessor){var t=new XSLTProcessor;for(var r in e)t.setParameter(null,r,e[r]);if(t.transformToDocument)return t.importStylesheet(this._xslDoc),t.transformToDocument(this._xmlDoc)}else if(i){var n=i("Microsoft.XMLDOM");if(this._ieAddParams(n,e),"transformNodeToObject"in this._xmlDoc)return this._xslDoc=this._xslIEWorkaround(this._xslDoc),this._xmlDoc.transformNodeToObject(this._ieAddParams(this._xslDoc,e),n),n}throw new Error("Transform to document is not supported in your environment")},transformToFragment:function(e,t){if(window.XSLTProcessor){var r=new XSLTProcessor;for(var n in t)r.setParameter(null,n,t[n]);if(r.transformToFragment)return r.importStylesheet(this._xslDoc),r.transformToFragment(this._xmlDoc,e)}else if(i){var o=e.createDocumentFragment(),s=this._xmlDoc.transformNode(this._ieAddParams(this._xslDoc,t)),l=e.createElement("div");l.innerHTML=s;while(l.hasChildNodes())o.appendChild(l.firstChild);return o}throw new Error("Transform to fragment is not supported in your environment")},getCapabilities:function(){var e=l.LOAD_URL,t;if(window.DOMParser)e|=l.LOAD_TEXT;if(window.XSLTProcessor){if(t=new XSLTProcessor,t.transformToDocument)e|=l.TRANSFORM_TO_DOC;if(t.transformToFragment)e|=l.TRANSFORM_TO_FRAGMENT}else if(i){if(t=i("Microsoft.XMLDOM"),"transformNodeToObject"in t)e|=l.TRANSFORM_TO_DOC;if("transformNode"in t)e|=l.TRANSFORM_TO_TEXT;if("loadXML"in t)e|=l.LOAD_TEXT}if(window.XMLSerializer)e|=l.TRANSFORM_TO_TEXT;return e},destroy:function(){this._xmlDoc=null,this._xslDoc=null,this._options=null}}),c=function(e){return n.resolve("IXMLDocumentSync",e)},u=r.extend({},{$protected:{_options:{name:""},_doc:null},$constructor:function(){this._doc=this._loadDocument(this._options.name)},getDocument:function(){return this._doc},checkDocument:function(e){var t=null;if(e)if(e.parseError){if(0!==e.parseError.errorCode)t=e.parseError.reason}else{var r=e.getElementsByTagName("parsererror");if(r.length)t=r[0].textContent}else t="Empty document";if(null!==t)throw new EvalError("Parse error: "+t);return e},_loadDocument:function(e){var t=null;if(e.documentElement)t=e;else t=this["_loadDocumentFrom"+(this._isUrl(e)?"Url":"String")](e);return this.checkDocument(t)},_loadDocumentFromString:function(e){var t=null;if(e=o.removeInvalidXMLChars(e),i)(t=i("Microsoft.XMLDOM")).async=false,t.loadXML(e);else if(window.DOMParser)t=(new DOMParser).parseFromString(e,"text/xml");if(null!==t)return t;throw new Error("Your environment is not able to parse XML documents from string")},_loadDocumentUsingXHR:function(e){var r=new XMLHttpRequest;if(t.chrome&&/\.(xml|xsl)$/.test(e))e+="?_="+Math.random();return r.open("GET",e,false),r.send(""),r},_loadDocumentFromUrl:function(e){var t;if(i){var r=i("Microsoft.XMLDOM");if(window.XMLHttpRequest)t=this._loadDocumentUsingXHR(e),r.loadXML(o.removeInvalidXMLChars(t.responseText));else r.async=false,r.load(e);return r}else return t=this._loadDocumentUsingXHR(e),t.responseXML},_isUrl:function(e){if(void 0===e.substr||""===e||!e)return false;if(!/^http[s]?:/.test(e)){var t=e.substr(0,1);if("/"!=t&&"."!=t)if("<"==t)return false}return true},destroy:function(){this._doc=null,this._options=null}});return e.XSLTCaps=e.XSLTCaps||l,n.bind("IXMLDocumentSync",u),a}),define("js!SBIS3.CORE.XSLT","");
//# sourceMappingURL=xslt.js.map